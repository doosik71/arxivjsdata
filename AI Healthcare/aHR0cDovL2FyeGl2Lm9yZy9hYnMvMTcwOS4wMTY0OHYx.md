# Boosting Deep Learning Risk Prediction with Generative Adversarial Networks for Electronic Health Records

Zhengping Che, Yu Cheng, Shuangfei Zhai, Zhaonan Sun, Yan Liu

## 🧩 Problem to Solve

의료 데이터(Electronic Health Records, EHRs)의 양은 빠르게 증가하고 있지만, 딥러닝 기반의 의료 위험 예측 모델은 일반적으로 대규모의 레이블링된 데이터를 필요로 합니다. 그러나 실제 임상 환경에서는 정확한 레이블을 가진 EHR 데이터, 특히 희귀 질병이나 특정 조건에 대한 데이터가 제한적이며 수집에 많은 비용과 시간, 그리고 개인 정보 보호 문제가 따릅니다. 이로 인해 기존 딥러닝 모델들이 가진 잠재력을 충분히 발휘하기 어려운 문제가 있습니다.

## ✨ Key Contributions

- **ehrGAN 모델 제안**: EHR 데이터에 특화된 생성적 적대 신경망(Generative Adversarial Network, GAN)인 ehrGAN을 제안하여 실제와 유사한 환자 기록 데이터를 생성합니다. 이 모델은 모드 붕괴(mode collapsing) 문제를 완화하고 데이터 매니폴드(data manifold)의 풍부한 구조를 학습합니다.
- **준지도 학습 프레임워크 개발**: ehrGAN을 통해 생성된 데이터를 활용하여 제한된 레이블 데이터 환경에서 딥러닝 기반 위험 예측 모델의 성능을 향상시키는 준지도 학습(Semi-Supervised Learning, SSL) 프레임워크를 제시합니다.
- **실제 데이터셋에서의 성능 입증**: 두 가지 실제 의료 데이터셋(심부전 및 당뇨병)을 활용한 실험을 통해 제안된 프레임워크가 현실적인 데이터 샘플을 생성하며, 여러 최신 베이스라인 대비 분류 작업에서 상당한 성능 향상을 달성함을 입증합니다.

## 📎 Related Works

- **헬스케어 애플리케이션을 위한 딥러닝**: CNN(Convolutional Neural Network)을 이용한 위험 예측 [11, 33], RNN(Recurrent Neural Network)을 이용한 시퀀스 예측 [30], 그리고 딥 스테이트 스페이스 모델(Deep State Space Model) [31] 등이 의료 데이터의 복잡한 패턴을 학습하는 데 사용되었습니다. 그러나 대부분의 연구는 완전 지도 학습 방식에 의존했습니다.
- **준지도 학습(SSL)**: 레이블이 없는 데이터와 소량의 레이블 데이터를 함께 사용하여 성능을 향상시키는 기법입니다. 기존 연구들은 주로 임상 텍스트 데이터 [19, 20]에 집중했으나, 정형화된 시계열 EHR 데이터에 대한 준지도 딥러닝 모델 연구는 제한적이었습니다 [21].
- **적대적 학습 및 GAN**: Goodfellow et al. [25]이 제안한 GAN은 생성자와 판별자가 경쟁적으로 학습하며 데이터 분포를 학습합니다. GAN은 이미지 [34] 및 텍스트 [28, 29] 데이터에 주로 활용되었으며, 준지도 학습 프레임워크에도 적용되었습니다 [36, 39]. 그러나 시퀀스 또는 시계열 EHR 데이터 생성에 GAN을 적용한 사례는 거의 없었습니다. 본 연구는 이러한 기존 연구의 한계를 극복하고 GAN을 시계열 EHR 데이터 및 준지도 학습에 적용한 최초의 시도 중 하나입니다.

## 🛠️ Methodology

본 논문은 기본 딥러닝 예측 모델과 ehrGAN, 그리고 이를 활용한 준지도 학습 스키마로 구성됩니다.

### 1. 기본 딥러닝 예측 모델

- **구조**: 1D 컨볼루션 레이어(temporal dimension)와 max over-time 풀링 레이어를 사용하는 CNN(Convolutional Neural Network) 모델을 기반으로 합니다.
- **입력**: 환자 $p$의 EHR 기록은 시계열 임베딩 행렬 $x_p \in R^{T_p \times M}$로 표현됩니다. 여기서 $T_p$는 의료 이벤트 수, $M$은 학습된 임베딩 차원입니다.
- **학습**: Word2vec [40] 모델을 사용하여 의료 이벤트 임베딩을 사전 학습합니다. 여러 길이의 필터를 조합하여 다양한 수준의 시간적 의존성을 포착합니다.
- **출력**: 고정 길이의 벡터로 변환된 후, 완전 연결(fully connected) 소프트맥스 레이어를 통해 예측 확률을 산출합니다.

### 2. ehrGAN: EHR 데이터용 수정된 GAN 모델

- **기본 GAN 목적**:
  $$ \min*G \max_D E*{x\sim p*{data}(x)}[\log D(x)] + E*{z\sim p*z(z)}[\log (1-D(G(z)))] $$
  여기서 $p*{data}(x)$는 실제 데이터 분포, $D(x)$는 판별자, $G(z)$는 생성자입니다.
- **판별자(Discriminator)**: 기본 CNN 예측 모델의 구조를 채택하고, 최상위 예측 레이어를 단일 시그모이드(sigmoid) 유닛으로 교체하여 입력 데이터가 실제 데이터셋에서 추출되었을 확률을 출력합니다.
- **생성자(Generator)**:
  - **VCD(Variational Contrastive Divergence) 기반 생성자**: 잠재 벡터 $z$를 합성 샘플 $\tilde{x}$로 변환하는 대신, 실제 샘플 $x$에서 파생된 생성 샘플 $\tilde{x}$에 대한 전이 분포 $p(\tilde{x}|x)$를 학습합니다.
  - **구조**: 인코더-디코더(encoder-decoder) CNN 네트워크로 구성됩니다.
    - 실제 샘플 $x$로부터 인코더를 통해 표현 $h$를 얻습니다.
    - 표현 $h$는 임의의 이진 마스크 벡터 $m$과 노이즈 벡터 $z$와 혼합되어 $\tilde{h} = m*z + (1-m)*h$를 생성합니다.
    - $\tilde{h}$를 동일한 디코더에 입력하여 합성 샘플 $\tilde{x}$를 얻습니다.
  - **생성자 목적 함수**:
    $$ E*{x\sim p*{data}(x)} \left[ \rho \cdot E\_{\tilde{x}\sim p_g(\tilde{x}|x)}[-\log D(\tilde{x})] + (1-\rho)\cdot \|\bar{x}-x\|^2_2 \right] $$
        여기서 $D$는 판별자 함수, $\rho$는 합성 샘플이 해당 실제 샘플과 얼마나 유사해야 하는지를 제어하는 하이퍼파라미터입니다.
  - **이점**: 모드 붕괴(mode collapsing) 문제를 완화하고, 훈련 데이터 예제 주변의 데이터 매니폴드에 대한 풍부한 구조를 학습하여 준지도 학습에 유용합니다.
- **훈련 기법**:
  - 생성자와 판별자를 SGD(Stochastic Gradient Descent)로 반복적으로 최적화합니다.
  - GAN 훈련 안정화를 위해 판별자 1단계 훈련당 생성자 5단계 훈련을 수행합니다.
  - 판별자 손실 함수에 $l_2$-norm 정규화를 추가합니다.
  - 배치 정규화(batch normalization) 및 레이블 스무딩(label smoothing) 기법을 사용합니다.

### 3. GAN을 활용한 준지도 학습(SSL-GAN)

- **아이디어**: 학습된 ehrGAN의 전이 분포 $p(\tilde{x}|x)$를 사용하여 데이터 증강을 수행합니다.
- **손실 함수**:
  $$ \frac{1}{N}\sum*{i=1}^{N}L(x_i,y_i) + \mu\cdot\frac{1}{N}\sum*{i=1}^{N}E\_{\tilde{x}\_i\sim p(\tilde{x}|x_i)}L(\tilde{x}\_i,y_i) $$
    여기서 $L$은 이진 교차 엔트로피 손실(binary cross-entropy loss), $\mu$는 훈련 데이터와 증강된 데이터의 비율을 조정하는 하이퍼파라미터입니다. 잘 훈련된 생성자는 실제 샘플 $x$와 동일한 클래스에 속할 가능성이 있는 샘플 $\tilde{x}$를 생성하여 분류기에 추가 훈련 데이터를 제공합니다.

## 📊 Results

- **데이터셋**: 건강 보험 회사에서 추출된 218,680명의 환자 기록(2011-2015)에서 심부전(Congestive Heart Failure) 및 당뇨병(Diabetes) 코호트 데이터를 사용했습니다. 각 코호트에서 이진 분류(case/control)를 수행했습니다.
- **기본 모델 성능 비교**: CNN 모델은 로지스틱 회귀(LR), SVM, 랜덤 포레스트(RF) 및 GRU, LSTM과 같은 다른 딥러닝 모델들보다 심부전 및 당뇨병 예측 작업에서 더 나은(혹은 견줄만한) AUROC 및 정확도를 보였습니다.
- **생성된 데이터 분석**:
  - **길이 분포**: ehrGAN이 생성한 데이터셋은 원본 데이터셋과 유사한 길이 분포를 가집니다 (그림 2).
  - **피처 빈도**: 생성된 데이터는 가장 빈번한 100개 피처에 대해 원본 데이터와 유사한 빈도를 유지합니다 (그림 3).
  - **동시 발생 패턴**: 가장 빈번한 20개 진단 피처의 동시 발생 히트맵에서 생성된 데이터가 원본 데이터와 유사한 동시 발생 패턴과 군집을 보였습니다 (그림 4). 이는 ehrGAN이 질병 코호트의 발생 패턴을 잘 포착함을 보여줍니다.
- **향상된 모델 평가 (SSL-GAN)**:
  - **성능 우수성**: SSL-GAN은 CNN-BASIC (기본 모델), CNN-RAND (랜덤 레이블 증강), SSL-SMIR, SSL-LGC (표준 준지도 학습) 등의 베이스라인 모델들을 일관되게 능가했습니다.
  - **CNN-FULL과의 비교**: 모든 레이블 데이터를 사용한 CNN-FULL 모델과도 견줄만한 성능을 달성했습니다. 예를 들어, Dia50 및 Dia67 세트에서 AUROC 점수 기준으로 CNN-FULL보다 약 2% 낮았으며, HF50 및 HF67에서는 차이가 더 작았습니다.
- **하이퍼파라미터 ($\rho$, $\mu$) 영향**:
  - **$\rho$의 영향**: 생성자 목적 함수에서 $\rho$ 값을 0.1로 설정했을 때 가장 좋은 성능을 보였습니다. $\rho=0$ (오토인코더 샘플) 또는 $\rho=1$ (레이블 불일치 위험)은 성능을 저해했습니다.
  - **$\mu$의 영향**: 증강된 데이터의 활용 정도를 나타내는 $\mu$ 값은 0.6에서 최적의 성능을 보였습니다. 너무 많은 증강된 데이터를 포함하는 것은 성능에 부정적인 영향을 미칠 수 있음을 확인했습니다.

## 🧠 Insights & Discussion

- **제한된 데이터 문제 해결**: 본 연구는 딥러닝 모델에 필요한 대량의 레이블 데이터를 확보하기 어려운 의료 분야의 고질적인 문제에 대한 효과적인 해결책을 제시합니다. ehrGAN은 실제와 유사한 EHR 데이터를 성공적으로 생성하여 데이터 부족 문제를 완화하고, 이를 통해 딥러닝 모델의 일반화 능력과 예측 성능을 향상시킬 수 있음을 보여주었습니다.
- **ehrGAN의 강점**: 제안된 ehrGAN은 기존 GAN의 모드 붕괴 문제를 해결하고, 실제 데이터의 복잡한 시계열 및 동시 발생 패턴을 효과적으로 학습하여 현실적인 의료 기록을 생성하는 능력을 입증했습니다. 이는 단순히 데이터를 늘리는 것을 넘어, 데이터의 내재된 구조를 반영한 유의미한 증강이 가능함을 의미합니다.
- **준지도 학습의 잠재력**: ehrGAN을 활용한 준지도 학습 프레임워크인 SSL-GAN은 제한된 레이블 데이터만으로도 우수한 위험 예측 성능을 달성하여, 의료 분야에서 준지도 학습의 큰 잠재력을 강조합니다.
- **향후 연구**: 임상 전문가의 도움을 받아 생성된 데이터의 임상적 유용성과 패턴을 정량적으로 비교하는 심층적인 분석이 필요합니다. 또한, 더 나은 임상적 해석 가능성이나 구조적 정보를 통합하여 생성 모델을 개선하고, 최신 GAN 아키텍처를 프레임워크에 통합할 수 있습니다. 본 프레임워크는 재입원 예측 및 표현 학습 등 다른 의료 애플리케이션으로 확장될 수 있습니다.

## 📌 TL;DR

제한된 EHR 데이터로 인한 딥러닝 위험 예측 성능 저하 문제 해결을 위해, 생성적 적대 신경망(GAN)을 활용한 준지도 학습 프레임워크인 **SSL-GAN**을 제안합니다. **ehrGAN**이라는 변형된 GAN은 실제 환자 기록과 유사한 시계열 EHR 데이터를 성공적으로 생성하여 훈련 데이터셋을 증강하며, 이를 통해 심부전 및 당뇨병 예측 태스크에서 기존 모델 대비 예측 정확도와 AUROC를 크게 향상시켰습니다. 본 연구는 제한된 레이블 데이터 환경에서 딥러닝 기반 위험 예측 모델의 일반화 능력과 성능을 효과적으로 향상시킬 수 있음을 입증합니다.
