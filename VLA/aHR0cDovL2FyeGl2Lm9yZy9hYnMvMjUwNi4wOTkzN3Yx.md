# SAFE: Multitask Failure Detection for Vision-Language-Action Models

Qiao Gu, Yuanliang Ju, Shengxiang Sun, Igor Gilitschenski, Haruki Nishimura, Masha Itkina, Florian Shkurti

## 🧩 해결해야 할 문제

최근 비전-언어-액션 모델(Vision-Language-Action models, VLA)은 다양한 조작 작업에서 로봇 행동의 유망한 가능성을 보여주었지만, 처음 접하는(unseen) 새로운 작업에 배포될 경우 제한적인 성공률(30-60%)을 보입니다. 로봇이 환경과 안전하게 상호작용하기 위해서는 적시에 경고를 발생하여 로봇이 작업을 중단하거나, 이전 상태로 되돌아가거나, 도움을 요청할 수 있도록 하는 실패 감지기가 필요합니다. 그러나 기존 실패 감지기는 단일 또는 소수의 특정 작업에 대해서만 학습 및 테스트되었으며, VLA는 미지의 작업 및 새로운 환경에서도 실패를 일반화하여 감지할 수 있는 능력이 필요합니다. 또한, 기존의 다중 작업 실패 감지 방법들은 다수의 액션 샘플링이나 대규모 VLM 쿼리를 필요로 하여 실시간 로봇 제어에 상당한 추론 오버헤드를 발생시킵니다.

## ✨ 주요 기여

- VLA 특징 공간(feature space)을 분석하여, VLA의 내부 특징이 작업 성공과 실패에 대한 충분한 고수준 지식을 담고 있으며, 이는 다양한 작업에 걸쳐 일반적(generic)임을 입증했습니다.
- 일반주의 로봇 정책을 위한 다중 작업 실패 감지기 `SAFE`를 제안했습니다. `SAFE`는 VLA의 내부 특징을 활용하고, 다중 작업의 성공 및 실패 롤아웃 데이터로 학습하며, 컨포멀 예측(conformal prediction) 방법을 사용하여 미지의 작업에서도 실패 감지 능력을 일반화할 수 있음을 보여주었습니다.
- OpenVLA, $\pi^0$, $\pi^0$-FAST 등 여러 최신 대규모 VLA 모델에 대해 시뮬레이션 및 실제 환경에서 `SAFE`와 다양한 기준선(baselines)을 광범위하게 평가했습니다. 실험 결과, `SAFE`가 최첨단(SOTA) 실패 감지 성능을 달성하고 정확도와 감지 시간 사이에서 최상의 절충점(trade-off)을 제공함을 보여주었습니다.

## 📎 관련 연구

- **비전-언어-액션 모델(VLAs):** 대규모 로봇 데이터셋과 사전 학습된 VLM을 기반으로 하는 일반주의 로봇 정책(예: RT-1, OpenVLA, $\pi^0$, $\pi^0$-FAST)으로, 익숙하지 않은 작업에서 30-60%의 성공률을 보입니다.
- **로봇 조작에서의 실패 감지:**
  - **비지도 OOD(Out-of-Distribution) 감지:** 성공적인 실행을 정상으로 간주하고 벗어나는 모든 것을 실패로 감지하는 방식(예: LogpZO, RND). 일반주의 VLA에는 너무 제한적이며, 기존 연구 [8]에서는 학습 작업에 과적합되는 경향을 보였습니다.
  - **지도 실패 감지:** 성공 및 실패 롤아웃 데이터를 모두 사용하여 학습. 대부분의 기존 방법은 작업별로 별도의 감지기 학습이 필요했습니다.
  - **다중 작업 실패 감지:** 일부 연구(예: 액션 일관성 점수 [17], VLM 미세 조정 [18,19])가 있었으나, 실시간 제어에 높은 추론 오버헤드를 초래합니다.
- **LLM/VLM을 위한 불확실성 정량화(Uncertainty Quantification, UQ):**
  - **토큰 수준 UQ:** 생성된 각 토큰의 확률 분포 분석.
  - **의미론적 유사성 방법:** 여러 응답을 생성하여 의미론적 일관성 평가.
  - **내부 잠재 공간 분석:** 내부 잠재 특징에 분류기를 학습시켜 환각(hallucination)을 감지하는 접근 방식. `SAFE`는 이 효율적이고 효과적인 접근 방식에서 영감을 얻었습니다.

## 🛠️ 방법론

1. **VLA 잠재 공간 시각적 분석 ($4.1$절):**
   - VLA의 내부 특징이 작업 성공/실패에 대한 고수준 정보를 포착한다는 가설을 세웠습니다.
   - $\pi^0$-FAST의 LIBERO-10 벤치마크 롤아웃의 t-SNE 시각화(그림 $1$)를 통해, 실패한 롤아웃의 특징들이 '실패 구역(failure zone)'으로 그룹화되며, 이 분리가 다양한 작업에 걸쳐 일반적임을 발견했습니다. 작업 실행 중 로봇이 실패하면 특징이 이 실패 구역으로 진입하는 것을 관찰했습니다.
   - 이러한 통찰을 바탕으로 `SAFE`는 VLA의 내부 특징을 활용하도록 설계되었습니다.
2. **특징 프로빙을 통한 실패 감지 ($4.2$절):**
   - VLA 모델의 마지막 계층에서 출력 토큰 로짓(token logits) 또는 속도 필드(velocity field)로 디코딩되기 전의 히든 상태 벡터($e_t$)를 추출합니다.
   - `SAFE`는 현재 시점 $t$까지의 VLA 특징 시퀀스 $e_{0:t}=\{e_1, ..., e_t\}$를 입력받아 실패 점수 $s_t$를 예측하도록 학습됩니다.
   - **두 가지 백본 설계:**
     - **SAFE-MLP ($f_{MLP}$):** 다층 퍼셉트론(MLP) $g(\cdot)$를 사용하여 각 시점 $t$의 $e_t$를 독립적으로 단일 스칼라로 투영하고, 이를 누적하여 실패 점수를 계산합니다: $f_{MLP}(e_{0:t}) = \sum_{\tau=1,...,t} \sigma(g(e_{\tau}))$. $L_1$ 손실 $L_{MLP} = \sum_i [y_i \sum_t (t-s_t) + (1-y_i) \sum_t s_t]$로 학습됩니다.
     - **SAFE-LSTM ($f_{LSTM}$):** LSTM 모델이 $e_{0:t}$ 스트림을 순차적으로 처리하고, LSTM의 히든 상태 벡터를 시그모이드 함수 $\sigma(\cdot)$를 통해 $0 \leq s_t \leq 1$ 범위의 스칼라 점수로 투영합니다: $f_{LSTM}(e_{0:t}) = \sigma(LSTM(e_{0:t}))$. 이진 교차 엔트로피 손실 $L_{LSTM} = \sum_i \sum_t [y_i \log(s_t) + (1-y_i) \log(1-s_t)]$로 학습됩니다.
   - 두 모델 모두 과적합을 방지하고 미지의 작업에 대한 일반화 능력을 향상시키기 위해 간단하게 설계되었습니다(1~2개 계층).
3. **컨포멀 예측을 통한 임계값 선택 ($4.3$절):**
   - 예측된 실패 점수 $s_t$가 시간 가변 임계값 $\delta_t$를 초과할 때 실패 플래그를 발생시킵니다.
   - $\delta_t$를 원칙적으로 결정하기 위해 함수적 컨포멀 예측(functional CP) 프레임워크 [22]를 사용합니다. CP는 보정 세트 내에서 관찰된 성공 롤아웃의 $s_t$ 분포를 활용하여 시간 가변 예측 대역 $C_{\alpha}$를 구성합니다. $C_{\alpha}$의 상한값(upper bound)이 $\delta_t$로 사용되며, 이는 오탐율(false positive rate)을 사용자 지정된 유의 수준 $\alpha$ 이하로 보장합니다.

## 📊 결과

- **ROC-AUC 성능:**
  - 시뮬레이션 및 실제 환경의 모든 벤치마크에서 `SAFE` 방법(SAFE-MLP, SAFE-LSTM)이 다른 기준선보다 우수하거나 동등한 성능을 일관되게 보여주었습니다.
  - 특히, 시뮬레이션 벤치마크에서는 `SAFE`가 미지의 작업에서 최고의 기준선보다 4-5% 더 우수했고, 알려진 작업에서도 최고의 성능을 달성했습니다.
  - 실제 로봇 실험에서는 SAFE-MLP가 최고의 성능을, SAFE-LSTM은 최고의 기준선(Euclidean k-NN)에 근접한 성능을 보였습니다.
  - 토큰 불확실성 기반 방법은 성능이 낮았으며, 다수의 액션 샘플링이 필요한 샘플 일관성(Sample Consistency) 및 STAC [17] 방법은 성능은 좋았지만 높은 오버헤드를 가집니다.
- **정확도 및 감지 시간 절충 (기능적 CP 사용):**
  - 그림 $3$에 따르면, `SAFE`-MLP와 `SAFE`-LSTM은 높은 균형 정확도(Balanced Accuracy)와 낮은 평균 감지 시간(Average Detection Time)을 보이며, 이는 정확하고 신속한 실패 감지를 의미합니다.
  - `SAFE`는 롤아웃 초기 단계에서 높은 정확도로 실패를 감지할 수 있어, 실제 실패가 발생하기 전에 조기 개입을 가능하게 합니다.
- **질적 결과:** 시뮬레이션에서는 부정확한 삽입, 불안정한 액션, 그립 실패와 같은 일반적인 실패 모드를 감지했습니다. 실제 로봇에서는 작업 완료 후 실패 점수가 안정화되며, 정책 정지(freezing) 또는 물체 미끄러짐과 같은 실패가 발생할 때 실패 플래그가 발생하여 인간의 직관과 잘 일치했습니다.

## 🧠 통찰 및 논의

- VLA의 내부 특징 공간은 작업 성공/실패에 대한 풍부하고 추상적이며 작업에 구애받지 않는 정보를 담고 있습니다. 이 정보는 미지의 작업에 대한 일반화 가능한 실패 감지에 효과적으로 활용될 수 있습니다.
- `SAFE`는 VLA의 내부 특징을 활용하고, 간단한 신경망 구조와 컨포멀 예측을 결합함으로써 미지의 작업에 대한 높은 일반화 능력을 달성했습니다.
- `SAFE`의 조기 실패 감지 능력은 실제 로봇 시스템의 안전하고 안정적인 배포에 매우 중요하며, 치명적인 실패가 발생하기 전에 적시에 개입할 수 있는 기회를 제공합니다.
- **한계:**
  - 이 연구는 조작 작업에 대해서만 다중 작업 실패 감지를 고려했습니다. 다양한 로봇 신체(embodiments), 시뮬레이션-실제(sim2real) 일반화, 또는 액션 없는 비디오 데이터에 대한 적용 가능성은 불분명합니다.
  - `SAFE`는 VLA의 마지막 계층에서 추출된 특징만을 사용하며, 여러 계층의 정보를 효과적으로 통합하는 방법은 향후 연구 과제입니다.

## 📌 요약 (TL;DR)

**문제:** 일반주의 VLA 로봇은 미지의 작업에서 낮은 성공률을 보이지만, 기존 실패 감지기는 작업 일반화가 어렵거나 추론 오버헤드가 큽니다.
**방법:** VLA의 내부 특징 공간이 작업 성공/실패에 대한 일반적인 고수준 정보를 담고 있음을 발견했습니다. 이를 기반으로 `SAFE`는 VLA 내부 특징을 사용하여 단일 스칼라 실패 확률을 예측하는 간단한 신경망(MLP 또는 LSTM)을 제안합니다. `SAFE`는 다중 작업 성공/실패 롤아웃 데이터를 학습하고, 기능적 컨포멀 예측을 통해 시간 가변 임계값을 보정하여 미지의 작업에서도 실패를 조기에, 정확하게 감지합니다.
**주요 결과:** `SAFE`는 시뮬레이션 및 실제 환경의 여러 VLA 모델에서 최첨단 실패 감지 성능을 달성하며, 정확도와 감지 시간 사이에서 최상의 절충점을 제공합니다. 미지의 작업에 대한 효과적인 실패 감지 능력과 인간의 직관에 부합하는 실패 모드 식별 능력을 보여주었습니다.
