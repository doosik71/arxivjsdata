# Curriculum Domain Adaptation for Semantic Segmentation of Urban Scenes

Yang Zhang, Philip David, Boqing Gong

## 🧩 Problem to Solve

최근 합성 데이터(synthetic data)를 활용하여 CNN 모델을 학습하는 것이 가능해졌지만, 실제 이미지(real images)와 합성 데이터 간의 **도메인 불일치(domain mismatch)**로 인해 모델 성능이 저하되는 문제가 있습니다. 특히 자율 주행과 같은 분야에서 핵심적인 **시맨틱 분할(semantic segmentation)**은 픽셀 단위 주석(annotation)이 매우 노동 집약적이고 비용이 많이 들기 때문에, 이러한 도메인 간극을 줄이는 것이 중요합니다. 기존의 도메인 적응(domain adaptation) 기법들은 주로 분류(classification)나 회귀(regression) 문제에 초점을 맞추었으며, 픽셀 단위의 구조화된 예측(structured prediction) 문제인 시맨틱 분할에는 효과적이지 않을 수 있다는 한계가 있었습니다.

## ✨ Key Contributions

- **커리큘럼 스타일 도메인 적응(Curriculum-style Domain Adaptation) 제안:** 쉬운 작업부터 시작하여 타겟 도메인의 필요한 속성을 먼저 추론하고, 이를 기반으로 어려운 시맨틱 분할 작업을 수행하는 새로운 접근 방식입니다.
- **이미지 및 랜드마크 슈퍼픽셀의 레이블 분포 활용:** 타겟 도메인의 전역적(global) 이미지 레이블 분포와 지역적(local) 랜드마크 슈퍼픽셀(landmark superpixels)의 레이블 분포를 "쉬운 작업"으로 정의하고 이를 활용하여 네트워크를 정규화합니다.
- **일반적인 예측 함수 가정 회피:** 소스 도메인과 타겟 도메인이 변환된 특징 공간에서 동일한 예측 함수를 공유한다는 기존 도메인 적응의 가정을 피함으로써, 구조화된 예측 문제에 더 적합한 방법을 제시합니다.
- **네트워크 구조 변경 없이 적용 가능:** 기존 시맨틱 분할 네트워크의 구조를 변경하거나 중간 레이어에 영향을 주지 않고 손실 함수(loss function)만 수정하여 쉽게 적용할 수 있습니다.
- **최첨단 성능 달성:** 제안하는 방법은 기존의 베이스라인 및 동일 문제를 다루는 유일한 기존 접근 방식보다 우수한 성능을 보였습니다.

## 📎 Related Works

- **일반적인 도메인 적응:** 훈련 및 테스트 데이터가 동일한 분포에서 추출된다는 가정을 완화하고 도메인 불일치를 해결하는 방법들. 주로 분류 및 회귀 문제에 집중했습니다 [43, 41].
- **합성 데이터 기반 도메인 적응:** 가상 이미지(virtual images)를 실제 사진(real photos)으로 변환하는 접근 방식 [56, 65, 48, 63, 27, 45, 53].
- **시맨틱 분할:** 이미지의 모든 픽셀에 객체 레이블을 할당하는 작업. CNN 기반 방법들이 주류를 이루며 [10, 35, 64, 49], 데이터 주석의 높은 비용이 문제입니다.
- **시맨틱 분할을 위한 도메인 적응:** 본 연구와 동일한 문제를 다룬 기존 시도 중 유일하게 알려진 Hoffman et al.의 "FCNs in the Wild" [27]가 있습니다. 이 연구는 픽셀 수준의 적대적 손실(adversarial loss)과 제약 조건을 사용하지만, 본 논문은 다른 커리큘럼 기반 전략을 제안합니다.

## 🛠️ Methodology

본 논문은 소스 도메인의 풍부한 레이블 데이터를 활용하고 타겟 도메인의 레이블 없는 데이터에 대해 필요한 속성을 학습함으로써 시맨틱 분할 네트워크를 학습하는 커리큘럼 도메인 적응을 제안합니다.

1. **전반적인 목표 함수:**

   - 소스 도메인($S$)의 레이블이 있는 이미지에 대한 픽셀 단위 교차 엔트로피(pixel-wise cross-entropy) 손실 $L(Y_{s}, \hat{Y}_{s})$과, 타겟 도메인($T$)의 레이블이 없는 이미지에 대한 추정된 속성 분포 $p^k_{t}$와 네트워크 예측 분포 $\hat{p}^k_{t}$ 간의 교차 엔트로피 $C(p^k_{t}, \hat{p}^k_{t})$를 결합합니다.
   - 전체 손실 함수는 다음과 같습니다:
     $$ \min*{\gamma} \frac{1}{|S|} \sum*{s \in S} L(Y*{s}, \hat{Y}*{s}) + \frac{1-\gamma}{|T|} \sum*{t \in T} \sum*{k} C(p^k*{t}, \hat{p}^k*{t}) $$
        여기서 $k$는 서로 다른 유형의 레이블 분포(전역/지역)를 나타냅니다.

2. **"쉬운" 타겟 속성 추론:**

   - **전역 이미지 레이블 분포:**

     - 타겟 이미지에 대한 픽셀 단위 레이블 없이 레이블 분포 $p_t(c) = \frac{1}{WH} \sum_{i=1}^{W} \sum_{j=1}^{H} Y_t(i,j,c)$를 추정합니다.
     - **로지스틱 회귀(Logistic Regression, LR):** Inception-Resnet-v2 [57]로 추출한 이미지 특징을 입력으로 받아 소스 도메인의 실제 레이블 분포로 학습됩니다. 타겟 이미지의 레이블 분포를 직접 출력합니다.
     - **가장 가까운 이웃(Nearest Neighbors, NN) 평균:** 타겟 이미지의 가장 가까운 이웃 소스 이미지들의 레이블 분포 평균을 사용합니다.

   - **랜드마크 슈퍼픽셀의 지역 레이블 분포:**
     - 이미지를 100개의 슈퍼픽셀로 분할합니다 (선형 스펙트럼 클러스터링 [33] 사용).
     - 소스 도메인의 슈퍼픽셀에서 지배적인 레이블과 해당 특징(FCN-8s [35]로 추출한 59차원 픽셀 검출 점수 평균 및 주변 슈퍼픽셀 정보)을 사용하여 다중 클래스 SVM을 학습합니다.
     - 타겟 이미지의 슈퍼픽셀에 대해 SVM을 사용하여 분류하고, 분류 신뢰도 점수가 높은 상위 60% 슈퍼픽셀을 "랜드마크 슈퍼픽셀"로 선정합니다.
     - 이 랜드마크 슈퍼픽셀의 분류된 클래스 레이블을 원-핫 벡터(one-hot vector)로 인코딩하여 유효한 레이블 분포로 사용합니다. 이 방법은 공간적 제약(spatial constraints)을 제공합니다.

## 📊 Results

- **데이터셋:** SYNTHIA [48] 또는 GTA [47] (소스)에서 Cityscapes [12] (타겟)로의 도메인 적응을 평가했습니다. Cityscapes 검증 세트를 테스트 세트로 사용했습니다.
- **평가 지표:** PASCAL VOC Intersection-over-Union (IoU)을 사용했습니다.
- **전역 레이블 분포 추론 결과:** 로지스틱 회귀(LR)가 가장 낮은 $\chi^2$ 거리(0.27)를 보이며 가장 정확하게 타겟 이미지의 전역 레이블 분포를 추정했습니다. 이는 베이스라인(NoAdapt, 0.65)보다 훨씬 우수하며, 단순한 소스 평균(0.44)이나 균일 분포(1.13)보다도 좋습니다.
- **시맨틱 분할 결과:**
  - **NoAdapt:** 도메인 적응 없이 SYNTHIA로 학습한 FCN-8s는 Cityscapes에서 22.0%의 평균 IoU를 보였습니다 (Table 2). 이는 도로를 보도로, 자동차를 보도로 잘못 분류하는 등 심각한 불균형 예측을 야기했습니다.
  - **Ours (I):** 전역 이미지 레이블 분포를 사용한 적응은 평균 IoU를 25.5%로 크게 향상시켰으며, 특히 도로와 보도에 대한 불균형 예측을 교정했습니다.
  - **SP Lndmk / SP:** 랜드마크 슈퍼픽셀 분류(SP Lndmk) 및 전체 슈퍼픽셀 분류(SP) 자체는 각각 23.0% 및 25.6%의 IoU를 보이며 베이스라인보다 좋았습니다.
  - **Ours (SP):** 랜드마크 슈퍼픽셀 레이블 분포를 사용한 적응은 평균 IoU를 28.1%로 향상시켰습니다. 이는 하늘, 도로, 건물과 같이 큰 영역을 차지하는 카테고리에 매우 정확하지만, 울타리, 신호등, 표지판과 같은 작은 객체에서는 성능이 떨어졌습니다.
  - **Ours (I+SP):** 전역 이미지 레이블 분포와 지역 랜드마크 슈퍼픽셀 레이블 분포를 모두 사용하여 재학습한 모델은 **29.0%**의 최고 평균 IoU를 달성했습니다. 이는 서로 다른 수준의 속성이 상호 보완적으로 작동함을 보여줍니다.
  - **FCNs in the wild [27]:** 본 논문의 NoAdapt 베이스라인이 [27]의 베이스라인보다 우수함에도 불구하고, 본 논문의 방법은 베이스라인 대비 더 큰 개선(7%)을 달성하여 경쟁 방법보다 성능 우위를 입증했습니다.
  - **도메인 불변 특징 학습 비교:** 기존의 Max-Mean Discrepancy (MMD)나 도메인 분류기 역전파(gradient reversal)와 같은 도메인 불변 특징 학습 방법들은 시맨틱 분할 문제에서 베이스라인 대비 유의미한 개선을 보이지 못했습니다.
- **GTA 데이터셋 활용 결과:** SYNTHIA 대신 GTA 데이터셋을 소스로 사용했을 때도 유사한 경향을 보였으며, Ours (I+SP)가 28.9%의 최고 IoU를 달성했습니다. GTA 이미지가 SYNTHIA보다 사실적이기 때문에 전체적으로 SYNTHIA보다 성능이 향상되었습니다.

## 🧠 Insights & Discussion

- **커리큘럼 학습의 효과:** 본 연구는 시맨틱 분할과 같은 구조화된 예측 문제에 대해 커리큘럼 스타일의 도메인 적응이 매우 효과적임을 입증했습니다. 쉬운 작업(레이블 분포 추정)을 통해 얻은 타겟 도메인 지식이, 어려운 작업(픽셀 단위 분할)의 학습을 성공적으로 안내합니다.
- **속성의 상호 보완성:** 전역적 이미지 레이블 분포는 전반적인 레이블 비율 불균형을 교정하는 데 효과적이며, 지역적 랜드마크 슈퍼픽셀 레이블 분포는 공간적 제약을 제공합니다. 이 두 가지 속성은 서로 보완적으로 작용하여 분할 성능을 극대화합니다.
- **기존 접근 방식과의 차별점:** 기존의 도메인 불변 특징 학습은 분류 문제에는 효과적이지만, 픽셀 단위 예측과 같이 지수적으로 큰 레이블 공간을 다루는 시맨틱 분할에는 적합하지 않을 수 있음을 시사합니다. 본 연구는 이러한 가정을 회피하고 후방 정규화(posterior regularization)와 유사한 방식으로 도메인 적응을 수행합니다.
- **한계 및 향후 연구:** 현재 방법은 작은 객체(예: 울타리, 표지판, 신호등)의 분할에는 여전히 어려움을 겪고 있습니다. 향후에는 작은 객체를 잘 처리할 수 있는 새로운 "쉬운 작업" 또는 타겟 속성을 발굴하여 커리큘럼 프레임워크를 더욱 풍부하게 만들 필요가 있습니다.

## 📌 TL;DR

본 논문은 실제 이미지와 합성 데이터 간의 도메인 불일치 문제를 해결하기 위해 시맨틱 분할을 위한 **커리큘럼 스타일 도메인 적응(Curriculum Domain Adaptation)** 방법을 제안합니다. 이 방법은 "쉬운 작업"인 타겟 도메인의 **전역 이미지 레이블 분포**와 **지역 랜드마크 슈퍼픽셀 레이블 분포**를 먼저 추정하여 네트워크를 정규화합니다. 이는 기존 도메인 적응 기법에서 흔히 사용되는 "동일한 예측 함수" 가정을 회피하며, 기존 시맨틱 분할 네트워크 구조 변경 없이 적용 가능합니다. Cityscapes 데이터셋에 대한 실험에서, 제안된 방법은 베이스라인 및 기존 경쟁 방법들보다 우수한 시맨틱 분할 성능을 달성했습니다.
