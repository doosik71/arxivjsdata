# No More Discrimination: Cross City Adaptation of Road Scene Segmenters

Yi-Hsin Chen, Wei-Yu Chen, Yu-Ting Chen, Bo-Cheng Tsai, Yu-Chiang Frank Wang, Min Sun

## 🧩 Problem to Solve

최근 딥러닝 기반의 시맨틱 분할 모델들은 뛰어난 성능을 보이지만, 학습 데이터셋에 포함되지 않은 새로운 도시의 이미지에 적용할 경우 **데이터셋 편향(dataset bias)** 또는 **도메인 변화(domain shift)**로 인해 성능이 크게 저하됩니다. 관심 있는 각 도시마다 대규모의 주석(annotation)된 이미지를 수집하여 모델을 학습시키거나 미세 조정하는 것은 픽셀 수준 주석에 많은 시간(Cityscapes 이미지당 평균 90분)과 비용이 소요되어 비현실적입니다. 따라서 사용자 주석이나 상호작용 없이 도로 장면 분할기를 여러 도시 간에 **비지도 방식으로 적응(unsupervised adaptation)**시키는 방법이 필요합니다.

## ✨ Key Contributions

- **비지도 학습 접근 방식 제안:** 사전 학습된 도로 장면 분할기를 다양한 도시에 배포하기 위한 전역적(global) 및 클래스별(class-wise) 적응을 수행하는 비지도 학습 방법을 제안합니다.
- **정적 객체 사전 정보 활용:** Google Street View의 "타임 머신(time-machine)" 기능을 활용하여 사용자 주석이나 상호작용 없이 수집된 이미지 데이터에서 **정적 객체 사전 정보(static-object priors)**를 추출합니다.
- **적대적 학습 프레임워크 발전:** 추출된 정적 객체 사전 정보와 함께, 교차 도시 이미지에 **가상 레이블(pseudo labels)**을 할당하기 위한 적대적 학습(adversarial learning)을 발전시켜 전역적 및 클래스별 적응을 동시에 달성합니다.

## 📎 Related Works

- **CNN 기반 시맨틱 분할:** FCN, SegNet, DeepLab 등 픽셀 수준의 시맨틱 레이블 예측을 위한 CNN 기반 접근 방식들을 언급합니다.
- **도로 장면 이미지 분할:** Cityscapes, SYNTHIA와 같이 대규모 데이터셋을 활용하거나 3D 정보, 렌더링된 이미지, 약한 감독(weakly supervised) 레이블(점 레이블, 이미지 수준 레이블, 객체 크기/경계 제약)을 사용하는 연구들을 다룹니다.
- **DNN 기반 도메인 적응:** Maximum Mean Discrepancy (MMD) 기반의 DAN, RTN, Central Moment Discrepancy (CMD)를 사용한 연구와 더불어, Generative Adversarial Network (GAN) 및 Domain Adversarial Neural Network (DANN)를 활용한 도메인 적응 연구들(예: Coupled GAN, VRADA, Hoffman et al.의 FCNs in the wild)을 참조합니다.

## 🛠️ Methodology

본 논문은 사전 학습된 분할 모델을 사용자 주석 없이 대상 도시에 적응시키는 **비지도 도메인 적응(unsupervised domain adaptation)** 프레임워크를 제안합니다.

1. **도메인 변화 유형 식별:**

   - **전역적 도메인 변화(Global domain shift):** 도시 간의 전반적인 외관 차이.
   - **클래스별 도메인 변화(Class-wise domain shift):** 각 도시의 도로 장면 구성 요소의 특징적 차이.

2. **프레임워크 아키텍처 (Fig. 3):**

   - **특징 추출기($M_F(x, \theta_F)$):** 입력 이미지를 고수준의 의미론적 특징 공간으로 변환합니다.
   - **레이블 예측기($M_Y(M_F(x, \theta_F), \theta_Y)$):** 특징 공간을 작업 레이블 공간으로 매핑합니다.
   - **전역 도메인 판별기($M_G(M_F(x, \theta_F), \theta_G)$):** 소스 및 대상 도메인 이미지의 특징 차이를 판별합니다.
   - **클래스별 도메인 판별기($M_c^{class}(M_F(x, \theta_F), \theta_c^{class})$):** 각 클래스 $c$에 대해 소스 및 대상 도메인 이미지의 특징 차이를 억제합니다.
   - 모델의 전체 손실은 $L_{total} = L_{task} + \lambda_G L_G + \lambda_{class} L_{class}$ 로 정의됩니다. 여기서 $L_{task}$는 소스 도메인 이미지에 대한 예측 손실입니다.

3. **전역 도메인 정렬 (Global Domain Alignment):**

   - FCN 기반 분할기의 `fc7` 특징 맵의 각 그리드를 인스턴스로 간주합니다.
   - Ganin et al. [7]의 적대적 학습 기법을 확장하여, 손실 함수 $L_G$를 판별기($\theta_G$)를 훈련시키는 $L_D^G$와 특징 추출기($\theta_F$)를 업데이트하는 $L_{Dinv}^G$로 분해하여 그래디언트 소실 문제를 완화합니다. 목표는 $L_G = L_D^G + L_{Dinv}^G$를 반복적으로 최소화하는 것입니다.

4. **클래스별 도메인 정렬 (Class-wise Domain Alignment):**

   - 대상 도메인 이미지에 레이블 주석이 없으므로, 사전 학습된 분할기에서 얻은 예측 확률 분포 맵 $\phi(I_T)$을 **"소프트 가상 레이블(soft pseudo labels)"**로 사용합니다.
   - **픽셀-그리드 레벨 가상 레이블 할당:** 픽셀 레벨의 (가상) 레이블을 특징 공간의 각 그리드로 전파하여, 각 그리드가 특정 클래스 $c$에 속할 확률 $\tilde{\Phi}_c^n(I_S)$ 및 $\tilde{\Phi}_c^n(I_T)$를 계산합니다.
   - **클래스별 적대적 학습:** 여러 개의 클래스별 도메인 판별기 $M_c^{class}$를 배포하며, 각 판별기는 해당 클래스 $c$의 객체를 도메인 간에 구별하도록 훈련됩니다. 소프트 가상 레이블을 사용하여 클래스별 적대적 손실 $L_{class} = L_D^{class} + L_{Dinv}^{class}$를 정의하고 최적화합니다.

5. **정적 객체 사전 정보 활용 (Harvesting Static-Object Prior):**
   - Google Street View의 타임 머신 기능을 사용하여 동일한 위치에서 다른 시간에 촬영된 이미지 쌍을 수집합니다.
   - **DeepMatching [36]**을 사용하여 이미지 쌍 내 픽셀 간의 밀집 매칭을 수행합니다 (정적 객체 영역 식별).
   - **Entropy Rate Superpixel [17]**을 사용하여 이미지 쌍에 슈퍼픽셀 분할을 적용합니다.
   - $k$개 이상의 매칭된 픽셀을 포함하는 매칭된 슈퍼픽셀을 **정적 객체 사전 정보 $P_{static}(I_T)$**로 간주합니다.
   - $P_{static}(I_T)$에 속하는 픽셀에 대해, 해당 픽셀이 비정적 객체일 확률을 억제하여 소프트 가상 레이블을 정제합니다.

## 📊 Results

- **교차 도시 차별성 (Cross-City Discrimination):** Cityscapes (프랑크푸르트)에서 사전 학습된 분할기를 로마, 리오, 도쿄, 타이베이와 같은 다른 도시에 적용했을 때, mIoU(평균 IoU)가 **25-30% 감소**하는 심각한 성능 저하가 관찰되었습니다. 이는 문화적 차이로 인한 시각적 외관의 차이가 분할기 정확도에 크게 영향을 미침을 보여줍니다.
- **교차 도시 적응 (Cityscapes → Our Dataset):**
  - 제안된 **전역 정렬(GA)**만으로 평균 **2.6%의 mIoU 개선**을 보였습니다.
  - **클래스별 정렬(CA)**을 추가했을 때 평균 **0.9%의 mIoU가 추가 개선**되었습니다.
  - **정적 객체 사전 정보(Static-object prior)**를 최종적으로 적용했을 때 평균 **0.6%의 mIoU가 추가 개선**되어, 총체적으로 상당한 성능 향상을 달성했습니다.
  - t-SNE 시각화 결과는 "Pre-trained"에서 "GA"를 거쳐 "GA+CA"로 갈수록 도메인 간의 특징 공간 정렬이 점진적으로 개선됨을 보여줍니다.
  - 이는 각 구성 요소의 효과를 정량적, 정성적으로 입증합니다.
- **합성 데이터 → 실제 데이터 적응 (SYNTHIA → Cityscapes):**
  - Google Street View와 같은 시간 정보를 활용할 수 없는 상황(Cityscapes에 시간 정보가 없는 경우)에서도 제안된 방법은 효과적이었습니다.
  - GA는 3.1%의 mIoU 개선을, GA+CA는 추가 1.9%의 mIoU 개선을 보여, 다른 유형의 도메인 변화에 대해서도 방법론의 견고성을 입증했습니다.

## 🧠 Insights & Discussion

- 이 연구는 딥러닝 기반 시맨틱 분할 모델이 새로운 도시 환경에 배포될 때 발생하는 심각한 성능 저하 문제를 효과적으로 해결하기 위한 **비지도 도메인 적응의 중요성**을 강조합니다.
- **전역적 및 클래스별 적대적 학습의 결합**은 도메인 간의 전체적인 외관 차이와 클래스 구성 차이를 동시에 완화하는 데 효과적임을 입증했습니다.
- Google Street View의 "타임 머신" 기능을 활용하여 **정적 객체 사전 정보를 비지도 방식으로 추출**하고 이를 가상 레이블 정제에 활용한 것은 본 연구의 독창적인 기여이며, 실제 데이터에서 추가적인 정보원을 발굴하는 새로운 가능성을 제시합니다.
- 각 제안된 구성 요소(전역 정렬, 클래스별 정렬, 정적 객체 사전 정보)가 개별적으로 그리고 함께 성능 향상에 기여함을 실험적으로 확인했습니다.
- 본 방법론은 실제 도시 간 적응뿐만 아니라 합성-실제 데이터 간 적응과 같이 **다양한 도메인 변화 시나리오에도 일반화될 수 있음**을 보여주어 그 적용 범위를 넓혔습니다.
- 새로운 도시 도로 장면 데이터셋(4개 도시, 시간 정보 포함, 평가용 고품질 주석)의 제공은 향후 관련 연구에 중요한 자원이 될 것입니다.

## 📌 TL;DR

도로 장면 분할 모델이 훈련되지 않은 도시에 적용될 때 발생하는 성능 저하(도메인 변화)와 고비용의 수동 주석 문제를 해결하기 위해, 본 논문은 **비지도 도메인 적응 프레임워크**를 제안합니다. 이 프레임워크는 전역적 및 클래스별 **적대적 학습**을 결합하고, Google Street View의 "타임 머신" 기능에서 얻은 **정적 객체 사전 정보**로 생성된 "소프트 가상 레이블"을 정제하여 활용합니다. 이 방법은 수동 주석 없이 다양한 도시에서 분할 정확도를 크게 향상시키며, 지도 학습 기반의 상한선에 필적하는 성능을 달성함을 입증했습니다.
