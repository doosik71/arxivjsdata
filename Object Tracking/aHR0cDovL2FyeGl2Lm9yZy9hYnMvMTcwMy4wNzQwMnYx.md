# SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC

Nicolai Wojke, Alex Bewley, Dietrich Paulus

## 🧩 Problem to Solve

기존 SORT(Simple Online and Realtime Tracking)는 간단하고 효율적이지만, 주로 바운딩 박스 중첩률(IoU) 기반의 연결 방식을 사용하여 긴 시간의 폐색(occlusion) 상황에서 객체 ID 전환(identity switches)이 빈번하게 발생한다는 한계가 있습니다. 특히 추정 불확실성이 높은 경우 연결 정확도가 떨어져 추적 성능이 저하됩니다.

## ✨ Key Contributions

- 폐색 상황에서 객체 ID 유지를 개선하기 위해 SORT에 **깊이 학습 기반의 외형(appearance) 정보**를 통합했습니다.
- 오프라인에서 대규모 보행자 재식별(person re-identification) 데이터셋으로 학습된 **깊은 연결 척도(deep association metric)**를 도입하여, 온라인 추적 시 외형 공간에서의 최근접 이웃(nearest neighbor) 쿼리를 통해 측정값-트랙 연결을 수행합니다.
- 움직임 정보(마할라노비스 거리)와 외형 정보(코사인 거리)를 결합한 새로운 연결 비용 함수를 제안하고, **매칭 캐스케이드(matching cascade)** 방식을 도입하여 더 자주 보이는 객체에 우선순위를 부여함으로써 추적 안정성을 높였습니다.
- MOT16 벤치마크에서 기존 SORT 대비 **ID 전환을 약 45% 감소**시키면서 경쟁력 있는 전체 성능을 유지하고 실시간 추적 속도를 달성했습니다.
- 제안하는 모델의 코드와 사전 학습된 CNN 모델을 공개하여 연구 및 실제 응용 개발을 용이하게 했습니다.

## 📎 Related Works

- **추적-by-검출(Tracking-by-detection) 패러다임:** 객체 검출의 발전으로 컴퓨터 비전 분야의 주류가 되었습니다.
  - **전역 최적화 방식:** 플로우 네트워크(flow network) [1, 2, 3] 및 확률적 그래픽 모델(probabilistic graphical models) [4, 5, 6, 7]은 전체 비디오를 배치(batch) 처리하여 온라인 시나리오에 부적합합니다.
  - **전통적인 온라인 방식:** MHT(Multiple Hypothesis Tracking) [8] 및 JPDAF(Joint Probabilistic Data Association Filter) [9]는 프레임별 데이터 연결을 수행하지만 계산 및 구현 복잡도가 높습니다.
- **기존 SORT (Simple Online and Realtime Tracking)** [12]: 이미지 공간에서 칼만 필터링과 헝가리안 메소드를 사용하여 프레임별 데이터 연결을 수행하는 간단한 프레임워크입니다. 높은 프레임률에서 좋은 성능을 보이지만, ID 전환이 상대적으로 많다는 한계가 있습니다.

## 🛠️ Methodology

본 논문은 재귀적인 칼만 필터링과 프레임별 데이터 연결을 사용하는 단일 가설 추적 방법론을 채택하며, 기존 SORT 프레임워크를 확장합니다.

- **트랙 관리 및 상태 추정 (Track Handling and State Estimation):**
  - 8차원 상태 공간 $(u, v, \gamma, h, \dot{x}, \dot{y}, \dot{\gamma}, \dot{h})$을 사용합니다. 여기서 $u, v$는 바운딩 박스 중심 위치, $\gamma$는 종횡비, $h$는 높이이며, 뒤의 네 항은 각각의 속도입니다.
  - 객체 상태의 직접적인 관측값으로 바운딩 박스 좌표 $(u, v, \gamma, h)$를 사용하는 표준 칼만 필터를 적용합니다.
  - 각 트랙에 대해 마지막 성공적인 연결 이후 프레임 수 $a_k$를 카운트하며, 미리 정의된 최대 나이 $A_{max}$를 초과하는 트랙은 삭제됩니다.
  - 새로운 트랙 가설은 기존 트랙과 연결되지 않은 각 검출에 대해 초기화되며, 처음 세 프레임 동안 임시(tentative) 상태로 분류됩니다.
- **연결 문제 (Assignment Problem):**
  - 예측된 칼만 상태와 새로 도착한 측정값 간의 연결은 헝가리안 알고리즘(Hungarian algorithm)을 사용하여 해결됩니다.
  - **움직임 척도:** 마할라노비스 거리(Mahalanobis distance) $d^{(1)}(i,j) = (d_j - y_i)^T S_i^{-1} (d_j - y_i)$를 사용하여 예측된 칼만 상태와 측정값 사이의 거리를 계산합니다.
    - 이 거리는 상태 추정 불확실성을 고려하며, 4차원 측정 공간에 대해 95% 신뢰 구간에 해당하는 $t^{(1)} = 9.4877$로 게이팅(gating)됩니다.
  - **외형 척도:** 각 바운딩 박스 검출 $d_j$에 대해 정규화된 외형 기술자(appearance descriptor) $r_j$를 계산합니다. 각 트랙 $k$에 대해 마지막 $L_k = 100$개의 연결된 외형 기술자 갤러리 $R_k$를 유지합니다.
    - 외형 공간에서 트랙 $i$와 검출 $j$ 사이의 가장 작은 코사인 거리(cosine distance) $d^{(2)}(i,j) = \min\{1-r_j^T r^{(i)}_k | r^{(i)}_k \in R_i\}$를 사용합니다.
    - 이 또한 임계값 $t^{(2)}$로 게이팅됩니다.
  - **두 척도의 결합:** 연결 비용은 가중합 $c_{i,j} = \lambda d^{(1)}(i,j) + (1-\lambda) d^{(2)}(i,j)$으로 계산됩니다. 연결은 두 척도 모두에 의해 허용될 때 유효합니다($b_{i,j} = \prod_{m=1}^{2} b^{(m)}_{i,j}$).
- **매칭 캐스케이드 (Matching Cascade):**
  - 전역적인 할당 문제 대신, 일련의 하위 문제를 해결하는 캐스케이드를 도입합니다.
  - 이는 나이(age)가 작은(즉, 최근에 더 자주 관측된) 트랙에 우선순위를 부여하여, 마할라노비스 거리가 불확실성이 큰 트랙을 선호하는 경향으로 인한 트랙 단편화(fragmentation) 문제를 완화합니다.
  - 알고리즘은 트랙 나이 $n \in \{1, \dots, A_{max}\}$에 따라 반복하며 선형 할당 문제를 해결하고, 매칭된 트랙과 남은 검출을 업데이트합니다.
  - 마지막 매칭 단계에서는 초기 SORT의 IoU 연결 방식을 사용하여 갑작스러운 외형 변화나 초기화 오류를 처리합니다.
- **깊은 외형 기술자 (Deep Appearance Descriptor):**
  - 대규모 보행자 재식별 데이터셋(MARS)으로 오프라인에서 사전 학습된 CNN을 사용하여 외형 기술자를 생성합니다.
  - CNN 아키텍처는 두 개의 컨볼루션 레이어와 6개의 잔차 블록으로 구성된 와이드 잔차 네트워크(wide residual network)입니다.
  - 최종 128차원 특징 맵은 배치 정규화(batch normalization) 및 $L_2$ 정규화를 통해 단위 초구(unit hypersphere)에 투영되어 코사인 외형 척도와 호환됩니다.

## 📊 Results

- **데이터셋:** MOT16 벤치마크의 7개 테스트 시퀀스에서 평가되었습니다.
- **검출기:** Yu et al. [16]이 제공한 Faster R-CNN 검출기를 사용하였으며, 공정한 비교를 위해 SORT도 동일한 검출기로 재실행되었습니다.
- **주요 성능 지표 (MOTA, MOTP, MT, ML, ID, FM):**
  - **ID 전환 (ID Sw.):** 기존 SORT의 1423회에서 Deep SORT는 781회로, **약 45% 감소**했습니다. 이는 본 방법의 핵심 목표인 ID 유지 개선을 성공적으로 보여줍니다.
  - **Mostly Tracked (MT):** 25.4%에서 32.8%로 증가했고, **Mostly Lost (ML):** 22.7%에서 18.2%로 감소했습니다. 이는 더 많은 객체가 수명 주기 동안 꾸준히 추적되고 덜 손실됨을 의미합니다.
  - **트랙 단편화 (FM):** 1835회에서 2008회로 소폭 증가했습니다. 이는 폐색 및 누락된 검출을 통해 객체 ID를 유지하는 과정에서 발생하는 trade-off로 해석됩니다.
  - **MOTA (Multi-Object Tracking Accuracy):** 59.8%에서 61.4%로 상승하여 전반적인 추적 정확도도 향상되었습니다.
  - **실시간 성능:** 약 20 Hz의 프레임률로 동작하며, 이 중 절반 정도의 시간이 특징 생성에 소요됩니다. 최신 GPU 환경에서 실시간 추적에 적합합니다.

## 🧠 Insights & Discussion

- **ID 유지 개선:** 외형 정보 통합을 통해 특히 긴 폐색 기간 동안 객체 ID를 성공적으로 유지하는 데 큰 효과를 보였습니다. 이는 정량적 지표(ID 감소, MT 증가)뿐만 아니라 질적 분석에서도 확인되었습니다.
- **경쟁력:** 제안된 방법은 다른 온라인 추적 방법들과 비교했을 때, 가장 적은 수의 ID 전환을 달성하면서도 전반적인 MOTA 점수와 다른 지표들에서 경쟁력을 유지합니다.
- **한계 및 향후 개선점:**
  - MOTA 점수는 비교적 많은 수의 오탐(false positives, FP)으로 인해 부분적으로 저해되었습니다. 이는 주로 정적 장면 기하학에서 발생하는 산발적인 검출기 반응과 트랙 최대 나이($A_{max}$) 설정 때문으로 보입니다.
  - 그러나 이러한 오탐이 자주 트랙을 건너뛰게 하는 대신, 트래커는 보고된 객체 위치에서 비교적 안정적인 정지 트랙을 생성하는 경향이 있었습니다.
  - 검출 신뢰도 임계값을 높이면 FP를 줄여 MOTA 성능을 크게 향상시킬 잠재력이 있습니다.

## 📌 TL;DR

Deep SORT는 기존 SORT의 높은 ID 전환 문제를 해결하기 위해 **깊은 학습 기반의 외형 정보**를 통합한 실시간 온라인 다중 객체 추적 알고리즘입니다. **칼만 필터의 움직임 예측**과 **사전 학습된 CNN 기반 외형 기술자의 코사인 거리**를 결합한 새로운 연결 척도를 사용하고, **매칭 캐스케이드**를 통해 트랙의 나이에 따라 연결 우선순위를 부여합니다. 이를 통해 MOT16 벤치마크에서 **ID 전환율을 45% 감소**시키는 동시에 높은 추적 정확도와 실시간 성능을 달성하여, 긴 폐색 상황에서도 객체 ID를 효과적으로 유지할 수 있음을 입증했습니다.
