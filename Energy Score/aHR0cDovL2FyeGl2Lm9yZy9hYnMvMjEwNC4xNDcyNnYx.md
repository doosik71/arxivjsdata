# MOOD: Multi-level Out-of-distribution Detection

Ziqian Lin, Sreya Dutta Roy, Yixuan Li

## 🧩 Problem to Solve

현재 OOD(Out-of-distribution) 감지 방법들은 대부분 신경망의 최종 레이어 출력을 사용하며, 모든 입력에 대해 전체 순방향 전달(full feedforward pass)을 요구합니다. 이는 모델 배포 시 높은 계산 비용과 지연 시간을 초래하여, 자율주행차와 같은 안전에 중요한 애플리케이션에 적합하지 않습니다. 또한, 최신 딥러닝 모델의 과도한 파라미터 수는 이러한 계산 비용 문제를 더욱 악화시킵니다. 따라서, 입력의 특성에 따라 계산량을 동적으로 조절하여 OOD 감지를 수행하는 효율적인 방법이 필요합니다.

## ✨ Key Contributions

- **다단계 OOD 감지 (MOOD) 프레임워크 제안:** 동적이고 효율적인 OOD 추론을 위해 중간 분류기 출력을 활용하는 새로운 프레임워크를 제안합니다.
- **OOD 데이터 복잡도와 최적 종료 수준 간의 관계 규명:** 쉬운 OOD 샘플은 깊은 레이어까지 전파하지 않고도 조기에 효과적으로 감지될 수 있음을 보여줍니다.
- **조정된 에너지 점수 (Adjusted Energy Score) 도입:** 여러 분류기를 가진 네트워크에 적합하며, 종료 지점(exit) 간 점수 비교 가능성을 높이는 새로운 OOD 스코어링 함수를 제안합니다.
- **계산 효율성 및 성능 입증:** 광범위한 복잡도를 가진 10개 OOD 데이터셋에 대한 광범위한 실험을 통해 최대 71.05%의 계산량 감소를 달성하면서도 경쟁력 있는 OOD 감지 성능을 유지함을 입증했습니다.

## 📎 Related Works

- **적응형 추론 네트워크 (Adaptive Inference Networks):** FractalNets, Big-Little Net, MSDNet 등은 주로 인-분포(In-distribution, ID) 데이터의 분류 정확도를 최적화하는 데 중점을 두었으나, OOD 감지를 위한 동적 추론은 본 연구에서 처음으로 깊이 탐구되었습니다.
- **최종 출력을 활용한 OOD 감지:** MSP, ODIN, Mahalanobis, Energy 기반 방법 등 기존 OOD 감지 솔루션들은 주로 신경망의 최종 또는 마지막에서 두 번째 레이어의 출력을 활용하며 고정된 계산량을 요구합니다.
- **중간 정보를 활용한 OOD 감지:** 일부 연구는 중간 레이어의 특징이나 출력을 OOD 감지에 사용했지만, 적응형 종료 결정은 이루어지지 않아 계산 병목 현상이 해결되지 않았습니다.
- **복잡도와 OOD 감지:** 콜모고로프 복잡도 또는 무손실 압축 알고리즘을 프록시로 사용하여 OOD 점수를 도출하는 연구가 있었으나, MOOD는 이를 다단계 종료 개념과 결합하여 동적 추론을 가능하게 합니다.

## 🛠️ Methodology

MOOD 프레임워크는 세 가지 핵심 과제를 해결하여 동적 OOD 감지를 가능하게 합니다:

1. **조기 종료를 위한 OOD 감지기 설정:**
   - $k$개의 분류기로 구성된 적응형 추론 모델을 사용합니다. 이 모델은 일반적인 CNN으로 간주할 수 있으며, 각 블록마다 $k-1$개의 중간 분류기가 연결되어 있습니다.
   - 각 분류기(종료 지점)에 중간 OOD 감지기 $G_i(x)$를 도입하여 동적 OOD 추론을 가능하게 합니다.
   - 핵심 아이디어는 '쉬운' OOD 샘플은 초기 레이어에서 감지하고, '복잡한' 샘플은 더 깊은 레이어로 전파하여 더 확신하는 결정을 내리도록 하는 것입니다.
2. **복잡도 기반 OOD 감지용 종료 전략:**
   - 기존의 예측 신뢰도 기반 종료 방식은 모델이 OOD 데이터에 노출되지 않았기 때문에 OOD 감지에 부적합하다고 판단합니다.
   - 모델에 구애받지 않는 **복잡도 점수**를 활용합니다. 이미지 $x$의 복잡도는 무손실 압축 알고리즘(예: PNG, JPEG2000)으로 압축된 비트 길이 $L(x) = \text{Bit length}(c(x))$로 정의됩니다. 이를 인-분포 데이터셋의 최대 복잡도로 정규화합니다 ($L_{\text{normalized}} = L(x) / L_{\text{max}}$).
   - 정규화된 복잡도 $L_{\text{normalized}}(x)$에 따라 $k$개의 서브-범위 중 적절한 종료 지점 $I(x) = \min(\lfloor L_{\text{normalized}}(x) \times k \rfloor, k)$를 동적으로 선택합니다.
3. **OOD 스코어링 함수: 조정된 에너지 점수 ($E_{\text{adjusted}}$):**
   - 기존 에너지 점수 $E(x;\theta_i) = -\log \sum_{j=1}^{C} e^{f^{(j)}_i(x;\theta_i)}$는 여러 분류기가 존재할 때 종료 지점마다 스케일이 달라져 점수 비교가 어렵다는 문제가 있습니다.
   - 이를 해결하기 위해 **조정된 에너지 점수** $E_{\text{adjusted}}(x;\theta_i) = -E(x;\theta_i) - E_{x \in D_{\text{in}}}[-E(x;\theta_i)]$를 제안합니다. 이는 각 종료 지점의 평균 에너지 점수를 빼주어 점수들이 서로 비교 가능하도록 정규화합니다.
   - 추론 시 모든 종료 지점에 단일 임계값 $\gamma$ (예: 인-분포 데이터의 95%가 임계값 이상이 되도록 설정)를 사용합니다.

**추론 알고리즘:**

1. 입력 $x$의 정규화된 복잡도 $L_{\text{normalized}}$를 계산합니다.
2. 이를 기반으로 종료 분류기 $I(x)$를 선택합니다.
3. 선택된 종료 지점의 조정된 에너지 점수 $E_{\text{adjusted}}(x;\theta_{I(x)})$가 임계값 $\gamma$보다 크거나 같으면 인-분포로, 아니면 OOD로 분류합니다. 인-분포일 경우 해당 종료 지점의 분류 결과를 사용합니다.

## 📊 Results

- **계산 비용 감소:** MOOD는 10개 OOD 데이터셋 전체 평균 22.02%의 계산량 (FLOPs)을 줄였으며, 복잡도가 낮은 데이터셋(예: MNIST)에서는 최대 71.05%까지 감소했습니다.
- **경쟁력 있는 OOD 감지 성능:** MOOD는 기존의 최종 출력 기반 OOD 감지 방법들(MSP, ODIN, Mahalanobis, Energy)과 비교하여 동등하거나 더 나은 AUROC 및 FPR95 성능을 달성했습니다. 예를 들어, CIFAR-100 ID 데이터셋에 대해 평균 AUROC 0.8497로 기존 Energy 방식의 0.8451보다 우수했습니다.
- **복잡도와 최적 종료 수준의 관계 입증:** 낮은 복잡도의 데이터셋(예: MNIST)은 조기 종료(Exit@1)가 더 자주 선택되고, 높은 복잡도의 데이터셋(예: iSUN)은 더 깊은 종료가 선호되는 경향을 보였습니다. 이는 MOOD가 OOD 데이터 복잡도와 계산 비용 간의 직접적인 관계를 효과적으로 활용함을 나타냅니다.
- **스코어링 함수 호환성:** MOOD는 조정된 에너지 점수가 가장 좋은 성능을 보였으나, MSP나 ODIN과 같은 다른 스코어링 함수와도 호환되어 일관된 성능 향상을 제공함을 확인했습니다.
- **모델 용량 영향:** MSDNet의 깊이가 증가함에 따라 MOOD의 성능 향상이 더욱 두드러져, 다양한 모델 용량에서 MOOD의 적용 가능성을 시사합니다.
- **인-분포 분류 정확도 유지:** OOD 감지 효율성 향상과 함께 인-분포 데이터에 대한 분류 정확도도 높게 유지되었습니다.
- **종료 전략 비교:** 복잡도 기반 종료 전략은 욕심 기반(Greedy-based) 또는 무작위(Randomized) 종료 전략보다 우수한 OOD 감지 성능을 보였습니다 (예: Greedy보다 9.26% 낮은 FPR95).

## 🧠 Insights & Discussion

- MOOD는 OOD 감지에 대한 동적이고 자원 효율적인 접근 방식을 제시하여, 기존의 고정된 추론 방식이 가진 높은 계산 비용 및 지연 시간의 한계를 극복합니다.
- 데이터의 내재적 복잡성(압축 비트 길이로 측정)을 활용하여 쉬운 OOD 예제를 조기에 감지함으로써 계산 비용을 크게 절감하면서도 강력한 OOD 감지 성능을 유지합니다. 이는 계산 효율성과 감지 정확도라는 두 가지 이점을 동시에 제공함을 보여줍니다.
- 특히, '조정된 에너지 점수'는 다중 분류기 환경에서 에너지 점수들의 비교 가능성을 높여 OOD 감지 신뢰도를 향상시키는 핵심 요소입니다.
- 모델에 의존하지 않는 복잡도 기반 종료 전략과 매개변수가 없는(parameter-free) OOD 추론 방식은 MOOD를 실용적이고 배포하기 쉽게 만듭니다.
- 이 연구는 OOD 감지에서 계산 효율성 측면의 중요성을 강조하며, 특히 안전에 중요한 애플리케이션에서 동적 추론의 필요성을 제시합니다.
- 한계점으로는 복잡도 점수가 콜모고로프 복잡도의 근사치이며, 인-분포 데이터에서 임계값 $\gamma$를 설정해야 한다는 점을 들 수 있습니다.

## 📌 TL;DR

**문제:** 기존 OOD 감지 방법은 신경망의 고정된 전체 순방향 전달로 인해 높은 계산 비용과 지연 시간을 초래합니다.
**제안 방법:** MOOD (Multi-level Out-of-distribution Detection)는 입력 이미지의 복잡도(무손실 압축 비트 길이)에 따라 신경망의 최적 종료 지점($I(x) = \min(\lfloor L_{\text{normalized}}(x) \times k \rfloor, k)$)을 동적으로 선택합니다. 각 종료 지점에서는 '조정된 에너지 점수'($E_{\text{adjusted}}(x;\theta_i) = -E(x;\theta_i) - E_{x \in D_{\text{in}}}[-E(x;\theta_i)]$)를 사용하여 OOD를 효율적으로 감지합니다.
**주요 결과:** MOOD는 OOD 감지 성능을 유지하거나 향상시키면서 계산 비용을 최대 71.05%까지 크게 줄였습니다 (평균 22.02% 감소). 이는 OOD 데이터의 복잡성과 최적 종료 수준 사이의 직접적인 관계를 활용하여 계산 효율성과 감지 정확도를 모두 달성한 결과입니다.
