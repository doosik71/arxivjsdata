# Real-Time Anomaly Detection for Streaming Analytics

Subutai Ahmad, Scott Purdy

## 🧩 Problem to Solve

이 논문은 스트리밍 시계열 데이터에서 실시간 이상 감지(Anomaly Detection)를 수행하는 문제를 다룹니다. 이 작업은 다음과 같은 여러 가지 난제를 수반합니다:

- **실시간 처리:** 배치(batch) 방식이 아닌 실시간으로 데이터를 처리하고 의사결정을 내려야 합니다.
- **지속적인 학습 및 적응:** 시스템의 통계적 특성이 끊임없이 변화하므로, 이상 감지기는 새로운 "정상" 상태에 지속적으로 학습하고 적응해야 합니다 (비정상(non-stationary) 데이터).
- **비지도 학습 및 자동화:** 대부분의 시나리오에서 대규모 스트림에 대한 전문가의 개입이 어려우므로, 비지도(unsupervised) 방식으로 자동화되어야 합니다.
- **미묘한 이상 감지:** 명확한 값의 범위를 벗어나는 공간적(spatial) 이상뿐만 아니라, 발생 순서가 비정상적인 시간적(temporal) 이상까지 감지해야 합니다.
- **노이즈 처리:** 본질적으로 노이즈가 많고 예측 불가능한 스트림에서 과도한 오탐(false positives) 없이 이상을 정확하게 식별해야 합니다.

## ✨ Key Contributions

- **새로운 HTM 기반 이상 감지 기술 제안:** Hierarchical Temporal Memory (HTM) 네트워크를 사용하여 실시간 스트리밍 데이터의 공간적, 시간적 패턴을 모델링하고 이상을 감지하는 새로운 방법을 제시합니다.
- **강력하고 효율적인 시스템:** HTM 기반 시스템은 효율적이고 노이즈 데이터에 매우 강하며, 데이터 통계의 변화에 지속적으로 적응합니다.
- **미묘한 이상 감지:** 미묘한 이상까지 감지하면서도 오탐을 최소화합니다.
- **확장 가능한 다중 모델 처리:** 여러 독립적인 HTM 모델을 결합하여 복잡한 시스템의 전반적인 이상 가능성을 평가하는 메커니즘을 제안합니다.
- **NAB 벤치마크 최고 성능 달성:** 실시간 이상 감지를 위한 공개 벤치마크인 Numenta Anomaly Benchmark (NAB)에서 동급 최고의 결과를 달성했음을 보여줍니다.
- **상업적 배포 및 오픈 소스 공개:** 알고리즘이 상업적으로 배포되었으며, 전체 소스 코드를 오픈 소스로 공개하여 커뮤니티에 기여합니다.

## 📎 Related Works

이 논문은 시간-시계열 이상 감지에 대한 다양한 기존 연구들을 언급하고, 제안하는 HTM 기반 방식과의 차별점을 강조합니다.

- **분류 기반 방법 (Classification-based methods):** 지도(supervised) 또는 준지도(semi-supervised) 방식으로, 레이블링된 데이터가 필요하며 지속적인 학습이 어렵습니다.
- **단순 임계값, 클러스터링, 지수 평활 (Exponential Smoothing):** 공간적 이상만 감지할 수 있으며, 데이터 변화에 따라 임계값 조정이 자주 필요하여 오탐이 많을 수 있습니다 (예: Holt-Winters).
- **변화점 감지 방법 (Change Point Detection methods):** 시간적 이상 감지가 가능하며, 이동 윈도우(moving windows)를 사용하지만 윈도우 크기 및 임계값에 민감할 수 있습니다 (예: Basseville & Nikiforov).
- **Skyline 프로젝트 (Etsy Skyline):** 스트리밍 데이터 이상 감지를 위한 오픈 소스 통계 기법 앙상블을 제공합니다.
- **ARIMA:** 계절성을 가진 시계열 데이터 모델링에 효과적이지만, 계절성 주기를 동적으로 결정하기 어렵습니다.
- **베이즈 변화점 감지 (Bayesian Change Point Detection):** 온라인 이상 감지에 사용될 수 있지만, 데이터 분포(가우시안 또는 감마)에 대한 강한 가정을 필요로 합니다.
- **EGADS (Yahoo) 및 Twitter의 알고리즘:** 시계열 예측과 이상 감지 알고리즘을 결합한 오픈 소스 프레임워크로, 공간적 및 시간적 이상 감지가 가능합니다.
- **도메인 특정 모델:** 항공기 엔진, 클라우드 데이터센터 온도, ATM 사기 감지 등 특정 도메인에 특화된 모델이 있지만, 범용 애플리케이션에는 부적합합니다.

기존 방법들은 주로 특정 유형의 이상 감지에 초점을 맞추거나, 지속적인 학습 및 적응, 또는 미묘한 시간적 이상 감지에서 HTM만큼의 유연성과 성능을 보이지 못합니다.

## 🛠️ Methodology

제안된 HTM 기반 이상 감지 방법은 다음과 같은 단계로 진행됩니다.

1. **HTM 내부 표현 활용:**

   - 입력 데이터 $x_t$가 주어지면, HTM 네트워크는 두 가지 내부 표현을 생성합니다:
     - $a(x_t)$: 현재 입력 $x_t$를 나타내는 희소 이진 코드(sparse binary code).
     - $\pi(x_{t-1})$: 다음 입력 $x_t$에 대한 HTM 모델의 예측을 나타내는 상태 벡터.
   - 이 예측 벡터는 현재 감지된 시퀀스와 입력의 시퀀스 내 위치에 따라 달라집니다.

2. **원시 이상 점수 ($s_t$) 계산:**

   - 모델의 예측과 실제 입력 간의 편차를 측정하는 원시 이상 점수 $s_t$는 다음과 같이 계산됩니다:
     $$s_t = 1 - \frac{\pi(x_{t-1}) \cdot a(x_t)}{|a(x_t)|}$$
   - $s_t$는 현재 입력이 완벽하게 예측되면 0, 완전히 예측되지 않으면 1이 됩니다. HTM의 지속적인 학습 특성 덕분에 시스템 동작에 변화가 생기면 $s_t$는 일시적으로 높아지지만, 모델이 "새로운 정상"에 적응하면서 0으로 돌아갑니다.

3. **이상 가능성 ($L_t$) 계산:**

   - 노이즈가 많은 시나리오에서 원시 이상 점수 $s_t$를 직접 임계값으로 사용하는 것은 많은 오탐을 유발할 수 있습니다. 이를 해결하기 위해 이상 점수 $s_t$의 분포를 모델링하여 현재 상태가 이상할 가능성(anomaly likelihood)을 계산합니다.
   - 최근 $W$개의 원시 이상 점수($s_t$) 윈도우를 유지하고, 이들의 표본 평균($\mu_t$)과 분산($\sigma_t^2$)을 rolling normal distribution으로 지속적으로 업데이트합니다:
     $$\mu_t = \frac{\sum_{i=0}^{W-1} s_{t-i}}{W}$$
     $$\sigma_t^2 = \frac{\sum_{i=0}^{W-1} (s_{t-i} - \mu_t)^2}{W-1}$$
   - 단기 이동 평균 $\tilde{\mu}_t$ (최근 $W'$개의 $s_t$의 평균)을 계산하고, 가우시안 꼬리 확률(Q-함수)을 사용하여 이상 가능성 $L_t$를 정의합니다:
     $$L_t = 1 - Q \left( \frac{\tilde{\mu}_t - \mu_t}{\sigma_t} \right)$$
     여기서 $\tilde{\mu}_t = \frac{\sum_{i=0}^{W'-1} s_{t-i}}{W'}$ 이고 $W' \ll W$입니다.
   - $L_t$가 임계값 $(1-\epsilon)$ 이상일 때 이상으로 간주합니다:
     $$\text{anomaly detected} \equiv L_t \ge 1 - \epsilon$$

4. **여러 독립 모델 결합 (복합 시스템):**

   - 여러 센서 스트림이 있는 복잡한 시스템의 경우, 각 스트림에 대해 개별 HTM 모델을 사용합니다.
   - 각 모델에서 계산된 이상 가능성 $Q(\frac{\tilde{\mu}_t^i - \mu_t^i}{\sigma_t^i})$ (즉, $1-L_t^i$)를 결합하여 시스템 전체의 전반적인 이상 가능성을 측정합니다.
   - 모델 간 시간 지연을 처리하기 위해 가우시안 컨볼루션 커널 $G(x; \sigma)$를 각 모델의 $Q$-값에 적용하여 최종 결합 이상 가능성 $L_t$를 계산합니다:
     $$L_t = 1 - \prod_{i=0}^{M-1} 2(G * Q)\left( \frac{\tilde{\mu}_t^i - \mu_t^i}{\sigma_t^i} \right)$$
     여기서 \*는 컨볼루션을 의미하며, 실시간 시스템이므로 반정규 분포 커널(half-normal distribution kernel)을 사용합니다.

5. **실용적 고려사항:**
   - **파라미터:** $W$ (이상 점수 분포 계산 기간), $W'$ (단기 이동 평균 기간), $\epsilon$ (오탐율 제어 임계값, 일반적으로 $10^{-5}$ 사용), $\sigma$ (컨볼루션 커널 폭).
   - **계산 효율성:** 각 모델은 현재 고성능 노트북에서 입력 벡터당 10밀리초 미만으로 처리되며, 서버에서는 병렬로 5,000개 모델까지 실행 가능합니다.

## 📊 Results

- **정성적 결과 (상용 애플리케이션):**

  - **금융 지표:** 실시간 금융 이상 감지 애플리케이션에서 HTM의 효과를 입증했습니다. 예를 들어, 트위터 활동량의 이상(배당 감소와 관련)이 주가 급락에 선행하여 발생했음을 시장 개장 전에 감지했습니다.
  - **미묘한 시간적 이상:** 페이스북 주식 거래량 데이터에서 두 번 연속 발생하는 급등(일반적으로 한 번만 발생)과 같은 미묘한 시간적 이상을 성공적으로 감지했습니다 (빨간색 점선으로 감지 시점 표시).
  - **다중 지표 결합:** Comcast 주식 관련 두 가지 지표에서, 개별적으로는 임계값을 넘지 않지만, 두 지표의 이상 행동이 결합될 때 시스템 전체의 이상이 성공적으로 감지되었습니다. 이는 미묘한 변화를 조기에 포착하는 데 다중 모델의 중요성을 보여줍니다.

- **정량적 결과 (NAB 벤치마크):**
  - 58개의 스트림과 35만 개 이상의 레코드를 포함하는 NAB 벤치마크에서 HTM 기반 이상 감지기가 다른 알고리즘에 비해 가장 좋은 성능을 보였습니다.
  - **NAB 점수:** HTM (65.3)이 Twitter ADVec (47.1), Etsy Skyline (35.7), Bayesian Change Point (17.7) 등을 크게 앞섰습니다.
  - **오탐/미탐 균형:** "오탐 선호(prefer low FP)" 및 "미탐 선호(prefer low FN)" 프로필에서도 HTM이 전반적으로 가장 좋은 성능을 보여, 오탐과 미탐 사이의 우수한 균형을 달성함을 입증했습니다.
  - **지속적인 학습의 중요성:** CPU 사용량 데이터에서 HTM과 Skyline은 시스템의 동작 변화에 적응하여 "새로운 정상"을 학습했지만, Twitter ADVec은 며칠 동안 계속 이상을 생성했습니다.
  - **조기 감지 및 미묘한 시간적 이상:** 일부 스트림에서 HTM은 다른 알고리즘보다 3시간 더 일찍 이상을 감지했으며, 특히 치명적인 시스템 장애에 앞서 발생한 미묘한 시간적 이상(Figure 1의 두 번째 이상)은 HTM만이 감지했습니다. 이는 시간적 모델링의 가치를 강조합니다.

## 🧠 Insights & Discussion

- **HTM의 적합성:** HTM은 실시간 스트리밍 데이터의 특성(지속적인 학습, 비정상 데이터, 공간/시간적 패턴)에 매우 적합하며, 예측 불가능하고 노이즈가 많은 환경에서도 잘 작동합니다.
- **조기 경고 시스템:** 미묘한 시간적 행동 변화가 종종 더 크고 쉽게 감지할 수 있는 문제에 선행한다는 정성적 분석 결과는 HTM과 같은 시간적 이상 감지 기술이 생산 환경에서 조기 경고를 제공하고 잠재적인 문제를 방지하는 데 크게 기여할 수 있음을 시사합니다.
- **모델의 견고성:** 이상 점수의 분포를 모델링하는 접근 방식은 데이터 자체의 분포에 대한 강한 가정을 피함으로써, 실제 데이터의 복잡성과 노이즈에 대해 더 강력한 성능을 제공합니다.
- **실용성과 효율성:** 제안된 알고리즘은 계산 효율적이며, 통계 변화에 자동으로 적응하고, 파라미터 튜닝이 거의 필요 없어 상업적 배포에 매우 실용적입니다.
- **향후 연구:**
  - **앙상블 기반 접근:** HTM의 오류가 다른 알고리즘의 오류와 반드시 상관관계가 없으므로, 앙상블 접근 방식이 정확도를 크게 높일 수 있습니다.
  - **이상 점수 분포 모델:** 이상 점수($s_t$)가 항상 가우시안 분포를 따른다는 가정이 정확하지 않을 수 있으므로, 다른 분포를 탐색하여 결과를 개선할 가능성이 있습니다.

## 📌 TL;DR

이 논문은 스트리밍 시계열 데이터에서 실시간 이상 감지의 어려움(실시간 처리, 지속 학습, 비지도, 비정상 데이터, 미묘한 이상)을 해결하기 위해 신경과학에서 영감을 받은 **Hierarchical Temporal Memory (HTM)** 기반의 새로운 알고리즘을 제안합니다. HTM은 입력의 희소 이진 코드 $a(x_t)$와 다음 입력 예측 $\pi(x_t)$를 사용하여 **원시 이상 점수 ($s_t$)**를 계산하고, 이 점수들의 분포를 모델링하여 **이상 가능성 ($L_t$)**을 도출함으로써 노이즈가 많은 환경에서도 오탐을 줄입니다. 또한, 여러 독립 모델을 결합하고 시간적 윈도우를 적용하여 복잡한 시스템의 전반적인 이상을 감지할 수 있습니다. NAB 벤치마크에서 HTM은 **최고의 성능**을 달성하며, 특히 **미묘한 시간적 이상을 조기에 감지**하는 능력을 입증했습니다. 이 알고리즘은 효율적이고, 스스로 적응하며, 파라미터 튜닝이 적어 실제 상업적 환경에 매우 실용적입니다.
