# DRÆM – A discriminatively trained reconstruction embedding for surface anomaly detection

Vitjan Zavrtanik, Matej Kristan, Danijel Skoˇcaj

## 🧩 Problem to Solve

시각적 표면 이상 감지(Visual Surface Anomaly Detection)는 정상적인 외관에서 크게 벗어나는 이미지의 국부 영역을 감지하는 것을 목표로 합니다. 이 작업은 다음과 같은 여러 가지 도전 과제를 안고 있습니다:

- **작은 이상 영역**: 이상 현상은 이미지 픽셀의 작은 부분만 차지하며, 정상적인 학습 데이터 분포와 매우 유사할 수 있어 감지하기 어렵습니다.
- **이상 데이터 부족**: 실제 이상 현상 이미지는 드물고, 수동 주석은 시간이 많이 소요되어 학습 세트가 심하게 불균형해지는 경우가 많습니다(대부분 이상 없는 이미지로만 구성).
- **생성 모델의 한계**: 재구성 기반 생성 모델(예: 오토인코더, GAN)은 정상 영역을 정확하게 재구성하지만, 학습 데이터에서 관찰되지 않은 이상 영역은 잘 재구성하지 못한다는 점을 이용합니다. 하지만 정상 외관과 크게 다르지 않은 이상 현상은 종종 잘 재구성되어 감지하기 어렵습니다(과도한 일반화).
- **판별 모델의 한계**: 합성 이상 현상을 사용하여 판별 모델을 훈련하는 경우, 합성 외관에 과적합되어 실제 이상 현상에 대한 일반화 성능이 저조합니다.

## ✨ Key Contributions

- **판별적 학습 접근 방식**: 표면 이상 감지 문제를 재구성 문제뿐만 아니라 주로 판별 문제로 접근하여, 판별적으로 훈련된 재구성 이상 임베딩 모델(DRÆM)을 제안합니다.
- **공동 임베딩 학습**: 이상이 있는 이미지와 이상이 없는 재구성 이미지의 공동 표현을 학습하는 동시에, 정상 예시와 이상 예시 사이의 결정 경계를 학습합니다.
- **직접적인 이상 위치 파악**: 네트워크 출력에 대한 복잡한 후처리 없이 직접적인 픽셀 단위 이상 위치 파악을 가능하게 합니다.
- **단순한 합성 이상 학습**: 간단하고 일반적인 이상 시뮬레이션을 사용하여 훈련할 수 있으며, 합성 이상이 실제 이상을 충실하게 나타낼 필요가 없다는 것을 입증합니다.
- **최고 성능 달성**: MVTec 이상 감지 데이터셋에서 현존하는 비지도 학습 방법을 크게 능가하며, DAGM 표면 결함 감지 데이터셋에서는 완전 지도 학습 방법과 유사한 감지 성능을 보이지만, 위치 파악 정확도 면에서는 월등히 뛰어납니다.

## 📎 Related Works

- **재구성 기반 방법**: 오토인코더(Autoencoders) [5, 1, 2, 26] 및 GAN(Generative Adversarial Networks) [24, 23]은 이상 없는 이미지만으로 강력한 재구성 잠재 공간을 학습하여 이상 영역의 낮은 재구성 품질을 기반으로 이상을 감지합니다. 하지만 모델이 이상 현상에 대해 과도하게 일반화되어 미묘한 이상을 놓칠 수 있습니다.
- **깊은 특징 재구성**: 사전 훈련된 네트워크의 깊은 특징을 재구성하여 이상을 감지하는 방법도 있습니다 [4, 25].
- **단일 클래스 분류**: 사전 훈련된 네트워크의 이상 없는 특징에 적합된 가우시안 분포로부터의 편차를 식별하거나 [20, 11], 패치 기반 단일 클래스 분류 [30, 22, 7]를 통해 이상 없는 데이터 주변에 결정 경계를 추정합니다. 이러한 방법은 종종 단일 모드 분포 가정을 위반하여 성능이 저하될 수 있습니다.
- **합성 이상을 이용한 판별 모델**: 합성 이상을 사용하여 판별적 분할(segmentation) 방법을 훈련하는 시도 [8, 21]가 있었지만, 합성 외관에 과적합되어 실제 이상에 대한 일반화가 잘 되지 않는다는 문제가 있습니다.

## 🛠️ Methodology

DRÆM은 재구성 하위 네트워크(reconstructive sub-network)와 판별 하위 네트워크(discriminative sub-network)의 두 부분으로 구성됩니다.

1. **재구성 하위 네트워크 (Reconstructive sub-network)**

   - **목표**: 입력 이미지 $I$의 국부 패턴을 정상 샘플의 분포에 더 가깝게 변환하는 인코더-디코더 구조입니다.
   - **훈련**: 시뮬레이터로 생성된 인위적으로 손상된 이미지 $I_a$로부터 원본 이미지 $I$를 재구성하도록 훈련됩니다.
   - **손실 함수**: 패치 기반 SSIM [27] 손실과 $l_2$ 손실을 결합하여 사용합니다.
     $$ L*{rec}(I, I_r) = \lambda L*{SSIM}(I, I_r) + l_2(I, I_r) $$
        여기서 $I_r$은 재구성된 이미지입니다.

2. **판별 하위 네트워크 (Discriminative sub-network)**

   - **목표**: 재구성 하위 네트워크의 출력인 $I_r$과 원본 입력 이미지 $I$를 채널별로 연결한 $I_c$를 입력으로 받아 픽셀 단위의 이상 감지 맵 $M_o$를 생성합니다.
   - **구조**: U-Net [21]과 유사한 아키텍처를 사용합니다.
   - **훈련**: 재구성 하위 네트워크의 '정상성 복원' 특성 때문에 $I$와 $I_r$의 공동 외관이 이상 이미지에서 크게 달라진다는 정보를 활용합니다. 적절한 거리 측정 기준을 자동으로 학습합니다.
   - **손실 함수**: 어려운 예시의 정확한 분할에 대한 견고성을 높이기 위해 Focal Loss [14] ($L_{seg}$)를 적용합니다.

3. **총 손실 함수**: 두 하위 네트워크의 목표를 결합하여 사용됩니다.
   $$ L(I, I*r, M_a, M) = L*{rec}(I, I*r) + L*{seg}(M_a, M) $$
    여기서 $M_a$는 시뮬레이터에서 생성된 실제 이상 분할 마스크이고, $M$은 네트워크의 출력 이상 분할 마스크입니다.

4. **시뮬레이션된 이상 생성 (Simulated Anomaly Generation)**

   - DRÆM은 시뮬레이션이 실제 이상 외관과 유사할 필요 없이, "분포에서 살짝 벗어난(just-out-of-distribution)" 외관을 생성하여 이상 감지를 위한 적절한 거리 함수를 학습하도록 합니다.
   - **단계**:
     1. **이상 마스크 생성**: Perlin 노이즈 생성기 [18]로 노이즈 이미지를 생성하고, 무작위로 샘플링된 임계값을 사용하여 이진화하여 이상 마스크 $M_a$를 만듭니다.
     2. **이상 텍스처 소스**: 입력 이미지 분포와 관련 없는 이상 소스 이미지 데이터셋(예: Describable Textures Dataset (DTD) [9])에서 이상 텍스처 소스 이미지 $A$를 샘플링합니다.
     3. **증강**: RandAugment [10]에서 영감을 받은 3가지 무작위 증강 함수(예: posterize, sharpness, solarize 등)를 적용합니다.
     4. **합성**: 증강된 텍스처 $A$를 $M_a$로 마스킹하고, 원래 이상 없는 이미지 $I$와 블렌딩하여 $I_a$를 생성합니다. 블렌딩 파라미터 $\beta \in [0.1, 1.0]$는 무작위로 샘플링됩니다.
        $$ I_a = \bar{M_a} \circ I + (1-\beta)(M_a \circ I) + \beta(M_a \circ A) $$
        (여기서 $\circ$는 요소별 곱셈 연산입니다.)
   - 이 시뮬레이터는 원본 이상 없는 이미지 $I$, 시뮬레이션된 이상이 포함된 증강 이미지 $I_a$, 그리고 픽셀 단위의 이상 마스크 $M_a$의 학습 샘플 트리오를 생성합니다.

5. **표면 이상 위치 파악 및 감지 (Surface Anomaly Localization and Detection)**
   - 판별 하위 네트워크의 출력인 픽셀 단위 이상 감지 마스크 $M_o$는 이미지 수준의 이상 점수 $\eta$를 추정하는 데 사용됩니다.
   - $M_o$를 평균 필터 컨볼루션 레이어로 평활화한 후, 최대값을 취하여 최종 이미지 수준 이상 점수를 계산합니다:
     $$ \eta = \max(M*o \* f*{s*f \times s_f}) $$
     (여기서 $f*{s_f \times s_f}$는 $s_f \times s_f$ 크기의 평균 필터이고, $*$는 컨볼루션 연산자입니다.)

## 📊 Results

- **MVTec 데이터셋 (비지도 학습 방법과의 비교)**
  - **이상 감지 (이미지 수준 AUROC)**: DRÆM은 평균 98.0%의 AUROC로, 이전 최고 성능인 95.5%를 2.5%p 크게 앞섰습니다. 15개 클래스 중 9개 클래스에서 최고 AUROC를 달성했습니다.
  - **이상 위치 파악 (픽셀 기반 AUROC / AP)**: AUROC는 97.3%로 이전 최고와 유사했으나, AP(Average Precision) 점수에서는 68.4%로 이전 최고인 55.0%보다 13.4%p 크게 향상되었습니다. AP는 클래스 불균형이 심한 표면 이상 감지에 더 적합한 지표입니다.
  - **정성적 결과**: DRÆM이 생성한 이상 마스크는 매우 상세하고 ground truth와 높은 정확도로 일치했습니다.
- **DAGM 데이터셋 (지도 학습 방법과의 비교)**
  - **이상 감지 (이미지 수준 AUROC)**: DRÆM은 99.0%의 AUROC를 달성하여, 기존의 비지도 학습 방법을 크게 능가했을 뿐만 아니라, 완전 지도 학습 방법과 거의 동등한 분류 성능을 보였습니다.
  - **이상 위치 파악**: DRÆM은 훈련 시 ground truth 라벨을 전혀 사용하지 않았음에도 불구하고, 대략적인 타원형으로만 주석이 달린 지도 학습 방법들보다 훨씬 더 정확한 이상 위치 파악 맵을 생성하여 모든 지도 학습 방법을 능가했습니다.
- **제거 연구 (Ablation Study)**
  - **아키텍처**: 재구성 하위 네트워크를 제거하거나 단독으로 사용했을 때 성능이 크게 감소하여, 두 하위 네트워크 모두 최적의 결과를 위해 필수적임을 확인했습니다. "정상성으로부터의 이상 편차 정도"를 학습하는 DRÆM의 방식이 중요하다는 것을 보여주었습니다.
  - **이상 외관 패턴**: ImageNet, 균일한 색상 영역, 직사각형 마스크 등 다양한 간단한 합성 이상 패턴을 사용해도 성능이 거의 저하되지 않았습니다. 이는 시뮬레이션된 이상 외관이 실제 이상과 현실적으로 유사할 필요가 없음을 시사합니다.
  - **낮은 교란 예시**: 이미지 증강과 투명도 무작위화가 결정 경계를 강화하는 데 중요하며, 특히 투명도 무작위화가 이미지 증강 없이도 성능 향상에 크게 기여했습니다.

## 🧠 Insights & Discussion

- **판별적 재구성 임베딩의 효과**: DRÆM은 재구성 하위 네트워크를 통해 재구성-이상 공동 임베딩을 학습하고 이를 판별적으로 훈련함으로써, 기존 재구성 기반 방법의 한계(과도한 일반화)와 합성 이상 기반 판별 방법의 한계(과적합 및 낮은 일반화)를 극복합니다.
- **시뮬레이션의 역할**: DRÆM은 시뮬레이션된 이상 현상이 실제 이상을 충실하게 나타낼 필요 없이 "분포에서 살짝 벗어난" 패턴을 생성하는 것만으로도 충분히 효과적인 결정 경계를 학습할 수 있음을 보여줍니다. 이는 이상 데이터가 부족한 실제 산업 환경에 매우 유용합니다.
- **"편차 정도" 학습의 중요성**: 모델이 이상 또는 정상 외관 자체를 학습하기보다는 재구성으로부터의 "이상 편차 정도"를 학습하는 것이 더 강력하다는 것을 시사합니다.
- **직접적인 위치 파악**: 복잡한 후처리 없이 픽셀 단위의 정확한 이상 맵을 직접 출력하는 능력은 실제 적용에 있어 큰 장점입니다.
- **주석 정확도의 한계**: 일부 감지 오류는 MVTec 데이터셋의 모호한 이상에 대한 부정확한 ground truth 라벨 때문이었습니다. DRÆM은 이러한 라벨의 한계를 넘어 더 정확한 위치 파악을 수행할 수 있음을 DAGM 데이터셋에서 입증했습니다.

## 📌 TL;DR

DRÆM은 비지도 표면 이상 감지 및 위치 파악을 위한 판별적으로 훈련된 재구성 임베딩 모델입니다. 이 모델은 재구성 하위 네트워크와 판별 하위 네트워크를 end-to-end로 결합하여, 간단한 합성 이상만으로 정상 이미지와 재구성 이미지의 공동 표현을 학습합니다. DRÆM은 MVTec 데이터셋에서 기존 비지도 SOTA를 크게 능가하는 감지 및 위치 파악 성능을 보였으며, DAGM 데이터셋에서는 완전 지도 학습 방법과 유사한 감지 정확도를 달성하고 위치 파악 정확도에서는 이를 뛰어넘습니다. 핵심은 시뮬레이션된 이상이 실제와 유사할 필요 없이, "정상성으로부터의 편차 정도"를 학습하여 강력한 일반화 성능을 얻는 것입니다.
