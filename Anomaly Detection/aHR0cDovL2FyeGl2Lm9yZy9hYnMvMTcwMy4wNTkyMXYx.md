# Unsupervised Anomaly Detection with Generative Adversarial Networks to Guide Marker Discovery

Thomas Schlegl, Philipp Seeböck, Sebastian M. Waldstein, Ursula Schmidt-Erfurth, and Georg Langs

## 🧩 Problem to Solve

의료 영상에서 질병의 진행 및 치료 모니터링에 중요한 이미징 마커를 포착하는 모델을 얻는 것은 어렵습니다. 기존의 모델은 일반적으로 알려진 마커의 주석이 달린 대량의 데이터에 기반하며 자동 감지를 목표로 합니다. 그러나 이러한 접근 방식은 높은 주석 작업 비용과 알려진 마커의 어휘에 국한된다는 한계가 있습니다. 본 연구는 이러한 한계를 극복하고, 주석 없이도 이미징 데이터에서 이상(anomalies)을 마커 후보로 식별하기 위한 비지도 학습 방법을 제안합니다.

## ✨ Key Contributions

- **AnoGAN 제안:** 건강한 해부학적 다양성의 매니폴드를 학습하기 위한 심층 합성곱 생성적 적대 신경망(DCGAN) 기반의 비지도 이상 감지 모델인 AnoGAN을 제안했습니다.
- **새로운 이상 점수 체계 개발:** 이미지 공간에서 잠재 공간으로의 매핑에 기반한 새로운 이상 점수 체계를 도입했습니다.
- **개선된 잠재 공간 매핑 기술:**
  - 전체 쿼리 이미지에 대한 잠재 공간 검색을 조건화했습니다.
  - 기존 판별자 출력 대신 판별자의 중간 특징 표현을 활용하는 새로운 특징 일치(feature matching) 기반의 판별 손실($L_D(z_\gamma)$)을 제안하여, 학습된 매니폴드에 대한 이미지의 적합도를 더 풍부하게 측정할 수 있게 했습니다.
- **GAN을 활용한 최초의 이상/이상치 감지 연구:** 생성적 적대 신경망을 이상 또는 이상치 감지에 활용한 첫 번째 연구입니다.
- **다양한 이상 감지 및 분할 능력:** 망막 OCT 이미지에서 망막액(retinal fluid) 및 과반사성 병소(hyperreflective foci)와 같은 알려진 이상을 높은 정확도로 감지하고, 픽셀 수준에서 이상 영역을 분할할 수 있음을 입증했습니다.

## 📎 Related Works

- **일반적인 이상 감지:** 피처 공간에서 정상 데이터 분포의 명시적 표현을 사용하거나 [1,2], 합성곱 희소 모델 [3], 딥 신뢰망(DBN)을 사용한 비지도 이상 감지를 위한 하이브리드 모델 [4] 등이 있습니다.
- **OCT 영상 이상 감지:** 지도 학습 기반으로 bag-of-word 피처와 랜덤 포레스트 분류기를 사용하거나 [6], 약한 지도 학습으로 합성곱 신경망을 사용하여 망막액 영역을 분할하는 연구 [7] 등이 있습니다. 비지도 방식으로는 합성곱 오토인코더와 원-클래스 SVM을 사용하여 이상 영역을 식별하는 연구 [8]가 있었으나, AnoGAN은 SVM의 하이퍼파라미터 선택 필요성을 제거했습니다.
- **생성적 적대 신경망(GANs):** Goodfellow et al. [9]의 초기 GAN부터, Radford et al. [12]의 DCGANs를 통한 비지도 표현 학습, Yeh et al. [13]의 의미론적 이미지 인페인팅을 위한 GAN 활용 등이 언급됩니다. AnoGAN은 Yeh et al. [13]의 접근 방식을 기반으로 하지만, 잠재 공간 매핑 방법을 개선하고 이상 점수 개념을 도입합니다.
- **특징 일치(Feature Matching):** Salimans et al. [14]이 GAN 훈련의 불안정성을 해결하기 위해 제안한 기술로, AnoGAN은 이 아이디어를 잠재 공간 매핑의 판별 손실에 적용했습니다.

## 🛠️ Methodology

1. **데이터 전처리:** OCT 볼륨에서 망막 영역을 추출 및 평탄화하고, 64x64 픽셀 크기의 패치를 추출하며, 강도 정규화를 수행합니다.
2. **비지도 매니폴드 학습 (AnoGAN 훈련):**
   - 건강한 피험자로부터 추출된 이미지 패치만을 사용하여 DCGAN을 훈련합니다.
   - **생성자 ($G$)**: 1D 잠재 공간 벡터 $z$를 실제와 같은 2D 이미지 $G(z)$로 매핑하여 건강한 이미지 매니폴드를 학습합니다.
   - **판별자 ($D$)**: 실제 건강한 이미지 $x$와 생성된 이미지 $G(z)$를 구별하도록 학습합니다.
   - **목표 함수:** $min_G max_D V(D,G) = E_{x \sim p_{data}(x)}[logD(x)] + E_{z \sim p_z(z)}[log(1-D(G(z)))]$
3. **새로운 이미지의 잠재 공간 매핑:**
   - 새로운 쿼리 이미지 $x$에 대해, $G(z)$가 $x$와 시각적으로 가장 유사하고 학습된 매니폴드에 위치하도록 하는 잠재 공간 벡터 $z$를 찾습니다.
   - **반복적 최적화:** $z$의 계수를 역전파를 통해 $\Gamma$ 단계 동안 최적화합니다. 이 과정에서 생성자 및 판별자의 학습된 파라미터는 고정됩니다.
   - **손실 함수 $L(z_\gamma)$:**
     - $L(z_\gamma) = (1-\lambda) \cdot L_R(z_\gamma) + \lambda \cdot L_D(z_\gamma)$ (여기서 $\lambda$는 가중치)
     - **잔여 손실 ($L_R(z_\gamma)$):** 쿼리 이미지 $x$와 생성된 이미지 $G(z_\gamma)$ 간의 픽셀 단위 시각적 불일치를 측정합니다: $\sum |x - G(z_\gamma)|$.
     - **판별 손실 ($L_D(z_\gamma)$):** 생성된 이미지 $G(z_\gamma)$가 학습된 매니폴드에 속하도록 강제합니다. 이는 판별자의 중간 레이어 출력인 $f(\cdot)$를 사용하여 $x$와 $G(z_\gamma)$의 특징 표현을 일치시킴으로써 정의됩니다: $\sum |f(x) - f(G(z_\gamma))|$.
4. **이상 감지 및 점수 부여:**
   - **이상 점수 ($A(x)$):** 잠재 공간 매핑 과정의 최종 반복 ($\Gamma$번째)에서 얻은 잔여 점수 ($R(x)$)와 판별 점수 ($D(x)$)를 조합하여 계산합니다: $A(x) = (1-\lambda) \cdot R(x) + \lambda \cdot D(x)$.
   - $A(x)$ 값이 클수록 이상 이미지이고, 작을수록 정상 이미지와 유사함을 나타냅니다.
   - **잔여 이미지 ($x_R$):** $|x - G(z_\Gamma)|$를 사용하여 이미지 내의 이상 영역을 픽셀 수준에서 식별합니다.

## 📊 Results

- **정성적 평가 (이미지 생성):** 훈련된 DCGAN은 사실적인 의료 이미지를 생성했습니다. 정상 이미지 패치의 경우 입력 이미지와 시각적으로 매우 유사한 이미지를 생성했지만, 이상 이미지의 경우 입력 이미지와 생성된 이미지 간에 명확한 강도 또는 질감 차이를 보였습니다.
- **정량적 평가 (이상 감지 성능):**
  - 이상 점수 $A(x)$를 기반으로 한 ROC 곡선 분석에서 **AUC는 0.89**를 기록하며 높은 감지 정확도를 보여주었습니다.
  - 잔여 점수 $R(x)$와 판별 점수 $D(x)$는 모두 정상 및 이상 샘플 분류에 적합했습니다.
  - 픽셀 수준에서 망막액과 과반사성 병소(HRF)를 정확하게 식별했습니다. HRF는 훈련 시 망막액에 대한 주석과 별개로 감지되었습니다.
- **다른 접근 방식과의 비교:**
  - AnoGAN (AUC 0.89)은 Adversarial Convolutional Autoencoder (aCAE, AUC 0.73) 및 기존 인페인팅 방식의 판별 손실을 사용한 GAN_R (AUC 0.88)보다 우수한 성능을 보였습니다.
  - aCAE는 이상 이미지에 과도하게 적응하는 경향을 보였습니다.
  - 본 연구에서 제안한 특징 일치 기반의 판별 손실 $L_D(z)$가 기존의 판별 손실 $L_{\hat{D}}(z)$보다 우월함을 입증했습니다.

## 🧠 Insights & Discussion

- **비지도 학습의 잠재력:** AnoGAN은 훈련 시 보지 못했던 다양한 알려진 이상(망막액, HRF)을 감지할 수 있음을 보여주었으며, 새로운 이상을 발견할 수 있는 잠재력을 가집니다. 이는 의료 영상 데이터에서 마커 후보를 발견하는 데 중요합니다.
- **생성 모델의 강점:** 정상적인 해부학적 변동성을 포괄적으로 학습함으로써, 모델은 정상에서 벗어나는 어떠한 현상도 이상으로 효과적으로 식별할 수 있습니다.
- **새로운 마커 발견:** 기존 지도 학습의 한계(알려진 마커에 국한)를 넘어, 주석이 없는 데이터에서도 잠재적인 새로운 마커를 찾아내는 가능성을 제시합니다.
- **특징 일치 기반 손실의 중요성:** 판별자의 중간 특징 표현을 활용하는 판별 손실은 잠재 공간으로의 매핑과 이상 감지 성능을 크게 향상시켰습니다.
- **한계:** 새로운 이상을 발견하는 비지도 학습의 특성상, "위양성(false positives)"이 실제로는 아직 알려지지 않은 "새로운 이상"일 수 있어 정량적 평가에 한계가 있습니다. 그러나 모델은 전반적으로 우수한 감도와 이상 분할 능력을 보여주었습니다.
- **미래 영향:** 대규모 이상 감지를 통해 데이터 마이닝을 통한 마커 후보 발견은 향후 임상 검증의 대상이 될 것입니다.

## 📌 TL;DR

의료 영상에서 질병 마커 발견을 위한 주석 데이터의 한계를 극복하고자, 본 연구는 건강한 데이터로 훈련된 심층 합성곱 생성적 적대 신경망(DCGAN)인 **AnoGAN**을 사용하여 비지도 이상 감지 방법을 제안합니다. AnoGAN은 정상 해부학적 다양성을 학습하고, 새로운 이미지에 대해 잔여 손실과 판별자의 중간 특징 표현을 활용한 **새로운 판별 손실**을 결합한 이상 점수를 통해 이상을 식별합니다. 망막 OCT 이미지 실험에서 망막액, 과반사성 병소 등 알려진 이상뿐만 아니라 훈련 시 보지 못한 새로운 이상까지 높은 정확도로 감지하고 픽셀 단위로 분할할 수 있음을 입증하며, 마커 발견을 위한 비지도 학습의 잠재력을 보여주었습니다.
