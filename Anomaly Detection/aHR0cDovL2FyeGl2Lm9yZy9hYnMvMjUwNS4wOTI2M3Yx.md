# Few-Shot Anomaly-Driven Generation for Anomaly Classification and Segmentation

Guan Gui, Bin-Bin Gao, Jun Liu, Chengjie Wang, and Yunsheng Wu

## 🧩 Problem to Solve

산업 검사 분야에서 실제 이상(anomaly) 샘플의 희소성으로 인해 이상 감지는 실용적이고 도전적인 과제입니다. 기존의 이상 감지 방법들은 노이즈 또는 외부 데이터를 사용하여 이상을 합성하여 이 문제를 해결하려 하지만, 합성된 이상과 실제 이상 사이에는 큰 의미론적 간극(semantic gap)이 존재하여 이상 감지 성능이 저조합니다. 특히 픽셀 수준의 이상 분할(segmentation) 작업에서는 지도 학습을 위한 이상 데이터의 부재로 인해 성능이 더욱 약합니다. 확산 모델(Diffusion Model)과 같은 강력한 생성 모델조차 많은 양의 훈련 이미지를 필요로 하므로, 소수의 실제 이상 이미지로 현실적이고 다양한 이상을 생성하고 이를 활용하여 이상 감지 모델을 효과적으로 훈련하는 것이 문제입니다.

## ✨ Key Contributions

- **소수 샘플 기반 이상 생성 방법론 제안**: 소수의 실제 이상 샘플만으로 확산 모델을 가이드하여 현실적이고 다양한 이상을 생성하는 Few-Shot Anomaly-driven Generation (AnoGen) 방법을 제안합니다. 이 생성된 이상들은 실제 이상과 의미론적으로 일관됩니다.
- **바운딩 박스 가이드 이상 생성 프로세스**: 이상 영역의 위치와 크기를 제어할 수 있도록 바운딩 박스를 활용한 이상 생성 프로세스를 제안하며, 이는 판별 기반 이상 감지 모델의 지도 학습을 위한 바운딩 박스 레이블을 제공합니다.
- **약지도 이상 감지 방법론 개발**: 바운딩 박스 지도 학습을 기반으로 DRAEM 및 DeSTSeg와 같은 판별 기반 이상 모델에 적용할 수 있는 간단한 약지도(weakly-supervised) 이상 감지 방법을 제안합니다.
- **성능 향상 입증**: MVTec 데이터셋 실험을 통해 AnoGen이 생성한 이상 데이터와 약지도 학습 방법을 통해 DRAEM 및 DeSTSeg 모델의 이상 분류 및 분할 성능을 모두 효과적으로 향상시킴을 입증했습니다 (예: 분할 작업에서 AU-PR 기준 DRAEM 5.8%, DeSTSeg 1.5% 향상).

## 📎 Related Works

- **조건부 확산 모델 (Conditional Diffusion Models)**: 클래스 레이블, 텍스트, 참조 이미지, 레이아웃, 스케치 등 다양한 조건을 통해 이미지를 생성하는 확산 모델의 발전. 본 논문은 산업 이상이라는 특정 객체 생성에 초점을 맞추며, 인페인팅(inpainting) 기술을 활용합니다.
- **산업 이상 감지 (Industrial Anomaly Detection)**:
  - **비지도 학습 모델**: 임베딩 기반(예: PaDim, PatchCore, CS-Flow, RD4AD) 또는 재구성 기반 방법. 분류에서는 만족할 만한 성능을 보이나, 이상 데이터의 판별적 지도 부재로 인해 분할 작업에서는 성능이 저조합니다.
  - **판별 기반 모델**: DRAEM, CutPaste, SimpleNet과 같이 합성된 이상 이미지를 사용하여 판별 모델을 훈련합니다. 분할 작업에서 우수한 성능을 보이지만, 합성 이상이 실제 이상과 의미론적 간극이 크다는 단점이 있습니다.
- **동시 연구**: AnomalyDiffusion [17]과 유사한 목표를 가지지만, 본 연구는 더 적은 파라미터 학습, 생성된 이상 다양성 유지, 그리고 더 효과적인 약지도 방법을 사용한다는 점에서 차이가 있습니다.

## 🛠️ Methodology

본 연구는 세 가지 단계로 구성되며, 사전 훈련된 잠재 확산 모델(Latent Diffusion Model, LDM)을 기반으로 합니다.

1. **1단계: 이상 임베딩 학습 (Learn Anomaly Embedding)**
   - **목표**: 소수의 실제 이상 데이터로 실제 이상 샘플의 의미론적 특성을 포착합니다.
   - **접근 방식**: 수백 개의 파라미터로 구성된 작은 임베딩 벡터 $\mathbf{v}$만 최적화하고, 수백만 개의 파라미터를 가진 사전 훈련된 LDM의 모든 파라미터를 고정합니다.
   - **손실 함수**: LDM의 잡음 예측 손실(noise prediction loss)을 활용합니다. $I_{T}^{a}$는 소수(예: 1 또는 3개)의 실제 이상 이미지입니다.
   - **마스크 가이드 손실**: 이상 영역에 초점을 맞추기 위해, 이상 이미지 $I_{T}^{a}$의 분할 마스크 $M_{T}^{a}$를 손실 함수에 통합합니다.
     $$ L'_{LDM} = E_{\epsilon(x),\epsilon,t,v} [||(\epsilon - \epsilon_{\theta}(\epsilon(I_{T}^{a}), t, v)) \odot M_{T}^{a}||_{2}^{2}] $$
     이 손실은 이상 영역에 가중치를 부여하여 임베딩이 객체 전체가 아닌 이상 자체의 세부 정보를 학습하도록 유도합니다.
2. **2단계: 이상 생성 가이드 (Guiding Anomaly Generation)**
   - **목표**: 의미론적으로 일관되고 공간적으로 제어 가능한 이상 이미지를 생성합니다.
   - **접근 방식**: 학습된 임베딩 $\mathbf{v}^{*}$와 인페인팅(inpainting) 기술을 사용하여 LDM을 가이드합니다.
   - **프로세스**:
     - 입력으로 정상 이미지 $I_{n}$과 이상 영역을 정의하는 바운딩 박스 마스크 $M_{box}$를 사용합니다 (바운딩 박스는 전경 영역과의 IoU를 고려하여 무작위로 생성).
     - 노이즈 제거 과정 중, 바운딩 박스 내부 영역은 $\mathbf{v}^{*}$의 가이드 하에 생성되고, 외부 영역은 $I_{n}$의 노이즈 버전으로 유지됩니다.
     - 수식: $z_{t} = z_{t}^{n} \odot (1 - M_{box}) + z'_{t} \odot M_{box}$
     - 결과: 바운딩 박스 레이블이 있는 생성된 이상 이미지 $I_{G}^{a}$를 출력합니다.
3. **3단계: 약지도 이상 감지 (Weakly-Supervised Anomaly Detection)**
   - **목표**: 생성된 이상 이미지와 바운딩 박스 레이블을 사용하여 판별 기반 이상 감지 모델(예: DRAEM, DeSTSeg)을 훈련합니다.
   - **문제점**: 바운딩 박스 레이블은 픽셀 단위로 정확하지 않으며, 박스 내부에 정상 픽셀이 포함될 수 있습니다.
   - **접근 방식**: 약지도 손실 함수를 제안하여 이 문제를 해결합니다.
   - **프로세스**:
     - 예측된 정상 확률 $\hat{p}_{(i,j)}$에 대한 신뢰도 임계값 $\tau$ (예: 0.9)를 설정합니다.
     - 바운딩 박스 내부에 있는 픽셀 중 신뢰도 높은 정상 픽셀($\hat{p}_{(i,j)} \geq \tau$)에 대해서는 손실을 0으로 설정하여 잘못된 지도 학습을 방지합니다.
     - 바운딩 박스 외부 픽셀에는 표준 분할 손실 $L_{seg}$를 적용합니다.
     - 최종 약지도 손실:
       $$ L'_{seg} = M_{box} \odot (1-\delta) \odot L*{seg} + (1-M*{box}) \odot L*{seg} $$
       여기서 $\delta*{(i,j)} = 1$ (만약 $\hat{p}_{(i,j)} \geq \tau$), 그 외에는 $0$입니다.

## 📊 Results

- **데이터셋**: MVTec AD 데이터셋(10개 객체, 5개 텍스처, 총 73종의 이상 유형, 1258개의 실제 이상 이미지)에서 실험을 수행했습니다. 각 객체/텍스처 유형에 대해 4개의 이상 이미지를 생성하여 총 70,760개의 이상 데이터셋을 구축했습니다.
- **정량적 성능 향상**: AnoGen을 통해 생성된 이미지와 약지도 방법을 사용하여 훈련된 DRAEM 및 DeSTSeg 모델은 MVTec 데이터셋에서 이상 분류 및 분할 성능을 일관되게 향상시켰습니다.
  - **DRAEM**: 이미지 수준 AU-ROC 1.6% (97.1%에서 98.7%로), 픽셀 수준 AU-PR 5.8% (67.4%에서 73.2%로) 향상.
  - **DeSTSeg**: 이미지 수준 AU-ROC 0.5% (98.3%에서 98.8%로), 픽셀 수준 AU-PR 1.5% (76.6%에서 78.1%로) 향상.
- **다른 모델과의 비교**: AnoGen이 적용된 판별 기반 모델들은 비지도 학습 모델(PaDim, PatchCore, CS-Flow, RD4AD)보다 이상 분할 작업에서 월등히 우수한 성능을 보였습니다. 이는 이상 정보의 지도가 이상 분할에 얼마나 중요한지 보여줍니다.
- **어블레이션 연구 (Ablation Study)**:
  - **다양한 서포트 이상**: 서포트 이상 샘플의 인스턴스가 달라지더라도 의미론적 일관성은 유지되어 모델 성능에 미치는 영향이 미미함을 확인했습니다.
  - **서포트 이상 개수**: 1개의 서포트 이미지로는 생성 다양성과 일반화가 부족했으며, 3개의 이미지가 5개의 이미지와 유사한 성능을 보이면서 데이터 요구량을 줄이는 데 최적임을 확인했습니다.
  - **마스크 가이드 임베딩 학습**: 마스크 가이드가 없는 경우 임베딩이 이상 영역이 아닌 전체 객체에 편향되어 특정 이상(예: "병의 깨짐")을 생성하지 못하고, 이상 감지 성능도 저하됨을 확인하여 마스크 가이드의 중요성을 입증했습니다.
  - **신뢰도 임계값 $\tau$**: 약지도 학습에서 $\tau=0.9$가 픽셀 수준 AU-PR에서 최적의 성능을 제공함을 확인했습니다. 너무 낮거나 높으면 성능이 저하됩니다.
  - **다양한 이상 데이터로 훈련**: AnoGen 생성 이상과 DRAEM 기반 합성 이상을 함께 사용할 때 DRAEM 기준 픽셀 AU-PR 73.2%로 가장 높은 성능을 달성했습니다. 이는 서로 다른 이상 생성 방법의 시너지를 보여줍니다.
  - **생성 이상 이미지 수 $N$**: 각 객체/텍스처당 $N=4$개를 생성하는 것이 모델 성능과 생성 비용 간의 최적의 균형임을 확인했습니다.

## 🧠 Insights & Discussion

- AnoGen은 산업 이상 감지에서 가장 큰 문제인 이상 데이터의 희소성과 기존 합성 이상 데이터의 의미론적 간극 문제를 효과적으로 해결합니다. 소수의 실제 이상 샘플만으로도 현실적이고 다양하며 의미론적으로 일관된 이상을 생성할 수 있습니다.
- 생성된 이상 이미지는 바운딩 박스 형태의 레이블과 함께 제공되어, 이를 활용한 약지도 학습을 통해 이상 분류 및 특히 분할 작업의 성능을 크게 향상시킬 수 있습니다.
- DRAEM과 같은 다른 합성 방법론과 AnoGen 생성 데이터를 함께 사용할 때 최상의 성능을 달성할 수 있는데, 이는 실제 분포에 가까운 이상과 외부 분포 데이터를 활용한 이상이 상호 보완적인 이점을 제공하기 때문으로 해석됩니다.
- **한계점**: 생성된 이상 이미지는 바운딩 박스 형태의 주석을 가지므로 약지도 학습이 필요하며, 이는 추가적인 하이퍼파라미터($\tau$)를 도입하게 됩니다. 향후 연구에서는 더 정밀한(픽셀 수준) 이상 주석을 생성 단계에서 얻는 방법을 모색하여 모델의 사용 편의성과 적용 범위를 넓힐 계획입니다.
- **의의**: 소수의 실제 이상 이미지로도 모델 성능을 크게 향상시킬 수 있음을 보여줌으로써, 실제 산업 현장에서 이상 데이터 수집의 어려움을 극복하고 이상 감지 모델의 실용성을 높이는 데 중요한 기여를 합니다.

## 📌 TL;DR

- **문제**: 산업 이상 감지는 실제 이상 데이터 부족과 기존 합성 이상 데이터의 비현실성(의미론적 간극)으로 인해, 특히 픽셀 수준 이상 분할에서 성능이 저조합니다.
- **방법**: AnoGen은 소수의 실제 이상 샘플(few-shot)로부터 압축된 임베딩을 학습한 후, 이를 사용하여 사전 훈련된 확산 모델을 가이드하여 현실적이고 다양하며 공간적으로 제어 가능한 이상을 정상 이미지에 생성합니다. 생성된 이상 이미지는 바운딩 박스 레이블과 함께 제공되며, 이를 활용하여 DRAEM 및 DeSTSeg와 같은 판별 모델을 훈련하기 위한 새로운 약지도 손실 함수를 제안합니다. 이 손실은 바운딩 박스 내의 부정확한 픽셀 레이블 문제를 효과적으로 처리합니다.
- **핵심 결과**: MVTec 데이터셋에서 AnoGen이 생성한 이상 데이터는 이상 분류 및 분할 성능을 크게 향상시켰습니다. 특히 이상 분할에서 DRAEM 및 DeSTSeg의 AU-PR이 각각 5.8%, 1.5% 상승하여, 고품질의 의미론적으로 일관된 이상 합성이 다운스트림 이상 감지 작업에 매우 효과적임을 입증했습니다. 기존 합성 방법과 병행하면 더욱 큰 성능 향상을 기대할 수 있습니다.
