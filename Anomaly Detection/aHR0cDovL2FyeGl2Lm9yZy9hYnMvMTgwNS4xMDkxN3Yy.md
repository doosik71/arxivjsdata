# Deep Anomaly Detection Using Geometric Transformations

Izhak Golan, Ran El-Yaniv

## 🧩 Problem to Solve

본 논문은 이미지 분야에서 "정상(normal)" 데이터만 주어진 상황에서 이상치(anomaly)를 탐지하는 문제를 다룹니다. 기존 심층 신경망 기반 이상치 탐지 방법들이 일부 문제에서 저조한 성능을 보이거나, 재구성(reconstruction) 기반 모델(예: 오토인코더, GAN)에 의존하는 경향이 있다는 한계를 지적하며, 재구성 방식 없이 순수한 이상치 탐지 문제에서 성능을 크게 향상시킬 수 있는 새로운 접근 방식을 제안합니다.

## ✨ Key Contributions

- **새로운 이상치 탐지 기법 제안:** 기하학적 변환을 활용하여 심층 신경망을 학습시키는 혁신적인 이상치 탐지 방법을 제시합니다.
- **자기-레이블 데이터셋 및 다중 클래스 분류 학습:** 정상 이미지에 수십 가지 기하학적 변환을 적용하여 자기-레이블(self-labeled) 데이터셋을 생성하고, 어떤 변환이 적용되었는지 예측하는 다중 클래스 분류 모델을 학습합니다.
- **효과적인 특징 추출기 생성:** 이러한 보조적인 학습 작업이 테스트 시 이상 이미지를 효과적으로 식별하는 특징 추출기를 생성함을 보여줍니다.
- **재구성 기반 방법론 회피:** 오토인코더나 GAN과 같은 재구성 기반 접근 방식을 완전히 우회하여 새로운 패러다임을 제시합니다.
- **최첨단 성능 달성:** 기존의 모든 알려진 이상치 탐지 알고리즘보다 훨씬 우수한 성능을 일관되게 달성함을 광범위한 실험을 통해 입증합니다. 예를 들어, CIFAR-10에서 평균 AUROC 32% 개선, CatsVsDogs에서 67% 개선을 달성했습니다.

## 📎 Related Works

본 연구는 이미지 및 딥러닝 기반 이상치 탐지 문헌에 중점을 두며, 대부분의 기존 작업은 재구성 학습에 의존합니다.

- **재구성 기반 이상치 점수:**
  - 이상치는 정상 데이터로 최적화된 재구성 스키마로 압축 및 재구성하기 어렵다는 가정에 기반합니다.
  - 재구성된 이미지의 품질(일반적으로 $L_2$ 거리)로 이상치 점수를 측정합니다.
  - 고전적인 방법: PCA, Robust-PCA.
  - 딥러닝 기반: 다양한 형태의 딥 오토인코더, Variational Autoencoder (VAE) (An and Cho, 2015), Generative Adversarial Networks (GAN) (Schlegl et al., 2017; Deecke et al., 2018의 ADGAN).
- **재구성 기반 표현 학습:**
  - 데이터의 밀도가 낮은 영역에 있는 새로운 샘플을 이상치로 간주하는 저밀도 거부 원리(low-density rejection principle)를 사용합니다.
  - 고전적인 방법: Kernel Density Estimation (KDE), Robust-KDE.
  - 차원의 저주(curse of dimensionality) 문제를 완화하기 위해 저차원 표현 학습 후 밀도 추정합니다.
  - 딥러닝 기반: Energy-Based Model 형태의 정규화된 오토인코더 (Zhai et al., 2016), 가우시안 혼합 모델(Gaussian Mixture Model)의 파라미터를 추정하기 위해 오토인코더의 표현 계층 사용 (Zong et al., 2018).
- **재구성 외 접근 방식:**
  - Deep One-Class SVM (Ruff et al., 2018): SVDD (Support Vector Data Description) 객관 함수와 유사한 손실 함수를 사용하여 딥 아키텍처의 가중치를 최적화하는 모델.

## 🛠️ Methodology

제안된 방법은 기하학적 변환을 사용하여 자기-레이블(self-labeled) 데이터셋을 만들고, 이를 통해 정상 여부를 판별하는 다중 클래스 분류 모델을 학습합니다.

1. **자기-레이블 데이터셋 생성 ($S_T$):**

   - 주어진 정상 이미지 훈련 세트 $S$와 기하학적 변환 세트 $T = \{T_0, T_1, \dots, T_{k-1}\}$를 사용합니다.
   - $T_0(x) = x$는 항등 변환이며, $k-1$개의 다른 변환이 있습니다.
   - 각 변환 $T_j \in T$를 $S$의 모든 이미지 $x$에 적용하여 새로운 이미지 $T_j(x)$를 생성합니다.
   - 생성된 각 이미지 $(T_j(x), j)$에 적용된 변환의 인덱스 $j$를 레이블로 부여하여 자기-레이블 다중 클래스 데이터셋 $S_T$를 만듭니다. ($|T|$개의 클래스, 총 $|T||S|$개의 샘플).
   - 변환 세트 $T$는 수평 뒤집기($T_{flip_b}$), 이동($T_{trans_{s_h, s_w}}$), 90도 회전($T_{rot_k}$)의 조합으로 구성되며, 총 $2 \times 3 \times 3 \times 4 = 72$개의 변환을 사용했습니다.

2. **다중 클래스 분류 모델 학습:**

   - 자기-레이블 데이터셋 $S_T$를 사용하여 딥 $k$-클래스 분류 모델 $f_\theta$를 표준 교차 엔트로피 손실 함수로 학습합니다.
   - WRN (Wide Residual Network) 아키텍처를 사용합니다.

3. **Dirichlet Normality Score 정의:**
   - 추론 시, 보지 못한 이미지 $x$가 주어지면, $T$에 있는 각 변환 $T_i$를 $x$에 적용합니다.
   - 분류 모델 $f_\theta$를 각 변환된 이미지 $T_i(x)$에 적용하여 $k$차원의 소프트맥스 응답 벡터 $y(T_i(x))$를 얻습니다.
   - 정상 스코어는 이 벡터들의 결합된 로그-가능도(combined log-likelihood)를 사용하여 정의됩니다.
   - 각 조건부 분포 $p(y(T_i(x))|T_i)$는 Dirichlet 분포 $Dir(\alpha_i)$로 근사화됩니다.
   - $\alpha_i$ 파라미터는 훈련 세트 $S$의 이미지들을 $T_i$로 변환한 후 얻은 소프트맥스 응답 벡터들의 집합 $S_i = \{y(T_i(x))|x \in S\}$로부터 최대 가능도 방식으로 추정됩니다($\tilde{\alpha}_i$).
   - 최종 정상 스코어 $n_S(x)$는 다음과 같이 정의됩니다:
     $$ n*S(x) = \sum*{i=0}^{k-1} \sum\_{j=0}^{k-1} ([\tilde{\alpha}_i]\_j - 1) \log y(T_i(x))\_j $$
        이는 $x$에 무관한 상수 항들을 제거한 간소화된 스코어입니다.
   - 간소화된 버전으로 $\hat{n}_S(x) = \frac{1}{k}\sum_{j=0}^{k-1} [y(T_j(x))]_j$도 초기 연구 단계에서 사용되었으며 좋은 성능을 보였습니다.

## 📊 Results

- **데이터셋:** CIFAR-10, CIFAR-100, CatsVsDogs, Fashion-MNIST 네 가지 이미지 데이터셋을 사용합니다.
- **평가 프로토콜:** "one-vs-all" 방식으로, 각 클래스를 정상(normal) 클래스로 설정하고 나머지 모든 클래스를 이상치(anomaly)로 간주하여 평가합니다. AUROC (Area Under the Receiver Operating Characteristic curve)를 주요 성능 지표로 사용합니다.
- **주요 결과:**
  - 제안된 방법은 모든 벤치마크 데이터셋에서 최신 심층 이상치 탐지 방법들(OC-SVM, DSEBM, DAGMM, ADGAN)을 크게 능가했습니다.
  - CIFAR-10에서 평균 AUROC를 32% (86.0% vs. 64.8% for E2E-OC-SVM) 향상시켰습니다.
  - CatsVsDogs (64x64) 데이터셋에서 특히 두드러진 성능 향상을 보였으며, AUROC를 67% (88.8% vs. 56.1% for DSEBM) 향상시켰습니다.
  - Fashion-MNIST와 같은 간단한 데이터셋에서도 다른 모든 방법보다 약간 우수한 성능을 보여주었습니다.
  - **외부 분포(Out-of-distribution) 샘플 식별:** 라벨링된 다중 클래스 데이터셋에서 외부 분포 샘플을 식별하는 문제에서도 ODIN (Liang et al., 2018)보다 우수한 AUROC (95.7% vs 92.1%)를 달성했습니다.

## 🧠 Insights & Discussion

- **기하학적 변환의 직관:** 다중 클래스 분류 모델이 다양한 기하학적 변환을 구별하도록 훈련되면, 정상 클래스에 고유한 기하학적 특징들을 학습하게 됩니다. 이러한 특징들은 이상치를 효과적으로 식별하는 데 사용됩니다.
- **변환 선택의 중요성:** 수평 뒤집기, 이동, 회전과 같이 공간 정보를 보존하는 기하학적 변환이 Gaussian blur나 sharpening과 같은 비기하학적 변환보다 성능이 우수했습니다. 비기하학적 변환은 학습된 이미지 세트의 중요한 특징을 제거할 수 있기 때문입니다.
- **분류 난이도와 이상치 탐지:** 학습된 분류기가 이상치에 적용된 변환의 종류를 정확히 예측하기 어려울수록 제안된 방법의 Type-I 오류율(정상 데이터를 이상치로 오분류)이 감소하는 경향이 있습니다.
- **시각화:** 정상 스코어를 최대화하도록 이미지(MNIST 숫자)를 최적화하는 실험을 통해, 모델이 정상 클래스의 특징을 학습했음을 시각적으로 보여줍니다. 이상치 '0'은 '3'으로 변형되는 반면, 정상 데이터 '3'은 변형되지 않고 본래의 모습을 유지했습니다.
- **제한 사항 및 향후 연구:**
  - 정상 클래스 내 다양성이 높은 경우(예: CIFAR-100의 일부 슈퍼클래스) 성능이 다소 저하될 수 있습니다.
  - 기하학적 변환 사용에 대한 이론적 근거 개발, 특정 훈련 세트에 최적화된 변환 세트 선택 연구.
  - 오픈 월드 시나리오(open-world scenario)와 같은 다른 응용 분야에 적용 가능성 탐구.
  - 불확실성 추정(uncertainty estimation) 및 액티브 러닝(active learning) 기술과 결합.

## 📌 TL;DR

본 논문은 이미지 이상치 탐지를 위해 정상 데이터에 기하학적 변환을 적용하여 자기-레이블된 다중 클래스 분류기를 학습하는 새로운 방법을 제안합니다. 이 모델은 각 변환된 이미지에 어떤 변환이 적용되었는지 예측하며, 이 과정에서 정상 클래스에 고유한 특징을 학습합니다. 테스트 시에는 변환된 이미지들의 소프트맥스 응답 분포를 기반으로 Dirichlet 분포를 활용한 정상 스코어를 계산하여 이상치를 판별합니다. 제안된 방법은 재구성 기반 모델을 사용하지 않으면서도 기존 최첨단 방법들보다 AUROC 성능을 크게 향상시켰음을 CIFAR-10, CIFAR-100 등 다양한 데이터셋에서 입증했습니다.
