# Graph Neural Networks based Log Anomaly Detection and Explanation

Zhong Li, Jiayang Shi, Matthijs van Leeuwen

## 🧩 Problem to Solve

기존 로그 이상 탐지 방법들은 로그 이벤트의 정량적 또는 순차적 관계만을 이용하여 낮은 탐지 정확도를 보이는 한계가 있습니다. 또한, 대부분의 방법은 이상 탐지 결과에 대한 설명(explanation)을 제공하지 못하여 근본 원인 분석에 어려움을 겪습니다. 특히, 기존 그래프 기반 방법들은 로그를 비방향성 그래프로 변환하여 중요한 순차적 정보를 손실하거나, 그래프 표현 학습과 이상 탐지를 분리하여 수행하여 최적의 정확도를 얻지 못합니다.

## ✨ Key Contributions

- **Logs2Graphs 프레임워크 제안**: 로그 이상 탐지를 그래프 레벨 이상 탐지 문제로 재정의하고, 로그 시퀀스를 속성(attributed), 방향성(directed), 가중치(edge-weighted) 그래프로 변환하여 기존 방법보다 더 풍부한 구조 정보를 포착합니다.
- **OCDiGCN(One-Class Digraph Inception Convolutional Networks) 모델 개발**: 속성, 방향성, 가중치 그래프를 위한 일반적인 엔드투엔드(end-to-end) 비지도 그래프 레벨 이상 탐지 방법입니다. 그래프 표현 학습과 이상 탐지 목표를 결합하여 정확도를 향상시킵니다.
- **이상 탐지 결과 설명 제공**: 탐지된 각 이상에 대해 핵심 노드를 식별하여 설명을 제공하고, 이는 후속 근본 원인 진단에 유용한 단서를 제공합니다.
- **성능 검증**: 다섯 가지 벤치마크 데이터셋에 대한 실험을 통해 Logs2Graphs가 최신 로그 이상 탐지 방법들과 비교하여 동등하거나 우수한 성능을 보임을 입증합니다.

## 📎 Related Works

- **정량 기반(Quantitative-based) 방법**: OCSVM, PCA와 같이 로그 이벤트 카운트 매트릭스를 사용하여 이상을 탐지하지만, 이벤트 간의 의미론적/순차적 정보를 포착하지 못합니다.
- **시퀀스 기반(Sequence-based) 방법**: DeepLog, LogAnomaly와 같이 로그 이벤트 시퀀스를 입력으로 받아 순차적(및 때로는 의미론적) 정보를 활용하여 이상을 탐지합니다. 하지만 로그 이벤트 간의 전체 구조를 고려하지 못합니다.
- **그래프 기반(Graph-based) 방법**: GLAD-PAW, GLAD와 같이 로그를 그래프로 변환하여 이벤트 간의 의미론적 및 구조 정보를 활용합니다. 그러나 기존 방법들은 로그를 비방향성 그래프로 변환하여 순서 정보를 손실하거나, 그래프 표현과 이상 탐지를 분리하여 수행하며, 대부분 설명 기능을 제공하지 않습니다.

## 🛠️ Methodology

Logs2Graphs는 다음 단계를 따릅니다.

1. **로그 파싱 (Log Parsing)**: Drain [12]과 같은 오프라인 도구를 사용하여 원시 로그 메시지에서 로그 이벤트 및 파라미터를 추출합니다.
2. **로그 그룹화 (Log Grouping)**: 로그 식별자(log identifier)를 사용하여 파싱된 로그 메시지들을 로그 그룹으로 나눕니다.
3. **그래프 구성 (Graph Construction)**: 각 로그 그룹을 속성, 방향성, 가중치 그래프 $G_m = (V_m, E_m, X_m, Y_m)$으로 변환합니다.
   - **노드 ($V_m$)**: 각 고유 로그 이벤트를 노드로 나타냅니다.
   - **노드 속성 ($X_m$)**: 각 로그 이벤트에 대한 의미론적 임베딩 벡터를 생성하여 노드 속성으로 사용합니다. 이는 전처리, GloVe [29]를 이용한 워드 임베딩, TF-IDF [31] 가중치를 이용한 문장 임베딩 과정을 거칩니다.
   - **엣지 ($E_m$)**: 로그 이벤트 $L_i$ 뒤에 $L_j$가 즉시 나타나면 $L_i$에서 $L_j$로 향하는 방향성 엣지를 추가합니다.
   - **엣지 가중치 ($Y_m$)**: 해당 엣지가 나타난 횟수를 가중치로 설정합니다.
4. **OCDiGCN (One-Class Digraph Inception Convolutional Networks)을 이용한 이상 탐지**:
   - **그래프 표현 학습**: 기존 DiGCN [37]을 기반으로, 노드 표현 학습 후 `Readout()` 함수를 통해 노드 벡터 표현을 집계하여 그래프 벡터 표현 $z = \text{Readout}(Z_i | i \in \{1,2,...,|V|\})$을 얻습니다. DiGCN의 메시지 전달 프레임워크를 활용하여 엣지 가중치 $Y$를 학습에 통합합니다.
   - **단일 클래스 이상 탐지**: `One-Class Deep SVDD` [32] 목적 함수를 최적화하여 이상을 탐지합니다. 모델은 비정상(non-anomalous) 그래프 데이터셋에 대해 훈련되며, 모든 정상 그래프 표현을 하이퍼스피어(hypersphere) 중심 $o$에 가깝게 매핑하도록 학습합니다.
     $$
     \min_{\mathcal{H}} \frac{1}{M} \sum_{m=1}^{M} \| \text{DiGCN}(G_m;\mathcal{H}) - o \|_2^2 + \frac{\lambda}{2} \sum_{l=1}^{L} \| \mathcal{H}^{(l)} \|_F^2
     $$
     여기서 $o$는 학습된 표현 공간의 중심이며, 하이퍼스피어 붕괴를 피하기 위해 네트워크 표현들의 평균으로 설정됩니다.
   - **이상 점수 계산**: 훈련 후, 새로운 그래프 $G_m$에 대한 이상 점수는 학습된 표현과 중심 $o$ 사이의 유클리드 거리로 정의됩니다: $\text{score}(G_m) = \| \text{DiGCN}(G_m;\mathcal{H}) - o \|_2$.
5. **이상 설명 (Anomaly Explanation)**: 탐지된 이상 그래프에 대해, 그래프의 이상 점수에 가장 많이 기여하는 노드들을 식별하여 설명으로 제공합니다. 노드 $v_j$의 중요도 점수는 $\frac{|\text{score}(G_m) - \text{score}(G_m \setminus \{Z_j\})|}{\text{score}(G_m)}$로 정의되며, LRP (Layerwise Relevance Propagation) [2] 알고리즘을 확장하여 입력 레이어의 중요한 노드들을 찾아 시각화합니다.

## 📊 Results

- **탐지 정확도**: Logs2Graphs는 5개 벤치마크 데이터셋 중 3개에서 ROC AUC 및 PRC AUC(Average Precision) 기준 최첨단 성능을 달성하거나 경쟁 우위를 보였습니다. 특히 BGL에서 ROC AUC 9.6%p 개선, Spirit 및 Thunderbird에서 0.99 이상의 ROC AUC를 달성했습니다.
- **방향성 vs. 비방향성 그래프**: 방향성 로그 그래프(Logs2Graphs)가 비방향성 그래프(GLAM)보다 모든 데이터셋(Hadoop 제외)에서 일관되게 우수한 성능을 보였으며, 이는 시간적 순서 정보 유지의 중요성을 시사합니다.
- **노드 레이블 vs. 노드 속성**: 로그 이벤트의 의미론적 임베딩을 노드 속성으로 사용하는 것이 노드 레이블의 원-핫 인코딩보다 항상 우수하며, Hadoop, Spirit, HDFS 데이터셋에서 상당한 성능 향상을 가져왔습니다.
- **오염에 대한 강건성**: 훈련 데이터의 오염 수준이 증가함에 따라 Logs2Graphs의 성능이 감소했지만, 낮은 오염 수준에서는 강건성을 보였습니다.
- **구조적 이상 및 미확인 정상 인스턴스 탐지 능력**: Logs2Graphs는 구조적 이상을 효과적으로 탐지하며, DeepLog, LogAnomaly, AutoEncoder와 같은 시퀀스 기반 방법들이 높은 오탐률(False Positive Rate)을 보인 반면, Logs2Graphs는 구조적으로 동등한 미확인 정상 인스턴스를 인식하는 데 0%의 FPR을 달성했습니다.
- **이상 설명**: 탐지된 이상에 대해 중요한 노드를 강조하여 이해하기 쉬운 설명을 제공합니다 (예: HDFS 데이터셋에서 "WriteBlock(WithException)" 노드가 이상에 가장 크게 기여).
- **민감도 분석**:
  - **합성곱 레이어 수 ($L$)**: $L=1$일 때 일관되게 좋은 성능을 보이며, 레이어 수를 늘려도 성능 향상이 미미하거나 오히려 저하됩니다.
  - **임베딩 차원 ($d$)**: 대부분의 데이터셋에서 $d=128$이 좋은 성능을 보였으나, BGL과 같이 복잡한 데이터셋에서는 더 높은 차원이 필요했습니다.
  - **근접성 파라미터 ($k$)**: $k=1$과 $k=2$ 사이의 성능 차이가 크지 않았습니다. 로그에서 생성된 그래프의 노드 수가 적기 때문에 2차 근접성 정보의 필요성이 적었습니다.
- **런타임 분석**: Logs2Graphs는 그래프 생성 단계에서 대부분의 계산 시간을 소요하지만, 훈련 및 테스트 단계는 최소한의 시간을 요구하여 온라인 로그 이상 탐지에 대한 가능성을 보여주었습니다.

## 🧠 Insights & Discussion

Logs2Graphs는 로그 이상 탐지에서 풍부한 구조적(방향성, 가중치) 및 의미론적 정보(노드 속성)를 활용하는 것이 중요함을 입증합니다. 엔드투엔드 방식으로 그래프 표현 학습과 이상 탐지를 통합하는 OCDiGCN은 높은 탐지 정확도를 달성하는 데 핵심적인 역할을 합니다. 특히, 이상 탐지 결과에 대한 설명 기능을 제공함으로써 시스템 운영자가 문제의 근본 원인을 더 빠르고 효과적으로 파악할 수 있도록 돕습니다.

다만, 연구의 타당성에는 몇 가지 위협 요소가 존재합니다. 제한된 데이터셋과 비교 대상 모델, 훈련 데이터의 순수성 보장 문제, 그리고 단순한 그래프 구성 규칙 등은 향후 연구에서 개선해야 할 점으로 지적됩니다. 이러한 한계점들을 보완한다면 Logs2Graphs는 실제 산업 환경에서 시스템 모니터링 및 유지 보수에 더욱 크게 기여할 수 있을 것입니다.

## 📌 TL;DR

이 논문은 시스템 로그의 이상 탐지 정확도 및 설명 가능성 부족 문제를 해결하기 위해 **Logs2Graphs**라는 새로운 비지도 학습 프레임워크를 제안합니다. 이 프레임워크는 로그를 속성, 방향성, 가중치 그래프로 변환하고, **OCDiGCN**이라는 새로운 그래프 신경망 모델을 사용하여 그래프 레벨 이상을 엔드투엔드 방식으로 탐지합니다. OCDiGCN은 그래프 표현 학습과 이상 탐지 목표를 통합하며, 탐지된 이상에 대한 핵심 노드 설명을 제공합니다. 5개 벤치마크 데이터셋 실험 결과, Logs2Graphs는 기존 방법들보다 우수하거나 동등한 성능을 보였으며, 특히 방향성 그래프와 의미론적 노드 속성이 이상 탐지 정확도를 크게 향상시킴을 입증했습니다. 이는 시스템 로그의 복잡한 관계를 효과적으로 포착하고, 이상 발생 시 근본 원인 분석에 유용한 통찰력을 제공합니다.
