# Deep Anomaly Detection with Deviation Networks

Guansong Pang, Chunhua Shen, Anton van den Hengel

## 🧩 Problem to Solve

기존 딥 이상 탐지(deep anomaly detection) 방법론들은 주로 특징 표현(feature representation) 학습에 초점을 맞춰 이상 점수(anomaly score)를 간접적으로 최적화합니다. 이는 데이터 비효율적인 학습과 차선책의 이상 점수 산출로 이어집니다. 또한, 대규모 레이블링된 이상 데이터의 부족으로 인해 대부분 비지도 학습으로 설계되어, 실제 애플리케이션에서 가용할 수 있는 소수의 레이블링된 이상치(예: 몇 개에서 수십 개)와 같은 사전 지식(prior knowledge)을 활용하기 어렵습니다.

## ✨ Key Contributions

- **새로운 프레임워크 제안:** 제한된 수의 레이블링된 이상 데이터를 활용하여 이상 점수를 종단간(end-to-end)으로 학습하는 새로운 프레임워크를 제안합니다. 이는 기존의 간접적인 특징 표현 학습 방식을 벗어나 이상 점수를 직접 최적화하는 최초의 시도입니다.
- **DevNet 방법론 개발:** 제안된 프레임워크의 구체적인 구현체인 편차 네트워크(Deviation Networks, DevNet)를 소개합니다. DevNet은 신경망, 가우시안 사전 분포(Gaussian prior), Z-점수 기반 편차 손실(Z-Score-based deviation loss)을 결합하여 데이터 효율적이고 효과적이며 해석 가능한 이상 점수 학습을 수행합니다.
- **탁월한 성능 입증:** 9개의 실제 대규모/고차원 데이터셋에 대한 광범위한 실험 결과, DevNet은 최신 경쟁 방법론들에 비해 AUC-ROC에서 평균 3-29%, AUC-PR에서 평균 21-309%의 상당한 성능 향상을 달성했습니다.
- **높은 데이터 효율성:** DevNet은 경쟁 방법론들과 유사하거나 더 나은 정확도를 달성하는 데 75-88% 더 적은 레이블링된 이상 데이터를 필요로 함으로써 뛰어난 데이터 효율성을 보였습니다.

## 📎 Related Works

- **전통적인 이상 탐지:** 거리 기반, 밀도 기반, 앙상블 방법(예: iForest) 등이 있으나, 고차원 데이터의 비선형적 관계 처리에서 한계가 있습니다.
- **딥 이상 탐지:**
  - **비지도 방식:** 오토인코더(Autoencoder) 기반, GAN(Generative Adversarial Network) 기반 방법들은 재구성 오류(reconstruction error)를 이상 점수로 사용합니다. 이들은 특징 학습과 이상 탐지가 분리되어 최적화가 비효율적일 수 있습니다.
  - **통합 방식:** REPEN, 딥 SVDD(Deep SVDD)와 같은 최근 연구들은 특징 학습 목표에 전통적인 이상 측정치를 통합하여 특징 표현력을 향상시켰지만, 여전히 특징 표현 최적화에 초점을 맞춘 간접적인 이상 점수 최적화 방식입니다.
- **제한된 데이터를 활용한 이상 탐지:**
  - 소수의 연구만이 소수의 레이블링된 이상치를 활용하여 그래프 데이터에 적용되거나(예: [16, 26]), REPEN과 같이 특징 표현 학습에 활용되었습니다.
  - **소수 학습(Few-shot Learning) 및 PU 학습(Positive-Unlabeled Learning)과의 차이점:** 본 연구의 문제 설정은 소수 학습이나 PU 학습과 유사해 보이지만, 소수 학습은 학습 시 대량의 레이블링된 데이터가 있는 '알려진 클래스'를 전제로 하고, PU 학습은 '레이블링된 소수 데이터와 미지의 데이터가 동일한 매니폴드(manifold)에 속한다'는 가정을 하며, 상당한 비율의 양성 예시(20-50%)를 요구한다는 점에서 큰 차이가 있습니다. 본 연구는 훈련 데이터의 클래스 정보가 전혀 없으며, 이상치들이 서로 매우 다른 매니폴드에서 올 수 있고, 레이블링된 이상치가 극히 소량이라는 점에서 이들 방법론이 적용되기 어렵습니다.

## 🛠️ Methodology

DevNet은 신경망, 가우시안 사전 분포, Z-점수 기반 편차 손실을 결합하여 이상 점수를 직접 최적화하는 종단간(end-to-end) 딥 이상 탐지 방법입니다.

1. **문제 정의:** $N$개의 미확인 데이터 $U$와 $K$개의 레이블링된 이상치 $K$ ($K \ll N$)로 구성된 훈련 데이터셋 $X = U \cup K$가 주어졌을 때, 이상 점수 함수 $ \phi: X \to \mathbb{R} $를 학습하여 이상치 $x_i$에 대해 정상 객체 $x_j$보다 높은 점수 $ \phi(x_i) > \phi(x_j) $를 할당하는 것을 목표로 합니다.

2. **제안 프레임워크 (Figure 2):**

   - **이상 점수 네트워크 ( $ \phi(x; \Theta) $ ):** 입력 $x$에 대해 스칼라 이상 점수를 출력하는 신경망입니다. 특징 표현 학습기 $ \psi(x; \Theta_t) $와 이상 점수 학습기 $ \eta(q; \Theta_s) $로 구성됩니다. $ \psi $는 $H$개의 은닉층을 가진 MLP, CNN, RNN 등이 될 수 있으며, $ \eta $는 단일 선형 유닛을 사용합니다.
   - **참조 점수 생성기 ( $ \mu_R $ ):** $l$개의 무작위로 선택된 정상 객체들의 이상 점수 평균으로 정의됩니다. 해석 가능한 이상 점수를 위해 가우시안 사전 분포(Gaussian prior) $ F $를 사용하여 생성합니다.
   - **편차 손실 함수 ( $ L $ ):** $ \phi(x; \Theta) $, $ \mu_R $, 그리고 $ \mu_R $의 표준편차 $ \sigma_R $를 입력으로 받습니다. 이상치들의 점수는 $ \mu_R $로부터 통계적으로 유의미하게 상위 꼬리(upper tail)에서 벗어나도록 하고, 정상 객체들의 점수는 $ \mu_R $에 가능한 한 가깝도록 최적화합니다.

3. **가우시안 사전 기반 참조 점수:**

   - 정상 객체의 이상 점수가 가우시안 분포 $ N(\mu, \sigma^2) $를 따른다고 가정합니다.
   - 참조 점수 $ \mu*R = \frac{1}{l} \sum*{i=1}^l r_i $ ($ r_i \sim N(\mu, \sigma^2) $)로 정의됩니다.
   - 실험에서 $ \mu=0, \sigma=1 $로 설정되었으며, $ l=5000 $으로 설정되었습니다.

4. **Z-점수 기반 편차 손실:**

   - 편차는 Z-점수로 정의됩니다: $ \text{dev}(x) = \frac{\phi(x; \Theta) - \mu_R}{\sigma_R} $.
   - 손실 함수는 다음과 같습니다:
     $$ L (\phi(x;\Theta), \mu_R, \sigma_R) = (1-y)|\text{dev}(x)| + y \max(0, a-\text{dev}(x)) $$
        여기서 $y=1$은 이상치, $y=0$은 정상 객체를 나타내며, $a$는 Z-점수 신뢰 구간(confidence interval) 매개변수입니다 ($a=5$로 설정). 이 손실은 정상 객체의 이상 점수를 $ \mu_R $에 가깝게 만들고, 이상치의 이상 점수는 $ \mu_R $로부터 최소 $a$만큼 편차를 갖도록 강제합니다. 학습 시 미확인 훈련 데이터 $U$는 정상 객체로 간주됩니다.

5. **DevNet 알고리즘 (Algorithm 1):**

   - 신경망 파라미터 $ \Theta $를 무작위로 초기화합니다.
   - 각 에폭(epoch)과 미니배치(mini-batch)에서:
     - 미확인 데이터 $U$와 레이블링된 이상치 $K$에서 데이터를 계층적으로 샘플링하여 미니배치 $B$를 구성합니다.
     - 가우시안 사전 $ N(\mu, \sigma^2) $에서 $l$개의 점수를 샘플링하여 $ \mu_R $와 $ \sigma_R $를 계산합니다.
     - 미니배치 $B$에 대한 손실 $L$을 계산하고 $ \Theta $에 대해 경사 하강법을 수행합니다.
   - 최적화된 이상 점수 네트워크 $ \phi $를 반환합니다.

6. **이상 점수의 해석 가능성:** Z-점수 기반 편차 손실 덕분에 DevNet은 높은 해석력을 지닌 이상 점수를 산출합니다. 예를 들어, $ \phi(x) $가 $ \mu \pm z_p \sigma $ 구간 밖에 있을 확률이 $ 2(1-p) $라는 것을 직접적으로 설명할 수 있습니다. $ \mu=0, \sigma=1 $일 때, $ \phi(x) > 1.96 $ ($p=0.95$)이면 해당 객체가 정상 데이터와 동일한 메커니즘에서 생성될 확률이 0.05에 불과하다고 해석할 수 있습니다.

## 📊 Results

- **데이터셋:** 침입 탐지, 사기 탐지, 악성 URL 탐지, 질병 탐지 등 9개의 실제 대규모/고차원 데이터셋을 활용했습니다.
- **경쟁 방법론:** REPEN, adaptive Deep SVDD (DSVDD), Prototypical Networks (FSNet), iForest와 비교했습니다.
- **평가 지표:** AUC-ROC 및 AUC-PR (10회 독립 실행 평균, Wilcoxon 부호 순위 검정).

- **효과성:**

  - DevNet은 AUC-ROC 성능에서 9개 중 8개 데이터셋에서, AUC-PR 성능에서는 9개 중 9개 데이터셋에서 가장 우수했습니다.
  - 평균 AUC-ROC에서 REPEN(9%), DSVDD(3%), FSNet(22%), iForest(29%) 대비 상당한 개선을 보였습니다.
  - 평균 AUC-PR에서는 REPEN(118%), DSVDD(21%), FSNet(113%), iForest(309%) 대비 훨씬 더 큰 개선을 달성했습니다. 모든 개선은 통계적으로 유의미했습니다.
  - 이는 DevNet이 제한된 레이블링된 이상치를 효율적으로 활용하여 이상 점수를 최적화하여 높은 정밀도와 재현율(recall)을 달성했음을 보여줍니다.

- **데이터 효율성:**

  - DevNet은 가장 데이터 효율적인 방법론으로, 레이블링된 이상치 수가 5개에서 120개로 증가함에 따라 AUC-PR이 가장 빠르게 증가했습니다.
  - 일부 경우, 최적의 경쟁 방법론보다 75-88% 적은 레이블링된 데이터로 유사하거나 더 우수한 성능을 달성했습니다.
  - 심지어 5개 또는 15개의 매우 적은 레이블링된 이상치만 사용하더라도, DevNet과 DSVDD는 비지도 학습인 iForest보다 평균 400% 이상 크게 향상된 성능을 보였습니다.

- **이상치 오염에 대한 강건성 (Robustness):**

  - 미확인 훈련 데이터에 최대 20%의 이상치 오염(anomaly contamination)이 있을 때에도 DevNet은 다른 딥러닝 방법들보다 일관되게 강건한 성능을 유지했습니다.
  - 높은 오염 수준에서도 DevNet은 REPEN(200%), DSVDD(28%), FSNet(336%)보다 훨씬 우수한 평균 AUC-PR 성능을 달성했습니다.
  - 이는 제한된 사전 지식이 시끄러운 환경에서도 이상 점수를 효과적으로 최적화하는 DevNet의 강력한 능력을 입증합니다.

- **어블레이션 연구 (Ablation Study):**

  - 종단간 이상 점수 학습 (Def vs. DevNet-Rep): 이상 점수를 직접 학습하는 것이 특징 표현만 학습하는 것보다 더 정확하고 안정적인 성능을 보였습니다.
  - 편차 손실 (DevNet-Rep vs. DSVDD): DevNet의 편차 손실이 이상 행동을 포착하는 데 더 효과적이었습니다.
  - 비선형 특징 학습 (Def vs. DevNet-Linear): 은닉층을 통한 비선형 특징 학습이 성능 향상에 중요한 역할을 했습니다.
  - 더 깊은 네트워크 (Def vs. DevNet-3HL): 제한된 레이블링된 데이터로는 더 깊은 은닉층이 항상 유익하지는 않다는 것을 보여주었습니다.

- **확장성:**
  - DevNet은 데이터 크기와 차원 모두에 대해 선형 시간 복잡도를 가집니다.
  - 대규모 데이터셋에서 REPEN, FSNet, iForest보다 10-20배 더 빠르게 실행되었습니다.

## 🧠 Insights & Discussion

- **주요 통찰:** 이 논문은 소수의 레이블링된 이상 데이터와 사전 지식을 활용한 종단간 이상 점수 학습이 기존의 특징 표현 학습 기반 간접 최적화 방식보다 훨씬 효과적이고 데이터 효율적임을 실증적으로 보여줍니다. 특히, 이는 레이블링된 이상 데이터가 극히 드문 실제 이상 탐지 시나리오에서 매우 중요합니다.
- **해석 가능한 점수:** Z-점수 기반 편차 손실은 이상 점수에 통계적 해석력을 부여하여, 사용자가 특정 임계값을 기준으로 이상치를 식별할 때 직관적인 확신 수준을 제공할 수 있게 합니다. 이는 많은 블랙박스형 이상 탐지 모델에 비해 큰 장점입니다.
- **한계 및 미래 연구:** 제한된 레이블링된 이상 데이터로는 더 깊은 신경망 아키텍처가 항상 이점을 제공하지 않을 수 있습니다. 향후 연구로는 이미지 및 시퀀스 데이터에 대한 DevNet 적용, 그리고 1~2개의 레이블링된 이상치만 존재하는 극한의 시나리오를 위한 데이터 기반 및 사전 기반 참조 점수 생성의 하이브리드 접근 방식이 제안되었습니다.

## 📌 TL;DR

**문제:** 기존 딥 이상 탐지 모델은 특징 표현 학습을 통해 이상 점수를 간접적으로 최적화하여 데이터 비효율적이며 소수의 레이블링된 이상치를 활용하기 어렵습니다.
**방법:** DevNet은 소수의 레이블링된 이상치와 가우시안 사전 분포를 활용하여 이상 점수를 종단간 직접 학습하는 새로운 프레임워크입니다. Z-점수 기반 편차 손실을 통해 이상치 점수가 정상 데이터 점수로부터 상위 꼬리에서 통계적으로 유의미하게 벗어나도록 최적화합니다.
**결과:** DevNet은 AUC-ROC 및 AUC-PR에서 최신 방법론들을 크게 능가하며, 75-88% 더 적은 레이블링된 데이터로 유사하거나 더 나은 정확도를 달성하여 데이터 효율성이 뛰어납니다. 또한, 미확인 데이터에 이상치가 오염되어 있어도 강건한 성능을 유지하고, 해석 가능한 이상 점수를 제공합니다.
