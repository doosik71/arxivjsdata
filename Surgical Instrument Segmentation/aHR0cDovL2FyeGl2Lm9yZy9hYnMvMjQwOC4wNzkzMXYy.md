# Surgical SAM 2: Real-time Segment Anything in Surgical Video by Efficient Frame Pruning

Haofeng Liu, Erli Zhang, Junde Wu, Mingxuan Hong, Yueming Jin

## 🧩 Problem to Solve

최근 Segment Anything Model 2 (SAM2)는 이미지 및 비디오 분할에서 뛰어난 성능을 보였지만, 고해상도 영상 및 복잡하고 장기적인 시간 동역학(temporal dynamics)을 처리하는 데 있어 높은 계산 비용으로 인해 효율성 문제가 발생합니다. 특히 수술 비디오는 고해상도이며 길고, 프레임 간의 의미론적 정보 중복이 많아 SAM2의 적용이 어렵습니다. 이는 수술 환경의 제한된 리소스와 실시간 처리의 필요성 측면에서 큰 도전 과제입니다.

## ✨ Key Contributions

* 수술 비디오 분할의 특정 요구사항을 충족하도록 설계된 선구적인 SAM2 기반 모델인 SurgSAM2를 소개합니다.
* 선택적 프레임 가지치기(pruning)를 통해 계산 요구 사항을 줄이면서 높은 정확도를 유지하는 동적 메모리 관리 모듈을 통합하여 SAM2를 수술 환경에 최적화하는 혁신적인 접근 방식을 제안합니다.
* EndoVis17 및 EndoVis18 데이터셋에 대한 광범위한 평가를 통해 수술 도구 분할에서 정확도와 효율성 모두에서 SurgSAM2의 우수한 성능을 입증합니다.

## 📎 Related Works

* **수술 도구 분할 (Surgical Instrument Segmentation):** FCNs, U-Net과 같은 초기 딥러닝 모델부터 Transformer 기반 모델(Swin Transformers, multi-scale attention U-Nets) 및 SAM 기반 모델(SurgicalSAM)로 발전해 왔습니다. 그러나 효율성 문제 해결은 여전히 과제였습니다.
* **Segment Anything Model 2 (SAM2):** ViT 아키텍처와 다중 스케일 특징 추출을 통해 이미지 및 비디오 분할에서 강력한 성능을 보입니다. 하지만 고해상도 수술 비디오 처리에는 높은 계산 자원이 필요하며, 기존의 메모리 관리 방식은 중복 프레임을 유지하여 비효율성을 야기합니다.
* **메모리 뱅크 제한 (Memory Bank Restriction):** XMem, RMem과 같은 기법들은 비디오 분석에서 가장 관련성 높은 프레임만 유지하는 효율적인 메모리 관리를 탐구했습니다. SurgSAM2는 이를 기반으로 코사인 유사도 기반의 프레임 가지치기 메커니즘을 도입합니다.

## 🛠️ Methodology

SurgSAM2는 SAM2의 강력한 ViT 아키텍처를 기반으로 하지만, 수술 환경의 고유한 문제를 해결하기 위한 중요한 최적화를 통합합니다.

* **SurgSAM2 아키텍처:** SAM2의 이미지 인코더는 들어오는 비디오 프레임을 상세한 임베딩으로 처리하여 정확한 분할에 필요한 로컬 및 글로벌 특징을 캡처합니다. SurgSAM2는 여기에 동적 메모리 관리 시스템을 통합하여 덜 관련된 프레임을 선택적으로 가지치기합니다.

* **효율적인 프레임 가지치기 (Efficient Frame Pruning, EFP):**
  * 메모리 뱅크에 추가되기 전에 각 들어오는 프레임 $f_t$의 관련성을 지능적으로 평가합니다.
  * $f_t$와 슬라이딩 윈도우 내의 지난 $n$개 프레임 $\{f_{t-n}, \dots, f_{t-2}, f_{t-1}\}$ 간의 코사인 유사도 $S(f_t, f_i)$를 다음 수식으로 계산합니다:
        $$S(f_t, f_i) = \frac{f_t \cdot f_i}{\|f_t\|\|f_i\|}$$
  * $n$개의 코사인 유사도를 계산한 후, 가장 유사한 $m$개의 프레임을 가지치기하고, 나머지 $(n-m)$개의 프레임과 현재 프레임 $f_t$를 메모리 뱅크에 저장합니다.
  * 첫 번째 프레임 $f_0$는 핵심 참조 프레임으로 항상 메모리 뱅크에 유지되며 동적 메모리 뱅크 크기에 포함되지 않습니다.
  * 기본 SAM2가 과거 6개 프레임을 사용하는 것을 고려하여, 본 연구에서는 $n=5$, $m=2$로 설정하여 동적 메모리 뱅크에 4개 프레임을 유지합니다.

* **구현 세부 사항:**
  * RTX A6000 GPU (48GB), ViT-Small 백본, bfloat16 정밀도 사용.
  * 기존 SAM2의 $1024 \times 1024$ 해상도 대신 $512 \times 512$ 해상도로 미세 조정.
  * SAM2의 훈련 전략을 따라 비디오 및 이미지 훈련을 번갈아 수행.
  * SAM2의 일반화 능력을 보존하기 위해 마스크 디코더와 메모리 모듈만 미세 조정하고 프롬프트 인코더와 이미지 인코더는 고정.
  * 추론 시 첫 번째 프레임은 $1024 \times 1024$ 원본 해상도로 처리하여 고품질 분할을 보장하고, 나머지 프레임은 $512 \times 512$ 해상도로 처리하여 효율성 최적화.

## 📊 Results

* **모델 효율성 평가:**
  * EndoVis17 및 EndoVis18 데이터셋에서 SurgSAM2는 다양한 프롬프트 설정(Full Mask, One Point, Five Points)에 걸쳐 vanilla SAM2 대비 일관된 개선을 보였습니다.
  * 평균적으로 13.8%의 FPS 증가와 8.5%의 메모리 사용량 감소를 달성했습니다.
  * 미세 조정을 통해 EndoVis17의 1-point 설정에서 FPS가 29에서 86으로 3배 증가하고, 메모리 사용량은 3.11GB에서 1.09GB로 감소했습니다.

* **모델 정확도 평가:**
  * EFP 메커니즘만 적용했을 때, EndoVis17에서는 J&F 및 Dice 점수에서 약간의 감소를 보였으나, 더 어려운 EndoVis18 데이터셋에서는 J&F에서 2.2%, Dice에서 2.5%의 향상을 달성했습니다. 이는 중복 프레임 제거의 긍정적인 효과를 반영합니다.
  * **미세 조정 후:** SurgSAM2는 vanilla SAM2를 일관되게 능가했습니다. EndoVis17 (5 points)에서 J&F는 83.6%에서 88.0%로, Dice는 86.9%에서 91.4%로 증가했습니다. EndoVis18 (5 points)에서도 J&F는 76.3%에서 80.8%로, Dice는 80%에서 84.9%로 증가했습니다.
  * **다른 모델과의 비교 (Challenge IoU):** EndoVis18 데이터셋에서 SurgSAM2는 instance-level 분할 설정에서 SAM2를 일관되게 능가했으며, 다른 task-specific 모델들과도 경쟁력 있는 IoU 결과를 보였습니다 (예: Full prompt에서 SurgSAM2 84.4% vs. SAM2 82.2%).

* **정성적 평가:** vanilla SAM2가 때때로 목표 객체 분할에 실패하거나 잘못된 객체를 식별하는 것과 달리, SurgSAM2는 목표 도구에 대해 일관되게 정확한 분할 마스크를 생성했습니다.

## 🧠 Insights & Discussion

* SurgSAM2는 수술 비디오 분할에서 SAM2의 효율성 문제를 성공적으로 해결했습니다. 동적 프레임 가지치기(EFP) 메커니즘을 통해 메모리 사용량을 줄이고 처리 속도를 높이면서도 높은 분할 정확도를 유지했습니다.
* 이 연구는 리소스 제약이 있는 환경, 특히 수술 환경에서 효율적인 메모리 관리가 비디오 분할 발전에 결정적임을 보여줍니다.
* 더 낮은 해상도 데이터로 미세 조정을 수행했음에도 불구하고 vanilla SAM2의 고해상도 성능을 능가하는 것은 실제 수술 환경에서 모델 배포의 실현 가능성을 크게 높입니다.
* **한계 및 향후 연구:** EFP 전략을 더욱 세분화하고 다양한 메모리 뱅크 크기를 실험하여 효율성과 정확도를 극대화하는 최적의 구성을 찾는 데 집중할 것입니다. 또한, SurgSAM2의 견고성과 적용 가능성을 검증하기 위해 더 다양하고 복잡한 데이터셋으로 평가를 확장할 계획입니다.

## 📌 TL;DR

**문제:** SAM2는 수술 비디오 분할에서 높은 계산 비용과 프레임 간 중복성으로 인해 실시간 처리가 어렵습니다.
**방법:** SurgSAM2는 코사인 유사도 기반의 효율적인 프레임 가지치기(EFP) 메커니즘을 도입하여 메모리 뱅크를 동적으로 관리하고, 가장 정보가 많은 프레임만 유지하여 계산 효율성을 높입니다.
**결과:** SurgSAM2는 vanilla SAM2 대비 최대 3배 빠른 FPS와 현저히 감소된 메모리 사용량을 달성하며, 특히 미세 조정 후에는 최신 수준의 분할 정확도를 제공하여 리소스 제약이 있는 수술 환경에서 실시간 비디오 분할을 현실화합니다.
