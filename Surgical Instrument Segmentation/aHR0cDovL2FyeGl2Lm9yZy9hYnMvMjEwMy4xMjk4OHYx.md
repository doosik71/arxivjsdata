# One to Many: Adaptive Instrument Segmentation via Meta Learning and Dynamic Online Adaptation in Robotic Surgical Video

Zixu Zhao, Yueming Jin, Bo Lu, Chi-Fai Ng, Qi Dou, Yun-Hui Liu, and Pheng-Ann Heng

## 🧩 해결하고자 하는 문제

로봇 보조 수술(RAS)에서 수술 도구 분할(segmentation)은 핵심 과제이나, 딥러닝 모델은 훈련 및 테스트 비디오가 동일 도메인에서 온다는 가정에 기반합니다. 현실에서는 새로운 도메인마다 충분한 데이터를 수집하고 주석을 달기 어렵고 비용이 많이 들며, 훈련-테스트 데이터 간의 분포 변화(domain shift)가 발생하면 기존 모델의 성능이 크게 저하됩니다.

이 논문은 레이블 효율성을 극대화하기 위해 "적응형 도구 분할(adaptive instrument segmentation)"이라는 새로운 문제를 탐구합니다. 이는 하나의 소스 모델을 타겟 도메인의 새로운 로봇 수술 비디오에 효과적으로 적응시키는 것으로, 이때 타겟 도메인에서는 첫 번째 프레임 주석만 활용됩니다.

## ✨ 주요 기여

* 로봇 수술 비디오를 위한 핵심적이면서도 도전적인 문제인 **적응형 도구 분할** (다대일 적응)을 처음으로 연구하고, 새로운 도메인에서 **첫 번째 프레임만 레이블링**하는 규칙으로 레이블 효율성을 향상시켰습니다.
* 다수의 비디오 작업에서 공유되는 도구의 **공통 지식을 학습**하도록 모델을 강화하는 **비디오별 작업 공간**을 메타 학습(meta-learning) 프레임워크에 설계했습니다.
* 불완전한 유사 마스크(pseudo masks)로부터의 노이즈 있는 감독(noisy supervision)을 걸러내고 매개변수를 선별적으로 업데이트하는 **노이즈 인식 그래디언트 게이트(gradient gate)**를 통해 테스트 프레임에 대한 모델의 온라인 적응을 수행하여, 연속적인 온라인 적응 대비 성능과 효율성을 모두 향상시켰습니다.
* 새로운 도메인에서 평균 IoU 75.5%와 Dice 84.9%의 뛰어난 도구 분할 결과를 달성했습니다.

## 📎 관련 연구

* **완전 지도 학습(Fully-supervised learning)**: 대부분의 기존 방법은 대규모 주석 데이터에 의존하며, 훈련-테스트 데이터의 동일 분포 가정을 따릅니다.
* **준지도 학습(Semi-supervised learning), 자기 지도 학습(Self-supervised learning), 도메인 적응(Domain adaptation)**: 레이블 없는 데이터에 대한 유사 마스크 생성 등을 통해 레이블 효율성을 높이려 했지만, 여전히 도메인 변화 문제에 직면했습니다.
* **MAML (Model-agnostic meta-learning)**: 소수의 반복으로 새로운 작업에 빠르게 적응할 수 있는 일반적인 표현 학습 패러다임을 제공하며, 본 연구의 메타 학습 기반 프레임워크 구축에 영감을 주었습니다.
* **비디오 객체 분할(Video Object Segmentation, VOS)의 온라인 적응**: MVOS-OL [27], Dual-MF [13] 등은 온라인 적응 기법을 사용하지만, 로봇 수술 비디오의 빠른 도구 움직임에 강인하게 대처하지 못하는 한계가 있습니다.

## 🛠️ 방법론

제안하는 MDAL(Meta-learning based Dynamic Online Adaptive Learning)은 다음 두 단계로 구성됩니다.

1. **오프라인 메타 훈련 (Offline Meta-training)**
    * **목표**: 모델이 새로운 비디오에 빠르게 적응할 수 있는 능력을 갖추도록 학습합니다.
    * **접근 방식**: MAML(Model-Agnostic Meta-Learning) 프레임워크를 기반으로 합니다.
    * **비디오별 작업 공간**: 소스 도메인 $D_a$에서 $n$개의 비디오 $\{v_1, \dots, v_n\}$를 샘플링합니다. 각 비디오 $v_k$에서 프레임 쌍 $\{(I_i, y_i), (I_{i+\epsilon}, y_{i+\epsilon})\}$을 샘플링하여 메타-훈련(meta-train) 및 메타-테스트(meta-test) 세트를 구성합니다. $I_i$는 입력 이미지, $y_i$는 해당 그라운드 트루스 마스크입니다.
    * **내부 루프 (Inner Loop)**: 각 작업 $\tau$에 대해 한 단계의 경사 하강법으로 작업별 매개변수 $\theta_\tau$를 업데이트합니다:
        $$\theta_\tau \leftarrow \theta - \alpha \odot \nabla_\theta L_{seg}(I_i, y_i; \theta)$$
        여기서 $L_{seg}$는 하이브리드 분할 손실(교차 엔트로피 + 자카드)이며, $\alpha$는 학습 가능한 스텝 크기입니다.
    * **외부 루프 (Outer Loop)**: 메타-학습자 ($\theta, \alpha$)는 메타-테스트 세트에서 누적 손실 $L$을 최소화하도록 최적화되어, 새로운 도메인에 빠르게 적응할 수 있는 최적의 초기화 매개변수 ($\theta^*, \alpha^*$)를 제공합니다:
        $$\theta^* \leftarrow \theta - \beta_\theta \nabla_\theta \frac{1}{n} L$$
        $$\alpha^* \leftarrow \alpha - \beta_\alpha \nabla_\alpha \frac{1}{n} L$$

2. **동적 온라인 적응 (Dynamic Online Adaptation)**
    * **목표**: 메타 학습된 모델을 타겟 비디오의 첫 프레임 주석에 빠르게 적응시키고, 이후 프레임에서는 노이즈에 강인하게 온라인으로 적응시킵니다.
    * **메타 적응 (Meta-adaptation)**: 타겟 비디오의 첫 프레임 $(I_1, y_1)$에 대해 $\theta^*$와 $\alpha^*$로 초기화된 모델을 단 몇 번의 반복($K \le 5$)으로 적응시킵니다.
    * **유사 마스크 생성 (Pseudo mask generation)**: 현재 프레임 $I_i$의 유사 마스크 $\bar{y}_i$는 이전 프레임 예측 $\hat{y}_{i-1}$과 업데이트된 매개변수 $\theta_{i-1}$로부터 생성됩니다. 거리에 기반한 배경($\bar{y}_i^b$) 및 예측의 높은 신뢰도를 갖는 전경($\bar{y}_i^f$) 픽셀을 사용하여 소프트 교차 엔트로피 손실 $L_{pse}$를 계산합니다:
        $$L_{pse} = \frac{1}{HW} \sum_t -\bar{y}_{i,t}^f \log \hat{y}_{i,t} - \bar{y}_{i,t}^b \log(1 - \hat{y}_{i,t})$$
    * **그래디언트 게이트를 이용한 동적 적응 (Dynamic adaptation with gradient gate)**:
        * 모델 업데이트 방향을 결정하기 위해 첫 프레임의 그라운드 트루스 $y_1$와 현재 프레임의 유사 마스크 $\bar{y}_i$에서 파생된 그래디언트를 통합합니다:
            $$\nabla_{\theta_i} L \leftarrow \gamma \nabla_{\theta_i} L_{seg}(I_1, y_1; \theta_i) + (1-\gamma)\nabla_{\theta_i} L_{pse}(I_i, \bar{y}_i; \theta_i)$$
            여기서 $\gamma$는 하이퍼파라미터입니다.
        * 이 통합된 그래디언트를 사용하여 한 단계 업데이트된 모델과 업데이트되지 않은 모델 간의 첫 프레임 손실 차이 $\Delta$를 측정합니다:
            $$\Delta = L_{seg}(I_1, y_1; \theta_i - \alpha^* \odot \nabla_{\theta_i} L) - L_{seg}(I_1, y_1; \theta_i)$$
        * **그래디언트 게이트**: 만약 $\Delta < 0$이면, 유사 마스크의 품질이 높아 긍정적으로 모델을 최적화한다고 판단하여 모델을 업데이트합니다. $\Delta \ge 0$이면 노이즈가 있다고 판단하여 업데이트를 수행하지 않습니다. 이는 노이즈 유사 마스크로 인한 부정적인 영향을 방지하고 적응 효율성을 높입니다.

## 📊 결과

* **데이터셋**: EndoVis17 (소스), EndoVis18, HKPWH, DSS, PSH (타겟)
* **정량적 결과**:
  * MDAL은 EndoVis18에서 IoU 73.3%, Dice 83.6%, HKPWH에서 IoU 77.7%, Dice 86.2%를 달성하여 기존 SOTA(State-of-the-Art) 방법을 능가했습니다.
  * 첫 프레임 메타-적응에 단 5회 반복만 필요하여, 100회 반복이 필요한 기존 Fine-Tuning 방식(Base-FT)보다 FT 시간(25.16s vs 1.46s)을 크게 단축했습니다.
* **정성적 결과**: 빠른 움직임, 다중 인스턴스 등 로봇 수술 비디오의 일반적인 도전 과제에도 불구하고 강력하고 완전한 분할 결과를 보여주었습니다.
* **어블레이션 연구**: 메타-학습만으로도 기존 Fine-Tuning보다 훨씬 좋은 성능을 보였고, 노이즈 인식 동적 온라인 적응은 단순 온라인 적응 대비 성능을 일관되게 향상시켜 노이즈 유사 마스크의 부정적 영향을 성공적으로 완화했습니다.
* **다운스트림 애플리케이션 잠재력**: dVRK 기반 봉합 비디오(DSS) 및 팬텀 기반 자궁 적출술 시뮬레이션 비디오(PSH)에서 안정적인 도구 분할 및 미세한 도구 팁 추적 성능을 보여, 로봇 보조 봉합 및 자율 카메라 제어와 같은 중요한 다운스트림 작업에 대한 높은 잠재력을 입증했습니다.

## 🧠 통찰 및 논의

* **의미**: 본 연구는 소량의 레이블(첫 프레임만)만으로도 다양한 로봇 수술 도메인에 빠르고 효과적으로 적응할 수 있는 방법을 제시하여, 레이블 효율성과 실제 임상 시나리오 적용 가능성을 크게 향상시켰습니다. 메타 학습과 동적 온라인 적응의 결합은 도메인 불일치, 빠른 도구 움직임, 큰 외관 변화와 같은 어려운 문제를 효과적으로 해결했습니다.
* **한계 및 미래 연구**: 현재 추론 속도(4 fps)는 여러 로봇 작업에서 큰 잠재력을 보여주지만, 더 넓은 로봇 자동화 애플리케이션을 위해서는 추론 속도를 더욱 높여야 합니다. 이를 위해 경량 네트워크 [9], [34] 통합 또는 효율적인 적응을 위한 부분 매개변수 업데이트 방법을 탐색할 계획입니다.

## 📌 TL;DR

이 논문은 첫 프레임 주석만으로 여러 타겟 도메인에 적응하는 **적응형 도구 분할** 문제를 해결하기 위해 **MDAL**이라는 메타 학습 기반 동적 온라인 적응 프레임워크를 제안합니다. MDAL은 비디오별 메타 훈련을 통해 일반적인 도구 지식과 빠른 적응 능력을 학습하고, 노이즈 인식 그래디언트 게이트를 사용하여 불완전한 유사 마스크로 인한 노이즈를 걸러내며 선택적으로 온라인 적응을 수행합니다. 이 방법은 다양한 로봇 수술 데이터셋에서 뛰어난 분할 성능을 달성하여, 레이블 효율성을 높이고 로봇 보조 봉합 및 자율 카메라 제어와 같은 다운스트림 작업에 대한 높은 잠재력을 보여줍니다.
