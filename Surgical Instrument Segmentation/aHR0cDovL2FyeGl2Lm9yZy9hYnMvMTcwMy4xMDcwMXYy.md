# Concurrent Segmentation and Localization for Tracking of Surgical Instruments

Iro Laina, Nicola Rieke, Christian Rupprecht, Josué Page Vizcaíno, Abouzar Eslami, Federico Tombari, and Nassir Navab

## 🧩 Problem to Solve

최소 침습 수술(MIS) 및 망막 미세 수술(RM)에서 수술 도구의 실시간 추적은 수술 보조 시스템의 핵심 요소입니다. 기존의 비전 기반 추적 방법들은 반사광, 모션 블러, 강한 조명 변화와 같은 문제에 취약합니다. 특히, 도구의 정확한 위치(localization)와 형태(segmentation)를 결정하는 것은 서로 밀접하게 연관되어 있으나, 대부분의 기존 방법은 이를 독립적이거나 순차적인 단계로 처리하여 성능 한계를 보였습니다. 이 연구는 이러한 문제를 해결하고, 제한된 데이터 상황에서도 강건하고 정확한 실시간 마커-프리 도구 추적 방법을 개발하는 것을 목표로 합니다.

## ✨ Key Contributions

* **동시 세그멘테이션 및 자세 추정:** 수술 도구 세그멘테이션과 2D 자세 추정을 단일의 심층 학습 접근 방식(CSL) 내에서 동시적으로 수행하는 새로운 방법을 제안합니다.
* **히트맵 회귀 기반 랜드마크 추정:** 2D 도구 랜드마크 위치 추정 문제를 2D 좌표를 직접 회귀하는 대신 히트맵(heatmap) 회귀 문제로 재정의하여 정확도와 강건성을 크게 향상시켰습니다.
* **공유 가중치를 통한 상호 의존성 활용:** 세그멘테이션과 랜드마크 히트맵이 동일한 차원을 가지도록 모델링하여 공간적 상호 의존성을 활용하고, 네트워크 전체에 걸쳐 가중치를 공유하여 두 태스크를 동시에 학습할 수 있도록 합니다.
* **ResNet-50 기반 Fully Convolutional Network:** 최신 ResNet-50 아키텍처를 인코더로 활용하고, 디코더에 긴 범위의 스킵 연결(skip connection)을 추가하여 고해상도 정보 흐름을 개선하고 정확도를 높였습니다.
* **최첨단 성능 달성:** 망막 미세 수술 벤치마크 및 MICCAI EndoVis 챌린지 2015 데이터셋에서 기존 최첨단(SOTA) 방법들을 뛰어넘는 성능을 입증했습니다.
* **유연성 및 효율성:** 추적되는 관절의 수와 의미론적 클래스(semantic classes)에 유연하게 대응하며, 초기화, 후처리 또는 시간적 정규화 없이도 실시간에 가까운 추론 속도를 제공합니다.

## 📎 Related Works

* **수동 특징 기반 접근법:** Haar 웨이블릿 [2], 기울기(gradient) [3-6], 색상 특징 [7, 8] 등을 활용했으나, 조명 변화, 모션 블러에 취약하고 일반화 능력이 제한적이었습니다. Rieke et al. [9]은 두 특징 유형을 결합하여 사용했습니다.
* **심층 학습 기반 도구 감지:** Sarikaya et al. [11]은 영역 제안(region proposal)을 통해 도구 감지 및 바운딩 박스를 제공했으나, 정밀한 랜드마크 위치는 제공하지 않았습니다.
* **2단계 접근법:** 도구 세그멘테이션 후 위치를 결정하는 방식으로 Allan et al. [12], Reiter et al. [13] 등이 제안했으며, 최근의 세그멘테이션 방법 [14, 15]도 활용될 수 있습니다. 그러나 이는 세그멘테이션과 위치 추정이 상호 의존적이라는 점을 간과합니다.
* **인간 자세 추정에서의 히트맵 활용:** 인간 자세 추정 분야에서 히트맵을 사용하여 랜드마크 위치를 추정하는 접근법 [21, 22]이 성공적으로 적용되었습니다.
* **CNN 아키텍처:** U-Net [18] 및 FCN 기반 접근법 [14]과 같은 인기 있는 CNN 아키텍처와 비교되었습니다.

## 🛠️ Methodology

본 연구는 입력 이미지로부터 도구 랜드마크의 위치와 해당 조밀한 의미론적 레이블링(semantic labeling)을 모델링하기 위해 CNN 기반 접근 방식을 사용합니다.

1. **인코더(Encoder): ResNet-50 활용**
    * 입력 이미지(480x480)를 순차적인 잔차 블록(residual block)을 통해 다운샘플링하여 특징 맵을 추출합니다.
    * ImageNet으로 사전 학습된 ResNet-50 [17] 가중치를 사용하여 깊은 아키텍처와 낮은 복잡도를 유지하면서 학습을 용이하게 합니다. 마지막 풀링 레이어와 손실 레이어는 제거됩니다.

2. **디코더 태스크(Decoder Tasks): 세 가지 모델 전략 비교**
    * **Localization (L):** 랜드마크의 실제 2D 좌표 ($2n$ 차원 벡터)를 직접 회귀합니다. $L_2$ 손실을 사용하여 학습하며, 세그멘테이션 태스크는 포함되지 않습니다.
    * **Segmentation and Localization (SL):** 2D 랜드마크 위치와 의미론적 세그멘테이션 맵을 동시에 예측합니다. 인코더 가중치를 공유한 후 두 개의 독립적인 분기로 나뉩니다. 위치 추정에는 L 모델과 동일한 회귀 방식을 사용하고, 세그멘테이션에는 잔차 업샘플링 레이어 [16]를 사용합니다. $L_L$ 손실과 픽셀 단위의 소프트맥스-로그 손실 $L_S$를 결합한 $l_{SL} = \lambda_L l_L + l_S$를 사용합니다.
    * **Concurrent Segmentation and Localization (CSL) (제안 모델):**
        * 랜드마크 위치를 정확한 좌표 대신 각 랜드마크에 대한 **히트맵**으로 회귀합니다. 히트맵은 정답 위치에 가우시안 커널을 적용하여 생성되며, 실제 위치에 가까울수록 신뢰도가 높아집니다.
        * 세그멘테이션과 동일한 크기의 히트맵을 사용하여 네트워크 전체에서 명시적으로 가중치를 공유합니다.
        * 긴 범위의 스킵 연결(long-range skip connections)을 인코딩에서 디코딩 단계로 추가하여 저수준의 고해상도 특징을 활용하고 모델의 정확도를 높입니다.
        * 두 태스크를 거의 마지막 단계에서만 분리하고, 예측된 세그멘테이션 점수(소프트맥스 전)를 마지막 특징 맵 세트에 보조 수단으로 연결하여 위치 히트맵을 안내합니다.
        * 전체 손실은 세그멘테이션 손실 $l_S$와 히트맵 $L_2$ 손실의 합으로 정의됩니다: $l_{CSL} = l_S(\tilde{S},S) + \frac{\lambda_H}{n} \sum_{i=1}^n \sum_{x=1}^w \sum_{y=1}^h || \frac{1}{\sqrt{2\pi\sigma^2}} e^{-\frac{||y_i - (x,y)^T||^2_2}{2\sigma^2}} - \tilde{y}^*_{x,y,i} ||^2_2$.
        * 추론 시에는 각 예측된 히트맵에서 최대 신뢰도 지점을 랜드마크 위치로 사용합니다.

3. **학습 및 데이터 증강:**
    * 입력 이미지는 640x480으로 크기가 조정됩니다.
    * 학습 중 무작위 회전, 스케일링, 자르기, 감마 보정, 색상 요인 조절, 반사 추가 등의 데이터 증강을 적용하여 강건성을 높입니다.
    * 확률적 경사 하강법(SGD)으로 학습하며, 실시간에 가까운 추론 시간(56ms/프레임)을 달성합니다.

## 📊 Results

* **모델링 전략 평가 (RM 데이터셋):**
  * **L (직접 2D 좌표 회귀):** 가장 낮은 정확도를 보였습니다.
  * **SL (세그멘테이션 + 2D 좌표 회귀):** L보다 성능이 향상되었습니다.
  * **CSL (히트맵 회귀 + 세그멘테이션):** 가장 높은 정확도를 달성했습니다. 도구 팁의 경우 90% 이상, 중앙 관절의 경우 20픽셀 허용 오차 기준 79%의 정확도를 보였습니다. U-Net보다 지속적으로 높은 정확도를 보였으며, CSL의 DICE 스코어는 75.4% (스킵 연결 없는 CSL 74.4%, SL 73.7%, U-Net 72.5%).
* **망막 미세 수술(RM) 데이터셋:**
  * **Half Split Experiment:** 제안된 CSL 방법은 KBB 스코어 [3] (α=0.15) 기준으로 평균 84% 이상의 정확도를 달성하여 FPBC [23], POSE [3], Online Adaption [9] 등 기존 최첨단 방법들을 명확히 능가했습니다.
  * **Cross Validation Experiment:** 보이지 않는 시퀀스와 미지의 도구 형상에 대한 일반화 능력을 평가하는 leave-one-out 방식에서도 최첨단 성능을 유지했습니다.
* **EndoVis 챌린지 데이터셋:**
  * leave-one-surgery-out 방식으로 교차 검증을 수행한 결과, 기존 최첨단 방법보다 현저히 우수한 성능을 보였습니다.
  * 여러 도구의 부품(예: 왼쪽/오른쪽 손잡이, 샤프트)을 구별할 수 있었으며, 심지어 이전에 학습 데이터셋에서 보지 못했던 도구 유형과 시점도 성공적으로 위치를 파악하고 분할할 수 있었습니다. (Sequence 5, 6)
  * 평균 이진 정확도(B.Acc.) 92.6%, DICE 88.9%를 달성했습니다. 평균 위치 오류(loc. error)는 24.8/51.6 픽셀이었습니다.

## 🧠 Insights & Discussion

* **히트맵 회귀의 우수성:** 2D 랜드마크 위치를 히트맵으로 모델링하는 것이 직접적인 좌표 회귀보다 훨씬 정확하고 강건하다는 것이 입증되었습니다. 이는 수동 주석의 불일치나 부정확성을 완화하고, 이미지 컨텍스트를 더 잘 활용하기 때문입니다.
* **세그멘테이션과 위치 추정의 상호 의존성 활용:** 두 태스크를 동시적으로 학습함으로써, 세그멘테이션 정보가 위치 추정에 대한 강력한 보조 신호 역할을 하고, 그 반대도 가능하여 전체 성능이 향상됩니다.
* **유연하고 확장 가능한 아키텍처:** 제안된 CSL 모델은 추적되는 관절의 수와 의미론적 클래스를 유연하게 조정할 수 있어, 단일 도구뿐만 아니라 여러 도구, 심지어 좌우 도구를 구별하는 복잡한 시나리오에도 적용 가능합니다.
* **실용성:** 초기화, 후처리 기술 또는 시간적 정규화가 필요 없으며, 실시간에 가까운 추론 속도를 제공하여 수술 중 컴퓨터 보조 시스템에 즉시 통합될 수 있는 잠재력을 가집니다.
* **제한된 데이터에 대한 강건성:** 데이터가 제한적인 환경에서도 심층 학습 방법을 성공적으로 적용하고 최첨단 성능을 달성한 것은 중요한 성과입니다. 이는 의료 영상 분야에서 흔히 겪는 데이터 부족 문제를 극복할 수 있는 가능성을 보여줍니다.
* **향후 과제:** EndoVis 챌린지 일부 시퀀스의 그라운드 트루스 정확도 문제와 같이 여전히 해결해야 할 과제가 남아 있습니다. 3D 자세 추정으로의 확장도 고려해 볼 수 있습니다.

## 📌 TL;DR

이 논문은 수술 도구 추적의 고질적인 문제(반사, 블러, 조명 변화)를 해결하기 위해 **수술 도구의 세그멘테이션(segmentation)과 2D 자세 추정(pose estimation)을 동시에 수행하는 딥러닝 기반 방법(CSL)**을 제안합니다. 특히, 2D 랜드마크 위치 추정 문제를 직접 좌표를 회귀하는 대신 **히트맵(heatmap) 회귀**로 재정의하여 정확도를 높였습니다. 인코더로 ResNet-50을 사용하고 긴 범위의 스킵 연결을 통해 고해상도 컨텍스트 정보를 활용하며, 두 태스크의 **상호 의존성을 활용**하도록 설계된 단일 네트워크를 **종단 간(end-to-end) 학습**시킵니다. 실험 결과, 제안된 CSL은 망막 미세 수술 및 MICCAI EndoVis 챌린지 벤치마크에서 기존 최첨단 방법들을 능가하는 성능을 보였고, 실시간에 가까운 추론 속도와 여러 도구를 구별하는 유연성을 입증했습니다.
