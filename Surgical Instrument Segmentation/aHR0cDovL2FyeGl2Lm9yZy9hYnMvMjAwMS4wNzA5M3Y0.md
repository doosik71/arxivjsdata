# BARNet: Bilinear Attention Network with Adaptive Receptive Fields for Surgical Instrument Segmentation

Zhen-Liang Ni, Gui-Bin Bian, Guan-An Wang, Xiao-Hu Zhou, Zeng-Guang Hou, Xiao-Liang Xie, Zhen Li, Yu-Han Wang

## 🧩 Problem to Solve

이 논문은 컴퓨터 보조 수술에 필수적인 수술 도구 분할(surgical instrument segmentation)이 직면한 주요 난제들을 해결하고자 합니다.

- **조명 변화(Illumination Variation)**: 수술 장면의 특성상 반사광(specular reflection)과 그림자(shadow)로 인해 수술 도구의 색상 및 질감 표현이 크게 달라져 안정적인 식별이 어렵습니다.
- **스케일 변화(Scale Variation)**: 수술 도구의 연속적인 움직임과 시점 변화로 인해 같은 도구라도 크기와 모양이 다양하게 변하여 정확한 분할이 어렵습니다.
기존의 많은 연구들은 수용장(receptive field) 확장이나 형상 사전(shape prior) 캡처에 중점을 두었으나, 이러한 조명 및 스케일 변화 문제 해결에는 미흡했습니다.

## ✨ Key Contributions

- **Bilinear Attention Module (BAM) 제안**: 조명 변화에 강건하게 대응하기 위해 2차 통계(second-order statistics)를 캡처하여 전역 컨텍스트와 픽셀 간의 의미론적 의존성을 모델링하고, 이를 통해 도전적인 영역에서 의미론적 특징을 추론하여 특징 표현을 강화합니다. 이 모듈은 추가 파라미터를 필요로 하지 않습니다.
- **Adaptive Receptive Field (ARF) Module 설계**: 수술 도구의 스케일 변화에 적응하기 위해 다중 스케일 특징을 통합하고, 채널 간의 의미론적 관계를 인코딩하여 적절한 스케일의 특징 맵을 강조함으로써 최적의 수용장을 동적으로 선택합니다.
- **최고 성능 달성**: 제안된 네트워크(BARNet)는 Cata7 데이터셋에서 97.47% mIOU를 달성하고, EndoVis 2017 데이터셋에서는 2위 방법보다 10.10% 높은 IOU로 1위를 차지하여 최신 기술(state-of-the-art) 성능을 입증했습니다.

## 📎 Related Works

- **어텐션 메커니즘(Attention Mechanisms)**:
  - **1차 연산 기반**: SENet은 전역 평균 풀링을 사용하여 채널 간 의미론적 의존성을 모델링하며, AGRNet은 컨볼루션 풀링을 사용하여 어텐션 특징을 생성합니다.
  - **2차 연산 기반**: A$^2$-Net은 이차 풀링 기반으로 2차 통계를 캡처하여 복잡한 의미론적 의존성을 모델링하며, Bilinear Attention Networks는 저랭크 이차 풀링 위에 이차 어텐션 분포를 학습합니다. 이는 2차 모델이 풍부한 의미론적 관계를 포착하여 특징 표현을 향상시킬 수 있음을 보여줍니다. BARNet은 인코더-디코더 아키텍처 내에서 어텐션 특징을 집계하고 분배하는 새로운 방식을 제안합니다.
- **적응형 수용장 및 피라미드 특징(Adaptive Receptive Field and Pyramid Features)**:
  - **다중 스케일 특징 집계**: PSPNet은 피라미드 풀링을, DeepLabV2는 다양한 팽창률의 팽창 컨볼루션을, FPN(Feature Pyramid Network)은 다중 스케일 특징을 횡적으로 전파합니다. 그러나 이 방법들은 단순히 다중 스케일 특징을 연결할 뿐 특정 작업에 적합한 스케일을 선택하지 못합니다.
  - **적응형 수용장 선택**: SKNet은 다양한 크기의 커널을 사용하여 특징 맵을 생성하고 필터링하는 방식으로 적응형 수용장 선택 솔루션을 제공합니다. BARNet은 커널 크기 대신 다중 스케일 특징 맵 자체를 직접 선택하고, cross-scale dense connections을 활용하여 더 넓은 스케일 범위를 커버하며 특징 재사용을 증진합니다.

## 🛠️ Methodology

BARNet은 조명 및 스케일 변화 문제를 해결하기 위해 Bilinear Attention Module (BAM)과 Adaptive Receptive Field (ARF) Module을 핵심 구성 요소로 사용합니다. ImageNet으로 사전 학습된 Residual Network를 백본으로 채택합니다.

- **Bilinear Attention Module (BAM)**:
  - **목표**: 조명 변화로 인한 색상 및 질감 변화 문제를 해결하고, 전역 컨텍스트 및 의미론적 의존성을 통해 도전적인 영역의 특징을 추론합니다.
  - **인코딩**: 이차 풀링($F_{bp}$)을 사용하여 입력 특징 맵 $X \in \mathbb{R}^{D \times W \times H}$에서 각 픽셀 쌍의 외적을 계산, 2차 통계를 캡처하여 전역 디스크립터 $A \in \mathbb{R}^{D \times D}$를 생성합니다. $A = F_{bp}(X, X) = XX^T = \sum_{i=1}^{W} \sum_{j=1}^{H} x_{ij}x_{ij}^T$.
  - **정규화**: 생성된 전역 어텐션 맵 $A$에 요소별 부호 제곱근($sign(A)\sqrt{|A|}$) 및 $L_2$ 정규화($F_{norm}$)를 적용하여 특징 표현을 강화합니다. $A' = F_{norm}(A) = sign(A)\sqrt{|A|} / \|sign(A)\sqrt{|A|}\|_2$.
  - **디코딩**: 정규화된 어텐션 특징 $A'$를 입력 특징 맵 $X$의 각 위치에 행렬 곱셈을 통해 분배하여 전역 정보로 보정된 최종 어텐션 특징 맵 $Z \in \mathbb{R}^{D \times W \times H}$를 얻습니다. $Z = F_{decode}(A', X) = A' \times \bar{X} + X$.
  - **특징**: 매트릭스 연산만 수행하므로 추가 파라미터가 없으며(parameter-free), 다른 네트워크에 쉽게 삽입 가능합니다.

- **Adaptive Receptive Field Module (ARF)**:
  - **목표**: 수술 도구의 스케일 및 모양 변화에 적응하기 위해 적절한 수용장을 동적으로 선택하고 다중 스케일 특징을 효율적으로 통합합니다.
  - **다중 스케일 특징 준비**: 다양한 스케일의 특징 맵에 $1 \times 1$ 컨볼루션을 적용하여 채널 차원 $N$ (본 논문에서는 8)으로 조정하여 다중 스케일 특징의 집계 및 계산 효율성을 높입니다. 최대 스케일 특징 맵은 채널을 압축하지 않아 의미론적 정보를 보존합니다.
  - **두 가지 브랜치**:
        1. **채널 간 의미론적 관계 모델링**: 다중 스케일 특징들을 전역 평균 풀링(Global Average Pooling, GAP)을 통해 벡터로 변환하고, 이 벡터들을 연결한 후 두 개의 컨볼루션 레이어를 통과시켜 가중치 벡터 $S$를 생성합니다. $S$는 각 특징 맵의 의미론적 응답 강도를 나타냅니다.
        2. **다중 스케일 특징 집계**: 다중 스케일 특징 맵들을 업샘플링하고 연결하여 피라미드 특징 $P$를 생성합니다. $P = H([f_{2^k}(x_0), f_{2^{k-1}}(x_1), ..., f_{2^1}(x_{k-1})])$, 여기서 $x_k$는 $k$-번째 저스케일 특징 맵, $f_{2^k}$는 $1 \times 1$ 컨볼루션과 $2^k \times$ 업샘플링, $H$는 연결을 의미합니다.
  - **적응형 수용장 선택**: 생성된 피라미드 특징 $P$에 가중치 벡터 $S$를 브로드캐스트 하더마드 곱($\otimes$)으로 곱하여 반응이 큰 특징 맵을 강조합니다. $P_S = S \otimes P$. 이를 통해 후속 컨볼루션의 수용장이 적응적으로 조정됩니다.
  - **특징**: 매우 적은 수의 파라미터(0.1M)만을 추가하여 효율적입니다.

- **손실 함수(Loss Function)**:
  - 클래스 불균형 문제를 해결하기 위해 교차 엔트로피(Cross-entropy, $H$)와 Dice 손실($D$)을 결합한 하이브리드 손실을 사용합니다.
  - $Loss = (1 - \alpha)H - \alpha \ln(D)$, 여기서 $\alpha \in [0, 1]$은 두 손실 간의 균형을 맞추는 가중치로, 본 논문에서는 0.2로 설정되었습니다.

## 📊 Results

BARNet은 두 가지 주요 수술 도구 분할 데이터셋에서 최신 기술을 능가하는 뛰어난 성능을 입증했습니다.

- **Cata7 데이터셋**:
  - **최고 성능**: 97.47% mIOU와 98.68% mDice를 달성하여, 기존의 모든 비교 방법들을 능가했습니다. 특히, 2위 방법보다 mIOU에서 1.85%, mDice에서 0.97% 높은 성능을 보였습니다.
  - **어블레이션 스터디(Ablation Study)**:
    - **BAM 효과**: BAM은 네트워크 성능을 크게 향상시키며(mIOU 4.66% 증가), 파라미터를 전혀 추가하지 않는다는 장점이 있습니다. BAM의 출력 특징 맵은 계측기 영역을 효과적으로 강조하여, 조명 변화로 인한 불완전한 분할 문제를 해결함을 시각적으로 보여줍니다.
    - **ARF 효과**: ARF 또한 네트워크 성능을 크게 향상시키며(mIOU 4.97% 증가), 단 0.1M의 파라미터만을 추가하여 매우 효율적입니다. ARF가 없는 네트워크는 BARNet보다 분할 성능이 현저히 떨어지는 것을 확인했습니다.
  - **클래스별 정확도**: 특히 primary incision knife (I1), lens hook (I6), bonn forceps (I10)과 같이 반사광에 취약한 재질의 도구에서 다른 방법들보다 월등한 성능을 보였습니다.

- **EndoVis 2017 데이터셋**:
  - **1위 달성**: 64.30% mIOU를 달성하여 참가 팀 중 1위를 차지했습니다. 2위 방법(TernausNet, 54.20%)보다 10.10% 높은 IOU로 큰 격차를 보였습니다.
  - **비디오 시퀀스별 성능**: 10개의 비디오 시퀀스 중 7개에서 최고 결과를, 나머지 3개에서 2위를 기록하며 다양한 수술 환경에서의 강건성을 입증했습니다.
  - **시각화**: 반사광, 그림자, 스케일 및 모양 변화가 큰 복잡한 수술 장면에서도 BARNet이 수술 도구를 정확하게 분할하며, 분할 결과가 ground truth와 거의 일치함을 보여주었습니다.

## 🧠 Insights & Discussion

BARNet의 성공은 수술 도구 분할의 고유한 난제인 조명 및 스케일 변화에 대한 깊은 이해와 이를 해결하기 위한 혁신적인 모듈 설계에서 비롯됩니다.

- **조명 변화에 대한 강건성**: Bilinear Attention Module (BAM)은 2차 통계를 활용하여 픽셀 간의 복잡한 의미론적 의존성을 효과적으로 모델링합니다. 이는 단순히 지역적인 특징을 넘어 전역적인 맥락에서 반사광이나 그림자로 인해 손상된 도구의 시각적 특징을 정확하게 추론할 수 있게 합니다. 파라미터가 없는 BAM의 설계는 모델의 효율성을 극대화하면서도 성능을 크게 향상시켜, 실제 수술 환경의 예측 불가능한 조명 조건에서도 신뢰할 수 있는 분할을 가능하게 합니다.
- **스케일 변화에 대한 적응성**: Adaptive Receptive Field (ARF) Module은 수술 도구의 지속적인 움직임과 시점 변화로 인한 스케일 및 모양 변화에 대한 강력한 해결책을 제공합니다. 다중 스케일 특징을 통합하고 채널 간 의미론적 관계를 통해 가장 적절한 스케일의 정보를 동적으로 선택함으로써, 네트워크가 다양한 크기의 도구를 정확하게 인식하고 분할할 수 있도록 합니다. 이는 기존의 고정된 수용장을 가진 네트워크의 한계를 극복하는 중요한 발전입니다.
- **하이브리드 손실 함수의 시너지**: Cross-entropy와 Dice loss를 결합한 하이브리드 손실 함수는 수술 도구 분할에서 흔히 발생하는 클래스 불균형 문제를 효과적으로 완화하여, 특히 작은 도구나 미세한 부분의 분할 정확도를 높이는 데 기여합니다.
- **실용적 의의**: BARNet이 Cata7 및 EndoVis 2017과 같은 실제 수술 데이터셋에서 최첨단 성능을 달성했다는 점은 컴퓨터 보조 수술 시스템의 정확도와 신뢰도를 크게 향상시킬 수 있는 잠재력을 의미합니다. 이는 수술 로봇 제어, 실시간 수술 알림, 수술 기술 평가 등 다양한 응용 분야에 긍정적인 영향을 미칠 수 있습니다.
- **향후 연구 방향**: 본 논문은 실시간 처리 속도 최적화, 더욱 복잡하고 예측 불가능한 수술 환경에서의 강건성 검증, 그리고 다양한 종류의 수술 도구에 대한 일반화 능력 향상 등을 포함한 추가 연구의 기회를 열어줍니다.

## 📌 TL;DR

BARNet은 수술 도구 분할 시 발생하는 조명 및 스케일 변화라는 두 가지 핵심 난제를 해결하기 위해 제안된 혁신적인 딥러닝 네트워크입니다. 이 네트워크는 2차 통계를 활용하여 전역 컨텍스트와 픽셀 간 의미론적 의존성을 캡처하는 파라미터 없는 **Bilinear Attention Module (BAM)**을 통해 조명 변화에 강건하게 대응합니다. 또한, 다중 스케일 특징을 지능적으로 융합하고 채널 간 의미론적 관계를 기반으로 적절한 수용장을 동적으로 선택하는 효율적인 **Adaptive Receptive Field (ARF) Module**을 통해 스케일 변화 문제에 적응합니다. BARNet은 Cata7 및 EndoVis 2017 데이터셋에서 기존 최신 방법들을 크게 능가하는 분할 성능을 달성하며, 컴퓨터 보조 수술 분야의 발전에 크게 기여할 잠재력을 보여주었습니다.
