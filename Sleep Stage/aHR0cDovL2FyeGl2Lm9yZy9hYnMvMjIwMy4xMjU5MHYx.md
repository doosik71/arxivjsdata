# TransSleep: Transitioning-aware Attention-based Deep Neural Network for Sleep Staging

Jauen Phyo, Wonjun Ko, Eunjin Jeon, and Heung-Il Suk

## 🧩 Problem to Solve

자동 수면 단계 분류는 수면 건강 평가에 필수적이지만, 두 가지 핵심 문제에 직면해 있습니다. 첫째, 수면 신호 내의 **주요 파형(salient waveforms)을 효과적으로 포착**하는 것이 어렵습니다. 알파 리듬, 수면 방추(sleep spindle), K-복합체 등은 다양한 스펙트럼 및 시간적 특성을 가지며 에포크(epoch) 내 여러 위치에 분포할 수 있습니다. 기존의 단일 스케일 CNN 기반 방법은 이러한 복합적인 패턴을 완전히 포착하는 데 한계가 있습니다. 둘째, **전이 에포크(transitioning epochs)에서 혼란스러운 단계(confusing stages)를 정확하게 분류**하는 것이 어렵습니다. 수면 단계가 전환되는 에포크는 종종 여러 단계의 특성이 혼합되어 있어 분류기를 혼동시킬 수 있습니다. 기존의 은닉 마르코프 모델(HMM)이나 순환 신경망(RNN) 기반 컨텍스트 인코더는 잠재적 컨텍스트 정보를 학습하지만, 혼란스러운 단계를 명시적으로 식별하거나 전이 발생 여부를 직접적으로 파악하는 데는 부족합니다.

## ✨ Key Contributions

- **TransSleep 제안:** 에포크 내의 주요 특징(intra-epoch salient features)을 효과적으로 포착하고 에포크 간의 상황적 관계(inter-epoch contextual relationships)를 모델링하는 새로운 수면 단계 분류 딥러닝 네트워크인 TransSleep을 제안합니다.
- **두 가지 보조 작업 활용:** 수면 단계 분류 시 발생하는 전이 에포크 문제를 해결하기 위해 두 가지 새로운 보조 작업인 "에포크 수준 단계 분류(epoch-level stage classification)"와 "단계 전이 감지(stage-transition detection)"를 활용합니다.
- **최신 성능 달성:** 두 개의 공개 데이터셋(Sleep-EDF 및 MASS)에서 자동 수면 단계 분류 실험을 수행하여 제안하는 방법의 유효성을 입증하고 최신(state-of-the-art) 성능을 달성했습니다.
- **심층 분석:** 다양한 관점에서 제안하는 프레임워크를 분석하여 TransSleep의 이점을 탐색하고 그 유효성을 정성적, 정량적으로 입증했습니다.

## 📎 Related Works

- **기계 학습 기반 자동 수면 단계 분류:**
  - Tsinalis et al. [5], Alickovic et al. [6], Li et al. [7], Ghimatgar et al. [8] 등은 시간-주파수 특징을 수동으로 추출하거나, SVM, Random Forest, HMM과 같은 고전적인 기계 학습 알고리즘을 사용하여 수면 단계를 분류했습니다. Ghimatgar et al. [8]은 HMM을 사용하여 수면 단계 간의 전이를 학습했습니다.
- **딥러닝 기반 자동 수면 단계 분류:**
  - **특징 추출:** Supratak et al. [17], Seo et al. [19] 등은 단일 스케일 CNN을 사용하여 EEG의 스펙트로-시간적 특성을 학습했습니다. Eldele et al. [20], Qu et al. [10] 등은 다양한 필터 크기를 사용했지만, 여전히 단일 스케일 CNN의 최종 출력에 의존하여 멀티스케일 및 국소적으로 분포된 주요 특징을 완전히 포착하지 못하는 한계가 있었습니다.
  - **컨텍스트 모델링:** Supratak et al. [9], Phan et al. [18], Seo et al. [19] 등은 Bi-LSTM 또는 Bi-GRU와 같은 RNN 계열 모델을 사용하여 인접 에포크의 상황적 의존성을 모델링했습니다. Perslev et al. [22]는 U-Net [23] 기반의 temporal FCN을 제안했습니다. 이들 방법은 학습 가능한 은닉 상태 내에서 컨텍스트 정보를 임베딩했지만, 혼란스러운 단계를 명시적으로 학습하거나 전이 발생 여부를 직접적으로 판단하는 데는 초점을 맞추지 않았습니다.

## 🛠️ Methodology

TransSleep은 세 가지 주요 모듈과 두 가지 보조 작업으로 구성됩니다.

1. **AMF (Attention-based Multi-scale Feature Extractor):**

   - **Multi-scale Convolution Paths:** 각 에포크의 복잡한 스펙트로-시간적 특징을 추출하기 위해 멀티스케일 CNN [24] 구조를 활용합니다.
     - 두 개의 특징 포착 경로를 사용하며, 첫 번째 스펙트럴 컨볼루션 레이어에서 $f_s \times 2$와 $f_s / 2$의 다른 필터 크기를 사용하여 낮은 주파수(델타파)와 높은 주파수(알파파) 신호를 포착합니다.
     - 각 경로에는 3개의 분리 가능한 시간적 컨볼루션을 다양한 커널 크기로 적용하여 다양한 멀티스케일 시간적 경향을 학습합니다.
   - **ETA (Epoch-level Temporal Attention):** 멀티스케일 특징 표현 후, 에포크 내의 다양한 지점에서 나타나는 주요 파형을 강조하기 위해 에포크 수준 시간적 어텐션 모듈을 사용합니다.
     - 적응형 평균 풀링(adaptive average pooling, AAP)과 위치 인코딩이 포함된 멀티-헤드 셀프-어텐션(multi-head self-attention) 메커니즘 [25]을 적용하여 주요 특징에 집중합니다.
     - 두 경로에서 나온 어텐션 특징을 연결하여 최종 특징 벡터 $f_{\tau} \in \mathbb{R}^{F}$를 생성합니다.

2. **SCE (Stage-Confusion Estimator):**

   - AMF에서 추출된 에포크 수준 특징 표현 $f_{\tau}$를 입력으로 받습니다.
   - **보조 작업 1: 에포크 수준 단계 분류:** 전역 평균 풀링(Global Average Pooling, GAP) 및 FC 레이어 $g$를 사용하여 가능한 클래스 분포 $c_{\tau} = \text{softmax}(g(\text{GAP}(f_{\tau})))$를 계산합니다. 이 $c_{\tau}$는 "어떤 단계가 혼란스러운지"에 대한 정보를 내포합니다.
   - $c_{\tau}$를 FC 레이어 $q$와 시그모이드(sigmoid) 함수를 통해 어텐션 벡터 $a_{\tau} = \text{sigmoid}(q(c_{\tau}))$로 변환합니다.
   - 최종 에포크 특징 표현 $\tilde{f}_{\tau} = a_{\tau} \otimes f_{\tau}$ (하마르 연산)를 계산하여 단계 혼동 정보를 특징 벡터에 명시적으로 반영합니다.

3. **CE (Context Encoder):**
   - SCE에서 업데이트된 특징 시퀀스 $[\tilde{f}_{\tau}]_{N}^{\tau=1}$를 입력으로 받습니다.
   - Bi-LSTM 셀 [31]을 사용하여 인접 에포크 간의 시간적 의존성과 상황적 관계를 인코딩합니다.
   - **보조 작업 2: 단계 전이 감지:** Bi-LSTM의 은닉 상태를 기반으로 단계 전이 $\hat{y}^{(\text{t})}_{\tau}$를 예측합니다. 정답 전이 레이블 $y^{(\text{t})}_{\tau}$는 $y_{\tau-1} \neq y_{\tau}$ 또는 $y_{\tau} \neq y_{\tau+1}$인 경우 1, 그렇지 않으면 0으로 정의됩니다. 이 보조 작업은 전이 발생 여부에 대한 명시적인 정보를 제공합니다.
   - Bi-LSTM 출력에 원본 특징 $f_{\tau}$를 더하는 잔차 연결(residual connection)을 적용하여 더 풍부한 특징을 생성하고, 이를 기반으로 최종 수면 단계 $\hat{y}_{\tau}$를 예측합니다.

- **최적화:** 세 가지 학습 작업을 동시에 최적화합니다.
  - 주요 수면 단계 예측 작업에 대한 손실 $L^{(\text{c})}$: 클래스 가중 교차 엔트로피(WCE)와 클래스 가중 코사인 유사도(WCS)의 합.
  - 에포크 수준 단계 분류 보조 작업에 대한 손실 $L^{(\text{s})}$: WCE.
  - 단계 전이 감지 보조 작업에 대한 손실 $L^{(\text{t})}$: WCE.
  - 총 손실 함수: $L = L^{(\text{c})} + \lambda^{(\text{s})}L^{(\text{s})} + \lambda^{(\text{t})}L^{(\text{t})}$. Adam 옵티마이저 [35]를 사용하여 모델을 훈련합니다.

## 📊 Results

- **데이터셋:** Sleep-EDF 및 MASS 두 가지 공개 EEG 데이터셋을 사용했습니다.
  - Sleep-EDF: 20명, Fpz-Cz 채널, 100 Hz 샘플링.
  - MASS: 62명, F4-LER 채널, 100 Hz로 다운샘플링.
  - 모든 신호는 양자 정규화(quantile normalization) 및 0.5-49 Hz 대역 통과 필터링으로 전처리되었습니다.
- **평가 지표:** Macro-averaged F1-score (MF1) 및 Accuracy (ACC)를 사용했으며, 각 클래스별 F1-score도 보고했습니다.
- **성능 비교:**
  - **Sleep-EDF 데이터셋:** TransSleep은 MF1에서 81.7%를 달성하여 비교 대상 최신 방법들을 능가했으며, W 단계를 제외한 N1, N2, N3, REM 단계의 per-class F1-score에서도 가장 높은 점수를 기록했습니다. ACC는 두 번째로 높았습니다.
  - **MASS 데이터셋:** TransSleep은 ACC에서 87.4%, MF1에서 82.6%를 달성하여 최신 방법 중 가장 높은 성능을 보였고, W, N1, N2 단계의 per-class F1-score에서도 최고 점수를 기록했습니다.
- **주요 결과:** 특히, 시각적으로 구별하기 어렵고 데이터 불균형이 심한 N1 및 임상적으로 중요한 REM 단계에서 다른 기준선 모델에 비해 상당한 개선을 보여주었습니다. 이는 제안하는 방법이 소수 클래스에 편향되지 않고 혼란스러운 단계를 효과적으로 식별할 수 있음을 의미합니다.

## 🧠 Insights & Discussion

- **제안된 구성 요소의 유효성 (Ablation Experiments):**
  - **ETA 모듈의 효과:** ETA(Epoch-level Temporal Attention) 모듈을 포함한 Case II가 ETA가 없는 Case I보다 성능이 향상되어, ETA가 에포크 내 국소적으로 분포된 주요 파형을 포착하여 특징 표현을 개선함을 확인했습니다.
  - **에포크 수준 단계 분류 보조 작업의 효과:** 에포크 수준 단계 분류 보조 작업을 추가한 Case III가 Case II보다 성능이 향상되어, SCE가 혼란스러운 단계에 대한 정보를 명시적으로 제공함으로써 인접 에포크 간의 상황적 관계 모델링을 풍부하게 함을 입증했습니다.
  - **단계 전이 감지 보조 작업의 효과:** 단계 전이 감지 보조 작업까지 모두 포함한 TransSleep이 Case III보다 성능이 더 향상되어, 단계 전이 정보를 명시적으로 감지하는 것이 컨텍스트 정보를 효과적으로 표현하는 데 도움이 됨을 보여주었습니다.
  - 전반적으로 TransSleep의 모든 구성 요소와 보조 작업이 주요 패턴 및 상황적 관계의 표현을 크게 개선하며, 전체 모델이 모든 제거 실험 사례보다 우수했습니다.
- **혼동 행렬 분석:** TransSleep의 혼동 행렬은 전이 구간에서 인접 단계의 오분류가 상대적으로 감소하고 올바른 분류가 증가했음을 보여주었습니다.
- **단계 전이 감지 학습 검증:** 단계 전이 감지 보조 작업의 손실 곡선이 훈련 및 검증 모두에서 수렴하는 것을 관찰하여, 컨텍스트 인코더가 전이 정보를 효율적으로 학습함을 확인했습니다.
- **수면 기록도 (Hypnogram) 분석:** 예측된 수면 기록도가 실제 기록도와 유사하여 TransSleep이 수면 단계를 효과적으로 분류함을 시각적으로 입증했습니다.
- **전이 에포크 분류 능력:** 전이 에포크(transitioning epochs)에서 TransSleep이 Case II보다 오분류율을 더 크게 감소(2.1% 감소 vs 비전이 에포크 0.9% 감소)시켜, TransSleep이 전이 에포크를 효과적으로 분류하는 "전이 인식" 모델임을 정량적으로 보여주었습니다.
- **제한 사항 및 향후 연구:** TransSleep은 유망하지만, 계층적 분류기를 통해 혼란스러운 단계를 더 잘 분류하고, 건강 정보학 관점에서 의사 결정 과정의 해석 가능성을 높이는 연구가 필요합니다.

## 📌 TL;DR

수면 단계 자동 분류는 수면 신호의 중요한 파형을 포착하고 전이 구간의 혼란스러운 단계를 정확히 분류하는 데 어려움을 겪습니다. 이 문제를 해결하기 위해 **TransSleep**은 에포크 내 멀티스케일 특징을 효과적으로 추출하는 어텐션 기반 모듈(AMF)과, 두 가지 새로운 보조 작업인 "에포크 수준 단계 분류" 및 "단계 전이 감지"를 활용하여 혼란스러운 단계 및 전이 정보를 명시적으로 학습합니다. 이를 통해 **Sleep-EDF 및 MASS 데이터셋에서 최신 성능을 달성**했으며, 특히 N1 및 REM과 같은 혼란스러운 단계와 전이 에포크 분류에서 상당한 개선을 보이며 **"전이 인식" 능력을 입증**했습니다.
