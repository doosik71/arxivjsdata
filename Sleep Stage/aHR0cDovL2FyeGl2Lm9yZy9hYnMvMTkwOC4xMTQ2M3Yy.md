# Sleep Staging from Electrocardiography and Respiration with Deep Learning

Haoqi Sun, PhD, Wolfgang Ganglberger, MSc, Ezhil Panneerselvam, MD, Michael J. Leone, MSc, Syed A. Quadri, MD, Balaji Goparaju, MSc, Ryan A. Tesh, BS, Oluwaseun Akeju, MD, Robert J. Thomas, MD, M. Brandon Westover, MD, PhD

## 🧩 Problem to Solve

수면 단계 분류(Sleep staging)는 주로 뇌전도(EEG), 안구전도(EOG), 턱 근전도(EMG) 분석에 의존합니다. 하지만 이러한 방법은 중환자나 웨어러블 장치와 같은 특정 환경에서 적용하기 어렵거나 비실용적일 수 있습니다. 이 연구의 목표는 심전도(ECG) 및 호흡 신호와 같은 비-EEG 신호를 사용하여 수면 단계를 정확하게 분류할 수 있는지 가설을 세우고 검증하는 것입니다. 이는 자율신경계 활동이 수면 동안의 피질 활동과 연계되어 나타나기 때문입니다.

## ✨ Key Contributions

- **ECG 및 호흡 신호의 중요성 입증:** 대규모 인구 집단에서 ECG 및 호흡 노력이 수면 단계에 대한 상당한 정보를 제공한다는 것을 검증했습니다.
- **딥러닝 기반 수면 단계 분류 모델 개발:** ECG 및 호흡 신호를 사용하여 수면 단계를 정확하게 분류하는 딥 신경망을 개발했습니다.
- **최적의 신호 조합 발견:** ECG와 복부 호흡 노력(abdominal respiratory effort)의 조합이 5가지 수면 단계 분류에서 Cohen's kappa($ \kappa $) 0.600, 3가지 수면 상위 단계(W vs. NREM vs. REM) 분류에서 $ \kappa $ 0.762로 가장 우수한 성능을 달성했습니다.
- **다양한 인구 집단에 대한 견고성 확인:** 모델의 수면 단계 분류 성능은 연령 및 수면 무호흡-저호흡 지수(Apnea-Hypopnea Index, AHI)에 따라 일부 차이를 보였으나, 일반적으로 사용되는 외래 약물 복용 여부와 관계없이 광범위한 수면 장애(수면 무호흡증, 주기성 사지 운동 장애)에 대해 견고함을 보여주었습니다.
- **새로운 연구 및 응용 가능성 제시:** EEG를 쉽게 사용할 수 없거나 적용하기 어려운 환경(예: 중환자실, 웨어러블 기기)에서 수면 연구 및 응용 분야에 새로운 가능성을 열었습니다.

## 📎 Related Works

이 연구는 수면을 특징화하기 위해 주로 EEG, EOG, EMG 분석에 의존해온 기존 방식($ ^{1} $Silber et al., 2007)을 언급합니다. 또한, EEG 신호를 이용한 딥 신경망 기반 수면 단계 분류 연구($ ^{17} $Biswal et al., 2018)를 자사의 이전 연구로 제시하며, 이는 인간 전문가의 성능과 유사한 수준임을 보여주었습니다.
비-EEG 신호를 이용한 수면 단계 분류에 대한 이전 연구들도 참조되었는데, 이들은 주로 PPG, 혈액 산소 포화도, 호흡 노력, 무선 주파수 신호, 심박수 등을 사용했습니다. 하지만 이 연구는 이전 연구들이 표본 크기가 작고 일반화 가능성이 제한적이었다는 점을 강조하며($ ^{12} $Sady et al., 2013; $ ^{22} $Long et al., 2014; $ ^{23} $Fonseca et al., 2015; $ ^{24} $Zhao et al., 2017; $ ^{25} $Zhang et al., 2017; $ ^{26} $Radha et al., 2018), 본 연구의 대규모 데이터셋이 제공하는 견고하고 일반화 가능한 결과를 차별점으로 제시합니다.

## 🛠️ Methodology

- **데이터셋:** 2009년부터 2016년까지 Massachusetts General Hospital의 수면 연구실에서 수집된 8,682개의 수면다원검사(PSG) 데이터셋을 사용했습니다. 각 PSG에는 1개의 ECG 채널과 흉부 및 복부 벨트에서 기록된 2개의 호흡 노력 채널이 포함되며, 모든 신호는 200 Hz로 샘플링되었습니다. 수면 단계는 AASM(American Academy of Sleep Medicine) 표준에 따라 30초 단위의 겹치지 않는 에포크로 W, N1, N2, N3, REM 5단계로 주석이 달렸습니다.
- **전처리:**
  - 중앙 30초 에포크의 수면 단계를 분류하기 위해 전후 120초의 정보를 포함하는 총 270초($ = $ 4.5분, 9개의 30초 에포크)의 확장된 에포크를 사용했습니다.
  - **ECG:** R-피크 타이밍을 추출하고, R-피크가 '1'이고 다른 모든 지점이 '0'인 이진 시퀀스로 변환했습니다. 생리학적으로 불가능한 진폭( $ > $ 6mV) 또는 표준 편차( $ < $ 5$\mu$V)를 가진 에포크 및 ADARRI($ ^{19} $Rebergen et al., 2018) 방법으로 식별된 잘못된 R-피크가 있는 에포크는 아티팩트로 처리했습니다.
  - **호흡 신호(흉부/복부):** 10Hz로 다운샘플링했습니다. 생리학적으로 불가능한 진폭( $ > $ 6mV) 또는 표준 편차( $ < $ 10$\mu$V)를 가진 에포크는 아티팩트로 처리했습니다.
  - CNN 훈련 시에는 아티팩트 에포크를 제거했지만, LSTM 훈련 시에는 시간적 문맥을 보존하기 위해 아티팩트 에포크를 유지했습니다.
- **딥 신경망 아키텍처:**
  - 다음 입력 신호 및 조합에 기반한 5개의 딥 신경망을 훈련했습니다: 1) ECG, 2) CHEST (흉부 호흡 노력), 3) ABD (복부 호흡 노력), 4) ECG+CHEST, 5) ECG+ABD.
  - 각 네트워크는 에포크별 특징을 학습하는 순방향 합성곱 신경망(CNN)과 연속적인 에포크 간의 시간적 패턴을 학습하는 장단기 기억(LSTM) 순환 신경망(RNN)으로 구성됩니다.
  - **CNN:** 합성곱 계층, 여러 잔차 블록(residual block) 및 최종 출력 블록으로 구성됩니다. 다중 신호 입력의 경우, 단일 신호 네트워크에서 훈련된 초기 계층의 가중치를 고정하고 출력을 연결한 후 하위 네트워크에 입력합니다.
  - **LSTM:** 양방향 LSTM을 사용하며, 문맥 셀을 순방향 및 역방향에서 연결합니다. LSTM 계층 수, 은닉 노드 수, 드롭아웃 비율은 검증 세트에서 목적 함수를 최소화하도록 최적화했습니다.
- **훈련 및 평가:**
  - PSG를 훈련(6,682개), 검증(1,000개), 테스트(1,000개) 세트로 무작위 분할했습니다.
  - CNN을 먼저 훈련한 후, CNN의 출력을 사용하여 LSTM을 훈련했습니다.
  - 목적 함수로는 교차 엔트로피(cross-entropy)를 사용했으며, 클래스 불균형을 해결하기 위해 각 수면 단계의 에포크 수의 역수로 가중치를 부여했습니다.
  - 성능 지표로 혼동 행렬(confusion matrix)과 Cohen's kappa($ \kappa $)를 사용했습니다. 5가지 AASM 수면 단계(W, N1, N2, N3, R)와 두 가지 방식의 3가지 수면 상위 단계 (W+N1 vs. N2+N3 vs. R; W vs. N1+N2+N3 vs. R)에 대해 성능을 평가했습니다.

## 📊 Results

- **전반적인 수면 단계 분류 성능:**
  - ECG와 복부 호흡 노력(ABD)을 함께 입력 신호로 사용했을 때 테스트 세트에서 가장 좋은 예측 결과를 보였습니다.
  - 5가지 수면 단계 분류에서 Cohen's kappa($ \kappa $)는 0.600(95% CI 0.599 – 0.602)이었습니다.
  - "각성(W) vs. 비렘 수면(NREM) vs. 렘 수면(REM)"의 3가지 수면 상위 단계 분류에서는 $ \kappa $가 0.762(0.760 – 0.763)였습니다.
  - 개별 5단계 분류 정확도: 각성(W) 81.8%, N1 55.8%, N2 66.3%, N3 66.6%, REM 92.2%.
  - 주요 오분류는 W vs. N1, N1 vs. N2, N2 vs. N3 단계 사이에서 발생했습니다.
- **입력 신호 비교:** ECG+ABD 조합이 모든 분류 방식에서 가장 높은 $ \kappa $ 값을 달성했으며, 복부 호흡 노력(ABD) 단독이 흉부 호흡 노력(CHEST) 단독보다 성능이 우수했습니다.
- **다양한 인구 집단에 대한 성능:**
  - ECG+ABD를 사용했을 때, 고령( $ \ge $ 60세) 참가자와 AHI가 높은 참가자에서 $ \kappa $ 값이 낮아졌습니다.
  - 심한 무호흡증(AHI $ \ge $ 30)의 경우에도 5단계 분류에서 $ \kappa $ 0.574, 3가지 상위 단계 분류에서 $ > $ 0.7의 성능을 유지했습니다.
  - 다양한 외래 약물(항우울제, 벤조디아제핀 등) 복용 여부에 관계없이 견고한 성능을 보였습니다.
- **R-피크 타이밍 정밀도 의존성:** ECG R-피크에 가우시안 지터(Gaussian jitter)를 추가했을 때, 지터의 표준 편차가 증가함에 따라 성능이 점진적으로 저하되어 R-피크 타이밍의 정밀도에 대한 민감성을 나타냈습니다.

## 🧠 Insights & Discussion

- **EEG의 한계를 넘어선 가능성:** ECG와 호흡 신호가 수면 단계에 대한 상당한 정보를 제공한다는 것이 입증되어, EEG를 사용하기 어려운 ICU나 일반 병원 환경, 웨어러블 기기 등에서 수면 추적을 간소화할 수 있는 가능성을 열었습니다.
- **생물학적 의미:** 특정 수면 단계를 상위 단계로 통합했을 때 분류 성능이 향상되는 것은 수면 상태의 진정한 생물학적 정보가 반영될 수 있음을 시사합니다. 예를 들어, N1은 불안정한 전환 상태이며 N2와 N3는 유사한 심폐 특성을 가질 수 있습니다.
- **연령 및 수면 무호흡증의 영향:** 고령 및 AHI 증가에 따른 성능 저하는 이러한 집단에서 수면의 자율신경계 특징이 변화하거나, EEG 기반의 AASM 표준과 자율신경계 변동 간의 불일치에서 비롯될 수 있습니다.
- **한계점:**
  1. 데이터셋이 성인에만 국한되어 소아 그룹에 대한 일반화는 추가 연구가 필요합니다.
  2. 30초 에포크 기반 스코어링은 수면 파편화(sleep fragmentation)와 같은 미세한 수면 단계 분석에 한계가 있습니다.
  3. 딥 신경망의 '블랙박스' 특성으로 인해 네트워크가 어떤 핵심 특징을 학습했는지에 대한 통찰력이 제한적입니다.
  4. 대규모 데이터셋에서는 일반적이지만, 단일 훈련-검증-테스트 분할(1-fold validation) 방식은 교차 검증(cross-validation)에 비해 편향될 수 있습니다.

## 📌 TL;DR

- **문제:** 기존 EEG 기반 수면 단계 분류는 번거롭고 특정 환경에서 적용이 어렵습니다.
- **방법:** 8,682개의 대규모 PSG 데이터셋을 활용하여 ECG 및 호흡 신호(흉부, 복부)를 입력으로 하는 CNN-LSTM 기반 딥 신경망 모델 5가지를 훈련하고 수면 단계를 분류했습니다.
- **결과:** ECG와 복부 호흡 신호를 함께 사용했을 때 5가지 수면 단계($ \kappa $ = 0.600) 및 3가지 상위 수면 단계($ \kappa $ = 0.762) 분류에서 가장 우수한 성능을 보였습니다. 이는 비-EEG 신호만으로도 수면 단계에 대한 충분한 정보를 제공하며, 다양한 환자군에 대해 견고한 성능을 유지함을 입증했습니다. 이 연구는 EEG 사용이 어려운 환경에서 수면 모니터링 및 연구에 새로운 길을 열었습니다.
