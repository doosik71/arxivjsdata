# SLEEP-WAKE CLASSIFICATION VIA QUANTIFYING HEART RATE VARIABILITY BY CONVOLUTIONAL NEURAL NETWORK

JOHN MALIK, YU-LUN LO, HAU-TIENG WU

## 🧩 Problem to Solve

수면은 전반적인 건강에 필수적이지만, 수면 방해는 심각한 건강 문제로 이어질 수 있습니다. 현재 수면 역학을 정량화하는 '골드 스탠다드'인 수면다원검사(PSG)는 설치가 복잡하고, 노동 집약적이며, 비용이 많이 들고 오류 발생 가능성도 있습니다. 따라서 이 연구는 심전도(ECG) 및 광혈류측정법(PPG) 신호와 같은 비침습적인 생체 신호를 활용하여 수면/각성 상태를 자동으로, 편리하게, 그리고 정확하게 분류하는 효율적이고 확장 가능한 방법을 개발하는 것을 목표로 합니다. 이는 웨어러블 및 모바일 헬스 기기를 통한 수면 모니터링의 필요성에 부응하고, 기존 심박변이도(HRV) 분석 방법론의 한계를 극복하고자 합니다.

## ✨ Key Contributions

- **CNN 기반 HRV 정량화:** 순간 심박수(IHR) 시계열 데이터에서 수면/각성 상태를 분류하기 위해 1차원 컨볼루션 신경망(CNN) 모델을 제안했습니다. 이 모델은 IHR 변동성과 그 시간적 위치를 적응적으로 정량화합니다.
- **비침습적이고 확장 가능한 방법:** PSG를 대체하는 비침습적 심박수 모니터링을 통해 생리적 상태 변화를 인식하는 효과적이고 확장 가능한 방법을 제시합니다.
- **다양한 데이터셋에 대한 일반화:** 자체 데이터셋(CGMH) 외에, 인종 및 수면 무호흡증 심각도가 다른 두 개의 공개 데이터셋(DREAMS, UCDSADB)에서 모델의 일반화 성능을 검증했습니다.
- **PPG 신호와의 호환성 확인:** ECG에서 추출한 IHR 시계열뿐만 아니라, PPG에서 추출한 IHR-PPG 시계열에서도 유사한 분류 성능을 달성하여 모바일 장치 적용 가능성을 입증했습니다.
- **모델 견고성 입증:** 다양한 입력 크기와 다른 데이터셋으로 학습된 모델 간의 교차 검증을 통해 모델의 견고성을 확인했습니다. 특히, 수면 무호흡증 환자 데이터로 학습된 모델이 일반인 데이터에 잘 일반화되는 비대칭적 결과를 발견했습니다.
- **CNN 특징 시각화:** 학습된 CNN 모델이 IHR 시계열에서 각성 및 수면 상태와 관련된 HRV 변동의 형태학적 특징을 어떻게 포착하는지 시각화하여 모델의 내부 작동에 대한 통찰을 제공했습니다.

## 📎 Related Works

- **기존 수면 평가 방법의 한계:** 수면 역학을 정량화하는 '골드 스탠다드'인 수면다원검사(PSG)의 복잡성, 노동 집약성, 비용 문제가 지적됩니다. 뇌전도(EEG), 광혈류측정법(PPG), 심전도(ECG) 등 다른 비침습적 생체 신호가 대안으로 연구되어 왔습니다.
- **심박변이도(HRV) 연구:** HRV는 심장 박동 간 간격(RRI) 시계열을 분석하여 자율신경계(ANS) 활동을 반영하며, 수면 [41, 52, 42, 46, 44, 4, 12, 7, 36]을 포함한 다양한 생리 시스템을 이해하는 데 광범위하게 연구되어 왔습니다 [3, 45, 40].
- **HRV 기반 수면 분류의 선행 연구:** HRV를 활용하여 수면 단계를 분류하려는 여러 연구가 있었습니다 [25, 31, 28, 49, 2, 51, 47]. 이들은 일반적으로 수동으로 설계된 특징과 다양한 분류 알고리즘(예: 랜덤 포레스트, 은닉 마르코프 모델, 다층 퍼셉트론)을 사용했습니다.
- **신경망 활용 연구:** 일부 연구에서는 신경망과 수동으로 설계된 심박수 특징을 사용하여 수면 단계를 예측했지만 [26, 2], CNN을 이 분야에 직접적으로 적용한 연구는 저자들이 아는 한 이전에 없었습니다.
- **관련된 분류 성능 비교:** 예를 들어, [49]는 랜덤 포레스트로 각성/REM/비REM을 분류하여 각성 단계에서 51.2%의 민감도와 90.2%의 특이도를 보고했으며, [2]는 피드포워드 신경망을 사용하여 각성/수면 분류에서 71.9%의 정확도와 0.29의 카파 계수를 보고했습니다.

## 🛠️ Methodology

1. **데이터 수집 및 전처리:**
   - **데이터셋:** 56명의 건강한 피험자로 구성된 내부 학습 데이터셋(CGMH-training), 27명의 건강한 피험자 검증 데이터셋(CGMH-validation), 20명의 건강한 피험자로 구성된 공개 DREAMS Subjects Database (다른 인종 고려), 25명의 다양한 수면 무호흡증 심각도를 가진 피험자 데이터셋(UCDSADB)이 사용되었습니다.
   - **신호:** 200Hz (CGMH, DREAMS) 또는 128Hz (UCDSADB)로 샘플링된 ECG 및 PPG 기록.
   - **순간 심박수(IHR) 추출:** 표준 R 피크 감지 알고리즘을 사용하여 ECG (또는 PPG)에서 R 피크를 검출한 후, IHR($r_i$) = $60 / (r_i - r_{i-1})$ (bpm) 공식으로 IHR을 계산합니다. 모양 보존 조각별 3차 보간법을 통해 4Hz로 IHR 시계열을 생성합니다.
   - **에포크 분할:** 수면 전문가가 지정한 경계에 따라 IHR (또는 IHR-PPG) 신호를 30초 단위의 에포크로 분할하며, 에포크당 5개 미만의 R 피크가 감지되면 해당 에포크는 폐기됩니다.
   - **입력 신호 구성:** 각 30초 에포크를 예측하기 위해, 해당 에포크와 이전 4분 30초 데이터를 연결하여 총 5분 길이의 입력 신호를 구성합니다. 각 5분 입력 신호는 중앙값을 빼서 정규화됩니다.
2. **CNN 모델 아키텍처:**
   - **1차원 CNN:** TensorFlow 1.5를 사용하여 구현된 피드-포워드 네트워크 아키텍처입니다.
   - **컨볼루션 블록:** 입력 신호는 5개의 컨볼루션 블록을 통과합니다. 각 블록은 10개의 필터(커널 크기 8)를 가진 컨볼루션 계층과 정류 선형 단위(ReLU) 활성화 함수로 구성됩니다. 각 블록의 출력은 입력 크기의 절반이 됩니다.
   - **완전 연결 계층:** 컨볼루션 블록 뒤에는 각각 20개의 노드를 가진 두 개의 완전 연결(Dense) 계층이 이어집니다. 이 노드들 또한 바이어스와 ReLU 활성화 함수를 가집니다. 마지막 컨볼루션 계층과 두 완전 연결 계층에는 0.5 확률의 드롭아웃이 적용됩니다.
   - **출력 계층:** 마지막 완전 연결 계층의 출력은 2개 노드의 출력 계층("각성" 및 "수면")으로 전달되며, 소프트맥스 함수를 사용하여 정규화됩니다. "각성" 노드의 출력이 "수면" 노드의 출력보다 크거나 같으면 해당 에포크를 "각성"으로 예측합니다.
3. **학습:**
   - **에포크:** 180 에포크 동안 학습을 진행합니다.
   - **옵티마이저:** 미니 배치 경사 하강법을 사용합니다.
   - **학습률:** $10^{-3}$.
   - **배치 크기:** 24.
   - **손실 함수:** 교차 엔트로피를 손실 함수로 사용합니다.
4. **성능 평가:**
   - **측정 지표:** 민감도(recall), 특이도, 정확도, AUC (ROC 곡선 아래 면적), 정밀도(PPV), F1 점수, 코헨의 카파 계수를 보고합니다.
   - **평가 방식:** 모델 평가는 피험자 간(inter-individual) 기준으로 수행되었습니다.
   - **모니터링 장치 간 전이 능력:** ECG에서 학습된 모델을 PPG 데이터에 적용하거나 그 반대로 적용하여 다른 장치 간의 성능을 비교했습니다.
   - **견고성 검사:** 30초, 2분, 10분 등 다양한 입력 크기로 모델 성능 변화를 분석하고, DREAMS Subjects Database 및 UCDSADB로 모델을 학습시킨 후 세 가지 검증 데이터셋에 적용하여 교차 데이터베이스 견고성을 평가했습니다.

## 📊 Results

- **CGMH-validation (내부 데이터):** 각성 단계 예측에 대한 정확도 83.1%, 민감도 52.4%, 특이도 89.4%, AUC 0.83, F1 점수 0.51, 코헨의 카파 계수 0.41을 달성했습니다. '각성' 클래스의 불균형으로 인해 F1 및 정밀도가 상대적으로 낮게 나타났으며, '각성' 레이블 비율이 높을수록 F1 및 정밀도 점수가 선형적으로 향상되는 경향을 보였습니다. ($F1 = 0.32 + 0.0086w$, $precision = 40.16 + 1.03w$)
- **DREAMS Subjects Database (외부, 건강한 피험자):** AUC 0.81로, CGMH-validation과 유사한 성능을 보였습니다. 이는 모델이 다른 인종의 건강한 피험자 데이터에 대해서도 잘 일반화됨을 시사합니다.
- **UCDSADB (외부, 수면 무호흡증 피험자):** AUC 0.72로, 다른 데이터베이스에 비해 성능이 유의미하게 낮았습니다. 수면 무호흡증 지수(AHI)가 높을수록 모델의 AUC 및 카파 계수가 감소하는 경향을 보여($\text{AUC} = 0.8 - 0.0034 \cdot \text{AHI}$, $\text{Kappa} = 0.34 - 0.0047 \cdot \text{AHI}$) 수면 무호흡증으로 인한 생리적 변화가 모델 성능에 영향을 미침을 확인했습니다.
- **모니터링 장치 간 전이 능력:** ECG에서 학습된 모델을 PPG 기반 IHR-PPG 시계열에 적용했을 때 성능이 약간 저하되었으나, IHR-PPG 시계열로 학습하고 IHR-PPG로 검증한 모델의 성능은 IHR 기반 모델과 유사하거나 약간 더 좋았습니다 (AUC 0.84 대 0.83).
- **입력 크기 민감도 분석:** 5분 길이의 입력 신호를 사용했을 때 30초 입력보다 검증 AUC가 크게 향상되었습니다 (0.75에서 0.83으로). 그러나 10분 입력은 5분 입력 대비 유의미한 추가 개선을 제공하지 않아, 계산 효율성과 분류 성능 간의 절충점을 시사합니다.
- **교차 데이터베이스 견고성:** UCDSADB (수면 무호흡증 피험자)로 학습된 모델은 CGMH-validation 및 DREAMS Database에서 합리적인 성능을 보였습니다 (AUC 0.75, 0.75). 이는 CNN이 정상 및 비정상 피험자 모두의 특징을 학습할 수 있음을 나타냅니다. 반대로, DREAMS Database로 학습된 모델은 UCDSADB에서 성능이 좋지 않았습니다 (AUC 0.67).
- **REM vs. 비REM 분류 (부록):** CNN 모델은 REM 대 비REM 분류에서도 높은 AUC 0.89 (CGMH-validation)를 달성하여 기존 연구보다 우수함을 시사했습니다.

## 🧠 Insights & Discussion

- **CNN의 HRV 분석 우수성:** 전통적인 HRV 분석이 비정상성 및 '불확실성 원리' 문제에 직면하는 것과 달리, CNN은 입력의 변환에 대해 'equivariance' 특성을 가지므로 HRV 변동의 존재뿐만 아니라 시간적 위치까지 감지할 수 있습니다. 이는 각성 상태와 관련된 교감 신경계의 활성 변화를 포착하는 데 효과적입니다.
- **입력 윈도우 크기의 중요성:** 충분히 긴 윈도우(예: 5분)는 IHR 시계열 내의 시간 가변적 변동을 포착하고 기준선 보정(baseline calibration)과 같은 생리학적 맥락을 제공하는 데 필수적입니다.
- **다양한 생리적 조건에서의 일반화:** 수면 무호흡증 환자 데이터(UCDSADB)로 학습된 모델이 건강한 피험자 데이터에 잘 일반화되는 결과는, CNN 프레임워크가 정상 및 비정상 피험자 모두의 특징을 학습할 만큼 충분한 용량을 가지고 있음을 시사합니다. 이는 CNN의 강력한 특징 학습 능력을 강조합니다.
- **PPG 신호의 잠재적 장점:** IHR-PPG 기반 모델의 성능이 IHR 기반 모델과 비슷하거나 약간 더 우수했던 것은, PPG 신호가 움직임에 더 민감하여 각성 상태와 관련된 왜곡을 포착하거나, 혈압 및 혈역학 정보(예: 맥파 전달 시간, PTT)를 추가적으로 포함하기 때문일 수 있습니다.
- **CNN의 '블랙박스' 문제:** CNN 모델은 그 효과가 입증되었음에도 불구하고, 내부 작동 방식에 대한 이론적 이해는 제한적입니다. 재학습 시 다른 로컬 최적점에 수렴하여 다른 특징 세트가 생성될 수 있다는 점은 명시적인 재현성 부족이라는 한계로 작용합니다.
- **한계점 및 향후 연구:**
  - **클래스 불균형:** '각성' 클래스의 수가 적어 훈련을 어렵게 하고 성능(특히 민감도)을 왜곡시킬 수 있습니다.
  - **데이터셋 규모 및 다양성:** 더 큰 고품질 데이터셋을 통해 피험자 및 데이터셋 간의 생리적 변이성을 더 잘 수용하도록 모델을 튜닝할 수 있습니다.
  - **정보 손실:** IHR/IHR-PPG는 원시 ECG/PPG 신호의 '차원 축소' 버전이므로, 호흡 정보, 혈압 정보 등 추가 정보를 활용하면 성능 향상이 가능할 수 있습니다.
  - **알고리즘 복잡성:** 현재의 CNN 아키텍처는 상대적으로 단순하며, 순환 신경망(RNN, LSTM)과 같은 구조를 도입하여 시퀀스 데이터를 더 효과적으로 활용할 수 있습니다.
- **임상적 중요성:** 각성 상태를 정확하게 평가하는 것은 수면 무호흡증 선별에 중요하며, 모델은 가정용 Class IV 장비를 사용한 수면 무호흡증 선별 문제에 적용될 수 있습니다.

## 📌 TL;DR

이 연구는 비침습적 수면 모니터링을 위해 ECG 또는 PPG에서 추출한 순간 심박수(IHR) 시계열을 기반으로 수면/각성 상태를 분류하는 1차원 컨볼루션 신경망(CNN) 모델을 제안합니다. CNN은 IHR 변동성과 그 시간적 위치를 효과적으로 학습하며, 자체 및 공용 데이터셋에서 각성 상태 예측에 대한 83.1%의 정확도와 0.83의 AUC를 달성하며 견고한 성능을 입증했습니다. 특히, PPG 신호에서도 유사한 성능을 보여 모바일 헬스 기기 적용 가능성을 높였고, 수면 무호흡증 환자 데이터로 학습된 모델이 일반인에게도 잘 일반화되는 등 CNN의 뛰어난 특징 학습 능력을 보여주었습니다.
