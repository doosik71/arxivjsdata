# Joint Classification and Prediction CNN Framework for Automatic Sleep Stage Classification

Huy Phan, Fernando Andreotti, Navin Cooray, Oliver Y. Chén, and Maarten De Vos

## 🧩 Problem to Solve

수면 단계의 정확한 식별은 수면 장애 진단 및 치료에 중요하지만, 기존의 수작업 방식은 번거롭고 시간이 많이 소요되며 주관적인 오류에 취약합니다. 자동 수면 단계 분류는 이 과정을 효율적으로 만들 수 있습니다.

기존 딥러닝 기반 자동 수면 단계 분류 방식은 주로 두 가지 문제가 있습니다:

1. **"Many-to-one" 접근 방식의 모델링 모호성**: 여러 에포크(contextual input)를 입력으로 받아 중앙 에포크의 레이블을 분류하는 방식은 네트워크가 실제로 어떤 에포크의 특징을 모델링하는지 불분명하게 만듭니다. (예: 좌우 이웃 에포크 레이블과의 정확도 차이가 크지 않음)
2. **계산 복잡성 증가**: 여러 에포크를 입력으로 사용하면 입력 크기가 커져 네트워크의 계산 복잡성이 선형적으로 증가합니다.

이 논문은 이러한 기존 방식의 단점을 극복하고 수면 에포크 간의 강한 의존성을 활용하여 정확하고 효율적인 자동 수면 단계 분류를 목표로 합니다.

## ✨ Key Contributions

- **새로운 문제 정식화**: 자동 수면 단계 분류를 **공동 분류 및 예측(joint classification and prediction)** 문제로 정식화했습니다. 이는 단일 입력 에포크에 대해 해당 에포크의 레이블을 분류하고 동시에 인접 에포크의 레이블을 예측하는 "one-to-many" 접근 방식입니다.
- **Multi-task CNN 프레임워크 제안**: 공동 분류 및 예측 작업을 수행하기 위한 간단하고 효율적인 CNN 아키텍처를 제안합니다. 이 아키텍처는 `1-max CNN`이라고 불리며, 멀티태스크 소프트맥스 레이어와 멀티태스크 손실 함수를 포함합니다.
- **앙상블 의사결정 활용**: 단일 모델 내에서 여러 결정을 생성할 수 있는 능력을 강조하며, 이 여러 결정(앙상블)을 통합하기 위한 **확률적 집계(probabilistic aggregation)** 방법(덧셈 및 곱셈 투표)을 제안합니다.
- **성능 우수성 입증**: Sleep-EDF(20명) 및 MASS(200명) 두 가지 공개 데이터셋에 대한 실험을 통해 제안된 프레임워크가 기존 분류 방식(one-to-one, many-to-one) 및 최신 딥러닝 접근 방식보다 우수한 성능을 보임을 입증했습니다.
- **계산 효율성**: 기존 "many-to-one" 방식에 비해 계산 오버헤드가 적으면서도 높은 성능을 달성합니다.

## 📎 Related Works

- **전통적인 수면 단계 분류**: 수작업 특징 추출(시간, 주파수, 비선형 도메인 특징)과 SVM, k-NN, Random Forests와 같은 전통적인 머신러닝 알고리즘 활용.
- **딥러닝 기반 수면 단계 분류**:
  - **CNN**: 자동 특징 학습의 강력한 기능으로, 가중치 공유 메커니즘을 통해 모델 복잡도를 줄이고 일반화 성능을 향상시킵니다 [18]-[20].
  - **RNN (LSTM)**: 수면 단계 전환의 장기적인 시퀀스 모델링에 효율적이며, CNN [17], [22] 또는 DNN [23]과 함께 사용되거나 단독으로 활용되기도 합니다 [25], [30], [31].
  - **기타 네트워크**: DBNs [28], Auto-encoder [21], DNNs [23] 등.
- **컨텍스트 입력 활용**: 연속적인 수면 에포크 간의 의존성을 활용하기 위해 대상 에포크 주변의 에포크를 입력으로 사용하는 "many-to-one" 분류 방식 [17], [18], [20], [22].
- **앙상블 학습**: 여러 모델을 결합하여 성능을 향상시키는 방법 [39], [40], 기존 방법 [6], [13], [41] 및 딥러닝 [17]에서 활용되었습니다.

## 🛠️ Methodology

제안된 프레임워크는 크게 세 단계로 구성됩니다: 신호 전처리, Multi-task CNN, 그리고 의사결정 집계입니다.

1. **시간-주파수 이미지 표현 (Time-Frequency Image Representation)**

   - **로그-파워 스펙트럼 변환**: 30초 길이의 원시 신호 에포크(EEG, EOG, EMG)를 STFT(Short-Time Fourier Transform)를 사용하여 파워 스펙트럼으로 변환한 후 로그 스케일로 변환하여 $F \times T$ 크기의 로그-파워 스펙트럼 이미지(여기서 $F=129$, $T=29$)를 생성합니다.
   - **주파수 필터 뱅크**: DNN으로 사전 학습된 주파수 도메인 필터 뱅크를 적용하여 주파수 평활화 및 차원 축소를 수행합니다. 이는 스펙트럼 이미지를 $M \times T$ 크기(여기서 $M=20$)로 줄이며, 각 채널에 대해 이러한 이미지를 얻습니다. 여러 채널($P$)을 사용할 경우, $P \times M \times T$ 크기의 다채널 시간-주파수 이미지 $X_n$이 입력으로 사용됩니다.

2. **Multi-task CNN을 통한 공동 분류 및 예측**

   - **1-max CNN 아키텍처**: 제안된 CNN은 1개의 오버-타임 컨볼루션 레이어, 1개의 1-max 풀링 레이어, 그리고 1개의 멀티태스크 소프트맥스 레이어로 구성된 간단한 구조입니다.
     - **오버-타임 컨볼루션 레이어**: 다양한 시간 폭($w$)을 가진 컨볼루션 커널(예: $w \in \{3,5,7\}$)을 사용하여 다양한 해상도의 특징을 학습합니다. 각 필터는 입력 이미지의 주파수 및 채널 차원을 완전히 커버합니다. ReLU 활성화 함수를 사용합니다.
     - **1-max 풀링 레이어**: 특징 맵에서 가장 두드러진 특징을 유지하기 위해 1-max 풀링 함수를 사용합니다. 이는 시간 신호의 시프트-불변(shift-invariance) 특성 포착에 효과적입니다.
     - **멀티태스크 소프트맥스 레이어**: 일반적인 소프트맥스 대신, 현재 에포크($y_n$)의 분류와 인접 에포크($y_{n-\tau}, \dots, y_{n+\tau}$)의 예측을 동시에 수행하기 위해 $2\tau+1$개의 서브태스크에 대한 출력 확률 분포를 생성합니다.
   - **멀티태스크 손실 함수**: 각 서브태스크에 대한 교차 엔트로피 오류의 합을 최소화하도록 네트워크를 훈련합니다.
     $$E^{(i)}(\theta) = \sum_{k=n_i-\tau}^{n_i+\tau} y_k^{(i)} \log(\hat{y}_k^{(i)}(\theta))$$
     전체 훈련 샘플 $N$에 대한 손실 함수는 $L_2$ 정규화와 함께 다음과 같습니다.
     $$E(\theta) = -\frac{1}{N}\sum_{i=1}^{N}E^{(i)}(\theta) + \frac{\lambda}{2} \|\theta\|_2^2$$
     Adam 옵티마이저와 Dropout을 사용하여 훈련됩니다.

3. **앙상블 의사결정 및 집계 (Ensemble of Decisions and Aggregation)**
   - Multi-task CNN은 단일 입력 $X_n$에 대해 $2\tau+1$개의 결정(자기 분류 1개, 이웃 예측 $2\tau$개)을 생성합니다. 이 결정들을 결합하여 최종적으로 더 신뢰할 수 있는 예측을 도출합니다.
   - **덧셈 투표 (Additive Voting)**:
     $$P(y_n) = \frac{1}{2\tau+1} \sum_{i=n-\tau}^{n+\tau} P(y_n|X_i)$$
   - **곱셈 투표 (Multiplicative Voting)**:
     $$P(y_n) = \left( \prod_{i=n-\tau}^{n+\tau} P(y_n|X_i) \right)^{\frac{1}{2\tau+1}}$$
     (논문에서는 단순한 곱으로 표현되었지만, 일반적으로 확률의 곱은 매우 작은 값을 생성하므로 $N$제곱근을 취하는 것이 합리적입니다. 다만, 논문의 식 (6)은 곱을 한 후 $1/(2\tau+1)$을 곱하는 형태로 되어 있어 의미상 $N$제곱근이 아니라 단순 곱셈 후 평균에 가깝습니다. 여기서는 논문에 제시된 그대로를 따릅니다.)
   - 최종 예측 레이블 $\hat{y}_n$은 가장 높은 확률을 가진 클래스로 결정됩니다: $\hat{y}_n = \arg \max_{y_n \in \mathcal{L}} P(y_n)$.

## 📊 Results

- **데이터셋**: Sleep-EDF Expanded (20명) 및 MASS (200명) 데이터셋.
- **교차 검증**: Sleep-EDF는 Leave-one-subject-out, MASS는 20-fold cross validation.
- **분류 vs. 예측 정확도**: 제안된 프레임워크는 이웃 에포크의 신호 정보에 접근하지 않고도 분류 정확도에 근접하는 우수한 예측 정확도를 보였습니다. (1-max CNN의 경우 Sleep-EDF에서 분류보다 좌/우 예측이 각각 2.9%, 1.4% 낮았고, MASS에서는 2.2%, 1.3% 낮았습니다.) 이는 연속적인 수면 에포크 간의 강한 의존성을 입증합니다.
- **공동 분류 및 예측의 장점**:
  - **성능 향상**: 집계 단계를 거친 후 1-max CNN은 Sleep-EDF 및 MASS에서 각각 분류 서브태스크 대비 덧셈 투표로 2.8%, 4.5%의 절대 정확도 향상을, 곱셈 투표로 3.0%, 4.7%의 향상을 달성했습니다. 곱셈 투표가 약간 더 나은 성능을 보였습니다.
  - **기존 방식 대비 우위**: 제안된 "one-to-many" 프레임워크는 "one-to-one" 및 "many-to-one" 기준선보다 일관되게 우수한 성능을 보였습니다. 1-max CNN을 기반으로 했을 때, Sleep-EDF에서 one-to-one 대비 2.5%, many-to-one 대비 0.2% 향상, MASS에서 one-to-one 대비 1.0%, many-to-one 대비 1.6% 향상을 보였습니다.
  - **계산 효율성**: "many-to-one" 방식이 입력 크기 증가로 인해 훈련 시간이 3배 가량 늘어나는 반면, 제안된 프레임워크는 "one-to-one" 방식과 비교하여 훈련 시간이 0.2시간 정도만 증가했습니다.
- **성능 비교 (최종)**:
  - **Sleep-EDF**: Multi-task 1-max CNN은 EEG+EOG 채널 사용 시 82.3%의 전체 정확도를 달성하며, 기존 최신 방법(예: Supratak et al. [22]의 82.0%)을 능가합니다.
  - **MASS**: Multi-task 1-max CNN은 EEG+EOG+EMG 채널 사용 시 83.6%의 전체 정확도를 달성하며, 최신 DeepSleepNet [22] (80.7%) 등 다른 딥러닝 접근 방식보다 2.9% 높은 성능을 보였습니다.
- **클래스별 성능**: N1 단계는 다른 단계와의 유사성과 낮은 빈도로 인해 정확도(Sleep-EDF 31.9%, MASS 41.1%)가 상대적으로 낮았습니다.

## 🧠 Insights & Discussion

- **성능 향상 원인**:
  - **비전환(Non-transition) 에포크**: 제안된 프레임워크는 수면 단계 전환이 없는 에포크(전체 에포크의 83.4%)에서 one-to-one 및 many-to-one 기준선 대비 각각 2.7%, 1.3% 더 높은 정확도를 달성했습니다. 불일치하는 에포크에서도 제안된 방식이 2배 높은 정확도를 보였습니다.
  - **전환(Transition) 에포크**: 수면 단계 전환 지점의 에포크는 수동 레이블링의 모호성으로 인해 모든 프레임워크에서 낮은 정확도를 보였습니다. 제안된 프레임워크는 이러한 모호한 전환 에포크에서 이웃 정보를 고려하여 분류 결정에 균형을 맞추는 경향이 있습니다.
- **컨볼루션 필터 수의 영향**: 컨볼루션 필터($Q$) 수를 늘려도 성능 향상은 미미했습니다 (Q=100에서 Q=1000으로 늘려도 약 0.4%~0.5% 향상). 이는 더 작은 네트워크로도 좋은 성능을 유지할 수 있음을 시사합니다.
- **멀티모달 입력의 이점**: EEG, EOG, EMG 채널을 함께 사용했을 때 일관된 성능 향상을 보였습니다. 예를 들어, MASS 데이터셋에서 EEG 단독 대비 EEG+EOG는 4.1%p, EEG+EOG+EMG는 추가로 1.1%p 향상되었습니다. 이는 눈 움직임과 근육 활동과 같은 추가 정보가 수면 단계 분류에 중요함을 나타냅니다.
- **출력 컨텍스트 크기의 절충 문제**: 출력 컨텍스트 크기를 늘리면 앙상블 결정의 수가 증가하여 성능 향상을 기대할 수 있지만, 입력 에포크와 멀리 떨어진 이웃 간의 연관성이 약해져 개별 예측 결정의 품질이 저하될 수 있습니다. 실험 결과, 컨텍스트 크기가 3일 때 가장 좋은 성능을 보였고, 5로 늘렸을 때는 약간의 성능 감소가 관찰되었습니다 (Sleep-EDF에서 0.1%p, MASS에서 0.2~0.3%p 감소).
- **멀티태스크 vs. 앙상블**: 별도의 CNN 앙상블 모델은 개별 서브태스크에서 멀티태스크 모델보다 약간 더 나은 성능을 보였으나, 집계 후에는 성능 차이가 미미했습니다. 중요한 것은 제안된 Multi-task 1-max CNN이 Deep CNN 기준선보다 두 가지 형태(멀티태스크 및 앙상블) 모두에서 뛰어났다는 점입니다.

## 📌 TL;DR

이 논문은 자동 수면 단계 분류를 위한 **공동 분류 및 예측(joint classification and prediction)**, 즉 "one-to-many" CNN 프레임워크를 제안합니다. 단일 수면 에포크를 입력으로 받아 해당 에포크의 수면 단계를 분류하고 동시에 인접 에포크의 수면 단계를 예측하는 방식으로, 기존 "many-to-one" 방식의 모델링 모호성과 계산 오버헤드를 해결합니다. 간단한 **1-max CNN** 아키텍처와 **멀티태스크 손실 함수**를 사용하며, 여러 예측 결과를 **확률적 집계(덧셈/곱셈 투표)**하여 최종 결정을 내립니다. Sleep-EDF와 MASS 데이터셋에서 실험한 결과, 제안된 프레임워크는 기존 딥러닝 방법들을 능가하는 최신 성능을 달성했으며, 특히 **82.3% (Sleep-EDF)** 및 **83.6% (MASS)**의 높은 정확도를 보이며, 계산 효율성도 우수함을 입증했습니다.
