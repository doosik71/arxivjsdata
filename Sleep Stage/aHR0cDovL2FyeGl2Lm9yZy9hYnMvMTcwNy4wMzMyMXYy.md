# A deep learning architecture for temporal sleep stage classification using multivariate and multimodal time series

Stanislas Chambon, Mathieu N. Galtier, Pierrick J. Arnal, Gilles Wainrib and Alexandre Gramfort

## 🧩 Problem to Solve

수면 단계 분류(Sleep stage classification)는 수면 장애 진단의 중요한 예비 검사이며, 전통적으로 수면 전문의가 뇌전도(EEG), 안구전도(EOG), 근전도(EMG)와 같은 수면다원검사(PSG) 신호를 시각적으로 검사하여 30초 단위로 수면 단계를 할당합니다. 이러한 수동 분류는 지루하고 시간이 많이 소요되며, 전문가의 주관성과 변동성에 영향을 받습니다. 기존의 자동화된 수면 단계 분류 방법들은 종종 스펙트로그램 계산이나 수동으로 특징(hand-crafted features)을 추출하는 방식에 의존했으며, PSG 신호의 다변량(multivariate) 및 다중 모드(multimodal) 특성을 완전히 활용하지 못하거나 각 30초 데이터 윈도우의 시간적 문맥(temporal context)을 효과적으로 통합하지 못했습니다. 특히 불균형한 클래스 분포(예: N1 단계는 N2 단계에 비해 드묾)로 인해 희귀 클래스 예측이 어렵다는 과제도 있습니다.

## ✨ Key Contributions

- **최초의 엔드-투-엔드(end-to-end) 딥러닝 접근법**: 스펙트로그램 계산이나 수동 특징 추출 없이, 다변량 및 다중 모드 PSG 신호(EEG, EMG, EOG)를 활용하여 수면 단계를 분류하는 최초의 엔드-투-엔드 딥러닝 아키텍처를 제안했습니다.
- **시간적 문맥 활용**: 각 30초 데이터 윈도우의 시간적 문맥(이전 및 이후 윈도우)을 활용하여 분류 성능을 향상시키는 방법을 제안하고 그 효과를 정량화했습니다.
- **선형 공간 필터링**: 각 모드별로 첫 번째 계층에서 선형 공간 필터(linear spatial filters)를 학습하여 센서 배열을 통해 신호 대 잡음비(SNR)를 높이고, 분류 작업에 유용한 정보를 강화합니다.
- **최첨단 성능 달성**: 61개의 공개 PSG 기록(최대 20개 EEG 채널 포함)에 대한 실험에서 제안된 네트워크 아키텍처가 최첨단(state-of-the-art) 성능을 달성함을 입증했습니다.
- **최적의 채널 구성 제안**: 6개의 EEG 채널(F3, F4, C3, C4, O1, O2), 2개의 EOG 채널(좌우), 3개의 EMG 턱 채널을 사용하는 것이 균형 정확도(Balanced Accuracy) 측면에서 최적의 분류 성능을 위한 좋은 균형임을 밝혔습니다.
- **시간적 문맥의 중요성 강조**: 제한된 채널 수를 사용할 때 각 데이터 세그먼트 전후 1분(±30초)의 데이터를 활용하는 것이 가장 큰 성능 향상을 제공함을 확인했습니다.
- **모델 해석 가능성 탐구**: 가려진 민감도(occlusion sensitivity) 분석을 통해 네트워크가 수면 단계와 특정 주파수 콘텐츠(예: 델타 대역은 N2/N3, 알파 대역은 W)를 어떻게 연관 짓는지 설명했습니다.

## 📎 Related Works

- **수동 특징 기반 접근법**: 신호 및 이벤트에 대한 사전 지식을 바탕으로 수동으로 특징을 추출한 후 분류기(예: 그래디언트 부스팅, 결정 트리)를 사용하는 방법들이 있습니다. [7], [16] 등에서 광범위하게 참조됩니다.
- **학습된 특징 기반 접근법**: 변환된 데이터나 원시 데이터에서 적절한 특징 표현을 학습하는 방법들입니다.
  - **컨볼루션 신경망(CNN) 기반**: 원시 데이터로부터 직접 특징을 학습하여 수면 단계 분류를 수행하는 접근법 [11]–[13].
  - **공간 필터링을 통합한 딥러닝**: EEG 데이터에서 특징을 학습하기 위해 첫 번째 계층에서 공간 필터를 사용하는 딥러닝 접근법 [25]–[30].
  - **다중 센서 및 시간적 문맥 활용**: 다중 센서 데이터에서 특징 표현을 학습하고 수면 단계를 분류하며, 시간적 문맥을 고려하는 딥러닝 접근법 [5], [9].
- **불균형 클래스 문제 해결**: 예측 알고리즘이 희귀 클래스를 무시하는 경향을 해결하기 위해 손실 함수에 가중치를 부여하거나 균형 샘플링(balanced sampling)을 사용하는 방법 [4], [5], [9]–[13], [15].
- **시간적 수면 단계 분류**: 인접한 시간 세그먼트의 특징을 활용하여 분류 성능을 높이는 접근법 [4], [5], [9]–[13].
- **재귀 신경망(RNN) 기반**: LSTM 또는 Bi-LSTM 유닛을 사용하여 복잡한 단계 전환이나 장기 의존성을 통합하는 방법 [5], [9], [10], [12], [45].

## 🛠️ Methodology

본 논문은 다변량 및 다중 모드 시계열로부터 시간적 수면 단계 분류를 수행하기 위한 엔드-투-엔드 딥러닝 아키텍처를 제안합니다.

1. **문제 정의**:

   - 입력은 $C \times T$ 차원의 시계열 $X$ (30초 길이의 세그먼트)와 라벨 $y \in \{W, N1, N2, N3, REM\}$입니다.
   - 시간적 문맥을 위해 $2k+1$개의 인접 세그먼트 시퀀스 $S_t^k = \{X_{t-k}, \dots, X_t, \dots, X_{t+k}\}$를 사용합니다.
   - 목표는 예측 모델 $f: X^k \to Y$를 학습하여 범주형 교차 엔트로피 손실 $L(f(x), y)$의 기댓값을 최소화하는 것입니다.

2. **다변량 네트워크 아키텍처 (시간적 문맥 없음, $k=0$)**:

   - **입력 처리**: EEG/EOG 채널과 EMG 채널을 별도의 파이프라인으로 처리합니다.
   - **선형 공간 필터링**: 각 파이프라인의 첫 번째 계층은 시간과 무관한 선형 연산을 통해 원본 입력 채널의 선형 조합으로 "가상 채널(virtual channels)"을 생성합니다. 이는 분류 작업에 필요한 정보의 신호 대 잡음비를 높이는 역할을 합니다. (2D 컨볼루션으로 구현 가능).
   - **차원 변환**: 공간 필터링 후, 차원 순서를 변경하여 다음 컨볼루션 계층에 맞춥니다.
   - **컨볼루션 블록**: 두 개의 연속적인 컨볼루션 블록을 적용합니다. 각 블록은 다음과 같습니다:
     - 8개의 길이 64 커널(stride 1)을 가진 1D 컨볼루션.
     - ReLU 비선형 활성화 함수.
     - 최대 풀링(Max Pooling) 계층(시간 축을 따라 16 크기, 중첩 없음).
   - **드롭아웃**: 두 번째 컨볼루션 블록의 출력은 과적합을 방지하기 위해 드롭아웃 계층(25% 비활성화)을 통과합니다.
   - **특징 연결**: EEG/EOG 및 EMG 파이프라인의 드롭아웃 계층 출력을 연결하여 최종 특징 공간을 형성합니다.
   - **소프트맥스 분류기**: 연결된 특징은 5개의 뉴런과 소프트맥스 비선형성을 가진 최종 계층으로 전달되어 각 수면 단계에 대한 확률 벡터를 출력합니다.

3. **시간 분산 다변량 네트워크 (시간적 문맥 활용, $k>0$)**:

   - $k>0$일 경우, 위에서 설명한 다변량 네트워크 아키텍처를 특징 추출기 $Z$로 활용합니다.
   - 관심 있는 샘플 $X_t$와 그 전후 $k$개의 인접 샘플 $\{X_{t-k}, \dots, X_{t+k}\}$ 각각에 특징 추출기 $Z$를 적용합니다.
   - 각 샘플에서 추출된 $2k+1$개의 특징 벡터를 집계(concatenation)하여 하나의 긴 특징 벡터를 만듭니다.
   - 이 집계된 특징 벡터를 최종 소프트맥스 분류기에 입력하여 $X_t$에 해당하는 수면 단계 라벨 $y_t$를 예측합니다.

4. **훈련 과정**:
   - **최적화**: Adam 옵티마이저를 사용하여 범주형 교차 엔트로피 손실을 최소화합니다.
   - **균형 샘플링**: 불균형한 클래스 분포(특히 W, N1 단계) 문제를 해결하고 균형 정확도(Balanced Accuracy)를 최적화하기 위해 미니배치(크기 128)에서 각 클래스의 샘플 수가 균형을 이루도록 샘플링합니다 (각 클래스 약 20%).
   - **조기 종료(Early Stopping)**: 검증 손실이 5 epoch 동안 개선되지 않으면 훈련을 중단합니다.
   - **두 단계 훈련 (시간 분산 네트워크)**:
     1. 시간적 문맥 없이($k=0$) 다변량 네트워크의 특징 추출기 부분을 먼저 훈련합니다.
     2. 훈련된 특징 추출기의 가중치를 고정하고, 집계된 특징을 사용하여 최종 소프트맥스 분류기만 훈련합니다.

## 📊 Results

- **실험 1 (특징 추출기 비교 - Fz/Cz 채널)**:
  - 제안된 다변량 접근법은 Fz-A2, Cz-A2 채널에서 학습했을 때, 단변량 Fz-Cz 파생에서 학습된 Gradient Boosting, Tsinalis et al. 2016, Supratak et al. 2017보다 높은 분류 성능(Balanced Accuracy)을 달성했습니다.
  - 또한, 제안된 모델은 다른 딥러닝 접근법에 비해 적은 수의 파라미터와 낮은 훈련 및 예측 실행 시간을 보였습니다.
  - 특히, Proposed approach - multivariate는 N1을 제외한 모든 수면 단계에서 가장 높은 혼동 행렬 대각 계수를 보였습니다.
- **실험 2 (센서 수 증가의 영향)**:
  - EEG 센서 수를 늘리거나 EOG/EMG와 같은 추가 모드를 포함하면 분류 성능이 향상됩니다. 특히 EMG 모드는 성능에 상당한 향상을 가져옵니다.
  - 6개의 EEG 채널(F3, F4, C3, C4, O1, O2)과 추가 모드를 사용하면 20개 채널 구성과 유사한 성능을 보였으며, 이는 계산 비용을 줄이면서 최고 성능을 얻기 위한 효율적인 구성입니다.
- **실험 3 (시간적 문맥의 영향)**:
  - 가까운 시간적 문맥(예: ±30초)을 고려하면 분류 성능이 향상되지만, 너무 큰 시간적 문맥은 오히려 성능을 저하시킬 수 있습니다.
  - 시간적 문맥의 이점은 공간적 문맥이 제한적일 때 더 두드러집니다. (예: 2개 EEG 채널에서 ±30초 문맥은 6개 EEG 채널 문맥 없는 경우와 유사한 성능)
  - 시간적 문맥을 추가하면 N1, N2, REM 단계의 탐지율이 향상되지만, 너무 넓은 문맥은 W와 N3 단계의 탐지에 부정적인 영향을 미 미치고 수면 그래프(hypnogram)를 평활화하는 경향이 있습니다.
- **실험 4 (훈련 데이터 양의 영향)**:
  - 훈련 데이터의 양이 많을수록 모든 알고리즘의 성능이 향상됩니다.
  - Gradient Boosting은 적은 데이터 상황에서 제안된 접근법보다 더 강건했지만, 제안된 딥러닝 모델은 데이터 양이 증가함에 따라 성능 향상 폭이 더 컸습니다.
  - 풍부한 공간적 문맥(6 EEG + EOG/EMG)은 적은 훈련 데이터(12개 기록)로도 많은 훈련 데이터(41개 기록)와 적은 채널(2개 EEG)을 사용하는 경우와 유사한 성능을 달성할 수 있음을 시사합니다.
- **실험 5 (모델 분석 - 주파수 대역별 예측)**:
  - 가려진 민감도 분석 결과, 네트워크는 델타(delta) 대역(0.5-4.5 Hz) 신호가 남아있을 때 주로 N2 또는 N3 단계를 예측하여 저주파수 콘텐츠를 이 단계들과 연관시키는 것을 보여주었습니다.
  - 알파(alpha) 대역(8.5-11.5 Hz) 신호만 남아있을 때는 주로 W(각성) 단계를 예측하여, 인간 전문가의 수면 채점 규칙과 일치하는 학습을 보여주었습니다.

## 🧠 Insights & Discussion

- **공간 필터링의 효과**: 제안된 아키텍처는 선형 공간 필터링을 통해 다변량 입력을 효과적으로 처리하며, 이는 분류 작업에 유용한 정보를 강화합니다. 다른 접근법들이 입력 시계열을 평균화하거나 공간 처리를 수행하지 않는 것과 대조적으로, 본 연구는 최적화된 공간 필터의 중요성을 보여줍니다.
- **효율적인 특징 추출기 아키텍처**: 2계층의 간단하고 다용도적인 특징 추출기는 공간 및 시간 컨볼루션을 엄격하게 분리하여 값비싼 2D 컨볼루션을 1D 컨볼루션으로 대체하는 저랭크 시공간 컨볼루션 전략을 성공적으로 사용했습니다. 이는 작은 필터 크기에도 불구하고 저주파수(N3)와 고주파수(N2, W, N1) 콘텐츠를 구별하는 능력을 입증했습니다.
- **적은 파라미터 수**: 특정 아키텍처 선택(작은 컨볼루션 필터, 큰 풀링 영역, 최종 계층 전 완전 연결 계층 제거) 덕분에 모델은 다른 최첨단 딥러닝 접근법에 비해 훨씬 적은 수의 파라미터(~$10^4$ ~ $10^5$)를 가집니다. 이는 휴대용 장치에서의 온라인 분류에 유리합니다.
- **임상적 적용 가능성**: 제안된 접근법은 W(각성) 단계 탐지에 특히 강하며(높은 민감도 0.85, 특이도 1에 가까움), 이는 단편화된 수면 진단과 같은 임상적 응용에 유용할 수 있습니다. 수면의 질 측정(수면 단편화 지수)과 분류 성능 사이에 특별한 상관관계가 없다는 점은 비정상적인 수면 구조를 가진 환자에게도 적용 가능함을 시사합니다.
- **시간적 문맥의 균형**: 시간적 문맥 활용은 N1, N2, REM 단계 탐지에서 이점을 제공하지만, 너무 넓은 문맥은 W와 N3 탐지에 부정적인 영향을 미쳐 수면 그래프를 과도하게 평활화할 수 있습니다. 따라서 시간적 문맥의 폭은 교차 검증을 통해 신중하게 결정되어야 합니다. 이는 수면 장애 관련 비정상적인 수면 전환을 놓치지 않기 위해 중요합니다.
- **훈련 데이터의 중요성**: 딥러닝 모델은 Gradient Boosting보다 더 많은 훈련 데이터에서 더 큰 성능 향상을 보였습니다. 이는 더 많은 데이터가 있다면 더 나은 성능을 기대할 수 있음을 의미합니다. 또한, 풍부한 공간적 문맥은 훈련 데이터 부족을 보완할 수 있습니다.
- **샘플링 및 평가 지표의 선택**: 불균형 클래스 문제를 해결하고 균형 정확도를 최적화하기 위해 균형 샘플링(balanced sampling)이 사용되었습니다. 특정 임상 응용에 따라 특정 단계의 오류 비용이 달라질 수 있으므로, 샘플링 전략과 평가 지표는 사용자의 목적에 맞게 조정될 수 있는 자유도를 제공합니다.
- **제한 사항 및 향후 연구**: 본 논문의 시간적 문맥 활용은 오프라인 예측에는 적합하지만 온라인 예측에는 한계가 있을 수 있습니다. LSTM/Bi-LSTM과 같은 재귀 네트워크 아키텍처와 특징 추출기를 통합하면 복잡한 단계 전환 및 장기 의존성을 포착하여 추가적인 성능 개선을 이끌어낼 수 있을 것입니다.

## 📌 TL;DR

수면 단계 분류를 위해 스펙트로그램이나 수동 특징 추출 없이 다변량, 다중 모드 PSG 신호와 시간적 문맥을 엔드-투-엔드(end-to-end)로 활용하는 딥러닝 아키텍처를 제안합니다. 이 모델은 선형 공간 필터와 시간적 컨볼루션을 통해 효율적인 특징을 추출하며, 인접한 30초 세그먼트의 시퀀스를 통합하여 시간적 문맥을 고려합니다. 실험 결과, 제안된 접근법은 최첨단 성능을 달성하며, 적은 수의 파라미터와 낮은 계산 비용으로 동작합니다. 특히 6 EEG, 2 EOG, 3 EMG 채널 구성과 1분 이내의 시간적 문맥이 최적의 성능을 제공하며, 모델이 수면 단계와 특정 주파수 대역(델타: N2/N3, 알파: W) 간의 관계를 학습함을 확인했습니다.
