# Multi-View Spatial-Temporal Graph Convolutional Networks with Domain Generalization for Sleep Stage Classification

Ziyu Jia, Youfang Lin, Jing Wang, Xiaojun Ning, Yuanlai He, Ronghao Zhou, Yuhan Zhou, Li-wei H. Lehman

## 🧩 Problem to Solve

본 논문은 수면 단계 분류와 관련하여 세 가지 주요 도전 과제를 해결하고자 합니다:

1. **공간-시간적 특징 활용의 한계:** 다중 채널 뇌 신호에서 시간 변화에 따른 공간적 및 시간적 특징을 효과적으로 활용하는 것이 어렵습니다. 특히, 기존 연구들은 뇌 영역 간의 공간 위상 정보를 충분히 활용하지 못했습니다. 기존 그래프 신경망(GNN) 모델도 주로 기능적 연결성(functional connectivity)만을 사용하여 물리적 근접성을 간과하는 경향이 있습니다.
2. **피험자 간 일반화 문제:** 개인별 생체 신호의 큰 차이로 인해 딥러닝 모델의 일반화 능력이 저해됩니다. 기존의 전이 학습(transfer learning) 방법들은 대부분 새로운 피험자 데이터에 대한 추가적인 미세 조정(fine-tuning)을 필요로 하여 비효율적입니다.
3. **모델 해석 가능성 부족:** 대부분의 딥러닝 방법, 특히 그래프 신경망 모델은 뇌 활동과 관련하여 모델이 어떻게 작동하는지에 대한 해석 가능성을 제공하지 않습니다.

## ✨ Key Contributions

본 연구의 핵심 기여는 다음과 같습니다:

- **다중 뷰 뇌 그래프 구성:** 뇌 영역의 기능적 연결성 및 물리적 거리 근접성을 기반으로 두 가지 다른 뇌 뷰(view) 그래프를 구축하여 분류 작업에 풍부한 공간 위상 정보를 제공합니다.
- **어텐션 기반 공간-시간 그래프 합성곱 설계:** 공간-시간적 특징을 추출하고 수면 단계 분류에 가장 관련성 높은 공간-시간적 정보를 포착하기 위해 어텐션(attention) 메커니즘을 포함한 공간-시간 그래프 합성곱(Spatial-Temporal Graph Convolution, ST-GCN)을 설계했습니다.
- **도메인 일반화 통합:** 피험자 불변(subject-invariant) 수면 특징을 추출하기 위해 도메인 일반화(domain generalization)와 공간-시간 그래프 합성곱 네트워크를 통합된 프레임워크에 결합했습니다.
- **최첨단 성능 달성:** ISRUC-S3 및 MASS-SS3 두 가지 공개 수면 데이터셋에서 기존 최첨단(state-of-the-art, SOTA) 기준 모델들을 능가하는 성능을 입증했습니다.
- **모델 해석 가능성 탐구:** 모델의 핵심 모듈(특히 적응형 그래프 학습을 통한 기능적 연결성)의 해석 가능성을 탐구하여, 얕은 수면(N1)이 깊은 수면(N3)보다 기능적 연결성이 더 복잡하다는 것을 밝혔습니다.

## 📎 Related Works

- **전통적 머신러닝:** SVM [2] 및 Random Forest [3]와 같은 방법들은 특징 공학(feature engineering)에 크게 의존하여 분류 정확도가 제한적이었습니다.
- **딥러닝 (CNN 및 RNN):** CNN [4], RNN [5], SeqSleepNet [13], DeepSleepNet [12] 등은 특징 표현 학습 능력이 뛰어나지만, 입력 데이터가 그리드 형태여야 하므로 뇌 영역 간의 복잡한 연결성을 충분히 활용하지 못했습니다.
- **그래프 신경망 (GNN):** GraphSleepNet [15]은 기능적 연결성 기반 뇌 네트워크를 모델링하여 SOTA 성능을 달성했지만, 뇌 영역의 물리적 근접성을 간과하는 한계가 있었습니다.
- **전이 학습:** MetaSleepLearner [18]와 같은 방법들은 피험자 간 차이 문제를 해결하고자 했으나, 대부분 사전 훈련된 모델의 미세 조정을 요구하여 새로운 피험자에게 적용할 때 비효율적입니다.
- **해석 가능성:** 기존의 CNN 또는 RNN 분류 모델에 대한 해석 가능성 연구는 드물었으며 [7], [12], [19], 특히 수면 단계 분류를 위한 그래프 신경망 모델에 대한 뇌 네트워크 관점에서의 해석 시도는 없었습니다.

## 🛠️ Methodology

본 논문에서 제안하는 MSTGCN (Multi-View Spatial-Temporal Graph Convolutional Networks)은 다음 네 가지 핵심 아이디어를 기반으로 합니다:

1. **뇌 그래프의 다중 뷰 구성:**

   - **기능적 연결성 기반 뇌 그래프 ($G_{FC}$):** 각 EEG 채널을 노드로 간주하고, 노드 특징 $x_m, x_n$ 간의 상관관계를 기반으로 가중치 $A^{FC}_{mn} = g(x_m, x_n)$를 적응적으로 학습합니다. 이는 데이터 주도적 접근 방식이며, 손실 함수 $L_{graphlearning} = \sum_{m,n=1}^N \|x_m - x_n\|^2_2 A^{FC}_{mn} + \lambda \|A^{FC}\|^2_F$를 통해 그래프의 희소성과 의미 있는 연결을 조절합니다.
   - **공간 거리 기반 뇌 그래프 ($G_{DC}$):** 뇌 영역 간의 물리적 거리에 반비례하여 연결 강도를 정의함으로써, 물리적으로 인접한 뇌 영역 간의 상호작용을 반영합니다.

2. **공간-시간 어텐션 (Spatial-Temporal Attention):**

   - **공간 어텐션:** 각 수면 단계에서 뇌의 다른 영역이 미치는 동적인 영향을 포착하기 위해 공간 어텐션 행렬 $P'$를 동적으로 계산합니다.
   - **시간 어텐션:** 인접 수면 단계 간의 동적 상관관계를 포착하기 위해 시간 어텐션 행렬 $Q'$를 사용합니다. 이를 통해 모델이 정보 가치가 높은 시간적 정보에 더 집중하도록 입력 $\hat{X}^{(l-1)}$을 조정합니다.

3. **공간-시간 그래프 합성곱 (Spatial-Temporal Graph Convolution):**

   - **공간 그래프 합성곱:** 스펙트럼 그래프 이론 기반의 그래프 합성곱을 사용하여 각 수면 뇌 네트워크에서 공간적 특징을 추출합니다. 체비쇼프 다항식(Chebyshev polynomial) 확장을 통해 계산 복잡도를 줄이며, $g_\theta *_{\mathcal{G}} x = \sum_{k=0}^{K-1} \theta_k T_k(\tilde{L})x$로 정의됩니다.
   - **시간 합성곱:** 공간 특징 추출 후, 표준 2D 합성곱 계층을 사용하여 이웃 수면 단계 간의 시간적 의존성을 포착하고 수면 전환 규칙을 학습합니다. 전체 ST-GCN의 출력은 $X^{(l)} = \text{ReLU}(\Phi * (\text{ReLU}(g_\theta *_{\mathcal{G}} \hat{X}^{(l-1)})))$입니다.
   - 두 가지 뷰 ($X_{FC}$와 $X_{DC}$)에서 추출된 특징은 병합(concatenate)되어 $X = X_{FC} \| X_{DC}$를 형성합니다.

4. **도메인 일반화 (Domain Generalization):**
   - 개인별 생체 신호 차이의 영향을 줄이기 위해 적대적 도메인 일반화(adversarial domain generalization) 방법을 사용합니다. 이는 각 피험자를 특정 소스 도메인으로 간주하여 도메인 불변(domain-invariant) 특징을 추출하도록 모델을 훈련합니다.
   - 특징 추출기($G_f$), 도메인 분류기($G_d$), 레이블 예측기($G_y$)로 구성되며, $G_f$와 $G_d$ 사이에 Gradient Reversal Layer (GRL)를 삽입하여 적대적 학습을 수행합니다.
   - 최적화 목표는 $G_y$의 손실을 최소화하고 동시에 $G_d$의 손실을 최대화하는 $G_f$의 매개변수를 찾는 것입니다. 이를 통해 모델은 수면 단계 분류와 관련된 공통적인(subject-invariant) 특징을 학습하게 됩니다. 전체 손실 함수는 다음과 같습니다:
     $$L_{DG} = -\frac{1}{L} \sum_{i=1}^L \sum_{r=1}^{R_y} y_{i,r} \log \hat{y}_{i,r} + \beta_1 \frac{1}{L} \sum_{i=1}^L \sum_{r=1}^{R_d} d_{i,r} \log \hat{d}_{i,r}$$

## 📊 Results

- **최첨단 성능 달성:** ISRUC-S3 및 MASS-SS3 두 가지 공개 데이터셋 모두에서 종합 정확도(Accuracy), F1-점수(F1-score), Kappa 지수 등 다양한 평가 지표에서 기존 최첨단(SOTA) 기준 모델들을 능가하는 성능을 보였습니다 (Table I, II).
- **개별 수면 단계 분류:** Wake 및 N3 단계(ISRUC-S3), REM 및 N2 단계(MASS-SS3)에서 특히 높은 분류 정확도를 보였습니다. N1 단계는 전환기적 특성과 적은 샘플 수로 인해 분류가 여전히 어려웠지만, MSTGCN은 MASS-SS3 데이터셋에서 N1 단계에 대해 기존 SOTA 모델보다 4% 높은 F1-점수를 달성하며 우수성을 입증했습니다.
- **모듈별 효과 (Ablation Study):** 공간 그래프 합성곱을 기본 모델로 하여 시간 합성곱, 어텐션 메커니즘, 다중 뷰 융합, 도메인 일반화를 순차적으로 추가할 때마다 모델 성능(정확도 및 F1-점수)이 꾸준히 향상되는 것을 확인했습니다. 이는 제안된 각 모듈이 수면 단계 분류 성능 향상에 효과적임을 입증합니다 (Figure 6).
- **적응형 기능적 연결성 그래프의 효과:** 본 연구에서 제안된 적응형 (학습된) 기능적 연결성 그래프는 고정된 그래프 (예: Fully Connected, KNN, PCC, PLV, MI)보다 수면 단계 분류에서 더 높은 정확도를 달성했습니다 (Figure 7).
- **모델 해석 가능성:**
  - **기능적 연결성 시각화:** 학습된 적응형 기능적 연결성 맵은 Wake 및 N1 단계에서 N3 단계보다 더 많은 기능적 연결성을 보였습니다. 이는 N3 단계(깊은 수면)에서 뇌 활동이 적고 N1 단계(얕은 수면)에서 상대적으로 활발하다는 기존 뇌 과학 연구 결과와 일치합니다 (Figure 8).
  - **시간 어텐션 시각화:** 모델은 현재 수면 단계(T)에 가장 높은 어텐션 가중치를 부여하고, 인접한 이전 및 이후 수면 단계에는 유사하지만 낮은 가중치를 부여했습니다. 이는 AASM 수면 표준과 수면 전문가의 분류 방식과 일치하는 결과입니다 (Figure 9).
  - **공간 어텐션 시각화:** C3 및 C4 EEG 채널이 모든 수면 단계에서 항상 가장 높은 어텐션 가중치를 가졌으며, F3 및 F4 채널은 가장 낮았습니다. 이는 C3 및 C4 채널이 수면 단계 분류에 가장 정보가 풍부한 채널일 수 있음을 시사합니다 (Figure 10).

## 🧠 Insights & Discussion

- **다중 뷰 접근 방식의 강점:** 뇌의 기능적 연결성과 물리적 근접성을 모두 고려한 다중 뷰 뇌 그래프는 뇌의 공간적 관계에 대한 풍부하고 보완적인 정보를 제공하여 수면 단계 분류의 정확도를 크게 향상시켰습니다. 이는 뇌 활동의 다양한 측면을 포착하는 데 효과적임을 보여줍니다.
- **도메인 일반화의 중요성:** 제안된 도메인 일반화 프레임워크는 피험자 간 생체 신호의 개인차를 극복하고 모델의 일반화 능력을 획기적으로 향상시켰습니다. 특히, 새로운 피험자에 대한 미세 조정 없이도 높은 성능을 유지할 수 있어, 임상 환경과 같이 미지의 사용자를 대상으로 하는 실제 시스템에 적용될 잠재력이 큽니다.
- **해석 가능한 모델:** 적응형 그래프 학습과 공간-시간 어텐션 메커니즘을 통해 모델의 "블랙박스"적 특성을 일부 해소하고, 뇌 기능 및 수면 생리 과정과 관련된 의미 있는 통찰을 제공했습니다. 이는 뇌 과학 연구 결과와 일치하는 방식으로 수면 단계별 뇌 활동 패턴 및 중요한 EEG 채널을 식별하는 데 기여합니다.
- **한계 및 미래 연구:** N1 단계의 낮은 분류 성능은 여전히 개선이 필요한 부분입니다. 이는 N1 단계의 전환기적 특성과 데이터 불균형 문제에 기인하며, 향후 불균형 데이터 처리 기술이나 전환기 수면 특징을 더 효과적으로 학습하는 방법에 대한 연구가 필요할 수 있습니다.
- **다변량 시계열 적용 가능성:** 본 연구에서 제안된 접근 방식은 수면 데이터뿐만 아니라 다른 다변량 생리 시계열 데이터 분석에도 적용될 수 있는 일반적인 프레임워크를 제공합니다.

## 📌 TL;DR

수면 단계 분류는 다중 채널 뇌 신호의 공간-시간 특징을 완전히 활용하고, 피험자 간 생체 신호 차이로 인한 딥러닝 모델의 일반화 문제를 해결하며, 모델의 뇌 해석 가능성을 높이는 주요 과제를 안고 있습니다. 본 논문은 이러한 문제를 해결하기 위해 **다중 뷰 공간-시간 그래프 합성곱 네트워크 (MSTGCN)와 도메인 일반화**를 제안합니다. MSTGCN은 뇌의 기능적 연결성 및 물리적 거리를 기반으로 두 가지 뇌 뷰 그래프를 구성하고, 공간-시간 어텐션 메커니즘을 통합한 ST-GCN을 사용하여 공간-시간 특징을 효과적으로 추출합니다. 또한, 도메인 일반화를 통해 피험자 불변 특징을 학습함으로써 모델의 일반화 성능을 크게 향상시킵니다. 실험 결과, MSTGCN은 ISRUC-S3 및 MASS-SS3 데이터셋에서 최첨단 성능을 달성했으며, 적응형 그래프 학습 및 어텐션 메커니즘을 통해 수면 단계별 기능적 연결성 패턴 및 중요한 EEG 채널에 대한 해석 가능한 통찰을 제공했습니다.
