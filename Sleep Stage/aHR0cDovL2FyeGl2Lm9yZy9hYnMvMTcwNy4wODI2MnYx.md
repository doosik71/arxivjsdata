# SLEEPNET: Automated Sleep Staging System via Deep Learning

Siddharth Biswal, Joshua Kulas, Haoqi Sun, Balaji Goparaju, M Brandon Westover, Matt T Bianchi, Jimeng Sun

## 🧩 Problem to Solve

수면 무호흡증과 같은 수면 장애는 전 세계적으로 수백만 명에게 영향을 미치는 심각한 건강 문제이며, 진단에는 야간 수면다원검사(PSG)를 통한 뇌파(EEG) 모니터링이 필수적입니다. 그러나 PSG 데이터의 수면 단계 수동 채점은 수면 기술자의 시간이 많이 소요되며, 기술자 간 신뢰도(Inter-rater reliability) 문제도 존재합니다. 환자 개개인의 EEG 시계열 데이터의 방대한 이질성 또한 자동화의 주요 도전 과제입니다. 이 연구는 대규모의 이질적인 PSG 데이터셋에 대해 전문가 수준의 정확도를 달성하는 자동화된 수면 단계 분류 시스템을 개발하여 이러한 문제점을 해결하고자 합니다.

## ✨ Key Contributions

- **종단 간(End-to-End) 심층 신경망 SLEEPNET 제안**: 대규모 PSG 데이터를 기반으로 수면 단계를 자동으로 주석 처리하는 딥러닝 모델을 제안합니다. 이는 다른 EEG 주석 및 분류 작업으로 확장될 수 있는 새로운 심층 신경망입니다.
- **대규모 EEG 데이터셋 평가**: 환자당 약 8시간 분량의 데이터를 포함하는 10,000건의 야간 PSG(훈련용 9,000건, 테스트용 1,000건)에 대해 SLEEPNET을 평가했으며, 이는 EEG 분류 문제에 대한 지금까지 가장 큰 규모의 평가입니다.
- **실제 임상 환경에 배포 및 검증**: Massachusetts General Hospital (MGH)에 SLEEPNET을 배포하고 정량적, 정성적 초기 평가를 수행하여 제안된 시스템의 임상적 및 연구적 가치를 확인했습니다.

## 📎 Related Works

- **EEG 분류**: 간질 발작 예측 및 감지, 뇌-컴퓨터 인터페이스(BCI)에 초점을 맞춘 연구가 많았으며, 주로 생리적 통찰력에 기반한 특징 공학(feature engineering)이 강조되었습니다 (Mirowski et al., 2008; Shoeb and Guttag, 2010).
- **수면 단계 자동 주석**: 이전에도 머신러닝 기반 수면 단계 주석 방법이 제안되었으며 (Berthomier et al., 2007; Anderer et al., 2010; Fraiwan et al., 2010), 신경망을 적용한 연구도 있었습니다 (Schaltenbrand et al., 1996). 상업용 소프트웨어(예: ZMachine$^\text{R}$©)도 개발되었지만 (Wang et al., 2015), 대부분의 선행 연구는 100명 미만의 적은 수의 피험자를 대상으로 하여 일반화에 한계가 있었습니다 (Anderer et al., 2005).
- **헬스케어 애플리케이션용 심층 신경망**: 이미지 분류, 음성 인식 등에서 인상적인 성능을 보여주었으며 (Krizhevsky et al., 2012; Hannun et al., 2014), 의료 분야에서도 CNN (Gulshan et al., 2016; Esteva et al., 2017) 및 RNN (Choi et al., 2016a,b; Lipton et al., 2015)이 성공적으로 활용되었습니다. EEG 데이터에 딥러닝을 적용하여 특징을 학습하거나 (Bashivan et al., 2015) 간질 발작 인식 및 BCI에 사용된 사례도 있습니다 (Mirowski et al., 2008; Lawhern et al., 2016).

## 🛠️ Methodology

SLEEPNET은 크게 **훈련 모듈**과 **배포 모듈**로 구성됩니다.

### 1. 훈련 모듈

- **데이터**: MGH 수면 연구실에서 수집된 10,000명의 환자 PSG 데이터(8만 시간의 EEG 데이터, 3.2TB). 각 30초 단위(epoch)는 W(깨어 있음), R(렘 수면), N1, N2, N3(비렘 수면 1, 2, 3단계)의 5단계 중 하나로 숙련된 기술자가 AASM 표준에 따라 주석 처리했습니다.
- **특징 추출**:
  - **원시 EEG($F_\text{R}$)**: 각 30초 epoch의 6개 채널(F3-M2, F4-M1, C3-M2, C4-M1, O1-M2, O2-M1)에서 6000개 샘플을 추출하여 $6000 \times 6 \times n_i$ 차원의 텐서로 표현합니다.
  - **스펙트로그램($F_\text{S}$)**: 각 30초 epoch를 29개의 2초 서브-epoch(1초 겹침)로 분할하고, 다중 테이퍼 스펙트럼 분석(MTSA)을 사용하여 0-100Hz 범위의 257개 주파수 빈에서 파워 스펙트럼 밀도를 추정합니다. 이는 $29 \times 257 \times n_i$ 차원의 텐서가 됩니다.
  - **전문가 정의 특징($F_\text{E}$)**: 각 30초 epoch에서 시간 및 주파수 도메인 특징을 추출합니다.
    - **시간 도메인**: 라인 길이(Line length), 첨도(Kurtosis) (각 6개 채널).
    - **주파수 도메인**: 델타(0.5-4Hz), 세타(4-8Hz), 알파(8-12Hz), 시그마(12-20Hz) 밴드의 상대적 파워(예: 델타/총 파워, 델타/세타 비율 등)의 95백분위수, 최소값, 평균, 표준 편차, 첨도 등을 추출합니다. 총 96개의 특징이 $96 \times n_i$ 차원의 벡터를 형성합니다.
- **분류 모델**: 다양한 모델 조합을 실험했습니다.
  - **기본 머신러닝**: 로지스틱 회귀(LR), 트리 부스팅(TB), 다층 퍼셉트론(MLP).
  - **심층 학습**:
    - **Convolutional Neural Network (CNN)**: 스펙트로그램($29 \times 257$) 처리에는 2D CNN을, 원시 파형(6개 채널 평균) 처리에는 1D CNN을 사용합니다. $3 \times 3$ 필터(32, 64, 128개 스택), 최대 풀링 레이어, 완전 연결 레이어로 구성됩니다.
    - **Recurrent Neural Network (RNN)**: 시퀀스 데이터를 모델링하기 위해 Long Short-Term Memory (LSTM) 셀을 사용합니다. 5개 LSTM 레이어, tanh 활성화 함수, 드롭아웃 확률 0.9, 은닉 레이어 크기 1000으로 구성됩니다.
    - **Recurrent-Convolutional Neural Network (RCNN)**: CNN으로 스펙트로그램에서 "공간" 특징($\phi_t = \text{CNN}(F_S)$)을 추출한 후, 이 특징 시퀀스를 RNN(LSTM)에 입력하여 시간적 종속성을 학습합니다.
- **평가**: 9,000명의 환자를 훈련/검증에, 1,000명의 환자를 독립적인 테스트 세트로 사용합니다. 정확도와 Cohen의 카파($\kappa$) 값을 성능 지표로 사용합니다. 하이퍼파라미터 튜닝을 위해 랜덤 검색을 50회 수행했습니다.

### 2. 배포 모듈

- **배포 아키텍처**: 훈련된 모델과 모든 종속성을 Docker 이미지로 패키징하여 MGH의 진료 현장(point of care) 랩톱 또는 데스크톱에 배포합니다.
- **웹 애플리케이션**: 임상의는 웹 인터페이스를 통해 PSG 파일을 로드하고, SLEEPNET이 자동으로 수면 단계를 분류하며, 원시 EEG 데이터, 스펙트로그램, 전문가 및 알고리즘 예측 레이블, 수면 관련 통계(각 단계에 소요된 시간, 수면 효율성, 수면 분절 지수 등)를 시각적으로 제공합니다.

## 📊 Results

- **성능 비교**:
  - **가장 좋은 성능**: 전문가 정의 특징($F_\text{E}$)을 입력으로 사용하는 다층 RNN 모델이 테스트 세트에서 평균 **85.76%의 정확도**와 **$\kappa=79.46\%$**의 카파 값을 달성했습니다.
  - **딥러닝 모델의 우위**: 모든 딥러닝 모델(CNN, RNN, RCNN)은 로지스틱 회귀, 트리 부스팅, MLP와 같은 전통적인 분류 방법보다 일관되게 높은 성능을 보였습니다.
  - **RCNN의 경쟁력**: RCNN 또한 전문가 정의 특징과 스펙트로그램 특징 모두에서 76% 이상의 높은 카파 값을 기록하며 경쟁력 있는 성능을 보여주었습니다.
  - **선행 연구 대비 우수**: RNN의 $\kappa=79.46\%$는 이전 연구들(Anderer et al., 2005)의 카파 값보다 훨씬 높으며, 특히 10,000명의 훨씬 더 크고 이질적인 코호트에서 달성되었습니다.
- **오분류 분석**: 혼동 행렬(Confusion matrix) 분석 결과, 5가지 수면 단계 중 N1 단계가 가장 분류하기 어려운 것으로 나타났으며, 이는 임상적 기대와 일치합니다.
- **효율성**:
  - **훈련 시간**: 9,000명의 환자 훈련에 복잡한 모델(원시 데이터 입력)은 더 많은 시간이 소요되지만, 전문가 정의 특징을 사용하는 RNN은 상대적으로 효율적이었습니다.
  - **채점 시간**: 한 환자의 8시간 EEG 기록 전체(특징 추출 포함)를 채점하는 데 2~5분이 소요되어, 배포 요구사항을 충분히 충족했습니다.
- **민감도 분석**:
  - **장기 시간 의존성**: RNN에서 look-back step 수가 증가함에 따라 모델 성능(카파 값)이 향상되어, 장기적인 시간 의존성이 수면 단계 분류에 도움이 됨을 입증했습니다.
  - **훈련 환자 수**: 훈련 환자 수가 증가함에 따라 테스트 세트의 카파 값과 정확도가 지속적으로 증가하는 경향을 보였습니다.

## 🧠 Insights & Discussion

- **전문가 수준의 성능**: SLEEPNET은 대규모 이질적 데이터셋에서 인간 전문가의 상호 평가 일치도($\kappa \approx 65-75\%$)와 유사하거나 이를 능가하는(알고리즘-전문가 일치도 $\kappa=79.46\%$) 성능을 달성하여 수면 단계 자동 주석의 실현 가능성을 보여주었습니다.
- **임상적 가치 입증**: MGH 수면 연구실과 신경 중환자실(ICU)에서의 배포 사례 연구를 통해 SLEEPNET의 실용적 가치를 확인했습니다.
  - **수면 연구실**: 기술자의 주석 프로세스를 가속화하고 품질을 향상시키는 데 도움이 될 수 있음을 입증했습니다. 웹 인터페이스는 기존 임상 워크플로우와 유사하여 신속한 사용이 가능하며, 기술자 주석과 알고리즘 주석의 불일치를 쉽게 식별할 수 있습니다.
  - **신경 중환자실**: 중환자실 환자의 수면 상태를 신속하게 특성화하는 데 성공했습니다. 이는 뇌전증 감지를 위한 EEG 모니터링이 이루어지지만 수면 분석 전문성이 부족한 ICU 환경에서 특히 중요합니다. 수면 부족이 섬망(delirium)의 주요 원인임을 고려할 때, SLEEPNET은 중환자 환자 치료 발전에 기여할 잠재력이 큽니다.
- **한계 및 향후 과제**:
  - **N1 단계의 어려움**: N1 단계 분류의 어려움은 임상적으로도 인지되는 부분이지만, 알고리즘 개선을 위한 여지가 있습니다.
  - **전처리 및 모델 복잡성**: 원시 EEG 또는 스펙트로그램 특징에 직접 딥러닝을 적용하는 경우, 특징 공간의 차원이 커서 모델 훈련 시간이 길어질 수 있습니다. 전문가 정의 특징은 계산 효율성을 높이는 데 기여합니다.
  - **추가 개발**: 기술자가 신뢰도가 낮은 epoch에 집중하여 수동 편집할 수 있도록 하는 사전 채점 도구, 자원 부족 환경에서의 완전한 수동 채점 대체, 제한된 채널 기반 가정용 모니터의 정확도 향상 등에 활용될 수 있습니다.

## 📌 TL;DR

수면 장애 진단에 필수적인 수면다원검사(PSG)의 수면 단계 수동 채점은 시간이 많이 걸리고 주관적이라는 문제가 있습니다. 이 논문은 대규모(10,000명)의 이질적인 EEG 데이터셋에 대해 **SLEEPNET**이라는 딥러닝 기반 자동 수면 단계 분류 시스템을 제안합니다. SLEEPNET은 전문가 정의 특징과 재귀 신경망(RNN)을 사용하여 5가지 수면 단계(W, R, N1, N2, N3)를 분류하며, 테스트 세트에서 **85.76%의 정확도**와 **$\kappa=79.46\%$의 카파 값**을 달성하여 인간 전문가 수준의 성능을 뛰어넘는 결과를 보여주었습니다. 또한, MGH의 수면 연구실 및 신경 중환자실에 배포되어 임상적 유용성을 입증했으며, 향후 수면 의학의 접근성을 확대하고 임상 워크플로우를 개선할 큰 잠재력을 가지고 있습니다.
