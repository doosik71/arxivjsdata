# SleepEEGNet: Sequence to Sequence 딥러닝 접근법을 이용한 자동 수면 단계 분류

Sajad Mousavi, Fatemeh Afghah, U. Rajendra Acharya

## 🧩 Problem to Solve

수면 장애 진단에 뇌 활동 모니터링을 위해 뇌전도(EEG) 신호가 흔히 사용됩니다. 수면 전문의에 의한 수동적인 수면 단계 분류(scoring)는 시간이 많이 소요되며, 전문가 간의 분류 신뢰도(inter-rater reliability)에 한계가 있습니다. 기존 자동 분류 방법들은 사전 지식이 필요하거나, 데이터 불균형 문제를 제대로 해결하지 못해 전문가 수준의 성능에 도달하지 못했습니다. 따라서 본 연구는 단일 채널 EEG 신호를 사용하여 수면 단계를 자동으로, 효율적으로, 높은 정확도로 분류하는 방법을 개발하는 것을 목표로 합니다.

## ✨ Key Contributions

- **시퀀스-투-시퀀스(Sequence-to-Sequence) 딥러닝 모델 제안**: 수면 단계 분류가 본질적으로 순차적이라는 점에 착안하여, CNN (특징 추출), BiRNN (시간적 의존성 포착), 어텐션 네트워크 (관련 부분 집중)를 결합한 SleepEEGNet 모델을 개발했습니다.
- **클래스 불균형 문제 해결**: 수면 데이터셋의 클래스 불균형 문제를 완화하기 위해 평균 오분류 오류(MFE) 및 평균 제곱 오분류 오류(MSFE)와 같은 새로운 손실 함수를 적용하여 각 수면 단계의 오분류 오류가 균등하게 처리되도록 했습니다.
- **최고 성능 달성**: Physionet Sleep-EDF 데이터셋(2013년 및 2018년 버전)의 Fpz-Cz 및 Pz-Oz EEG 채널을 사용하여 기존 최신 방법론 대비 우수한 분류 성능을 달성했습니다 (전반적인 정확도 84.26%, 매크로 F1-점수 79.66%, $\kappa=0.79$). 특히 N1 단계와 같이 분류하기 어려운 클래스에서도 향상된 성능을 보였습니다.
- **범용성 입증**: 제안된 모델이 ECG 신호를 이용한 부정맥 탐지나 EEG 신호를 이용한 간질 탐지와 같이 순차적이며 클래스 불균형 문제가 있는 다른 생체 의료 신호 처리 문제에도 적용될 수 있음을 시사했습니다.

## 📎 Related Works

- **수동 특징 추출 기반 방법**: EEG 분석의 사전 지식을 바탕으로 시간, 주파수, 시간-주파수 영역 특징을 추출하고 SVM, 랜덤 포레스트, 신경망 등 고전적인 머신러닝 알고리즘을 적용합니다. 하지만 사전 지식의 필요성과 다양한 환자 데이터에 대한 일반화 능력 부족이라는 한계가 있습니다.
- **자동 특징 추출 기반 딥러닝 방법**: CNN과 같은 딥러닝 알고리즘이 원시 EEG 신호에서 시간 불변 특징을 자동으로 추출합니다. SleepNet [1], DeepSleepNet [22], Stacked Sparse Autoencoders [23], Cascaded LSTM [24] 등이 수면 단계 분류에 딥러닝을 적용했지만, 클래스 불균형 문제로 인한 성능 저하를 겪는 경우가 많습니다.

## 🛠️ Methodology

SleepEEGNet은 단일 채널 EEG 신호로부터 자동 수면 단계 분류를 수행하는 딥러닝 모델입니다.

1. **전처리 (Pre-processing)**

   - **세그먼트화**: 연속적인 원시 단일 채널 EEG 신호를 30초 길이의 에포크(epoch) 시퀀스로 분할하고, 각 에포크에 해당하는 수면 단계를 레이블로 지정합니다.
   - **정규화**: 각 30초 EEG 에포크가 0의 평균과 단위 분산을 갖도록 정규화합니다.
   - (주목할 점은, 필터링이나 노이즈 제거와 같은 복잡한 전처리 과정을 포함하지 않는다는 것입니다.)

2. **모델 아키텍처 (Architecture)**
   SleepEEGNet은 인코더-디코더 구조의 시퀀스-투-시퀀스 모델을 기반으로 합니다.

   - **CNN (특징 추출)**: 입력된 30초 EEG 에포크 시퀀스에서 시간 불변 특징 및 주파수 정보를 추출합니다.
     - 두 개의 섹션으로 구성: 작은 필터(temporal information)와 큰 필터(frequency information)를 사용하여 시간 영역 및 주파수 영역 특징을 모두 활용합니다.
     - 각 CNN 부분은 4개의 1차원 컨볼루션 레이어, ReLU 활성화 함수, 맥스 풀링 레이어, 드롭아웃 블록으로 구성됩니다.
     - 두 CNN 부분의 출력을 결합하여 인코더에 입력합니다.
   - **인코더 (Encoder)**:
     - BiRNN (Bidirectional Recurrent Neural Network) 유닛으로 구성되어 있습니다.
     - 입력 시퀀스의 이전 및 미래 정보를 동시에 고려하여 복잡하고 장기적인 문맥 의존성을 포착합니다.
     - 은닉 상태($e_0, e_1, e_2, ...$)를 계산하여 인코더 표현으로 사용하고 어텐션 네트워크에 전달합니다.
     - BiRNN의 계산은 다음과 같습니다:
       $$
       \vec{h}_t = \tanh(\vec{W}x_t + \vec{V}\vec{h}_{t-1} + \vec{b}) \\
       \overleftarrow{h}_t = \tanh(\overleftarrow{W}x_t + \overleftarrow{V}\overleftarrow{h}_{t+1} + \overleftarrow{b}) \\
       y_t = (U[\vec{h}_t; \overleftarrow{h}_t] + b_y)
       $$
   - **어텐션 디코더 (Attention Decoder)**:
     - BiRNN으로 구성되며, 인코더의 출력 전체를 고려하되 각 디코딩 단계에서 입력 시퀀스의 가장 관련성 높은 부분에 더 많은 가중치를 부여하도록 학습합니다.
     - 컨텍스트 벡터($c_t$)를 계산하여 모델이 중요 영역에 집중하도록 돕습니다.
     - 어텐션 가중치 $\alpha_i$와 컨텍스트 벡터 $c_t$는 다음과 같이 계산됩니다:
       $$
       f(h_{t-1}, e_i) = \tanh(W_h h_{t-1} + W_e e_i) \\
       \alpha_i = \text{softmax}(f(h_{t-1}, e_i)) \approx \frac{\exp(f(h_{t-1}, e_i))}{\sum_{j=1}^{n} \exp(f(h_{t-1}, e_j))} \\
       c_t = \sum_{i=0}^{n} \alpha_i e_i
       $$
     - 훈련 시 디코더는 타겟 시퀀스를 입력으로 받으며, 테스트 시에는 이전 단계의 예측을 다음 단계의 입력으로 사용합니다. 최종 출력에 softmax를 적용하여 각 수면 단계의 확률을 계산합니다.

3. **손실 함수 (Loss Calculation)**
   - 클래스 불균형 문제를 완화하기 위해 평균 오분류 오류(MFE)와 평균 제곱 오분류 오류(MSFE)를 다중 클래스 분류 작업에 맞게 확장하여 사용합니다. 이 손실 함수들은 다수 클래스에 대한 오류와 소수 클래스에 대한 오류를 동등하게 처리하려고 시도합니다.
   - $l(c_i)$는 클래스 $c_i$에 대한 계산된 오류이며, $C_i$는 클래스 $c_i$의 샘플 수입니다. $N$은 사용 가능한 클래스 수입니다.
     $$
     l(c_i) = \frac{1}{C_i} \sum_{i=j}^{C_i} (y_j - \hat{y}_j)^2 \\
     l_{\text{MFE}} = \sum_{i=1}^{N} l(c_i) \\
     l_{\text{MSFE}} = \sum_{i=1}^{N} l(c_i)^2
     $$

## 📊 Results

- **데이터셋**: Physionet Sleep-EDF (2013년 및 2018년 버전) 데이터셋의 Fpz-Cz 및 Pz-Oz 단일 EEG 채널 사용.
- **클래스 불균형 처리**: SMOTE(Synthetic Minority Over-sampling Technique)를 사용하여 소수 클래스 샘플을 오버샘플링하고, MFE/MSFE 손실 함수 적용.
- **평가 지표**: 전반적인 정확도(Accuracy), 정밀도(Precision), 재현율(Recall), 특이도(Specificity), Cohen's Kappa($\kappa$), F1-점수, 매크로 F1-점수(MF1).
- **성능 요약 (Sleep-EDF 2013, Fpz-Cz 채널)**:
  - 전반적인 정확도: **84.26%**
  - 매크로 F1-점수: **79.66%**
  - $\kappa$: **0.79**
  - 클래스별 F1-점수: W (89.19), N1 (52.19), N2 (86.77), N3 (85.13), REM (85.02)
- **기존 연구 대비 우수성**: SleepEEGNet은 Fpz-Cz 및 Pz-Oz EEG 채널 모두에서 Supratak et al. [22], Tsinalis et al. [23, 32] 등 기존 최신 알고리즘보다 모든 평가 지표에서 뛰어난 성능을 보였습니다. 특히 N1 단계와 같이 데이터 불균형이 심한 클래스에서도 기존 연구보다 높은 F1-점수를 달성했습니다.
- **Attention Map 시각화**: 어텐션 메커니즘을 통해 모델이 각 수면 단계를 분류할 때 입력 에포크 중 어느 부분에 집중했는지 시각적으로 확인할 수 있었습니다.
- **Hypnogram 비교**: 수면 전문의가 수동으로 채점한 hypnogram과 제안된 모델이 자동으로 채점한 hypnogram이 약 85% 일치함을 보여주었습니다.

## 🧠 Insights & Discussion

- **성능 향상 요인**:
  - 수면 단계 분류의 **순차적 특성**에 적합한 시퀀스-투-시퀀스 딥러닝 모델 (BiRNN 및 어텐션 메커니즘 포함) 사용.
  - 클래스 불균형 문제 완화를 위한 **새로운 손실 함수(MFE, MSFE)** 적용. 특히, N1 단계와 같이 분류가 어려운 소수 클래스에 대한 성능 향상에 기여했습니다.
- **모델의 범용성**: 제안된 모델은 본질적으로 순차적이며 클래스 불균형 문제가 있는 다른 생체 의료 신호 처리 분야(예: ECG 기반 부정맥 탐지, EEG 기반 간질 탐지)에도 적용될 수 있는 **일반적인(generic) 특성**을 가집니다.
- **한계점**:
  - 충분한 수의 수면 단계 샘플이 훈련 단계에 필요합니다.
  - 시퀀스-투-시퀀스 접근 방식이므로 각 시간 단계에서 특정 길이의 30초 EEG 에포크 시퀀스가 입력으로 요구됩니다.
  - 현재 두 가지 EEG 채널(Fpz-Cz 및 Pz-Oz)로만 평가되었으며, 다른 EEG 채널에 적용하려면 모델을 재훈련해야 합니다.
- **향후 연구**: EEG, EOG, EMG를 포함한 다중 모드 수면다원검사(PSG) 신호를 사용하여 수면 단계 분류 성능을 더욱 향상시키는 방향으로 연구를 확장할 계획입니다.

## 📌 TL;DR

수동 수면 단계 분류의 시간 소모와 전문가 간 편차 문제를 해결하기 위해, 본 논문은 단일 채널 EEG 신호를 활용한 자동 수면 단계 분류 딥러닝 모델 **SleepEEGNet**을 제안합니다. SleepEEGNet은 CNN으로 특징을 추출하고, BiRNN으로 시간적 문맥을 포착하며, 어텐션 메커니즘으로 핵심 정보에 집중하는 **시퀀스-투-시퀀스 아키텍처**를 사용합니다. 또한, 클래스 불균형 문제 해결을 위해 **MFE 및 MSFE라는 새로운 손실 함수**를 도입했습니다. Physionet Sleep-EDF 데이터셋 평가 결과, SleepEEGNet은 기존 최신 방법론 대비 **전반적인 정확도 84.26%, 매크로 F1-점수 79.66%로 우수한 성능을 달성**했으며, 특히 N1 단계 분류에서 큰 개선을 보였습니다. 이 모델은 순차적이고 불균형한 데이터가 특징인 다른 생체 의료 신호 분석 문제에도 적용 가능합니다.
