# LKM-UNet: Large Kernel Vision Mamba UNet for Medical Image Segmentation
Jinhong Wang, Jintai Chen, Danny Chen, and Jian Wu

## 🧩 Problem to Solve

의료 영상 분할은 임상 진단 및 치료에 중요한 정보를 제공하지만, 기존 딥러닝 모델들은 다음과 같은 한계를 가집니다:

*   **CNN 기반 모델 (예: UNet):** 픽셀 수준 특징 추출에는 뛰어나지만, 제한적인 수용장(receptive field)으로 인해 장거리 의존성(long-range dependency) 모델링에 비효율적입니다. 대형 컨볼루션 커널은 특정 최적화 전략과 복잡한 추론 시간 모델 재구성을 요구합니다.
*   **Transformer 기반 모델:** 강력한 장거리 모델링 기능을 제공하지만, 자체 어텐션(self-attention) 모듈의 2차 복잡성($O(N^2)$)으로 인해 계산 비용이 높고, 픽셀을 윈도우로 묶어 해상도 정보를 희생함으로써 픽셀 수준 공간 모델링 능력이 저하됩니다.
*   **Mamba (State Space Sequence Model, SSM):** 선형 복잡성($O(N)$)으로 장거리 시퀀스 모델링에 유망하지만, 다음과 같은 잠재력과 결함이 아직 완전히 탐구되거나 해결되지 않았습니다:
    *   대형 수용장 공간 모델링에 Mamba의 유연성을 활용하는 데 소홀했습니다.
    *   단방향 시퀀스 모델링 방식으로 위치 인식이 부족하고 후방 토큰에 더 집중합니다.
    *   원래 1D 시퀀스 모델링을 위해 고안되어, 인접 픽셀의 불연속성으로 인해 시각 입력의 공간 인식에 부적합하며 "망각(forgetting)" 문제와 비효율적인 지역 모델링 능력을 겪을 수 있습니다.

## ✨ Key Contributions

*   2D/3D 의료 영상 분할을 위한 **대형 커널 Mamba U-shape Network (LKM-UNet)**를 제안합니다.
*   SSM 레이어에 **대형 수용장 커널**을 할당하여 모델이 넓은 공간을 모델링할 수 있는 능력을 부여합니다.
*   **양방향 Mamba** 설계를 통해 위치 인식 시퀀스 모델링을 구현하여 입력 순서의 영향력을 줄입니다.
*   **픽셀 수준 SSM (PiM)**과 **패치 수준 SSM (PaM)**으로 구성된 새로운 **계층적 Mamba 모듈 (LM 블록)**을 제안하여 지역 인접 픽셀 수준 및 장거리 전역 패치 수준 모델링을 강화합니다.

## 📎 Related Works

*   **CNN 기반 모델:** UNet [18], SegResNet [17], nnU-Net [10] 등. 지역 특징 추출에 강하지만 장거리 의존성 모델링에 한계가 있습니다.
*   **Transformer 기반 모델:** UNETR [8], SwinUNETR [7], nnFormer [24] 등. 장거리 의존성 모델링에 강력하지만 계산 비용이 높고 픽셀 수준 공간 모델링이 약합니다.
*   **Mamba 기반 모델:** U-Mamba [15], SegMamba [22] 등. SSM-CNN 하이브리드 모델로 Mamba를 적용하여 장거리 의존성을 모델링하지만, LKM-UNet이 제안하는 대형 커널, 양방향성, 공간 인식 문제는 충분히 다루지 않았습니다.

## 🛠️ Methodology

LKM-UNet은 UNet 형태의 인코더-디코더 구조를 기반으로 하며, 핵심 구성 요소는 LM 블록입니다.

*   **LKM-UNet 전체 구조:**
    *   입력은 깊이별 컨볼루션(depth-wise convolution)을 거쳐 특징 맵 $F_0$에 인코딩됩니다.
    *   인코더는 제안된 **LM 블록**과 다운샘플링 레이어로 구성되어 멀티스케일 특징 맵을 얻습니다.
    *   디코더는 UNet 디코더와 스킵 커넥션(skip-connection)을 포함하는 잔차 블록(residual block)을 사용하여 업샘플링하고 최종 분할 마스크를 예측합니다.

*   **LM 블록 (핵심 구성 요소):**
    *   선형 복잡성을 가진 Mamba의 이점을 활용하여 대형 커널을 통해 픽셀 수준 및 패치 수준 모델링을 동시에 수행합니다.
    *   **픽셀 수준 SSM (PiM):**
        *   특징 맵을 여러 개의 **대형 비겹침(non-overlapping) 서브 커널** (예: 2D의 경우 $m \times n$, 최대 $40 \times 40$) 또는 서브 큐브로 나눕니다.
        *   이 서브 커널들에 대해 SSM 연산을 수행하여 지역 인접 픽셀 간의 상관관계를 모델링합니다.
        *   대형 커널 분할 전략을 통해 수용장을 확장하고 지역 픽셀의 더 많은 세부 정보를 얻습니다.
    *   **패치 수준 SSM (PaM):**
        *   서로 다른 서브 커널 간의 정보를 교환하여 장거리 의존성을 모델링합니다.
        *   풀링 레이어(pooling layer, 크기 $m \times n$)를 통해 각 서브 커널의 중요 정보를 단일 대표값으로 요약합니다.
        *   이 요약된 대표값들에 대해 Mamba를 적용하여 전역 범위 의존성을 모델링합니다.
        *   Mamba 상호작용 후, 집계된 맵을 원래 크기로 언풀링(unpooling)하고 잔차 연결을 적용합니다.
    *   **양방향 Mamba (BiM):**
        *   LM 블록 내의 모든 SSM 레이어(PiM 및 PaM 포함)는 양방향입니다.
        *   기존 Mamba의 단방향 스캔과 달리, **순방향 및 역방향 스캔을 동시에 수행**하고 그 결과를 중첩시킵니다.
        *   이를 통해 입력 순서의 가중치 영향을 줄이고, 영상의 중앙 영역(장기 및 병변이 많은 곳)에 더 집중하여 위치 인식을 향상시킵니다.

*   **수학적 배경 (SSM):**
    *   연속 시스템:
        $$h'(t) = Ah(t) + Bx(t)$$
        $$y(t) = Ch(t)$$
        여기서 $A \in \mathbb{R}^{N \times N}$, $B, C \in \mathbb{R}^{N}$ 입니다.
    *   이산화 (ZOH):
        $$A = \exp(\Delta A)$$
        $$B = (\Delta A)^{-1}(\exp(\Delta A) - I) \cdot \Delta B$$
    *   이산 시스템:
        $$h'(t) = A h(t) + B x(t)$$
        $$y(t) = C h(t)$$
    *   출력은 전역 컨볼루션을 통해 계산됩니다:
        $$K = (CB, CAB, \dots, CA^{L-1}B)$$
        $$y = x * K$$

## 📊 Results

*   **전반적인 성능 (표 1):**
    *   3D Abdomen CT 및 2D Abdomen MR 데이터셋에서 Dice Similarity Coefficient (DSC)와 Normalized Surface Distance (NSD) 지표 모두에서 **최첨단(SOTA) 성능**을 달성했습니다.
    *   CNN 기반(SegResNet, nnUNet), Transformer 기반(UNETR, SwinUNETR, nnFormer) 모델뿐만 아니라, 최신 Mamba 기반 U-Mamba [15]보다도 향상된 성능을 보였습니다.
        *   3D Abdomen CT: DSC 86.82, NSD 90.02
        *   2D Abdomen MR: DSC 77.35, NSD 83.80
*   **커널 크기의 중요성 (표 2, 보충 문서 표 1):**
    *   더 큰 커널 크기를 사용할수록 LKM-UNet의 성능이 향상되었습니다 (예: Abdomen MR에서 커널 크기가 [10, 5, ...]에서 [40, 20, ...]으로 증가할 때 DSC가 75.89에서 77.35로 향상).
    *   이는 의료 영상 분할에서 대형 수용장이 중요하며, Mamba의 선형 복잡성 덕분에 효율적으로 달성될 수 있음을 입증합니다.
*   **개별 구성 요소 분석 (Ablation Study) (표 3, 보충 문서 표 2):**
    *   PiM, PaM, BiM 각 구성 요소는 독립적으로 기본 모델 대비 성능 향상을 가져왔습니다.
    *   특히 PiM은 상당한 개선을 보였는데, 이는 지역 모델링을 위한 수용장 확장(enlarging the receptive field of local modeling)이 모델 성능 향상의 핵심임을 시사합니다.
    *   BiM은 추가적인 성능 향상을 가져와 위치 인식 모델링의 중요성을 확인했습니다.
    *   모든 구성 요소를 포함한 LKM-UNet이 최상의 성능을 달성했습니다.
*   **유효 수용장 (ERF) 시각화 (그림 3, 보충 문서 그림 1):**
    *   LKM-UNet은 CNN 기반 모델(지역적), Transformer 기반 모델(더 넓지만 덜 집중적), U-Mamba(전역적이지만 지역적 주의 약화)와 비교하여 전역 및 지역 측면 모두에서 더 넓은 ERF를 가짐을 보여주었습니다.
    *   질적 분할 결과는 LKM-UNet이 작은 장기를 더 잘 인식하고 분할하며, 전역 모델링뿐만 아니라 지역 세부 사항에서도 강점을 보임을 보여주었습니다.

## 🧠 Insights & Discussion

*   이 연구는 의료 영상 분할에서 대형 Mamba 커널을 사용하여 넓은 수용장을 구현하는 것의 실현 가능성과 효과를 성공적으로 입증했습니다. Mamba의 선형 복잡성은 기존 모델보다 훨씬 큰 커널을 사용할 수 있게 하여, 대형 의료 영상 처리에 특히 유리합니다.
*   새로운 계층적 설계(지역 모델링을 위한 PiM, 전역 의존성 모델링을 위한 PaM)는 Mamba 프레임워크 내에서 다양한 스케일의 공간 모델링을 효과적으로 통합합니다.
*   양방향 Mamba는 기존 Mamba의 단방향 스캔 한계를 극복하고, 입력 순서에 덜 민감하며, 장기 및 병변과 같은 중요한 영상의 중심 영역에 모델의 초점을 맞추는 데 기여합니다.
*   결과들은 Mamba가 장거리 의존성뿐만 아니라, 대형 커널과 함께 적절히 설계될 경우 효율적인 지역 특징 모델링에도 큰 잠재력을 가지고 있음을 강조합니다.
*   LKM-UNet은 의료 영상 분할 분야에서 Mamba 기반 모델의 새로운 가능성을 제시하며, 더 정확하고 효율적인 진단 및 분석 도구 개발에 기여할 수 있습니다.

## 📌 TL;DR

LKM-UNet은 의료 영상 분할을 위해 Mamba의 선형 복잡성을 활용하여 대형 커널 공간 모델링을 구현한 새로운 UNet 모델입니다. 기존 CNN과 트랜스포머의 수용장 제한 및 2차 복잡성 문제를 해결하며, 픽셀 수준 SSM(PiM)과 패치 수준 SSM(PaM)으로 구성된 계층적 Mamba 모듈과 위치 인식에 강한 양방향 Mamba를 도입하여 지역 및 전역 특징 모델링 능력을 극대화합니다. 2D/3D 복부 영상 데이터셋에서 기존 SOTA 모델들을 능가하는 성능을 달성하여, 대형 커널 Mamba 설계의 효과와 잠재력을 성공적으로 입증했습니다.