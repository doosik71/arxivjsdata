# Progressive Domain Adaptation for Object Detection

Han-Kai Hsu, Chun-Han Yao, Yi-Hsuan Tsai, Wei-Chih Hung, Hung-Yu Tseng, Maneesh Singh, and Ming-Hsuan Yang

## 🧩 Problem to Solve

최근 객체 탐지 딥러닝 모델은 방대한 양의 바운딩 박스 어노테이션에 의존합니다. 이러한 어노테이션을 수집하는 것은 수고스럽고 비용이 많이 들지만, 지도 학습 모델은 학습 및 테스트 데이터의 분포가 다를 때(도메인 불일치, domain shift) 일반화 성능이 저하됩니다. 기존 도메인 적응(domain adaptation)은 이러한 문제를 해결하기 위한 방안이지만, 원본(source) 도메인과 타겟(target) 도메인 간의 큰 간극은 적응 작업을 매우 어렵게 만들어 불안정한 학습 과정과 최적화되지 않은 결과를 초래할 수 있습니다.

## ✨ Key Contributions

- **점진적 특징 정렬 프레임워크 제안:** 객체 탐지에서 점진적 특징 정렬(progressive feature alignment)을 달성하기 위해 원본과 타겟 도메인 사이에 중간 도메인(intermediate domain)을 활용하는 새로운 적응 프레임워크를 도입했습니다.
- **가중치화된 태스크 손실 개발:** 중간 도메인 내 합성된 이미지 샘플들의 품질 불균형을 해결하기 위해, 각 샘플의 중요도(타겟 도메인과의 거리)에 따라 가중치를 부여하는 태스크 손실(task loss)을 개발했습니다.
- **최신 성능 달성:** 다양한 객체 탐지 시나리오(교차 카메라 적응, 날씨 적응, 대규모 데이터셋 적응)에서 광범위한 실험을 수행하여 최신(state-of-the-art) 성능을 능가함을 입증했습니다.

## 📎 Related Works

- **객체 탐지:** Faster R-CNN, SSD와 같은 딥 컨볼루션 신경망(CNN) 기반 모델이 주류를 이루지만, 대규모 레이블링 데이터가 필요하며 도메인 불일치에 취약합니다.
- **도메인 적응:**
  - **적대적 학습:** DANN(Domain Adversarial Neural Network) [7] 이후, 특징 분포 정렬을 위한 다양한 적대적 학습 기반 방법론들이 제시되었습니다 [2, 31, 3].
  - **픽셀 공간 정렬:** CycleGAN [36]과 같은 이미지-투-이미지 변환 기법을 활용하여 픽셀 수준에서 도메인을 정렬하는 방식(예: PixelDA [1], CyCADA [12], AugGAN [14])이 있습니다. \* **객체 탐지 특화 도메인 적응:** LSDA [11]는 약지도 학습(weakly-supervised) 방식을, Inoue et al. [15]은 합성 데이터와 의사 레이블(pseudo-labels)을 사용합니다. Chen et al. [3]은 이미지 및 인스턴스 수준에서, Zhu et al. [37]은 식별적 영역(discriminative regions)에 초점을 맞춰 도메인 간 간극을 줄입니다. Kim et al. [16]은 다중 도메인 생성 및 다중 도메인 판별자를 사용하지만, 생성된 도메인과 최종 타겟 도메인 간의 거리는 고려하지 않습니다.
    본 논문은 이러한 한계를 극복하기 위해 중간 도메인을 통한 점진적 접근과 합성 샘플의 품질에 따른 가중치 부여를 제안합니다.

## 🛠️ Methodology

본 논문은 원본-타겟 도메인($S \to T$) 간의 큰 적응 문제를 두 개의 더 쉬운 하위 태스크($S \to F$, $F \to T$)로 분해하는 점진적 도메인 적응 방법론을 제안합니다. 여기서 $F$는 중간 합성 도메인입니다.

- **특징 공간에서의 적응 (Adaptation in the Feature Space):**

  - **탐지 네트워크 (Detection Network):** 객체 탐지 태스크를 위해 Faster R-CNN [24] 프레임워크를 사용합니다. 인코더 $E$가 이미지 특징을 추출하고, 이 특징은 RPN(Region Proposal Network)과 ROI(Region of Interest) 분류기로 구성된 탐지기로 전달됩니다. 손실 함수는 $L_{\text{det}}(E(I)) = L_{\text{rpn}} + L_{\text{cls}} + L_{\text{reg}}$로 정의됩니다.
  - **도메인 판별자 (Domain Discriminator):** 인코더 $E$ 뒤에 도메인 판별자 $D$를 연결하여 특징 $E(I)$가 원본 도메인인지 타겟 도메인인지 구별합니다. 이진 교차 엔트로피 손실 $L_{\text{disc}}$를 사용하여 $P = D(E(I))$가 입력 이미지의 도메인 레이블 $d$와 일치하도록 학습됩니다.
  - **적대적 학습 (Adversarial Learning):** GRL(Gradient Reverse Layer) [6]을 판별자와 탐지 네트워크 사이에 삽입하여 도메인 불변 특징 $E(I)$를 학습합니다. GRL은 역전파 시 기울기 부호를 반전시켜 인코더 $E$가 판별자 $D$를 속이는 특징을 생성하도록 유도합니다. 원본 이미지 $I_S$와 타겟 이미지 $I_T$에 대한 전체 손실 함수는 다음과 같습니다:
    $$ \min*{E} \max*{D} L(I*S,I_T) = L*{\text{det}}(I*S) + \lambda*{\text{disc}} \left[ L_{\text{disc}}(E(I_S)) + L_{\text{disc}}(E(I_T)) \right] $$
        여기서 $\lambda_{\text{disc}}$는 판별자 손실의 가중치입니다.

- **점진적 적응 (Progressive Adaptation):**
  - **중간 도메인 (Intermediate Domain):** CycleGAN [36]을 사용하여 원본 도메인 이미지를 타겟 도메인 이미지와 유사하게 변환하여 합성 도메인 $F$를 구성합니다. 이 $F$는 원본 $S$와는 이미지 내용이 유사하고 외형만 다르며, 타겟 $T$와는 픽셀 수준 분포가 유사하여 $S$와 $T$ 사이에 위치하는 "다리" 역할을 합니다.
  - **적응 과정 (Adaptation Process):** 적응 문제는 두 단계로 분해됩니다:
    1. **1단계 ($S \to F$):** 레이블이 있는 원본 도메인 $S$를 합성 도메인 $F$에 적응시킵니다. 이 단계에서는 주로 픽셀 수준의 외형 차이에 대한 특징 정렬에 집중합니다.
    2. **2단계 ($F \to T$):** 합성 도메인 $F$를 레이블이 없는 타겟 도메인 $T$에 적응시킵니다. $F$의 레이블은 $S$에서 상속받으며, 1단계에서 학습된 외형 불변 특징을 활용하여 객체 및 맥락 분포 적응에 집중합니다.
  - **가중치화된 감독 학습 (Weighted Supervision):**
    - CycleGAN으로 생성된 합성 이미지의 품질은 다양하며, 품질이 낮은 이미지는 이상치(outliers)로 작용하여 탐지 모델을 혼란시킬 수 있습니다.
    - 이 문제를 완화하기 위해 CycleGAN의 판별자 $D_{\text{cycle}}$가 출력하는 타겟 도메인에 속할 확률을 활용하여 각 합성 이미지 $I_F$에 중요도 가중치 $w(I_F)$를 부여합니다.
      $$ w(I) = \begin{cases} D\_{\text{cycle}}(I), & \text{if } I \in F \\ 1, & \text{otherwise} \end{cases} $$
    - 이 가중치 $w(I_F)$는 2단계 적응 시 탐지 손실 함수 $L_{\text{det}}(I_F)$에 곱해져, 품질이 좋은 합성 샘플에 더 큰 가중치를 부여합니다. 최종 가중치화된 손실 함수는 다음과 같습니다:
      $$ \min*{E} \max*{D} L(I*F,I_T) = w(I_F)L*{\text{det}}(I*F) + \lambda*{\text{disc}} \left[ L_{\text{disc}}(E(I_F)) + L_{\text{disc}}(E(I_T)) \right] $$

## 📊 Results

제안된 방법은 세 가지 실제 시나리오에서 평가되었으며, 모든 경우에서 최신 방법 대비 우수한 성능을 보였습니다.

- **교차 카메라 적응 (KITTI $\to$ Cityscapes):** `car` 클래스 AP(Average Precision)를 기준으로 평가했으며, 기존 최신 방법보다 5.4% 높은 43.9% AP를 달성했습니다. 가중치화된 태스크 손실은 가중치를 사용하지 않는 경우보다 1.7% AP를 향상시켰습니다.
- **날씨 적응 (Cityscapes $\to$ Foggy Cityscapes):** 8개 클래스에 대한 mAP(mean Average Precision)를 기준으로 평가했으며, 기존 최신 방법들을 능가하는 36.9% mAP를 달성했습니다. 중간 도메인 사용 시 baseline 대비 10% mAP 향상을 보였습니다.
- **대규모 데이터셋 적응 (Cityscapes $\to$ BDD100k daytime):** 10개 클래스에 대한 mAP를 기준으로 평가했으며, 기존 baseline 대비 3.1% mAP 향상을 보이며 24.3% mAP를 달성했습니다.

전반적으로, 합성 도메인을 직접 증강하는 것보다 점진적 적응 전략과 가중치화된 태스크 손실을 함께 사용하는 것이 성능을 더욱 향상시키는 것으로 나타났습니다. t-SNE [34] 시각화 결과, 합성 도메인 특징이 원본과 타겟 도메인 특징 분포 사이에 위치하며 효과적인 중간 다리 역할을 함을 확인했습니다.

## 🧠 Insights & Discussion

- **복잡한 문제의 분해:** 도메인 간 간극이 클 때, 문제를 직접 해결하기보다 중간 도메인을 도입하여 두 개의 더 작은 하위 문제로 분해하는 점진적 적응 전략이 훨씬 효과적이라는 점을 보여줍니다. 이는 학습 안정성을 높이고 더 나은 최적화를 가능하게 합니다.
- **중간 도메인의 전략적 활용:** CycleGAN을 통해 생성된 합성 이미지를 단순한 데이터 증강이 아닌, 독립적인 중간 도메인으로 정의하고 활용하는 것이 핵심입니다. 이 중간 도메인은 원본과의 내용 유사성과 타겟과의 픽셀 수준 외형 유사성을 동시에 가지므로, 점진적 특징 정렬에 이상적인 다리 역할을 수행합니다.
- **합성 데이터 품질 관리:** 합성 이미지의 품질 불균형은 도메인 적응 학습에 부정적인 영향을 미칠 수 있습니다. 본 논문에서 제안하는 가중치화된 태스크 손실은 CycleGAN 판별자의 점수를 활용하여 각 합성 샘플의 중요도를 동적으로 조절함으로써 이 문제를 효과적으로 해결하고, 품질이 우수한 샘플에 더 큰 학습 비중을 부여합니다.
- **실용적 적용 가능성:** 교차 카메라, 날씨 변화, 작은 데이터셋에서 대규모 데이터셋으로의 적응 등 다양한 실제 시나리오에서 도메인 불일치 문제를 성공적으로 완화함으로써, 레이블링 비용을 절감하고 객체 탐지 모델의 실제 환경 일반화 능력을 크게 향상시킬 수 있는 잠재력을 보여줍니다.

## 📌 TL;DR

객체 탐지는 도메인 불일치(domain shift)에 취약하며, 큰 도메인 간극은 적응을 어렵게 합니다. 본 논문은 원본 도메인 이미지를 타겟 도메인처럼 변환한 **중간 합성 도메인($F$)**을 도입하여, 원본-타겟 도메인 적응 문제를 **원본 $\to$ 중간 ($S \to F$)** 및 **중간 $\to$ 타겟 ($F \to T$)**의 두 가지 점진적 하위 태스크로 분해하는 방법을 제안합니다. 또한, 합성 이미지 품질 불균형 문제를 해결하기 위해 CycleGAN 판별자 점수를 활용한 **가중치화된 태스크 손실**을 적용했습니다. 결과적으로, 제안된 점진적 적응 방법은 교차 카메라, 날씨 변화, 대규모 데이터셋 적응과 같은 다양한 실제 시나리오에서 기존 최신 방법들을 능가하는 객체 탐지 성능을 달성하며 도메인 불일치 문제를 효과적으로 완화합니다.
