# Curriculum Domain Adaptation for Semantic Segmentation of Urban Scenes

Yang Zhang, Philip David, and Boqing Gong

## 🧩 Problem to Solve

자율 주행과 같은 분야에서 핵심적인 태스크인 의미론적 분할(semantic segmentation)은 방대한 양의 고품질 주석 데이터가 필요합니다. 하지만 실제 이미지(예: Cityscapes)에 픽셀 단위 주석을 달기에는 엄청난 시간과 노력이 소요됩니다 (이미지당 1.5시간 이상). 컴퓨터 그래픽 기술의 발전으로 합성 데이터(예: SYNTHIA)를 자동 주석과 함께 생성하여 이 문제를 해결할 수 있지만, 실제 이미지와 합성 이미지 간의 시각적 **도메인 불일치(domain mismatch)**가 모델 성능을 크게 저하시킵니다.

기존 도메인 적응(domain adaptation) 연구는 주로 분류(classification)나 회귀(regression) 문제에 초점을 맞추었으며, 종종 변환된 특징 공간에서 소스 및 타겟 도메인이 동일한 예측 함수를 공유한다는 가정을 합니다. 하지만 의미론적 분할과 같은 구조화된 예측(structured prediction) 문제에서는 이러한 가정이 유효하지 않으며, 심층 신경망 기반 분할 모델의 경우 수용 필드가 겹치는 픽셀 단위 출력의 특성상 "인스턴스"를 명확히 정의하기도 어렵습니다. 따라서 실제 도시 장면의 의미론적 분할에서 도메인 간 격차를 효과적으로 줄이는 방법이 필요합니다.

## ✨ Key Contributions

- **커리큘럼 스타일 도메인 적응(Curriculum-style Domain Adaptation) 제안:** 쉬운 태스크를 먼저 해결하여 타겟 도메인에 대한 필요한 지식(속성)을 얻고, 이를 바탕으로 어려운 픽셀 단위 의미론적 분할 태스크를 효과적으로 지도하는 새로운 접근 방식을 제안합니다.
- **"쉬운" 태스크의 정의 및 활용:** 전역 이미지 레이블 분포(global image label distributions)와 랜드마크 슈퍼픽셀(landmark superpixels)의 지역 레이블 분포 추론을 "쉬운" 태스크로 정의하고, 이를 타겟 도메인 예측의 정규화(regularization)에 사용합니다.
- **가정 회피:** 소스 및 타겟 도메인이 변환된 특징 공간에서 동일한 예측 함수를 공유한다는 가정을 피하여 구조화된 예측 문제에 더 적합한 도메인 적응을 가능하게 합니다.
- **유연한 적용성:** 네트워크 아키텍처나 중간 계층을 변경하지 않고 손실 함수(loss function)만 수정하므로, 다양한 의미론적 분할 네트워크에 쉽게 적용할 수 있습니다.
- **최첨단 성능 달성:** 기존 베이스라인 및 동일한 문제에 대한 유일한 기존 접근 방식인 "FCNs in the Wild" [27]보다 Cityscapes 데이터셋에서 의미론적 분할 성능을 크게 향상시켰습니다.

## 📎 Related Works

- **도메인 적응 (Domain Adaptation):** 훈련 데이터와 테스트 데이터의 분포가 다른 경우 모델의 일반화 성능을 향상시키는 것을 목표로 합니다. 주로 분류 및 회귀 문제에 적용되었으며, 최근에는 심층 신경망의 적응성 향상 [36, 18, 17, 61]과 합성 데이터 활용 [56, 65, 48, 63, 27]에 대한 연구가 활발합니다.
- **의미론적 분할 (Semantic Segmentation):** 각 픽셀에 객체 레이블을 할당하는 태스크로, 초기에는 수동 설계된 특징 [52, 58]을 사용했지만, FCN [35] 도입 이후 대부분 CNN 기반 [64, 49, 3, 39]으로 발전했습니다. 데이터 주석의 어려움 때문에 약한 감독 학습 [44, 28]이나 합성 이미지 [47, 48]를 사용하는 방법이 모색되고 있습니다.
- **의미론적 분할을 위한 도메인 적응:** 저자들이 아는 한, 이 문제를 알고리즘적으로 다룬 유일한 기존 연구는 Hoffman et al.의 "FCNs in the Wild" [27]입니다. 이 연구는 픽셀 수준 적대적 손실(adversarial loss)을 중간 계층에 도입하고 네트워크 출력에 제약을 가하는 반면, 본 논문은 다른 커리큘럼 도메인 적응 전략을 제안합니다.

## 🛠️ Methodology

본 논문은 도시 장면의 의미론적 분할을 위한 커리큘럼 스타일 도메인 적응을 제안하며, 타겟 도메인의 픽셀 단위 레이블 $Y_t$의 필요한 속성을 모방하도록 분할 네트워크를 훈련합니다.

1. **"쉬운" 태스크 정의 및 타겟 속성 추론:**

   - **전역 이미지 레이블 분포($p_t^{img}$):** 이미지 전체에 걸쳐 각 카테고리의 픽셀 점유 비율을 나타내는 분포입니다.
     - **추론:** Inception-Resnet-v2 [57] 특징을 추출하고, 소스 도메인의 실제 레이블 분포로 훈련된 다항 로지스틱 회귀(Logistic Regression, LR) 모델을 사용하여 타겟 이미지의 레이블 분포를 예측합니다. 최근접 이웃(NN) 기반 방법도 비교합니다.
       $$ p*t(c) = \frac{1}{WH} \sum*{i=1}^{W} \sum\_{j=1}^{H} Y_t(i,j,c), \forall c $$
   - **랜드마크 슈퍼픽셀의 지역 레이블 분포($p_t^{sp}$):** 공간적 제약을 제공하기 위해 이미지 내 특정 "랜드마크" 슈퍼픽셀에 대한 레이블 분포를 사용합니다.
     - **슈퍼픽셀 분할:** 선형 스펙트럼 클러스터링(Linear Spectral Clustering) [33]을 사용하여 각 이미지를 100개의 슈퍼픽셀로 분할합니다.
     - **랜드마크 선택:** 소스 도메인의 슈퍼픽셀 특징(FCN-8s [35] 및 주변 슈퍼픽셀 정보로 구성)과 지배적인 레이블로 다중 클래스 SVM을 훈련합니다. 이 SVM을 사용하여 타겟 슈퍼픽셀의 분류 신뢰도를 얻고, 상위 60%를 랜드마크 슈퍼픽셀로 선정합니다. 이들의 예측된 클래스 레이블을 원-핫 벡터로 인코딩하여 레이블 분포로 사용합니다.

2. **의미론적 분할 네트워크 훈련:**
   - **네트워크 아키텍처:** FCN-8s [35]를 사용하며, VGG-19 [54]로 합성곱(convolutional) 계층을 초기화합니다.
   - **최적화 목표 함수:** 소스 도메인 $S$의 픽셀 단위 교차 엔트로피 손실 $L$과 타겟 도메인 $T$에서 추론된 속성 $p_t^k$와 네트워크 예측 $\hat{p}_t^k$ 간의 교차 엔트로피 손실 $C$를 결합합니다. $\gamma$는 두 손실 항의 균형을 조절하는 가중치입니다.
     $$ \min*{\gamma} \frac{1}{|S|} \sum*{s \in S} L(Y*s, \hat{Y}\_s) + \frac{1-\gamma}{|T|} \sum*{t \in T} \sum_k C(p_t^k, \hat{p}\_t^k) $$
   - 이 과정을 통해, 네트워크는 소스 데이터로부터 픽셀 수준 판별 능력을 학습하는 동시에, 타겟 도메인에서 예측이 추론된 전역 및 지역 레이블 분포 속성을 따르도록 유도됩니다.

## 📊 Results

실험은 SYNTHIA [48] (또는 GTA [47])를 소스 도메인으로, Cityscapes [12]를 타겟 도메인으로 사용하여 수행되었습니다. 평가는 Intersection-over-Union (IoU)을 기준으로 합니다.

- **전역 레이블 분포 추론 결과 (Table 1):**
  - 로지스틱 회귀(LR) 방법이 $\chi^2$ 거리 0.27로, 베이스라인(NoAdapt, 0.65)이나 최근접 이웃(NN, 0.33) 등 다른 방법들보다 가장 정확하게 타겟 도메인의 전역 레이블 분포를 추론했습니다. 이는 베이스라인 네트워크가 타겟 도메인에서 크게 불균형한 예측을 한다는 것을 확인시켜 줍니다.
- **의미론적 분할 결과 (Table 2, SYNTHIA $\to$ Cityscapes):**
  - **NoAdapt:** 22.0% IoU.
  - **FCN Wld [27]:** 20.2% IoU. 본 논문의 NoAdapt보다 낮은 수치로, 구현 및 실험 설정의 미묘한 차이 때문일 수 있습니다.
  - **Ours (I) (전역 이미지 분포만 사용):** 25.5% IoU. 베이스라인 대비 상당한 개선을 보였으며, 특히 도로와 보도 같은 불균형한 예측 오류를 수정하는 데 효과적이었습니다.
  - **Ours (SP) (랜드마크 슈퍼픽셀 지역 분포만 사용):** 28.1% IoU. 슈퍼픽셀 분류 자체(SP 25.6%, SP Lndmk 23.0%)보다 뛰어난 성능을 보였습니다. 하늘, 도로, 건물 등 큰 객체에 매우 정확하지만, 울타리, 신호등 등 작은 객체에는 취약했습니다.
  - **Ours (I+SP) (전역 이미지 + 지역 슈퍼픽셀 분포 병합):** **29.0% IoU로 모든 비교 방법 중 가장 높은 성능**을 달성했습니다. 전역 및 지역 분포가 서로 다른 강점을 보완하며 시너지 효과를 내는 것을 확인했습니다.
- **GTA $\to$ Cityscapes 추가 실험 (Table 3):**
  - SYNTHIA보다 사실적인 GTA 데이터를 소스로 사용했을 때, 전반적인 IoU 성능이 더 높게 나왔으며, 여전히 Ours (I+SP)가 28.9% IoU로 가장 좋은 성능을 보였습니다.
- **도메인 불변 특징 학습과의 비교:** Maximum Mean Discrepancy (MMD) [24]나 도메인 분류기 역전(gradient reversal) [17]과 같은 도메인 불변 특징 학습 방법은 베이스라인 대비 유의미한 성능 향상을 보이지 못했습니다.

## 🧠 Insights & Discussion

- **구조화된 예측의 특수성:** 의미론적 분할과 같은 구조화된 예측 문제에서는 변환된 특징 공간에서 두 도메인이 동일한 예측 함수를 공유한다는 가정이 유효하지 않을 수 있습니다. 본 연구의 커리큘럼 접근 방식은 이러한 가정을 피함으로써 효과적인 도메인 적응을 가능하게 했습니다.
- **커리큘럼 학습의 유효성:** 픽셀 단위 레이블 할당보다 쉬운 태스크(예: 이미지 및 슈퍼픽셀의 레이블 분포 추론)를 통해 타겟 도메인의 고수준 속성을 먼저 파악하고, 이를 분할 네트워크의 예측을 정규화하는 데 사용하는 전략은 매우 효과적이었습니다. 이는 타겟 도메인에 대한 "건전성 검사(sanity check)" 역할을 하여, 네트워크가 도메인 불일치로 인해 발생할 수 있는 비정상적인 예측(예: 불균형한 클래스 비율)을 피하도록 돕습니다.
- **전역 및 지역 정보의 상호 보완성:** 전역 이미지 레이블 분포는 이미지 전반의 클래스 비율 불균형을 교정하는 데 효과적인 반면, 지역 랜드마크 슈퍼픽셀 레이블 분포는 공간적 제약을 제공합니다. 이 두 가지 유형의 분포가 서로 다른 종류의 객체(작은 객체 vs. 큰 객체)에 대해 보완적인 역할을 하여, 함께 사용했을 때 최상의 성능을 달성했습니다.
- **간편한 적용:** 기존 심층 도메인 적응 방법들이 중간 계층에 정규화를 도입하는 것과 달리, 본 연구는 출력 계층의 손실 함수만 수정하므로 다른 분할 네트워크에 쉽게 통합될 수 있는 장점이 있습니다.
- **향후 연구:** 현재의 "쉬운" 태스크 외에, 작은 객체들을 더 잘 다룰 수 있는 다른 타겟 속성(예: 레이블 분포 형태)을 탐색하여 커리큘럼 도메인 적응 프레임워크를 더욱 풍부하게 할 수 있을 것입니다.

## 📌 TL;DR

합성 데이터(SYNTHIA, GTA)로 훈련된 의미론적 분할 모델이 실제 도시 장면(Cityscapes)에서 도메인 불일치로 인해 성능이 저하되는 문제를 해결하기 위해, 본 논문은 **커리큘럼 스타일 도메인 적응** 방법을 제안합니다. 이 방법은 전역 이미지 레이블 분포와 랜드마크 슈퍼픽셀의 지역 레이블 분포를 추론하는 "쉬운" 태스크를 먼저 수행하여 타겟 도메인의 고수준 속성을 파악합니다. 이 지식을 사용하여 픽셀 단위 분할 네트워크의 예측을 정규화함으로써, 베이스라인 및 기존 도메인 적응 방법(FCNs in the Wild)보다 Cityscapes 데이터셋에서 **IoU 성능을 22.0%에서 29.0%로 크게 향상**시켰습니다.
