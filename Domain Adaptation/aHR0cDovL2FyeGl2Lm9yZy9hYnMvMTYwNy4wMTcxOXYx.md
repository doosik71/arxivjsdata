# Deep CORAL: Correlation Alignment for Deep Domain Adaptation

Baochen Sun, Kate Saenko

---

## 🧩 Problem to Solve

심층 신경망(Deep Neural Networks)은 대량의 레이블링된 데이터로부터 강력한 표현을 학습할 수 있지만, 입력 데이터 분포가 변하는(도메인 시프트) 경우 일반화 성능이 저하될 수 있습니다. 특히, 타겟 도메인의 레이블링된 데이터가 없는 **비지도 도메인 적응(Unsupervised Domain Adaptation)** 상황에서 이러한 성능 저하를 보상하는 것이 주요 문제입니다. 기존 CORAL(Correlation Alignment) 방법은 2차 통계량(공분산)을 선형 변환으로 정렬하지만, 심층 신경망에 직접 통합되지 못하고 특징 추출, 변환, 분류기 학습이 개별적으로 이루어지는 한계가 있었습니다.

## ✨ Key Contributions

- **비선형 변환 학습**: 기존 CORAL을 확장하여 심층 신경망 활성화의 상관관계를 정렬하는 비선형 변환을 학습하는 Deep CORAL을 제안합니다.
- **미분 가능한 손실 함수 도입**: 소스 및 타겟 도메인 간의 상관관계 차이를 최소화하는 미분 가능한 CORAL 손실 함수를 개발하여 심층 신경망에 직접 통합될 수 있도록 했습니다.
- **엔드-투-엔드(End-to-End) 도메인 적응**: CORAL 손실을 분류 손실과 함께 최적화함으로써, 판별력이 있으면서도 도메인 불변적인 특징을 엔드-투-엔드 방식으로 학습할 수 있습니다.
- **최첨단 성능 달성**: 표준 벤치마크 데이터셋에서 최첨단(state-of-the-art) 성능을 달성하여 제안 방법의 효과를 입증했습니다.

## 📎 Related Works

- **가중치 재조정 기반(Re-weighting based) 접근법**: 훈련 데이터 손실에 가중치를 부여하여 테스트 분포를 반영 [11,12].
- **측지선 방법(Geodesic methods)**: 소스 및 타겟 도메인을 측지 경로를 따라 투영 [13,7] (예: GFK [7]).
- **부분공간 정렬(Subspace alignment)**: 부분공간 간의 선형 맵을 계산하여 정렬 [14,8] (예: SA [8], TCA [22]).
- **CORAL [1]**: 소스 및 타겟 분포의 2차 통계량을 정렬하여 도메인 시프트를 최소화하는 "매우 쉬운" 비지도 도메인 적응 방법.
- **적응형 심층 신경망(Adaptive Deep Neural Networks)**:
  - DLID [15]: 두 개의 적응 레이어를 가진 CNN 아키텍처 훈련.
  - DDC [16]: 단일 선형 커널을 적용하여 MMD(Maximum Mean Discrepancy) 최소화.
  - DAN [17]: 여러 커널을 여러 레이어에 적용하여 MMD 최소화.
  - ReverseGrad [18]: 이진 분류기를 추가하여 두 도메인을 명시적으로 혼동.

## 🛠️ Methodology

Deep CORAL은 심층 신경망 내에서 소스 및 타겟 특징 활성화의 2차 통계량(공분산) 차이를 최소화하는 것을 목표로 합니다.

1. **CORAL 손실 정의**:

   - 주어진 소스 데이터 $D_S = \{x_i\}$와 타겟 데이터 $D_T = \{u_i\}$ (각각 $n_S$, $n_T$ 개)에 대해, 각 데이터는 $d$차원 심층 레이어 활성화 $\phi(I)$를 나타냅니다.
   - 소스 및 타겟 특징의 공분산 행렬 $C_S$와 $C_T$를 계산합니다.
   - CORAL 손실 $\mathcal{L}_{\text{CORAL}}$은 이들 공분산 행렬의 차이에 대한 프로베니우스 노름(Frobenius norm)의 제곱으로 정의됩니다:
     $$ \mathcal{L}\_{\text{CORAL}} = \frac{1}{4d^2} \|C_S - C_T\|^2_F $$
   - 공분산 행렬은 다음과 같이 계산됩니다:
     $$ C_S = \frac{1}{n_S-1} (D^{\top}\_S D_S - \frac{1}{n_S}(\mathbf{1}^{\top}D_S)^{\top}(\mathbf{1}^{\top}D_S)) $$
        $$ C_T = \frac{1}{n_T-1} (D^{\top}\_T D_T - \frac{1}{n_T}(\mathbf{1}^{\top}D_T)^{\top}(\mathbf{1}^{\top}D_T)) $$
        여기서 $\mathbf{1}$은 모든 요소가 1인 열 벡터입니다.
   - CORAL 손실은 입력 특징에 대해 미분 가능하며, 역전파를 통해 신경망 파라미터를 업데이트할 수 있습니다.

2. **엔드-투-엔드 도메인 적응**:

   - 최종 심층 특징이 판별력(discriminative)과 도메인 불변성(domain-invariant)을 모두 갖도록, 분류 손실과 CORAL 손실을 함께 최소화합니다.
   - 총 손실 함수는 다음과 같습니다:
     $$ \mathcal{L} = \mathcal{L}_{\text{CLASS.}} + \sum_{i=1}^{t} \lambda*i \mathcal{L}*{\text{CORAL}}^{(i)} $$
        여기서 $\mathcal{L}_{\text{CLASS.}}$는 분류 손실, $\mathcal{L}_{\text{CORAL}}^{(i)}$는 $i$번째 CORAL 손실 레이어의 손실, $t$는 CORAL 손실 레이어의 수, $\lambda_i$는 적응과 분류 정확도 간의 균형을 조절하는 가중치입니다.
   - 훈련 초반에는 분류 손실이 크고 CORAL 손실이 작지만, 훈련이 진행됨에 따라 두 손실이 균형을 이루며 타겟 도메인에서 잘 작동하는 특징을 학습합니다.

3. **구현**:
   - CORAL 손실은 AlexNet의 `fc8`과 같은 완전 연결(fully connected) 레이어에 적용될 수 있으며, 다른 레이어나 네트워크 아키텍처에도 쉽게 통합 가능합니다.
   - ImageNet으로 사전 훈련된 파라미터로 네트워크를 초기화하고, 소스 데이터에 대해 파인튜닝하며 CORAL 손실을 적용합니다.

## 📊 Results

- **데이터셋**: 표준 도메인 적응 벤치마크인 Office 데이터셋(Amazon, DSLR, Webcam 3개 도메인)의 6가지 도메인 시프트에서 평가했습니다.
- **비교 대상**: CNN (적응 없음), GFK, SA, TCA, CORAL, DDC, DAN 등 7가지 최신 방법과 비교했습니다.
- **성능**: Deep CORAL (D-CORAL)은 평균 72.1%의 객체 인식 정확도를 달성하여 모든 6가지 도메인 시프트에서 기존 CORAL(70.4%) 및 다른 모든 베이스라인 방법보다 뛰어난 성능을 보였습니다. 6가지 시프트 중 3가지에서 최고 정확도를 기록했으며, 나머지 3가지에서도 최고 성능과 매우 근소한 차이를 보였습니다.
- **효과 검증**:
  - CORAL 손실을 추가하면 타겟 도메인에서 훨씬 더 나은 성능을 달성하면서 소스 도메인에서 강력한 분류 정확도를 유지하는 것을 확인했습니다 (A→W 시프트에 대한 상세 분석).
  - CORAL 손실을 적용하지 않으면 소스 및 타겟 도메인 간의 공분산 거리가 100배 이상 크게 증가하는 것을 보였습니다. 이는 도메인 적응 없이는 특징이 소스 도메인에 과적합되기 쉽다는 것을 시사합니다.
  - 훈련 과정에서 분류 손실과 CORAL 손실이 점차적으로 균형을 이루며, 최종 특징이 타겟 도메인에서 잘 작동하는 "평형(equilibrium)" 상태에 도달합니다.

## 🧠 Insights & Discussion

- Deep CORAL은 기존 CORAL의 선형 한계를 극복하고, 심층 신경망의 강력한 표현력을 활용하여 비선형적인 도메인 적응을 가능하게 합니다.
- 미분 가능한 CORAL 손실을 심층 네트워크에 직접 통합함으로써, 특징 추출부터 적응, 분류까지 전체 과정을 엔드-투-엔드로 학습할 수 있어 효율적이고 강력한 성능을 제공합니다.
- 분류 손실과 CORAL 손실의 공동 최적화는 특징이 특정 작업에 대해 판별력을 유지하면서도 도메인 시프트에 강인하도록 만드는 핵심적인 역할을 합니다. 이는 특징 공간에서 도메인 간의 거리를 제약하는 동시에 유용한 특징을 학습하게 합니다.
- DDC나 DAN과 같은 다른 심층 도메인 적응 방법과 비교했을 때, Deep CORAL은 MMD를 다항식 커널로 최소화하는 것과 유사하지만, 최적화가 더 간단하며 다양한 레이어나 아키텍처에 쉽게 통합될 수 있다는 장점이 있습니다.
- 제시된 방법은 비지도 도메인 적응 시나리오에서 광범위하게 적용될 수 있는 잠재력을 가집니다.

## 📌 TL;DR

Deep CORAL은 심층 신경망에서 비지도 도메인 적응을 위한 엔드-투-엔드 방법으로, 소스 및 타겟 도메인 간의 2차 통계량(공분산) 차이를 최소화하는 미분 가능한 CORAL 손실을 도입합니다. 분류 손실과 CORAL 손실을 함께 최적화함으로써, 모델은 판별력이 있으면서도 도메인 불변적인 특징을 학습하여 도메인 시프트 상황에서 뛰어난 성능을 발휘합니다. 표준 벤치마크 실험에서 기존 방법들을 능가하는 최첨단 성능을 달성했습니다.
