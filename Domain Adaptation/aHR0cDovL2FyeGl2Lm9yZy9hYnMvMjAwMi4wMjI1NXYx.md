# Unsupervised Bidirectional Cross-Modality Adaptation via Deeply Synergistic Image and Feature Alignment for Medical Image Segmentation

Cheng Chen, Qi Dou, Hao Chen, Jing Qin, Pheng Ann Heng

## 🧩 Problem to Solve

심층 신경망은 의료 영상 분야에서 학습 데이터와 다른 특성을 가진(domain shift) 새로운 데이터에 적용될 때 성능 저하를 겪습니다. 특히 MRI와 CT와 같은 교차 모달리티(cross-modality) 영상은 시각적 특성이 크게 달라, 한 모달리티로 학습된 모델이 다른 모달리티에서 제대로 작동하지 않습니다. 각 새로운 모달리티에 대해 데이터를 수동으로 레이블링하는 것은 비용이 많이 들거나 불가능하므로, 레이블링되지 않은 타겟 도메인에서도 효과적으로 작동하는 비지도 도메인 적응(unsupervised domain adaptation) 방법론이 필요합니다.

## ✨ Key Contributions

- **시너지 학습 프레임워크 SIFA 제안**: 의료 영상 분할을 위한 비지도 도메인 적응 문제 해결을 위해 이미지 정렬(Image Alignment)과 특징 정렬(Feature Alignment)을 시너지 효과적으로 결합한 새로운 프레임워크 SIFA(Synergistic Image and Feature Alignment)를 제안합니다.
- **강화된 특징 정렬**: 적대적 학습(adversarial learning)을 사용하여 의미론적 예측 공간(semantic prediction space)과 생성된 이미지 공간(generated image space)의 두 가지 관점에서 특징 정렬을 강화하고, 깊이 감독 메커니즘(deeply supervised mechanism)을 통합하여 적응 성능을 향상시켰습니다.
- **양방향 교차 모달리티 적응 검증**: 심장 하위 구조 및 복부 다기관 분할이라는 두 가지 다중 클래스 분할 태스크에서 MRI-CT 및 CT-MRI 양방향 교차 모달리티 적응에 대한 광범위한 실험을 수행하여, 제안된 방법이 레이블링되지 않은 타겟 이미지에서 분할 성능을 크게 향상시키고 최신(state-of-the-art) 방법론들을 능가함을 입증했습니다.

## 📎 Related Works

- **이미지 정렬 (Image Alignment)**: CycleGAN [8], Bousmalis et al. [11], Zhang et al. [10] 등은 CycleGAN 프레임워크 기반으로 소스 이미지를 타겟 도메인처럼 보이게 변환하여 도메인 간 시각적 차이를 줄입니다. SynSeg-Net [37] 및 Jiang et al. [36]는 의료 영상에 적용했습니다.
- **특징 정렬 (Feature Alignment)**: Ganin et al. [13], Tzeng et al. [14] 등은 적대적 학습을 통해 도메인 불변 특징을 추출합니다. Tsai et al. [15]는 의미론적 예측 공간, Sankaranarayanan et al. [16]는 이미지 공간에서 특징 정렬을 수행했습니다. Dou et al. [6], [7]은 의료 영상에 적용하여 특징 분포를 정렬했습니다.
- **이미지 및 특징 정렬 혼합**: CyCADA [18]와 Zhang et al. [19]는 이미지 및 특징 정렬을 결합했지만, 본 논문에서는 순차적이고 상호작용이 없는 방식이라는 한계를 지적합니다. 본 연구는 이 두 가지 접근 방식을 시너지 효과적으로 통합합니다.

## 🛠️ Methodology

SIFA 프레임워크는 이미지 정렬과 특징 정렬을 공유 인코더 $E$를 통해 엔드-투-엔드(end-to-end)로 통합하여 상호 이점을 활용합니다.

1. **외관 변환을 통한 이미지 정렬 (Appearance Transformation for Image Alignment)**:

   - **생성적 적대 신경망(GAN)**: 소스 이미지 $x_s$를 타겟 도메인과 유사한 $x_{s \to t}$로 변환하는 생성자 $G_t$와 이를 실제 타겟 이미지 $x_t$와 구별하는 판별자 $D_t$를 사용합니다.
   - **사이클 일관성 손실 ($L_{cyc}$)**: 변환된 이미지의 내용과 구조적 의미를 유지하기 위해 역방향 생성자 $G_s = E \circ U$ (인코더 $E$와 디코더 $U$로 구성)를 사용하여 $x_{s \to t}$를 다시 소스 도메인으로 재구성합니다.
   - **분할 네트워크 학습**: $E$와 픽셀 단위 분류기 $C$로 구성된 분할 네트워크 $E \circ C$는 변환된 이미지 $x_{s \to t}$와 소스 레이블 $y_s$를 사용하여 하이브리드 손실 $L_{seg}$ (크로스 엔트로피 + Dice 손실)로 학습됩니다.

2. **적대적 학습을 통한 특징 정렬 (Adversarial Learning for Feature Alignment)**:

   - **의미론적 예측 공간에서의 특징 정렬**: $E \circ C$의 분할 예측 마스크를 대상으로 판별자 $D_p$를 사용하여 $x_{s \to t}$와 $x_t$에서 추출된 특징의 예측을 구별합니다.
   - **깊이 감독 적대적 학습**: 저수준 특징 정렬을 강화하기 위해 인코더의 하위 계층 출력에 추가 픽셀 분류기 $C_2$와 판별자 $D_{p2}$를 연결합니다. 전체적으로 두 개의 분류기 ($C_1, C_2$)와 판별자 ($D_{p1}, D_{p2}$)를 사용합니다.
   - **생성된 이미지 공간에서의 특징 정렬**: 역방향 생성자 $E \circ U$에서 생성된 소스 유사 이미지 ($U(E(x_{s \to t}))$ 및 $U(E(x_t))$)의 도메인을 판별자 $D_s$가 구별하도록 하여 특징이 도메인 불변성을 가지도록 유도합니다.

3. **시너지 학습을 위한 공유 인코더 (Shared Encoder for Synergistic Learning)**:
   - 인코더 $E$는 이미지 정렬 (사이클 일관성 $L_{cyc}$, 소스 도메인 적대적 손실 $L_{s\_adv}$)과 특징 정렬 (판별자 $D_p$, $D_s$로부터의 역전파) 모두에 사용됩니다.
   - 이는 다중 작업 학습 시나리오를 가능하게 하여 인코더가 여러 목적에 유용한 일반적이고 견고한 표현을 학습하도록 돕습니다.
   - 전체 프레임워크는 엔드-투-엔드 방식으로 학습되며, 각 모듈은 특정 순서로 업데이트됩니다.
   - 최종 목적 함수는 다음과 같습니다:
     $$L = L_{t}^{adv}(G_t,D_t) + \lambda_{s}^{adv}L_{s}^{adv}(E,U,D_s) + \lambda_{cyc}L_{cyc}(G_t,E,U) + \lambda_{1}^{seg}L_{1}^{seg}(E,C_1) + \lambda_{2}^{seg}L_{2}^{seg}(E,C_2) + \lambda_{p1}^{adv}L_{p1}^{adv}(E,C,D_{p1}) + \lambda_{p2}^{adv}L_{p2}^{adv}(E,C,D_{p2}) + \lambda_{\tilde{s}}^{adv}L_{\tilde{s}}^{adv}(E,D_s)$$

## 📊 Results

- **데이터셋**: 심장 하위 구조 분할 (MMWHS Challenge 2017) 및 복부 다기관 분할 (ISBI 2019 CHAOS, 공용 CT 데이터)에 대해 평가했습니다.
- **성능 저하 및 SIFA의 개선 효과**:
  - 어떤 적응도 없이 모델을 직접 적용했을 때, 심장 MRI$\to$CT 적응의 경우 평균 Dice가 17.2%에 불과했고, 복부 MRI$\to$CT 적응은 58.2%였습니다.
  - SIFA는 심장 MRI$\to$CT 적응에서 평균 Dice를 74.1%로, 복부 MRI$\to$CT 적응에서 83.7%로 크게 향상시켰습니다.
  - 복부 분할에서는 SIFA의 결과가 지도 학습(supervised training) 상한선에 매우 근접하여 Dice는 5% 포인트, ASD는 0.1 차이밖에 나지 않았습니다.
- **최신 방법론 대비 우수성**: PnP-AdaNet [44], SynSeg-Net [37], AdaOutput [15], CycleGAN [8], CyCADA [18] 등 다른 최신 비지도 도메인 적응 방법론보다 일관되게 우수한 성능을 보였습니다. 특히 이미지 및 특징 정렬을 모두 사용하는 CyCADA보다 SIFA가 더 뛰어난 성능을 보였습니다.
- **핵심 구성 요소의 기여**:
  - 이미지 정렬만 사용했을 때 평균 Dice가 58.0%로 크게 향상되었습니다.
  - 의미론적 예측 공간에서의 깊이 감독 특징 정렬(FA-P)을 추가했을 때 67.7%로 증가했습니다.
  - 생성된 이미지 공간에서의 특징 정렬(FA-I)까지 추가한 SIFA 최종 모델은 74.1%의 평균 Dice를 달성하여 각 구성 요소의 시너지 효과를 입증했습니다.
  - 본 연구에서 도입된 깊이 감독 메커니즘은 이전 SIFA 버전 [20] 대비 성능을 추가로 향상시켰습니다.

## 🧠 Insights & Discussion

- **비지도 도메인 적응의 잠재력**: SIFA는 추가 레이블링 없이도 심각한 성능 저하를 크게 줄이고, 일부 태스크에서는 지도 학습에 거의 근접한 분할 성능을 달성할 수 있음을 보여줍니다. 이는 실용적인 가치가 매우 높습니다.
- **태스크 난이도 및 데이터 품질의 영향**: 심장 분할은 복부 기관 분할보다 성능 격차가 더 컸는데, 이는 심장 구조 자체의 낮은 대비 및 불균일한 영상 품질 때문으로 분석됩니다. 도메인 적응의 난이도가 태스크 자체와 데이터 품질에 더 크게 좌우될 수 있음을 시사합니다.
- **양방향 적응의 가능성**: MRI$\leftrightarrow$CT 양방향 적응이 모두 가능하며, 적응의 난이도는 방향보다는 태스크의 본질에 더 달려있을 수 있다는 새로운 발견을 제시합니다.
- **한계점**:
  - 2D 네트워크를 사용하여 3D 볼륨 데이터를 처리했습니다. 복잡한 3D 프레임워크는 메모리 및 학습 비용이 매우 높아 향후 연구 과제입니다.
  - 소스 및 타겟 도메인의 데이터 양이 상대적으로 균형 잡혀 있었으며, 불균형하거나 제한된 타겟 도메인 데이터에 대한 적응 연구는 향후 과제입니다.
- **네트워크 아키텍처 유연성**: CycleGAN과 ResNet 기반의 아키텍처를 사용했지만, U-Net과 같은 다른 의료 영상 분할 네트워크도 통합될 수 있음을 시사합니다.

## 📌 TL;DR

본 논문은 의료 영상 분할에서 **교차 모달리티 도메인 시프트 문제**를 해결하기 위해 **시너지 이미지 및 특징 정렬(SIFA)**이라는 새로운 비지도 도메인 적응 프레임워크를 제안합니다. SIFA는 **공유 인코더**를 통해 **이미지 외관 변환**과 **깊이 감독 적대적 특징 정렬**을 엔드-투-엔드로 통합하여 시너지 효과를 창출합니다. 심장 및 복부 분할 태스크에서 **MRI$\leftrightarrow$CT 양방향 적응**을 통해, SIFA가 기존 최신 방법들을 **크게 능가**하며, 특히 복부 분할에서는 **지도 학습 상한선에 매우 근접한 성능**을 달성함을 입증했습니다.
