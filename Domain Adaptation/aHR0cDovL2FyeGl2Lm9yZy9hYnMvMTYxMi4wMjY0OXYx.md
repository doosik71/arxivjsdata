# FCNs in the Wild: Pixel-level Adversarial and Constraint-based Adaptation

Judy Hoffman, Dequan Wang, Fisher Yu, Trevor Darrell

## 🧩 Problem to Solve

시맨틱 분할(Semantic Segmentation) 모델은 동일한 데이터 소스에서 학습 및 평가될 때 성능이 향상되고 있지만, 서로 다른 도메인(예: 학습 도시와 다른 도시, 시뮬레이션 환경과 실제 환경) 간의 **도메인 이동(domain shift)**이 발생하면 픽셀 수준의 분포 변화로 인해 성능이 크게 저하될 수 있습니다. 특히 픽셀 단위 주석은 수집하는 데 비용이 많이 들고 번거롭기 때문에, 주석 없는 **타겟 도메인(target domain)**으로 모델을 효과적으로 **도메인 적응(domain adaptation)**시키는 비지도 학습 방법이 필요합니다.

## ✨ Key Contributions

- **최초의 시맨틱 분할을 위한 비지도 도메인 적응 방법론:** 픽셀 예측 문제에 대한 비지도 적대적 접근 방식을 제시하여 시맨틱 분할 모델에 도메인 적응 기법을 도입한 첫 번째 연구입니다.
- **전역 및 카테고리별 적응 기법 결합:** 전역 도메인 정렬(global domain alignment)과 카테고리별 적응(category specific adaptation)을 결합하여 도메인 이동의 두 가지 주요 원인을 모두 해결합니다.
- **완전 컨볼루션 도메인 적대적 학습 (FCDA) 도입:** 픽셀 수준의 밀집 예측(dense prediction)을 위해 설계된 새로운 도메인 적대적 학습(domain adversarial learning) 접근 방식을 통해 전역 도메인 정렬을 수행합니다. 이는 이전 이미지 수준 분류 접근 방식을 확장한 것입니다.
- **제약 기반 약한 학습(constrained weak learning)의 일반화:** 소스 도메인에서 타겟 도메인으로 공간 레이아웃(spatial layout) 정보를 명시적으로 전달하는 제약 조건이 있는 다중 인스턴스 손실(Multiple Instance Loss, MIL)을 통해 카테고리별 적응을 가능하게 합니다.
- **다양한 대규모 데이터셋에서의 성능 입증:** 실제 도시 환경 간, 다양한 합성 하위 도메인 간, 시뮬레이션 환경에서 실제 환경으로의 적응 등 여러 설정에서 기존 베이스라인을 능가하는 성능을 보여줍니다.
- **새로운 대규모 대시캠 데이터셋(BDDS) 소개:** Berkeley Deep Driving Segmentation (BDDS)이라는 비제약적(unconstrained) 대시캠 데이터셋을 새롭게 공개했습니다.

## 📎 Related Works

- **시맨틱 분할:** FCNs [20], Dilated Convolution [33], CRFs [1, 19, 34]를 포함한 컨볼루션 네트워크 아키텍처를 활용한 많은 연구가 진행되었습니다. 픽셀 수준 주석의 높은 비용 때문에 이미지 수준 태그와 같은 **약한 레이블(weak labels)**을 활용한 다중 인스턴스 학습 (MIL) [26, 27, 24, 25, 15] 연구가 있었으나, 본 연구는 타겟 도메인에 약한 레이블조차 없는 비지도 시나리오를 다룹니다.
- **도메인 적응:** 주로 이미지 분류 작업 [30, 17, 8]에 집중되었으며, 적대적 학습 [32, 6, 7]이나 분포 거리 최소화 [21, 22], GAN 기반 [18] 접근 방식들이 있었습니다. 탐지(detection) 작업 [11, 12, 13]에 대한 연구도 있었으나, 시맨틱 분할에 특화된 도메인 적응 방법론은 이 논문이 처음입니다.

## 🛠️ Methodology

본 논문은 완전 컨볼루션 네트워크(FCN)를 활용한 시맨틱 분할 모델의 **비지도 도메인 적응 프레임워크**를 제안합니다. 이 프레임워크는 소스 및 타겟 도메인 간의 **전역(global) 및 카테고리별(category specific) 도메인 이동**을 동시에 해결합니다.

전체 학습 목표는 다음과 같습니다:
$$L(I_S,L_S,I_T) = L_{seg}(I_S,L_S) + L_{da}(I_S,I_T) + L_{mi}(I_T,P_{L_S})$$
여기서 $L_{seg}$는 소스 도메인에 대한 표준 지도 학습 손실, $L_{da}$는 전역 도메인 정렬 손실, $L_{mi}$는 카테고리별 적응 손실입니다.

1. **전역 도메인 정렬 (Global Domain Alignment, $L_{da}$):**

   - **완전 컨볼루션 도메인 적대적 학습(FCDA)**을 사용합니다. 기존의 이미지 단위 도메인 분류와 달리, 최종 표현 계층(예: $fc_7$)의 각 공간 단위(spatial unit)에 해당하는 **수용 필드(receptive field) 영역**을 개별 인스턴스로 간주합니다.
   - **절차:**
     1. **도메인 분류기 학습:** 도메인 분류기 $\theta_D$를 학습하여 소스 도메인 $R^S_{hw} = \phi^{\ell-1}(\theta,I_S)_{hw}$와 타겟 도메인 $R^T_{hw} = \phi^{\ell-1}(\theta,I_T)_{hw}$의 픽셀 수준 표현을 구분하도록 $L_D$를 최소화합니다:
        $$\min_{\theta_D} L_D = - \sum_{I_S \in S} \sum_{h,w} \log(p_{\theta_D}(R^S_{hw})) - \sum_{I_T \in T} \sum_{h,w} \log(1-p_{\theta_D}(R^T_{hw}))$$
     2. **표현 공간 학습:** 도메인 분류기를 혼란스럽게 하여 소스-타겟 도메인 간의 거리를 최소화하도록 네트워크 파라미터 $\theta$를 업데이트합니다. 이는 $L_D$의 역 목표인 $L_{Dinv}$를 사용하여 달성됩니다:
        $$\min_\theta \frac{1}{2} [L_D + L_{Dinv}]$$
        $L_{Dinv}$는 타겟 도메인 예측 확률을 높이고 소스 도메인 예측 확률을 낮추는 방향으로 학습됩니다.

2. **카테고리별 적응 (Category Specific Adaptation, $L_{mi}$):**
   - **제약 기반 다중 인스턴스 학습(Constrained Multiple Instance Learning)**을 일반화하여 사용합니다. 소스 도메인에서 학습된 공간 레이아웃 정보를 주석 없는 타겟 도메인으로 이전합니다.
   - **절차:**
     1. **소스 도메인 픽셀 통계 계산 ($P_{L_S}$):** 각 클래스 $c$에 대해 소스 이미지에서 해당 클래스가 차지하는 픽셀 비율의 분포를 계산하고, 하위 10%($\alpha_c$), 평균($\delta_c$), 상위 10%($\gamma_c$) 경계를 추출합니다.
     2. **타겟 이미지 수준 레이블 예측:** 타겟 이미지 $I_T$에 대해 현재 모델의 출력 $p=\text{argmax } \phi(\theta,I_T)$에서 각 클래스 $c$의 픽셀 비율 $d_c$를 계산합니다. 만약 $d_c > 0.1 \cdot \alpha_c$ 이면 해당 클래스가 이미지에 존재한다고 간주하여 약한 이미지 수준 레이블을 할당합니다.
     3. **제약 조건 적용:** 예측된 이미지 수준 레이블이 있는 클래스에 대해, 타겟 이미지의 픽셀 예측 $p_{hw}(c)$가 소스 도메인에서 관찰된 예상 범위 내에 있도록 제약 조건을 적용합니다:
        $$\delta_c \le \sum_{h,w} p_{hw}(c) \le \gamma_c$$
        하한에는 이상치(outlier)를 허용하기 위한 슬랙(slack)이 적용되지만, 상한에는 적용되지 않아 특정 클래스가 너무 많은 영역을 차지하는 것을 방지합니다.
     4. **클래스 불균형 조정:** 픽셀 수가 많은 'stuff' 카테고리가 학습에 과도하게 영향을 미치는 것을 방지하기 위해, $\alpha_c > 0.1$인 클래스에 대한 그레디언트(gradient)를 0.1배로 줄여 가중치를 낮춥니다.

- **기반 모델:** 모든 실험에서 팽창 컨볼루션(dilated convolution)을 사용하는 FCN [33] (VGGNet [31] 기반)을 초기화 및 베이스라인 모델로 사용했습니다.

## 📊 Results

- **대규모 도메인 이동: 합성(Synthetic)에서 실제(Real)로 적응 (GTA5/SYNTHIA → Cityscapes)**
  - 소스(GTA5)에서 타겟(Cityscapes)으로 적응 시, 베이스라인 FCN 대비 GA(Global Alignment)만 적용해도 mIoU가 4.4% 향상되었으며, CA(Category Specific Adaptation)까지 적용하면 추가로 1.6% 향상되어 총 6.0%의 성능 향상을 보였습니다. SYNTHIA에서 Cityscapes로의 적응에서도 측정 가능한 개선을 달성했습니다.
- **중간 규모 도메인 이동: 계절 간 적응 (SYNTHIA Seasons)**
  - 평균적으로 약 3%의 mIoU 개선을 보였으며, 13개 카테고리 중 12개에서 성능이 향상되었습니다. 'car' 클래스는 합성 데이터셋 내에서 계절에 따른 외형 변화가 거의 없어 개선이 없었습니다. 'road'와 같이 외형 변화가 큰 카테고리에서는 가장 큰 성능 향상을 보였습니다.
- **작은 규모 도메인 이동: 도시 간 적응 (Cityscapes train → Cityscapes val)**
  - 주로 GA를 통해 3.6%의 mIoU 개선을 달성했으며, CA는 'traffic light', 'rider', 'train'과 같은 특정 카테고리에서만 눈에 띄는 추가 개선을 보였습니다. 이는 도시 간 도메인 이동의 주요 원인이 전역적인 외형 변화 때문이며, 특정 카테고리의 외형 변화는 상대적으로 적기 때문으로 분석됩니다.
- **BDDS 데이터셋 적응 (Cityscapes → BDDS)**
  - 새롭게 소개된 대규모 대시캠 데이터셋인 BDDS(Berkeley Deep Driving Segmentation)에 Cityscapes에서 학습된 모델을 직접 적용하면 심각한 품질 저하(노이즈 또는 잘못된 맥락)가 발생했습니다. 제안된 적응 방법론을 적용한 후에는 분할 결과가 훨씬 깨끗해지는 것을 질적으로 확인했습니다. (정량적 평가는 주석 준비 후 진행 예정)

## 🧠 Insights & Discussion

- 본 연구는 시맨틱 분할과 같은 픽셀 수준의 밀집 예측 작업에서도 도메인 적응의 중요성을 강력히 입증했습니다. 특히, 도메인 이동이 심한 경우(예: 합성에서 실제 환경) 제안된 방법론이 큰 효과를 발휘했습니다.
- 전역 도메인 정렬과 카테고리별 적응을 결합하는 것이 효과적임을 보여주었습니다. 특히, 전역 정렬은 큰 도메인 이동(예: 합성-실제, 계절 변화)에 효과적이며, 카테고리별 적응은 미묘한 카테고리 편향(bias)을 해결하는 데 기여합니다.
- 새로운 FCDA (Fully Convolutional Domain Adversarial learning) 접근 방식은 이미지 전체가 아닌 픽셀 수준의 수용 필드 영역을 인스턴스로 사용하여 도메인 불변 표현 학습에 더 적합함을 입증했습니다.
- 소스 도메인의 클래스별 픽셀 분포 통계를 타겟 도메인의 약한 레이블링과 결합하는 제약 기반 다중 인스턴스 학습의 일반화는 주석 없는 타겟 도메인으로 공간 레이아웃 정보를 효과적으로 전달하는 새로운 방법입니다.
- BDDS와 같은 대규모 실제 환경 대시캠 데이터셋의 도입은 향후 자율 주행 및 로봇 내비게이션 분야의 도메인 적응 연구에 중요한 자료가 될 것입니다.
- 제한 사항으로는, 'car' 클래스의 경우 합성 데이터셋 내에서 외형 변화가 없어 적응 효과가 미미했던 것처럼, 도메인 이동의 특성에 따라 각 적응 구성 요소의 기여도가 달라질 수 있다는 점이 있습니다. 또한, 약한 레이블링을 위한 초기 임계값 설정($0.1 \cdot \alpha_c$)에 대한 추가적인 분석이 필요할 수 있습니다.

## 📌 TL;DR

이 논문은 시맨틱 분할을 위한 최초의 비지도 도메인 적응 프레임워크를 제안합니다. 주요 문제인 픽셀 수준 도메인 이동을 해결하기 위해, **완전 컨볼루션 도메인 적대적 학습(FCDA)**을 사용하여 전역 도메인 정렬을 수행하고, 소스 도메인의 공간 레이아웃 정보를 활용하는 **제약 기반 다중 인스턴스 손실**로 카테고리별 적응을 달성합니다. GTA5/SYNTHIA에서 Cityscapes로의 적응, SYNTHIA 내 계절 간 적응, Cityscapes 내 도시 간 적응 등 다양한 시나리오에서 베이스라인 대비 유의미한 성능 향상을 입증했으며, 새로운 대규모 대시캠 데이터셋인 BDDS를 소개했습니다.
