# Unsupervised Domain Adaptation by Backpropagation

Yaroslav Ganin, Victor Lempitsky

## 🧩 Problem to Solve

최고 성능의 딥러닝 아키텍처는 방대한 양의 레이블이 지정된 데이터로 훈련됩니다. 그러나 특정 작업에 대해 레이블이 지정된 데이터가 부족하고, 유사하지만 다른 도메인(예: 합성 이미지)의 레이블 지정 데이터와 레이블 없는 타겟 도메인 데이터만 있는 경우 "도메인 시프트(domain shift)" 문제가 발생합니다. 이로 인해 소스 도메인에서 훈련된 모델이 타겟 도메인에서 성능이 크게 저하됩니다. 본 연구의 목표는 레이블이 지정된 타겟 도메인 데이터 없이(비지도 도메인 적응) 모델이 타겟 도메인에서도 잘 작동하도록, **작업에 대해 판별적이면서도 도메인 변화에 불변적인 특징**을 학습하는 것입니다.

## ✨ Key Contributions

- **심층 도메인 적응을 위한 새로운 접근 방식 제안**: 대규모 레이블 소스 데이터와 대규모 레이블 없는 타겟 데이터를 활용하여 심층 신경망을 훈련하는 효과적인 방법을 제시합니다.
- **그레디언트 반전 레이어(Gradient Reversal Layer, GRL) 도입**: 순전파 시에는 항등 변환으로 작동하고, 역전파 시에는 그레디언트에 음의 상수를 곱하는 `GRL`을 제안합니다. 이 레이어를 통해 특징 추출기가 도메인 불변 특징을 학습하도록 유도합니다.
- **통합 역전파 기반 학습 프레임워크**: GRL을 표준 피드포워드 아키텍처에 통합하여, 표준 역전파 알고리즘으로 특징 추출기, 레이블 예측기, 도메인 분류기를 동시에 훈련함으로써 판별적이면서도 도메인 불변적인 특징을 추출합니다.
- **단순성 및 확장성**: 제안된 방법은 기존 딥러닝 패키지를 사용하여 쉽게 구현할 수 있으며, 개념적으로 간단하고 확장성이 높아 대규모 딥러닝 모델에 적용하기 용이합니다.
- **최첨단 성능 달성**: MNIST 변형, SVHN, Office 데이터셋 등 다양한 이미지 분류 벤치마크에서 큰 도메인 시프트가 있는 상황에서도 기존 최첨단 방법들을 크게 능가하는 우수한 적응 성능을 보여주었습니다.

## 📎 Related Works

- **특징 분포 매칭 기반 비지도 도메인 적응**:
  - **샘플 가중치 부여/선택**: 소스 도메인 샘플에 가중치를 부여하거나 선택하여 분포를 매칭하는 방법 (Borgwardt et al., 2006; Huang et al., 2006).
  - **명시적 특징 공간 변환**: 소스 분포를 타겟 분포로 매핑하는 변환 학습 (Pan et al., 2011; Gopalan et al., 2011).
  - **분포 비유사성 측정**: 커널-재생 힐베르트 공간에서 분포 평균 매칭 (Borgwardt et al., 2006) 또는 분포의 주축 매핑 (Gong et al., 2012). 본 논문은 특징 표현 자체를 수정하여 분포를 매칭하며, 분류기의 분리 가능성을 기반으로 분포 간 불일치를 측정합니다.
- **점진적 도메인 전이**: 소스에서 타겟 도메인으로 점진적으로 학습하는 방법 (Gopalan et al., 2011).
  - **심층 학습 접근**: 계층별 딥 오토인코더 훈련 (S. Chopra & Gopalan, 2013). 본 논문은 특징 학습, 도메인 적응, 분류기 학습을 하나의 통합 아키텍처에서 동시에 수행하여 더 단순합니다.
- **지도 도메인 적응**: 타겟 도메인의 레이블 데이터를 사용하여 네트워크를 미세 조정 (Zeiler & Fergus, 2013). 본 방법은 레이블 없는 타겟 데이터를 요구하지만, 레이블 데이터가 있을 경우 쉽게 통합할 수 있습니다.
- **생성적 적대 신경망(GAN) 관련 아이디어**: (Goodfellow et al., 2014)의 생성적 네트워크 아이디어와 유사하게, 훈련 데이터와 합성 데이터 간의 불일치를 측정하는 방식이 본 논문의 도메인 불일치 측정 방식과 유사합니다.
- **Deep Domain Confusion (DDC)**: (Tzeng et al., 2014)는 도메인 평균 간의 거리를 최소화하며, 본 논문은 분포 간의 더 긴밀한 정렬을 추구하는 "1차 근사"에 해당합니다.

## 🛠️ Methodology

제안된 모델은 세 가지 주요 구성 요소로 이루어진 심층 피드포워드 아키텍처입니다 (그림 1):

1. **특징 추출기 ($G_f$**: 입력 $x$를 $D$-차원 특징 벡터 $f$로 매핑하며, 파라미터는 $\theta_f$입니다.
2. **레이블 예측기 ($G_y$**: 특징 벡터 $f$를 레이블 $y$로 매핑하며, 파라미터는 $\theta_y$입니다.
3. **도메인 분류기 ($G_d$**: 특징 벡터 $f$를 도메인 레이블 $d$ (소스: 0, 타겟: 1)로 매핑하며, 파라미터는 $\theta_d$입니다.

**최적화 목표**:
모델은 다음 목적 함수 $E(\theta_f, \theta_y, \theta_d)$의 새들 포인트(saddle point)를 찾도록 훈련됩니다.

$$
E(\theta_f, \theta_y, \theta_d) = \sum_{i: d_i=0} L_y(G_y(G_f(x_i;\theta_f);\theta_y), y_i) - \lambda \sum_{i=1}^N L_d(G_d(G_f(x_i;\theta_f);\theta_d), d_i)
$$

- 여기서 $L_y$는 레이블 예측 손실, $L_d$는 도메인 분류 손실입니다.
- $\theta_y$는 레이블 예측 손실을 최소화합니다.
- $\theta_d$는 도메인 분류 손실을 최소화하여 소스와 타겟 도메인의 특징을 잘 구별하도록 학습됩니다.
- **$\theta_f$는 레이블 예측 손실을 최소화(판별력)하는 동시에, 도메인 분류 손실을 최대화(도메인 불변성)하도록 학습됩니다.** $\lambda$는 이 두 목표 사이의 균형을 조절합니다.

**그레디언트 반전 레이어(GRL)를 이용한 최적화**:

- 새들 포인트 최적화를 표준 확률적 경사 하강법(SGD)으로 구현하기 위해 `그레디언트 반전 레이어(GRL)`가 도입됩니다.
- **순전파**: GRL은 입력 $x$에 대해 항등 함수($R_{\lambda}(x) = x$)로 작동합니다.
- **역전파**: GRL은 다음 계층으로부터 받은 그레디언트에 $-\lambda$를 곱하여 이전 계층으로 전달합니다($\frac{dR_{\lambda}}{dx} = -\lambda I$).
- GRL은 특징 추출기($G_f$)와 도메인 분류기($G_d$) 사이에 위치하여, $\theta_f$로 역전파되는 도메인 분류 손실의 그레디언트에 $-\lambda$가 곱해지도록 합니다.
- 이는 $\theta_f$가 레이블 예측 손실을 최소화하는 방향으로, 그리고 도메인 분류 손실을 **최대화**하는 방향으로 업데이트되도록 하여, 최종적으로 도메인 분류기가 소스와 타겟 도메인 특징을 구별하기 어렵게 만듭니다.
- $\lambda$ 값은 훈련 초기 단계에서 노이즈 신호를 줄이기 위해 $0$에서 $1$까지 점진적으로 증가하는 스케줄을 사용합니다.

## 📊 Results

제안된 방법은 다양한 벤치마크에서 기존의 비지도 도메인 적응 방법들을 능가하는 최첨단 성능을 달성했습니다.

- **MNIST → MNIST-M**: 소스 전용 모델의 $57.4\%$ 정확도를 크게 개선하여 $81.4\%$를 달성했습니다 ($57.9\%$의 성능 격차 커버리지). 특징 분포 시각화(t-SNE)를 통해 적응 후 두 도메인의 특징이 잘 혼합됨을 보여주었습니다.
- **SYNNUMBERS → SVHN (합성 이미지 → 실제 이미지)**: 소스 전용 모델의 $86.6\%$에서 $90.4\%$로 향상되었으며, 이는 성능 격차의 $66.1\%$를 커버합니다. 기존 SA(Subspace Alignment) 방법은 유의미한 개선을 보이지 못했습니다.
- **SVHN → MNIST**: 소스 전용 모델의 $59.1\%$에서 $71.0\%$로 정확도가 향상되었습니다 ($29.3\%$ 격차 커버리지). 다만, MNIST → SVHN 방향의 적응은 큰 도메인 차이로 인해 성공하지 못했습니다.
- **Synthetic Signs → GTSRB**: 소스 전용 모델의 $74.0\%$에서 $88.6\%$로 성능이 크게 향상되었습니다 ($56.7\%$ 격차 커버리지). 합성에서 실제 데이터로의 적응에 대한 방법의 적합성을 다시 한번 입증했습니다.
- **Office 데이터셋 (Amazon, DSLR, Webcam)**: 이 방법은 Office 데이터셋의 3가지 전이 작업에서 이전 보고된 최첨단 정확도를 크게 능가했습니다 (표 2). 특히 가장 도전적인 AMAZON → WEBCAM 시나리오에서 우수한 성능을 보였습니다.
- **반지도 도메인 적응**: 소량의 레이블 있는 타겟 데이터를 활용하는 반지도 설정에서도 소스 전용 또는 타겟 전용 모델보다 낮은 에러율을 달성하며 그 잠재력을 입증했습니다.

## 🧠 Insights & Discussion

- **도메인 불변 특징 학습의 효율성**: 제안된 GRL 기반 접근 방식은 레이블 예측을 위한 판별력과 도메인 불변성이라는 두 가지 상충되는 목표를 하나의 역전파 프레임워크 내에서 효과적으로 최적화합니다. 이는 특징 분포가 도메인에 걸쳐 유사해질수록 적응 성능이 향상된다는 핵심 통찰력을 실험적으로 뒷받침합니다.
- **간편한 구현과 확장성**: GRL이라는 간단한 구성 요소와 표준 역전파를 사용하므로, 딥러닝 프레임워크에서 쉽게 구현하고 기존 모델에 적용할 수 있습니다. 이는 실용적인 측면에서 이 방법의 큰 강점입니다.
- **메타-파라미터 설정 가이드**: 메타-파라미터(예: $\lambda$, 학습률)를 비지도 방식으로 설정할 때, 소스 도메인 테스트 에러는 낮고 도메인 분류기 에러는 높은 것이 성공적인 적응과 관련이 있다는 관찰을 제시하여 튜닝에 도움을 줍니다.
- **제한 사항 및 향후 연구**:
  - **극단적인 도메인 시프트**: MNIST → SVHN과 같이 도메인 간의 차이가 매우 큰 경우, 현재의 비지도 적응 방법으로는 한계가 있을 수 있음을 보여줍니다.
  - **반지도 설정 및 대규모 데이터셋**: 반지도 도메인 적응에 대한 추가 평가와 더 큰 스케일의 작업에서의 성능 검증이 향후 연구 과제로 남아 있습니다.
  - **특징 추출기 초기화**: 딥 오토인코더와 같은 방법을 통한 특징 추출기의 좋은 초기화가 성능 향상에 기여할 수 있는지 탐구할 가치가 있습니다.

## 📌 TL;DR

본 논문은 `그레디언트 반전 레이어(GRL)`를 활용하여 `비지도 도메인 적응`을 위한 새로운 딥러닝 접근 방식을 제안합니다. GRL은 역전파 시 그레디언트 방향을 반전시켜 특징 추출기가 레이블 예측에는 `판별적`이고, 도메인 분류기가 도메인을 구별하기 어렵게 만들어 `도메인 불변적`인 특징을 동시에 학습하도록 합니다. 이 방법은 표준 역전파로 쉽게 훈련 가능하며, 다양한 이미지 분류 벤치마크에서 기존 최첨단 성능을 크게 뛰어넘는 우수한 결과를 달성했습니다.
