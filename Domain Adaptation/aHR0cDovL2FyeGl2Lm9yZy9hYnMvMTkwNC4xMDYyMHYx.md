# Bidirectional Learning for Domain Adaptation of Semantic Segmentation

Yunsheng Li, Lu Yuan, Nuno Vasconcelos

## 🧩 Problem to Solve

시맨틱 이미지 분할(Semantic Image Segmentation)은 픽셀 단위의 정교한 레이블이 필요하기 때문에 대규모 데이터셋을 수동으로 레이블링하는 데 막대한 비용과 시간이 소요됩니다. 이를 해결하기 위해 컴퓨터 그래픽스로 생성된 합성 이미지 데이터셋(예: GTA5, SYNTHIA)을 사용하여 딥러닝 모델을 훈련할 수 있지만, 이러한 합성 데이터(소스 도메인)와 실제 이미지(타겟 도메인) 간의 심각한 도메인 불일치(Domain Mismatch 또는 Domain Shift)가 모델 성능을 저해합니다. 기존의 도메인 적응(Domain Adaptation) 기법들은 특정 데이터셋에 한정되거나, 이미지-투-이미지 변환(Image-to-Image Translation) 모델의 품질에 크게 의존하는 순차적 접근 방식(sequential approach)으로 인해 변환 단계에서 오류가 발생하면 이후 단계에서 이를 만회하기 어렵다는 한계를 가집니다. 이 연구는 레이블이 없는 타겟 도메인에서도 시맨틱 분할 성능을 크게 향상시킬 수 있는 견고한 도메인 적응 방법을 제안하는 것을 목표로 합니다.

## ✨ Key Contributions

- **양방향 학습 시스템(Bidirectional Learning System)**: 시맨틱 분할을 위한 새로운 양방향 학습 시스템을 제안합니다. 이는 이미지 변환 모델과 분할 적응 모델을 번갈아 학습시키고 상호 발전시키는 폐쇄 루프(closed loop) 구조를 가집니다.
- **자기 지도 학습(Self-supervised Learning, SSL) 알고리즘**: 분할 적응 모델을 위한 자기 지도 학습 알고리즘을 도입하여, 변환된 결과(translated results)를 기반으로 소스 도메인과 타겟 도메인을 특징(feature) 수준에서 점진적으로 정렬합니다.
- **새로운 지각 손실(Perceptual Loss)**: 이미지-투-이미지 변환 모델에 새로운 지각 손실을 도입합니다. 이는 업데이트된 분할 적응 모델의 감독(supervision)을 통해 변환의 시맨틱(semantic) 일관성을 강제합니다.

## 📎 Related Works

- **전통적인 도메인 적응**: Maximum Mean Discrepancy (MMD) 손실 [$8$], 특징 분포의 평균 및 공분산 일치 [$2, 21$] 등이 있었으나, 시맨틱 분할 문제에는 제한적인 성능을 보였습니다.
- **적대적 학습(Adversarial Learning)**: 분류 문제에서 도메인 불일치를 줄이기 위해 discriminator를 속이도록 학습하는 방식 [$34, 35$]이 도입되었으나, 복잡한 시맨틱 분할에서는 성능이 제한적이었습니다.
- **시맨틱 분할을 위한 도메인 적응**:
  - **특징 수준 정렬**: 초기 연구는 특징 수준에서 전역적/지역적 정렬 [$13$], 커리큘럼 도메인 적응 [$37$], 다중 discriminator 사용 [$33$], 전경/배경 분리 [$31$] 등을 시도했습니다. 하지만 합성-실제 데이터 간의 큰 시각적(visual) 차이에는 어려움을 겪었습니다.
  - **이미지-투-이미지 변환 후 특징 정렬**: CycleGAN [$38$]과 같은 모델로 먼저 이미지를 변환하여 도메인 불일치를 줄인 다음, 특징 수준에서 추가 정렬을 수행하는 Cycada [$12$] 및 DCAN [$36$]과 같은 방법이 제안되었습니다. 그러나 이들은 이미지 변환 품질에 크게 의존하는 순차적 방식입니다.
- **양방향 학습(Bidirectional Learning)**: 신경망 기계 번역 [$10, 23$] 및 이미지 생성 [$25$] 등 다른 분야에서 양방향 학습이 제안되었습니다. 이미지 변환에서 양방향 학습을 사용한 연구 [$29$]도 있지만, 본 논문의 양방향 학습은 변환 모델과 분할 모델 간의 상호 피드백을 통해 시맨틱 분할 태스크를 다룹니다.

## 🛠️ Methodology

본 연구는 이미지-투-이미지 변환 모델($F$)과 시맨틱 분할 적응 모델($M$)의 두 가지 주요 구성 요소로 이루어진 새로운 양방향 학습 프레임워크를 제안합니다.

1. **양방향 학습(Bidirectional Learning)**:

   - **순방향 학습 (F $\to$ M, "translation-to-segmentation")**:
     - 먼저 이미지 변환 모델 $F$를 훈련하여 소스 이미지 $S$를 타겟 도메인의 스타일을 가진 $S'$로 변환합니다. 이때 $S'$는 $S$와 동일한 레이블 $Y_S$를 유지합니다.
     - 분할 적응 모델 $M$은 변환된 $S'$ (레이블 $Y_S$와 함께)와 레이블 없는 타겟 이미지 $T$를 사용하여 훈련됩니다.
     - $M$의 손실 함수는 다음과 같습니다:
       $$L_M = \lambda_{\text{adv}} L_{\text{adv}}(M(S'), M(T)) + L_{\text{seg}}(M(S'), Y_S)$$
       여기서 $L_{\text{adv}}$는 $S'$와 $T$의 특징 표현 간의 거리를 최소화하는 적대적 손실이고, $L_{\text{seg}}$는 $S'$에 대한 시맨틱 분할 손실입니다.
   - **역방향 학습 (M $\to$ F, "segmentation-to-translation")**:
     - 업데이트된 분할 모델 $M$을 사용하여 이미지 변환 모델 $F$를 개선합니다. 이는 $F$가 고정되는 기존 접근 방식과 다릅니다.
     - 새로운 **지각 손실(perceptual loss)**을 도입하여 원본 이미지와 변환된 이미지 간의 시맨틱 일관성을 강제합니다.
     - $F$의 손실 함수는 다음과 같습니다:
       $$L_F = \lambda_{\text{GAN}} [L_{\text{GAN}}(S', T) + L_{\text{GAN}}(S, T')] + \lambda_{\text{recon}} [L_{\text{recon}}(S, F^{-1}(S')) + L_{\text{recon}}(T, F(T'))] + L_{\text{per}}(M(S), M(S')) + L_{\text{per}}(M(T), M(T'))$$
       여기서 $L_{\text{GAN}}$은 GAN 손실, $L_{\text{recon}}$은 이미지 재구성 손실이며, $L_{\text{per}}$은 $M$이 계산한 특징을 사용하여 $S$와 $S'$ 또는 $T$와 $T'$ 간의 시맨틱 일관성을 유지합니다.
       $L_{\text{per}}$는 $M(S)$와 $M(S')$ 간의 L1 거리뿐만 아니라 $M(F^{-1}(S'))$와 $M(S)$ 간의 L1 거리도 포함하여 재구성 부분의 안정성을 높입니다.

2. **분할 모델 $M$을 위한 자기 지도 학습(Self-supervised Learning, SSL)**:

   - 순방향 학습 단계에서 $M$의 성능을 더욱 향상시키기 위해 SSL을 사용합니다.
   - $M$이 타겟 이미지 $T$에 대해 높은 확신도를 가진 예측 픽셀에 대해 가상 레이블(pseudo-labels) $\hat{Y}_T$을 생성합니다.
   - 이 가상 레이블을 사용하여 $T_{\text{ssl}}$ (높은 확신도를 가진 픽셀들의 부분집합)에 대해 추가적인 시맨틱 분할 손실을 계산하여 $M$을 훈련합니다.
   - $M$의 손실 함수는 다음과 같이 수정됩니다:
     $$L_M = \lambda_{\text{adv}} L_{\text{adv}}(M(S'), M(T)) + L_{\text{seg}}(M(S'), Y_S) + L_{\text{seg}}(M(T_{\text{ssl}}), \hat{Y}_T)$$
   - '최대 확률 임계값(Max Probability Threshold, MPT)' 방법을 사용하여 높은 확신도를 가진 픽셀을 선택합니다. 이 임계값은 예측 신뢰도와 픽셀 비율 간의 관계를 분석하여 결정됩니다.

3. **훈련 과정 (Algorithm 1)**:
   - 전체 훈련은 두 개의 루프로 구성됩니다. 외부 루프($K$번 반복)는 양방향 학습을 통해 $F$와 $M$을 번갈아 학습합니다. 내부 루프($N$번 반복)는 SSL 과정을 구현하여 $T_{\text{ssl}}$을 업데이트하고 $M$을 재훈련합니다.

## 📊 Results

- **GTA5 $\to$ Cityscapes 적응**: ResNet101 백본 사용 시 본 연구 방법은 48.5%의 mIoU를 달성했습니다. 이는 Cycada [$12$] (42.7%) 대비 약 6%p, CLAN [$19$] (43.2%) 대비 약 5%p 크게 향상된 수치입니다. VGG16 백본 사용 시에도 SOTA 대비 10.4%p 이상의 성능 향상을 보였습니다.
- **SYNTHIA $\to$ Cityscapes 적응**: 더 큰 도메인 간극을 가진 SYNTHIA 데이터셋에 대해서도 본 연구 방법은 ResNet101 백본 사용 시 51.4%의 mIoU (13개 카테고리 기준)를 달성하여 SOTA 방법들보다 최소 4%p 이상 우수한 성능을 보였습니다.
- **양방향 학습의 효과**: SSL 없이 양방향 학습만으로도 $M^{(0)}$ (소스 데이터만으로 학습)의 33.6% mIoU에서 $M^{(1)}_0(F^{(1)})$이 42.7% mIoU로 크게 개선되었으며, 두 번째 반복($M^{(2)}_0(F^{(2)})$)에서는 43.3%로 추가 개선을 보였습니다. 이는 양방향 학습이 상호 보완적임을 입증합니다.
- **자기 지도 학습(SSL)의 효과**: 양방향 학습에 SSL을 추가했을 때, mIoU는 $M^{(1)}_0(F^{(1)})$의 42.7%에서 $M^{(1)}_2(F^{(1)})$의 47.2%로 4.5%p 향상되었습니다. 두 번째 반복의 SSL 이후에는 48.5%로 더욱 개선되어, SSL이 분할 적응 모델의 능력을 크게 향상시키고 적대적 학습이 정렬되지 않은 데이터에 집중하도록 돕는 것을 확인했습니다.
- **하이퍼파라미터 영향**: MPT (Max Probability Threshold)에 대한 임계값은 0.9가 최적의 선택으로 분석되었으며, SSL의 내부 반복 횟수 $N$은 2회가 가장 효율적인 것으로 나타났습니다.
- **상한선(Upper Bound)과의 격차**: Cityscapes 데이터셋에서 완전한 감독 학습으로 얻은 상한선(ResNet101 기준 GTA5 $\to$ Cityscapes는 65.1% mIoU)과 비교했을 때, 본 연구 방법은 여전히 16.6%p 이상의 격차를 보였습니다.

## 🧠 Insights & Discussion

- **상호 보완적인 학습**: 본 연구의 가장 중요한 통찰은 이미지 변환 모델과 분할 적응 모델이 고정된 파이프라인으로 작동하는 대신, 양방향으로 상호 피드백을 주고받으며 지속적으로 서로를 개선한다는 점입니다. 이 폐쇄 루프 방식은 기존 순차적 방법의 한계를 극복하고, 한 모델의 약점이 다른 모델의 개선으로 보완될 수 있는 강력한 시너지를 창출합니다.
- **SSL의 효율성**: 자기 지도 학습은 레이블이 없는 타겟 데이터를 효과적으로 활용하는 핵심 요소입니다. 높은 확신도를 가진 픽셀에 대한 가상 레이블을 통해 분할 모델은 타겟 도메인에 대한 지식을 점진적으로 학습하고, 적대적 학습은 잘 정렬되지 않은 데이터에 더 집중할 수 있게 됩니다. 이는 전체적인 도메인 적응 과정을 더욱 견고하고 효율적으로 만듭니다.
- **지각 손실의 중요성**: 새롭게 제안된 지각 손실은 변환 모델이 단순히 시각적 스타일만 일치시키는 것이 아니라, 시맨틱 정보를 유지하도록 유도합니다. 분할 모델에서 얻은 시맨틱 특징을 변환 과정에 직접 통합함으로써, 생성된 이미지가 분할 태스크에 더 유용하도록 만듭니다.
- **제한 및 향후 연구**: 비록 SOTA 성능을 크게 뛰어넘었지만, 여전히 완전한 감독 학습의 상한선과 상당한 성능 격차가 존재합니다. 이는 도메인 간극이 매우 큰 경우에도 강건하게 작동하는 가상 레이블링 기법이나, 변환된 이미지의 품질을 더욱 향상시키는 방법에 대한 추가 연구의 여지가 있음을 시사합니다.

## 📌 TL;DR

시맨틱 분할을 위한 픽셀 단위 레이블링의 높은 비용 문제를 해결하기 위해 합성 데이터 기반의 도메인 적응이 필수적입니다. 이 연구는 합성(소스)에서 실제(타겟) 도메인으로의 시맨틱 분할 도메인 적응을 위한 **양방향 학습(Bidirectional Learning, BDL)** 프레임워크를 제안합니다. BDL은 이미지 변환 모델과 분할 적응 모델을 번갈아 학습시키고 상호 발전시키는 폐쇄 루프 방식으로, 기존 순차적 방법의 한계를 극복합니다. 또한, 분할 모델의 성능을 향상시키기 위해 타겟 도메인의 높은 확신도 예측 픽셀을 활용하는 **자기 지도 학습(Self-supervised Learning, SSL)** 알고리즘을 도입하고, 변환 모델의 시맨틱 일관성을 강화하기 위해 분할 모델로부터 피드백을 받는 새로운 **지각 손실(perceptual loss)**을 제안합니다. GTA5/SYNTHIA $\to$ Cityscapes 벤치마크에서 BDL은 기존 SOTA 방법들을 크게 능가하는 mIoU 성능을 달성하며, 상호 보완적인 학습 방식과 SSL의 효과를 성공적으로 입증했습니다.
