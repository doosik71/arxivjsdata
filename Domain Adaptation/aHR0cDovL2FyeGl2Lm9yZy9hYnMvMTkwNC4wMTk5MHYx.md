# Invariance Matters: Exemplar Memory for Domain Adaptive Person Re-identification

Zhun Zhong, Liang Zheng, Zhiming Luo, Shaozi Li, Yi Yang

## 🧩 Problem to Solve

레이블된 소스 도메인과 레이블되지 않은 타겟 도메인에서 사람 재식별(Person Re-identification, re-ID) 모델을 학습하는 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) re-ID 문제가 이 논문의 핵심 목표입니다. 기존 UDA 방법들은 주로 소스 도메인과 타겟 도메인 간의 특징 분포 차이를 줄이는 데 집중했지만, 타겟 도메인 내부의 다양한 변형(intra-domain variations)을 간과하여 타겟 도메인에서의 성능 저하를 야기합니다. 또한, 사람 re-ID의 UDA는 소스 도메인과 타겟 도메인의 클래스가 완전히 다른 오픈셋(open-set) 문제이기 때문에 더욱 어려운 도전 과제입니다.

## ✨ Key Contributions

- 타겟 도메인 내의 복잡한 변형을 종합적으로 분석하고, 세 가지 기본 불변성(exemplar-invariance, camera-invariance, neighborhood-invariance)을 활용하여 re-ID 모델의 일반화 능력을 향상시키는 방법을 제안했습니다.
- 타겟 도메인의 특징을 효율적으로 저장하고 위 세 가지 불변성 속성을 효과적으로 수용하기 위해 '예시 메모리(exemplar memory)' 모듈을 도입했습니다.
- 예시 메모리 덕분에 전체 학습 배치(global training batch)에 불변성 제약 조건을 적용할 수 있었으며, 이를 통해 계산 비용을 크게 늘리지 않고도 성능을 향상시켰습니다.
- 실험을 통해 제안된 세 가지 불변성 속성과 메모리 모듈이 효과적인 도메인 적응 시스템 구축에 필수적임을 입증했습니다.
- Market-1501, DukeMTMC-reID, MSMT17의 세 가지 대규모 re-ID 데이터셋에서 기존 SOTA(State-of-the-Art) 방법들보다 훨씬 우수한 도메인 적응 정확도를 달성했습니다.

## 📎 Related Works

- **비지도 도메인 적응(UDA)**: 기존 UDA 방법들은 주로 소스-타겟 도메인 간의 특징 분포를 정렬(e.g., MMD [11, 17, 35] 또는 적대적 도메인 분류기 [2, 27])하는 데 중점을 두었습니다. 대부분 `폐쇄 집합(closed-set)` 시나리오 [27, 10]를 가정했지만, 사람 re-ID는 `오픈 집합(open-set)` 문제 [3, 22]로 새로운 접근이 필요합니다.
- **비지도 사람 재식별**: 레이블된 소스 도메인으로 모델을 초기화한 후 타겟 도메인에서 메트릭 학습 [36] 또는 비지도 클러스터링 [9]을 수행하는 방법들이 있습니다. 도메인 간 차이를 줄이는 이미지 레벨 [7, 30, 1] 또는 속성 특징 레벨 [29, 16]의 적응 방법들도 연구되었습니다. HHL [43]은 카메라 불변성을 다루었지만, 잠재적인 긍정 쌍(positive pairs)을 간과하는 한계가 있었습니다.
- **기존 연구와의 차별점**: 예시 불변성 및 메모리 모듈은 자가 지도 학습 [33], Few-shot 학습 [23, 28, 32], 지도 학습 [34]에서 개별적으로 제시된 바 있습니다. 이웃 불변성은 Deep Association Learning (DAL) [4]과 유사하지만, 본 연구는 Top-$k$ 이웃을 정렬하기 위한 소프트 분류 손실을 사용합니다. 가장 큰 차이는 이 논문이 예시, 카메라, 이웃 불변성이라는 세 가지 불변성 제약 조건을 사람 re-ID의 UDA 문제에 종합적으로 적용하고, 그 상호 이점을 탐구했다는 점입니다.

## 🛠️ Methodology

본 논문은 ResNet-50 [12]을 백본으로 사용하는 비지도 도메인 적응 re-ID 모델을 제안합니다. 전체 프레임워크는 크게 두 가지 구성 요소로 나뉩니다.

- **소스 도메인 지도 학습**:

  - 레이블된 소스 데이터셋($\{X_s, Y_s\}$)에 대해 교차 엔트로피 손실 $L_{src}$를 사용하여 분류 모델을 학습합니다. 이는 모델이 사람의 기본 특징 표현을 학습하도록 돕습니다.

- **타겟 도메인 불변성 학습 (예시 메모리 활용)**:

  - **예시 메모리(Exemplar Memory)**: 타겟 도메인($X_t$)의 각 이미지 인스턴스를 개별적인 카테고리로 간주합니다. 각 이미지의 최신 특징 표현($f(x_{t,i})$)을 저장하는 키-값(key-value) 구조의 메모리($K$)를 구축합니다. 메모리의 키는 지수 이동 평균($K[i] \leftarrow \alpha K[i] + (1-\alpha)f(x_{t,i})$)을 통해 지속적으로 업데이트됩니다.
  - **예시 불변성(Exemplar-invariance)**: 각 타겟 이미지가 자신에게는 가깝고 다른 모든 이미지에게서는 멀어지도록 학습하여 개별 예시를 구별하는 능력을 키웁니다. 이는 코사인 유사도 기반의 소프트맥스 분류 손실 $L_{ei} = -\log p(i|x_{t,i})$를 통해 구현됩니다. 여기서 $p(i|x_{t,i}) = \frac{\exp(K[i]^T f(x_{t,i})/\beta)}{\sum_{N_t j=1} \exp(K[j]^T f(x_{t,i})/\beta)}$입니다.
  - **카메라 불변성(Camera-invariance)**: StarGAN [5]을 기반으로 한 CamStyle [44]을 사용하여 원본 타겟 이미지를 다른 카메라 스타일로 변환한 $\hat{x}_{t,i}$를 생성합니다. 원본 이미지와 스타일이 변환된 이미지가 동일한 ID를 공유하도록 강제하는 손실 $L_{ci} = -\log p(i|\hat{x}_{t,i})$를 적용하여 카메라 스타일 변화에 강건한 모델을 만듭니다.
  - **이웃 불변성(Neighborhood-invariance)**: 특정 타겟 이미지 $x_{t,i}$에 대해 예시 메모리 $K$에서 $k$개의 최신 이웃($M(x_{t,i},k)$)을 찾습니다. $x_{t,i}$와 이 이웃들이 서로 가까워지도록 소프트 레이블 손실 $L_{ni} = -\sum_{j \neq i, j \in M(x_{t,i},k)} w_{i,j} \log p(j|x_{t,i})$를 사용합니다. 이는 잠재적 긍정 쌍을 활용하여 모델의 견고성을 높입니다.
  - **전체 타겟 손실**: 위 세 가지 불변성을 종합적으로 고려한 타겟 도메인 전체 손실 $L_{tgt} = -\frac{1}{n_t} \sum_{i=1}^{n_t} \sum_{j} w_{i,j} \log p(j|x^*_{t,i})$를 사용합니다. 여기서 $x^*_{t,i}$는 원본 이미지 또는 카메라 스타일 변환 이미지 중 하나이며, $w_{i,j}$는 소프트 레이블 가중치입니다.

- **최종 손실 함수**: 소스 손실과 타겟 손실을 결합하여 $L = (1-\lambda)L_{src} + \lambda L_{tgt}$로 모델을 최적화합니다. $\lambda \in [0,1]$는 두 손실의 중요도를 조절하는 하이퍼파라미터입니다.

## 📊 Results

- **데이터셋 및 평가 지표**: Market-1501, DukeMTMC-reID, MSMT17 데이터셋에서 Rank-1 정확도와 mAP(mean Average Precision)를 사용하여 성능을 평가했습니다.
- **기본 모델 성능**: 레이블된 소스 데이터만으로 학습된 모델(Source Only)은 타겟 도메인에서 심각한 성능 저하를 보였는데 (예: Market-1501 $\leftarrow$ DukeMTMC-reID 전이 시 Rank-1 정확도 87.6% $\rightarrow$ 43.1%), 이는 도메인 전환(domain shift) 문제의 심각성을 재확인시켜 주었습니다.
- **불변성 학습 기여도 분석 (Ablation Study)**:
  - `예시 불변성(E)`만 추가했을 때도 기본 모델 대비 상당한 성능 향상을 보였습니다.
  - 여기에 `카메라 불변성(C)`을 추가하자 DukeMTMC-reID $\rightarrow$ Market-1501에서 Rank-1 정확도가 14.4%p 증가하는 등 크게 향상되었습니다.
  - `이웃 불변성(N)`도 `예시 불변성`과 함께 사용했을 때 성능을 꾸준히 개선시켰습니다.
  - 세 가지 불변성(E+C+N)을 모두 적용한 최종 모델(`Ours w/ E+C+N`)이 가장 우수한 성능을 달성했습니다 (예: DukeMTMC-reID $\rightarrow$ Market-1501에서 Rank-1 75.1%, mAP 43.0%).
- **예시 메모리의 효과**: 예시 메모리 기반 방법이 미니 배치 기반 방법보다 명확히 우수한 성능을 보였으며 (Rank-1 75.1% vs 67.2%), 추가적인 학습 시간(약 1.3분)과 GPU 메모리(약 260MB) 소모는 제한적이었습니다.
- **SOTA 비교**: Market-1501, DukeMTMC-reID에서 기존 SOTA 방법인 HHL [43] 대비 Rank-1 정확도에서 각각 12.9%p, 16.4%p 더 높은 성능을 기록하며 큰 폭으로 능가했습니다. 더 큰 MSMT17 데이터셋에서도 기존 방법 대비 Rank-1 정확도에서 18.4%p 향상되는 등 SOTA를 달성했습니다.

## 🧠 Insights & Discussion

- **세 가지 불변성 속성에 대한 논의**:
  - **예시 불변성**: 서로 다른 ID의 예시 간 거리를 늘려 구별력을 높이는 데 효과적이지만, 동일 ID의 예시 간 거리도 멀어지게 할 수 있는 상충 관계가 있습니다.
  - **이웃 불변성**: 동일 ID의 예시와 이웃 간 거리를 줄여 응집력을 높이는 데 유용하지만, 초기 모델의 부정확성으로 인해 신뢰할 수 없는 이웃(false positive)을 포함시켜 다른 ID의 이미지를 가까이 당겨 올 수 있는 위험이 있습니다.
  - **상호 보완적 관계**: 예시 불변성은 개별성(separation)을 강조하고 이웃 불변성은 유사성(cohesion)을 강조하여 상호 보완적인 상충 관계를 가지며, 이 둘의 균형이 중요합니다.
  - **카메라 불변성**: 예시 불변성과 유사하게 분리 효과를 가지면서, 같은 사람이 다른 카메라 스타일에서도 일관된 특징 표현을 갖도록 보장하여 모델의 견고성을 높입니다.
- **함의**: 본 논문에서 제안된 예시 메모리 기반의 불변성 학습 방법은 타겟 도메인 내의 복잡한 변형 요인(외관, 카메라 스타일, 자세 등)을 효과적으로 다루어 re-ID 모델의 도메인 적응 능력과 일반화 성능을 크게 향상시킬 수 있음을 보여줍니다. 이는 비지도 도메인 적응 사람 re-ID 분야에서 새로운 SOTA 성능을 제시하며, 타겟 도메인 내부 구조의 중요성을 강조합니다.

## 📌 TL;DR

레이블 없는 타겟 도메인에서 발생하는 도메인 전환 및 내부 변형 문제를 해결하기 위해, 본 논문은 `예시 메모리` 기반의 비지도 도메인 적응(UDA) 사람 재식별(re-ID) 방법을 제안한다. 이 방법은 `예시 불변성` (개별 인스턴스 구별), `카메라 불변성` (CamStyle로 카메라 스타일 변화에 강건), `이웃 불변성` (신뢰할 수 있는 이웃을 가까이)의 세 가지 핵심 불변성 원칙을 `전역 배치(global batch)`에 효율적으로 적용한다. 실험 결과, 제안된 방법은 기존 SOTA를 큰 폭으로 뛰어넘는 성능을 달성하며, 타겟 도메인 내부의 변형을 효과적으로 해결함이 입증되었다.
