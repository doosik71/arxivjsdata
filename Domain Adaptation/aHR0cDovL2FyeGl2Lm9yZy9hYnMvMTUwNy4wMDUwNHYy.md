# Optimal Transport for Domain Adaptation

Nicolas Courty, Rémi Flamary, Devis Tuia,Senior Member, IEEE, Alain Rakotomamonjy,Member, IEEE

## 🧩 Problem to Solve

최신 데이터 분석에서는 학습(소스 도메인)에 사용되는 데이터와 추론(타겟 도메인)에 사용되는 데이터의 분포가 다른(도메인 드리프트) 문제에 직면합니다. 이는 학습된 모델이 다른 관측 시스템에서 얻은 유사한 클래스의 데이터에 대해 견고하지 못하게 만듭니다. 본 논문은 특히 타겟 도메인에 레이블이 없는 **비지도 도메인 적응(unsupervised domain adaptation)** 문제에 초점을 맞춰, 도메인 불변 표현을 찾아 단일 분류기가 모든 도메인에서 효과적으로 작동하도록 하는 것을 목표로 합니다.

## ✨ Key Contributions

- 소스 및 타겟 도메인의 표현을 정렬하기 위한 **정규화된 비지도 최적 운송(Optimal Transport, OT) 모델**을 제안합니다.
- 확률 밀도 함수(PDF)를 일치시키는 운송 계획을 학습하며, 이때 소스 도메인의 동일 클래스 레이블 샘플들이 운송 중에도 가깝게 유지되도록 제약합니다. 이를 통해 소스 레이블 정보와 양 도메인의 분포를 동시에 활용합니다.
- 도메인 적응 문제에 특화된 두 가지 새로운 정규화 항을 도입했습니다:
  - **그룹 희소성(Group-Sparsity) 정규화:** 특정 타겟 샘플이 동일한 레이블을 가진 소스 샘플로부터만 질량을 받도록 유도합니다 (식 (17)).
  - **라플라시안(Laplacian) 정규화:** 운송 과정에서 데이터의 지역적 이웃 및 클래스 구조를 보존하도록 합니다 (식 (18), (19), (20)).
- 소수의 레이블이 타겟 도메인에 존재하는 **준지도(semi-supervised) 도메인 적응** 문제로의 확장이 쉽고 효과적임을 보여줍니다 (식 (21)).
- 결과적으로 도출되는 정규화된 최적 운송 최적화 문제를 효율적으로 해결하기 위한 **일반화된 조건부 기울기(Generalized Conditional Gradient, GCG) 알고리즘**을 제안하여 실제 데이터셋에서도 확장이 가능하게 합니다.
- 합성 및 실제 시각 적응 데이터셋에 대한 실험을 통해 기존 최첨단 방법론들을 일관되게 능가하는 성능을 입증합니다.

## 📎 Related Works

- **도메인 적응(Domain Adaptation):**
  - **준지도 DA:** 타겟 도메인에 소수의 레이블이 있다고 가정하는 방법들 (예: [42], [32], [29], [27], [26], [52], [47]).
  - **비지도 DA (본 논문의 초점):** 타겟 도메인에 레이블이 전혀 없다고 가정합니다.
    - 샘플 재가중치 (sample reweighting) [46].
    - 두 도메인에 공통된 특징 표현 또는 잠재 공간(latent space)을 찾는 방법 (예: [18], [38]).
    - 특징 공간에서 도메인 평균을 일치시키거나 [38], 상관 관계를 정렬하거나 [33], 쌍별 제약 조건(pairwise constraints)을 사용하는 방법 [51].
    - Grassmannian 측지선(geodesic) [24] 또는 측지 흐름 커널(geodesic-flow kernel) [23], [54]을 이용한 점진적 정렬(gradual alignment) 전략.
    - 샘플 재가중치와 표현 전이(representation transfer)를 결합하는 접근법 [53].
  - 본 제안은 기존 전역적인(global) 선형 변환과 달리 각 소스 샘플에 대한 **지역적 변환**을 정의한다는 점에서 차별화됩니다.
- **최적 운송(Optimal Transport, OT) 및 기계 학습:**
  - 19세기 몽주(Monge)와 20세기 칸토로비치(Kantorovich) [30]에 의해 정립된 이론.
  - 최근에는 계산 유체 역학 [3], 이미지 처리의 색상 전이 [40], [20], [5], 컴퓨터 그래픽스 [6] 등 다양한 분야에서 재조명되고 있습니다.
  - 기계 학습 분야에서는 히스토그램 간 거리 계산 [15]이나 그래프의 레이블 전파 [45] 등에 적용되기 시작했습니다.
  - 높은 계산 비용이 주요 장애물이었으나, Cuturi [15]를 비롯한 새로운 계산 전략 [17], [5]의 등장으로 실용적인 적용이 가능해졌습니다.

## 🛠️ Methodology

1. **도메인 적응을 운송 문제로 모델링:**
   - 도메인 드리프트가 알 수 없는 비선형 변환 $T: \Omega_{s} \to \Omega_{t}$에 의해 발생하며, 이 변환이 조건부 분포 $P_{s}(y|x_{s}) = P_{t}(y|T(x_{s}))$를 보존한다고 가정합니다.
   - 문제는 1) 소스($\mu_{s}$)와 타겟($\mu_{t}$)의 경험적 분포를 추정하고, 2) $\mu_{s}$를 $\mu_{t}$로 변환하는 운송 맵 $T$ (또는 결합 확률 $\gamma$)를 찾고, 3) $T$를 사용하여 레이블링된 소스 샘플을 변환하여 분류기를 학습하는 것으로 귀결됩니다.
   - 칸토로비치(Kantorovich)의 최적 운송 문제 정식화를 사용하여, 한계 분포(marginals) 제약 조건 하에 운송 비용 $\int_{\Omega_{s} \times \Omega_{t}} c(x_{s}, x_{t}) d\gamma(x_{s}, x_{t})$를 최소화하는 최적 운송 계획 $\gamma_{0}$를 찾습니다.
   - 운송 비용 함수 $c(x,y)$는 일반적으로 제곱 유클리드 거리 $||x-y||^{2}_{2}$를 사용합니다.
2. **정규화된 이산 최적 운송:**
   - 이산 샘플에 대한 경험적 분포(식 (6))의 경우, 문제는 $\min_{\gamma \in B} \langle \gamma, C \rangle_{F}$로 표현됩니다. 여기서 $B$는 한계 분포 제약을 만족하는 결합 확률 집합입니다.
   - Cuturi [15]가 제안한 엔트로피 정규화 항 $\lambda \Omega_{s}(\gamma) = \lambda \sum_{i,j} \gamma(i,j) \log \gamma(i,j)$를 추가하여, $\min_{\gamma \in B} \langle \gamma, C \rangle_{F} + \lambda \Omega_{s}(\gamma)$ 형태의 문제를 풉니다 (식 (9)). 이는 $\gamma$를 더 밀도 있게(denser) 만들고 Sinkhorn-Knopp 알고리즘으로 효율적인 계산을 가능하게 합니다.
3. **OT 기반 샘플 매핑:**
   - 계산된 운송 계획 $\gamma_{0}$를 이용하여 소스 샘플 $x^{s}_{i}$를 타겟 도메인으로 매핑합니다.
   - 이는 각 소스 샘플의 이동을 타겟 샘플의 가중 평균으로 표현하는 무게 중심(barycentric) 매핑으로 이루어집니다: $\hat{x}^{s}_{i} = \operatorname{argmin}_{x \in \mathbb{R}^{d}} \sum_{j} \gamma_{0}(i,j)c(x,x^{t}_{j})$.
   - 제곱 $L_2$ 비용 함수일 경우, $\hat{X}_{s} = T_{\gamma_{0}}(X_{s}) = \operatorname{diag}(\gamma_{0} \mathbf{1}_{n_{t}})^{-1} \gamma_{0} X_{t}$로 계산됩니다 (식 (14)).
4. **클래스 기반 정규화:**
   - 최적화 목표 함수에 $\eta \Omega_{c}(\gamma)$ 항을 추가합니다 (식 (16)).
   - **그룹 희소성 정규화 (OT-GL):** $\Omega_{c}(\gamma) = \sum_{j} \sum_{cl} ||\gamma(I_{cl},j)||_{2}$ (식 (17)). 타겟 샘플 $j$가 클래스 $cl$에 해당하는 소스 샘플 $I_{cl}$로부터의 운송 질량만 받도록 유도하여 클래스 구조를 보존합니다.
   - **라플라시안 정규화 (OT-Laplace):** $\Omega_{c}(\gamma) = \frac{1}{N^{2}_{s}} \sum_{i,j} S_{s}(i,j)||\hat{x}^{s}_{i} - \hat{x}^{s}_{j}||^{2}_{2}$ (식 (18)). 소스 도메인 샘플 간의 유사성 행렬 $S_{s}$ (동일 클래스 간에만 연결)를 사용하여 운송 후에도 유사한 샘플들이 가깝게 유지되도록 합니다. 타겟 도메인의 유사성 정보 $S_{t}$를 포함하는 대칭형 라플라시안 정규화 (식 (20))로도 확장될 수 있습니다.
5. **준지도 도메인 적응 정규화 (OT-Semi):**
   - 타겟 도메인의 소수 레이블을 활용하기 위해 운송 비용 행렬 $C$를 수정합니다. 만약 소스 샘플 $x^{s}_{i}$와 타겟 샘플 $x^{t}_{j}$의 레이블 $y^{s}_{i}, y^{t}_{j}$가 다르면 운송 비용을 무한대로 설정하여 해당 매칭을 방지합니다: $\Omega_{semi}(\gamma) = \langle \gamma, M \rangle$ (식 (21)).
6. **최적화 알고리즘:**
   - 정규화된 OT 문제를 풀기 위해 일반화된 조건부 기울기(GCG) 알고리즘 (Algorithm 1)을 사용합니다. GCG는 목적 함수의 미분 가능한 부분만 선형화하여, 각 반복에서 엔트로피 정규화된 최적 운송 문제를 해결하는 Sinkhorn-Knopp 알고리즘을 효율적으로 적용할 수 있도록 합니다.

## 📊 Results

- **Two Moons (합성 데이터셋):**
  - OT 기반 방법론들 (OT-exact, OT-IT, OT-GL, OT-Laplace)은 기존 최첨단 방법(DA-SVM, PBDA)보다 우수한 성능을 보였으며, 특히 낮은 회전 각도에서 기하학적 구조를 더 잘 보존했습니다.
  - 클래스 기반 정규화(OT-GL, OT-Laplace)는 중간 범위의 각도에서 거의 최적의 적응 결과를 달성하며 성능을 크게 향상시켰습니다.
- **시각 적응 (실제 데이터셋, SURF 특징):**
  - Digits (USPS, MNIST), Faces (PIE), Objects (Caltech-Office) 데이터셋에서 실험을 수행했습니다.
  - OT 기반 방법들은 일반적으로 기준선(1NN, PCA, GFK, TSL, JDA)보다 우수한 성능을 보였습니다. 특히 OT-GL과 OT-Laplace가 가장 좋은 결과를 보였습니다.
  - PIE 데이터셋에서는 JDA가 더 나은 성능을 보이는 경우가 있었는데, 이는 많은 클래스 수와 JDA의 EM(기대-최대화) 단계가 타겟 분류 결과를 활용하기 때문으로 해석됩니다.
- **시각 적응 (실제 데이터셋, DeCAF 딥러닝 특징):**
  - 딥러닝 특징 자체가 높은 성능을 제공함에도 불구하고, 제안된 OT 방법들(OT-IT, OT-GL)은 최종 분류 성능을 크게 향상시켰습니다 (일부 경우 20% 이상).
  - 이는 딥 아키텍처가 처리하기 어려운 분포의 비정상성(non-stationarity)을 OT가 효과적으로 다룰 수 있음을 보여줍니다.
- **준지도 도메인 적응 (Office-Caltech, SURF 특징, 클래스당 3개 레이블):**
  - 타겟 도메인의 레이블을 운송 계획 계산에 활용하는 준지도 정규화 방식은, 레이블을 분류기 학습 단계에서만 사용하는 경우에 비해 성능을 현저히 향상시켰습니다.
  - 기존 최첨단 준지도 DA 방법(MMDT [28])과 비교했을 때도 경쟁력 있는 성능을 보였습니다.

## 🧠 Insights & Discussion

- 최적 운송(OT)은 기존의 공통 부분 공간(common subspace) 학습 방법보다 훨씬 일반적인 도메인 적응을 위한 강력한 프레임워크를 제공합니다.
- 클래스 기반 정규화(그룹 희소성, 라플라시안)는 소스 도메인의 레이블 정보를 운송 계획 추정 과정에 효과적으로 통합하여 더 나은 적응 성능을 이끌어냅니다. 이는 동일 클래스 샘플들이 유사한 변환을 거치도록 강제하는 직관에 부합합니다.
- 제안된 프레임워크는 준지도 시나리오에서도 타겟 도메인의 소수 레이블 정보를 활용하여 운송 계획을 최적화하고 성능을 더욱 향상시킬 수 있는 유연성을 갖습니다.
- 일반화된 조건부 기울기(GCG) 알고리즘과 Sinkhorn-Knopp 알고리즘의 결합은 실제 대규모 데이터셋에서도 효율적인 계산을 가능하게 하여 OT 방법의 실용성을 높입니다.
- OT는 딥러닝 특징이 이미 추출된 후에도 분포의 비정상성을 처리하여 분류 성능을 추가적으로 개선할 수 있음을 보여주며, 이는 OT가 강력한 특징 추출기와 상호보완적으로 작동할 수 있음을 시사합니다.
- **한계점 및 향후 연구:** 본 논문에서 제시된 클래스 기반 및 라플라시안 정규화 외에, 변환을 유도하는 물리적 프로세스에 따른 물리적 제약 조건 등을 포함하는 다른 유형의 정규화 항에 대한 연구가 필요합니다. 또한, 여러 도메인을 동시에 다루는 다중 도메인 적응(multi-domain adaptation) 문제로의 확장을 다중 한계 최적 운송(multi-marginal optimal transport)을 통해 계획하고 있습니다.

## 📌 TL;DR

**문제:** 소스와 타겟 도메인 간의 데이터 분포 차이(도메인 드리프트)로 인해 학습 모델의 일반화 성능이 저하되는 비지도 도메인 적응 문제입니다. 특히 타겟 도메인에는 레이블이 없습니다.
**방법:** 본 논문은 소스 도메인에서 타겟 도메인으로 데이터를 "운송"하여 분포를 정렬하는 정규화된 최적 운송(OT) 프레임워크를 제안합니다. 핵심은 운송 계획을 학습할 때, 소스 레이블 정보를 활용하여 클래스 구조를 보존하는 새로운 **그룹 희소성** 및 **라플라시안 정규화**를 적용하는 것입니다. 효율적인 계산을 위해 일반화된 조건부 기울기(GCG) 알고리즘을 사용하며, 소수의 타겟 레이블이 있는 준지도 설정으로도 확장됩니다.
**발견:** 제안된 OT 기반 방법론, 특히 클래스 기반 정규화가 적용된 모델들은 합성 및 실제 시각 데이터셋 모두에서 기존 최첨단 도메인 적응 방법들보다 일관되게 우수한 성능을 보였습니다. 또한, 딥러닝 특징과 결합했을 때도 성능을 크게 향상시키고, 준지도 시나리오에서도 상당한 개선을 가져와 OT가 복잡한 도메인 변화를 처리하는 유연하고 강력한 패러다임을 제공함을 입증했습니다.
