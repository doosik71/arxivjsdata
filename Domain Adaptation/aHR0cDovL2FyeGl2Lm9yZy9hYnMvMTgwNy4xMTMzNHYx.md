# Unsupervised Domain Adaptive Re-Identification: Theory and Practice

Liangchen Song, Cheng Wang, Lefei Zhang, Bo Du, Qian Zhang, Chang Huang, Xinggang Wang

## 🧩 Problem to Solve

비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) 재식별(Re-ID)은 컴퓨터 비전 분야에서 활발히 연구되고 있으나, 다음과 같은 주요 문제점과 한계점을 가지고 있습니다.

- **이론적 토대 부족**: 기존의 비지도 도메인 적응 이론은 분류(classification) 과제에 초점을 맞추고 있으며, Re-ID 과제의 고유한 특성(예: ID의 쌍별 정의, 테스트 세트의 미공개 ID)을 다루는 이론적 기반이 부족합니다.
- **Re-ID 과제의 특수성**: Re-ID는 단일 샘플에 레이블이 없는 '쌍(pairwise) 데이터'를 다루며, 테스트 세트의 샘플들이 훈련 세트에서 본 적 없는 ID에 속한다는 점에서 전통적인 분류 과제와 다릅니다. 이로 인해 기존 분류 UDA 이론을 Re-ID에 직접 적용하기 어렵습니다.
- **실용적 솔루션의 이론적 근거 부족**: 기존의 비지도 도메인 적응 Re-ID 알고리즘들은 도메인 불변 표현 학습이나 타겟 도메인 데이터 생성을 통해 문제를 해결하지만, 이러한 실용적 접근 방식들이 왜 효과적인지에 대한 이론적 설명이 부족합니다.

따라서 본 논문은 비지도 도메인 적응 Re-ID 문제에 대한 이론적 보장을 제공하고, 이를 기반으로 한 효과적인 학습 프레임워크를 개발하는 것을 목표로 합니다.

## ✨ Key Contributions

본 논문의 주요 기여는 다음과 같습니다.

- **최초의 이론적 분석**: 기존 분류 과제의 비지도 도메인 적응 이론([3])을 확장하여 Re-ID 과제에 대한 이론적 보장을 제공합니다. 특징 공간에 대한 세 가지 가정을 도입하고 Re-ID 문제의 학습 가능성(learnability)을 수학적으로 증명한 첫 번째 연구입니다.
- **이론 기반 손실 함수 도출**: 앞서 언급된 이론적 가설들을 만족시키기 위한 구체적이고 다루기 쉬운(tractable) 손실 함수들을 인코더 네트워크와 데이터 샘플에 대해 이론적으로 유도합니다.
- **새로운 자기 훈련 프레임워크 제안**: 도출된 손실 함수들을 반복적으로 최소화하기 위한 자기 훈련(self-training) 방식을 제안합니다. 이 프레임워크는 모든 Re-ID 과제에 적용 가능하며, 대규모 사람 Re-ID 및 차량 Re-ID 데이터셋에서 최신 SOTA(State-Of-The-Art) 방법들보다 뛰어난 효과를 검증했습니다.

## 📎 Related Works

- **비지도 도메인 적응 및 특징 표현**: 두 도메인 간에 공유되는 잠재 특징 공간을 찾는 데 중점을 둡니다. [26]은 두 도메인의 평균 거리 최소화를, [22, 4]는 MMD(Maximum Mean Discrepancy)를 통해 분포 유사성을 높이는 방법을 사용합니다. [10]은 소스 및 타겟 도메인을 구별할 수 없는 특징을 활용합니다. 본 논문의 방법은 이러한 직관을 반복적인 방식으로 접근합니다.
- **비지도 도메인 적응 및 자기 훈련**: 타겟 도메인에 대한 예측을 통해 모델을 반복적으로 개선하는 EM(Expectation Maximization) 알고리즘과 밀접한 관련이 있습니다. [27]은 각 반복마다 타겟 데이터의 가중치를 높이고, [1]은 타겟 도메인의 상위 인식 가설을 언어 모델 적응에 사용합니다. 본 논문은 직접 레이블을 추측하기보다 클러스터링을 수행합니다.
- **비지도 도메인 적응 사람 Re-ID**: [23]은 다중 작업 딕셔너리 학습을 통해 뷰 불변 표현을 학습하고, [6, 31]은 생성 모델을 적용합니다. [30, 14]는 속성-ID 식별 특징을 학습하거나 도메인 불변 특징을 도출합니다. 그러나 이들 방법은 이론적 프레임워크가 부족하고 다른 Re-ID 과제에서의 일반화 능력이 검증되지 않았습니다. [8]은 클러스터링과 미세 조정을 포함하는 점진적 비지도 학습 방법을 제안했으나, 비지도 도메인 적응이 아닌 비지도 학습에만 초점을 맞췄습니다.

## 🛠️ Methodology

본 논문은 비지도 도메인 적응 Re-ID 문제를 해결하기 위해 다음의 이론적 및 실용적 방법론을 제시합니다.

### 1. 이론적 기반 확립

기존 분류 과제의 비지도 도메인 적응 이론을 Re-ID에 맞게 확장하기 위해, 원시 데이터($z \in \mathcal{Z}$) 대신 추출된 특징($x(z) \in \mathcal{X}$) 공간에 대한 세 가지 가정을 도입합니다.

- **Covariate Shift (공변량 이동)**: 소스 도메인과 타겟 도메인에서 특징 쌍을 분류하는 기준이 동일하다는 가정입니다. 즉, $l_S(x_1, x_2) = l_T(x_1, x_2)$입니다.
- **Separately Probabilistic Lipschitzness (SPL)**: 특징 쌍들이 레이블 동질적인 클러스터로 나뉘고 저밀도 영역으로 분리될 수 있다는 가정입니다. 이는 `Definition 2`로 수학적으로 정의됩니다.
- **Weight Ratio (가중치 비율)**: 소스 도메인과 타겟 도메인 간의 중첩 정도에 대한 가정입니다. `Definition 3`으로 정의됩니다.
  이러한 가정들을 기반으로 `Theorem 1`을 통해 비지도 도메인 적응 Re-ID 과제의 학습 가능성(learnability)을 증명합니다.

### 2. 자기 훈련(Self-training) 프레임워크

가설들을 강화하기 위해 인코더($x(\cdot)$)를 반복적으로 훈련하는 자기 훈련 프레임워크를 제안합니다.

- **초기화**: 소스 도메인 $S$에서 인코더 $x^{(0)}$를 사전 훈련합니다.
- **반복 과정**:
  1. **특징 추출 및 가설 레이블 생성**: 현재 인코더 $x^{(i)}$를 사용하여 타겟 도메인 $T$의 모든 레이블 없는 샘플로부터 특징을 추출합니다. 이 특징들을 기반으로 가설 레이블(pseudo-labels)을 추론하고 훈련에 사용할 샘플($D^{(i)}$)을 선택합니다.
  2. **인코더 훈련**: 선택된 가설 레이블 샘플 $D^{(i)}$를 사용하여 인코더 $x^{(i)}$를 업데이트하여 $x^{(i+1)}$를 생성합니다.

### 3. 손실 함수 및 샘플 선택 전략

가정들을 강화하기 위한 구체적인 손실 함수와 이를 기반으로 한 샘플 선택 전략을 제시합니다.

- **SPL 강화를 위한 손실**:
  - `Definition 4`를 통해 인코더가 더 '클러스터 가능(clusterable)'한지 평가하는 기준을 정의합니다.
  - `Theorem 2`를 통해 SPL을 강화하는 것은 클러스터 내부 거리($L_{intra}$)를 최소화하고 클러스터 간 거리($L_{inter}$)를 최대화하는 것과 같음을 보입니다.
    - $L_{intra}(x, D, l) = \sum_{l(x(z_1),x(z_2))=1} \|x(z_1)-x(z_2)\|$ (식 5)
    - $L_{inter}(x, D, l) = \sum_{l(x(z_1),x(z_2))=0} -\|x(z_1)-x(z_2)\|$ (식 6)
- **Weight Ratio 강화를 위한 손실**:
  - 타겟 특징이 소스 특징에 얼마나 가까운지를 나타내는 손실 $L_{WR}$을 제안합니다.
  - $L_{WR}(x, D) = E_{z_d \sim D}[\inf_{z_s \sim S} \|x(z_d)-x(z_s)\|]$ (식 9)
  - `Theorem 3`을 통해 $L_{WR}$을 최소화하는 것이 Weight Ratio 가정을 강화하는 것과 같음을 보입니다.

### 4. 클러스터링 기반 샘플 선택

$L_{intra}$와 $L_{inter}$를 동시에 최소화하기 위해 클러스터링을 통해 가설 레이블을 생성합니다.

- **거리 메트릭 $d_J$**: SPL 가정을 반영하기 위해 k-reciprocal 인코딩([35]) 기반의 Jaccard 거리를 변형하여 사용합니다 (식 7, 8). 이는 클러스터 내 유사성을 높입니다.
- **거리 메트릭 $d_W$**: Weight Ratio 가정을 반영하기 위해 타겟 샘플과 소스 도메인의 가장 가까운 이웃 간의 거리를 기반으로 신뢰도를 측정하는 $d_W$를 사용합니다 (식 10).
- **최종 통합 거리 $d(x_i, x_j)$**: $d_J$와 $d_W$를 결합하여 최종 거리 메트릭을 만듭니다.
  $$d(x_i, x_j) = (1-\lambda)d_J(x_i, x_j) + \lambda(d_W(x_i) + d_W(x_j))$$
  여기서 $\lambda \in [0,1]$은 균형 매개변수입니다.
- **클러스터링 알고리즘**: 클러스터 수를 미리 알 필요 없고, 신뢰도가 낮은 점들을 제외할 수 있으며, 제안된 거리 메트릭을 통합할 수 있는 **DBSCAN**([7])을 사용하여 클러스터를 형성합니다.
- **훈련**: DBSCAN으로 생성된 의사 레이블을 가진 데이터에 대해 **triplet loss**([32])를 사용하여 인코더(ResNet-50)를 훈련합니다.

## 📊 Results

본 논문은 사람 Re-ID (Market-1501, DukeMTMC-reID) 및 차량 Re-ID (VeRi-776, PKU-VehicleID) 과제에 대해 제안된 방법을 평가했습니다. 성능은 CMC(Cumulative Matching Characteristic)와 mAP(mean Average Precision)를 사용하여 측정되었습니다.

- **사람 Re-ID 성능 (Table 2)**:

  - 제안된 자기 훈련 프레임워크는 DukeMTMC-reID $\to$ Market-1501 (rank-1: 75.8%, mAP: 53.7%) 및 Market-1501 $\to$ DukeMTMC-reID (rank-1: 68.4%, mAP: 49.0%) 전이 모두에서 Direct Transfer, Self-training Baseline, SPGAN, TJ-AIDL, ARN 등 최신 SOTA 방법들을 크게 능가했습니다.
  - 특히, $d_W$를 사용하지 않은 Ours w/o $d_W$ 버전도 기존 SOTA 방법들보다 우수했으며, $d_W$를 추가했을 때 성능이 더욱 향상되어 제안된 두 가정이 모두 효과적임을 입증했습니다.

- **차량 Re-ID 성능 (Table 3)**:

  - 차량 Re-ID (PKU-VehicleID $\to$ VeRi-776)에서도 제안된 방법은 (rank-1: 76.9%, mAP: 35.8%) Direct Transfer, Self-training Baseline, SPGAN보다 우수하여 방법의 일반화 능력을 확인했습니다.
  - 차량 Re-ID에서도 $d_W$의 기여가 관찰되었습니다.

- **수렴 및 매개변수 분석 (Figure 1, Figure 8, Table 6)**:

  - mAP 수렴 곡선은 제안된 방법이 안정적으로 수렴함을 보여줍니다.
  - 매개변수 $\lambda$ 및 $p$에 대한 분석은 이러한 매개변수가 최종 정확도에 상당한 영향을 미칠 수 있음을 보여주며, 특히 대규모 데이터셋에서는 $p$의 작은 변화가 큰 차이를 만들 수 있습니다.

- **거리 메트릭 및 클러스터링 방법 비교 (Table 4, Table 5, Figure 7)**:
  - k-reciprocal 인코딩을 사용한 Jaccard 거리가 일반 Jaccard 거리보다 성능이 좋으며, $d_W$의 통합이 Jaccard 거리 기반 방식에도 도움이 됨을 보여주었습니다.
  - DBSCAN이 Re-ID 클러스터링에 적합하며, 모든 샘플에 클러스터를 할당하는 Affinity Propagation과 같은 방법은 신뢰도가 낮은 샘플을 필터링하지 못해 성능이 저하될 수 있음을 확인했습니다.

## 🧠 Insights & Discussion

- **이론과 실제의 연결**: 본 논문은 비지도 도메인 적응 Re-ID 과제에 대한 이론적 기반을 마련하고, 이를 실용적인 자기 훈련 프레임워크로 구현하여 이론과 실제 사이의 간극을 성공적으로 메웠습니다. 이는 Re-ID 연구 분야에 중요한 기여를 합니다.
- **가정의 중요성**: 추출된 특징 공간에 대한 세 가지 가설(Covariate Shift, SPL, Weight Ratio)이 Re-ID 문제의 학습 가능성(DA-learnability)을 보장하며, 이 가설들을 강화하는 손실 함수를 통해 인코더를 훈련하는 것이 매우 효과적임을 실험적으로 입증했습니다.
- **프레임워크의 일반화 능력**: 제안된 자기 훈련 프레임워크는 사람 Re-ID뿐만 아니라 차량 Re-ID와 같은 다양한 Re-ID 과제에서도 최첨단 성능을 달성하여, 그 일반화 가능성과 강력함을 보여주었습니다.
- **한계점 및 향후 연구**:
  - **Weight Ratio 손실($L_{WR}$) 최적화**: $L_{WR}$은 infimum 항 때문에 인코더 업데이트 시 완전히 활용되지 못했습니다. 향후 연구에서는 이를 최적화할 수 있는 보다 실현 가능한 손실 함수를 설계하는 것이 중요합니다.
  - **데이터 선택 전략 개선**: 현재 자기 훈련 단계의 데이터 선택은 하드 임계값 기반의 클러스터링 문제로 변환되었습니다. 이는 거리 값들 사이의 상대적인 정보를 더 잘 활용할 수 있는 보다 유연한 전략이 존재할 수 있음을 시사합니다.
- **의의**: 본 연구의 이론적 분석은 새로운 도메인 적응 Re-ID 과제 개발의 문을 열고, 대규모 및 복잡한 네트워크 설계 부담을 줄이는 데 기여할 것으로 기대됩니다.

## 📌 TL;DR

**문제**: 비지도 도메인 적응(UDA) 재식별(Re-ID)은 이론적 토대가 부족하고, 기존 UDA 이론은 Re-ID의 고유한 쌍별 특성을 다루지 못했습니다.

**제안**: 본 논문은 기존 분류 UDA 이론을 Re-ID에 맞게 특징 공간에 대한 세 가지 가설(공변량 이동, Separately Probabilistic Lipschitzness (SPL), 가중치 비율)로 확장하고, Re-ID의 학습 가능성을 이론적으로 증명했습니다. 이 가설들을 강화하는 손실 함수($L_{intra}, L_{inter}, L_{WR}$)를 기반으로 하는 새로운 자기 훈련(self-training) 프레임워크를 제안했습니다.

**성과**: 제안된 프레임워크는 k-reciprocal 인코딩 기반 Jaccard 거리와 소스-타겟 근접성을 결합한 거리 메트릭을 사용하여 DBSCAN 클러스터링으로 의사 레이블을 생성하고, triplet loss로 인코더를 반복적으로 훈련합니다. 사람 및 차량 Re-ID 벤치마크에서 SOTA 성능을 달성하여 이론적 근거와 실용적 효과를 모두 입증했습니다.
