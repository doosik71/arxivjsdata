# Learning to Adapt Structured Output Space for Semantic Segmentation

Yi-Hsuan Tsai, Wei-Chih Hung, Samuel Schulter, Kihyuk Sohn, Ming-Hsuan Yang, Manmohan Chandraker

## 🧩 Problem to Solve

CNN 기반의 의미론적 분할(semantic segmentation) 모델은 픽셀 단위의 정답 레이블에 대한 지도 학습에 크게 의존하지만, 훈련 데이터와 다른 분포를 갖는 이미지 도메인(예: 합성 데이터에서 실제 데이터, 또는 다른 도시)에 대해서는 성능이 저하되는 도메인 갭(domain gap) 문제가 발생합니다. 새로운 도메인에 대해 픽셀 단위의 정답 레이블을 수동으로 생성하는 것은 엄청난 비용이 드는 작업입니다. 기존에는 피처 공간(feature space)에서 적대적 학습을 통해 도메인 적응을 시도했지만, 고차원 피처의 복잡성으로 인해 픽셀 단위 예측 작업에는 그 효과가 제한적이었습니다. 따라서, 도메인 갭을 효과적으로 줄이면서 픽셀 단위의 레이블링 비용 문제를 해결할 수 있는 새로운 도메인 적응 방법이 필요합니다.

## ✨ Key Contributions

- **출력 공간 적대적 학습**: 픽셀 단위 의미론적 분할을 위해 출력(분할) 공간에서 적대적 학습을 사용하는 새로운 도메인 적응 방법을 제안했습니다.
- **구조적 출력의 효과 증명**: 이미지의 외형은 달라도 분할 결과는 공간적 배치(spatial layout) 및 지역적 컨텍스트와 같은 구조적 유사성을 공유하며, 이러한 출력 공간에서의 적응이 도메인 간 정렬에 효과적임을 입증했습니다.
- **다단계 적대적 학습**: 분할 모델의 여러 피처 레벨에서 적응을 수행하여 성능을 더욱 향상시키는 다단계 적대적 학습(multi-level adversarial learning) 방식을 개발했습니다.

## 📎 Related Works

- **의미론적 분할**: FCN (Fully-Convolutional Network), DeepLab-v2, PSPNet 등 딥러닝 기반의 최첨단 방법론들은 컨텍스트 정보 활용 및 수용 필드(receptive field) 확장을 통해 성능을 개선했습니다. 레이블링 비용 문제를 완화하기 위해 약지도(weakly-supervised) 및 반지도(semi-supervised) 접근 방식과 GTA5, SYNTHIA와 같은 합성 데이터셋 활용 연구가 진행되었습니다.
- **도메인 적응 (이미지 분류)**: DANN (Domain-Adversarial Neural Network), PixelDA (픽셀 단위 변환) 등의 방법론이 피처 분포 정렬을 통해 이미지 분류 문제의 도메인 갭을 줄였습니다.
- **도메인 적응 (픽셀 단위 예측)**: Hoffman et al. [13]의 FCNs in the Wild는 피처 공간에서 적대적 학습을 적용했습니다. CyCADA [12]는 CycleGAN을 이용한 픽셀 변환과 피처 공간 적대적 학습을 결합했습니다. Cross-City [3]는 클래스별 적대적 학습에 중점을 두었습니다. 본 연구는 이들과 달리 출력 공간 적응의 이점을 강조합니다.

## 🛠️ Methodology

본 논문은 의미론적 분할을 위한 엔드-투-엔드(end-to-end) CNN 기반 도메인 적응 알고리즘을 제안하며, 주로 **분할 네트워크($G$)**와 **판별자($D_{i}$)**의 두 가지 모듈로 구성됩니다.

1. **단일 레벨 적대적 학습**:

   - **판별자 훈련**: 분할 네트워크 $G$가 생성한 분할 소프트맥스 출력 $P = G(I)$를 입력받아, 이 출력이 소스 도메인에서 왔는지 타겟 도메인에서 왔는지 판별합니다. 이를 위해 이진 교차 엔트로피 손실 $L_{d}(P)$를 사용합니다. $z=1$은 소스 도메인, $z=0$은 타겟 도메인을 나타냅니다.
     $$L_{d}(P) = -\sum_{h,w} \left( (1-z) \log(D(P)^{(h,w,0)}) + z \log(D(P)^{(h,w,1)}) \right)$$
   - **분할 네트워크 훈련**:
     - **분할 손실 ($L_{seg}$)**: 소스 이미지 $I_{s}$에 대해, 예측된 분할 출력 $P_{s} = G(I_{s})$와 정답 레이블 $Y_{s}$ 간의 표준 교차 엔트로피 손실로 계산됩니다.
       $$L_{seg}(I_{s}) = -\sum_{h,w} \sum_{c \in C} Y_{s}^{(h,w,c)} \log(P_{s}^{(h,w,c)})$$
     - **적대적 손실 ($L_{adv}$)**: 타겟 이미지 $I_{t}$에 대해, $P_{t} = G(I_{t})$가 판별자를 속여 소스 도메인 예측으로 분류되도록 유도하는 손실입니다.
       $$L_{adv}(I_{t}) = -\sum_{h,w} \log(D(P_{t})^{(h,w,1)})$$
   - **총 목적 함수**: 두 손실을 균형 있게 조절하기 위해 가중치 $\lambda_{adv}$를 사용합니다.
     $$L(I_{s},I_{t}) = L_{seg}(I_{s}) + \lambda_{adv} L_{adv}(I_{t})$$

2. **다단계 적대적 학습**:
   - 단일 레벨 적응으로는 낮은 레벨의 피처가 충분히 적응되지 않을 수 있다는 문제를 해결하기 위해, 분할 모델의 여러 피처 레벨(예: $conv4$ 레이어)에서 각각 보조 분류기(ASPP 모듈)와 별도의 판별자를 연결하여 적대적 학습을 수행합니다.
   - 총 목적 함수는 각 레벨 $i$에 대한 분할 손실 $L_{i}^{seg}(I_{s})$와 적대적 손실 $L_{i}^{adv}(I_{t})$의 가중치 합으로 확장됩니다.
     $$L(I_{s},I_{t}) = \sum_{i} \lambda_{i}^{seg} L_{i}^{seg}(I_{s}) + \sum_{i} \lambda_{i}^{adv} L_{i}^{adv}(I_{t})$$
   - 네트워크는 최종적으로 $ \max*{D} \min*{G} L(I*{s},I*{t})$의 최소-최대(min-max) 게임을 통해 훈련됩니다.
3. **네트워크 아키텍처 및 훈련**:
   - **분할 네트워크**: DeepLab-v2 프레임워크와 ImageNet으로 사전 학습된 ResNet-101을 백본으로 사용합니다. 마지막 두 합성곱 레이어의 스트라이드(stride)를 1로 수정하고, Atrous Spatial Pyramid Pooling (ASPP)을 최종 분류기로 사용합니다.
   - **판별자**: 5개의 합성곱 레이어로 구성된 완전 합성곱 네트워크를 사용하여 공간 정보를 유지합니다.
   - **훈련**: 분할 네트워크와 판별자를 한 단계에서 공동으로 훈련하며, SGD (분할 네트워크)와 Adam (판별자) 옵티마이저를 사용합니다.

## 📊 Results

제안된 방법은 다양한 도메인 적응 시나리오(합성-실제, 도시 간)에서 광범위한 실험을 통해 우수한 성능을 입증했습니다.

- **GTA5 $\rightarrow$ Cityscapes 적응**:
  - VGG-16 기반 모델에서 단일 레벨 출력 공간 적응은 기존 SOTA 방법론 (CyCADA, FCNs in the Wild 등)보다 평균 IoU (mIoU)가 높았습니다 (예: 본 방법 35.0% vs CyCADA (pixel) 34.8%).
  - ResNet-101 기반의 강력한 베이스라인에서는 다단계 출력 공간 적응이 42.4%의 mIoU를 달성하여 베이스라인 (36.6%), 피처 적응 (39.3%), 단일 레벨 출력 공간 적응 (41.4%) 대비 가장 높은 성능을 기록했습니다.
  - 완전 지도(fully-supervised) 모델과의 mIoU 격차를 22.7%로 줄여, 기존 방법론 대비 가장 작은 격차를 보였습니다.
- **SYNTHIA $\rightarrow$ Cityscapes 적응**:
  - GTA5 결과와 유사하게, 단일 레벨 출력 공간 적응은 VGG-16 기반에서 SOTA (Cross-City) 대비 우수했으며 (mIoU 37.6% vs Cross-City 35.7%), 다단계 출력 공간 적응은 ResNet-101 기반에서 46.7%의 mIoU를 달성하여 가장 우수한 성능을 보였습니다.
  - 완전 지도 모델과의 격차를 25.0%로 줄여, 30% 미만으로 격차를 최소화한 유일한 방법론이었습니다.
- **Cross-City Dataset (Cityscapes $\rightarrow$ Rome/Rio/Tokyo/Taipei) 적응**:
  - 상대적으로 도메인 갭이 작은 도시 간 적응 시나리오에서도 제안된 다단계 모델은 모든 타겟 도시에서 일관된 mIoU 향상을 보여주었습니다 (예: Rome 53.8% vs 베이스라인 50.9%).
- **하이퍼파라미터($\lambda_{adv}$) 분석**: 출력 공간 적응은 피처 공간 적응보다 $\lambda_{adv}$ 값에 덜 민감하여, 더 넓은 범위의 하이퍼파라미터에서 안정적인 성능을 유지했습니다.
- **LS-GAN (Least Squares GAN)**: 부록에서 Vanilla GAN 대신 LS-GAN 목적 함수를 사용했을 때 mIoU가 추가적으로 향상됨을 보였습니다 (예: GTA5 $\rightarrow$ Cityscapes에서 41.4% $\rightarrow$ 44.1%).

## 🧠 Insights & Discussion

- 이 연구의 핵심 통찰은 의미론적 분할 결과가 단순히 픽셀별 레이블이 아니라, 장면 배치와 지역적 컨텍스트와 같은 풍부한 구조적 정보를 포함하며, 이러한 정보는 도메인 간에도 상당한 유사성을 공유한다는 것입니다. 이러한 특성을 활용하여 출력 공간에서 직접 도메인 적응을 수행하는 것이 효과적입니다.
- 출력 공간에서의 적응은 고차원 피처 공간에서의 적응보다 더 안정적이고 효과적입니다. 이는 고차원 피처 공간에서는 판별자가 소스와 타겟 분포를 쉽게 구별하여 적대적 학습이 효과적으로 이루어지지 않을 수 있는 반면, 출력 공간에서는 더 의미 있는 분포 정렬이 가능하기 때문입니다. 특히 $\lambda_{adv}$에 대한 민감도가 낮다는 것은 훈련의 안정성을 보여줍니다.
- 다단계 적대적 학습은 모델의 다양한 피처 레벨에서 적응을 유도함으로써 전체적인 적응 능력을 향상시키고 성능 개선에 기여합니다.
- 강력한 베이스라인 모델에 적용될 때, 본 제안 방법은 실제 적용에 필요한 높은 성능을 달성하며 도메인 갭을 효과적으로 줄이는 실용성을 보여주었습니다.
- 한계점으로는, 폴이나 표지판과 같이 작고 배경에 쉽게 묻힐 수 있는 객체들은 여전히 적응하기 어렵다는 점이 있습니다. 그럼에도 불구하고, 본 방법론은 다양한 픽셀 단위 예측 작업에 적용될 수 있는 일반적인 적응 모델로서의 잠재력을 가지고 있습니다.

## 📌 TL;DR

의미론적 분할의 도메인 갭 문제 해결을 위해, 이 논문은 **출력 공간에서 적대적 학습**을 수행하는 새로운 방법을 제안합니다. 이미지 외형은 달라도 분할 결과는 구조적 유사성을 가진다는 점에 착안, 분할 네트워크와 판별자를 사용하여 타겟 도메인 예측이 소스 도메인 예측 분포와 유사해지도록 학습시킵니다. 또한, 여러 피처 레벨에서 적응을 수행하는 **다단계 적대적 학습** 방식을 도입하여 성능을 더욱 향상시켰습니다. 합성 데이터셋에서 실제 데이터셋으로의 적응 및 도시 간 적응 시나리오에서 기존 SOTA 방법론 대비 **우수한 성능**을 입증하며, 출력 공간 적응의 효율성과 안정성을 강조했습니다.
