# Universal Domain Adaptation through Self-Supervision

Kuniaki Saito, Donghyun Kim, Stan Sclaroff, Kate Saenko

## 🧩 Problem to Solve

기존의 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) 방법들은 타겟 도메인의 모든 카테고리가 소스 도메인에도 존재한다고 가정합니다. 그러나 실제 시나리오에서는 두 도메인 간의 카테고리 중첩에 대해 알려진 바가 거의 없습니다. 일부 방법들이 부분(partial) 또는 개방형(open-set) 카테고리 시나리오를 다루지만, 이는 특정 설정이 사전에 알려져 있다는 가정을 전제로 합니다. 즉, 타겟 도메인의 카테고리 분포(closed-set, open-set, partial, open-partial)를 미리 알지 못할 경우, 기존 방법들은 제대로 작동하지 않을 수 있으며, 이는 '범용 도메인 적응(Universal Domain Adaptation, UniDA)'이라는 더 큰 문제로 이어집니다. 또한, 소스 도메인의 지도 학습에 지나치게 의존하면 타겟 도메인 고유의 판별적 특징, 특히 '알 수 없는(unknown)' 카테고리에 대한 특징을 학습하기 어렵습니다.

## ✨ Key Contributions

- **범용 도메인 적응 프레임워크 DANCE 제안**: 사전 지식 없이도 임의의 카테고리 변화(closed-set, partial, open-set, open-partial DA)를 처리할 수 있는 DANCE(Domain Adaptative Neighborhood Clustering via Entropy optimization)를 제안합니다.
- **두 가지 새로운 손실 함수 개발**:
  - **이웃 클러스터링(Neighborhood Clustering, NC) 손실**: 타겟 도메인의 클러스터 구조를 자체 지도 방식으로 학습하여 판별적인 특징을 추출합니다.
  - **엔트로피 분리(Entropy Separation, ES) 손실**: 타겟 특징을 소스 카테고리에 정렬시키거나, 엔트로피를 기반으로 '알 수 없는' 카테고리로 거부하는 메커니즘을 제공합니다.
- **모든 DA 설정에서 우수한 성능 입증**: DANCE는 모든 개방형(open-set, open-partial) DA 설정에서 최첨단 성능을 달성했으며, 모든 시나리오(closed-set, open-set, partial, open-partial DA)에서 source-only 모델보다 뛰어난 유일한 방법임을 실험적으로 보였습니다.
- **'알 수 없는' 타겟 샘플의 판별적 특징 학습**: 타겟 도메인에 대한 어떠한 지도 없이도 '알 수 없는' 타겟 샘플에 대한 판별적인 특징을 학습하는 능력을 보여줍니다.

## 📎 Related Works

- **Closed-set Domain Adaptation (CDA)**: 소스 ($L_s$)와 타겟 ($L_t$)의 클래스 집합이 동일하다고 가정합니다 ($L_s = L_t$). 특징 분포 정렬(예: DANN, CDAN, MDD)이나 유사 레이블링, 클러스터링 기반 방법들이 주로 사용됩니다.
- **Partial Domain Adaptation (PDA)**: 타겟 클래스들이 소스 클래스들의 부분집합이라고 가정합니다 ($L_t \subset L_s$). 소스 샘플에 중요도 가중치를 적용하여 해결합니다(예: ETN, SAN).
- **Open-set Domain Adaptation (ODA)**: 타겟 도메인에 소스 도메인에 없는 '알 수 없는' 클래스가 존재한다고 가정합니다 ($L_s \subset L_t$). 하지만 이 방법들은 타겟에 '알 수 없는' 클래스가 반드시 존재한다고 가정하여 closed-set 또는 partial DA에서 실패할 수 있습니다(예: STA).
- **Universal Domain Adaptation (UniDA)**: PDA와 ODA의 혼합 형태인 Open-Partial DA (OPDA)를 포함하여 모든 카테고리 변화를 다루려는 시도가 있었습니다(예: UAN).
- **Entropy Minimization**: 비지도 학습에서 레이블 없는 샘플의 예측에 대한 확신도를 높이는 데 사용됩니다. DANCE의 엔트로피 분리 손실은 '알려진' 클래스에 대한 확신도를 높이는 동시에 '알 수 없는' 클래스에 대한 확신도를 낮춰 거부할 수 있도록 합니다.
- **Self-Supervised Learning**: 퍼즐 풀이, 인스턴스 판별, 딥 클러스터링 등 보조 작업을 통해 레이블 없는 이미지에서 유용한 특징을 학습합니다. DANCE의 NC는 클러스터 중심을 지정하지 않고 샘플을 클러스터링하며, 기존 방법들이 UniDA에 직접 적용하기 어려운 한계를 극복합니다.

## 🛠️ Methodology

DANCE는 사전 지식 없이 어떤 카테고리 변화도 처리하기 위해 타겟 도메인 샘플을 $L_s$ 레이블 또는 '알 수 없는' 레이블 중 하나로 분류하는 것을 목표로 합니다.

1. **네트워크 아키텍처**: ResNet50을 특징 추출기($G$)로 사용하고, 마지막 선형 레이어 앞에 L2 정규화 레이어를 둔 프로토타입 기반 분류기($W$)를 채택합니다. $W$의 가중치 벡터 $w_k$는 각 클래스의 프로토타입으로 간주됩니다.
2. **이웃 클러스터링 (Neighborhood Clustering, NC)**:
   - 타겟 샘플들이 잘 클러스터링되도록 자체 지도 방식으로 학습합니다.
   - 각 타겟 포인트 $f_i$가 소스 도메인의 '알려진' 클래스 프로토타입 또는 타겟 도메인 내의 이웃에 가깝게 이동하도록 합니다.
   - 이를 위해 모든 타겟 샘플 특징과 프로토타입 벡터를 저장하는 **메모리 뱅크($V$, $F$)**를 활용합니다.
   - 각 타겟 특징 $f_i$와 메모리 뱅크 내 다른 특징/프로토타입 $F_j$ 사이의 유사도 분포에 대한 엔트로피를 최소화합니다:
     $$p_{i,j} = \frac{\exp(F_j^\top f_i / \tau)}{Z_i}$$
     여기서 $Z_i = \sum_{k=1, k \neq i}^{N_t+K} \exp(F_k^\top f_i / \tau)$ 이고, $\tau$는 온도(temperature) 파라미터입니다.
   - NC 손실은 다음과 같습니다: $L_{nc} = -\frac{1}{|B_t|} \sum_{i \in B_t} \sum_{j=1, j \neq i}^{N_t+K} p_{i,j} \log(p_{i,j})$
3. **엔트로피 분리 손실 (Entropy Separation loss, ES)**:
   - 타겟 샘플을 '알려진' 클래스에 정렬하거나 '알 수 없는' 클래스로 거부하도록 유도합니다.
   - 분류기 출력 $p$의 엔트로피 $H(p)$가 '알 수 없는' 샘플에서 더 클 것이라는 가설에 기반합니다.
   - '알려진'/'알 수 없는' 샘플을 구분하는 임계값 $\rho = \frac{\log(K)}{2}$ (소스 클래스 수 $K$에 기반)를 설정하고, $H(p)$가 $\rho$로부터 멀어지도록 손실을 최대화합니다.
   - 신뢰도 임계값 $m$을 도입하여, $|H(p_i) - \rho|$가 $m$보다 충분히 클 때만 손실을 적용합니다:
     $$L_{es}(p_i) = \begin{cases} -|H(p_i) - \rho| & \text{if } (|H(p_i) - \rho| > m) \\ 0 & \text{otherwise} \end{cases}$$
   - 전체 ES 손실은 $L_{es} = \frac{1}{|B_t|} \sum_{i \in B_t} L_{es}(p_i)$ 입니다.
4. **도메인별 배치 정규화(Domain-Specific Batch Normalization)**: 소스 및 타겟 샘플을 별도의 미니 배치로 처리하여 약한 도메인 정렬 효과를 제공합니다. 이는 강한 정렬이 비-closed-set DA에 해로울 수 있으므로 DANCE의 목표에 부합합니다.
5. **최종 목적 함수**: $L = L_{cls} + \lambda(L_{nc} + L_{es})$, 여기서 $L_{cls}$는 소스 샘플에 대한 교차 엔트로피 손실입니다.

## 📊 Results

- **범용 성능 우위 (표 1)**: DANCE는 모든 DA 설정(CDA, PDA, ODA, OPDA)에서 source-only 모델보다 성능을 향상시키는 유일한 방법입니다. 평균 정확도 및 순위에서 다른 모든 기준선보다 훨씬 우수합니다.
- **각 DA 설정에서의 성능 (표 2, 3, 4)**:
  - **CDA**: source-only 모델 대비 크게 개선되었으며, OfficeHome 벤치마크에서는 일부 전문화된 방법보다 우수합니다.
  - **PDA**: source-only 모델 대비 크게 개선되었으며, VisDA 및 OfficeHome에서는 모든 기준선을 능가합니다.
  - **ODA**: ODA 전용 방법들을 포함한 모든 기준선을 능가합니다.
- **특징 시각화 (그림 3)**: t-SNE 시각화를 통해 DANCE가 '알려진' 타겟 특징들을 잘 클러스터링하고, '알 수 없는' 특징들을 '알려진' 특징들로부터 멀리 떨어뜨려 놓으며, 심지어 '알 수 없는' 클래스 내에서도 유사한 샘플들이 함께 클러스터링되는 것을 보여줍니다.
- **'알 수 없는' 예제 클러스터링 (표 5)**: DANCE는 ImageNet 사전 학습 모델보다 '알려진' 및 '알 수 없는' 클래스 모두에 대해 더 잘 클러스터링된 특징을 제공하여, 적은 수의 레이블로도 선형 분류 정확도를 향상시킵니다.
- **클래스 수에 대한 강건성 (그림 4)**: '알 수 없는' 클래스 수 또는 소스 전용 클래스 수가 증가하더라도 DANCE는 다른 방법들보다 일관되게 우수한 성능과 강건성을 유지합니다.

## 🧠 Insights & Discussion

- DANCE의 핵심은 도메인 간의 **임의적인 카테고리 변화에 대한 사전 지식 없이도** 효과적으로 작동한다는 점입니다. 이는 실제 환경에서 도메인 적응의 적용 가능성을 크게 확장합니다.
- **자체 지도 방식의 NC 손실**은 소스 도메인의 지도 학습만으로는 얻기 어려운 타겟 도메인 고유의 판별적 특징, 특히 '알 수 없는' 카테고리에 대한 특징을 학습하는 데 결정적인 역할을 합니다.
- **ES 손실**은 '알려진' 샘플을 소스 프로토타입에 정렬시키는 동시에 '알 수 없는' 샘플을 효과적으로 거부하는 정교한 메커니즘을 제공합니다. 이는 범용 DA를 위한 필수적인 기능입니다.
- **도메인별 배치 정규화**를 통한 약한 도메인 정렬은 비-closed-set DA 설정에서 강한 특징 정렬이 야기할 수 있는 성능 저하를 방지하면서도 충분한 효과를 발휘합니다.
- **긍정적 영향**: 이 연구는 대규모 레이블링된 데이터 수집의 부담을 줄여, 딥러닝 기술을 더 많은 기관 및 개인에게 접근 가능하게 하며, 데이터 수집이 어렵거나 민감한 분야(예: 시뮬레이션-실제, 의료 이미지)에 유용하게 활용될 수 있습니다.
- **제한 사항**: 모든 딥러닝 시스템과 마찬가지로 DANCE도 적대적 공격에 취약하며 해석 가능성이 부족합니다. 또한, 음성 전이(negative transfer)의 가능성이 여전히 존재하므로, 인간의 감독 없이 임무 중요 애플리케이션에 사용되어서는 안 됩니다.

## 📌 TL;DR

**문제**: 기존 도메인 적응(DA) 방법들은 타겟 도메인의 카테고리 분포(closed-set, partial, open-set 등)를 미리 알아야 하는 한계가 있으며, 이를 모르는 '범용 도메인 적응(Universal DA)' 문제 해결이 필요합니다.

**제안 방법**: DANCE(Domain Adaptative Neighborhood Clustering via Entropy optimization)는 이 문제를 해결하기 위해 두 가지 핵심 아이디어를 제안합니다. 첫째, **이웃 클러스터링(Neighborhood Clustering, NC)**을 통해 타겟 도메인 내에서 자체적으로 클러스터 구조를 학습하여 판별적인 특징을 추출합니다. 둘째, **엔트로피 분리 손실(Entropy Separation loss, ES)**을 사용하여 타겟 샘플을 소스 도메인의 '알려진(known)' 카테고리에 정렬시키거나, 엔트로피 수준에 따라 '알 수 없는(unknown)' 카테고리로 분류하여 거부합니다.

**주요 결과**: DANCE는 모든 유형의 DA 설정(closed-set, partial, open-set, open-partial)에서 기존 source-only 모델을 유일하게 능가하는 성능을 보였습니다. 특히 open-set 및 open-partial DA에서 최첨단 성능을 달성했으며, 알려지지 않은 타겟 샘플에 대해서도 지도 학습 없이 판별적인 특징을 효과적으로 학습하여 범용 도메인 적응의 가능성을 입증했습니다.
