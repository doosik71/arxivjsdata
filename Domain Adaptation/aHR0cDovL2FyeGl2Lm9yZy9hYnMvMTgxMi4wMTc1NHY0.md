# Moment Matching for Multi-Source Domain Adaptation

Xingchao Peng, Qinxun Bai, Xide Xia, Zijun Huang, Kate Saenko, Bo Wang

## 🧩 Problem to Solve

기존의 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) 연구는 훈련 데이터가 단일 소스 도메인에서 샘플링된다는 가정을 합니다. 하지만 실제 시나리오에서는 훈련 데이터가 여러 소스 도메인에서 수집되는 경우가 많으며, 이는 다중 소스 도메인 적응(Multi-Source Domain Adaptation, MSDA) 문제를 야기합니다. MSDA는 다음과 같은 주요 도전 과제를 가지고 있습니다:

- 다수의 소스 도메인 존재로 인해 기존 단일 UDA 방법의 효과가 저해됩니다.
- 소스 도메인들 사이에도 도메인 시프트(domain shift)가 존재합니다.
- 대규모 다중 도메인 데이터셋의 부족으로 MSDA 모델 개발이 어렵습니다.

## ✨ Key Contributions

이 논문은 다중 소스 도메인 적응 문제 해결을 위해 세 가지 주요 기여를 합니다.

- **대규모 도메인 적응 데이터셋 'DomainNet' 구축**: 6개 도메인, 345개 카테고리, 약 0.6백만 개의 이미지를 포함하는 현재까지 가장 큰 UDA 데이터셋인 DomainNet을 수집 및 주석 처리하여, MSDA 연구를 위한 데이터 가용성 문제를 해결합니다.
- **새로운 딥러닝 접근 방식 'M3SDA' 제안**: Moment Matching for Multi-Source Domain Adaptation (M$^3$SDA)라는 새로운 딥러닝 접근 방식을 제안합니다. 이 방법은 여러 레이블이 지정된 소스 도메인에서 학습된 지식을 레이블이 없는 타겟 도메인으로 전이하기 위해 피처 분포의 모멘트를 동적으로 정렬합니다. 이는 소스-타겟뿐만 아니라 소스-소스 도메인 간의 정렬도 포함합니다.
- **모멘트 매칭 접근법을 위한 이론적 통찰 제공**: 단일 및 다중 소스 도메인 적응 모두에서 모멘트 매칭 접근법을 위한 새로운 이론적 통찰을 제공하며, 특히 모멘트 기반 발산에 대한 엄격한 에러 상한을 제시합니다.

## 📎 Related Works

- **도메인 적응 데이터셋**: Office, Office-Caltech10, PACS, Open MIC, Syn2Real 등 기존 데이터셋들은 규모가 작거나 카테고리 수가 제한적이어서 벤치마크 포화 문제를 겪었습니다.
- **단일 소스 UDA**:
  - **불일치 기반(Discrepancy-based)**: MMD (Maximum Mean Discrepancy) [27, 41], 상관 관계 정렬 (Correlation Alignment, CORAL) [39], Kullback-Leibler (KL) 발산 [51] 등이 분포 차이를 줄이는 데 사용됩니다.
  - **적대적 기반(Adversarial-based)**: 도메인 판별자(domain discriminator)를 사용하여 도메인 혼란(domain confusion)을 유도하는 DANN [8, 40] 및 GAN 기반 [50, 15] 방법들이 있습니다.
  - **재구성 기반(Reconstruction-based)**: 데이터 재구성을 통해 도메인 불변 피처를 학습하는 Dual-GAN [46], Cycle-GAN [50] 등이 있습니다.
- **다중 소스 도메인 적응(MSDA)**:
  - **이론적 연구**: H∆H-divergence 기반 [1, 28, 4, 14] 분석이 초기 연구에 제안되었습니다.
  - **응용 연구**: k-방향 도메인 판별자를 사용하는 Deep Cocktail Network (DCTN) [45] 및 Domain Selection Machine [6] 등이 있습니다.
- **모멘트 매칭(Moment Matching)**: MMD [27, 41]는 1차 모멘트를, CORAL [39]은 2차 모멘트를 매칭합니다. Zellinger et al. [47]은 고차 모멘트를 정렬하는 모멘트 매칭 정규화 기법을 제안했습니다. GAN 기반으로는 McGAN [29], GMMN [22], MMD GAN [20] 등이 있습니다.

## 🛠️ Methodology

저자들은 레이블이 지정된 $N$개의 소스 도메인 $D_S = \{D_1, D_2, ..., D_N\}$과 레이블이 없는 타겟 도메인 $D_T$가 주어졌을 때, $D_T$에서의 타겟 에러를 최소화하는 것을 목표로 합니다.

- **모멘트 거리(Moment Distance) 정의**:
  다중 소스 도메인 $D_S$와 타겟 도메인 $D_T$ 간의 모멘트 거리를 다음과 같이 정의합니다. 이 거리는 각 소스 도메인과 타겟 도메인 간의 모멘트 차이뿐만 아니라, 각 소스 도메인 쌍 간의 모멘트 차이까지 고려합니다.

  $$
  MD^2(D_S,D_T) = \sum_{k=1}^2 \left( \frac{1}{N} \sum_{i=1}^N \|E(X_i^k) - E(X_T^k)\|^2 + \left(\frac{N}{2}\right)^{-1} \sum_{i=1}^{N-1} \sum_{j=i+1}^N \|E(X_i^k) - E(X_j^k)\|^2 \right)
  $$

  여기서 $E(X^k)$는 $k$-번째 모멘트, $N$은 소스 도메인의 수입니다.

- **M$^3$SDA 프레임워크**:

  - **피처 추출기 ($G$)**: 모든 도메인의 데이터를 공통 잠재 피처 공간으로 매핑합니다.
  - **모멘트 매칭 컴포넌트**: 위에서 정의한 모멘트 거리 $MD^2(D_S, D_T)$를 최소화합니다.
  - **$N$개의 분류기 ($C = \{C_1, ..., C_N\}$)**: 각 소스 도메인에 대해 교차 엔트로피 손실로 훈련됩니다.

- **전체 목적 함수**:
  $$ \min*{G,C} \sum*{i=1}^N L*{D_i} + \lambda \min_G MD^2(D_S, D_T) $$
  여기서 $L*{D_i}$는 도메인 $D_i$에 대한 분류기 $C_i$의 소프트맥스 교차 엔트로피 손실이며, $\lambda$는 트레이드오프 파라미터입니다.

- **M$^3$SDA-β**:
  피처 분포 $p(x)$뿐만 아니라 조건부 분포 $p(y|x)$도 정렬하기 위해 [38]의 훈련 패러다임을 따릅니다.

  1. **분류 및 모멘트 정렬**: $G$와 $N$쌍의 분류기 $C' = \{(C_1, C_1'), ..., (C_N, C_N')\}$를 훈련하여 다중 소스 샘플을 올바르게 분류하고 모멘트를 정렬합니다 (Eq. 2와 유사).
  2. **분류기 불일치 최대화**: $G$를 고정하고 $C'$를 훈련하여 타겟 도메인에서 각 분류기 쌍의 불일치(L1-거리)를 최대화합니다.
     $$ \min*{C'} \sum*{i=1}^N L*{D_i} - \sum_i |P*{C*i}(D_T) - P*{C_i'}(D_T)| $$
  3. **분류기 불일치 최소화**: $C'$를 고정하고 $G$를 훈련하여 타겟 도메인에서 각 분류기 쌍의 불일치를 최소화합니다.
     $$ \min*G \sum_i |P*{C*i}(D_T) - P*{C_i'}(D_T)| $$
     이 세 단계는 네트워크가 수렴할 때까지 주기적으로 수행됩니다.

- **앙상블 스키마(Ensemble Schema) (테스트 단계)**:

  - **M$^3$SDA\***: 모든 분류기의 출력을 단순히 평균합니다.
  - **M$^3$SDA**: 소스 도메인과 타겟 도메인 간의 근접도를 반영하는 가중치 벡터 $W$를 사용하여 분류기 출력의 가중 평균을 계산합니다. $w_i = acc_i / \sum_{j=1}^{N-1} acc_j$로 정의되며, $acc_i$는 $i$-번째 소스 도메인과 타겟 도메인 간의 소스 전용 정확도입니다.

- **이론적 통찰 (정리 1)**:
  타겟 에러의 상한이 소스 도메인 $D_j$와 타겟 도메인 $D_T$ 간의 쌍별 교차 모멘트 발산 $d_{CM_k}(D_j, D_T)$에 명시적으로 의존함을 보여줍니다. 이는 모멘트 매칭 접근법에 대한 직접적인 동기를 부여하며, $d_{CM_k}$의 삼각 부등식은 소스 도메인들 간의 모멘트 정렬 또한 중요함을 시사합니다.

## 📊 Results

저자들은 Digit Recognition (MNIST, SVHN, USPS 등 5개 데이터셋), Office-Caltech10, 그리고 새로 구축한 DomainNet 데이터셋에서 광범위한 실험을 수행했습니다.

- **Digit Recognition (표 2)**:

  - M$^3$SDA는 86.13%의 평균 정확도를 달성했으며, M$^3$SDA-β는 87.65%로 성능을 향상시켜 다른 모든 베이스라인을 크게 능가했습니다.
  - 일부 데이터셋(예: MNIST-M)에서 낮은 성능을 보였는데, 이는 부정적 전이(negative transfer) 현상 때문일 수 있습니다.

- **Office-Caltech10 (표 4)**:

  - M$^3$SDA는 96.1%의 평균 정확도를 기록했으며, M$^3$SDA-β는 96.4%로 다시 한번 성능을 끌어올려 이 데이터셋에서 보고된 최고 성능을 달성했습니다.

- **DomainNet (표 3, 5)**:

  - **단일 소스 적응 (표 3)**: DomainNet은 특히 `infograph`와 `quickdraw` 도메인에서 매우 도전적인 데이터셋임이 입증되었으며, 이는 많은 수의 카테고리 때문으로 분석됩니다. 카테고리 수가 증가함에 따라 대부분의 모델 성능이 급격히 저하되었습니다 (그림 4, 5).
  - **다중 소스 도메인 적응 (표 5)**:
    - M$^3$SDA는 41.5%의 평균 정확도를, M$^3$SDA-β는 42.6%를 달성하여 `single best` UDA 결과, `source combine` 결과, 그리고 `Deep Cocktail Network (DCTN)`과 같은 다중 소스 베이스라인을 현저히 능가했습니다.
    - M$^3$SDA의 가중치 평균 스키마는 단순 평균 (M$^3$SDA\*)보다 평균 정확도를 0.7% 개선했습니다.
    - `quickdraw`를 타겟 도메인으로 설정했을 때, 일부 모델에서 부정적 전이가 발생했습니다.

- **Ablation Study (표 6)**:
  - 소스-타겟 (S-T) 정렬은 가장 큰 성능 향상을 가져왔으며, 소스-소스 (S-S) 정렬은 추가적인 성능 향상을 제공하여 MSDA에서 소스 도메인들 간의 정렬이 필수적임을 실험적으로 입증했습니다.
- **피처 시각화 (그림 6)**: M$^3$SDA-β가 DAN보다 더 판별적이고 응집력 있는 피처를 학습하는 것으로 나타났습니다.

## 🧠 Insights & Discussion

- **실용적 필요성**: 기존의 단일 소스 UDA는 실제 다중 소스 환경에 부적합하며, MSDA는 더욱 현실적이고 복잡한 문제임을 강조합니다.
- **모멘트 매칭의 중요성**: 소스-타겟 도메인뿐만 아니라 소스-소스 도메인 간의 피처 분포 모멘트를 명시적으로 정렬하는 것이 다중 소스 환경에서 효과적인 지식 전이를 위한 핵심 요소임을 이론적, 실험적으로 입증했습니다.
- **이론적 기반 강화**: 모멘트 기반 발산을 통합한 새로운 타겟 에러 상한은 제안된 모멘트 매칭 방법론에 대한 견고한 이론적 근거를 제공하며, 이는 기존 연구에서 부족했던 부분입니다.
- **DomainNet의 도전 과제**: 새로 구축된 DomainNet은 대규모 카테고리와 이질적인 도메인 분포로 인해 기존 UDA 방법들의 성능 한계를 명확히 드러내며, 향후 MSDA 연구의 중요한 벤치마크 역할을 할 것으로 기대됩니다.
- **부정적 전이(Negative Transfer)**: 특정 시나리오에서 관찰된 부정적 전이는 MSDA의 복잡성을 보여주며, 소스 도메인 간의 관계를 신중하게 고려하는 모델 설계의 중요성을 시사합니다.
- **M$^3$SDA-β의 강점**: $p(y|x)$ 및 $p(x)$ 분포를 동시에 정렬하는 M$^3$SDA-β의 접근 방식은 피처 수준의 정렬과 함께 카테고리 수준의 정렬이 성능 향상에 기여함을 보여줍니다.

## 📌 TL;DR

- **문제**: 대부분의 기존 UDA 연구는 단일 소스 도메인을 가정하지만, 실제 환경에서는 다중 소스 도메인 적응(MSDA)이 필수적이며, 이는 대규모 데이터 부족 및 소스 도메인 간의 이질성으로 인해 도전적입니다.
- **제안 방법**:
  - **DomainNet**: MSDA 연구를 위한 최대 규모의 (6개 도메인, 345개 카테고리, 약 0.6백만 이미지) 벤치마크 데이터셋을 공개했습니다.
  - **M3SDA**: 딥러닝 기반 모델로, 소스 도메인들과 타겟 도메인 간, 그리고 소스 도메인들 서로 간의 피처 분포 모멘트를 동적으로 정렬하여 지식 전이를 수행합니다. 조건부 분포까지 정렬하는 M3SDA-β도 제안했습니다.
  - **이론**: 모멘트 기반 발산을 활용한 새로운 타겟 에러 상한을 도출하여 모멘트 매칭의 이론적 근거를 제시했습니다.
- **주요 결과**: M3SDA-β는 Digit, Office-Caltech10, DomainNet 벤치마크에서 기존 단일 및 다중 소스 UDA 방법들을 크게 능가하는 최신 성능을 달성했습니다. DomainNet은 기존 방법들의 한계를 드러내는 도전적인 데이터셋임을 입증했으며, 소스 도메인 간의 정렬이 MSDA 성능 향상에 결정적임을 실험적으로 확인했습니다.
