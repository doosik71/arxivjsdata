# DACS: Domain Adaptation via Cross-domain Mixed Sampling

Wilhelm Tranheden, Viktor Olsson, Juliano Pinto, Lennart Svensson

## 🧩 Problem to Solve

컨볼루션 신경망 기반의 의미론적 분할(Semantic Segmentation) 모델은 훈련 도메인과 테스트 도메인 간에 상당한 차이("도메인 시프트")가 있을 때, 특히 합성 데이터(synthetic data)에서 실제 데이터(real data)로 넘어갈 때 일반화 성능이 저하됩니다. 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA)은 레이블이 지정된 소스 도메인 데이터와 레이블이 없는 타겟 도메인 데이터를 동시에 활용하여 이 문제를 해결하고자 합니다. 기존 의사 레이블(pseudo-label) 기반 UDA 방법들은 도메인 시프트로 인해 저품질 의사 레이블이 생성되어, 일부 클래스가 다른 클래스와 혼동되거나("클래스 혼동", class conflation) 아예 예측되지 않는 문제가 발생합니다. 이로 인해 특히 의미론적 경계에서의 훈련 신호가 약해집니다.

## ✨ Key Contributions

- **교차 도메인 혼합 샘플링 알고리즘 도입:** 타겟 도메인 이미지와 소스 도메인 이미지를 혼합하여 새로운, 심하게 왜곡된 샘플을 생성하고 이를 훈련에 사용합니다.
- **클래스 혼동 문제 해결:** 도메인 간의 이미지 혼합이 클래스 혼동 문제를 효과적으로 해결함을 입증합니다.
- **최고 수준 성능 달성:** GTA5$\rightarrow$Cityscapes 벤치마크에서 UDA 분야의 최첨단(state-of-the-art) 성능을 경신했습니다.

## 📎 Related Works

- **의미론적 분할 UDA:** 적대적 학습 기반(픽셀/특징/의미론적 수준 정렬), 자가 훈련(pseudo-labelling), 일관성 기반 접근 방식 등이 있습니다.
- **의사 레이블링(Pseudo-labelling):** 네트워크 예측을 기반으로 인공적인 훈련 타겟을 생성하는 기술로, UDA에 적용되었으나 도메인 시프트로 인한 잘못된 의사 레이블(예: 초기 전이하기 쉬운 클래스에 대한 편향, 클래스 혼동) 문제가 있습니다. 이를 완화하기 위해 클래스 균형 샘플링 및 불확실성 추정 기법이 제안되었습니다.
- **일관성 정규화(Consistency Regularization):** 레이블이 없는 샘플에 대한 예측이 섭동(perturbation)에 불변해야 한다는 아이디어입니다. 준지도 학습(SSL)에서는 이미지 증강 기반으로 사용되며, UDA에서는 이미지 간 변환과 함께 분포 불일치 최소화에 활용됩니다.
- **혼합(Mixing) 기법:** Mixup, CutMix, ClassMix와 같이 두 훈련 이미지의 픽셀을 결합하여 새로운 샘플을 생성하는 증강 기술입니다. 특히 ClassMix는 네트워크 예측을 기반으로 마스크를 동적으로 생성하여 객체의 의미론적 경계를 따르는 혼합을 수행합니다. 본 연구는 ClassMix를 도메인 간 혼합에 적용하여 기존 일관성 기반 UDA 방법과 차별점을 둡니다.

## 🛠️ Methodology

DACS(Domain Adaptation via Cross-domain mixed Sampling)는 기존 SSL(Semi-Supervised Learning)에서 사용되던 혼합 기반 일관성 정규화를 UDA에 직접 적용했을 때 발생하는 "클래스 혼동" 문제를 해결합니다.

1. **"Naive Mixing"의 문제점:** 타겟 도메인 내에서만 이미지를 혼합하는 "Naive Mixing" 방식은 실질적으로 성능이 저하되며, '보도(sidewalk)'가 '도로(road)'로, '탑승자(rider)'가 '사람(person)'으로 혼동되는 등 클래스 혼동 문제가 발생합니다. 이는 의사 레이블링에서 발생하는 문제와 유사합니다.
2. **DACS의 교차 도메인 혼합:**
   - 소스 도메인 이미지 $X_S$와 타겟 도메인 이미지 $X_T$를 혼합하여 새로운 증강 이미지 $X_M$을 생성합니다.
   - 소스 이미지의 정답 레이블 $Y_S$와 타겟 이미지의 네트워크 예측 의사 레이블 $\hat{Y}_T$를 혼합하여 증강 레이블 $Y_M$을 만듭니다.
   - 기본적으로 ClassMix [29] 전략을 사용하며, 소스 이미지의 클래스 절반을 선택하여 해당 픽셀을 잘라 타겟 이미지에 붙여넣습니다.
   - 이러한 교차 도메인 혼합을 통해 소스 도메인의 신뢰할 수 있는 정답 레이블이 타겟 도메인의 의사 레이블에 주입되어, 클래스 혼동 문제를 해결하고 도메인 간 격차를 효과적으로 줄입니다.
3. **손실 함수:** 네트워크 파라미터 $\theta$는 다음 손실 함수를 최소화하여 훈련됩니다.
   $$L(\theta) = E[H(f_{\theta}(X_S), Y_S) + \lambda H(f_{\theta}(X_M), Y_M)]$$
   여기서 $H$는 예측된 의미론적 맵과 해당 레이블(정답 또는 의사) 간의 교차 엔트로피이며, $\lambda$는 비지도 손실의 영향을 조절하는 하이퍼파라미터로, 각 이미지에서 예측의 신뢰도가 특정 임계값 이상인 픽셀의 비율에 따라 적응적으로 조정됩니다.

## 📊 Results

- **GTA5$\rightarrow$Cityscapes 벤치마크:** DACS는 평균 IoU (mIoU) 52.14%를 달성하여 기존 모든 방법들을 능가하며 최첨단 성능을 기록했습니다. 19개 개별 클래스 중 7개에서 가장 높은 점수를 얻었습니다. 정성적 결과는 Naive Mixing이 '보도'를 '도로'로 잘못 분류하는 등 클래스 혼동 문제를 보이는 반면, DACS는 이를 올바르게 구별함을 보여줍니다.
- **SYNTHIA$\rightarrow$Cityscapes 벤치마크:** 16개 클래스에 대해 48.34% mIoU, 13개 클래스에 대해 54.81% mIoU를 달성했습니다.
- **평가 조건:** 조기 종료(early stopping)나 검증 세트 기반의 민감한 하이퍼파라미터 튜닝 없이 세 번의 실행 평균으로 결과를 보고하여, 기존 연구들의 과대평가 가능성을 배제하고 공정한 비교를 제시합니다.

## 🧠 Insights & Discussion

- **클래스 혼동 해결 메커니즘:** DACS의 교차 도메인 혼합은 소스 도메인의 정답 레이블로부터 신뢰할 수 있는 엔트로피를 타겟 도메인의 의사 레이블에 주입함으로써 클래스 혼동 문제를 해결합니다. 이는 모든 클래스가 혼합된 이미지 내에서 표현되도록 보장하며, 네트워크가 도메인을 픽셀 수준에서 암묵적으로 구별하는 것을 방지합니다.
- **도메인 유사성의 영향:** GTA5$\rightarrow$Cityscapes에서의 성능 향상이 SYNTHIA$\rightarrow$Cityscapes보다 더 큰 경향을 보였는데, 이는 소스 및 타겟 데이터 간의 유사성(예: GTA5가 SYNTHIA보다 Cityscapes와 더 유사함) 때문이라고 추정됩니다. 혼합된 이미지가 더 "상식적"일수록 성능이 향상될 수 있으며, 도메인 시프트가 클수록 DACS의 성능이 제한될 수 있습니다.
- **추가 실험을 통한 분석:**
  - Naive Mixing은 심각한 클래스 혼동으로 인해 DACS보다 훨씬 낮은 성능을 보였습니다.
  - 혼합 없이 순수하게 의사 레이블링만 사용한 경우, 소스 baseline보다도 성능이 저하되어 클래스 혼동의 주원인이 의사 레이블링 자체임을 시사합니다.
  - 클래스 분포 정렬(Distribution Alignment) 기법을 Naive Mixing에 적용했을 때 클래스 혼동이 해결되었는데, 이는 의사 레이블에 인위적으로 엔트로피를 주입하는 것이 클래스 혼동 방지에 도움이 된다는 가설을 뒷받침합니다.
  - ClassMix 대신 CutMix나 CowMix와 같은 다른 혼합 기법을 사용했을 때도 클래스 혼동은 해결되었으나 성능은 약간 떨어졌습니다. 이는 교차 도메인 혼합의 일반적인 적용 가능성을 보여주며, 혼합 전략의 선택이 성능에 중요하다는 것을 시사합니다.

## 📌 TL;DR

DACS는 의미론적 분할을 위한 비지도 도메인 적응(UDA)에서 도메인 간의 이미지 혼합 샘플링을 통해 기존 의사 레이블링 방법의 주요 문제인 "클래스 혼동" (class conflation)을 해결한다. 원본 이미지와 의사 레이블을 단순히 섞는 대신, 소스 도메인의 정답 레이블과 타겟 도메인의 의사 레이블을 교차 혼합하여 새로운 훈련 샘플을 생성한다. 이 접근 방식은 소스 도메인의 신뢰할 수 있는 정보를 주입하여 의사 레이블의 품질을 향상시키고, GTA5$\rightarrow$Cityscapes 벤치마크에서 최첨단 성능을 달성했다.
