# Domain Adaptive Faster R-CNN for Object Detection in the Wild

Yuhua Chen, Wen Li, Christos Sakaridis, Dengxin Dai, Luc Van Gool

## 🧩 Problem to Solve

객체 탐지 모델은 일반적으로 훈련 데이터와 테스트 데이터가 동일한 분포에서 추출된다고 가정하지만, 실제 환경에서는 이러한 가정이 항상 성립하지 않습니다. 뷰포인트, 객체 외형, 배경, 조명, 이미지 품질 등의 큰 변화로 인해 훈련 데이터와 테스트 데이터 사이에 상당한 **도메인 시프트(domain shift)**가 발생할 수 있으며, 이는 객체 탐지 성능의 심각한 저하로 이어집니다. 특히, 자율 주행과 같이 다양한 환경과 조건에서 작동해야 하는 시스템에서 이러한 문제는 더욱 중요해집니다. 이 연구는 레이블링된 대상 도메인 데이터 없이(비지도 도메인 적응 시나리오), 이러한 도메인 시프트 문제를 해결하여 **교차 도메인(cross-domain) 객체 탐지 모델의 견고성(robustness)을 향상**시키는 것을 목표로 합니다.

## ✨ Key Contributions

- **교차 도메인 객체 탐지 문제에 대한 이론적 분석 제공**: 확률적 관점에서 도메인 시프트 문제를 분석합니다.
- **이미지 및 인스턴스 레벨 도메인 적응 구성 요소 설계**: Faster R-CNN 모델에 두 가지 도메인 적응 구성 요소를 통합하여 이미지 및 인스턴스 레벨에서의 도메인 불일치를 완화합니다.
- **일관성 정규화(Consistency Regularization) 제안**: RPN(Region Proposal Network)이 도메인 불변(domain-invariant) 특성을 학습하도록 장려하는 일관성 정규화 기법을 제안합니다.
- **엔드-투-엔드 학습 가능한 도메인 적응 Faster R-CNN 모델 개발**: 제안된 구성 요소들을 Faster R-CNN 모델에 통합하여 엔드-투-엔드로 훈련 가능한 시스템을 구축합니다.

## 📎 Related Works

- **객체 탐지 (Object Detection)**: 고전적인 슬라이딩 윈도우 기반 방법($[9, 13, 56]$)부터 딥러닝 기반 R-CNN($[21, 20, 60]$), Fast R-CNN($[20, 26]$), Faster R-CNN($[48]$)에 이르기까지 발전해왔습니다. 그러나 대부분의 기존 연구는 도메인 적응 문제를 고려하지 않았습니다.
- **도메인 적응 (Domain Adaptation)**: 이미지 분류 분야에서 활발히 연구되었으며, 멀티플 커널 학습($[10, 11]$), 비대칭 메트릭 학습($[33]$), 서브스페이스 보간($[23]$) 등 고전적인 방법과 딥러닝 기반의 접근 방식($[40, 15, 18, 50, 45, 43, 34, 24, 41, 42]$)이 있습니다. 일부는 픽셀 레벨 도메인 적응을 위한 이미지 변환($[62, 31, 59, 38]$)도 다룹니다.
- **분류를 넘어서는 도메인 적응**: 분류 외의 컴퓨터 비전 태스크(예: 의미론적 분할($[4, 27, 61]$), 세분화된 인식($[16]$))에 대한 도메인 적응 연구도 진행되었습니다. 객체 탐지 분야에서는 DPM 모델($[58]$)이나 R-CNN($[47]$)에 대한 연구가 있었으나, 이 연구는 엔드-투-엔드 학습이 가능하고 더 광범위한 도메인 시프트 시나리오를 다루는 점에서 차별화됩니다.

## 🛠️ Methodology

본 연구는 최신 Faster R-CNN 모델을 기반으로 하며, 다음과 같은 도메인 적응 구성 요소를 도입합니다.

1. **확률적 관점의 도메인 시프트 분석**:

   - **이미지 레벨 적응**: $P(C, B, I) = P(C, B|I)P(I)$에서 $P(I)$의 차이로 인한 도메인 시프트를 가정하며, 기본 컨볼루션 레이어의 특징 맵 분포를 정렬합니다.
   - **인스턴스 레벨 적응**: $P(C, B, I) = P(C|B, I)P(B, I)$에서 $P(B, I)$의 차이로 인한 도메인 시프트를 가정하며, ROI(Region-of-Interest) 기반 특징 벡터의 분포를 정렬합니다.
   - **공동 적응 및 일관성 정규화**: 두 레벨에서 모두 도메인 정렬을 수행하며, $P(D|B,I) = P(D|I)$를 강제하는 일관성 정규화를 통해 RPN이 도메인 불변적인 바운딩 박스 예측을 학습하도록 돕습니다.

2. **두 가지 도메인 적응 구성 요소**:

   - **이미지 레벨 적응**: Faster R-CNN의 기본 컨볼루션 레이어 출력(특징 맵)에 **패치 기반(patch-based) 도메인 분류기**를 추가합니다. 이 분류기는 각 특징 맵 활성화(activation)에 대해 도메인 레이블을 예측하며, 이미지 스타일, 조명 등 전역적인 이미지 차이로 인한 시프트를 줄입니다.
     $$L_{img} = -\sum_{i,u,v} [D_i \log p^{(u,v)}_i + (1-D_i) \log(1-p^{(u,v)}_i)]$$
   - **인스턴스 레벨 적응**: ROI 풀링 후 최종 카테고리 분류기로 들어가기 전의 ROI 기반 특징 벡터에 **인스턴스 레벨 도메인 분류기**를 추가합니다. 이 분류기는 객체 외형, 크기 등 지역적인 인스턴스 차이로 인한 시프트를 줄입니다.
     $$L_{ins} = -\sum_{i,j} [D_i \log p_{i,j} + (1-D_i) \log(1-p_{i,j})]$$
   - 두 분류기 모두 $H$-다이버전스 이론에 기반하여 **적대적 학습(adversarial training)** 방식으로 구현됩니다. 즉, 도메인 분류기는 도메인을 구분하도록 훈련되고, 기본 네트워크는 도메인 분류기가 도메인을 구분하기 어렵게 만드는 특징을 생성하도록 훈련됩니다(Gradient Reverse Layer, GRL 활용).

3. **일관성 정규화 (Consistency Regularization)**:

   - 이미지 레벨 도메인 분류기의 이미지 평균 출력과 인스턴스 레벨 도메인 분류기의 출력 간의 일관성을 강제합니다. 이는 RPN이 도메인 불변 특징을 학습하는 데 도움을 줍니다.
     $$L_{cst} = \sum_{i,j} \left\| \frac{1}{|I|} \sum_{u,v} p^{(u,v)}_i - p_{i,j} \right\|^2$$

4. **최종 학습 손실**:
   - 객체 탐지 손실($L_{det}$)과 세 가지 도메인 적응 손실($L_{img}$, $L_{ins}$, $L_{cst}$)의 합으로 구성되며, $L_{det}$는 Faster R-CNN의 RPN 및 ROI 분류기 손실을 포함합니다.
     $$L = L_{det} + \lambda(L_{img} + L_{ins} + L_{cst})$$
   - $\lambda$는 하이퍼파라미터이며, 표준 SGD 알고리즘을 사용하여 엔드-투-엔드 방식으로 훈련됩니다.

## 📊 Results

제안된 Domain Adaptive Faster R-CNN 모델은 다양한 도메인 시프트 시나리오에서 기준선 Faster R-CNN 모델보다 뛰어난 성능을 보였습니다. 평가 지표로는 mAP(mean Average Precision) 0.5가 사용되었습니다.

- **1. 합성 데이터로부터 학습 (SIM10k → Cityscapes)**:
  - SIM10k (합성 데이터)를 소스 도메인으로, Cityscapes (실제 데이터)를 타겟 도메인으로 사용했습니다.
  - **결과**: 기준선 Faster R-CNN의 30.12% AP에서, 이미지 레벨 적응(+2.9%), 인스턴스 레벨 적응(+5.6%), 두 구성 요소 결합(+7.7%), 최종적으로 일관성 정규화까지 적용하여 **+8.8% 향상된 38.97% AP**를 달성했습니다.
- **2. 악천후 (Cityscapes → Foggy Cityscapes)**:
  - Cityscapes (맑은 날씨)를 소스 도메인으로, Foggy Cityscapes (안개 낀 날씨)를 타겟 도메인으로 사용했습니다.
  - **결과**: 기준선 Faster R-CNN의 18.8% mAP에서, 제안된 모델은 **+8.6% 향상된 27.6% mAP**를 달성했으며, 다양한 카테고리에서 일관된 개선을 보였습니다.
- **3. 크로스 카메라 적응 (KITTI ↔ Cityscapes)**:
  - KITTI와 Cityscapes 데이터셋 간의 상호 적응을 평가했습니다.
  - **결과**: 양방향 적응 모두에서 기준선 대비 명확한 성능 향상을 보였습니다. 예를 들어, KITTI에서 Cityscapes로 적응할 경우, 기준선 Faster R-CNN의 30.2% AP에서 **8.3% 향상된 38.5% AP**를 달성했습니다.
- **오류 분석 및 스케일 변화에 대한 견고성**:
  - 이미지 레벨 적응과 인스턴스 레벨 적응 모두 정확한 탐지 수를 늘리고 오탐(false positives)을 줄였습니다. 이미지 레벨 적응이 배경 오류를 더 효과적으로 줄였습니다.
  - 이미지 스케일 변화에 대해, 이미지 레벨 적응 모델이 인스턴스 레벨 적응 모델보다 더 견고하며, 두 구성 요소를 모두 사용하는 것이 모든 스케일에서 가장 좋은 결과를 보였습니다.
- **일관성 정규화의 효과**:
  - RPN의 성능(mIoU)을 향상시키는 데 기여했습니다. 일관성 정규화 없이는 28.5% mIoU에서, 적용 후에는 **30.3% mIoU**로 추가적인 개선을 보였습니다.

## 🧠 Insights & Discussion

- **두 레벨 적응의 중요성**: 이미지 레벨(전역적 시프트)과 인스턴스 레벨(지역적 시프트)에서 도메인 불일치를 동시에 해결하는 것이 객체 탐지 도메인 적응에 효과적임을 입증했습니다. 이는 객체 탐지 문제의 복잡성을 다루기 위한 필수적인 접근 방식입니다.
- **일관성 정규화의 역할**: 두 도메인 분류기 간의 일관성을 강제함으로써 RPN이 도메인 불변적인 특징을 학습하도록 유도하여 바운딩 박스 예측의 견고성을 향상시킵니다. 이는 객체 위치 추정의 도메인 적응에 대한 새로운 통찰을 제공합니다.
- **스케일 변화에 대한 대응**: 이미지 레벨 적응이 전역적인 변환인 스케일 변화에 더 효과적으로 대응함을 보여주었습니다. 이는 다양한 해상도 및 카메라 설정에서 모델의 성능을 유지하는 데 중요합니다.
- **실용적 의의**: 레이블링된 대상 도메인 데이터 없이 모델 성능을 향상시킬 수 있어, 데이터 수집 및 레이블링 비용이 많이 드는 실제 환경(예: 자율 주행)에서 매우 유용합니다.
- **제한 사항**: 논문에서 직접적인 한계는 언급되지 않았지만, 적대적 학습의 훈련 안정성 문제나 $\lambda$와 같은 하이퍼파라미터 튜닝의 민감도는 여전히 존재할 수 있습니다. 또한, 도메인 시프트의 유형(예: 극심한 조명 변화, 극단적인 시점 변화)에 따른 각 구성 요소의 상대적인 효과에 대한 더 심층적인 분석이 필요할 수 있습니다.

## 📌 TL;DR

이 논문은 훈련 및 테스트 데이터 간의 도메인 시프트로 인한 객체 탐지 성능 저하 문제를 해결하기 위해 **도메인 적응 Faster R-CNN** 모델을 제안합니다. Faster R-CNN을 기반으로, 이미지 레벨 및 인스턴스 레벨에서 특징 분포를 정렬하는 두 가지 **적대적 학습 기반 도메인 적응 구성 요소**를 도입합니다. 또한, RPN이 도메인 불변 특성을 학습하도록 유도하는 **일관성 정규화**를 추가합니다. 합성-실제, 맑은 날씨-안개, 크로스 카메라 등 다양한 도메인 시프트 시나리오에서 평가한 결과, 제안된 모델은 기준선 Faster R-CNN 대비 **최대 +8.8% mAP 향상**을 달성하며, 레이블링된 대상 도메인 데이터 없이 견고한 객체 탐지 성능을 제공함을 입증했습니다.
