# Real-Time Instrument Segmentation in Robotic Surgery using Auxiliary Supervised Deep Adversarial Learning
Mobarakol Islam, Daniel A. Atputharuban, Ravikiran Ramesh, and Hongliang Ren

## 🧩 Problem to Solve
로봇 보조 수술(RMIS)에서 로봇 수술 도구와 조직을 실시간으로 정확하고 효율적으로 시맨틱 분할하는 것은 매우 중요합니다. 이는 도구 식별 및 추적뿐만 아니라 수술 환경에 대한 상황별 정보를 제공하는 데 필수적입니다. 기존의 마커 기반 또는 수제 특징(handcrafted features) 기반 접근 방식은 도구 크기를 증가시키거나, 강도 변화에 강인하지 않거나, 오직 이진 분할만 제공하는 등의 한계가 있었습니다. 딥러닝 기반의 접근법들도 실시간 애플리케이션에 필요한 고해상도 비디오에서의 속도와 정확도 사이에서 균형을 맞추는 데 어려움을 겪었습니다. 그림자, 반사, 부분 폐색, 연기, 체액, 동적인 배경 조직과 같은 복잡한 수술 환경 요인들이 이러한 분할 작업을 더욱 어렵게 만듭니다.

## ✨ Key Contributions
*   고해상도 비디오에서 수술 도구를 실시간으로 분할하기 위한 가벼운 캐스케이드(cascaded) 컨볼루션 신경망(CNN) 모델을 제안했습니다.
*   보조(auxiliary) 및 메인(main) 브랜치에서 서로 다른 차원과 채널의 특징 맵을 융합하는 다중 해상도 특징 융합(Multi-resolution Feature Fusion, MFF) 모듈을 개발했습니다.
*   저해상도 특징 학습을 위한 보조 손실(auxiliary loss)과 고차 구조 정보 학습을 통한 분할 예측 개선을 위한 적대적 손실(adversarial loss)을 결합한 새로운 모델 정규화 기법을 도입했습니다.
*   중간 단계에서 풍부한 문맥 정보(contextual information)를 통합하기 위한 가벼운 공간 피라미드 풀링(Spatial Pyramid Pooling, SPP) 유닛을 포함시켰습니다.
*   MICCAI 2017 로봇 도구 분할 챌린지 데이터셋에서 기존 알고리즘보다 픽셀 단위 수술 도구 분할의 정확도와 분할 시간(속도) 면에서 우수한 성능을 입증했습니다.

## 📎 Related Works
*   **기존 수술 도구 추적**: 마커 기반 방법([9], [10])은 도구 크기 증가 및 소독 문제. 비전 기반 마커 없는 접근 방식은 수제 특징([13]-[15], [16], [17], [18]) 또는 고전적인 머신러닝 모델(Random Forest [19], Naive Bayesian [14], GMM [20])을 사용했으나, 단순 문제 해결에 그치거나 강인성 부족, 이진 분할에만 적용 가능했습니다.
*   **딥러닝 기반 도구 추적**:
    *   **탐지 기반 추적(Tracking-by-detection)**: 바운딩 박스([27], [28]) 및 자세 추정([17])을 사용하나, 정밀도가 부족하고 주로 도구 몸통을 예측합니다.
    *   **분할 기반 추적(Tracking-by-segmentation)**: ToolNet [29] (이진 분할, 실시간), Pakhomov et al. [30] (잔여 학습 및 팽창 컨볼루션으로 다중 클래스 분할), Shvets et al. [31] (LinkNet [32] 기반 이진, 부품, 카테고리 분할), Laina et al. [33] (동시 분할 및 지역화), Garcia-Peraza-Herrera et al. [34] (사전 훈련된 FCN과 아핀 변환), Al Hajj et al. [35] (CNN 및 RNN 결합). 대부분 계산 비용이 큽니다.
*   **고속 시맨틱 분할**: ICNet [36] (캐스케이드 특징 융합, 보조 손실), LinkNet [32] (효율적인 모델 파라미터 사용), ENet [37], SqueezeNet [38] (정확도-처리 시간 절충).
*   **적대적 학습**: 이미지 합성 [39], 분할 [40], 추적 [41] 등에서 최첨단 성능을 보이며 고차 일관성을 강제하는 데 사용됩니다.

## 🛠️ Methodology
제안된 모델은 보조 및 메인 브랜치로 구성된 가벼운 캐스케이드 CNN 아키텍처로, 서로 다른 해상도의 입력 이미지로부터 문맥 정보를 융합하여 고해상도 시맨틱 특징 맵을 생성합니다.

1.  **네트워크 아키텍처**:
    *   **메인 브랜치**:
        *   `Conv-Block`으로 시작 (7x7 커널, stride 2의 컨볼루션, 배치 정규화, ReLU).
        *   그 뒤 `Max-Pooling` 레이어.
        *   4개의 `Residual-Block` (ResNet18 [43]과 유사)으로 특징 추출.
        *   `Spatial Pyramid Pooling (SPP)` 유닛을 사용하여 잔여 블록의 출력 특징 맵에서 다중 스케일 시맨틱 특징을 추출 (피라미드 풀링 모듈의 연결(concatenation) 연산을 합산(summation)으로 대체하여 특징 길이를 줄임).
    *   **보조 브랜치**: 저해상도 입력에 대한 처리를 담당하여 저해상도 특징을 학습합니다.
    *   **디코더**: 3개의 디코더 블록 (Conv(1x1)-Deconv(3x3, stride 2)-Conv(1x1) 및 배치 정규화, ReLU)과 `Class-Block` (Deconvolution(3x3)-Convolution(3x3)-Deconvolution(2x2))으로 구성됩니다. 다운샘플링으로 손실된 공간 정보를 복구하기 위해 각 디코더에 해당하는 잔여 블록으로부터 스킵 연결(skip connection)이 있습니다.

2.  **다중 해상도 특징 융합 (MFF) 모듈**:
    *   메인 브랜치(1/32 스케일)와 보조 브랜치(1/16 스케일)의 특징 맵을 결합합니다.
    *   ICNet의 CFF 아이디어를 기반으로 하지만, 보간(interpolation) 레이어를 컨볼루션 레이어(stride 2)로 대체하여 맵을 다운샘플링하고, 복잡도를 높이지 않으면서 채널을 줄이기 위해 병목(bottleneck) 레이어를 추가합니다.
    *   출력으로 보조 클래스 맵과 융합된 MFF 특징 맵을 생성합니다.

3.  **적대적 학습 스킴**:
    *   분할 네트워크에서 생성된 특징 맵과 실제 레이블 맵(ground truth)을 입력으로 받아 이들을 구별하는 판별자(discriminator) 네트워크를 사용합니다.
    *   판별자는 FCN과 업샘플링 레이어로 구성되며, 분할 네트워크의 고차 불일치(inconsistency)를 감지하고 수정하여 예측 특징 맵을 정제합니다.

4.  **손실 함수**:
    *   **분할 손실($L_{\text{seg}}$)**: 메인 브랜치 손실($L_{\text{main}}$)과 보조 브랜치 손실($L_{\text{aux}}$)의 합으로 구성됩니다.
        $$L_{\text{seg}} = L_{\text{main}} + \lambda_{\text{aux}}L_{\text{aux}}$$
        여기서 $L_{\text{main}}$과 $L_{\text{aux}}$는 소프트맥스 교차 엔트로피 손실이며, $\lambda_{\text{aux}}$는 0.4로 설정됩니다.
    *   **전체 훈련 손실($L$)**: 분할 손실에 적대적 손실($L_{\text{adv}}$)을 추가합니다.
        $$L = L_{\text{main}} + \lambda_{\text{aux}}L_{\text{aux}} + \lambda_{\text{adv}}L_{\text{adv}}$$
        $L_{\text{adv}}$는 공간 교차 엔트로피 손실이며, $\lambda_{\text{adv}}$는 0.01로 설정됩니다. 적대적 손실 항은 특정 클래스로 라벨링된 영역이 임계값을 초과하는 등의 고차 레이블 불일치에 벌칙을 줍니다.

5.  **훈련**: Adam 옵티마이저와 "poly" 학습률 정책을 사용하며, 분할 네트워크에는 0.001, 판별자에는 0.00015의 기본 학습률을 적용합니다. 2개의 NVIDIA GTX 1080Ti GPU를 사용하여 훈련했습니다.

## 📊 Results
*   **데이터셋**: MICCAI 2017 Endovis-로봇 도구 분할 챌린지 데이터셋(8가지 수술, 총 225개 프레임 시퀀스, 1920x1080 해상도 → 1280x1024 크롭)을 사용했습니다. 훈련 데이터는 6개의 수술에서 1350장, 테스트 데이터는 2개의 수술에서 450장으로 구성되었습니다.
*   **적대적 학습의 효과**: 표 I에서 적대적 학습을 사용했을 때 (Dice 0.916) 사용하지 않았을 때(Dice 0.913)보다 더 나은 성능을 보였으며, 이는 공간적 일관성을 강제하여 클래스 확률을 더 부드럽게 만들기 때문입니다.
*   **이진 분할 성능**: 표 II에 따르면, 제안된 모델은 이진 분할에서 Dice 0.916, Hausdorff 11.110으로 LinkNet, ICNet, UNet, TernausNet, PSPNet 등 기존 모델들을 능가하며, 거의 인간 수준의 성능을 달성했습니다.
*   **속도 및 메모리**: 표 III에 따르면, 제안된 모델은 173.78 fps의 추론 속도를 보이며, 이는 LinkNet(245.88 fps)보다 약간 느리지만 ICNet(109.50 fps) 및 UNet(224.21 fps)보다 빠릅니다. 또한, 81.8MB의 메모리와 14.91백만 개의 파라미터로 효율성을 보여줍니다.
*   **부품 및 도구 카테고리 분할**: 표 IV에 따르면, 제안된 모델은 이진 분할뿐만 아니라 부품 분할(Dice 0.738) 및 도구 카테고리 분할(Dice 0.347)에서도 모든 기존 모델을 일관되게 능가했습니다. 도구 카테고리 분할의 전반적인 정확도는 낮았는데, 이는 테스트 비디오에 사용된 도구 종류가 훈련 데이터에 비해 적었기 때문일 수 있습니다.
*   **시각화**: 그림 5와 그림 6에서 제안된 모델의 예측 결과가 실제값(ground truth)에 훨씬 더 가깝고, 다른 아키텍처에서 나타나는 오탐(false positives) 및 미탐(false negatives)이 적음을 시각적으로 확인했습니다.
*   **브랜치 분석**: 표 V에서 보조 브랜치만 단독으로 사용했을 때 메인 브랜치보다 빠른 추론 속도(227.38 fps vs 173.78 fps)를 보이면서도, 분할 성능은 약간 낮지만(Binary Dice 0.911 vs 0.916) 여전히 비교할 만한 수준임을 확인했습니다. 이는 속도가 더 중요할 때 유용한 트레이드오프 옵션이 될 수 있습니다.

## 🧠 Insights & Discussion
*   **강점**: 제안된 모델은 실시간 로봇 도구 시맨틱 분할에 매우 효과적입니다. MFF 모듈은 다양한 차원과 채널의 특징 맵을 효과적으로 융합하며, 보조 손실은 저해상도 특징 학습을 최적화하고, 적대적 학습은 고차 불일치를 감지 및 수정하여 예측 정확도를 향상시킵니다. SPP 유닛은 다중 스케일 문맥 특징을 효율적으로 통합합니다.
*   **한계**: 디코더나 역컨볼루션 레이어를 사용하여 학습 가능한 파라미터와 모델 복잡도를 증가시켰기 때문에, LinkNet이나 UNet에 비해 더 많은 파라미터와 약간 느린 속도를 가집니다. 그림 5의 실패 사례(Case 5)처럼 빛 반사(오탐)나 도구 누락(미탐)과 같은 문제는 여전히 모든 모델에서 발생합니다. 또한, 표 IV에서 볼 수 있듯이, 모든 모델이 도구 카테고리 분할에서 낮은 성능을 보이는데, 이는 데이터셋의 제약(예: 테스트 세트에 특정 도구가 충분히 포함되지 않음) 때문일 수 있습니다.
*   **의의**: 본 연구는 로봇 보조 수술에서 도구 분할을 위한 상당한 혁신을 통합했으며, 향후 실시간 수술 가이드 및 로봇 보조 수술 분야 연구에 중요한 기준점을 제공합니다. 제안된 방법은 조직 분할에도 적용될 수 있을 것으로 예상됩니다.

## 📌 TL;DR
**문제**: 고해상도 로봇 수술 비디오에서 수술 도구를 실시간으로 정확하게 시맨틱 분할하는 것은 로봇 보조 수술의 핵심 과제입니다.
**방법**: 본 논문은 가벼운 캐스케이드 컨볼루션 신경망을 제안합니다. 이 모델은 다중 해상도 특징 융합(MFF) 모듈, 공간 피라미드 풀링(SPP) 유닛, 그리고 보조 손실과 적대적 손실을 결합한 새로운 학습 방식을 통합하여 예측을 정제하고 일관성을 개선합니다.
**발견**: 제안된 모델은 MICCAI 2017 챌린지 데이터셋에서 이진, 부품, 도구 카테고리 분할 모두에서 기존 최첨단 방법보다 뛰어난 분할 정확도와 추론 속도를 달성했습니다.