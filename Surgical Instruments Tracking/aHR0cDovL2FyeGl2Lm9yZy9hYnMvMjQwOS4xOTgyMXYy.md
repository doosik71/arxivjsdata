# Tracking Everything in Robotic-Assisted Surgery

Bohan Zhan, Wang Zhao, Yi Fang, Bo Du, Francisco Vasconcelos, Danail Stoyanov, Daniel S. Elson, Baoru Huang

## Problem to Solve

로봇 보조 최소 침습 수술(RAMIS)에서 정밀한 수술 장면 이해와 로봇 조작을 위해서는 조직과 수술 도구의 정확한 추적이 필수적입니다. 기존 시각 추적 알고리즘은 다음과 같은 한계를 가집니다:

- **전통적인 방법의 한계:** 키포인트 기반의 희소 추적은 특징점 부족 및 변형에 취약하며, 밀집 광학 흐름(optical flow) 기반 추적은 인접 프레임 간 움직임만 추적하여 장기적인 드리프트(drift)와 폐색에 취약합니다.
- **TAP(Tracking Any Point) 알고리즘의 수술 환경 적용 문제:** 최근 제안된 TAP 알고리즘은 밀집하고 장기적인 추적에 효과적이지만, 자연 장면 데이터셋으로 훈련되어 수술 환경(열악한 조명, 낮은 질감, 높은 반사 등)에 적용 시 성능이 검증되지 않았습니다.
- **수술 추적 데이터셋 부족:** TAP 기반 알고리즘의 수술 시나리오 적용을 평가할 수 있는 포괄적인 벤치마크 데이터셋이 부재합니다. 기존 데이터셋은 주석 수가 불충분하거나 희소하여 TAP 알고리즘 평가에 부적합합니다.

## Key Contributions

- **새로운 수술 비디오 추적 데이터셋 구축:** 실제 수술 시나리오에서 추적 알고리즘 평가를 위한 수동 주석이 포함된 포괄적인 데이터셋을 구축했습니다.
- **TAP 기반 알고리즘 벤치마킹 및 한계점 분석:** 구축된 데이터셋을 사용하여 기존 TAP 기반 알고리즘들을 벤치마킹하고, 로봇 수술에서 빠른 도구 움직임, 심한 폐색, 모션 블러 등 복잡한 움직임을 추적하는 데 한계가 있음을 밝혔습니다.
- **새로운 추적 방법인 SurgMotion 제안:** 수술 비디오에서 정확한 추적을 위한 새로운 방법인 SurgMotion을 제안했습니다. 이 방법은 기존 TAP 기반 방법들을 능가하며, 특히 도전적인 수술 비디오에서 상당한 성능 개선을 입증했습니다.

## Methodology

본 논문에서는 수술 추적 알고리즘 평가를 위한 새로운 수동 주석 데이터셋을 개발하고, 기존 TAP 기반 알고리즘의 성능을 향상시키기 위해 **SurgMotion**이라는 새로운 추적 방법을 제안합니다. SurgMotion은 OmniMotion [22]을 기반으로 하며 세 가지 핵심 손실 함수를 추가합니다.

1. **데이터셋 생성:**

   - **데이터 출처:** SurgT 벤치마크 [21] 및 EndoNerf 데이터셋 [33]에서 실제 수술 비디오 클립을 선별했습니다.
   - **데이터 처리:** 조직과 도구가 모두 포함된 약 50~70프레임의 비디오 클립을 선택하고 해상도를 조정했습니다.
   - **주석 프로세스:** TAP-Vid-DAVIS 데이터셋 가이드라인 [14]을 따라 수동으로 주석을 달았습니다. 각 비디오 프레임에 25개의 포인트(수술 도구 10개, 조직 15개)를 주석 처리했습니다. 도구의 끝, 모서리 등 특징적인 위치에, 조직은 혈관 접합부와 같은 질감이 있는 영역에 포인트를 선택했습니다. 폐색되거나 시야를 벗어난 포인트는 별도로 표시했습니다.

2. **SurgMotion 제안:**
   SurgMotion은 OmniMotion [22]에 수술 시나리오의 특성을 반영한 세 가지 특수 손실 함수를 추가하여 추적 성능을 향상시킵니다. OmniMotion은 2D 포인트를 3D 공간으로 변환($x_{\text{i}}$)하고, 이를 정규 3D 볼륨 $u$와 국부 프레임 간의 양방향 사상 $u=T_{\text{i}}(x_{\text{i}})$을 통해 추적하며, 3D 포인트를 2D 이미지로 렌더링하는 방식으로 작동합니다. 여기에 SurgMotion의 핵심 개선 사항이 추가됩니다.

   - **도구 마스크 제약 (Tool Mask Constraints):**

     - **목적:** 도구에 있는 포인트가 추적 과정 내내 해당 도구 영역 안에 유지되도록 합니다.
     - **방법:** 기존 세그멘테이션 모델 [31]을 활용하여 수술 도구의 마스크를 추출하고, 마스크 손실 $L_{\text{mask}}$를 도입하여 훈련 중 포인트가 도구 마스크 내에 일관되게 유지되도록 합니다.
     - **수식:**
       $$L_{\text{mask}} = \sum_{x_{\text{i}} \in \Omega_{\text{i}}^{\text{M}}} \|M(x_{\text{i}}) - M(x_{\text{j}})\|_{2}^{2}$$
       여기서 $\Omega_{\text{i}}^{\text{M}}$는 프레임 $i$에서 마스크 내의 모든 픽셀 집합이고, $M$은 도구가 차지하는 영역을 1로 표시하는 이진 이미지입니다. $x_{\text{j}}$는 프레임 $j$에서 $x_{\text{i}}$에 해당하는 포인트입니다.

   - **강체에 가까운 제약 (As Rigid As Possible (ARAP) Constraints):**

     - **목적:** 수술 도구가 일반적으로 강체이므로, 동일한 도구 내 포인트 간의 상대적 위치 및 변위가 일관되게 유지되도록 합니다.
     - **방법:** 3D 포인트 정보를 활용하여 K-평균 군집화(K-means clustering)를 통해 동일한 강체 부분에 속하는 포인트를 분류하고, ARAP 손실 $L_{\text{arap}}$를 적용하여 공간적 일관성을 강화합니다.
     - **수식:**
       $$L_{\text{arap}} = \sum_{(x_{\text{k}}, x_{\text{p}}) \in \Omega_{\text{k,p}}} |d(x_{\text{k\_i}}, x_{\text{k\_j}}) - d(x_{\text{p\_i}}, x_{\text{p\_j}})|$$
       여기서 $\Omega_{\text{k,p}}$는 동일한 강체 클러스터 내의 모든 쌍별 포인트 집합이고, $d(\cdot, \cdot)$는 유클리드 거리 함수입니다.

   - **희소 특징 매칭 가이드 (Sparse Feature Matching Guidance):**
     - **목적:** OmniMotion의 광학 흐름(optical flow) 기반 감독이 장거리 프레임에서 부정확해지는 문제를 해결하고, 장기 추적 중 유실되는 포인트 정보를 회복하여 정확도를 높입니다.
     - **방법:** Transformer 기반의 준밀집 특징 매칭 방법인 LoFTR [40]를 사용하여 두 프레임 간의 픽셀별 매치를 추출하고, 이를 장기 추적을 위한 가이드로 통합합니다.
     - **수식:**
       $$L_{\text{long}} = \sum_{(p_{\text{i,j}} \in \Omega)} \|(\hat{p}_{\text{j}} - p_{\text{i}}) - (p_{\text{j}} - p_{\text{i}})\|_{1}$$
       여기서 $\Omega$는 특징 매칭에서의 모든 쌍별 포인트 집합이고, $\hat{p}_{\text{j}}$는 LoFTR에 의해 $p_{\text{i}}$에 매치된 포인트이며, $p_{\text{j}}$는 모델에 의해 예측된 해당 포인트입니다.

## Results

- **평가 지표:** TAP-Vid 벤치마크 [14]를 따라 $\delta_{\text{x}}^{\text{avg}}$(가시 포인트의 평균 위치 정확도), AJ(Average Jaccard, 위치 및 가시성 정확도), OA(Occlusion Accuracy, 가시성 예측 정확도)를 사용했습니다.
- **정량적 비교:**
  - **수술 도구 추적:** SurgMotion은 RAFT, PIPs, PIPs++, MFT, TAPIR 등 기존 SOTA TAP 기반 알고리즘들을 능가했으며, AJ와 OA 지표에서 SOTA 성능을 달성했습니다. 특히 OmniMotion [22] 대비 모든 지표에서 개선을 보였고, CoTracker [19]보다 OA 지표에서 7.2% 높은 성능을 보였습니다.
  - **도전적인 도구 추적 사례:** 빠른 움직임과 모션 블러로 추적 난이도가 높은 "도전적인 사례"에서 SurgMotion은 다른 모든 베이스라인보다 월등히 뛰어난 성능을 보였습니다.
  - **조직 추적:** 도구 추적 개선에 중점을 두었음에도 불구하고, SurgMotion은 조직 추적에서도 다른 베이스라인과 유사한 높은 정확도를 유지하며 AJ 및 OA 지표에서 SOTA에 근접한 성능을 보였습니다.
- **정성적 비교:** SurgMotion은 MFT 및 OmniMotion에 비해 도구 추적에서 우수한 안정성을 보였으며, 특히 빠르게 움직이는 수술 도구에서 포인트 유실을 효과적으로 방지했습니다. 또한, CoTracker에 비해 폐색 예측에서 개선된 성능을 보여주었습니다.
- **어블레이션 연구:** 제안된 세 가지 손실 함수($L_{\text{mask}}$, $L_{\text{arap}}$, $L_{\text{long}}$) 각각이 개별적으로 성능 향상에 기여함을 확인했습니다. $L_{\text{mask}}$와 $L_{\text{arap}}$의 조합은 $L_{\text{mask}}$ 단독보다 성능이 좋았으며, $L_{\text{long}}$까지 추가한 전체 모델이 베이스라인 대비 가장 우수한 성능을 보였습니다.
