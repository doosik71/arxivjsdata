# SurgicalSAM: Efficient Class Promptable Surgical Instrument Segmentation

Wenxi Yue, Jing Zhang, Kun Hu, Yong Xia, Jiebo Luo, Zhiyong Wang

## 🧩 Problem to Solve

Segment Anything Model(SAM)은 일반 객체 세분화에서 강력한 성능을 보이지만, 수술 도구 세분화(Surgical Instrument Segmentation, SIS)에 직접 적용할 때 다음과 같은 두 가지 주요 문제에 직면합니다.

1. **도메인 격차:** 자연 객체와 수술 도구 간의 상당한 도메인 격차로 인해 SAM의 제로샷(zero-shot) 일반화 성능이 저하됩니다. 수술 도구는 특수한 외관, 복잡한 해부학적 배경, 그리고 높은 범주 간 유사성으로 인해 일반 객체와 크게 다릅니다.
2. **정확한 프롬프트 의존성 및 복잡한 파이프라인:** SAM은 정확한 세분화를 위해 정밀한 점(point) 또는 경계 상자(bounding box) 프롬프트에 의존합니다. 이는 정확한 프롬프트 준비를 위해 광범위한 수동 안내나 고성능 전문 검출기가 필요하여 복잡한 다단계 파이프라인을 초래하고, 프롬프트의 미세한 오차에도 취약하여 강건성이 떨어집니다.

## ✨ Key Contributions

* **효율적인 튜닝을 통한 SAM의 수술 도메인 통합:** SAM의 사전 학습된 지식과 수술 도구의 특화된 지식을 효율적인 튜닝을 통해 통합하여 클래스 프롬프트 기반 수술 도구 세분화를 위한 SurgicalSAM을 제안합니다. 이는 기존 전문 모델 및 복잡한 다단계 솔루션보다 우수한 성능을 보입니다.
* **프로토타입 기반 클래스 프롬프트 인코더 및 대조 프로토타입 학습:** 명시적인 점 또는 경계 상자 프롬프트 없이 클래스 프롬프트로부터 잠재 프롬프트 임베딩을 직접 학습하는 경량 프로토타입 기반 클래스 프롬프트 인코더를 제안하여 엔드-투-엔드 파이프라인을 가능하게 합니다. 또한, 미세한 수술 도구 범주 간의 차별성을 향상시키기 위해 대조 프로토타입 학습(contrastive prototype learning)을 도입합니다.
* **SOTA 성능 및 효율성:** 도전적인 EndoVis2018 및 EndoVis2017 데이터셋에 대한 광범위한 실험을 통해 최첨단(SOTA) 성능을 달성했으며, 동시에 튜닝 가능한 매개변수의 수를 크게 줄여 훈련 효율성을 향상시켰습니다.

## 📎 Related Works

* **수술 도구 세분화(SIS) 전문 모델:** TernausNet, ISINet, TraSeTR, MATIS와 같은 기존 SIS 방법들은 작업별 구성 요소를 갖춘 전문 모델을 설계하고 전체 모델 매개변수를 훈련해야 하여 비효율적입니다. 또한, SIS 데이터셋의 제한된 규모로 인해 일반화 성능이 저조한 경향이 있습니다.
* **Segment Anything Model(SAM) 기반 접근 방식:** SAM은 프롬프트 기반 세분화를 위한 선구적인 파운데이션 모델이지만, 사전 훈련 시 의료 데이터가 부족하고 자연 객체와 의료 대상 간의 상당한 도메인 격차로 인해 의료 영상에 직접 적용 시 성능 저하를 겪습니다. 기존 SAM 기반 의료 영상 세분화 연구는 주로 제로샷 방식을 사용하며, 정확한 점 또는 경계 상자 프롬프트가 필요하거나, 미세한 수술 도구 범주에 대한 차별성이 부족한 범용 프롬프트 임베딩을 사용한다는 한계가 있습니다.

## 🛠️ Methodology

SurgicalSAM은 클래스 프롬프트 기반 수술 도구 세분화를 위해 SAM을 효율적으로 튜닝하는 엔드-투-엔드 접근 방식입니다.

* **전반적인 구조:**
    SurgicalSAM은 세 가지 핵심 구성 요소로 이루어져 있습니다: 이미지 인코더($E_{I}$), 프로토타입 기반 클래스 프롬프트 인코더($E_{CP}$), 그리고 마스크 디코더($D_{M}$).
    1. 이미지 인코더 $E_{I}$는 입력 이미지 $I \in \mathbb{R}^{\text{H} \times \text{W} \times 3}$에서 이미지 임베딩 $F_{I} \in \mathbb{R}^{\text{h} \times \text{w} \times \text{d}}$를 추출합니다.
    2. 프로토타입 기반 클래스 프롬프트 인코더 $E_{CP}$는 클래스 프로토타입 $B$를 사용하여 이미지 임베딩 $F_{I}$를 활성화하고, 프롬프트된 클래스 $c$에 조건화된 특징을 기반으로 밀집(dense) 프롬프트 임베딩 $T_{D}^{\{(c)\}}$와 희소(sparse) 프롬프트 임베딩 $T_{S}^{\{(c)\}}$를 생성합니다.
    3. 마스크 디코더 $D_{M}$는 $F_{I}$와 $[T_{D}^{\{(c)\}}, T_{S}^{\{(c)\}}, T_{O}]$를 사용하여 클래스 $c$의 마스크 $M^{\{(c)\}}$를 예측합니다. 여기서 $T_{O}$는 SAM의 학습 가능한 출력 토큰입니다.

* **프로토타입 기반 클래스 프롬프트 인코더:**
  * 각 클래스 $k \in \{1, 2, ..., C\}$를 대표하는 프로토타입 $B^{\{(k)\}} \in \mathbb{R}^{\text{d}}$로 구성된 프로토타입 뱅크 $B = \text{concat}(\{B^{\{(k)\}}\}_{\text{k} \in \{1,2,...,\text{C}\}}) \in \mathbb{R}^{\text{C} \times \text{d}}$를 활용합니다.
  * 이미지 임베딩 $F_{I}$와 각 클래스 프로토타입 $B^{\{(k)\}}$ 간의 점곱을 계산하여 공간적 유사성 행렬 $S^{\{(k)\}} \in \mathbb{R}^{\text{h} \times \text{w}}$를 생성합니다: $S^{\{(k)\}} = F_{I} \times B^{\{(k)\}}$.
  * 유사성 행렬 $S^{\{(k)\}}$는 공간적 어텐션으로 사용되어 클래스별 영역을 활성화하고, 클래스 활성화 특징 $F_{I}^{\{(k)\}} \in \mathbb{R}^{\text{h} \times \text{w} \times \text{d}}$를 생성합니다: $F_{I}^{\{(k)\}} = F_{I} \circ S^{\{(k)\}} + F_{I}$.
  * **밀집 프롬프트 임베딩 $T_{D}^{\{(c)\}}$:** 프롬프트된 클래스 $c$의 클래스 활성화 특징 $F_{I}^{\{(c)\}}$를 2계층 MLP($g_{D}(\text{ReLU}(f_{D}(F_{I}^{\{(c)\}})))$를 통해 인코딩하여 생성합니다.
  * **희소 프롬프트 임베딩 $T_{S}^{\{(c)\}}$:** 모든 클래스의 클래스 활성화 특징 $F_{I}^{\text{C}}$를 2계층 MLP를 통해 긍정성(positivity) 불가지(agnostic) 희소 프롬프트 임베딩 $\hat{T}_{S}^{\text{C}}$를 생성합니다. 여기에 긍정 임베딩 $\lambda_+$ (프롬프트 클래스 $c$에 해당)과 부정 임베딩 $\lambda_-$ (프롬프트 클래스 $c$ 이외의 클래스에 해당)를 추가하여 긍정성 인지(aware) 희소 프롬프트 임베딩 $T_{S}^{\{(c)\}}$를 구성합니다.

* **대조 프로토타입 학습:**
  * 수술 시나리오에서 유사한 도구 외형으로 인해 정확한 클래스 프로토타입을 얻기 어려운 문제를 해결하기 위해, infoNCE 손실에서 영감을 받은 프로토타입 대조 손실($L_{PCL}$)을 제안합니다.
  * 클래스 프로토타입 $B^{\{(k)\}}$를 앵커로, 훈련 이미지 내의 SAM 기반 클래스 임베딩 $v^{\{(k)\}}$를 샘플로 간주합니다. $v^{\{(k)\}}$는 이미지 임베딩 $F_{I}$와 해당 클래스 $k$의 ground-truth 마스크 $G^{\{(k)\}}$를 사용하여 전경 특징을 평균화하여 추출됩니다.
  * $L_{PCL} = - \frac{1}{\text{C}} \sum_{\text{k}=1}^{\text{C}} \log \frac{\exp(B^{\{(k)\}} \cdot v^{\{(k)\}}/\tau)}{\sum_{\text{q}=1}^{\text{C}} \exp(B^{\{(k)\}} \cdot v^{\{(q)\}}/\tau)}$
  * 이 손실은 클래스 $k$의 프로토타입과 클래스 $k$의 SAM 기반 클래스 임베딩 간의 유사성을 강화하고, 다른 클래스의 SAM 기반 클래스 임베딩과의 유사성을 억제하여 프로토타입의 판별력을 높입니다.

* **효율적인 튜닝:**
  * 튜닝 중에는 대규모 이미지 인코더는 고정(frozen)하고, 경량 프로토타입 기반 프롬프트 인코더와 마스크 디코더의 매개변수만 업데이트합니다.
  * 손실 함수는 세분화를 위한 다이스 손실($L_{DICE}$)과 프로토타입 학습을 위한 프로토타입 대조 손실($L_{PCL}$)의 합으로 구성됩니다: $L = L_{DICE} + L_{PCL}$.

## 📊 Results

* **최첨단 성능 달성:** SurgicalSAM은 EndoVis2018 및 EndoVis2017 데이터셋 모두에서 기존 SAM 기반 제로샷 모델(MaskTrack-RCNN + SAM, Track Anything, PerSAM)을 능가하며, SOTA 전문 모델과 대등하거나 더 뛰어난 성능을 달성했습니다.
* **높은 효율성:** SurgicalSAM은 4.65M개의 튜닝 가능한 매개변수만을 사용하여, SOTA 전문 모델(MATIS Frame 68.72M)보다 훨씬 적은 매개변수로 탁월한 훈련 및 추론 효율성을 보였습니다. 훈련 속도는 10배 이상 빠르고, GPU 메모리 사용량은 1/6 미만이었습니다.
* **프롬프트 강건성:** Ground-truth 중심점 또는 경계 상자를 프롬프트로 사용하는 SAM에 비해 SurgicalSAM이 훨씬 우수한 성능을 보였으며(EndoVis2018에서 Challenge IoU 20.07%p, EndoVis2017에서 25.52%p 개선), 이는 수동 안내를 사용하는 것보다 우수함을 시사합니다.
* **대조 프로토타입 학습의 효과:** 대조 프로토타입 학습이 없을 경우 Challenge IoU와 mc IoU에서 상당한 성능 하락을 보였으며, 이는 유사한 도구 카테고리 간의 프로토타입 판별력을 강화하는 데 대조 프로토타입 학습이 중요함을 입증했습니다.
* **교차 데이터셋 일반화:** EndoVis2018로 훈련하고 EndoVis2017에서 평가했을 때 SOTA 전문 모델 MATIS Frame보다 평균 IoU에서 11.43%p 크게 향상되어, SurgicalSAM이 새로운 데이터 분포에 효과적으로 일반화하는 뛰어난 능력을 가짐을 보여주었습니다.

## 🧠 Insights & Discussion

* SurgicalSAM은 SAM의 강력한 사전 학습된 일반 지식과 수술 도구에 특화된 도메인 지식을 효율적인 튜닝을 통해 성공적으로 통합하여, 자연 객체와 수술 도구 간의 도메인 격차를 효과적으로 해소합니다.
* 명시적인 점 또는 경계 상자 프롬프트 대신 클래스 ID만을 사용하여 세분화를 가능하게 함으로써 파이프라인을 단순화하고, 복잡한 다단계 처리나 수동 안내의 필요성을 제거하여 프롬프트 강건성을 크게 향상시킵니다. 이는 실제 수술 환경에서의 실용성을 높입니다.
* 대조 프로토타입 학습은 외관상 매우 유사한 미세한 수술 도구 범주들을 효과적으로 구별할 수 있는 판별적인 프로토타입을 학습하게 하여 세분화 정확도를 높입니다.
* 매우 적은 수의 튜닝 가능한 매개변수로 SOTA 성능과 높은 효율성을 달성하는 것은 수술 분야에서 SAM과 같은 파운데이션 모델을 적응시키는 데 큰 가능성을 제시합니다. 특히, 훈련 및 추론 효율성 증가는 모델 개발 리소스 절약 및 의료 기술의 접근성 향상에 기여할 수 있습니다.
* 파운데이션 모델의 일반 지식이 작은 수술 데이터셋에서 흔히 발생하는 클래스 불균형 문제를 완화하는 데 도움이 될 수 있음을 시사합니다.

## 📌 TL;DR

SurgicalSAM은 수술 도구 세분화를 위해 SAM의 도메인 격차와 정확한 프롬프트 의존성 문제를 해결합니다. 이미지 인코더는 고정하고, 클래스 ID로부터 직접 프롬프트 임베딩을 생성하는 경량 프로토타입 기반 클래스 프롬프트 인코더와 마스크 디코더만 효율적으로 튜닝합니다. 이 인코더는 대조 프로토타입 학습을 통해 미세한 도구 범주 간의 판별력을 높입니다. SurgicalSAM은 EndoVis2018/2017에서 SOTA 성능을 달성하며, 적은 튜닝 파라미터로 높은 효율성을 보이고 뛰어난 교차 데이터셋 일반화 능력을 입증했습니다.
