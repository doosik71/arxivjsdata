# FUN-SIS: 수술 도구 분할을 위한 완전 비지도 학습 접근법

Luca Sestini, Benoit Rosa, Elena De Momi, Giancarlo Ferrigno, Nicolas Padoy

## 🧩 Problem to Solve

최소 침습 수술에서 내시경 이미지의 자동 수술 도구 분할은 컴퓨터 지원 응용 프로그램의 핵심 빌딩 블록입니다. 그러나 현재 최신 기술(state-of-the-art) 접근 방식들은 수동으로 주석을 달아 얻은 지상 진실(ground-truth) 감독 신호에 전적으로 의존하며, 이는 대규모로 수집하기에 비용이 많이 듭니다. 기존의 비디오 객체 분할(VOS) 방법들은 도구와 조직 간의 일관된 움직임, 그리고 도구가 오랫동안 정지해 있을 수 있는 수술 환경에서는 잘 작동하지 않는다는 한계가 있습니다.

## ✨ Key Contributions

* **FUN-SIS (Fully-UNsupervised Surgical Instrument Segmentation)**: 수술 도구 이진 분할을 위한 완전 비지도 학습 접근 방식을 제안합니다.
* **형상 사전(shape-priors) 도입**: 비디오와 동일한 데이터셋/도메인에서 오지 않아도 되는 사실적인 도구 분할 마스크(예: 다른 데이터셋의 기존 주석 재활용, 녹색 스크린 촬영물 자동 분할, 3D 가상/CAD 모델 투영)를 활용합니다.
* **광학 흐름(optical-flow) 분할을 위한 새로운 생성적 적대적 접근 방식**: 훈련 중 `shape-priors`로부터 광학 흐름 이미지를 동시에 생성하고 분할하여, 불일치하는 배경 움직임 가설을 완화합니다.
* **의사 라벨(pseudo-labels)의 노이즈 속성 분석**: 광학 흐름 분할로 생성된 의사 라벨의 **'예측 불가능성(unpredictability)'** 및 **'극성(polarization)'** 이라는 두 가지 독특한 노이즈 속성을 식별하고 철저히 분석하여, 이들이 분할 결과 개선에 크게 기여함을 보여줍니다.
* **노이즈 라벨 학습(learning-from-noisy-labels) 전략**: 위에서 식별된 노이즈 속성을 활용하여 의사 라벨의 "아마도 잘 라벨링된(probably well-labelled)" 영역에서만 Student 모델을 훈련하는 새로운 전략을 제안합니다. 이는 기존 방법과 달리 깨끗한 라벨로 훈련된 Teacher 모델을 요구하지 않습니다.
* **최첨단 성능 달성**: 완전 비지도 방식으로 수술 도구 분할에서 완전 지도 방식의 최신 기술과 거의 동등한 결과를 달성합니다.

## 📎 Related Works

* **수술 도구 분할**:
  * 초기 연구는 수작업 특징, SVM, Random Forests, `shape-priors` 기반 템플릿 매칭(Bouget et al. (2015))을 사용했습니다.
  * 최근 연구는 U-Net 변형, 다중 작업 학습, 어텐션 기반 접근 방식과 같은 완전 지도 딥러닝 방법을 주로 사용했습니다(Shvets et al. (2018a), Jin et al. (2019a)).
  * 주석 문제 해결을 위한 대안으로 크라우드소싱(Maier-Hein et al. (2016)), 반합성 데이터셋 생성(Garcia-Peraza-Herrera et al. (2021)), 키네마틱스 및 녹색 스크린 결합(Colleoni et al. (2020)), Cycle-GAN을 이용한 합성 도메인 변환(Colleoni and Stoyanov (2021)) 등이 있습니다.
  * 반지도 학습은 광학 흐름을 이용한 라벨 전파(Zhao et al. (2020))를 포함합니다.
  * 비지도 학습으로는 수작업 특징과 인접 프레임 간의 특징 상관관계를 이용한 의사 라벨 생성(Liu et al. (2020a))이 있습니다.
* **비디오 객체 분할 (VOS)**:
  * 움직임 정보는 VOS에서 중요한 단서이며, 강력한 광학 흐름 추정기를 통해 비디오에서 쉽게 얻을 수 있습니다.
  * 반지도 VOS는 첫 프레임의 마스크를 이용해 객체를 추적하고, 비지도 VOS는 전경 객체를 배경에서 분리하는 것을 목표로 합니다.
  * 일반적으로 비지도 VOS는 불일치하는 배경 움직임 가설에 의존하지만, 수술 환경에서는 도구와 조직 간의 강한 상호작용으로 인해 이 가설이 위배됩니다. FUN-SIS는 수술 도구에 대한 비지도 VOS를 수행하는 첫 시도입니다.
* **노이즈 라벨로부터 학습**:
  * 노이즈 라벨로부터 효과적으로 학습하는 것은 딥러닝 응용 분야의 필수적인 요구 사항입니다.
  * 접근 방식은 견고한 아키텍처, 견고한 정규화, 견고한 손실 함수 설계(예: 일반화 교차 엔트로피(GCE), 대칭 교차 엔트로피(SCE)), 샘플 선택(MentorNet, Co-teaching)으로 분류됩니다.
  * 분할 작업에서는 픽셀 라벨이 이미지로 그룹화되어 있기 때문에 샘플 선택에 대한 재고가 필요합니다. FUN-SIS는 지역적 신뢰도 맵 추정기(Yu et al. (2019), Nie et al. (2018))와 달리 깨끗한 라벨 없이 지역 선택을 수행합니다.

## 🛠️ Methodology

FUN-SIS는 3단계 접근 방식입니다 (1단계와 2단계는 동시에 수행하여 2단계로 압축 가능).

1. **1단계: Teacher – 비지도 광학 흐름 분할 (생성적 적대적 학습)**
    * `shape-priors`로부터 합성 광학 흐름 이미지를 동시에 생성하고 분할하는 새로운 **생성적 적대적 접근 방식**을 사용하여 광학 흐름 도구 분할 모델($S_{OF}$, "Teacher")을 학습시킵니다.
    * **복잡도 불균형($complexity-imbalance$) 완화**: 표준 Cycle-GAN에 다음 수정 사항을 적용합니다:
        * 단일 **사이클 일관성 손실($L_{cycle}$)**: 정보 은닉(steganography)을 방지하기 위해 `shape-priors` 도메인에만 적용됩니다.
        * **노이즈 벡터($n$) 연결**: `shape-priors` 마스크($m$)에 무작위 노이즈 벡터 $n$을 연결하여, 생성기($G$)가 동일한 `shape-priors` 마스크로부터 다양한 합성 광학 흐름 이미지를 생성하도록 하여 도구 실루엣과 움직임을 분리합니다.
        * **광범위한 온-더-플라이(on-the-fly) 증강**: 광학 흐름에 임의의 회전 행렬 $R = \begin{pmatrix} \cos\theta_{flow} & -\sin\theta_{flow} \\ \sin\theta_{flow} & \cos\theta_{flow} \end{pmatrix}$을 곱하고 정규화를 수행하여 광학 흐름의 가변성을 높입니다.
    * **손실 함수**: $L_{cycle} = -m \log(\hat{m}) - (1-m) \log(1-\hat{m})$, 생성기 적대적 손실 $L_{G_{adv}} = -\log(D(m_{OF}))$, 판별기 적대적 손실 $L_{D_{adv}} = -\log(1-D(m_{OF})) - \log(D(y_{OF_t}))$를 사용하여 모델을 훈련합니다.

2. **2단계: Proxy & "예측 불가능성" 노이즈 속성**
    * Teacher 모델($S_{OF}$)이 생성한 노이즈가 있는 의사 라벨($y^T_t$)을 직접 감독 신호로 사용하여 개별 프레임의 도구 분할을 수행하는 신경망("Proxy" 모델)을 훈련합니다.
    * **"예측 불가능성($unpredictability$)"** 속성 활용: 의사 라벨의 노이즈(광학 흐름 추정 노이즈 또는 광학 흐름 분할 노이즈)는 개별 프레임($x_t$)만으로는 예측할 수 없으므로, Proxy 네트워크는 노이즈 패턴을 외우는 대신 의사 라벨과 호환되는 가장 쉬운 일반 패턴(즉, 도구와 조직 분리)을 학습합니다.
    * 이를 위해 상대적으로 용량이 작은 네트워크(Unet11)를 사용합니다.
    * **손실 함수**: 이진 교차 엔트로피 손실($L_{P_{CE}}$)과 로그 합집합-교차-비율(IoU) 손실($L_{P_{IoU}}$)의 가중 합 $L_P = \alpha_P L_{P_{IoU}} + (1-\alpha_P) L_{P_{CE}}$를 최소화합니다.

3. **3단계: Student & "극성" 노이즈 속성**
    * Teacher 및 Proxy 모델의 예측 간의 지역적 일치도(local agreement)를 기반으로 "아마도 잘 라벨링된" 영역에서만 훈련하는 최종 모델("Student")을 훈련합니다.
    * **"극성($polarization$)"** 속성 활용: 일관된 움직임을 가진 개별 도구는 광학 흐름 이미지에서 균일한 모양을 가지는 경향이 있어, 이상적인 조건에서는 완벽하게 분할되거나 완전히 잘못 라벨링됩니다. 이는 의사 라벨 내에 거의 완벽하게 라벨링된 영역 또는 거의 완전히 잘못 라벨링된 영역이 존재한다는 것을 의미합니다.
    * **지역 라벨 선택**: `localIoU` ($IoU_{loc}(w,h)$)를 사용하여 Proxy 네트워크의 예측($y^P_t$)과 의사 라벨($y^T_t$) 간의 일치도를 측정합니다. $w \times h$ 크기의 윈도우를 슬라이딩하며 각 지역의 IoU를 계산하고, 임계값 $\theta_{IoU}$로 이진화하여 손실 전파를 위한 마스크로 사용합니다.
    * **손실 함수**: `localIoU` 마스크로 픽셀 단위 손실을 가린 이진 교차 엔트로피 손실($L_{S_{CE}}$)과 로그 IoU 손실($L_{S_{IoU}}$)의 가중 합 $L_S = \alpha_S L_{S_{IoU}} + (1-\alpha_S) L_{S_{CE}}$를 최소화합니다.

## 📊 Results

* **광학 흐름 분할 (Teacher)**:
  * EndoVis2017VOS 데이터셋에서 최신 CIS (Contextual Information Separation) 접근 방식보다 +16.32% $\Delta$IoU 더 높은 40.08% IoU를 달성했습니다. DAVIS2016 데이터셋에서도 CIS를 능가합니다 (SegTrackV2 `shape-priors` 사용 시 63.40% IoU). 이는 불일치 배경 움직임 가설을 완화한 덕분입니다.
* **프레임별 수술 도구 분할 (Student)**:
  * **EndoVis2017VOS**: Student 네트워크는 83.77%의 IoU를 달성하여, 비지도 학습 AGSD(67.85%)를 크게 앞서며 완전 지도 학습 Baseline$_{FS}$(88.99%)에 근접한 성능을 보였습니다.
  * **학습 과정**: Teacher(40.08% IoU) $\rightarrow$ Proxy(74.78% IoU) $\rightarrow$ Student(83.77% IoU)로 일관된 성능 향상을 보였습니다. 통계적 유의미성 검증 결과, 각 단계 간에 큰 효과 크기(Cohen's d)를 가진 유의미한 차이($p \ll 0.001$)가 확인되었습니다.
  * **EndoVis2017Challenge**: 76.25% IoU를 달성했으나, '기타' 장비를 배경으로 간주하는 규칙 때문에 EndoVis2017VOS보다 낮은 성능을 보였습니다.
  * **STRAS 데이터셋**: 도전적인 데이터셋에서도 66.37% IoU를 달성하며 방법의 견고성을 입증했습니다.
* **어블레이션 스터디 (Ablation Studies)**:
  * **광학 흐름 증강 및 노이즈 벡터**: `AugmFlow` 증강이 중요하며, 노이즈 벡터(크기 32) 결합은 Teacher 성능을 더욱 향상시킵니다.
  * **Proxy 네트워크 아키텍처**: 얕은 Proxy 네트워크(Unet11)가 깊은 네트워크(Unet16)보다 효과적으로 학습하여 "가장 쉬운 패턴" 가설을 지지합니다.
  * **손실 함수 계수**: 로그 IoU 손실은 노이즈가 많은 의사 라벨 학습에 특히 긍정적인 영향을 미칩니다.
  * **`localIoU` 매개변수**: 최적의 매개변수(윈도우 크기 64, 임계값 0.5)를 통해 전체 훈련 데이터의 50.48%를 효과적으로 사용하며, 의사 라벨의 유효 IoU는 80.70%에 달합니다.
  * **`shape-priors` 품질 및 수량**: FUN-SIS는 `shape-priors`의 출처(RoboTool vs GrScreenTool)와 수량(51개의 `shape-priors` 마스크만으로도 최적의 성능)에 매우 견고합니다.
  * **노이즈 속성 ('예측 불가능성' & '극성')**: 예측 불가능한 노이즈 상황에서 Proxy가 크게 개선되고, 극성 노이즈 상황에서 Student가 `localIoU` 선택 덕분에 추가적인 개선을 달성함을 인위적 노이즈 데이터셋 실험을 통해 확인했습니다.
  * **무작위 비지도 데이터 (RandSurg)**: RandSurg 데이터셋으로 훈련 시 EndoVis2017VOS에서 79.65% IoU를 달성하여, 일반 수술 비디오에 대한 견고성과 사용 편의성을 보여주었습니다.
  * **교차 도메인 적용 가능성 (Cholec80)**: 로봇 수술 `shape-priors`를 사용하여 수동 복강경 수술 데이터셋(Cholec80)에 대해 정성적으로 적용 가능함을 확인했습니다.

## 🧠 Insights & Discussion

* FUN-SIS는 다양한 수술 데이터셋(로봇, 유연 내시경, 복강경)에서 완전 비지도 방식으로 이진 수술 도구 분할을 효과적으로 수행합니다.
* EndoVis2017VOS에서 Student 네트워크의 83.77% IoU는 최신 완전 지도 모델(MF-TAPNet의 89.61%)과 거의 동등한 수준입니다.
* 주요 통찰력은 제안된 광학 흐름 분할이 수술 장면의 복잡성에 강하며, 의사 라벨 노이즈의 "예측 불가능성"과 "극성" 속성이 노이즈 라벨 학습 전략에 핵심적이라는 것입니다.
* `shape-priors`의 품질과 수량에 대한 요구 사항이 매우 낮아 실용성이 높습니다.
* **한계 및 향후 연구**:
  * 현재 "불확실하게 라벨링된" 픽셀(약 49.52%)을 버리는데, 이를 반지도 학습 전략으로 활용할 수 있습니다.
  * `localIoU` 계산에 사용되는 고정된 윈도우 크기를 도구 크기 및 위치에 따라 유연하게 조정하는 접근 방식이 이점이 있을 수 있습니다.
  * Proxy 네트워크 훈련의 불안정성을 완화하기 위해 자기 앙상블(self-ensembling)과 같은 방법을 적용할 수 있습니다.
  * FUN-SIS의 성능은 광학 흐름 이미지의 품질에 영향을 받으며, 이는 내시경 카메라 해상도 및 광학 흐름 추정기에 따라 달라집니다.
  * 현재는 이진 분할에 국한되며, 도구 클래스 내의 의미론적 차별화(multi-class segmentation)를 위해 움직임 패턴 분석 또는 제한된 외부 의미론적 감독을 탐색할 수 있습니다.

## 📌 TL;DR

본 논문은 수술 도구 분할을 위한 새로운 완전 비지도 학습 방법인 FUN-SIS를 제시합니다. 이 방법은 비주석 내시경 비디오에서 암묵적인 움직임 정보와 도구 형상 사전(shape-priors)만을 사용하여 의사 라벨을 생성합니다. 생성된 의사 라벨의 "예측 불가능성"과 "극성" 노이즈 속성을 활용하는 혁신적인 "노이즈 라벨로부터 학습" 전략을 통해 깨끗한 감독 신호를 추출하여 프레임별 분할 모델을 훈련합니다. FUN-SIS는 다양한 수술 데이터셋에서 완전 지도 학습 최신 기술과 거의 동등한 성능을 달성하여, 대량의 비주석 수술 데이터를 활용할 수 있는 엄청난 잠재력을 보여줍니다.
