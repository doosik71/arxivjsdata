# CompILE: Compositional Imitation Learning and Execution

Thomas Kipf, Yujia Li, Hanjun Dai, Vinicius Zambaldi, Alvaro Sanchez-Gonzalez, Edward Grefenstette, Pushmeet Kohli, Peter Battaglia

## 🧩 Problem to Solve

시퀀스 데이터에서 재사용 가능하고 가변 길이의 계층적 행동 세그먼트를 **비지도 학습** 방식으로 학습하는 문제. 특히, 시연(demonstration) 데이터를 입력으로 받아 행동 시퀀스를 자동으로 분할하고 각 세그먼트의 추상적인 잠재 인코딩(latent encoding)을 학습하여, 이를 새로운 작업을 위해 재조합하고 실행할 수 있도록 하는 것이 목표입니다. 기존 접근 방식들은 종종 명시적인 라벨링이나 특정 구조를 가정합니다.

## ✨ Key Contributions

* 새로운 비지도 학습 방식의 **완전 미분 가능한 시퀀스 분할 모듈(CompILE)**을 제안합니다.
* 시퀀스 데이터의 잠재 인코딩 및 해당 행동 정책을 학습하여 새로운 작업을 위해 재조합 및 실행 가능하게 합니다.
* 학습 시점에 보지 못한 더 긴 시퀀스나 새로운 환경 인스턴스에도 효과적인 일반화 성능을 보입니다.
* 학습된 잠재 코드와 정책을 활용하는 계층적 에이전트가 **희소 보상(sparse reward) 환경**에서 성공적으로 학습할 수 있음을 입증합니다. 이는 비계층적 에이전트가 어려움을 겪는 영역입니다.
* 세그먼트 경계를 Gumbel softmax를 통해 **연속적으로 이완된(relaxed) 이산 잠재 변수**로 모델링하여 효율적이고 저분산(low-variance) 학습을 가능하게 합니다.

## 📎 Related Works

* **옵션 디스커버리 (Option Discovery):** Niekum et al., Fox et al. 등의 연구와 유사하게 재사용 가능한 행동 단위(옵션)를 찾는 것을 목표로 하지만, CompILE은 잠재 변수의 타입(연속, 이산, 혼합)에 더 유연합니다.
* **역강화학습 (Inverse Reinforcement Learning, IRL) 및 GAN:** Hausman et al. 등의 연구는 환경과의 상호작용(온라인)이 필요하지만, CompILE은 행동 복제(Behavioral Cloning, BC) 기반으로 오프라인 시연 데이터에만 의존합니다.
* **지도/약지도 시퀀스 분할:** Graves, Krishna et al., Shiarlis (TACO), Sun et al. 등은 다양한 수준의 지도 학습을 필요로 하는 반면, CompILE은 완전 비지도 학습 방식입니다.
* **계층적 강화 학습 (Hierarchical RL):** Sutton et al., Kulkarni et al. 등의 연구는 행동의 분할 및 표현 학습을 다루지만 순수하게 생성적인(generative) 방식입니다.
* **자연어 및 음성 처리의 비지도 분할:** Blei & Moreno, Goldwater et al. 등 시퀀스 데이터의 비지도 분할 접근법이 존재합니다.
* **동시 연구:** Pertsch et al.의 미분 가능한 키프레임 디스커버리 모델과도 관련이 있습니다.

## 🛠️ Methodology

CompILE은 조건부 변분 오토인코더 (Conditional VAE) 프레임워크를 기반으로 합니다.

1. **행동 복제 (Behavioral Cloning, BC) 설정:** 전문가 시연 데이터 $D = \{\rho_1, ..., \rho_N\}$에서 얻은 상태-행동 궤적 $\rho = ((s_1, a_1), ..., (s_T, a_T))$을 오토인코딩합니다.
2. **하위 작업 식별 및 모방:**
    * 궤적 $\rho$를 $M$개의 서로 다른 세그먼트 $c_i$로 분할하며, 이때 이산 잠재 경계 변수 $b_i$를 활용합니다.
    * 각 세그먼트 $c_i$는 해당 세그먼트의 내용을 요약하는 잠재 변수 $z_i$에 매핑되며, 이 $z_i$는 하위 작업 정책 $\pi_\theta(a|s, z)$를 정의합니다. 세그먼트 길이에 대한 Poisson 사전 분포 $p(b_i|b_{i'})$를 사용하여 세그먼트 길이가 특정 값($\lambda$)에 가깝도록 유도합니다.
3. **인식 모델 ($q_\phi(b_{1:M}, z_{1:M}|x_{1:T})$):**
    * 주어진 궤적 $x_{1:T}$에 대해 작업 분해(경계 변수 $b_{1:M}$)와 작업 인코딩($z_{1:M}$)을 추론합니다.
    * 이 모델은 이전에 설명된 세그먼트를 마스킹(masking)함으로써 동일한 인식 모델을 재사용하고, 새로운 구성에 일반화되도록 설계되었습니다.
    * 단방향 LSTM(Long Short-Term Memory)과 두 개의 출력 헤드를 사용합니다. 하나는 하위 작업 인코딩 $z_i$를 예측하고, 다른 하나는 경계 변수 $b_i$를 예측합니다.
    * 입력 $x_t = (a_t, s_t)$는 CNN(픽셀 기반 입력) 또는 MLP를 통해 임베딩됩니다.
4. **연속 이완 (Continuous Relaxation, 훈련 시):**
    * $b$와 $z$에 대한 이산 범주형 분포를 Gumbel softmax/Concrete 분포로 대체하여 재매개변수화 트릭(reparameterization trick)을 적용하고 저분산 기울기 추정을 가능하게 합니다.
    * **소프트 세그먼트 마스크:** 특정 시간 단계 $t$가 $i$번째 세그먼트 $C_i$에 속할 확률 $P(t \in C_i)$를 계산하여 세그먼트 경계가 "소프트"하게 정의되도록 합니다.
    * **RNN 상태 마스킹:** 이전 세그먼트에 의해 설명된 부분의 RNN 은닉 상태를 소프트하게 마스킹하여, 기울기가 통과하면서도 모델이 현재 세그먼트에 집중하도록 합니다.
    * **손실 마스킹:** 재구성 손실은 각 세그먼트의 $P(t \in C_i)$로 마스킹되어 해당 세그먼트 내의 행동에 대한 학습 신호만 반영되도록 합니다.
5. **복잡도:** 길이 $T$의 궤적과 $M$개의 세그먼트에 대해 $O(TM)$의 시간 복잡도를 가집니다.

## 📊 Results

* **모방 학습 (Imitation Learning):**
  * **그리드 월드 (Grid World) 환경:** CompILE은 'pick up' 및 'visit' 작업 모두에서 정확한 경계 위치를 안정적으로 찾고, 행동 시퀀스를 거의 완벽하게 재구성했습니다. 특히, 학습 시보다 더 긴 시퀀스(5개 작업)에 대한 일반화 성능이 우수했으며, 비분할 BC(단일 잠재 변수) 기준선은 이러한 일반화에 실패했습니다.
  * **연속 제어 (Continuous Control) 환경:** CompILE (완전 비지도)는 LSTM surprisal 기준선보다 경계 복구 성능이 크게 뛰어났습니다. 잠재 변수 $z$ 또는 경계 $b$에 약한 지도를 제공하는 z-CompILE 및 b-CompILE은 거의 완벽한 세그먼트 경계 복구 성능을 보였습니다.
* **계층적 강화 학습 (Hierarchical Reinforcement Learning):**
  * CompILE 모델에서 학습된 하위 작업 정책을 사용하는 계층적 에이전트는 모든 실험 설정에서 일관된 결과를 얻었으며, 3개 작업으로 사전 학습되었음에도 불구하고 5개 작업 설정에 잘 일반화되었습니다.
  * 특히, **희소 보상 (sparse reward) 환경**의 'pick up' 작업에서 성공적으로 학습한 **유일한 에이전트**였으며, 다른 비계층적 또는 단일 세그먼트 BC 에이전트들은 학습에 어려움을 겪었습니다.

## 🧠 Insights & Discussion

* **의미:** CompILE은 명시적인 지도 없이 시연 데이터로부터 구성 가능한 행동을 학습하는 효과적인 방법을 제공하며, 이는 희소 보상 환경에서 계층적 강화 학습을 위한 견고하고 일반화 가능한 하위 정책으로 활용될 수 있음을 보여주었습니다.
* **한계점:**
  * 학습된 잠재 코드가 항상 인간이 정의한 의미론(예: 그리드 월드에서 객체 유형 대신 위치 특이적 코드)과 일치하지 않을 수 있습니다. 약한 지도를 통한 잠재 코드의 접지(grounding)에 대한 추가 연구가 필요합니다.
  * 현재 모델은 완전 관측 가능(fully-observable)하고 마르코프적인(Markovian) 설정에 초점을 맞추고 있습니다. 부분 관측 가능한 환경으로의 확장은 생성 모델에 대한 순환성(recurrency) 또는 기억(memory) 요구 사항과 함께 추가적인 도전 과제를 제시할 것입니다.
* **향후 연구:** 부분 관측 가능한 환경으로의 확장, 에피소드 기억 모듈로서의 적용 가능성, 그리고 추상적이고 높은 수준의 계획을 위한 계층적 확장 등을 탐구할 예정입니다.

## 📌 TL;DR

**문제:** 시연 데이터로부터 재사용 가능하고 계층적인 행동을 비지도 방식으로 학습하는 것이 목표.
**방법:** CompILE은 완전 미분 가능한 시퀀스 분할 모듈을 갖춘 VAE(Variational Auto-Encoder) 기반 프레임워크를 제안. Gumbel softmax를 통해 세그먼트 경계($b$)와 하위 작업의 잠재 인코딩($z$)을 학습하여, 입력 시퀀스를 자동 인코딩하고 재구성함.
**발견:** CompILE은 하위 작업과 그 경계를 성공적으로 발견하며, 학습된 정책은 계층적 강화 학습 에이전트가 희소 보상 환경에서 어려운 작업을 학습하고, 더 긴 시퀀스와 새로운 환경에 일반화하는 데 기여함을 입증. 이는 비계층적 기준선보다 우수한 성능임.
