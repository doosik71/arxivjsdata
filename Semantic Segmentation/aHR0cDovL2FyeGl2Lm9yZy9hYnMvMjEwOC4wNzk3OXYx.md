# A New Bidirectional Unsupervised Domain Adaptation Segmentation Framework

Munan Ning, Cheng Bian, Dong Wei, Shuang Yu, Chenglang Yuan, Yaohua Wang, Yang Guo, Kai Ma, and Yefeng Zheng

## 🧩 Problem to Solve

* **도메인 시프트(Domain Shift) 문제**: 딥러닝 모델이 한 도메인(소스 도메인)에서 학습된 후 다른 도메인(타겟 도메인)에 적용될 때 성능이 저하되는 현상. 특히 다중 모달 의료 영상 분석(예: MRI와 CT 간)에서 주석의 어려움으로 인해 이 문제가 심화됩니다.
* **기존 UDA(Unsupervised Domain Adaptation) 방법의 한계**: 대부분의 기존 UDA 방법은 한 방향 적응(예: MRI $\rightarrow$ CT)에서는 만족할 만한 성능을 보이지만, 역방향 적응(예: CT $\rightarrow$ MRI)에서는 `도메인 드롭(Domain Drop)`이라는 현상으로 인해 성능이 크게 저하되어 실제 적용에 제약이 있었습니다. 이 논문은 양방향 모두에서 동등하게 우수한 성능을 달성하는 `BiUDA(Bidirectional UDA)` 프레임워크의 필요성을 다룹니다.

## ✨ Key Contributions

* **DRPL(Disentangled Representation Learning) 기반 BiUDA 프레임워크 제안**: `도메인 드롭` 문제를 효과적으로 완화하고 `MMWHS` 및 `MMAS` 데이터셋에서 양방향 적응 모두에 대해 최신(SOTA) 성능을 달성하는 새로운 양방향 비지도 도메인 적응 프레임워크를 제안했습니다.
* **통합 도메인 인식 패턴 인코더 설계**: 각 모달리티마다 개별 패턴 인코더를 사용하는 기존 방식과 달리, `도메인 컨트롤러`를 통해 단일 모듈에서 다른 도메인의 인코딩 과정을 통합하는 `통합 도메인 인식 패턴 인코더`를 설계했습니다. 이는 매개변수를 줄이고 네트워크 성능을 향상시킵니다. 또한, 콘텐츠 및 패턴 코드의 왜곡을 방지하기 위해 `콘텐츠-패턴 일관성 손실(Content-Pattern Consistency Loss)`을 도입했습니다.
* **레이블 일관성 손실(Label Consistency Loss) 제안**: UDA 분할 작업의 성능 향상을 위해, 타겟 도메인 스타일의 이미지와 해당 소스 도메인 주석을 재구성하여 보조 학습을 제공하는 `레이블 일관성 손실`을 제안했습니다.

## 📎 Related Works

* **특징 정렬 기반 UDA 방법**: `AdaptSegNet [20]`, `BDL [16]`, `CLAN [18]` 등은 소스 도메인과 타겟 도메인의 특징 공간을 정렬하는 데 중점을 둡니다. 이러한 방법은 패턴과 콘텐츠가 유사한 일반 이미지에서는 효과적이지만, 다중 모달 의료 영상처럼 도메인 간 간극이 큰 경우에는 성능이 저하됩니다.
* **의료 영상 특화 UDA 방법**: `SIFA [4]`는 의료 시나리오에 특화되어 이미지 및 주석 공간에서 추가 정렬을 제안했지만, 주로 쉬운 UDA 방향(MRI $\rightarrow$ CT)에서만 효과적이고 역방향(CT $\rightarrow$ MRI)에서는 제한된 성능을 보입니다.
* **분리된 표현 학습(DRPL) 기반 UDA 방법**: `ACE [21]`는 VGG 네트워크를 사용하여 타겟 도메인 이미지에서 패턴 코드를 추출하여 소스 도메인 이미지에 통합합니다. `DISE [3]`는 `DRPL`을 활용하여 두 도메인 입력에서 콘텐츠 및 패턴 코드를 추출하고, 이를 분해-재구성 전략으로 UDA를 구현합니다. `DISE`는 `BiUDA` 문제에 효과적임이 입증되었으나, 본 논문은 `DISE`의 분리된 패턴 인코더와 달리 `통합 패턴 인코더`를 제안하여 성능을 개선합니다.

## 🛠️ Methodology

본 논문은 `DRPL(Disentangled Representation Learning)` 기반의 `BiUDA` 프레임워크를 제안합니다.

* **DRPL 아키텍처**:
  * **콘텐츠 인코더($E_c$)**: 입력 이미지 $x$를 도메인 불변의 해부학적 구조를 나타내는 `콘텐츠 코드` $c=E_c(x)$로 인코딩합니다.
  * **도메인 인식 패턴 인코더($E_p$)**: 입력 이미지 $x$를 도메인 특정 외형을 나타내는 `패턴 코드`로 인코딩합니다. 기존 방식과 달리, `도메인 컨트롤러` $d \in \{0,1\}$ (0은 소스, 1은 타겟)를 통해 `E_p(x|d)`와 같이 단일 인코더로 두 도메인의 패턴을 적응적으로 학습합니다. 이는 매개변수를 줄이고 인코딩 능력을 향상시킵니다.
  * **생성기(G)**: 콘텐츠 코드와 패턴 코드 쌍 $(c,p)$를 입력받아 이미지를 재구성합니다: $\hat{x}=G(c,p)$. 재구성된 소스 이미지($\hat{x}_s$), 재구성된 타겟 이미지($\hat{x}_t$), 변환된 이미지(소스 $\rightarrow$ 타겟 $\hat{x}_{s2t}$, 타겟 $\rightarrow$ 소스 $\hat{x}_{t2s}$)를 모두 단일 생성기로 처리합니다.
  * **분할기(S)**: 콘텐츠 코드 $c$를 의미론적 분할 마스크 $m=S(c)$로 디코딩합니다.

* **손실 함수**:
  * **콘텐츠-패턴 일관성 손실($L_{cpc}$)**: 분해-재구성 과정에서 콘텐츠($c$) 및 패턴($p$) 코드의 잠재적 왜곡을 방지합니다.
        $$L_{cpc} = E_{\hat{c} \sim \hat{C}, c \sim C}[\Vert \hat{c}-c \Vert_1] + E_{\hat{p} \sim \hat{P}, p \sim P}[\Vert \hat{p}-p \Vert_1]$$
  * **레이블 일관성 손실($L_{lc}$)**: 소스 도메인 이미지 $x_s$와 소스에서 타겟으로 변환된 이미지 $\hat{x}_{s2t}$가 동일한 해부학적 구조를 가져야 한다는 가정하에, 동일한 소스 주석 $a_s$로 이 둘의 분할을 감독합니다. 이는 타겟 도메인에 추가적인 학습 데이터를 제공하는 효과를 줍니다.
        $$L_{lc} = L_{seg}(a_s, m_s) + L_{seg}(a_s, \hat{m}_s)$$
        여기서 $L_{seg}(a_s,m)$은 교차 엔트로피와 Dice 손실의 조합입니다.
  * **사이클 일관성 손실($L_{cycle}$)**: CycleGAN [23]의 아이디어를 따라, 입력 이미지와 재구성된 이미지가 서로 가깝도록 강제합니다.
        $$L_{cycle} = E_{\hat{x} \sim \hat{X}, x \sim X}[\Vert \hat{x}-x \Vert_1]$$
  * **교차 재구성 손실($L_{GAN}$)**: GAN [9]을 따라, 변환된 이미지($\hat{x}_{s2t}$, $\hat{x}_{t2s}$)가 실제 타겟/소스 도메인 이미지와 구별할 수 없도록 하는 적대적 손실입니다.
        $$L_{GAN_{\hat{x}_{s2t}}} = E_{\hat{x}_{s2t} \sim \hat{X}_{s2t}}[\log (1-D(\hat{x}_{s2t}))] + E_{x_t \sim X_t}[\log D(x_t)]$$
        $$L_{GAN_{\hat{x}_{t2s}}} = E_{\hat{x}_{t2s} \sim \hat{X}_{t2s}}[\log (1-D(\hat{x}_{t2s}))] + E_{x_s \sim X_s}[\log D(x_s)]$$
  * **전체 손실 함수**: 위 손실들의 가중 합입니다.
        $$L = \lambda_1(L_{cpc_s} + L_{cpc_t}) + \lambda_2 L_{lc} + \lambda_3(L_{cycle_s} + L_{cycle_t}) + \lambda_4(L_{GAN_{\hat{x}_{s2t}}} + L_{GAN_{\hat{x}_{t2s}}})$$

## 📊 Results

* **성능 비교**: `MMWHS` 및 `MMAS` 두 가지 공개 데이터셋에서 `AdaptSegNet`, `BDL`, `CLAN`, `DISE`, `SIFA`, `ACE` 등 여러 SOTA UDA 방법들과 비교 평가되었습니다.
  * 제안된 `BiUDA` 프레임워크는 모든 비교 방법들보다 `Dice` 및 `F1` 점수 `성능 저하(Performance Drop)` 면에서 훨씬 우수한 성능을 보였습니다.
  * 특히, `양방향 적응`(MRI $\leftrightarrow$ CT) 간의 `성능 격차`(`도메인 드롭`)를 크게 줄여, 양방향 모두에서 가장 낮은 `성능 저하`를 달성했습니다.
* **정성적 분석**: 제안 방법의 분할 결과는 다른 경쟁 방법들보다 `Ground Truth`에 훨씬 더 가깝게 나타났으며, 특히 어려운 역방향 적응에서 우수함을 보였습니다.
* **절제 연구(Ablation Study)**: `콘텐츠-패턴 일관성 손실`, `레이블 일관성 손실`, `도메인 인식 패턴 인코더`의 효과를 검증하기 위한 절제 연구가 수행되었습니다.
  * `콘텐츠-패턴 일관성 손실` 추가 시 `Dice` 평균 성능 저하가 25.73%로 감소했습니다.
  * `레이블 일관성 손실` 도입 시 평균 성능 저하가 12.98%로 추가 감소했습니다.
  * `도메인 컨트롤러`를 포함한 `통합 도메인 인식 패턴 인코더`는 평균 성능 저하를 8.49%까지 추가 감소시켜 각 모듈의 효과를 입증했습니다.

## 🧠 Insights & Discussion

* **도메인 간극 문제 해결**: 기존 특징 정렬 기반 UDA 방법들은 다중 모달 의료 영상과 같이 도메인 간 간극이 큰 경우에 취약했습니다. 본 연구는 `DRPL`을 통해 모델이 콘텐츠와 패턴을 명확히 인식하도록 하여 이 문제를 더 우아하게 해결했습니다.
* **`DISE` 및 `ACE` 대비 우위**: `DRPL`을 활용하는 `DISE`나 `ACE`와 비교했을 때, 본 논문의 `통합 도메인 인식 패턴 인코더`는 패턴 차이를 더 잘 이해하며, `Dice` 성능 저하를 약 4% 추가로 감소시키는 효과를 보였습니다. 또한 `CPC` 및 `LC` 손실이 `ACE`의 `VGG` 기반 패턴 추출보다 더 효과적인 감독을 제공합니다.
* **실용적 가치**: 기존 UDA 방법들이 한 방향 적응에만 집중하거나 `도메인 드롭` 문제를 해결하지 못했던 것과 달리, 본 프레임워크는 양방향 적응에서 모두 우수한 성능을 보여 실제 다중 모달 의료 영상 분석 환경에서 UDA 기법의 유연한 솔루션을 제공합니다.

## 📌 TL;DR

의료 영상 분할에서 `양방향 비지도 도메인 적응(BiUDA)` 시 발생하는 `도메인 드롭` 문제(한 방향은 우수하나 역방향 성능이 저하되는 현상)를 해결하기 위해, 본 논문은 `DRPL(Disentangled Representation Learning)` 기반의 새로운 `BiUDA` 프레임워크를 제안합니다. 이 프레임워크는 매개변수를 줄이고 효율성을 높이는 `통합 도메인 인식 패턴 인코더`, 콘텐츠 및 패턴 왜곡을 방지하는 `콘텐츠-패턴 일관성 손실`, 그리고 보조 학습을 위한 `레이블 일관성 손실`을 핵심 요소로 포함합니다. 실험 결과, 제안된 방법은 기존 SOTA 방법들보다 `양방향 적응` 모두에서 월등히 우수한 성능을 달성하며 `도메인 드롭` 현상을 현저히 감소시켰습니다.
