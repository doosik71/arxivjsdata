# Curriculum-Based Augmented Fourier Domain Adaptation for Robust Medical Image Segmentation

An Wang, Mobarakol Islam, Mengya Xu, and Hongliang Ren

## 🧩 Problem to Solve

정확하고 강건한 의료 영상 분할(segmentation)은 컴퓨터 지원 진단 및 개입 시스템의 자율성을 향상하는 데 있어 매우 중요합니다. 그러나 의료 데이터는 다양한 스캐너, 프로토콜 및 모집단에서 수집되는 특성 때문에 도메인 이동(domain shift) 문제가 발생하며, 이는 배포 환경에서 모델 성능 저하를 야기합니다. 기존 딥러닝 모델은 도메인 간의 간극으로 인해 새로운 도메인에 배포될 때 성능 저하를 겪는 경우가 많습니다. 또한, 모델은 데이터 손상(corruption)의 영향을 완화하기 위해 높은 강건성(robustness)을 요구받습니다. 이러한 문제를 해결하고 다양한 테스트 도메인에서 모델 성능을 유지하는 강건한 의료 영상 분할 방법론이 필요합니다.

## ✨ Key Contributions

* 주파수 공간에서 점진적으로 증가하는 진폭 융합이 도메인 불일치를 완화하는 효과적인 커리큘럼 기반 접근 방식임을 시연했습니다.
* 훈련 시간 중 연쇄 증강 혼합(chained augmentation mixing)을 통합하여 훈련 데이터 다양성을 더욱 높이고, 커리큘럼 기반 증강 푸리에 도메인 적응(Curri-AFDA) 프레임워크를 구축했습니다.
* 다양한 망막(Retina) 및 핵(Nuclei) 분할 데이터셋, 그리고 다양한 유형 및 수준의 손상된 데이터셋에 대한 광범위한 실험을 통해 적응(adaptation), 일반화(generalization), 강건성(robustness) 측면에서 제안된 방법의 우수성을 입증했습니다.
* 분할(segmentation) 외에 피부 병변 데이터셋을 활용한 이미지 분류 작업에서도 Curri-AFDA의 유효성을 탐색하여 더 넓은 의료 응용 분야에 대한 잠재력을 보여주었습니다.

## 📎 Related Works

* **푸리에 변환 기반 도메인 적응 (Fourier Transform for Domain Adaptation)**: 푸리에 변환은 단순성, 효율성, 모델 불가지론적 특성으로 인해 도메인 적응에 활용됩니다. 특히, 주파수 영역의 저주파 진폭 성분(중앙 영역)이 도메인 특이 정보를 많이 담고 있습니다. FDA [21]는 소스 도메인(SD)과 타겟 도메인(TD) 이미지의 진폭 스펙트럼 중심 영역을 융합하여 도메인 이동을 완화합니다. FACT [22] 및 AmpMix [43]는 MixUp [36] 기술로 전체 진폭 스펙트럼을 혼합하여 더 나은 일반화 능력을 달성합니다. 기존 방법들이 고정된 진폭 융합 비율을 사용한 것과 달리, 본 연구는 훈련 과정에서 점진적으로 타겟 도메인 정보를 소스 도메인으로 전송합니다.
* **커리큘럼 기반 도메인 적응 (Curriculum-based Domain Adaptation)**: "쉬운 것에서 어려운 것"으로 학습하는 훈련 방식으로, 모델의 일반화 성능을 향상시키는 데 효과적입니다. 난이도 측정은 도메인 판별자 [32]나 밀도 기반 클러스터링 [33] 등 다양한 방식으로 이루어집니다. 본 연구는 주파수 영역 이미지의 진폭 성분이 도메인 특이적 저수준 통계를 포함한다는 속성을 활용하여, 진폭 융합을 통해 점진적인 스타일 정렬을 수행함으로써 모델이 데이터의 복잡한 패턴을 더 잘 인식하고 새로운 상황에 일반화할 수 있도록 합니다.
* **이미지 혼합을 통한 데이터 증강 (Data Augmentation by Mixing Images)**: 딥러닝 모델의 과적합, 낮은 강건성, 약한 일반화 문제를 극복하기 위해 데이터 증강 기술이 지속적으로 주목받고 있습니다. CutOut [35], MixUp [36], CutMix [37], AugMix [38] 등이 대표적입니다. AugMix는 여러 증강 체인에서 나온 이미지들을 혼합하여 데이터 다양성을 높이는 기법으로, 본 연구는 이를 커리큘럼 기반 훈련 과정에 통합하여 일반화 및 강건성 성능을 향상시킵니다.

## 🛠️ Methodology

본 연구는 커리큘럼 기반 교차 도메인 정보 융합 전략과 훈련 시간 중 연쇄 증강 혼합 모듈을 결합하여, 도메인 이동 및 데이터 손상에 대한 모델의 적응, 일반화, 강건성 성능을 향상시킵니다. 제안하는 방법은 크게 세 가지 핵심 구성 요소로 이루어져 있습니다: 진폭 융합(Amplitude Fusion), 커리큘럼 학습(Curriculum Learning), 연쇄 증강 혼합(Chained Augmentation Mixing).

1. **푸리에 공간에서의 진폭 융합 (Amplitude Fusion in the Fourier Space)**
    * 공간 도메인 디지털 이미지 $x$로부터 푸리에 변환 $F(x)$를 통해 진폭 성분 $A(x)$와 위상 성분 $P(x)$를 추출합니다. 진폭 성분은 도메인 특이 정보를, 위상 성분은 이미지의 시각적 모양을 유지하는 데 중요합니다.
    * 소스 도메인(SD)의 진폭 성분 $A_{S}$를 타겟 도메인(TD)의 진폭 성분 $A_{T}$와 융합하여 새로운 진폭 성분 $A_{F}^{S}$를 생성합니다. 융합은 진폭 스펙트럼의 중앙 영역에서 이루어집니다:
        $$A_{F}^{S}(u,v) = \begin{cases} (1-\alpha)A_{S}(u,v) + \alpha A_{T}(u,v), & \text{if } u,v \in [-\hat{\beta}, \hat{\beta}] \\ A_{S}(u,v), & \text{otherwise} \end{cases}$$
        여기서 $\hat{\beta} = ||\beta H||$ 또는 $\hat{\beta} = ||\beta W||$로, $H, W$는 이미지의 높이와 너비입니다. $\alpha \in [0,1]$는 혼합 비율을, $\beta \in [0,1]$는 융합되는 중앙 영역의 크기를 조절합니다.
    * 역 푸리에 변환 $F^{-1}$을 사용하여 재구성된 공간 도메인 SD 이미지 $x_{F}^{S} = F^{-1}(A_{F}^{S}, P_{S})$를 얻습니다.

2. **연쇄 증강 혼합 (Chained Augmentation Mixing)**
    * 훈련 데이터의 다양성을 높여 일반화 및 강건성 성능을 향상시키기 위해 적용됩니다.
    * 원본 이미지 $x$에 여러 증강 체인(ACs)을 적용하고, 이를 선형적으로 혼합하여 증강된 이미지 $x_{\text{Aug}}$를 생성합니다:
        $$x_{\text{Aug}} = m \cdot x + (1-m) \cdot \sum_{i=1}^{\text{AC}} (w_{i} \cdot H_{i}(x))$$
        여기서 $m$은 Beta 분포 $B(\cdot)$에서 샘플링된 무작위 볼록 계수이며, $w_{i}$는 Dirichlet 분포 $D(\cdot)$에서 샘플링된 무작위 볼록 계수로 증강 체인의 혼합 가중치를 제어합니다. $H_{i}$는 $i$번째 증강 체인에 적용된 순차적 증강 연산입니다. 각 증강 체인은 최대 세 개의 기본 증강 연산으로 구성됩니다.

3. **Curri-AFDA: 커리큘럼 기반 증강 푸리에 도메인 적응**
    * 훈련 기간 동안 타겟 도메인(TD)의 진폭 성분을 소스 도메인(SD)으로 점진적으로 전송하는 커리큘럼 전략을 사용합니다. 이는 모델이 쉬운 정보부터 시작하여 점차 어려운 도메인 변화 특징을 학습하도록 돕습니다.
    * 진폭 스케일링 계수 $\beta$를 0부터 최적 값 $\beta_{\text{opt}}$까지 점진적으로 증가시킵니다. 이를 위해 선형 또는 지수 스케줄러 함수를 사용합니다. 선형 스케줄러의 예는 다음과 같습니다:
        $$\beta_{c} = \begin{cases} \frac{e}{E \cdot r_{e}} \cdot \beta_{\text{opt}}, & \text{if } e \le E \cdot r_{e} \\ \beta_{\text{opt}}, & \text{otherwise} \end{cases}$$
        여기서 $E$는 총 훈련 에포크 수, $e$는 현재 에포크, $r_{e}$는 커리큘럼 단계의 길이를 제어하는 에포크 비율입니다.
    * 이러한 방식으로 재구성된 훈련 샘플 $x_{CF}^{S} = F^{-1}(A_{F}^{S(\beta_{c})}, P_{S})$는 연쇄 증강 혼합 모듈에 주입되어 최종 훈련 이미지 $x_{CAF}^{S}$를 생성합니다:
        $$x_{CAF}^{S} = m \cdot x_{CF}^{S} + (1-m) \cdot \sum_{i=1}^{\text{AC}} (w_{i} \cdot H_{i}(x_{CF}^{S}))$$
    * 푸리에 공간에서 저주파 진폭 성분의 변화는 원본 이미지의 핵심 의미론을 변경하지 않습니다. 연쇄 증강 혼합 중 기하학적 변화가 발생할 경우, 이미지와 마스크에 동일한 변환이 적용되어 모양 편차에 맞춰집니다.

## 📊 Results

* **망막 분할 (Retina Segmentation)**:
  * 타겟 도메인(TD)에서 Curri-AFDA는 UNet [63] 백본에서 다른 방법 대비 0.96%, Swin-UNet [64] 백본에서 5.30%의 DSC(Dice Similarity Coefficient) 개선을 달성하며 뛰어난 적응 성능을 보였습니다.
  * 미등록 외부 도메인(ED-1, ED-2)에서도 대부분의 경우 최고 성능을 달성하며 일반화 및 강건성 우위를 입증했습니다. 세 가지 테스트 데이터셋 전체 평균 DSC는 UNet 및 Swin-UNet 백본에서 각각 1.78%, 2.68% 향상되었습니다.
  * 정성적 결과(Fig. 4(a))는 Curri-AFDA가 더 정확한 분할 마스크와 경계를 생성함을 보여줍니다.
* **핵 분할 (Nuclei Segmentation)**:
  * 작고 불확실한 위치의 인스턴스가 많은 더 어려운 핵 분할 작업에서도 Curri-AFDA가 다른 방법들을 능가하는 결과를 보였습니다.
  * UNet [63] 및 Swin-UNet [64] 백본에서 테스트 데이터에 대한 전체 DSC는 각각 8.50%, 4.29% 증가했습니다.
  * 정성적 결과(Fig. 4(b))는 Curri-AFDA가 더 많은 핵을 정확하게 분할함을 나타냅니다.
* **강건성 분석 (Robustness Analysis)**:
  * 15가지 유형의 손상(노이즈, 블러, 날씨, 디지털 그룹)과 5단계의 심각도 수준으로 합성된 망막 데이터셋에서 강건성을 평가했습니다.
  * Curri-AFDA는 대부분의 손상 유형에서 다른 방법들보다 높은 성능을 보였으며, 전체 평균 DSC는 다른 방법 중 최고 결과보다 3.39% 상회했습니다 (Table II).
  * 심각도 수준이 증가함에 따라 다른 방법들의 성능이 크게 저하되는 반면, Curri-AFDA는 더 높고 안정적인 성능을 유지했습니다 (Fig. 5).
* **의료 영상 분류에 대한 유효성 (Efficacy for Medical Image Classification)**:
  * 피부 병변 데이터셋(Nevus, Benign Keratosis, Melanoma 3가지 유형, 4개 의료 도메인)을 사용하여 이미지 분류에서도 Curri-AFDA를 평가했습니다.
  * Swin-Transformer [65] 백본을 사용하여 F1 점수를 측정했을 때, Curri-AFDA는 전반적으로 최고의 F1 점수를 기록하여 분할 외에 분류 작업에서도 유효함을 입증했습니다 (Table V).

## 🧠 Insights & Discussion

* 제안된 커리큘럼 기반 진폭 융합 및 연쇄 증강 혼합 프레임워크는 모델이 더 넓은 특징 표현 공간을 탐색하고 학습하도록 돕습니다. 이는 모델이 도메인 간의 차이를 줄이고, 새로운 데이터 분포에 더 잘 적응하도록 만듭니다.
* 다중 도메인에 대한 광범위한 실험 및 평가 결과는 Curri-AFDA가 CNN 기반(UNet) 및 트랜스포머 기반(Swin-UNet) 아키텍처 모두에서 우수한 적응, 일반화 및 강건성 성능을 달성할 수 있는 일반적인 방법임을 시사합니다. 이는 제안된 방법이 특정 모델 아키텍처에 종속되지 않음을 의미합니다.
* 특히, 의료 영상 분석에서 중요하지만 기존 연구에서 거의 탐구되지 않았던 손상에 대한 강건성 성능을 합성 데이터셋으로 평가하였으며, Curri-AFDA가 이 분야에서도 뛰어난 결과를 보였습니다. 이는 실제 의료 환경에서 발생할 수 있는 다양한 데이터 품질 저하에 대한 모델의 신뢰성을 높여줍니다.
* 또한, 본 방법은 분할 외에 의료 영상 분류에도 기여할 수 있음이 입증되어 더 넓은 의료 응용 분야에 적용될 잠재력을 가지고 있습니다. 이는 제안된 프레임워크의 범용성을 강조합니다.
* **제한 사항 및 향후 연구**:
  * 진폭 융합 영역을 조절하는 진폭 스케일링 계수 $\beta$를 업데이트하는 보다 유연하고 자동화된 스케줄링 함수를 설계하는 연구가 필요합니다.
  * 이미지 간 혼합 비율을 제어하는 가중치 계수 $\alpha$도 커리큘럼 전략 설계에 포함되어 모델의 학습 과정을 더욱 최적화할 수 있습니다.
  * 훈련 시간 도메인 적응 외에, 푸리에 기반 교차 도메인 정보 융합 및 연쇄 증강 혼합을 통합하여 테스트 시간 도메인 적응(Test-Time Domain Adaptation)을 탐구할 가치가 있습니다.

## 📌 TL;DR

의료 영상 분할의 도메인 이동 및 데이터 손상 문제를 해결하기 위해, 본 논문은 커리큘럼 기반 증강 푸리에 도메인 적응(Curri-AFDA)을 제안합니다. 이 방법은 푸리에 공간에서 타겟 도메인의 진폭 정보를 소스 도메인으로 점진적으로 전송하는 커리큘럼 학습 전략과, 훈련 데이터 다양성을 높이는 연쇄 증강 혼합 기법을 결합합니다. 망막 및 핵 분할, 그리고 피부 병변 분류 데이터셋에 대한 광범위한 실험을 통해, Curri-AFDA는 기존 방법들보다 우수한 적응, 일반화 및 손상에 대한 강건성 성능을 달성함을 입증했습니다.
