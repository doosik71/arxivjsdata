# Rethinking Semi-Supervised Medical Image Segmentation: A Variance-Reduction Perspective

Chenyu You, Weicheng Dai, Yifei Min, Fenglin Liu, David A. Clifton, S. Kevin Zhou, Lawrence Staib, James S. Duncan

## 🧩 Problem to Solve

의료 영상 분할에서 신뢰할 수 있는 모델을 구축하기 위해서는 모델의 견고성(robustness)과 레이블 효율성(label efficiency)이 중요합니다. 전통적인 지도 학습은 방대한 양의 레이블링된 데이터를 필요로 하지만, 의료 데이터의 레이블링은 시간과 전문성이 많이 소모됩니다. 준지도 학습(Semi-Supervised Learning, SSL)은 이러한 문제를 해결하기 위한 유망한 접근 방식입니다.

특히, 대조 학습(Contrastive Learning, CL)은 유용한 표현(representation)을 학습하는 데 효과적인 것으로 알려져 있습니다. 그러나 픽셀/복셀(pixel/voxel) 수준의 대조 학습은 다음과 같은 실제적인 문제에 직면합니다:

1. **높은 계산 비용**: 모든 픽셀/복셀을 샘플링하는 것은 극도로 시간이 많이 걸리고 계산 비용이 높습니다.
2. **모델 붕괴 (Model Collapse) 및 불안정성**: 불균형한(long-tailed) 의료 데이터에서 무작위 샘플링은 큰 특징 변화를 초래하고, 소수 클래스(minority tail-class) 샘플을 오분류하기 쉽게 만들어 모델 붕괴로 이어질 수 있습니다. 이는 학습의 안정성을 저해합니다.

따라서 이 연구는 준지도 대조 학습 모델 훈련 시 분산 감소(variance reduction)를 개선하기 위해 가장 정보가 풍부한 픽셀/복셀을 샘플링하는 새로운 관점을 제안합니다.

## ✨ Key Contributions

* **ARCO 프레임워크 제안**: 의료 영상 분할을 위한 계층적 그룹 이론(stratified group theory) 기반의 새로운 준지도 대조 학습(CL) 프레임워크인 ARCO를 제안하여 모델 견고성과 레이블 효율성 간의 트레이드오프를 개선합니다.
* **분산 감소 샘플링 기법 도입**: 계층적 그룹 샘플링(Stratified Group, SG)과 계층적 상반 그룹 샘플링(Stratified-Antithetic Group, SAG)이라는 두 가지 실용적인 샘플링 기법을 도입하여, 픽셀/복셀 수준 분할 작업에서 극도로 제한된 레이블 환경에서도 분산 감소의 이점을 입증했습니다.
* **이론적 증명**: 제안된 샘플링 기법(SG 및 SAG)이 편향되지 않으며(unbiasedness), 나이브 샘플링(Naïve Sampling, NS)보다 분산이 작거나 같음을 이론적으로 증명했습니다. 이는 더 견고한 경사도 추정치를 제공하여 학습의 수렴 속도와 안정성을 향상시킵니다.
* **광범위한 실험 검증**: 5개의 2D/3D 의료 영상 데이터셋과 3개의 일반 의미론적 분할(semantic segmentation) 데이터셋을 포함한 총 8개의 벤치마크에서 다양한 레이블 비율(1%, 5%, 10%)에 대해 제안된 방법이 최신 준지도 방법들보다 지속적으로 우수한 성능(Dice 점수에서 최대 11.08% 절대 개선)을 보임을 실험적으로 검증했습니다.
* **기존 CL 프레임워크와의 통합 가능성**: SG/SAG 샘플링 기법을 기존의 다양한 픽셀 수준 대조 학습 프레임워크에 통합하여 성능 향상을 이끌어낼 수 있음을 보여주었습니다.

## 📎 Related Works

* **의료 영상 분할 (Medical Image Segmentation)**: Fully Convolutional Networks (FCN), UNet 등 딥러닝 기반의 조밀 분류(dense classification) 문제로 접근합니다. 특징 표현 개선을 위한 네트워크 설계(예: Dilated/Atrous/Deformable Convolution, Pyramid Pooling, Attention, Vision Transformer) 및 최적화 전략(예: 클래스 불균형 해결을 위한 손실 함수, 불확실한 픽셀 정제) 연구가 있습니다.
* **준지도 학습 (Semi-Supervised Learning, SSL)**: 레이블링된 데이터와 레이블 없는 데이터를 함께 사용하여 모델을 훈련합니다.
  * **일관성 정규화 (Consistency Regularization)**: 다른 섭동(perturbation)에 대한 출력 일관성을 강제합니다 (e.g., Pi-model, Mean-Teacher).
  * **자기 훈련 (Self-training)**: 모델의 예측을 사용하여 노이즈가 있는 의사 레이블(pseudo-labels)을 생성하고 성능을 향상시킵니다 (e.g., Pseudo-labeling, Model Uncertainty, Noisy Student).
  * 이러한 방법들은 클래스 불균형으로 인한 모델 붕괴를 방지하는 데 실패하는 경우가 많습니다.
* **대조 자기 지도 학습 (Contrastive Self-Supervised Learning, CL)**: 유사한 인스턴스의 표현은 가깝게, 비유사한 인스턴스의 표현은 멀리 떨어뜨려 학습합니다. 이미지 분류 같은 단순 작업에는 전역 표현(global representation)으로 충분하지만, 조밀한 예측 작업에서는 미세한 공간 구조를 포착하기 위한 조밀 대조 학습(dense contrastive learning)이 필요합니다. 최근 연구(MONA, ACTION)는 클래스 불균형을 완화하지만 안정성이 부족합니다. 본 연구는 모델 견고성과 레이블 효율성 간의 연결고리를 분산 감소 관점에서 탐구합니다.

## 🛠️ Methodology

제안하는 ARCO 프레임워크는 MONA 파이프라인($[17]$)을 단순화하여 픽셀 수준 대조 학습 프레임워크에 분산 감소 샘플링 기법을 적용하는 데 초점을 맞춥니다. 훈련은 두 단계로 구성됩니다:

1. **관계형 준지도 사전 학습 (Relational Semi-Supervised Pre-training)**:
    * **입력**: 레이블 없는 이미지($x$). 학생 네트워크($F_s$)와 EMA(Exponential Moving Average) 교사 네트워크($F_t$)를 사용합니다.
    * **뷰 생성**: 입력 이미지를 두 개의 `증강된 뷰`($x_1, x_2$)와 `마이닝된 뷰`($x_3$)로 생성합니다.
    * **특징 및 임베딩 추출**: 인코더(E)와 디코더(D)로 구성된 네트워크 $F$를 통해 글로벌 특징 $h$와 로컬 특징 $f$를 얻습니다. 이들은 다시 비선형 프로젝터와 예측기를 거쳐 글로벌 및 로컬 임베딩 $v_g$, $v_l$ 및 $w$로 변환됩니다.
    * **손실 함수**:
        * **비지도 인스턴스 판별 손실 ($L_{inst}$)**: 학생 네트워크의 임베딩과 교사 네트워크의 임베딩 간의 Kullback-Leibler 발산(KL divergence)을 사용하여 관계적 유사성을 강제합니다. 이는 모델 붕괴 문제를 완화합니다.
        * **지도 손실 ($L_{sup}$)**: 레이블링된 데이터에 대해 Dice 손실과 교차 엔트로피 손실의 조합을 사용합니다.
        * **총 손실**: $L = L_{global\_inst} + L_{local\_inst} + L_{sup}$.

2. **해부학적 대조 미세 조정 (Anatomical Contrastive Fine-tuning, ACF)**:
    * 사전 학습된 네트워크 가중치를 초기화에 사용합니다.
    * 두 가지 핵심 원칙을 따릅니다: `꼬리 부분 집중(tailness)`과 `다양성(diversity)`.
    * **꼬리 부분 집중 (Tailness)**:
        * **픽셀 수준 대조 손실 ($L_{contrast}$)**: 표현 헤드($\psi_r$)를 사용하여 고차원 조밀 표현을 생성합니다. 특정 클래스 $c$에 대한 쿼리 $r_q$는 해당 클래스의 평균 표현($r_{c,+k}$)에 가깝게 만들고, 다른 클래스의 음성 키($r_{-k}$)와는 멀리 떨어뜨립니다.
        * 수식:
        $$ L_{contrast} = \sum_{c \in C} \sum_{r_q \sim R_c^q} -\log \frac{\exp(r_q \cdot r_{c,+k}/\tau)}{\exp(r_q \cdot r_{c,+k}/\tau) + \sum_{r_{-k} \sim R_c^k} \exp(r_q \cdot r_{-k}/\tau)} $$
        여기서 $R_c^q$는 클래스 $c$의 모든 표현을 포함하는 쿼리 세트, $R_c^k$는 클래스 $c$가 아닌 모든 표현을 포함하는 음성 키 세트, $r_{c,+k}$는 클래스 $c$의 평균 표현입니다.
    * **다양성 (Diversity)**:
        * **준지도 최근접 이웃 손실 ($L_{nn}$)**: 선입선출(FIFO) 메모리 뱅크($[13]$)를 사용하여 K-최근접 이웃을 검색하고 코사인 유사성을 최대화하여 인스턴스 간 관계를 활용합니다.
    * **총 미세 조정 손실**: $L_{sup} + \lambda_1 L_{contrast} + \lambda_2 L_{unsup} + \lambda_3 L_{nn}$.

3. **분산 감소 샘플링 (Variance Reduction Sampling - SG & SAG)**:
    * 기존 나이브 샘플링(NS)의 높은 분산 문제를 해결하기 위해 도입됩니다.
    * **계층적 그룹 샘플링 (SG)**:
        * 이미지를 클래스에 따라 동일한 크기의 그리드(grids)로 나눕니다. 각 그리드는 $M$개의 서로 다른 픽셀 그룹 $P_m$을 형성합니다.
        * 각 그룹 $P_m$에서 해당 클래스 분포에 비례하여 픽셀 서브셋 $D_m$을 샘플링합니다.
        * 이 방법은 나이브 샘플링(NS)보다 분산이 작거나 같음을 이론적으로 보장합니다 (Theorem 3.2).
    * **계층적 상반 그룹 샘플링 (SAG)**:
        * SG에 기반하여, 각 그룹 $P_m$에서 $n_m/2$개의 픽셀을 샘플링한 다음, 나머지 $n_m/2$개의 픽셀을 첫 번째 절반 픽셀의 대칭적인 반사 픽셀로 결정론적으로 선택하여 대칭성을 강제합니다.
        * SAG의 분산은 SG의 분산의 2배를 넘지 않음을 보장합니다 (Lemma 3.1).
    * **훈련 수렴**: 분산이 감소된 경사도 추정기($\sigma_g$ 감소)는 SGD(Stochastic Gradient Descent)의 수렴을 가속화하고 안정성을 높입니다 (Proposition 1).

## 📊 Results

* **정량적 결과**:
  * **우수한 성능**: ACDC, LiTS, MMWHS(2D), LA, MP-MRI(3D) 등 5개 의료 영상 데이터셋과 Cityscapes, Pascal VOC, SUN RGB-D 등 3개 일반 의미론적 분할 데이터셋에서 1%, 5%, 10% 등 다양한 레이블 비율 설정에서 기존 SOTA 준지도 방법론들을 지속적으로 능가합니다.
  * **Dice 점수 개선**: 예를 들어, ACDC에서 ARCO-SG는 1% 레이블 비율에서 MONA 대비 평균 Dice에서 2.9%p 향상, MMWHS에서는 5.1%p 향상을 달성했습니다.
  * **레이블 효율성**: 5% 레이블 비율로 훈련된 ARCO 모델은 모든 비교 준지도 방법을 능가하며, 1%와 같은 극히 제한된 레이블 환경에서도 MONA보다 0.3%~4.1%p의 상대적인 Dice 개선을 보였습니다.
* **정성적 결과**:
  * ACDC, LiTS 등 데이터셋에서 ARCO는 해부학적 영역과 경계에서 훨씬 더 정확하고 선명한 예측을 제공합니다.
  * 특히, 작은 병변과 같은 모호한 꼬리 클래스 샘플에 대해서도 일관되게 선명하고 정확한 객체 경계를 생성합니다.
* **어블레이션 연구 (Ablation Studies)**:
  * **손실 구성 요소의 중요성**: `꼬리 부분 집중`을 위한 $L_{contrast}$와 `다양성`을 위한 $L_{nn}$을 포함한 모든 손실 함수 구성 요소들이 성능 향상에 필수적임을 확인했습니다.
  * **샘플링 방법의 중요성**: SG 및 SAG 샘플링이 나이브 샘플링(NS)에 비해 일관되게 우수한 모델 견고성 향상을 가져옴을 입증했습니다.
  * **안정성 분석**: 훈련 궤적 시각화 결과(Fig. 5) SG 샘플링이 더 빠른 손실 감소와 작은 오차 막대를 보여주어, 수렴 속도와 훈련 안정성 모두에서 다른 방법들을 능가함을 확인했습니다.

## 🧠 Insights & Discussion

* ARCO는 분산 감소 샘플링 기법을 도입함으로써 기존 자기 지도 학습 목표의 한계를 정량화하고, 극히 제한된 레이블 환경에서 의료 영상 분할과 같은 안전에 민감한(safety-critical) 작업의 성능을 크게 향상시킵니다.
* 제안된 계층적 그룹 이론 기반 샘플링(SG, SAG)은 픽셀/복셀 수준 샘플링을 포함하는 광범위한 시나리오에 적용될 수 있는 보편적인 분산 감소 솔루션입니다. 이는 더 정확한 경사도 추정치를 제공하여 더 빠르고 안정적인 모델 훈련을 가능하게 합니다.
* 이 연구는 기존 대조 학습 프레임워크의 불안정성(붕괴 문제)을 해결하고, 모델 견고성 및 레이블 효율성을 향상시키는 실용적인 수단을 제공합니다. 이는 의료 AI 시스템의 신뢰성을 높이는 중요한 단계입니다.
* **광범위한 영향**: 본 연구의 샘플링 기술은 3D 렌더링, 증강/가상 현실, 궤적 예측, 자율 주행 등 다양한 분야에도 적용될 잠재력을 가집니다.
* **한계점**: 연구는 공정성(fairness)이나 개인 정보 보호(privacy)와 같은 의료 영상 분석 영역의 윤리적/사회적 측면은 다루지 않았으며, 이는 향후 연구 방향으로 제안됩니다.

## 📌 TL;DR

**문제**: 의료 영상 분할에서 레이블 부족과 데이터 불균형으로 인해 준지도 대조 학습 모델이 높은 계산 비용, 불안정한 훈련, 모델 붕괴와 같은 문제에 직면합니다.
**방법**: 본 논문은 **ARCO**라는 새로운 준지도 대조 학습 프레임워크를 제안합니다. ARCO는 **계층적 그룹(SG)** 및 **계층적 상반 그룹(SAG)** 샘플링이라는 **분산 감소 기법**을 도입하여 픽셀/복셀 수준 샘플링의 높은 분산을 효과적으로 줄입니다. 이 방법은 이미지를 클래스별 그리드로 분할하고, 각 그룹 내에서 의미론적으로 유사한 픽셀을 비례적으로 샘플링하여 학습의 안정성과 효율성을 높입니다.
**결과**: ARCO는 8개 벤치마크 데이터셋(5개 의료, 3개 의미론적)에서 다양한 레이블 비율(1%, 5%, 10%)에 걸쳐 최신 준지도 방법들보다 지속적으로 우수한 성능을 보였습니다(Dice 점수 최대 11.08% 향상). 이론적으로도 SG/SAG가 나이브 샘플링 대비 분산 감소와 빠른 수렴을 제공함이 증명되어 모델 견고성과 레이블 효율성이 크게 향상됨을 보여주었습니다.
