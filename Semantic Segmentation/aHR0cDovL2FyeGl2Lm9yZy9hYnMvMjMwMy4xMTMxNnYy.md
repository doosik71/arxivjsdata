# Generative Semantic Segmentation
Jiaqi Chen, Jiachen Lu, Xiatian Zhu, Li Zhang

## Problem to Solve
기존의 시맨틱 분할(semantic segmentation) 방법론은 주로 각 픽셀에 대한 레이블을 예측하는 **판별 학습(discriminative learning)** 패러다임을 따릅니다. 이는 조건부 확률의 로그-우도(log-likelihood)를 최적화하여 픽셀별 분류에 집중합니다. 이러한 방식은 효율적이지만, 대규모 사전 학습된 생성 모델의 강력한 표현 학습 능력을 직접 활용하기 어렵다는 한계가 있습니다. 특히, 마스크 데이터의 특성(K-채널)과 이미지 데이터(RGB)의 형식 차이로 인해 일반적인 이미지 생성 프레임워크를 시맨틱 분할에 적용하기 어렵고, 기존의 생성 모델 기반 시도는 비효율적이거나 특정 데이터셋에 대한 재학습이 필요했습니다.

## Key Contributions
*   시맨틱 분할을 **이미지 조건부 마스크 생성 문제(image-conditioned mask generation problem)**로 재정의하는 `Generative Semantic Segmentation (GSS)` 접근 방식을 제안합니다. 이는 기존의 픽셀별 판별 학습 패러다임과의 **개념적 전환**을 의미합니다.
*   시맨틱 분할 마스크를 RGB 이미지 형태로 표현하는 `maskige`라는 새로운 개념을 도입합니다. 이를 통해 마스크 데이터를 범용적인 이미지 생성 모델(예: DALL·E의 VQVAE)이 이해할 수 있는 형식으로 변환하여, **사전 학습된 대규모 생성 모델의 지식을 효율적으로 활용**할 수 있도록 합니다.
*   `maskige` 개념과 효율적인 2단계 최적화 알고리즘을 기반으로 GSS 모델을 구현합니다. 이 모델은 기존 판별 모델과 **경쟁적인 성능**을 달성하며, 특히 **더 도전적인 교차 도메인(cross-domain) 설정에서는 새로운 최첨단(State-of-the-Art) 성능**을 기록합니다.

## Methodology
GSS는 시맨틱 분할을 이미지 조건부 마스크 생성 문제로 공식화하며, 이를 위해 `maskige` 개념과 효율적인 2단계 최적화 과정을 도입합니다.

1.  **잠재 사후 분포 학습 (`Latent Posterior Learning`)**:
    *   **목표**: 시맨틱 분할 마스크 `c`를 나타내는 특수 이미지인 `maskige x^(c)`가 주어졌을 때, 잠재 변수 `z`의 사후 분포 `q_φ(z|c)`를 학습하여 `maskige`를 재구성합니다. (`$E_{q_φ(z|c)} [\log p_θ(c|z)]$` 항 최적화).
    *   **`maskige` 변환**: K개 클래스를 가진 원본 마스크 `c`를 각 클래스에 특정 색상을 할당하여 `$H \times W \times 3$` 형태의 RGB 이미지인 `maskige` `x^(c)`로 변환하는 함수 `X`를 사용합니다. `X^(-1)`는 그 역변환입니다.
    *   **효율적인 학습**: `maskige`는 일반 이미지와 유사하므로, DALL·E와 같은 대규모 이미지 데이터셋에 **사전 학습된 VQVAE 모델의 인코더(`E_φ`)와 디코더(`D_θ`)를 고정(frozen)**하고 활용합니다. 이를 통해 가장 비용이 많이 드는 잠재 표현 학습 단계를 건너뛸 수 있습니다.
    *   **최적화**: VQVAE 모델의 파라미터를 고정한 채, `X`와 `X^(-1)`라는 경량 변환 모듈만 최적화합니다.
        *   `GSS-FF` (Free of Training): `X`는 `maximal distance assumption`에 따라 수동으로 설계하고, `X^(-1)`는 선형 함수로 정의하여 `least squares` 방식으로 학습 없이 명시적 해를 구합니다.
        *   `GSS-FT` (Training `X^(-1)` Only): `X`는 선형으로 고정하고, `X^(-1)`는 3계층 CNN 또는 `ShiftedWindow Transformer`와 같은 비선형 함수로 구현하여 **`X^(-1)`만 학습**합니다. 특히 `GSS-FT-W` 변형이 가장 좋은 성능을 보입니다.
    *   **손실 함수**: 마스크 재구성을 위해 MSE 대신 교차 엔트로피 손실을 사용합니다.

2.  **잠재 사전 분포 학습 (`Latent Prior Learning`)**:
    *   **목표**: 첫 번째 단계에서 `φ`와 `θ`가 고정되면, 입력 이미지 `x`가 주어졌을 때 잠재 변수 `z`의 사전 분포 `p_ψ(z|x)`를 학습합니다. (`$D_{KL}(q_φ(z|c), p_ψ(z|x))$` 항 최소화).
    *   **아키텍처**: 이미지 인코더 `I_ψ`를 최적화합니다. `I_ψ`는 `Swin-Large`와 같은 백본과 `Multi-Level Aggregation (MLA)` 모듈로 구성됩니다. `MLA`는 멀티 스케일 정보를 통합하고 메모리 효율성을 높입니다.
    *   **미정의 영역 처리 (`Unlabeled Area Auxiliary`)**: 학습 시 레이블링 되지 않은 픽셀 영역이 있는 경우, 보조 헤드 `p_ξ(c̄|z)`를 도입하여 이러한 미정의 영역에 대한 의사 레이블(pseudo labels)을 예측하고 활용함으로써 모델 성능 저하를 방지합니다.
    *   **손실 함수**: 이산 분포인 잠재 토큰(`z`)의 사전 분포와 사후 분포 간의 정렬을 측정하기 위해 교차 엔트로피 함수를 사용합니다.

3.  **생성적 추론 (`Generative Inference`)**:
    *   학습된 이미지 인코더 `I_ψ`를 사용하여 입력 이미지 `x`로부터 잠재 토큰 `z`를 예측합니다.
    *   예측된 잠재 토큰 `z`를 `maskige` 디코더 `D_θ`에 입력하여 예측된 `maskige` `x^(c)`를 생성합니다.
    *   `x^(c)`에 `X^(-1)` 변환을 적용하여 최종 시맨틱 분할 마스크 `c`를 얻습니다.

## Results
*   **단일 도메인 시맨틱 분할**: Cityscapes 및 ADE20K 벤치마크에서 기존의 강력한 판별 모델(예: `Maskformer`, `SETR`) 및 다른 생성 모델(`UViM`)과 **경쟁적인 성능**을 달성했습니다. 특히, `GSS-FT-W`는 높은 정확도를 보여주었습니다.
*   **교차 도메인 시맨틱 분할**: `MSeg` 데이터셋에서 `HRNet-W48` 및 `Swin-Large` 백본 모두에서 **모든 비교 모델을 능가하여 새로운 최첨단(State-of-the-Art) 성능**을 기록했습니다. 이는 GSS의 생성 학습 방식이 기존 판별 학습 방식보다 **더욱 강력한 도메인 일반화 능력**을 가짐을 시사합니다.
*   **효율성**: `maskige` 메커니즘을 통해 사전 학습된 VQVAE를 활용함으로써, `UViM`과 같은 다른 생성 모델에 비해 **매우 높은 학습 효율성**을 입증했습니다. 예를 들어, `GSS-FT-W`의 첫 번째 단계 학습은 `UViM`보다 훨씬 적은 GPU 시간을 소비합니다.
*   **`maskige` 재구성 품질**: `maskige` 재구성 단계에서 `UViM`이나 `VQGAN`보다 **더욱 정확하고 깨끗한 엣지**를 가진 거의 오류 없는 재구성을 생성하는 것으로 나타났습니다.
*   **`maskige`의 도메인 일반성**: `MSeg` 데이터셋에서 학습된 `maskige`를 Cityscapes 데이터셋에 전이했을 때 성능 저하가 미미하여(`1%` mIoU 하락), `maskige`가 **본질적으로 도메인에 구애받지 않는(domain-generic) 특성**을 가짐을 확인했습니다.
*   **정성적 평가**: ADE20K에서 가구와 같은 미세한 객체의 분할, Cityscapes에서 멀리 있는 보행자나 얇은 기둥의 정확한 분할 등 **높은 품질의 엣지 분할** 결과를 보여주었습니다. 교차 도메인 테스트셋에서도 강력한 일반화 능력을 시각적으로 입증했습니다.