# Anomaly Detection-Inspired Few-Shot Medical Image Segmentation Through Self-Supervision With Supervoxels

Stine Hansen, Srishti Gautam, Robert Jenssen, Michael Kampffmeyer

## 🧩 Problem to Solve

의료 영상 분석에서 심층 학습 기반의 의미론적 분할(semantic segmentation)은 많은 양의 레이블링된 데이터가 필요하지만, 의료 분야에서는 이러한 데이터 확보가 매우 어렵습니다. 소량 학습(Few-shot learning)은 적은 수의 레이블된 샘플만으로 새로운 클래스에 적응하는 능력을 제공하지만, 기존 모델은 과적합을 피하기 위해 다수의 레이블된 훈련 클래스를 요구하며, 이 또한 의료 분야에서는 드뭅니다. 특히, 기존의 프로토타입 기반 소량 분할(FSS) 모델은 의미론적 클래스의 프로토타입 표현에 의존하여 지역 정보 손실을 초래하고, 이는 크고 이질적인 배경 클래스에 대해 특히 문제가 됩니다. 배경 클래스의 복잡성을 모델링하기 위해 추가 프로토타입을 사용하는 기존 접근 방식은 제한된 수의 슬라이스 기반으로는 불충분합니다.

## ✨ Key Contributions

* **이상 탐지 기반 소량 분할 접근법 제안:** 기존 최첨단(SOTA) 방법을 능가하며, 많은 수의 프로토타입을 학습할 필요성을 제거합니다. 단일 전경 프로토타입만으로 분할을 수행하여 이질적인 배경 모델링의 어려움을 회피합니다.
* **3D 구조 정보 활용을 위한 새로운 자기 지도 학습(Self-supervision) 태스크 도입:** 의료 영상의 3D 구조를 활용하는 슈퍼복셀(supervoxels) 기반의 자기 지도 학습 방법을 제안하여, 2D 설정 내에서 3D 정보를 활용하고, 나아가 3D CNN 훈련을 통한 직접적인 볼륨 분할의 가능성을 제시합니다.
* **새로운 평가 프로토콜 (EP2) 도입:** 질의 이미지(query image)에 대한 약한 레이블(weak labels)에 의존하지 않는 새로운 평가 프로토콜을 제시하여, 실제 시나리오에 더 적용 가능하고 견고한 성능 평가를 가능하게 합니다.

## 📎 Related Works

* **소량 메타 학습(Few-Shot Meta-learning):** 모델이 새로운, 보지 못한 태스크에 빠르게 적응하도록 훈련 태스크 집합에 대해 최적화합니다. 특히 단순성과 효율성으로 주목받는 거리 학습(metric-learning) 기반 접근법 (Vinyals et al., 2016; Snell et al., 2017)을 활용합니다.
* **소량 의미론적 분할(Few-Shot Semantic Segmentation):** 소량 이미지 분류를 픽셀 수준 분류로 확장합니다. PANet (Wang et al., 2019) 및 그 후속작인 PPNet (Liu et al., 2020b), 그리고 의료 분야에 적용된 ALPNet (Ouyang et al., 2020)과 같이 프로토타입과 질의 특징 간의 코사인 유사도를 직접 사용하는 모델들에 기반을 둡니다.
* **자기 지도 학습(Self-Supervised Learning, SSL):** 대규모 레이블된 데이터셋이 없을 때, 데이터 자체에서 암묵적으로 레이블을 정의하는 보조 태스크를 훈련하여 표현을 학습합니다. Ouyang et al. (2020)의 슈퍼픽셀 기반 자기 지도 학습 기법을 확장합니다.
* **슈퍼복셀 분할(Supervoxel Segmentation):** 이미지 내에서 유사한 특성을 공유하는 복셀/픽셀들의 그룹화입니다. 이미지의 구조 경계를 따르는 자연스러운 하위 영역을 제공하며, 본 연구에서는 Ouyang et al. (2020)에서 사용된 2D 슈퍼픽셀 알고리즘의 3D 확장을 활용합니다.

## 🛠️ Methodology

본 연구에서는 **이상 탐지 기반 소량 분할 네트워크(ADNet)**를 제안합니다.

1. **특징 추출:** 지원(support) 및 질의(query) 이미지를 공유 특징 인코더 $f_{\theta}$를 통해 깊은 특징 맵 $F_s$와 $F_q$로 임베딩합니다.
2. **전경 프로토타입 계산:** 배경 클래스를 명시적으로 모델링하는 대신, 단일 전경 프로토타입 $p$만을 고려합니다. 지원 특징 맵 $F_s$를 마스크 크기에 맞게 조절한 후, 전경 마스크 $y_{fg}$를 사용하여 마스크 평균 풀링(Masked Average Pooling, MAP)을 수행하여 프로토타입을 계산합니다:
    $$p = \frac{\sum_{x,y} F_s(x,y) \circ y_{fg}(x,y)}{\sum_{x,y} y_{fg}(x,y)}$$
    여기서 $\circ$는 아다마르 곱(Hadamard product)을 나타냅니다.
3. **이상 점수 계산:** 각 질의 특징 벡터 $F_q(x,y)$와 전경 프로토타입 $p$ 사이의 (음수) 코사인 유사도를 계산하여 이상 점수 $S(x,y)$를 얻습니다:
    $$S(x,y) = -\alpha \frac{F_q(x,y) \cdot p}{\|F_q(x,y)\| \|p\|}$$
    여기서 $\alpha=20$은 스케일링 인자입니다.
4. **분할:** 학습된 임계값 $T$를 사용하여 이상 점수를 소프트 임계화(soft thresholding)하여 예측된 전경 마스크 $\hat{y}_{q}^{fg}$를 얻습니다:
    $$\hat{y}_{q}^{fg}(x,y) = 1 - \sigma(S(x,y) - T)$$
    여기서 $\sigma(\cdot)$는 시그모이드 함수입니다. 예측된 배경 마스크는 $\hat{y}_{q}^{bg} = 1 - \hat{y}_{q}^{fg}$입니다.
5. **손실 함수:** 전체 손실 함수 $L$은 세 가지 구성 요소로 이루어집니다:
    * **분할 손실($L_S$):** 예측된 마스크와 실제 마스크 사이의 이진 교차 엔트로피 손실입니다.
    * **임계값 손실($L_T$):** 학습된 임계값 $T$를 최소화하여 전경 클래스의 압축된 임베딩을 장려합니다 ($L_T = T/\alpha$).
    * **프로토타입 정렬 정규화 손실($L_{PAR}$):** 지원과 질의의 역할을 바꾸어 예측된 질의 마스크를 사용하여 지원 이미지를 분할하는 프로토타입을 계산하고 그에 대한 분할 손실을 추가합니다.
    $$L = L_S + L_T + L_{PAR}$$
6. **슈퍼복셀 기반 자기 지도 학습:** 훈련 단계에서는 레이블 없는 이미지 볼륨과 그 슈퍼복셀 분할을 기반으로 에피소드를 구성합니다. 무작위 슈퍼복셀 하나를 전경 클래스로 샘플링하고, 해당 슈퍼복셀을 포함하는 두 개의 2D 슬라이스를 지원 및 질의 이미지로 사용합니다. 이 과정에서 3D 슈퍼복셀을 활용하여 기존 2D 슈퍼픽셀 방식보다 더 많은 3D 구조 정보를 사용합니다. 이방성 복셀 해상도를 고려하여 z-방향 거리에 가중치를 부여합니다.

## 📊 Results

* **EP1 (약한 레이블 사용) 평가:** 제안된 vSSL-ADNet은 심장 MRI 및 복부 MRI 데이터셋 모두에서 기존 최첨단 모델(pSSL-ALPNet)과 유사한 성능을 보였습니다(심장 MRI 75.76%, 복부 MRI 78.82%). 배경 모델링에 적은 수의 프로토타입만 사용하는 모델(PANet, PPNet)은 성능이 좋지 않았습니다.
* **EP2 (약한 레이블 미사용) 평가:** 보다 현실적인 시나리오인 EP2에서 vSSL-ADNet은 기존 최첨단 모델을 **크게 능가**했습니다. 특히 복부 데이터에서 pSSL-ALPNet보다 20%p 이상 개선된 평균 Dice 점수 72.41%를 달성했습니다. 심장 데이터에서도 69.62%로 개선을 보였습니다. 이는 배경 클래스가 훨씬 크고 다양할 때 제안 모델이 덜 영향을 받는다는 것을 의미합니다.
* **정성적 비교:** 제안된 방법은 과분할(over-segmentation) 경향이 적은 것을 확인했습니다 (Fig. 5, Fig. 6).
* **학습된 임계값 분석:** 학습된 임계값은 실제 테스트 데이터의 이상적인 임계값과 근접하여 모델의 정확성을 보여주었습니다.
* **손실 함수 구성 요소 분석:** $L_T$ (임계값 최소화 손실)와 $L_{PAR}$ (프로토타입 정렬 정규화 손실) 모두 Dice 점수를 개선하며, 특히 $L_T$는 과분할을 줄이는 데 기여했습니다 (Fig. 8).
* **슈퍼복셀 크기 민감도:** 슈퍼복셀 크기를 제어하는 매개변수 $\rho$에 대해 모델은 비교적 견고한 성능을 보였습니다 ($ \rho=1000 \sim 2000 $).
* **vSSL vs pSSL:** 슈퍼복셀 기반 자기 지도 학습(vSSL)이 슈퍼픽셀 기반(pSSL)보다 전반적으로 더 좋거나 유사한 결과를 가져왔습니다. ADNet의 경우 두 데이터셋 모두에서 vSSL 사용 시 Dice 점수가 유의미하게 개선되었습니다. 특히 복부 데이터셋(슬라이스 수가 많음)에서 개선이 두드러졌습니다.
* **3D 볼륨 분할 확장:** 3D ResNeXt-101 백본을 사용한 3D CNN 기반의 단일 단계 볼륨 분할 가능성을 탐색했습니다. 심장 데이터셋에서는 2D CNN과 유사한 성능을 보였으나, 복부 데이터셋에서는 3D 구조 활용에 더 큰 잠재력을 보였습니다. 특히 왼쪽 신장과 비장 같은 경계가 약한 클래스에서 3D CNN이 더 나은 분리를 제공했습니다 (Fig. 10).

## 🧠 Insights & Discussion

* **주요 통찰:** 제안된 이상 탐지 기반 접근 방식은 전경 클래스가 비교적 동질적이라는 가정을 통해, 크고 이질적인 배경 클래스를 명시적으로 모델링할 필요성을 제거합니다. 이는 프로토타입 기반 소량 의료 영상 분할의 주요 과제를 해결합니다. 특히 약한 레이블이 없는 현실적인 시나리오에서 모델의 견고성과 성능을 크게 향상시킵니다.
* **한계점:**
  * **전경 클래스 동질성 가정:** 만약 전경 클래스가 여러 개의 뚜렷한 영역으로 구성되어 동질적이지 않다면(예: 좌심실 혈액과 좌심실 심근을 하나의 전경 클래스로 결합하는 경우), 단일 프로토타입만으로는 불충분할 수 있습니다.
  * **슈퍼복셀 의사-레이블의 노이즈:** 슈퍼복셀 기반 자기 지도 학습은 클래스 간 경계가 약할 경우 서로 다른 클래스가 동일한 슈퍼복셀에 병합될 위험이 있습니다. 이는 훈련 중 네트워크가 이 클래스들을 동일한 클러스터로 임베딩하게 만들어 추론 시 분리가 어려워지는 결과를 초래할 수 있습니다(예: 복부 데이터셋의 왼쪽 신장과 비장).
* **향후 연구 방향:**
  * 단일 프로토타입의 한계를 극복하기 위해 PPNet처럼 여러 전경 프로토타입을 클러스터링하고 결과를 병합하는 방법을 탐색할 수 있습니다.
  * 슈퍼복셀 의사-레이블의 약하고 노이즈가 많은 특성을 고려하는 방법을 연구하여 추론 시 클래스 간 혼동을 줄이는 것이 중요합니다.
  * 의료 영상의 3D 특성을 소량 분할에 완전히 활용하는 방법을 계속 탐색하는 것이 유망한 연구 방향입니다.

## 📌 TL;DR

레이블 데이터가 부족한 의료 영상 소량 분할에서 크고 이질적인 배경 클래스를 모델링하는 문제와 지역 정보 손실 문제를 해결하기 위해, 본 연구는 **이상 탐지 기반 소량 분할 네트워크(ADNet)**를 제안합니다. ADNet은 단일 **전경 프로토타입**과 학습된 **임계값**을 사용하여 분할을 수행하며, 배경을 명시적으로 모델링하지 않습니다. 또한, 의료 영상의 **3D 슈퍼복셀**을 활용한 새로운 **자기 지도 학습** 방식을 도입하여 레이블 없이 훈련합니다. 이 방법은 기존 최첨단 모델을 능가하며, 특히 약한 레이블 없는 실제 시나리오에서 견고한 성능을 보였고, 나아가 **단일 단계 3D 볼륨 분할**의 가능성을 보여주었습니다.
