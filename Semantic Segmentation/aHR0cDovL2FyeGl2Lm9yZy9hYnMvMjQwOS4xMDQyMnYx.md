# Learning Semi-Supervised Medical Image Segmentation from Spatial Registration

Qianying Liu, Paul Henderson, Xiao Gu, Hang Dai, Fani Deligianni

## 🧩 Problem to Solve

의료 영상의 반지도 의미론적 분할(Semi-Supervised Semantic Segmentation, S4)은 레이블이 제한된 데이터와 풍부한 레이블 없는 데이터를 활용하여 모델을 훈련하는 데 유망하지만, 기존 최첨단(SOTA) 방법들은 잠재적으로 가치 있는 비지도 의미 정보원인 "영상 볼륨 간의 공간 정합(spatial registration) 변환"을 무시합니다. 기존 교차 교육(cross-teaching) 프레임워크는 주로 네트워크 자체 예측에서 파생된 의사 레이블(pseudo-labels)에 의존하지만, 이러한 의사 레이블은 특히 훈련 초기 단계에서 노이즈가 많아 모델의 학습에 한계를 야기할 수 있습니다. 또한, 기존 지도 대조 학습(supervised contrastive learning)은 의사 레이블의 부정확성으로 인해 픽셀 단위 긍정 쌍(positive pairs) 샘플링에서 오류가 발생할 수 있습니다.

## ✨ Key Contributions

- **CCT-R 프레임워크 제안**: 공간 정합 정보를 대조적 교차 교육(contrastive cross-teaching) 프레임워크에 통합한 최초의 반지도 학습 의료 영상 분할 방법인 CCT-R을 제안합니다.
- **새로운 정합 지도 손실(Registration Supervision Loss, RSL) 도입**: 레이블이 지정된 볼륨과 레이블이 지정되지 않은 볼륨 쌍 간의 변환에서 파생된 분할 지식을 활용하여, 훈련 초기에 추가적이고 정보적인 정합 의사 레이블을 제공하고, 최적의 정합 볼륨을 자동으로 선택함으로써 교차 교육을 강화합니다.
- **정합 강화 긍정 샘플링(Registration-Enhanced Positive Sampling, REPS) 모듈 개발**: 정합 변환을 사용하여 해부학적으로 대응하는 픽셀을 여러 볼륨에서 식별함으로써 지도 대조 학습에서 의사 레이블의 노이즈 문제를 완화합니다. 이는 현재 예측된 클래스와 관계없이 정확한 긍정 쌍을 추가합니다.
- **다양한 반지도 학습 알고리즘과의 호환성 입증**: 제안된 전략들이 UAMT, CPS, CTS 등 여러 최신 S4 알고리즘 및 대조 학습 변형과 결합될 때 정확도를 향상시킴을 입증했습니다.

## 📎 Related Works

- **반지도 의료 영상 분할의 일관성 정규화 (Consistency regularization)**: 레이블 부족 문제를 해결하기 위해 데이터 증강, 네트워크 아키텍처, 작업 구성 등을 통해 여러 분기 간의 예측 일관성을 강제하는 접근 방식들 (예: UAMT, CPS, CTS, MCSC). 이들은 단일 슬라이스 내의 예측 일관성에 집중하며, 의사 레이블의 부정확성 문제가 있었습니다.
- **의료 영상 정합 (Medical image registration)**: 여러 소스, 시간, 환자의 영상을 공통 좌표계로 정렬하는 과정입니다. 상호 정보(MI) 기반의 고전적 방법과 VoxelMorph [5] 같은 딥러닝 기반의 학습 방법이 존재합니다.
- **분할과 정합의 결합 (Combining segmentation and registration)**: 아틀라스 영상에서 레이블을 전파하거나, 분할이 정합에 추가적인 지도를 제공하는 방식 (예: DeepAtlas [82]). 본 연구는 정합 자체를 해결하는 것이 아니라, 기존 정합 알고리즘을 S4 성능 향상에 활용한다는 점에서 차별화됩니다.
- **분할 및 정합을 위한 대조 학습 (Contrastive learning for segmentation and registration)**: 자기 지도(self-supervised) 표현 학습에서 중요하게 활용되며, 픽셀 단위(local) 대조 학습을 통해 조밀한 예측을 요구하는 분할 작업에 적용됩니다 (예: GLCL [36], ReCo [51], MCSC [49]). 본 연구는 정합 정보를 활용하여 S4를 위한 대조 샘플링을 유도한 최초의 시도입니다.

## 🛠️ Methodology

CCT-R은 소수의 레이블된 2D 슬라이스 $D_{l} = \{(x^{l}_{i}, y^{l}_{i})\}^{K}_{i=1}$와 다수의 레이블되지 않은 슬라이스 $D_{u} = \{x^{u}_{j}\}^{M}_{j=1}$ (여기서 $M \gg K$)를 활용하는 반지도 학습 설정에서 작동합니다. 전체 훈련 프레임워크는 두 개의 학생 모델(Model A, Model B)이 레이블된 이미지 $X_{l}$에 대한 표준 지도 손실($\mathcal{L}_{sup}$)과 레이블되지 않은 이미지 $X_{u}$에 대한 교차 의사 지도 손실($\mathcal{L}_{cps}$)을 통해 훈련되는 교차 의사 지도 [19, 57]와 유사합니다.

1. **지도 손실 ($\mathcal{L}_{sup}$)**: 레이블된 데이터에 대해 Dice 손실과 교차 엔트로피 손실을 결합하여 계산됩니다.
   $$ \mathcal{L}_{sup} = - \frac{1}{K} \sum^{K}_{i=1} [ \mathcal{L}_{dice}(P^{l}_{*}, Y^{l}) + \mathcal{L}_{ce}(P^{l}_{*}, Y^{l}) ] $$
    여기서 $P^{l}_{*}$는 레이블된 이미지 배치 $X_{l}$에 대한 예측 확률 맵이고, $Y^{l}$은 실제 레이블 맵이며, $*$는 모델 A 또는 B를 나타냅니다.

2. **교차 의사 지도 손실 ($\mathcal{L}_{cps}$)**: 모델 A와 B가 레이블되지 않은 $X_{u}$에 대해 서로의 예측으로부터 학습하도록 장려하여 일관성을 유도합니다.
   $$ \mathcal{L}_{cps(A)} = \mathcal{L}_{dice}(P^{u}_{A}, Y^{u}_{B}), \quad \mathcal{L}_{cps(B)} = \mathcal{L}_{dice}(P^{u}_{B}, Y^{u}_{A}) $$

3. **지도 대조 학습 ($\mathcal{L}_{cl}$)** (선택 사항): 픽셀 단위 특징을 공유 임베딩 공간으로 투영하여, 같은 클래스(긍정) 픽셀의 특징은 유사하게, 다른 클래스(부정) 픽셀의 특징은 비유사하게 만듭니다.
   $$ \mathcal{L}_{cl} = - \frac{1}{|C|} \sum_{c \in C} \frac{1}{|an*{c}|} \sum*{a*{i} \in an*{c}} \log \left[ \frac{\exp(a_{i} \cdot a_{p}/\tau)}{\exp(a_{i} \cdot a_{p}/\tau) + Z} \right] $$
    여기서 $a_{p}$는 같은 클래스의 모든 다른 픽셀의 평균을 계산하여 얻은 긍정 키입니다:
   $$ a^{l}_{p} = \frac{1}{|A_{c}|} \sum*{a*{i} \in A*{c}} a*{i} $$

CCT-R은 공간 정합 정보를 다음 두 가지 방식으로 통합합니다:

1. **정합 지도 손실 (RSL)**:
   - 레이블이 지정된 볼륨에서 레이블되지 않은 볼륨으로의 정합 변환을 사용하여 추가적인 의사 레이블 $r^{u}_{i}$를 생성합니다. 이는 훈련 초기에 더 정확한 의사 레이블을 제공하여 모델 학습을 개선하고 교차 교육의 확인 편향(confirmation bias)을 줄입니다.
     $$ \mathcal{L}_{rs} = - \frac{1}{M} \sum^{M}_{i=1} (\mathcal{L}_{dice}(p^{u}_{i}, r^{u}_{i}) + \mathcal{L}_{ce}(p^{u}_{i}, r^{u}_{i})) $$
   - **최적 정합 선택 (Best Registration Selection, BRS) 전략**: 정합의 부정확성을 완화하기 위해, 주기 일관성(cycle-consistency)을 측정하여 가장 유용한 정합 쌍을 선택합니다. 볼륨 $v^{u}_{j}$에 대해 순방향 변환 $T_{jq}$와 역방향 변환 $T_{qj}$를 적용하여 $\tilde{v}^{u}_{j} = T_{qj}(T_{jq}(v^{u}_{j}))$를 계산하고, $v^{u}_{j}$와 $\tilde{v}^{u}_{j}$ 간의 상호 정보(MI) 및 제곱근 평균 제곱 오차(RMSE)를 기반으로 복합 점수를 최소화하는 $v^{l}_{q}$를 선택합니다.
2. **정합 강화 긍정 샘플링 (REPS)**:
   - 지도 대조 학습에서 긍정 샘플링을 개선하기 위해 정합 정보를 활용합니다. 앵커 $a_{i}$의 xyz 좌표 $p$를 다른 볼륨 $v_{j}$의 대응하는 좌표 $p_{j}$로 변환합니다: $p_{j} = T_{qj}(p)$.
   - 메모리 뱅크 $B$를 구축하여 다양한 3D 볼륨에서 더 많은 정합된 긍정 샘플 $a^{r}_{p_{j}}$을 제공합니다. 이는 미니 배치 크기에 따른 제약을 피하고 의사 레이블 오류와 무관한 긍정 쌍을 제공합니다.
   - 최종 긍정 키 $a_{p}$는 의사 레이블 기반 긍정 키 $a^{l}_{p}$와 정합 기반 긍정 키 $a^{r}_{p}$의 가중 평균으로 계산됩니다:
     $$ a*{p} = w*{1}a^{l}_{p} + w_{2}a^{r}\_{p} $$

최종 손실 함수는 각 모델에 대해 다음과 같습니다:
$$ \mathcal{L}_{A} = \mathcal{L}_{sup(A)} + w*{cps}\mathcal{L}*{cps(A)} + w*{cl}\mathcal{L}*{cl} + \mathcal{L}\_{rs} $$
(모델 B도 유사)

## 📊 Results

- **데이터셋**: ACDC (심장 MRI) 및 Synapse (복부 CT).
- **성능 지표**: Dice 계수 (DSC) 및 95% Hausdorff 거리 (HD).
- **ACDC 데이터셋**:
  - 7개 레이블 케이스(10%)에서 CTS 대비 DSC 4% 이상 향상, HD 7mm 감소.
  - 3개 레이블 케이스(5%)에서 CTS 및 SOTA MCSC 대비 DSC 각각 20%, 12% 향상, HD 14mm, 8.5mm 감소.
  - 1개 레이블 케이스(1.4%)의 최소 지도 조건에서 SOTA MCSC 대비 DSC 80.4% vs 58.6%로 압도적인 성능 발휘 (33.6% 향상), HD 32.8mm 감소.
- **Synapse 데이터셋**:
  - 4개 레이블 케이스(20%)에서 CTS 대비 DSC 7.4% 향상 (64.0% $\rightarrow$ 71.4%), MCSC 대비 2.9% 향상.
  - 1개 레이블 케이스(5%)에서 MCSC 대비 평균 DSC 13.6% 향상, HD 15.4mm 감소. 특히 대동맥, 신장, 췌장과 같은 작고 어려운 장기 분할에서 뛰어난 성능을 보였습니다.
  - 단순 아핀(affine) 정합만 사용해도 등록을 사용하지 않는 경우보다 성능이 크게 향상되며, 변형(deformable) 정합 사용 시 더 좋은 결과를 보였습니다.
- **정합 전파(Registration-only)**: 정합을 통해 레이블을 전파하는 단순 정합 기반 방법은 학습 기반 방법보다 훨씬 낮은 성능을 보였습니다.
- **다른 SSL 기반 모델에 대한 모듈 적용**: RSL만 적용하거나, RSL과 SCL + REPS를 함께 적용했을 때 UAMT, CPS, CTS 등 모든 비교된 반지도 학습 기반 모델의 성능이 향상됨을 입증했습니다.
- **대조 학습 비교**: 다른 최신 대조 학습 S4 방법(GLCL, MCSC, ReCo)과 비교했을 때, CCT-R은 거의 모든 데이터셋과 레이블링 비율에서 더 높은 분할 정확도를 달성했습니다.
- **의사 레이블 품질 분석**: 훈련 초기 단계에서 RSL이 없는 모델은 불충분한 훈련으로 인해 의사 레이블의 품질이 낮았으나, RSL을 사용하면 훈련 과정 전반에 걸쳐 일관되고 신뢰할 수 있는 지도를 제공하여 효과적인 학습을 가능하게 했습니다.

## 🧠 Insights & Discussion

- **정합 정보의 가치**: 이 연구는 의료 영상 분석의 다른 분야인 공간 정합에서 파생된 풍부한 시맨틱 정보를 반지도 학습 분할에 성공적으로 활용했습니다. 이는 기존 S4 방법이 간과했던 중요한 정보원임을 입증합니다.
- **의사 레이블의 노이즈 완화**: RSL은 훈련 초기에 더 정확한 의사 레이블을 제공하여 교차 교육의 고질적인 문제인 확인 편향(confirmation bias)을 줄이고 학습 속도를 높이며 최종 분할 성능을 향상시키는 데 기여합니다.
- **대조 학습 강화**: REPS 모듈은 정합을 통해 해부학적으로 일치하는 긍정 쌍을 식별함으로써, 의사 레이블의 부정확성으로 인한 대조 학습의 한계를 극복합니다. 이는 모델이 다른 볼륨 간의 유사성을 더 강력하게 학습할 수 있도록 합니다.
- **강력한 일반화 및 강건성**: 매우 제한적인 레이블 데이터(예: 단 1개 케이스)에서도 CCT-R이 탁월한 성능을 보인다는 점은, 실제 임상 환경과 같이 주석이 매우 비싸고 희소한 시나리오에서 이 방법의 높은 실용적 가치를 시사합니다.
- **한계점 및 확장성**: CCT-R은 기존의 (완벽하지 않은) 정합 알고리즘에 의존합니다. 이는 정합 전처리 단계가 필요하며, 정합 품질이 결과에 영향을 미칠 수 있음을 의미합니다. 그럼에도 불구하고, 이 방법은 추가적인 훈련 파라미터 없이 SOTA 성능을 달성하여 효율성을 입증했습니다.

## 📌 TL;DR

의료 영상 반지도 분할에서 공간 정합 변환의 미활용 가치를 해결하기 위해, CCT-R은 정합 정보를 활용하는 대조적 교차 교육 프레임워크를 제안합니다. 이는 **정합 지도 손실 (RSL)**을 통해 정합 기반 의사 레이블로 모델을 지도하고, **정합 강화 긍정 샘플링 (REPS)**으로 대조 학습의 긍정 쌍 품질을 향상시킵니다. 그 결과, CCT-R은 단 1개의 레이블된 케이스와 같은 최소 지도 환경에서도 기존 SOTA 방법을 크게 능가하며, 의료 영상 분할에서 탁월한 정확도와 강건성을 입증합니다.
