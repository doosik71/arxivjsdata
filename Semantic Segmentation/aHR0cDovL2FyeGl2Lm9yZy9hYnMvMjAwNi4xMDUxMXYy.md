# Contrastive learning of global and local features for medical image segmentation with limited annotations

Krishna Chaitanya, Ertunc Erdil, Neerav Karani, Ender Konukoglu

## 🧩 Problem to Solve

지도 학습 기반의 딥러닝은 의료 영상 분석에서 탁월한 성능을 보이지만, 대규모의 주석(label)이 달린 데이터셋을 구축하기 어렵다는 고질적인 문제가 있습니다. 기존의 자기 지도 학습(Self-supervised learning, SSL), 특히 대조 학습(Contrastive learning)은 주로 이미지 수준의 전역적(global) 특징 학습에 중점을 두어 픽셀 단위 예측 작업(예: 이미지 분할)에 필요한 구별적인 지역적(local) 특징을 명시적으로 학습하지 않습니다. 또한, 대조 전략이 주로 데이터 증강(data augmentation) 변환에 의존하며, 데이터셋 내의 이미지 간에 내재된 구조적 유사성을 활용하지 못하는 한계가 있습니다. 본 연구는 이러한 간극을 메워 제한된 주석을 가진 의료 영상 분할 문제를 해결하고자 합니다.

## ✨ Key Contributions

* 의료 볼륨 영상(예: MRI, CT)의 구조적 유사성을 활용하는 새로운 **도메인 특화 대조 전략**을 제안했습니다.
* 픽셀 단위 분할에 유용한 지역별 표현을 학습하기 위해 **지역 대조 손실(local contrastive loss)** 버전을 제안했습니다. 이는 문제 특화적(problem-specific) 단서를 활용합니다.
* 세 가지 MRI 데이터셋에 대한 광범위한 평가를 통해 제한된 주석 설정에서 기존 자기 지도 학습 및 준지도 학습 기법 대비 상당한 성능 향상을 입증했습니다.
* 제안된 방법이 간단한 데이터 증강 기법과 결합될 때, 벤치마크 성능의 8% 내에 도달하며, 벤치마크 훈련 데이터의 4%에 해당하는 두 개의 레이블링된 MRI 볼륨만으로도 뛰어난 성능을 보임을 확인했습니다.

## 📎 Related Works

* **자기 지도 학습(SSL):**
  * **Pretext task-based methods:** 이미지 방향 예측, 인페인팅(inpainting), 문맥 복원 등 미리 정의된 보조 작업을 통해 유용한 표현을 학습합니다. (예: Rotation [21], Inpainting [46], Context Restoration [11])
  * **Contrastive learning methods:** 유사한 쌍은 유사한 표현을, 비유사한 쌍은 비유사한 표현을 갖도록 대조 손실($[24]$)을 사용합니다. 주로 이미지 변환을 통해 유사성을 정의하며, 상호 정보량(mutual information) 최대화와 유사한 구현 방식을 가집니다 (예: SimCLR $[12]$, MoCo $[25,42]$). 기존 연구는 주로 인코더 아키텍처와 이미지 단위 예측에 초점을 맞추었습니다. 본 연구는 인코더-디코더 아키텍처와 픽셀 단위 예측에 초점을 맞추고, 지역적 표현 학습의 목표가 다릅니다.
* **준지도 학습(Semi-supervised learning):** 레이블링되지 않은 데이터를 레이블링된 데이터와 함께 사용합니다. (예: Self-training $[6]$, Adversarial training $[66]$)
* **데이터 증강(Data augmentation):** 랜덤 아핀 변환, 탄성 변형, 대비 변환, Mixup $[62]$, GAN을 통한 합성 데이터 생성 등이 있습니다.

## 🛠️ Methodology

본 연구는 SimCLR $[12]$의 대조 학습 프레임워크를 의료 영상 분할에 맞게 확장합니다.

1. **전역 대조 손실(Global Contrastive Loss, $L_g$)**:
    * 기존 SimCLR의 대조 손실을 기반으로 합니다:
        $l(\tilde{x}, \hat{x}) = -\log \frac{e^{\text{sim}(\tilde{z}, \hat{z})/\tau}}{e^{\text{sim}(\tilde{z}, \hat{z})/\tau} + \sum_{\bar{x} \in \Lambda^-} e^{\text{sim}(\tilde{z}, g_1(e(\bar{x})))/\tau}$
        여기서 $\tilde{x}, \hat{x}$는 동일 이미지 $x$의 변환된 버전이고, $\Lambda^-$는 비유사 이미지 집합입니다. $\tilde{z}, \hat{z}$는 인코더 $e(\cdot)$와 투사 헤드 $g_1(\cdot)$를 거친 표현입니다.
    * **의료 볼륨 내 구조 활용**: 동일한 해부학적 영역의 다른 피험자 볼륨 간의 유사성을 활용합니다. 모든 볼륨을 동일한 수의 파티션(예: $S$개)으로 나누고, 다른 볼륨의 **해당 파티션에서 온 이미지들($x_i^s, x_j^s$)**을 유사하다고 간주합니다.
    * **제안된 전략**:
        * **G$_{D-}$**: 특정 파티션 $s$의 관련 쌍 $(\tilde{x}_i^s, \hat{x}_i^s)$에 대해, 비유사 이미지 집합 $\Lambda^-$를 *다른 파티션*에서 온 이미지들로만 구성합니다.
        * **G$_D$**: G$_{D-}$에 더하여, **다른 볼륨의 해당 파티션에서 온 이미지들 $(x_i^s, x_j^s)$**도 유사한 쌍 $\Lambda^+$에 포함시켜 파티션별 표현 클러스터를 장려합니다. 이는 $G_R$ (무작위 변환만 사용하는 기존 전략)보다 복잡한 유사성 단서를 제공합니다.

2. **지역 대조 손실(Local Contrastive Loss, $L_l$)**:
    * 인코더-디코더 네트워크의 디코더($d_l$)가 구별적인 지역적 표현을 학습하도록 합니다.
    * 이미지 $x$의 변환된 버전 $(\tilde{x}, \hat{x})$를 인코더 $e$, 디코더 $d_l$, 그리고 얕은 네트워크 $g_2$에 통과시켜 특징 맵 $\tilde{f}, \hat{f}$를 얻습니다.
    * 각 특징 맵을 $A$개의 지역 영역으로 나누고, **$\tilde{f}$와 $\hat{f}$의 해당 지역 영역**은 유사한 쌍 $\Omega^+$를 형성합니다.
    * **동일 특징 맵 내의 다른 지역 영역**들은 비유사한 쌍 $\Omega^-$를 형성합니다.
    * 지역 대조 손실:
        $l(\tilde{x},\hat{x},u,v) = -\log \frac{e^{\text{sim}(\tilde{f}(u,v),\hat{f}(u,v))/\tau}}{e^{\text{sim}(\tilde{f}(u,v),\hat{f}(u,v))/\tau} + \sum_{(u',v') \in \Omega^-} e^{\text{sim}(\tilde{f}(u,v),\hat{f}(u',v'))/\tau}$
    * **제안된 전략**:
        * **L$_R$ (무작위 샘플링)**: 도메인 특화 지식 없이, 동일 이미지의 변환된 버전 내 지역 영역 간의 유사성/비유사성만 활용합니다.
        * **L$_D$**: $G_D$와 유사하게, **다른 볼륨의 해당 파티션 내 지역 영역들**도 $\Omega^+$에 포함하여 지역 표현 클러스터링을 강화합니다.

3. **전체 사전 학습 과정 (단계별)**:
    1. 인코더 $e$와 $g_1$을 전역 대조 손실 $L_g$로 사전 학습합니다.
    2. $g_1$을 버리고 $e$를 고정합니다.
    3. 디코더의 첫 $l$개 블록 $d_l$과 $g_2$를 지역 대조 손실 $L_l$로 사전 학습합니다.
    4. $g_2$를 버립니다.
    5. 사전 학습된 $e$와 $d_l$에 나머지 디코더 블록을 추가하고, 소량의 레이블링된 데이터로 전체 네트워크를 분할 작업에 대해 미세 조정(fine-tuning)합니다.

## 📊 Results

* **데이터셋**: ACDC, Prostate, MMWHS (모두 MRI 데이터셋)
* **평가 지표**: Dice Similarity Coefficient (DSC)
* **전역 대조 전략**: 제안된 도메인 특화 전략인 $G_{D-}$와 $G_D$는 기존의 $G_R$ (무작위)보다 모든 데이터셋과 제한된 레이블 설정($|X_{tr}|=1,2,8$ 볼륨)에서 **상당히 더 나은 성능**을 보였습니다. 특히 $G_D$가 약간 더 우수했습니다.
* **지역 대조 전략**: 디코더를 지역 대조 손실로 사전 학습하는 것이 인코더만 사전 학습하고 디코더를 무작위로 초기화하는 것보다 **추가적인 성능 향상**을 제공했습니다. $L_R$ (무작위 지역 전략)이 $L_D$ (도메인 특화 지역 전략)보다 대부분의 설정에서 더 나은 성능을 보였습니다. 이는 볼륨 간의 대략적인 정렬이 반드시 지역 영역 간의 정확한 대응을 의미하지 않을 수 있음을 시사합니다. 디코더 블록 $l=3$이 최적의 성능을 보였습니다.
* **다른 방법들과의 비교**: 제안된 사전 학습($G_D+L_R$)은 다른 pretext task 기반의 사전 학습 방법(Rotation, Inpainting, Context Restoration), 기존 전역 대조 손실($G_R$), 준지도 학습 방법(Self-train, Mixup, Adversarial training)보다 **일관되게 우수한 성능**을 보였습니다. 특히 훈련 볼륨 수가 매우 적을 때($|X_{tr}|=1,2$) 성능 향상이 두드러졌습니다.
* **결합 효과**: 제안된 사전 학습 방법은 데이터 증강 (Mixup 등) 및 준지도 학습 방법과 **상호 보완적으로 작용하여** 추가적인 성능 개선을 달성했습니다.
* **제한된 레이블로 벤치마크 근접**: 2개의 훈련 볼륨만 사용했을 때, 제안된 방법은 벤치마크(전체 훈련 데이터 사용) 대비 약 $0.1$ DSC 내외의 성능에 도달했습니다.

## 🧠 Insights & Discussion

* 의료 영상 분할과 같이 픽셀 수준 예측을 요구하는 작업에서는 도메인 특화된 전역 특징 학습과 문제 특화된 지역 특징 학습을 모두 활용하는 대조 학습이 매우 효과적입니다.
* 의료 영상의 특성(볼륨 내 구조적 유사성)을 활용한 대조 전략은 단순한 데이터 증강 변환보다 더 복잡하고 유용한 유사성 단서를 네트워크에 제공하여 성능을 향상시킵니다.
* 사전 학습을 통해 얻은 좋은 초기화는 기존의 데이터 증강이나 준지도 학습 방법들과 시너지 효과를 내어, 제한된 레이블 환경에서도 높은 성능을 달성할 수 있는 강력한 도구 상자를 제공합니다. 이는 특히 레이블링 비용이 높은 임상 환경에서 매우 중요합니다.
* 일부 제한 사항으로는 의료 데이터셋의 경우 자연 이미지 데이터셋만큼 큰 배치 크기가 필요하지 않을 수 있으며, 볼륨 간의 "대략적인" 정렬이 모든 지역적 영역에 대해 정확한 대응을 보장하지 않으므로, 지역 대조 학습 시 도메인 특화 전략($L_D$)이 오히려 성능을 저해할 수 있다는 점이 있습니다. 또한, 단계별 학습이 손실 가중치 조정의 복잡성을 피하고 더 나은 성능을 보였습니다.

## 📌 TL;DR

레이블이 부족한 의료 영상 분할 문제를 해결하기 위해, 본 연구는 **도메인 특화 전역 대조 손실**과 **문제 특화 지역 대조 손실**을 활용하여 UNet 기반 모델을 사전 학습하는 새로운 대조 학습 프레임워크를 제안합니다. 이는 의료 볼륨 내의 구조적 유사성을 활용하고 픽셀 단위 분할에 필요한 지역적 특징을 명시적으로 학습합니다. 세 가지 MRI 데이터셋에서 **제한된 주석만으로도 기존 방법들을 능가하는 상당한 분할 성능 향상**을 보였으며, 데이터 증강과 결합 시 극히 적은 레이블(예: 2개 볼륨)로도 벤치마크 수준에 근접한 결과를 달성하여, 의료 영상 분석의 실용적 적용 가능성을 크게 높였습니다.
