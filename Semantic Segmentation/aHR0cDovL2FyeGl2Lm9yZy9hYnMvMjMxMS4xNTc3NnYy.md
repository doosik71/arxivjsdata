# Stable Segment Anything Model

Qi Fan, Xin Tao, Lei Ke, Mingqiao Ye, Yuan Zhang, Pengfei Wan, Zhongyuan Wang, Yu-Wing Tai, Chi-Keung Tang

## 🧩 Problem to Solve

Segment Anything Model (SAM)은 고품질의 프롬프트(예: 정확한 바운딩 박스, 충분한 포인트)가 주어졌을 때 뛰어난 분할 성능을 보여줍니다. 하지만 실제 환경에서는 사용자가 임의로 제공하는 부정확하거나 불충분한 프롬프트(저품질 프롬프트)에 대해 SAM의 분할 결과가 매우 불안정해지는 문제가 발생합니다. 이러한 저품질 프롬프트는 SAM의 마스크 디코더가 이미지의 배경이나 특정 객체 부분에 편향된 특징을 활성화하도록 유도하여 "어텐션 드리프트(attention drift)" 현상을 일으킵니다. 기존 SAM 모델을 직접 미세 조정하면 모델의 핵심적인 제로샷 일반화 능력을 손상시킬 수 있으며, 일반적인 변형 가능한 어텐션(deformable attention) 기법을 단순히 적용하는 것도 SAM의 무결성을 해칠 수 있어 적절한 해결책이 부재했습니다.

## ✨ Key Contributions

- 다양한 프롬프트 품질, 특히 부정확한 바운딩 박스 및 불충분한 포인트에 대한 SAM의 분할 안정성에 대한 최초의 포괄적인 분석을 수행했습니다.
- 저품질 프롬프트가 주어졌을 때 SAM의 마스크 디코더가 배경 또는 특정 객체 부분에 편향된 이미지 특징을 활성화하는 경향이 있음을 발견했습니다.
- SAM의 원래 모델 아키텍처와 가중치는 변경하지 않고, 오직 SAM의 마스크 어텐션만을 교정하는 새로운 **변형 가능한 샘플링 플러그인 (Deformable Sampling Plugin, DSP)**을 제안했습니다. 이는 이미지 특징의 샘플링 위치와 진폭을 조정하여 데이터 기반으로 어텐션을 프롬프트된 타겟 영역으로 적응적으로 전환합니다.
- 입력 프롬프트 품질에 따라 SAM이 변형 가능한 샘플링 모드와 일반 그리드 샘플링 모드 사이를 전환할 수 있도록 하는 **동적 라우팅 플러그인 (Dynamic Routing Plugin, DRP)**을 제안했습니다.
- 제안된 솔루션인 **Stable-SAM**은 다음과 같은 이점을 제공합니다:
  - 다양한 프롬프트 품질 전반에 걸쳐 SAM의 분할 안정성을 향상시킵니다.
  - SAM의 강력한 프롬프트 기반 분할 효율성과 일반성을 유지합니다.
  - 최소한의 학습 가능한 파라미터 (0.08M)와 빠른 적응 속도를 자랑합니다.

## 📎 Related Works

- **분할 품질 향상 (Improving Segmentation Quality):**
  - 초기 방법들은 CRF [36]나 영역 성장(region growing) [11]과 같은 그래프 모델을 후처리 단계로 사용했습니다.
  - 최근에는 Mask2Former [7] 및 SAM [35]과 같은 프롬프트 기반 접근 방식이 개방형 분할(open-world segmentation)을 가능하게 했습니다. HQ-SAM [32]을 포함한 여러 연구들이 프롬프트 튜닝과 디코더 정확도 개선에 중점을 두었지만, 부정확한 프롬프트 상황에서의 안정성은 간과되었습니다.
- **기반 모델 튜닝 (Tuning Foundation Models):**
  - 사전 학습된 모델 [22, 37, 57]과 제로샷 일반화 [4, 5]가 중요해지면서, 어댑터(adapter) [25] 및 프롬프트 기반 학습 [24, 25]과 같은 튜닝 방법이 제안되었습니다. 본 연구는 최소한의 추가 파라미터로 기존 특징을 활용하여 경쟁력 있는 결과를 생성합니다.
- **변형 가능한 어텐션 (Deformable Attention):**
  - 변형 가능한 컨볼루션(deformable convolution) [10, 69]은 신경망이 중요한 공간 위치에 집중하도록 돕는 데 효과적입니다. 최근에는 트랜스포머 기반 네트워크 [6, 63, 66, 70]로도 확장되었습니다. 기존의 변형 가능한 레이어는 오프셋 학습과 변형 후 특징 학습을 모두 포함하지만, 본 논문은 후속 레이어 학습 없이 변형 연산을 통해 특징 어텐션만 조정하는 새로운 접근 방식을 제안합니다.

## 🛠️ Methodology

Stable-SAM은 SAM의 마스크 디코더에 플러그인 형태로 추가되어 어텐션 드리프트 문제를 해결하며, SAM의 원본 모델은 변경하지 않습니다.

- **변형 가능한 샘플링 플러그인 (Deformable Sampling Plugin, DSP):**

  - DSP는 SAM의 마스크 어텐션을 교정하여 이미지 특징 샘플링 위치와 진폭을 조정합니다.
  - **오프셋 네트워크 ($\theta_{offset}$):** 입력 이미지 특징 맵 $x_p \in R^{H \times W \times C}$를 사용하여 각 이미지 특징 샘플링 위치에 대한 오프셋 $\Delta p \in R^{H \times W \times 2}$를 예측합니다. 이 네트워크는 $1 \times 1$ 컨볼루션, $5 \times 5$ 깊이별 컨볼루션, LayerNorm, GELU 활성화, 그리고 또 다른 $1 \times 1$ 컨볼루션으로 구성됩니다. 과도한 오프셋을 방지하기 위해 스케일 함수 $\theta_s(s_p \cdot \tanh(\cdot))$가 적용됩니다.
  - **특징 재샘플링 및 변조:** 예측된 오프셋 $\Delta p$를 통해 업데이트된 샘플링 위치 $p + \Delta p$에서 변형 가능한 이미지 특징 $x^{*}_{p+\Delta p} \in R^{H \times W \times C}$를 재샘플링하고 변조합니다 (bilinear interpolation 사용).
  - **크로스 어텐션에 주입:** 이 재샘플링된 변형 가능한 특징 $x^{*}_{p+\Delta p}$는 SAM의 토큰-투-이미지 크로스 어텐션 모듈에서 키(Key) 및 값(Value) 특징으로 사용됩니다. 중요한 점은 **원래 SAM 모델의 아키텍처와 파라미터는 변경되지 않는다**는 것입니다.
  - 교정된 크로스 어텐션 수식: $DCAttn(t,x) = \sigma(Q(t) \cdot K(x^{*}_{p+\Delta p})^T) \cdot V(x^{*}_{p+\Delta p})$

- **동적 라우팅 플러그인 (Dynamic Routing Plugin, DRP):**

  - DRP는 입력 프롬프트의 품질에 따라 DSP 활성화 정도를 조절합니다.
  - 출력 마스크에 해당하는 프롬프트 토큰 특징 $t_o \in R^{1 \times C}$를 작은 MLP 네트워크에 통과시켜 DSP의 활성화 가중치 $\alpha = [\alpha_1, \alpha_2]$를 예측합니다.
  - 이 $\alpha$ 값을 사용하여 SAM은 변형 가능한 샘플링 모드($x^{*}_{p+\Delta p}$)와 일반 그리드 샘플링 모드($x_p$) 사이를 동적으로 라우팅하여 최적의 성능을 발휘합니다.
  - 동적 라우팅된 출력 수식: $O(t,x) = CAttn(t, \alpha_1 \cdot x^{*}_{p+\Delta p} + \alpha_2 \cdot x_p)$

- **강건한 학습 전략 (Robust Training Strategy, RTS):**
  - **부정확한 프롬프트에 대한 강건함:** 학습 시 접지 진실(ground truth) 박스, 노이즈가 추가된 박스(noise scale 0.4), 다양한 수의 포인트(1, 3, 10 포인트) 등 다양한 품질의 프롬프트를 혼합하여 사용합니다.
  - **모호한 프롬프트에 대한 강건함:** 합성된 가려짐(occlusion) 이미지를 학습에 포함하여, SAM이 혼잡한 환경에서도 대상 객체를 정확하게 분할하도록 유도합니다.

## 📊 Results

- **안정성 및 정확도 향상:** 노이즈 박스, 1포인트, 3포인트 프롬프트와 같은 저품질 프롬프트 환경에서 Stable-SAM은 SAM, DT-SAM, PT-SAM, HQ-SAM 등 기존 SAM 변형 모델들보다 mask mIoU, boundary mBIoU, segmentation stability (mSF) 모든 지표에서 일관되게 뛰어난 성능을 보였습니다 (Table 2). 특히, 노이즈 박스 프롬프트에서 SAM의 성능이 크게 떨어지는 반면, Stable-SAM은 이를 크게 개선했습니다.
- **강력한 제로샷 일반화:** MS COCO 및 SGinW 데이터셋에서 노이즈 박스 프롬프트 사용 시 Stable-SAM은 모든 경쟁 모델을 능가하며 강력한 제로샷 일반화 능력을 입증했습니다 (Table 3).
- **효율성:** Stable-SAM은 단 0.08M의 최소한의 추가 학습 가능 파라미터를 가지며, 단 1 epoch의 학습만으로도 빠르게 적응하여 높은 성능을 달성합니다. 이는 SAM의 본래 효율성과 일반성을 그대로 유지하면서 안정성을 높이는 장점을 제공합니다.
- **SOTA 탐지기 프롬프트와의 비교:** FocalNet-L-DINO와 같은 최첨단 탐지기가 생성한 고품질 박스 프롬프트를 사용할 때도 Stable-SAM은 SAM 및 HQ-SAM과 필적하는 성능을 보여주며, 사용자 인터랙션이 제한적이거나 부정확한 프롬프트를 제공하는 시나리오에서 특히 탁월한 성능을 발휘합니다 (Table 4).
- **구성 요소별 기여:**
  - DSP는 RTS 없이도 저품질 프롬프트에 대한 성능과 안정성을 개선하며, RTS와 함께 사용 시 매우 큰 효과를 보입니다 (Table 5). 시각화 결과는 DSP가 모델의 어텐션을 대상 객체로 효과적으로 전환함을 보여줍니다 (Figure 4).
  - DRP는 특히 1포인트 프롬프트와 같은 어려운 시나리오에서 모델 성능을 더욱 향상시키는 데 기여합니다 (Table 5). 낮은 품질의 프롬프트일수록 DSP 특징에 더 많이 의존하는 경향이 관찰되었습니다.
  - RTS는 모든 방법에 걸쳐 분할 안정성을 크게 향상시키며, Stable-SAM에 가장 큰 개선 효과를 가져왔습니다 (Table 6).
- **모델 확장성 및 저샷 일반화:** Stable-SAM은 1 epoch 학습만으로도 경쟁력 있는 성능을 보이며, 12 epoch 학습 시 모든 프롬프트 설정에서 최상의 성능을 달성합니다 (Table 6). 또한, 제한된 수의 학습 이미지(220 또는 440장)로 학습된 저샷(low-shot) 시나리오에서도 HQ-SAM보다 뛰어난 성능을 보이며, 최소한의 학습 가능한 파라미터 덕분에 효과적인 일반화 능력을 보여줍니다 (Table 7).

## 🧠 Insights & Discussion

- **SAM의 근본적인 취약점 해결:** 본 연구는 SAM이 저품질 프롬프트에 노출될 때 발생하는 어텐션 드리프트 문제를 포괄적으로 분석하고, 그로 인해 어텐션이 배경이나 객체의 특정 부분으로 편향되는 현상을 명확히 밝혀냈습니다. 이는 SAM의 실제 적용에 있어 중요한 제약 사항이었습니다.
- **플러그인 디자인의 전략적 이점:** SAM의 핵심 아키텍처와 사전 학습된 가중치를 동결한 채 소수의 파라미터만 학습하는 플러그인 방식(DSP 및 DRP)은 기반 모델의 강력한 제로샷 일반화 능력을 보존하면서도 특정 문제점(프롬프트 안정성)을 효과적으로 해결할 수 있음을 보여줍니다. 이는 기존의 모델 전체를 미세 조정하는 방식이나 변형 가능한 어텐션의 일반적인 적용 방식이 야기할 수 있는 "치명적인 망각" 문제를 회피하는 현명한 접근 방식입니다 (Figure 5, Table 11).
- **실용적 적용 가능성:** Stable-SAM의 강건한 성능과 효율성은 크라우드소싱 주석, 대화형 분할 도구, 자율 주행, 의료 영상 분석 등 사용자가 항상 완벽한 프롬프트를 제공하기 어려운 다양한 실제 응용 시나리오에서 매우 중요한 의미를 가집니다. 특히 최소한의 상호작용으로 일관되고 정확한 분할을 원하는 사용자에게 큰 이점을 제공합니다.
- **강건한 학습 전략의 중요성:** RTS는 모델이 잘못된 프롬프트에도 불구하고 올바른 대상에 집중하도록 돕는 데 결정적인 역할을 하며, 모델의 전반적인 안정성 향상에 기여합니다.

## 📌 TL;DR

SAM은 저품질 프롬프트에 대해 불안정한 분할 결과를 생성하며 어텐션이 배경이나 객체 부분에 편향되는 '어텐션 드리프트' 문제를 겪습니다. 이 문제를 해결하기 위해, 본 논문은 SAM의 마스크 어텐션만 교정하는 **변형 가능한 샘플링 플러그인 (DSP)**을 제안합니다. DSP는 SAM의 원본 모델은 변경하지 않고 이미지 특징의 샘플링 위치와 진폭을 적응적으로 조정하여 어텐션을 타겟 영역으로 이동시킵니다. 또한, 프롬프트 품질에 따라 샘플링 모드를 동적으로 전환하는 **동적 라우팅 플러그인 (DRP)**과 다양한 프롬프트 품질에 적응하기 위한 **강건한 학습 전략 (RTS)**을 도입했습니다. **Stable-SAM**은 최소한의 학습 가능한 파라미터(0.08M)로 기존 SAM 대비 분할 안정성과 정확도를 크게 향상시키면서도, SAM의 효율성과 제로샷 일반성을 유지함을 광범위한 실험을 통해 입증했습니다.
