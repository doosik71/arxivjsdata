# Constructing Self-motivated Pyramid Curriculums for Cross-Domain Semantic Segmentation: A Non-Adversarial Approach
Qing Lian, Fengmao Lv, Lixin Duan, Boqing Gong

## 🧩 Problem to Solve
합성 데이터(소스 도메인)로 학습된 의미론적 분할(semantic segmentation) 모델은 실제 데이터(타겟 도메인)에 적용될 때 시각적 불일치(도메인 시프트)로 인해 성능이 크게 저하됩니다. 그러나 실제 데이터를 수집하고 레이블링하는 것은 매우 비용이 많이 드는 작업입니다. 따라서, 주석 비용을 줄이면서 합성 데이터의 이점을 최대한 활용하여 실제 장면의 의미론적 분할 성능을 향상시키는 것이 중요한 과제입니다.

## ✨ Key Contributions
*   **새로운 통찰력 제시:** 기존의 자기 훈련(Self-Training, ST) 방식과 커리큘럼 도메인 적응(Curriculum Domain Adaptation, CDA) 방식 사이의 흥미로운 연결점을 발견하고, 이를 통해 새로운 접근 방식인 PyCDA를 제안합니다.
*   **자기 동기 부여 피라미드 커리큘럼(PyCDA) 제안:** 타겟 도메인 이미지에 대한 픽셀, 이미지 영역 및 전체 이미지 수준의 다양한 속성을 포함하는 피라미드 커리큘럼을 구축합니다. 이 커리큘럼은 네트워크 스스로 속성을 추론하는 "자기 동기 부여" 방식으로 작동하며, 추가적인 모델(예: 판별자 네트워크) 없이 최적화가 더 용이합니다.
*   **성능 향상:** 제안된 PyCDA는 GTAV 및 SYNTHIA에서 Cityscapes로의 도메인 적응 벤치마크에서 기존의 개별 ST 및 CDA 방법을 능가하며, 최신 적대적 적응 방법과 동등하거나 더 나은 최첨단 결과를 달성합니다.
*   **경량성 및 효율성:** 적대적 학습에서 흔히 발생하는 `min max` 문제 해결의 어려움 없이, 추가적인 판별자 네트워크 없이 구현되어 최적화가 더 쉽고 가볍습니다.

## 📎 Related Works
*   **의미론적 분할(Semantic Segmentation):** CNN 기반 방법론, 확장 컨볼루션(dilated convolution) 및 피라미드 컨텍스트 활용(예: DeepLab, PSP-Net, RefineNet)이 언급됩니다.
*   **도메인 적응(Domain Adaptation):** 훈련 데이터와 테스트 데이터 간의 분포 불일치를 해결하는 방법으로, 이미지 분류 문제(예: DANN, GFK, DAN, JAN)에서 주로 연구되었습니다.
*   **의미론적 분할을 위한 도메인 적응:**
    *   **커리큘럼 학습 기반:** Zhang et al.의 CDA [38, 39]는 타겟 도메인의 쉬운 작업을 먼저 학습하고 이를 분할에 활용합니다. 본 논문은 자기 훈련 [43]을 커리큘럼 방식의 도메인 적응으로 해석합니다.
    *   **특징 공간/출력 공간 정렬(적대적 학습 기반):** Hoffman et al. [18], Chen et al. [5], Tsai et al. [35], Zhang et al. [40], Luo et al. [26], Vu et al. [36] 등 다수의 연구가 특징 또는 출력 맵 수준에서 도메인 간의 간극을 줄이기 위해 적대적 학습을 활용합니다. 일부는 이미지-투-이미지 변환 [17, 27, 33]을 통해 도메인 적응을 수행합니다.

## 🛠️ Methodology
PyCDA(Self-motivated Pyramid Curriculum Domain Adaptation)는 커리큘럼 도메인 적응(CDA)과 자기 훈련(ST)의 아이디어를 결합합니다.

1.  **CDA와 ST의 연결:**
    *   CDA는 타겟 도메인 이미지 및 영역의 레이블 분포($P^1_t$)를 활용하고, ST는 타겟 도메인 픽셀에 대한 의사 레이블($P^2_t$)을 활용합니다.
    *   본 논문은 이 두 집합($P^1_t \cup P^2_t$)을 통합하여 피라미드 구조를 형성합니다.

2.  **피라미드 커리큘럼 구조:**
    *   **최하위(Bottom Layer):** 픽셀 수준의 의사 레이블을 생성합니다.
    *   **중간(Middle Layer):** 작은 정사각형(예: $4 \times 4$, $8 \times 8$ 픽셀) 영역의 레이블 분포(일종의 의사 레이블)를 활용합니다. 기존 CDA의 슈퍼픽셀 대신 계산 효율성을 위해 겹치는 정사각형 영역을 사용합니다.
    *   **최상위(Top Layer):** 전체 이미지에 대한 레이블 분포를 활용합니다.

3.  **자기 동기 부여 속성 추론:**
    *   **픽셀 의사 레이블 ($Y_t(i,j)$):** 네트워크의 픽셀별 예측 $\hat{Y}_t(i,j,c)$ 중 가장 높은 확률($c^?$)이 $0.5$를 초과하는 경우, 해당 픽셀의 의사 레이블을 $c^?$로 할당합니다.
        $$ Y_t(i,j) = \begin{cases} c^? & \text{if } \hat{Y}_t(i,j,c^?) > 0.5 \\ \text{null} & \text{otherwise} \end{cases} $$
    *   **픽셀 정사각형 레이블 ($Y^k_t$):** 정사각형 영역 내의 네트워크 예측 $\hat{Y}_t(i,j,c)$에 대해 평균 풀링($\hat{Y}_{\text{square}}(i_0,j_0,c)$)을 수행한 후, 픽셀 의사 레이블과 동일한 방식으로 임계값 처리를 통해 영역의 레이블을 결정합니다. 이는 원-핫 벡터 형태의 레이블 분포로 간주됩니다.
    *   **전체 이미지 레이블 분포 ($p^0_t$):** 모든 소스 도메인 이미지의 레이블 분포 평균을 타겟 도메인 이미지의 레이블 분포로 사용합니다. 이는 도시 장면 데이터의 객체 및 공간 레이아웃 유사성 때문에 효과적입니다.

4.  **최적화 목표 함수:**
    PyCDA는 다음 목표 함수를 최소화하여 네트워크를 학습시킵니다.
    $$ \min \frac{1}{|S|}\sum_{s \in S} L(Y_s, \hat{Y}_s) + \frac{\lambda_1}{|T|}\sum_{t \in T} C(p^0_t, \hat{p}^0_t) + \frac{\lambda_2}{|P|}\sum_{(t,k) \in P} C(Y^k_t, \hat{Y}^k_t) $$
    *   첫 번째 항: 소스 도메인 이미지 $s \in S$에 대한 픽셀별 교차 엔트로피 손실 $L$.
    *   두 번째 항: 타겟 도메인 이미지 $t \in T$에 대한 전체 이미지 레이블 분포 $p^0_t$와 네트워크 예측 $\hat{p}^0_t$ 간의 교차 엔트로피 손실 $C$.
    *   세 번째 항: 타겟 이미지의 정사각형 영역 및 픽셀에 대한 $Y^k_t$ (레이블 분포 또는 의사 레이블)와 네트워크 예측 $\hat{Y}^k_t$ 간의 교차 엔트로피 손실 $C$. $P$는 해당 영역/픽셀들의 집합입니다.
    *   실험에서는 $\lambda_1=1$, $\lambda_2=0.5$로 설정했습니다.

## 📊 Results
*   **GTAV $\to$ Cityscapes 적응 (표 1):** PyCDA는 VGG-16, ResNet-38, ResNet-101 등 다양한 백본 네트워크에서 기존 최첨단 방법(ROAD, CyCADA, CLAN, ADVENT 등)과 비교하여 가장 우수한 mIoU 성능(ResNet-101 기준 47.4%)을 달성했습니다. 특히 "road", "building", "vegetation", "car"와 같은 주요 클래스에서 강점을 보였으며, "rider", "wall", "fence"와 같은 작은 객체 분류에서도 CBST보다 우수했습니다.
*   **SYNTHIA $\to$ Cityscapes 적응 (표 2):** PyCDA는 SYNTHIA를 소스 도메인으로 사용할 때도 VGG-16 및 ResNet-101 백본 모두에서 기존 최첨단 방법을 큰 폭으로 능가하는 mIoU 성능을 보여주었습니다.
*   **어블레이션 스터디 (표 3):**
    *   CDA와 ST를 연결한 "top + bottom" 또는 "top + pixel squares" 방식이 개별 CDA 또는 ST보다 훨씬 높은 성능을 보였습니다. 이는 두 방법론의 결합이 효과적임을 입증합니다.
    *   PyCDA(픽셀과 픽셀 정사각형을 모두 고려)는 "top + bottom" 또는 "top + pixel squares"보다 추가적인 성능 향상을 달성했습니다.
    *   슈퍼픽셀 대신 픽셀 정사각형을 사용했을 때, 계산 비용은 크게 절감되면서도 mIoU 성능은 유사하게 유지되어 효율성을 입증했습니다.

## 🧠 Insights & Discussion
*   **커리큘럼과 자기 훈련의 시너지:** PyCDA는 커리큘럼 도메인 적응의 점진적인 학습 방식과 자기 훈련의 의사 레이블 활용을 효과적으로 결합하여 도메인 적응 문제를 해결합니다. 특히, 의사 레이블 추론 과정을 네트워크 자체적으로 수행함으로써 "자기 동기 부여"라는 이점을 얻습니다.
*   **비-적대적 접근의 강점:** 적대적 학습 방식이 아닌 순수한 손실 함수 기반의 최적화를 통해 복잡한 `min max` 문제나 추가적인 판별자 네트워크 없이도 최첨단 성능을 달성할 수 있음을 보여줍니다. 이는 실제 적용 시 최적화의 안정성과 구현의 용이성 면에서 큰 장점입니다.
*   **다중 스케일 정보 활용:** 피라미드 구조를 통해 전체 이미지의 거시적인 정보부터 픽셀 수준의 미시적인 정보까지 다양한 스케일의 도메인 속성을 모델에 주입함으로써, 객체의 크기에 관계없이 더 정확한 분할을 가능하게 합니다. 중간 레이어의 픽셀 정사각형은 고립된 픽셀보다 더 신뢰성 높은 의사 레이블 추정(합의 투표)을 제공합니다.
*   **소스 도메인의 중요성:** GTAV 데이터셋이 SYNTHIA보다 Cityscapes와 시각적으로 더 유사하여, GTAV 기반 모델의 성능이 더 우수했습니다. 이는 도메인 적응 성능에 있어 소스 도메인의 시각적 유사성이 여전히 중요함을 시사합니다.
*   **제한점:** 현재 PyCDA는 이미지 스타일 변환이나 다른 형태의 적대적 학습과 직교하므로, 이들과 결합될 경우 추가적인 성능 향상 가능성이 있습니다. 또한, 도시 장면 이외의 도메인에서는 전체 이미지 레이블 분포를 추정하는 데 더 정교한 알고리즘이 필요할 수 있습니다.

## 📌 TL;DR
PyCDA는 합성 데이터에서 실제 데이터로의 의미론적 분할 도메인 적응을 위해 자기 훈련과 커리큘럼 적응을 결합한 비-적대적 방법입니다. 이 방법은 픽셀, 정사각형 영역, 전체 이미지를 포함하는 자기 동기 부여 피라미드 커리큘럼을 구축하여 다양한 스케일의 타겟 도메인 속성을 모델에 학습시킵니다. GTAV와 SYNTHIA에서 Cityscapes로의 적응 벤치마크에서 기존 SOTA를 능가하는 성능을 보였으며, 복잡한 적대적 학습 없이도 효과적인 도메인 적응을 가능하게 함을 입증했습니다.