# A Unified Efficient Pyramid Transformer for Semantic Segmentation

Fangrui Zhu, Yi Zhu, Li Zhang, Chongruo Wu, Yanwei Fu, Mu Li

## 🧩 Problem to Solve

의미론적 분할(Semantic segmentation)은 복잡한 장면에서의 컨텍스트 모델링의 어려움과 경계에서의 클래스 혼동으로 인해 도전적인 문제입니다. 기존 연구들은 주로 컨텍스트 모델링이나 경계 개선 중 하나에 초점을 맞춰 왔으며, 이는 개방형 시나리오(open-world scenarios)에서 일반화 가능성이 떨어집니다. 또한, 고해상도 이미지에 트랜스포머(Transformer) 기반 어텐션 메커니즘을 직접 적용하는 것은 연산 비용과 메모리 사용량 측면에서 비효율적입니다.

## ✨ Key Contributions

* **효율적인 피라미드 트랜스포머(Efficient Pyramid Transformer, EPT) 채택**: 의미론적 분할을 위한 컨텍스트 모델링을 효율적으로 활용하기 위해 스파스 샘플링(sparse sampling) 전략을 적용했습니다.
* **공간 브랜치(Spatial Branch) 도입**: 입력 적응형 정보(input-adaptive information)를 제공하고 최종 분할 마스크 예측을 위해 객체 경계를 개선하는 경량 공간 브랜치를 제안했습니다.
* **통합 프레임워크 UN-EPT 제시**: 컨텍스트 모델링과 경계 처리(boundary handling)를 동시에 고려하는 통합 프레임워크 UN-EPT를 선보였으며, ADE20K, Cityscapes, PASCAL-Context 세 가지 벤치마크 데이터셋에서 우수한 성능을 달성했습니다.

## 📎 Related Works

* **컨텍스트 모델링**: FCN [41] 이후, 피라미드 풀링 [70, 12], 전역 풀링 [65], 어텐션 메커니즘 [66] 등을 통해 컨텍스트 의존성을 탐색했습니다. 특히, GPU 메모리 제약으로 인해 대부분의 이전 작업은 마지막 컨볼루션 피처 위에 직접 어텐션을 학습했습니다. 본 연구는 스파스 샘플링 전략을 통해 계산 비용을 경감하고, 멀티-스케일 피라미드 레이어에 걸쳐 샘플링을 수행합니다.
* **경계 처리**: 의미론적 경계 지역화 [39] 또는 경계 분할 결과 개선 [4, 46]에 중점을 둔 연구들이 있었으나, 주로 고해상도 이미지에 설계되었으며 컨텍스트 모델링에는 덜 유용했습니다. SegFix [64]와 같이 모델에 구애받지 않는 경계 개선 메커니즘도 제안되었지만, 재학습이 필요했습니다. 본 연구는 동적 컨텍스트 쿼리를 제공하고 경계 정보를 활용하는 엔드-투-엔드(end-to-end) 학습 가능한 공간 브랜치를 제안합니다.
* **트랜스포머**: 기계 번역에서 처음 도입된 [48] 후 NLP [18]와 컴퓨터 비전 [75, 20, 72]에 널리 적용되었습니다. SETR [72]은 ViT [20]를 의미론적 분할에 직접 적용했으나, 바닐라(vanilla) 트랜스포머는 긴 시퀀스 길이에서 계산 및 메모리 소모가 컸습니다. SegFormer [52] 및 Swin Transformer [40]와 같은 동시 연구들은 MLP 디코더 및 쉬프트 윈도우를 사용하여 효율성을 개선했습니다. 본 연구는 자기(self) 및 교차(cross) 어텐션 계산 전략을 변경하고 경계 정보 모델링을 통합하여 분할에 더욱 적합하게 만들었습니다.

## 🛠️ Methodology

제안하는 UN-EPT 네트워크는 크게 컨텍스트 브랜치(Context Branch)와 공간 브랜치(Spatial Branch)의 두 가지 핵심 구성 요소로 이루어져 있습니다.

1. **효율적인 컨텍스트 모델링을 위한 트랜스포머 (EPT)**:
    * **스파스 샘플링(Sparse Sampling)**: 각 쿼리 픽셀이 정보가 풍부한 소수의 픽셀에만 어텐션하도록 강제하여, 기존 트랜스포머의 $O(N^2)$ 계산 복잡도를 $O(kN)$ (여기서 $N$은 시퀀스 길이, $k$는 샘플링 픽셀 수)로 줄입니다. 어텐션 가중치와 샘플링 오프셋($\Delta_n$)은 쿼리 피처에서 직접 학습됩니다.
    * **피라미드 피처(Pyramid Features)**: 백본 네트워크(예: ResNet, DeiT)의 여러 스테이지에서 추출된 멀티-스케일 피처 맵($\{X_l\}_{l=1}^L$)을 활용합니다. 이들은 하나의 긴 시퀀스 $X_{ms}$로 연결되어 트랜스포머 인코더에 입력됩니다. 각 쿼리 픽셀은 각 스케일의 피처 맵에서 $N$개의 샘플링된 픽셀에 어텐션하여, 총 $N \times L$ 픽셀에만 어텐션합니다. 위치 인코딩 및 스케일 인코딩이 추가되어 공간 정보가 제공됩니다.
    * **인코더-디코더 구조**: 인코더는 스파스 샘플링 기반 멀티-헤드 자기 어텐션 레이어와 피드 포워드 레이어로 구성됩니다. 디코더는 컨텍스트 쿼리를 입력으로 받아 자기 어텐션 후 인코더 출력($X_{enc}$)과 교차 어텐션을 수행하여 초기 분할 결과 $\hat{Y}$를 생성합니다.

2. **동적 학습 가능한 공간 브랜치(Dynamic Learnable Spatial Branch)**:
    * **동적 컨텍스트 쿼리**: 트랜스포머 디코더의 입력으로 사용되는 컨텍스트 쿼리는 고정된 임베딩 대신, 공간 브랜치에서 추출된 동적인 이미지 피처(원래 이미지의 1/8 해상도)를 사용합니다. 이는 각 입력 이미지에 적응하여 풍부하고 상세한 공간 정보를 제공합니다.
    * **경계 개선(Boundary Refinement)**: 공간 브랜치에서 얻은 피처를 사용하여 두 개의 추가 헤드(boundary head, direction head)를 통해 경계 정보를 추출합니다.
        * **경계 헤드**: 이진 분류를 통해 경계 픽셀을 예측합니다 ($L_{bound}$ 손실).
        * **방향 헤드**: 각 경계 픽셀에 대해 해당 픽셀의 내부 방향을 이산적으로 예측합니다 ($L_{dir}$ 손실).
    * **최종 개선**: 예측된 방향 맵은 오프셋 맵으로 변환되며, 이를 사용하여 컨텍스트 브랜치의 초기 분할 결과 $\hat{Y}$를 이동 및 보간하여 개선된 최종 분할 마스크 $\hat{Y}_{ref}$를 생성합니다.
    * **총 손실 함수**: $L = \lambda_1 L_{CE}(Y, \hat{Y}) + \lambda_2 L_{CE}(Y, \hat{Y}_{ref}) + \lambda_3 L_{bound} + \lambda_4 L_{dir}$로 구성됩니다. ($L_{CE}$는 교차 엔트로피 손실)

## 📊 Results

* **ADE20K 데이터셋**:
  * ResNet50 백본 사용 시 mIoU 46.1을 달성하여 이전 SOTA인 CPNet (ResNet50)보다 1.6%p 높았습니다. ResNet101 기반의 기존 방법들과 경쟁적인 성능을 보였습니다.
  * 더 강력한 DeiT 백본 사용 시 mIoU 50.5를 달성하여, ImageNet22K에서 사전 학습된 SETR의 ViT-large 모델을 ImageNet1K에서 사전 학습된 DeiT-base 모델로 능가했습니다.
  * 정성적 결과에서 복잡한 클래스 환경에서도 컨텍스트 정보를 잘 모델링하고 작은 객체 분할에서 우수한 성능을 보였습니다.
* **Cityscapes 데이터셋**:
  * DeiT 백본 사용 시 mIoU 82.9 (validation set) 및 82.2 (test set)를 달성하여 대부분의 동시 연구들을 능가했습니다. 경계 아티팩트 처리가 개선되었습니다.
* **PASCAL-Context 데이터셋**:
  * DeiT 백본 사용 시 mIoU 55.2를 달성하여 컨텍스트 모델링에서 기존의 어텐션 메커니즘이나 컨텍스트 사전 지식을 사용하는 DANet, CPNet보다 우수했습니다.
* **효율성**:
  * 최상 모델(DeiT 백본)이 학습 시 8.5G의 적은 메모리를 소비했습니다.
  * 총 모델 파라미터는 94M으로, SETR (401M)보다 훨씬 적습니다.
  * GFLOPs는 99.1로, 비교 대상 중 가장 낮아 높은 계산 효율성을 보여주었습니다.

## 🧠 Insights & Discussion

* **통합 프레임워크의 효과**: UN-EPT는 컨텍스트 모델링과 경계 개선을 동시에 최적화하는 단일 프레임워크의 이점을 명확히 보여주었습니다. 특히, 다양한 클래스와 고해상도 이미지를 동시에 처리할 수 있는 능력이 입증되었습니다.
* **스파스 샘플링 및 피라미드 피처의 중요성**: 스파스 샘플링 전략과 멀티-스케일 피라미드 피처의 통합은 트랜스포머의 계산 부담을 크게 줄이면서도 장거리 컨텍스트 의존성을 효과적으로 포착할 수 있게 했습니다. 이는 복잡한 장면 이해 및 작은 객체 분할에 기여했습니다.
* **동적 공간 브랜치의 역할**: 고정된 쿼리 임베딩을 사용하는 기존 트랜스포머와 달리, 동적인 컨텍스트 쿼리를 생성하는 공간 브랜치는 입력 이미지의 고주파 세부 정보를 효과적으로 포착하고 경계 정제를 가능하게 하여 분할 품질을 향상시켰습니다.
* **효율성 및 실용성**: UN-EPT는 대규모 데이터셋(예: ImageNet22K)에서의 사전 학습이나 과도한 메모리 소모 없이도 SOTA 성능을 달성하여, 실제 시나리오에서의 실용성을 높였습니다. 이는 자원 제약이 있는 환경에서도 고급 의미론적 분할 모델을 배포할 수 있는 가능성을 제시합니다.
* **기존 효율적인 트랜스포머와의 차이**: NLP 분야의 Sparse Transformer, Longformer, Reformer 등과 비교했을 때, UN-EPT는 메모리 비용을 절감하면서도 의미론적 분할 태스크의 특성(복잡한 장면, 경계 처리)에 특화된 어텐션 및 경계 모델링을 통해 성능을 크게 향상시켰습니다.

## 📌 TL;DR

의미론적 분할은 컨텍스트 모델링과 경계 혼동 문제로 인해 어렵습니다. 기존 방법들은 둘 중 하나에 집중하며, 트랜스포머는 고해상도 이미지에 직접 적용하기에 비효율적입니다. 본 논문은 이러한 문제를 해결하기 위해 **UN-EPT(UNified Efficient Pyramid Transformer)**를 제안합니다. UN-EPT는 **스파스 샘플링 기반의 효율적인 피라미드 트랜스포머(EPT)**를 통해 메모리 효율적인 장거리 컨텍스트 모델링을 수행하고, **경량 공간 브랜치**를 통해 동적 컨텍스트 쿼리를 제공하며 경계 정보를 활용하여 분할 결과를 정제합니다. 이 엔드-투-엔드 학습 가능한 통합 프레임워크는 ADE20K, Cityscapes, PASCAL-Context 등 주요 벤치마크에서 **적은 메모리 사용량과 낮은 GFLOPs로 SOTA 성능**를 달성하며, 컨텍스트와 경계 신호를 동시에 최적화하는 효과를 입증했습니다.
