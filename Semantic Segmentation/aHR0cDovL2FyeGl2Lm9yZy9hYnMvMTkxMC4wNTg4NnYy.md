# A New Local Transformation Module for Few-shot Segmentation

Yuwei Yang, Fanman Meng, Hongliang Li, Qingbo Wu, Xiaolong Xu and Shuai Chen

## 🧩 해결할 문제

소수점 학습(Few-shot) 이미지 분할은 새로운 클래스의 객체 영역을 소수의 수동 주석만을 사용하여 분할하는 것을 목표로 합니다. 이 작업의 핵심 단계는 지원(Support) 이미지(주석이 달린 이미지)와 쿼리(Query) 이미지(주석이 없는 이미지) 간의 변환 모듈을 구축하여 지원 이미지의 분할 단서가 쿼리 이미지의 분할을 안내하도록 하는 것입니다. 기존 방법들은 전역(global) 단서를 기반으로 변환 모델을 형성하지만, 본 논문에서 변환에 매우 중요하다고 검증된 지역(local) 단서를 무시합니다. 핵심 과제는 새로운 클래스에 효율적으로 일반화될 수 있는 클래스에 구애받지 않는(class-agnostic) 변환 모듈을 설계하는 것입니다.

## ✨ 주요 기여

- 지역 단서(local cues)를 기반으로 하는 새로운 변환 모듈을 제안했습니다. 이 모듈은 지역 특징 간의 관계를 변환에 사용합니다.
- 네트워크의 일반화 성능을 향상시키기 위해 코사인 거리(cosine distance)를 기반으로 고차원 메트릭 임베딩 공간(high-dimensional metric embedding space)에서 관계 행렬을 계산합니다.
- 저수준 지역 관계를 고수준 의미론적 단서로 매핑하는 어려운 문제를 해결하기 위해, 지원 이미지의 주석 행렬의 일반화된 역행렬(generalized inverse matrix)을 사용하여 관계 행렬을 선형적으로 변환하는 비모수적(non-parametric) 및 클래스에 구애받지 않는 방법을 제안했습니다.
- 행렬 변환 결과는 고수준 의미론적 단서를 포함하는 어텐션 맵(attention map)으로 간주될 수 있으며, 이를 기반으로 간단하게 변환 모듈을 구축할 수 있습니다.
- 제안된 변환 모듈은 기존의 Few-shot 분할 프레임워크에서 변환 모듈을 대체할 수 있는 일반적인 모듈입니다.
- Pascal VOC 2012 데이터셋에서 제안된 방법의 효과를 검증했으며, 1-shot에서 mIoU 57.0%, 5-shot에서 60.6%를 달성하여 최신 기술(SOTA) 대비 각각 1.6% 및 3.5% 성능을 향상시켰습니다.

## 📎 관련 연구

- **기존 의미론적 분할(Semantic Segmentation):** FCN [1], DeepLab v3 [2]와 같이 대규모 주석 데이터에 의존하는 딥러닝 기반 방법들.
- **Few-shot 분할 방법:** OSVOS [10], OSLSM [3], co-FCN [4], SG-One [5], A-MCG [6], CA-Net [7] 등. 특히, CA-Net [7]과 SG-One [5]은 전역 단서 기반 변환에 중점을 두지만, 본 논문은 이와 대조적으로 지역 단서의 중요성을 강조합니다.
- **관계 모델링:** NON-Local [8] 모델에서 사용된 관계 행렬 개념을 모방하여 지역 특징 간의 관계를 구축합니다.
- **일반화된 역행렬 이론:** Rao, Mitra [19]의 이론을 활용하여 비정방 행렬의 변환 문제를 해결합니다.

## 🛠️ 방법론

제안된 프레임워크는 기존 Few-shot 분할 네트워크와 유사하게 지원 브랜치, 쿼리 브랜치 및 변환 모듈로 구성됩니다.

1. **특징 추출 (Feature Extraction):** Resnet50 [18]의 첫 세 레이어를 특징 추출 백본(backbone)으로 사용하여 보이지 않는 클래스에 대한 네트워크 일반화 성능을 향상시킵니다. 지원 및 쿼리 브랜치는 특징 추출 백본을 공유합니다.
2. **지원 특징 처리:** 지원 이미지의 특징 $F_s$는 주석 마스크 $G_s$에 의해 공간적으로 가중되어 $F'_s$를 얻습니다. 이 과정은 $F'_s(i,j) = F_s(i,j) \times G_s(i,j)$로 표현되며, $F'_s$가 전경 영역만 포함하도록 보장합니다.
3. **임베딩 공간 매핑:** 학습된 특징 $F_q$와 $F'_s$는 추가 컨볼루션 연산 $T_e$를 통해 고차원 임베딩 공간으로 매핑되어 각각 임베딩 특징 $E_q$와 $E_s$를 얻습니다. 이는 코사인 거리를 사용하여 특징 픽셀 간의 관계를 계산하기 위함입니다. 동시에, $F_q$는 컨볼루션 연산 $T_f$를 통해 $\hat{F}_q$로 학습됩니다.
4. **관계 행렬 ($R$) 계산:** 쿼리 이미지와 지원 이미지의 각 지역 특징 쌍 간의 관계를 모델링합니다. 임베딩 공간에서 코사인 유사도를 사용하여 관계 $R_{ij}$를 계산합니다:
   $$ R*{ij} = \frac{\langle E*{si}, E*{qj} \rangle}{\|E*{si}\|_2 \|E_{qj}\|_2} $$
   여기서 $E_{si}$는 $E_s$의 $i$번째 지역 정보, $E_{qj}$는 $E_q$의 $j$번째 지역 정보를 나타냅니다.
5. **일반화된 역행렬 기반 선형 변환:** 관계 행렬 $R$을 쿼리 이미지의 고수준 의미론적 정보인 어텐션 맵 $A$로 변환합니다. $G_s$의 일반화된 역행렬을 사용하여 $R$을 선형 변환합니다.
   $$ A = R \cdot [(G_s)^T (G_s (G_s)^T)^{-1}] $$
    이 과정은 지역 관계 행렬을 고수준 의미론적 정보로 변환하는 어려움을 극복하며, $A$는 직접적으로 얻어집니다.
6. **어텐션 기반 특징 필터링:** 얻어진 어텐션 맵 $A$ (0~1로 정규화된 $\hat{A}$)는 쿼리 이미지의 심층 특징 $\hat{F}_q$를 필터링하여 $\hat{F}'_q$를 얻습니다: $\hat{F}'_q(i,j) = \hat{F}_q(i,j) \times A(i,j)$.
7. **업샘(Upsam) 서브-네트워크:** $\hat{F}'_q$는 Upsam 서브-네트워크를 통해 최종 분할 마스크 $M$을 생성합니다. Upsam은 객체의 스케일 변화에 더 잘 대응하기 위해 ASPP [15]와 잔차 연결(residual connection) [18]을 도입합니다.
8. **손실 함수:** 세 가지 손실 함수를 결합하여 모델 학습을 감독합니다.
   - **분할 손실 ($L_m$):** 쿼리 이미지의 예측된 확률 맵 $M$에 대한 교차 엔트로피 손실.
   - **관계 행렬 손실 ($L_r$):** 학습된 관계 행렬 $R$과 실제 관계 행렬 $R_{truth}$ 간의 평균 제곱 오차 손실 ($R_{truth} = G_q \cdot G_s$).
   - **어텐션 맵 손실 ($L_a$):** 어텐션 맵 $A$를 분할 결과의 전경 확률 맵으로 간주하여 교차 엔트로피 손실로 감독.
   - **총 손실:** $L = \lambda_m L_m + \lambda_a L_a + \lambda_r L_r$.
9. **5-shot 확장:** 5개의 지원 이미지로부터 제공된 어텐션 맵들을 간단히 평균하여 결합합니다.

## 📊 결과

- **Pascal VOC 2012 데이터셋 평가:**
  - **1-shot mIoU:** 57.0% (CA-Net [7] 대비 1.6% 개선)
  - **5-shot mIoU:** 60.6% (CA-Net [7] 대비 3.5% 개선)
  - **1-shot FB-IoU:** 71.8%
  - **5-shot FB-IoU:** 74.6%
- **손실 함수 기여도 (1-shot mIoU 기준):**
  - $L_a$ (어텐션 맵 손실)는 성능을 1.1% 향상시켰습니다.
  - $L_r$ (관계 행렬 손실)는 성능을 1.0% 향상시켰습니다.
- **후처리 및 다중 스케일 전략 기여도 (1-shot mIoU 기준):**
  - DenseCRF [14]는 mIoU를 0.4% 향상시켰습니다.
  - 다중 스케일(Multi-scale) 평가 전략은 mIoU를 0.3% 향상시켰습니다.
- 정성적 결과(Subjective Result)도 제안된 방법이 객체를 성공적으로 분할함을 보여줍니다.

## 🧠 통찰 및 토론

- 이 연구는 Few-shot 분할에서 기존 방법들이 간과했던 지역 단서의 중요성을 성공적으로 입증했습니다. 전역 단서에만 의존하는 것은 지역적인 기하학적 관계 정보를 놓칠 수 있음을 시사합니다.
- 고차원 임베딩 공간에서 코사인 거리를 사용하여 지역 특징 간의 관계를 모델링하는 것은 네트워크의 일반화 능력을 크게 향상시키는 데 기여합니다.
- 지원 이미지의 주석 마스크의 일반화된 역행렬을 이용한 선형 변환은 저수준 지역 관계로부터 고수준 의미론적 어텐션 맵을 비모수적이고 클래스에 구애받지 않게 추출하는 혁신적인 접근 방식입니다. 이는 새로운 클래스에 대한 강력한 일반화 성능의 핵심입니다.
- 제안된 변환 모듈은 기존 Few-shot 분할 프레임워크에 유연하게 통합될 수 있는 범용성을 가지고 있어, 향후 연구에 광범위하게 적용될 수 있습니다.
- 성능 개선은 특히 5-shot 시나리오에서 더 두드러지게 나타나, 더 많은 주석이 주어질 때 제안된 방법의 우월성을 보여줍니다. 이는 주석 수가 늘어남에 따라 지역 정보가 더욱 풍부해지고 변환 모듈이 이를 더 잘 활용할 수 있음을 의미합니다.

## 📌 요약

소수점 학습 분할(Few-shot Segmentation)은 제한된 주석으로 새로운 클래스를 분할하는 도전적인 과제입니다. 기존 방법들이 전역 단서에만 집중하여 지역 정보를 간과하는 문제를 해결하기 위해, 본 논문은 지역 단서를 활용하는 새로운 변환 모듈을 제안합니다. 이 모듈은 고차원 임베딩 공간에서 코사인 유사도를 통해 지역 특징 간의 관계 행렬을 계산하고, 지원 이미지 주석의 일반화된 역행렬을 사용하여 이 관계를 고수준의 의미론적 어텐션 맵으로 선형 변환합니다. 이 비모수적이고 클래스에 구애받지 않는 변환은 분할 성능을 크게 향상시키며, Pascal VOC 2012 데이터셋에서 최신 기술 대비 우수한 결과를 달성했습니다.
