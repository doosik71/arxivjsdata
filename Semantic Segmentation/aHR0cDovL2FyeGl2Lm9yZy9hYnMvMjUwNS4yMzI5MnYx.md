# Federated Unsupervised Semantic Segmentation

Evangelos Charalampakis, Vasileios Mygdalis, Ioannis Pitas

## Problem to Solve

이 연구는 **연합 학습(Federated Learning, FL)**을 **비지도 의미론적 이미지 분할(Unsupervised Semantic Segmentation, USS)**에 적용하는 문제를 다룹니다. 기존 USS 방법론은 시각 재단 모델(visual foundation models)에서 픽셀 수준 특징을 추출하고 이를 자기지도 학습(self-supervised learning)을 통해 정제한 후 의미론적 클러스터로 그룹화하여 분할 마스크를 생성합니다. 이러한 아이디어를 연합 학습 환경에 확장하는 것은 다음과 같은 주요 난관에 부딪힙니다:

- **이질적인 데이터 분포(heterogeneous data distributions)**: 분산된 클라이언트들 간의 데이터 분포가 상이하여 특징 표현(feature representation)과 클러스터 중심(cluster centroid)을 정렬하는 것이 매우 어렵습니다.
- **감독 부재(absence of supervision)**: 지도 학습(supervised learning) 시나리오와 달리 픽셀별 레이블이 없기 때문에, 의미론적으로 유사한 객체들의 표현을 모든 클라이언트에서 동일한 목표값으로 "밀어넣는" 것이 불가능합니다.
- **기존 FL의 한계**: 현재 연합 학습 기반의 의미론적 분할 연구는 대부분 지도 학습 시나리오에만 적용되어 데이터 주석 부족 및 개인 정보 보호 제약이 있는 환경에는 적용하기 어렵습니다.

## Key Contributions

이 연구는 위에서 언급된 문제들을 해결하기 위해 다음과 같은 핵심적인 기여를 합니다:

- **기존 연합 이미지 분할 문헌의 한계점 규명**: 주석된 이미지 데이터에 대한 의존성을 지적하여, 개인 정보 보호가 중요한 데이터 환경에서의 적용 제한을 명확히 합니다.
- **FUSS (Federated Unsupervised image Semantic Segmentation) 프레임워크 제안**: 사람의 감독 없이 효율적인 연합 이미지 분할 훈련을 가능하게 하는 **레이블 없는(label-free)** 연합 학습 프레임워크를 도입합니다. FUSS는 비지도 표현 학습과 클러스터링 기반의 의미론적 집계를 결합합니다.
- **새로운 집계 전략 FedCC (Federated Centroid Clustering) 개발**: 연합 비지도 분할에 특화된 `FedCC`를 제안합니다. `FedCC`는 클라이언트별 분할 헤드(segmentation heads)와 전역 의미론적 프로토타입(semantic class prototypes)의 동시 최적화를 지원하여 분산 환경에서 효과적인 엔드-투-엔드 학습을 가능하게 합니다.
- **광범위한 실험 및 성능 입증**: 실제 이미지 의미론적 분할 데이터셋에 대한 광범위한 실험을 통해 `FUSS`와 `FedCC`가 로컬 DNN 훈련 및 전통적인 FL 집계 전략의 확장보다 **일관되게 뛰어난 성능**을 보임을 입증합니다. 이는 i.i.d. 및 non-i.i.d. 연합 시나리오 모두에서 확장성과 개인 정보 보호를 유지하면서 달성되었습니다.

## Methodology

`FUSS`는 표준 연합 학습 패러다임을 비지도 의미론적 분할 설정으로 확장합니다. 각 클라이언트는 독립적으로 모델을 훈련하며, 주기적으로 업데이트된 매개변수와 중심점(centroids)을 중앙 서버에 전송하고, 서버는 이를 집계하여 전역 모델을 클라이언트들에게 다시 전송합니다.

### 1. 로컬 훈련 (`Local Training`)

- **특징 추출**: 각 클라이언트는 **고정된(frozen)** **시각 재단 모델(VFM)** (`DINO` 모델 기반) 인코더를 사용하여 이미지에서 의미론적으로 풍부한 픽셀 임베딩(`Z`)을 추출합니다. 이 VFM은 미리 학습되어 있어 자원 제약이 있는 환경에서도 효율적인 훈련을 가능하게 합니다.
- **분할 헤드 최적화**: 경량화된 학습 가능한 투영 헤드(`S_k`)가 `Z`를 분할 임베딩 공간(`H_k`)으로 매핑합니다.
- **로컬 손실 함수**: 총 로컬 손실 `L_local`은 두 가지 구성 요소의 합으로 구성됩니다:
  - **대응 증류 손실(`L_corr`)**: `L_corr(X_k_i, X_k_j) = - Σ_{h,w,m,n} (A_{k,i,j}^{(h,w,m,n)} - b) Q_{k,i,j}^{(h,w,m,n)}`
    - `A`는 원본 VFM 특징(`Z`) 간의 코사인 유사성 텐서이고, `Q`는 투영된 임베딩(`H`) 간의 코사인 유사성 텐서입니다. 이 손실은 분할 헤드가 VFM 특징에 이미 존재하는 의미론적 일관성을 강화하도록 유도합니다.
  - **클러스터링 손실(`L_cluster`)**: `L_cluster = Σ_{i,h,w} ||H_{i}^{(h,w)} - m_{i}^{(h,w)}||^2 + λ · Σ_{c≠c'} s(m_c, m_{c'})`
    - 클러스터 내부 분산(intra-cluster variance)을 최소화하고 클러스터 간 유사성(inter-cluster similarity)에 페널티를 부과하여, 로컬 중심 행렬 `M_k`가 업데이트되도록 합니다. 이로써 콤팩트하고 잘 분리된 프로토타입이 형성됩니다.

### 2. 연합 집계 전략 (`Federated Aggregation Strategies`)

각 클라이언트는 로컬 분할 헤드(`θ_S_k`)와 중심 행렬(`M_k`)을 서버에 전송합니다.

- **확장된 연합 평균 (`Extended Federated Averaging`)**:

  - 분할 헤드와 중심 행렬 모두를 가중 평균(클라이언트 데이터셋 크기 `N_k`에 비례하는 `α_k = N_k / N`)하여 집계합니다.
  - `θ_S = Σ_{k∈K} α_k θ_S_k`
  - `M = Σ_{k∈K} α_k M_k`
  - 이 방법은 간단한 기준선 역할을 하지만, 클라이언트별 중심점 인덱스가 동일한 의미 클래스에 대응된다는 암묵적인 가정을 합니다.

- **연합 중심 클러스터링 (`Federated Centroid Clustering, FedCC`) - 핵심 기여**:
  - 각 클라이언트에서 학습된 프로토타입(`m_k_c`)들을 한데 모아(`m_pool`), 의미론적 정렬을 가정하지 않고 전역적으로 클러스터링하여 새로운 전역 프로토타입 행렬 `M`을 구성합니다.
  - **FedCC - kMeans Clustering**: 서버가 `m_pool`에 k-평균 클러스터링을 적용하여 `|C|`개의 클러스터 중심을 생성하고, 이를 전역 프로토타입으로 사용합니다. 이는 구조적으로 유사한 클라이언트 프로토타입을 그룹화하여 정렬을 촉진합니다.
  - **FedCC - Maximin Prototype Selection**: 의미론적 다양성을 장려하기 위해, 각 프로토타입이 이전에 선택된 모든 프로토타입과의 최소 거리를 최대화하도록 선택합니다. 이는 프로토타입 붕괴를 방지하고 특징 공간에서의 최대 분리를 강제하여 작은 객체나 배경 영역에 의해 지배되는 클래스에 특히 유용합니다.
  - 두 `FedCC` 변형 모두 `θ_S`는 확장된 연합 평균 방식을 통해 업데이트됩니다.

## Results

`FUSS`는 Cityscapes (크로스-사일로), CocoStuff (극단적인 non-i.i.d.), IPS (실제 산업용 파이프라인 이진 분할) 데이터셋에서 평가되었습니다. 주요 평가 지표는 **mIoU (Mean Intersection-over-Union)**이며, 훈련 중에는 정답 레이블을 사용하지 않고 평가에만 사용합니다.

- **종합 성능**: `FedAvg+FedCC`는 Cityscapes에서 평균 `21.72 mIoU`, IPS에서 `84.87 mIoU`를 달성하여 중앙 집중식 모델의 성능에 근접했습니다. 이는 로컬 훈련 및 다른 전통적인 FL 방식 (FedProx, FedMoon)의 확장 버전보다 **일관되게 우수한 성능**을 보였습니다.
- **Non-i.i.d. 환경에서의 강건성**: CocoStuff 데이터셋의 이질적인 분포(18 클라이언트, Dirichlet `α=0.5`)에서 `FedAvg+FedCC`는 `25.39 mIoU`를 달성하여 중앙 집중식 모델(`25.41 mIoU`)에 거의 필적하며, 다른 모든 방법을 능가했습니다.
- **정성적 분석**: `FedCC`는 이질적인 시나리오에서도 구조적으로 식별 가능한 중심점들을 생성하며, `FedAvg`가 프로토타입들을 혼란스럽게 만드는 경향이 있는 반면 `FedCC`는 **클래스 간 분리도를 크게 유지**하는 것을 시각적으로 확인했습니다.
- **모듈별 기여 분석 (Ablation Study)**: 명시적으로 프로토타입을 정렬하는 것(`C` 모듈)이 인코더 평균(`E` 모듈) 없이도 유익함을 확인했습니다. 이진 분할(IPS)에서는 `FedCC-KMeans`가 최상의 성능을 보였고, 작은 객체와 의미론적 클러스터가 많은 다중 클래스(Cityscapes)에서는 `FedCC-Maximin`이 더 효과적이었습니다.

결론적으로, `FUSS`는 최소한의 통신으로 정확하고 분산된 분할을 가능하게 하며, 제안된 집계 전략은 데이터 복잡성과 연합 설정 전반에 걸쳐 **확장 가능하고 강건함**을 입증했습니다.
