# A LOCATION-SENSITIVE LOCAL PROTOTYPE NETWORK FOR FEW-SHOT MEDICAL IMAGE SEGMENTATION

Qinji Yu, Kang Dang, Nima Tajbakhsh, Demetri Terzopoulos, Xiaowei Ding

## 🧩 Problem to Solve

의료 영상 분할(medical image segmentation) 분야에서 딥러닝은 큰 성공을 거두었지만, 이는 방대한 양의 고비용 전문가 주석 데이터에 의존합니다. 소수 학습 분할(few-shot segmentation)은 이러한 데이터 부족 문제를 해결하고자 적은 수의 레이블링된 예제로부터 지식을 전이 학습하는 것을 목표로 합니다. 특히, 많은 의료 영상 양식에서 강한 공간적 사전 지식(spatial priors)이 존재하는데, 이 정보를 효과적으로 활용하여 제한된 데이터로도 고성능 의료 영상 분할을 수행하는 것이 주요 문제입니다.

## ✨ Key Contributions

* 소수 학습 의료 영상 분할에 공간 배치 정보(spatial layout information)를 통합하는 **위치 감지 로컬 프로토타입 네트워크(location-sensitive local prototype network)**를 제안하여, 이러한 정보 통합의 상당한 이점을 입증했습니다.
* 전역 프로토타입(global prototype)으로 전체 이미지를 분할하는 어려운 문제를 로컬 프로토타입(local prototype)으로 지역별 분할하는 쉬운 하위 문제로 나누어 성능을 크게 향상시켰습니다.
* 그리드 크기(grid size) 및 기타 주요 매개변수에 대한 철저한 분석을 수행했습니다.
* VISCERAL CT 영상 데이터셋에서 장기 분할(organ segmentation)에 대해 기존 최첨단(state-of-the-art) 방법보다 평균 Dice 계수(Dice coefficient)에서 10% 더 높은 성능을 달성하여 새로운 최첨단 기록을 수립했습니다.

## 📎 Related Works

* **소수 학습 의미론적 분할(Few-shot semantic segmentation):** PANet [7], SENet [10], CANet [8] 등 최근 컴퓨터 비전 분야에서 활발히 연구되고 있는 주제입니다.
* **프로토타입 기반 네트워크(Prototype-based networks):** Wang et al. [7], Dong and Xing [6] 등의 연구에서 클래스별 프로토타입을 학습하여 유사성을 기반으로 분할을 수행하는 방식을 사용했습니다.
* **의료 영상 특화 소수 학습 분할:** Roy et al. [10]은 Squeeze-Excitation 모듈을 활용하여 지원(support) 및 쿼리(query) 영상 간의 상호작용을 구현했습니다. Ouyang et al. [16]은 의료 영상의 전경-배경 불균형 문제를 해결하기 위해 적응형 로컬 프로토타입 풀링 모듈(adaptive local prototype pooling module)을 제안했습니다.
* **본 연구의 차별점:** 기존 프로토타입 기반 연구들이 주로 전역적(global) 정보나 일반적인 로컬 정보를 활용한 반면, 본 연구는 의료 영상의 고유한 특성인 **명시적인 공간 배치 정보**를 로컬 프로토타입에 통합하여 성능 향상을 이끌어냈습니다.

## 🛠️ Methodology

본 연구의 위치 감지 로컬 프로토타입 네트워크는 크게 두 단계로 구성됩니다:

1. **위치 감지 로컬 프로토타입 추출(Location-Sensitive Local Prototype Extraction):**
    * 입력 영상은 겹치는(overlapping) 그리드 $G = \{g_m\}_{m=1}^{n_g}$로 균일하게 분할됩니다. 각 그리드 $g_m$은 $\alpha w \times \alpha h$ 크기를 가집니다.
    * 지원 영상(support images)은 특징 인코더(feature encoder)를 통해 특징 맵(feature maps) $F^s_i$을 생성합니다.
    * 각 그리드 $g_m$과 클래스 $c$에 대한 위치 감지 로컬 프로토타입 $p^s_{c,g_m}$은 지원 영상의 마스크를 사용하여 그리드 내에서 마스크된 평균 풀링(masked average pooling)을 통해 계산됩니다:
        $$ p^s_{c,g_m} = \frac{1}{k} \sum_{i=1}^{k} \frac{\sum_{(x,y) \in g_m} F^s_i(x,y)M^s_{i,c}(x,y)}{\sum_{(x,y) \in g_m} M^s_{i,c}(x,y)} $$
        여기서 $M^s_{i,c}(x,y)$는 지원 영상 $i$의 클래스 $c$에 해당하는 마스크입니다. 배경 클래스 프로토타입 $p^s_{0,g_m}$도 유사하게 계산됩니다.
    * 이 프로토타입은 특정 그리드 $g_m$에 연결되어 있어 위치에 민감하며, 해당 그리드 내의 정보만 사용하도록 제약되어 지역 정보 손실을 방지합니다.

2. **그리드 기반 소수 학습 분할(Grid-Based Few-shot Segmentation):**
    * 지원 영상과 쿼리 영상(query images)이 유사한 공간 배치를 가진다고 가정합니다.
    * 쿼리 영상의 각 픽셀 $(x,y)$의 특징 벡터 $F^q_j(x,y)$는 해당 위치에 영향을 미치는 여러 그리드 $\Omega$에 매핑될 수 있습니다.
    * 쿼리 특징 벡터와 지원 프로토타입 세트 $P$ 간의 유사도 점수 $\text{sim}(F^q_j(x,y), P)$는 해당 픽셀이 속한 모든 그리드에 대한 코사인 유사도(cosine similarity) 중 최댓값으로 계산됩니다:
        $$ \text{sim}(F^q_j(x,y), P) = \max_{g_m \in \Omega} (\text{cos}(F^q_j(x,y), p^s_{c,g_m})) $$
    * 이 유사도 점수는 소프트맥스(softmax) 연산을 통해 클래스별 확률 맵 $P^q_{j,c}(x,y)$으로 변환됩니다.
    * 네트워크는 표준 교차 엔트로피 손실(cross-entropy loss) $L_{ce}(P^q, M^q)$을 사용하여 엔드-투-엔드(end-to-end)로 학습됩니다.

* **실험 설정:** VISCERAL CT 데이터셋을 사용하였으며, ResNet-50을 특징 인코더로 사용하고 ImageNet [19]으로 사전 학습했습니다. 그리드 스케일 $\alpha=1/8$을 최적 값으로 설정했습니다.

## 📊 Results

* **최첨단 성능 달성:** VISCERAL CT 데이터셋의 6개 장기 클래스 분할 실험에서 평균 Dice 계수 66.7%를 달성하여 SENet [10](56.7%) 및 PANet [7](30.7%)을 크게 능가하며 새로운 최첨단 성능을 확립했습니다.
* **추가 클래스 활용의 효과:** 훈련 시 더 많은 장기 클래스(14개 추가 클래스)를 활용했을 때, 평균 Dice 계수가 70.3%로 추가 개선되었습니다. 이는 모델의 클래스 불가지론적(class-agnostic) 일반화 능력을 향상시킵니다.
* **공간 정보 통합의 중요성 (Ablation Study):**
  * **그리드 스케일($\alpha$)의 영향:** 최적 그리드 스케일인 $1/8$에서 가장 높은 성능을 보였으며, $1/16$이나 $1/4$로 설정했을 때 성능이 하락했습니다. $\alpha=1$ (전체 이미지를 하나의 그리드로 간주, 즉 위치 정보 미활용)인 경우 Dice 계수가 30.3%로 급격히 떨어져 위치 정보의 중요성을 명확히 입증했습니다.
  * **겹치는 그리드의 이점:** 겹치는 그리드를 사용했을 때(70.3%) 비겹치는 그리드(60.2%)보다 훨씬 높은 성능을 보여 겹치는 그리드의 효과를 확인했습니다.
* **공간 정렬 불량에 대한 강건성:** 간(liver), 비장(spleen), 신장(kidney)과 같은 장기에 대해 지원 및 쿼리 마스크 간에 공간적 중첩이 거의 없는 경우(alignment Dice < 40%)에도 분할 Dice 점수가 60% 이상으로 유지되는 등 상당한 공간 정렬 불량에 대한 강건성을 보였습니다. 다만, 작고 주변 구조와 시각적으로 유사한 요근(psoas)에서는 성능이 상대적으로 낮았습니다.

## 🧠 Insights & Discussion

* **공간 사전 지식의 결정적 역할:** 본 연구의 핵심 통찰은 의료 영상에서 흔히 나타나는 강한 공간적 사전 지식(spatial priors)을 소수 학습 분할에 효과적으로 통합하는 것이 성능 향상에 결정적인 영향을 미친다는 것입니다. 로컬 프로토타입을 통해 공간 정보를 인코딩함으로써 복잡한 분할 문제를 더 관리하기 쉬운 지역 하위 문제로 분할할 수 있습니다.
* **로컬 프로토타입의 이점:** 전역 프로토타입 방식과 달리, 로컬 프로토타입은 각 그리드 내의 정보만 활용하도록 제약되어 배경 클래스와 같이 공간적으로 이질적인 영역에서 특징이 부당하게 평균화되는 것을 방지합니다. 이는 고품질 프로토타입 구성에 필수적입니다.
* **실용적 함의:** 의료 영상 데이터 주석의 어려움을 고려할 때, 적은 수의 레이블링된 데이터만으로도 높은 분할 성능을 달성할 수 있는 본 접근 방식은 임상 환경에서의 적용 가능성이 높습니다.
* **강건성과 한계:** 특정 장기에 대한 공간 정렬 불량에 대한 강건성을 보였지만, 시각적으로 판별하기 어려운 작은 해부학적 구조(예: 요근)에 대해서는 성능 개선의 여지가 남아있습니다.

## 📌 TL;DR

**문제:** 의료 영상 분할은 대량의 주석 데이터를 요구하지만, 소수 학습은 이를 제한된 데이터로 해결하고자 합니다. 이 과정에서 의료 영상의 고유한 **공간적 사전 지식**을 활용하는 것이 중요합니다.
**방법:** 본 연구는 **위치 감지 로컬 프로토타입 네트워크**를 제안합니다. 이는 이미지를 겹치는 그리드로 나누고, 각 그리드에서 위치에 민감한 로컬 프로토타입을 추출하여 쿼리 이미지의 픽셀 단위 분할에 활용하는 방식입니다. 이를 통해 전체 이미지 분할을 지역별 하위 문제로 단순화합니다.
**결과:** VISCERAL CT 데이터셋에서 기존 최첨단 대비 평균 Dice 계수 10%의 현저한 성능 향상을 달성했습니다. 심층적인 제거 연구(ablation study)를 통해 공간 정보를 통합하는 것이 성능에 결정적인 영향을 미치며, 제안된 방법이 특정 장기에 대한 공간 정렬 불량에도 강건함을 입증했습니다.
