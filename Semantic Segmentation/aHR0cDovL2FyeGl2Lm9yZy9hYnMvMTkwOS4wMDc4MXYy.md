# Adversarial Learning and Self-Teaching Techniques for Domain Adaptation in Semantic Segmentation

Umberto Michieli, Matteo Biasetton, Gianluca Agresti, and Pietro Zanuttigh

## 🧩 Problem to Solve

자율 주행 시스템에서 시맨틱 분할(semantic segmentation)은 주변 환경을 이해하는 데 핵심적인 역할을 하지만, 픽셀 수준의 주석(annotation)이 있는 대규모 학습 데이터셋이 필요하다는 단점이 있습니다. 이러한 데이터는 취득 및 라벨링에 많은 비용과 노력이 소요됩니다. 비디오 게임에서 생성된 합성(synthetic) 데이터를 사용하여 네트워크를 학습하는 방식이 제안되었으나, 합성 데이터와 실제 세계 데이터 사이의 **도메인 차이(domain shift)**로 인해 성능에 제약이 발생합니다. 본 논문은 실제 세계 데이터에 대한 라벨 없이도 합성 데이터로 학습된 시맨틱 분할 네트워크의 성능을 효과적으로 향상시킬 수 있는 **비지도 도메인 적응(Unsupervised Domain Adaptation, UDA)** 전략을 제안하여 이 문제를 해결하고자 합니다.

## ✨ Key Contributions

- 시맨틱 분할을 위한 새로운 비지도 도메인 적응(UDA) 전략을 도입했습니다.
- 제안하는 학습 전략은 세 가지 핵심 구성 요소에 의해 구동됩니다:
  - 라벨이 지정된 합성 데이터에 대한 표준 지도 학습 손실.
  - 라벨이 있는 합성 데이터와 라벨이 없는 실제 데이터를 모두 활용하는 적대적 학습(adversarial learning) 모듈.
  - 라벨이 없는 실제 데이터에 적용되는 자가 학습(self-teaching) 전략.
- 자가 학습 전략을 크게 개선했습니다:
  - 이전 연구의 하드 임계값 마스크 대신, 판별자(discriminator)의 출력을 신뢰도 측정값으로 사용하여 손실 함수에 대한 위치별 가중치로 적용했습니다.
  - 분할 신뢰도를 기반으로 신뢰 영역을 확장하고 형상을 더 잘 표현하기 위한 새로운 **영역 성장(region growing) 프레임워크**를 도입했습니다. 이는 특히 가장자리 영역과 작은 객체에 대한 성능을 향상시킵니다.
  - 클래스 빈도수에 비례하여 자가 학습 손실에 가중치를 부여하여 희귀 클래스(작은 객체 및 구조)의 성능 저하를 방지했습니다.
- 합성 데이터셋(GTA5, SYNTHIA)으로 학습된 분할 네트워크를 실제 데이터셋(Cityscapes, Mapillary)에 적응시키는 데 효과적임을 입증하며 최첨단(state-of-the-art) 결과를 달성했습니다.

## 📎 Related Works

- **시맨틱 분할:** FCN [8], DilatedNet [9], PSPNet [10], DeepLab [4] 등 인코더-디코더 기반의 최신 방법론들을 언급하며, 본 연구에서는 DeepLab v2를 생성자(generator) 네트워크로 사용합니다. Cityscapes [13], CamVid [19], Mapillary [14]와 같은 대규모 픽셀 단위 주석 데이터셋이 사용됩니다.
- **준지도 학습(Semi-supervised Learning):** 약하게 주석이 달린 데이터(예: 이미지 단위 라벨, 바운딩 박스)를 활용하거나 [20-27], 일부 데이터만 라벨링되고 나머지는 라벨이 없는 경우 [5, 6, 21, 28, 29]를 다룹니다. 특히, [5], [6]은 픽셀 수준에서 예측된 확률 맵과 실제 분할 맵을 구별하는 Fully Convolutional Discriminator(FCD)를 활용합니다.
- **비지도 도메인 적응(UDA):** [3]은 본 연구의 이전 버전으로, [5]에서 시작하여 도메인 적응 시나리오(합성 데이터에서 실제 데이터로)에 적용했습니다. 합성 데이터셋으로는 GTA5 [1] 및 SYNTHIA [2]가 주로 사용됩니다. 다른 UDA 기술로는 GANs 기반의 데이터 증강 [35-39], 특징 정렬(feature alignment) [48], 커리큘럼 학습(curriculum learning) [16], 출력 공간 정렬(output space alignment) [50, 51], 증류 손실(distillation loss) [17, 52], 엔트로피 최소화(entropy minimization) [57], 사이클 일관성(cycle consistency) [11, 58] 등이 있습니다.
- **영역 성장(Region Growing):** 시맨틱 분할에서 도메인 적응에 최근 적용된 기술로, [26]에서는 분할 네트워크를 학습시켜 판별 영역을 먼저 분할하고 점진적으로 픽셀 수준 감독을 증가시킵니다. 본 연구에서는 이 기술을 신뢰 맵 정제에 활용합니다.

## 🛠️ Methodology

제안하는 프레임워크는 **생성자(G)** (DeepLab v2 네트워크)와 **판별자(D)** (Fully Convolutional Discriminator, FCD)로 구성됩니다. G는 시맨틱 분할을 수행하며, D는 G가 생성한 분할 맵과 실제 정답 분할 맵을 구별합니다. G의 학습은 세 가지 손실 함수를 최소화하는 방향으로 진행됩니다.

1. **지도 학습 손실 ($L_{G,1}$):**

   - 라벨이 있는 합성(소스) 데이터 $X_s^n$에 대해서만 계산되는 표준 다중 클래스 교차 엔트로피(cross-entropy) 손실입니다.
   - $$ L*{G,1} = - \sum*{p \in X*s^n} \sum*{c \in C} Y*s^n(p)*{[c]} \cdot \log(G(X*s^n)(p)*{[c]}) $$
   - 여기서 $Y_s^n$은 원-핫 인코딩된 정답 분할입니다.

2. **적대적 손실 ($L_{G,2}^{s,t}$):**

   - G가 D를 속여 G의 출력이 정답처럼 보이도록 훈련시킵니다.
   - 합성(소스) 데이터 $X_s^n$와 라벨이 없는 실제(타겟) 데이터 $X_t^n$ 모두에 대해 계산됩니다. $L_{G,2}^s$는 소스 데이터에, $L_{G,2}^t$는 타겟 데이터에 해당합니다.
   - $$ L*{G,2}^{s,t} = - \sum*{p \in X*{s,t}^n} \log(D(G(X*{s,t}^n))(p)) $$
   - D는 G의 출력($G(X_{s,t}^n)$)을 '가짜'(0)로, 실제 정답($Y_s^n$)을 '진짜'(1)로 분류하도록 학습됩니다 ($L_D$ 손실 사용).

3. **자가 학습 손실 ($L_{G,3}$):**
   - D의 출력을 G의 예측 신뢰도 측정값으로 해석하고, 이 신뢰도를 이용해 라벨이 없는 실제 데이터 $X_t^n$에 대해 자가 학습(self-training)을 수행합니다.
   - G의 예측 중 D가 '신뢰할 수 있다'고 판단한 영역을 원-핫 인코딩($\hat{Y}_n$)으로 변환하여 자체 생성된 정답으로 사용합니다.
   - $$ L*{G,3} = - \sum*{p \in X*t^n} \sum*{c \in C} D*R(X_t^n)(p) \cdot W_s^c \cdot \hat{Y}\_n(p)*{[c]} \cdot \log(G(X*t^n)(p)*{[c]}) $$
   - **신뢰도 정제($D_R(X_t^n)$):** D의 출력을 기반으로 신뢰 영역을 추출한 다음, 영역 성장(region growing) 절차를 통해 해당 영역을 확장하여 $m_{R_{T_u}}$ 마스크를 생성합니다. 최종 가중치 $D_R(X_t^n) = m_{R_{T_u}} \cdot D(G(X_t^n))$는 신뢰 영역에 대해 D의 출력을 소프트 가중치로 사용하고, 그 외 영역은 0으로 설정합니다.
     - $T_u$는 D 출력을 기반으로 신뢰 픽셀을 선택하는 초기 임계값.
     - $T_R$은 G의 출력 확률을 기반으로 인접 픽셀로 신뢰 영역을 확장하는 임계값.
   - **클래스 가중치($W_s^c$):** 소스 도메인에서의 클래스 빈도에 비례하여 가중치를 부여하여 드물고 작은 객체(예: '교통 신호', '기둥')가 학습에서 무시되지 않도록 합니다. $W_s^c = 1 - \frac{\sum_n |p \in X_s^n \land p \in c|}{\sum_n |p \in X_s^n|}$로 정의되며, 학습 중에는 고정됩니다.

- **전체 손실 함수:** G의 전체 손실은 각 손실의 가중 평균으로 계산됩니다:
  $$ L*{full} = L*{G,1} + w*{s,t} L*{G,2}^{s,t} + w' L\_{G,3} $$
- **학습 과정:** $L_{G,3}$는 초기 5000 스텝 동안 비활성화($w'=0$)하여 D가 고품질 신뢰 맵을 생성하도록 합니다. 총 20000 스텝 동안 학습을 진행합니다.

## 📊 Results

- **데이터셋:** 합성 데이터(소스)는 GTA5 및 SYNTHIA, 실제 데이터(타겟, 학습 시 라벨 없음)는 Cityscapes 및 Mapillary를 사용했습니다. 평가는 각 데이터셋의 유효성 검사 세트에서 수행했습니다.
- **평가 지표:** mean Intersection over Union (mIoU).
- **주요 결과:**
  - **GTA5 $\rightarrow$ Cityscapes:** 지도 학습만으로 27.9% mIoU를 얻었으나, 제안하는 UDA 전략을 적용하여 **33.3% mIoU**로 향상(5.4% 증가). 이는 기존 최신 방법론(Hung et al. [5]의 29.0%, Biasetton et al. [3]의 30.4%)보다 우수한 성능입니다.
  - **SYNTHIA $\rightarrow$ Cityscapes:** SYNTHIA 데이터의 현실성이 GTA5보다 낮아 초기 mIoU는 25.4%였으나, UDA 적용 후 **31.3% mIoU**로 향상(5.9% 증가). GTA5에서와 유사한 개선 폭을 보이며, 다른 데이터셋에도 일반화됨을 입증했습니다.
  - **GTA5 $\rightarrow$ Mapillary:** 지도 학습 32.7% mIoU에서 제안하는 방법론 적용 후 **38.5% mIoU**로 크게 향상(5.8% 증가).
  - **SYNTHIA $\rightarrow$ Mapillary:** 지도 학습 26.6% mIoU에서 UDA 적용 후 **32.0% mIoU**로 향상(5.4% 증가).
- **정성적 결과:** 제안하는 방법은 작은 객체와 구조를 잘 감지하고 도로 및 큰 요소에 대한 신뢰할 수 있는 인식을 보여줍니다. 특히, 영역 성장 및 클래스 가중치 덕분에 도로 표면의 노이즈와 작은 객체의 부정확한 경계 문제가 크게 개선되었습니다.
- **어블레이션 스터디(Ablation Study):**
  - $L_{G,2}$ (적대적 손실) 추가 시 mIoU가 1.5-2% 증가합니다.
  - $L_{G,3}$ (자가 학습 손실) 추가 시 특히 SYNTHIA에서 약 3%의 큰 개선을 보입니다.
  - 영역 성장 전략($m_{R_{T_u}}$)은 GTA5에서 2.2% 증가하며, 중대형 객체 처리 능력을 향상시킵니다.
  - 판별자 출력을 자가 학습 손실의 가중치로 사용하는 것은 GTA5에서 2.4%의 좋은 개선을 보입니다.
  - 클래스 가중치($W_c^t$)는 희귀 클래스의 성능 안정화에 기여하며 전체 성능을 약간 더 향상시킵니다.
  - 모든 구성 요소가 결합될 때 최상의 성능을 달성합니다.

## 🧠 Insights & Discussion

- 제안된 UDA 전략은 적대적 학습과 개선된 자가 학습(영역 성장 및 클래스 빈도 가중치 포함)의 시너지를 통해 합성-실제 도메인 간의 격차를 효과적으로 줄여 시맨틱 분할 성능을 크게 향상시켰습니다.
- **영역 성장 모듈**은 판별자의 신뢰도 맵을 실제 이미지의 분할 출력과 결합하여 신뢰 영역을 확장하고 객체 형상을 더욱 정밀하게 표현함으로써, 특히 중대형 객체 및 경계선 인식 능력을 강화했습니다.
- **클래스 빈도 가중치**는 '교통 신호', '기둥'과 같은 작고 드문 클래스들이 학습 과정에서 간과되지 않도록 보장하여, 다양한 객체 유형에 대한 모델의 견고성을 입증했습니다. 이는 실제 데이터의 클래스 분포가 합성 데이터와 정확히 일치하지 않더라도 성능이 안정적임을 보여줍니다.
- 이 방법은 GTA5와 SYNTHIA 같은 다양한 합성 소스 데이터셋과 Cityscapes 및 Mapillary 같은 다양한 실제 타겟 데이터셋에 대해 일관된 성능 향상을 보여주며, 높은 일반화 능력을 입증했습니다.
- 향후 연구에서는 다른 백본 네트워크에서의 적용 가능성을 탐색하고, 생성 모델을 활용하여 프레임워크에 입력될 더 사실적이고 정제된 합성 훈련 데이터를 생성하는 방향으로 진행될 수 있습니다.

## 📌 TL;DR

시맨틱 분할 모델은 고비용의 라벨링 문제에 직면해 있으며, 합성 데이터는 대안이지만 도메인 차이가 존재합니다. 본 논문은 이 문제를 해결하기 위해 적대적 학습과 개선된 자가 학습 전략을 결합한 비지도 도메인 적응(UDA) 방법을 제안합니다. 특히, 판별자 신뢰도를 기반으로 신뢰 영역을 확장하는 영역 성장 기법과 희귀 클래스의 성능을 강화하기 위한 클래스 빈도 가중치가 핵심 기여입니다. 이 방법은 라벨링되지 않은 실제 데이터를 사용하여 GTA5 및 SYNTHIA로 학습된 네트워크를 Cityscapes 및 Mapillary 데이터셋에 성공적으로 적응시켜 최신 mIoU 성능을 달성합니다.
