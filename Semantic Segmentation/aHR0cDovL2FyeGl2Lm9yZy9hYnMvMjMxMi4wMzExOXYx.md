# AI-SAM: Automatic and Interactive Segment Anything Model

Yimu Pan, Sitao Zhang, Alison D. Gernand, Jeffery A. Goldstein, and James Z. Wang,Senior Member, IEEE

## 🧩 Problem to Solve

SAM(Segment Anything Model)과 같은 대규모 사전 학습된 상호작용 분할 모델은 강력한 성능을 보이지만, 기존의 적응 전략들은 다음과 같은 한계를 가집니다:

* **불균형한 적응**: 모델을 특정 작업에 적응시킬 때, 대부분 자동화된 방식(프롬프트 기능 상실) 또는 상호작용 방식(수동 개입 필수) 중 하나에 치우쳐 SAM의 본질적인 프롬프트 기능을 최적으로 활용하지 못합니다.
* **클래스 의미론적 이해 부족**: SAM은 클래스 의미론적 세분화에 대한 이해가 불충분하여 도메인 이동이 큰 작업에서 성능이 저하되며, 모호한 타겟으로 학습되어 다운스트림 작업의 의미론과 불일치할 수 있습니다.
* **효과적인 프롬프트에 대한 분석 부족**: 상호작용 방법에서 다양한 프롬프트의 효과에 대한 종합적인 연구가 부족하며, 최적의 포인트 프롬프트 정의에 대한 합의가 없습니다.

이러한 한계들을 해결하고, 자동화와 상호작용 기능의 균형을 이룬 새로운 분할 패러다임을 제안하는 것이 본 논문의 핵심 목표입니다.

## ✨ Key Contributions

* **새로운 분할 패러다임 제안**: 자동(automatic) 및 상호작용(interactive) 분할을 결합하는 새로운 패러다임인 AI-SAM을 제안하고, 이 패러다임 내의 첫 번째 모델을 소개합니다.
* **기능 향상**: 자동화된 포인트 프롬프트 생성 모듈인 AI-Prompter와 이에 상응하는 특수 손실 함수들을 개발하여, 기존 SAM 모델의 프롬프트 기능을 유지하면서 자동화된 성능을 향상시킵니다.
* **프롬프트 품질 분석**: 프롬프트 혼동 행렬(Prompt Confusion Matrix, PCM)과 출력 혼동 행렬(Output Confusion Matrix, OCM)을 통해 다양한 프롬프트 유형의 오류 동작을 체계적으로 분석하고, 포인트 프롬프트의 우수성을 이론적 및 실험적으로 입증합니다.
* **실증적 검증**: 의료 영상(Synapse, ACDC), 위장 객체 감지(Camouflage Object Detection), 그림자 감지(Shadow Detection) 등 다양한 데이터셋에 대한 광범위한 정량적 및 정성적 실험을 통해 제안된 방법의 효과를 입증하며, 여러 벤치마크에서 SOTA(State-of-the-Art) 성능을 달성합니다.

## 📎 Related Works

* **자동 의미론적 분할 (Automatic Semantic Segmentation)**: 초기 CNN 기반 모델(U-Net, DeepLab 등)부터 어텐션 모듈 통합(DANet, Non-local Net), 그리고 최근의 트랜스포머 기반 모델(SegFormer, Masked-attention Mask Transformer)에 이르기까지 다양한 자동 분할 방법론이 개발되었습니다. 이들은 주로 사전 정의된 클래스에 대한 분할을 목표로 합니다.
* **상호작용 분할 모델의 적응 (Adaptation of Interactive Segmentation Models)**: 사용자 프롬프트(포인트, 바운딩 박스, 텍스트 등)를 기반으로 분할 맵을 생성하는 모델들(SimpleClick, AdaptiveClick). 특히 SAM은 대규모 데이터셋(SA-1B)으로 사전 학습되어 뛰어난 상호작용 성능을 보였습니다. 이후 SAM을 특정 도메인(의료 영상 등)에 적응시키기 위한 미세 조정 연구(MedSAM, SAMed)와 SAM을 자동 분할 작업에 확장하려는 시도(SAM-Adapter, All-in-SAM)가 활발히 진행되었으나, 프롬프트 기능을 유지하면서 자동 분할 환경에 효율적으로 적응시키는 데에는 여전히 한계가 있었습니다.

## 🛠️ Methodology

AI-SAM은 자동 및 상호작용 분할을 통합하기 위해 다음과 같은 구성 요소를 가집니다:

1. **AI-Prompter (자동 및 상호작용 프롬프트 생성기)**:
    * **"일반화된 포인트(generalized point)" 개념 도입**: 전통적인 원-핫(one-hot) 포인트 대신, 이미지의 여러 위치 임베딩($P$)에 대한 가중 합으로 포인트를 표현합니다($P_{\text{g}} = W^{\top}P$). 이는 모델이 맥락적 정보를 활용하여 더 유연하고 효과적인 프롬프트를 생성하게 합니다.
    * **아키텍처**: SAM의 양방향 트랜스포머와 유사하게 이미지 특징($X$)과 클래스($c$)를 입력받아 가중치($W$)를 생성합니다($W = \text{AIPrompter}(X,c)$). 그러나 SAM이 위치 임베딩을 사용하는 것과 달리, AI-Prompter는 컨볼루션 레이어를 사용하여 인접한 이미지 토큰을 더 잘 구별하고 상대적 위치 정보에 중점을 둡니다.

2. **프롬프트 휴리스틱 손실 ($L_{\text{ph}}$)**:
    * 사용자 편의성과 모델 성능을 동시에 보장하기 위해 고안된 세 가지 손실 함수로 구성됩니다.
    * **포인트 정확성 손실 ($L_{\text{pc}}$)**: 생성된 일반화된 포인트가 관심 객체 내에 정확히 위치하도록 유도합니다.
        $$ L_{\text{pc}} = \text{mean}_{\text{c}} \left(1 - \frac{\mathbf{1}_{\text{c}}^{\top}W + \gamma}{\mathbf{1}^{\top}W + \gamma}\right) $$
        여기서 $\mathbf{1}_{\text{c}}$는 이미지 특징 $x_i$가 클래스 $c$에 속하면 1, 아니면 0인 인디케이터 함수이며, $\mathbf{1}$은 $W$와 동일한 크기의 1 행렬입니다. $\gamma$는 하이퍼파라미터입니다.
    * **포인트 선명도 손실 ($L_{\text{ps}}$)**: 일반화된 포인트가 원-핫 포인트처럼 간단하고 직접적으로 수정 가능하도록 유도합니다.
        $$ L_{\text{ps}} = \text{mean}_{\text{c}} \left(1 - \frac{\max(\mathbf{1}_{\text{c}} \odot W) + \gamma}{\mathbf{1}_{\text{c}}^{\top}W + \gamma}\right) $$
        여기서 $\odot$는 원소별 곱셈을 나타냅니다.
    * **프롬프트 다양성 손실 ($L_{\text{pd}}$)**: 모델이 여러 개의 유용한 포인트를 생성하도록 장려합니다.
        $$ L_{\text{pd}} = \beta_{\text{in}}L_{\text{in}} + \beta_{\text{out}}L_{\text{out}} $$
        $L_{\text{in}}$은 동일 클래스 내 포인트 간의 유사성을 줄여 TSS(True Semantic Similarity)를 높이고, $L_{\text{out}}$은 다른 클래스 포인트 간의 유사성을 줄여 FSS(False Semantic Similarity)를 낮추는 데 기여합니다.
    * **최종 프롬프트 휴리스틱 손실**:
        $$ L_{\text{ph}} = \alpha_{\text{pc}}L_{\text{pc}} + \alpha_{\text{ps}}L_{\text{ps}} + \alpha_{\text{pd}}L_{\text{pd}} $$
        여기서 $\alpha_{\text{pc}}$, $\alpha_{\text{ps}}$, $\alpha_{\text{pd}}$는 각 손실 구성 요소의 가중치입니다.

3. **분류기 (Classifier)**: 이미지에 존재하지 않는 클래스에 대한 프롬프트 생성을 필터링합니다. Query2label에서 영감을 받아 트랜스포머 디코더를 사용하며, ASL(Asymmetric Loss)로 학습됩니다.

4. **SAM 기반 상호작용 분할 모델**: 기존 SAM의 이미지 인코더, 프롬프트 인코더, 마스크 디코더를 활용합니다. AI-SAM은 종단 간(end-to-end)으로 학습되며, 오직 실제 분할 마스크만을 타겟으로 사용합니다.

## 📊 Results

* **자동 이미지 분할 성능**:
  * **의료 영상**: Synapse Multi-organ 및 ACDC(Automated Cardiac Diagnosis Challenge) 데이터셋에서 SOTA 성능을 달성했습니다. SAM 기반 적응 모델인 SAMedh와 비교해도 우수하거나 필적하는 결과를 보였습니다.
  * **일반 도메인**: AI-Prompter를 SAM-Adapter와 결합했을 때, 위장 객체 감지(CHAMELEON, CAMO, COD10K) 및 그림자 감지(ISTD) 작업에서 새로운 SOTA 성능을 달성하며 AI-Prompter의 일반화 가능성과 성능 향상 효과를 입증했습니다.

* **상호작용 이미지 분할 성능**:
  * 클래스 레이블(gt label), 추가 포인트(1 rd pt), 실제 바운딩 박스(gt box) 등 사용자 프롬프트를 통합했을 때 AI-SAM의 성능이 크게 향상되었습니다. 특히 바운딩 박스 프롬프트 사용 시 의료 영상에서 MedSAM보다 뛰어난 SOTA 성능을 보였습니다.
  * AI-Prompter가 생성한 포인트가 무작위로 샘플링된 실제 포인트보다 훨씬 고품질임을 입증했습니다 (ACDC 데이터셋에서 DICE 점수가 92.06%에서 64.05%로 감소).

* **정성적 평가**: AI-SAM 자동 모드에서 특정 클래스에 대해 성능이 좋지 않은 경우에도, 바운딩 박스와 같은 사용자 상호작용을 통해 누락되거나 잘못된 분할 마스크를 효과적으로 수정할 수 있음을 시각적으로 보여주었습니다.

* **어블레이션 연구 (Ablation Study)**:
  * **포인트 개수**: 클래스당 4개의 포인트가 가장 균형 잡힌 성능을 제공하며, 너무 많은 포인트(예: 16개)는 오히려 성능 저하를 초래할 수 있음을 확인했습니다.
  * **프롬프트 휴리스틱 손실($L_{\text{ph}}$)**:
    * 다양성 손실($L_{\text{pd}}$)을 제거하면 포인트들이 동일한 위치로 수렴하여 생성되는 포인트의 유용성이 저하됨을 확인했습니다.
    * 다양성 손실과 선명도 손실($L_{\text{ps}}$)을 모두 제거하면 일반화된 포인트와 원-핫 포인트 간의 차이가 발생하기 시작했습니다.
    * 전체 프롬프트 휴리스틱 손실($L_{\text{ph}}$)을 제거했을 때 성능이 41.32%p 급락하고, 부정확한 포인트가 많이 생성되어 사용성 측면에서 해당 손실 함수들의 중요성이 매우 크다는 것을 입증했습니다.

## 🧠 Insights & Discussion

* **한계**:
  * **SAM의 클래스 의미론 불일치**: 사전 학습 데이터(자연 이미지)와 하위 작업 데이터셋(예: 그림자 감지) 간의 클래스 의미론적 불일치로 인해 SAM이 일부 도메인에서 한계를 보일 수 있습니다.
  * **바운딩 박스 프롬프트의 모호성**: 본 연구의 PCM 분석에서 드러났듯이, 바운딩 박스 단독 프롬프트는 모호성을 유발하여 Myo와 LV 같은 유사한 클래스 간 혼동을 초래할 수 있습니다.
  * **AI-SAM의 특정 한계**: 제안된 포인트의 품질은 이미지 인코더 및 디코더의 표현력에 의존합니다. 또한, 클래스별 포인트를 생성하려면 클래스 레이블이 미리 제공되어야 하므로, 미세 조정 없이는 새로운 클래스에 자동으로 적용할 수 없습니다(이는 개방형 어휘 분할 연구의 필요성을 시사). 현재 다른 클래스의 전경 포인트를 배경 포인트로 사용하기 때문에, 모든 클래스를 전경으로 처리하는 상황에서는 배경 포인트 생성에 어려움이 있을 수 있습니다.

* **광범위한 함의**:
  * **모델 개발 가속화**: AI-SAM과 같은 자동 및 상호작용 통합 모델은 학습 데이터가 제한적이거나 편향된 시나리오(예: 자율 주행의 다양한 환경 데이터 레이블링)에서 모델 개발을 크게 가속화할 수 있습니다. 간단한 샘플은 자동으로 레이블링하고, 복잡한 샘플은 최소한의 수동 개입으로 처리하여 밀도 높은 어노테이션의 부담을 줄입니다.
  * **의료 애플리케이션 혁신**: 의료 영상 분석 분야에서는 전문가의 레이블링에 많은 시간과 비용이 소요됩니다. AI-SAM은 전문가의 단순 반복 작업 부담을 줄이고, 모델이 점진적으로 더 많은 데이터를 학습함에 따라 수동 개입의 필요성을 줄여 레이블링 시간을 단축시킵니다.
  * **태반 분석 사례**: 데이터 수집의 편향(예: 특정 사이트의 고품질 이미지)으로 인해 모델 성능이 저하될 수 있는 경우(예: 사진 기반 태반 분석), AI-SAM은 사용자가 분할 맵을 쉽게 수정하여 오류를 수정하고 모델 성능을 향상시킬 수 있는 유연성을 제공합니다.

## 📌 TL;DR

기존 SAM 적응 방식의 자동/상호작용 극단성 문제를 해결하고자, 본 논문은 자동과 상호작용 기능을 통합한 새로운 분할 패러다임인 AI-SAM을 제안합니다. AI-SAM은 이미지 특징과 클래스 레이블을 입력받아 자동적으로 포인트 프롬프트를 생성하며 사용자 피드백을 통해 추가 수정을 허용하는 **AI-Prompter**와 프롬프트 품질 및 사용성을 보장하는 **휴리스틱 손실 함수**를 핵심으로 합니다. 의료 영상, 위장 객체 감지, 그림자 감지 등 다양한 분야에서 **SOTA 성능을 달성**했으며, 특히 사용자 상호작용을 통해 자동 모드에서의 오류를 효과적으로 수정하여 하이브리드 모델의 우수성을 입증했습니다.
