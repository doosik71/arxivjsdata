# Multi-Scale Cross Contrastive Learning for Semi-Supervised Medical Image Segmentation

Qianying Liu, Xiao Gu, Paul Henderson, and Fani Deligianni

## 🧩 Problem to Solve

의료 영상 분할은 대규모의 정확한 주석이 달린 데이터셋을 필요로 하지만, 이러한 데이터셋을 확보하는 것은 시간, 비용, 전문성 측면에서 많은 제약이 따른다. 기존 준지도 학습(SSL) 접근 방식들은 원거리 영역 간의 고수준 의미론적 관계를 명시적으로 포착하지 못하여 성능이 제한된다. 특히, 클래스 불균형이 심한 의료 영상 데이터셋의 경우, 기존 대조 학습(Contrastive Learning) 방법론은 잘못된 음성 쌍(false negative pairs) 문제를 겪거나, 상세한 픽셀 수준 정보 대신 전역적인 이미지 수준 표현에만 초점을 맞추는 경향이 있다.

## ✨ Key Contributions

- 교차 티칭(cross-teaching)과 새로운 로컬 대조 학습(local contrastive learning)을 결합한 새로운 준지도 학습 프레임워크를 제안하여, 훈련 안정성을 높이고 출력 및 특징 수준에서 의미론적 일관성을 보장한다.
- 다중 스케일 특징 맵(multi-scale feature maps)에 정의된 최초의 로컬 대조 학습 프레임워크로, 픽셀 수준 대조 학습의 일반적인 과도한 지역성(over-locality) 및 과적합 문제를 해결하며, 교차 티칭을 통해 의사 레이블(pseudo-labels)과 실제 레이블(ground truth)을 원활하게 통합한다.
- 준지도 의료 영상 분할에서 편향되지 않은 표현 학습(unbiased representation learning)을 위해 균형 잡힌 대조 손실(balanced contrastive loss)을 통합하여, 의사 레이블 예측 및 지도 학습에서의 심각한 클래스 불균형 문제를 해결한다.

## 📎 Related Works

- **일관성 정규화 (Consistency Regularization):** 데이터 증강(augmentations), 모델 아키텍처(예: CNN과 트랜스포머 간 교차 티칭), 또는 태스크 간 예측 일관성을 강제하는 방식이 있다. 하지만 주로 출력 수준의 일관성에 중점을 두고, 판별적인 특징 표현 학습을 소홀히 하며, 불균형한 데이터셋에서 한계를 보인다.
- **대조 학습 (Contrastive Learning):** 긍정 쌍(positive pairs)의 유사성을 높이고 부정 쌍(negative pairs)의 비유사성을 강조하는 방식으로, 영상 분할을 위해서는 픽셀 단위 대조 학습이 필요하다. 기존 준지도 학습과 대조 학습의 결합은 주로 비레이블링 데이터에 대한 전역적 이미지 대조에 초점을 맞추었으며, 클래스 불균형 데이터에서 잘못된 음성 쌍 문제에 취약하다. 또한, 지도 및 자가지도 대조 손실의 정의 불일치로 인해 최적의 성능을 달성하기 어렵다.

## 🛠️ Methodology

본 논문은 CNN 기반 U-Net과 트랜스포머 기반 U-Net 간의 교차 티칭(cross-teaching)을 사용하는 학생-학생(student-student) 프레임워크인 Multi-Scale Cross Supervised Contrastive Learning (MCSC)을 제안한다. 이 프레임워크는 두 모델의 장점(지역적 의미 정보 vs. 장거리 의존성)을 활용하며, 기존 교차 티칭의 한계인 네트워크 간 특징 일관성 부족 및 전체 데이터셋에 걸친 다양한 카테고리 구별 능력 부족을 해결한다.

**감독 손실 (Supervision Losses):**

- **$L_{sup}$ (지도 손실):** 레이블링된 데이터에 대한 표준 분할 손실(예: Dice 손실).
- **$L_{cps}$ (교차 의사 감독 손실):** 비레이블링 데이터에 대해 한 네트워크의 예측과 *다른* 네트워크가 생성한 의사 레이블 간의 Dice 손실로, 예측 일관성을 보장한다.
- **$L_{cl}$ (다중 스케일 교차 지도 대조 손실):** 교차 의사 감독의 가이드에 따라 레이블링된 데이터와 비레이블링된 데이터 모두에서 동일 카테고리 특징의 일관성을 높이고, 다른 카테고리 특징의 구별 능력을 향상시킨다.

**다중 스케일 교차 지도 대조 학습 (MCSC) 모듈:**

- **특징 임베딩 (Feature Embedding):** CNN ($E_{cnn}$)과 트랜스포머 ($E_{tra}$)에서 추출된 특징은 프로젝터($H_{cnn}, H_{tra}$)를 통해 통합된 특징 공간으로 투영된다.
- **교차 지도 샘플링 (Cross Supervised Sampling):**
  - 트랜스포머의 예측이 CNN의 샘플링을 감독하고, 그 반대도 마찬가지로 클래스 정보를 교환하여 모델 간 특징 일관성을 보장한다.
  - 레이블링된 데이터와 비레이블링된 데이터 *모두*에서 특징을 대조하며, 슬라이스 *내부* 및 *간* 픽셀을 대조하여 전역적 구조와 지역적 텍스처 정보를 모두 포착한다.
  - 계산 복잡도를 줄이기 위해 패치($h' \times h'$) 단위로 지역 대조 손실을 계산한다.
- **균형 잡힌 지도 지역 대조 손실 ($L_{bcl}$):**
  - 각 클래스 픽셀 내에서 클래스 간(긍정) 및 클래스 내(부정) 특징 대조를 평균화하여 클래스 불균형 문제를 해결하며, 각 클래스가 거의 동일하게 기여하도록 보장한다.
  - 수식은 다음과 같다:
    $$
    L_{bcl} = -\frac{1}{|A|} \sum_{a_i \in A} \frac{1}{|A_y|-1} \sum_{p \in A_y \setminus \{i\}} \log \frac{\exp(a_i \cdot a_p / \tau)}{\sum_{j \in Y_A} \frac{1}{|A_j|} \sum_{a_k \in A_j} \exp(a_i \cdot a_k / \tau)}
    $$
    여기서 $A$는 픽셀 수준 특징 집합, $a_i$는 $i$번째 특징, $A_y$는 클래스 $y$의 모든 샘플을 포함하는 부분 집합, $Y_A$는 현재 $A$의 모든 고유 클래스 집합, $\tau$는 온도 상수이다.
- **다중 스케일 대조 손실 ($L_{cl}$):** 여러 레이어의 특징 맵에 $L_{bcl}$을 적용하여, 거친(전역적) 정보와 세부적인(지역적) 정보를 모두 포착한다. 총 손실 $L_{cl} = \sum_{i=1}^{n} L_{cl_i}$이다.

**최적화 (Optimization):**
두 네트워크는 다음과 같은 손실 함수의 가중 합을 최소화하도록 훈련된다:
$L_{cnn} = L_{sup(cnn)} + w_{cps}L_{cps(cnn)} + w_{cl}L_{cl}$
$L_{tra} = L_{sup(tra)} + w_{cps}L_{cps(tra)} + w_{cl}L_{cl}$
여기서 $w_{cps}$는 가우시안 워밍업 함수로 정의되며, $w_{cl}$은 $10^{-3}$으로 설정된다. 트랜스포머는 훈련 중에만 사용되며, 최종 추론에는 CNN이 사용된다.

## 📊 Results

본 연구는 ACDC(심장 MRI) 및 Synapse(복부 CT) 두 가지 벤치마크 데이터셋에서 MCSC의 성능을 평가했다. 성능 지표는 Dice 계수(DSC)와 95% Hausdorff 거리(HD)이다.

- **성능 우수성:** MCSC는 최신 준지도 학습(SSL) 방법들(CCT, CPS, CTS)을 현저히 능가한다.
- **ACDC 데이터셋:**
  - 10%의 레이블링된 데이터만 사용할 때, MCSC는 89.4%의 DSC와 2.3mm의 HD를 달성하여, 기존 최고 SSL 방법(CTS: 86.4% DSC, 8.6mm HD)보다 크게 향상되었다.
  - 특히, MCSC의 2.3mm HD는 완전 지도 학습 U-Net(4.0mm) 및 BATFormer(8.0mm)보다 우수하며, DSC(89.4%) 또한 완전 지도 학습 방법(U-Net 91.7%, BATFormer 92.8%)과 경쟁력 있는 수준이다.
  - 레이블링된 데이터 감소(예: 10%에서 5%로)에 대한 강한 회복력을 보이며, 기존 최신 SSL 방법 대비 DSC에서 약 10% 향상을 달성했다. 소수 클래스인 우심실(RV)에 대해서는 DSC에서 14%, HD에서 13.6mm의 현저한 성능 향상을 보였다.
- **Synapse 데이터셋:** 더 많은 장기 수와 심한 불균형으로 인해 ACDC보다 더 도전적인 분할 벤치마크임에도 불구하고, MCSC는 여전히 기준선보다 크게 우수하여 제안된 프레임워크의 견고성을 입증했다.
- **정성적 결과:** MCSC는 기존 기준선 대비 소수 클래스에서 덜 분할된 영역과 적은 위양성을 가진 더 정확한 분할을 생성한다.
- **절제 연구:** 균형 잡힌 손실, 교차 레이블링 샘플링, 다중 스케일 특징 사용이 각각 성능 향상에 기여함을 입증했다. 특히, 거친 특징과 세부적인 특징을 결합하는 것이 가장 좋은 성능을 보인다.
- **특징 시각화:** t-SNE 플롯은 MCSC가 다른 클래스에 대해 더 잘 분리된 클러스터를 생성하고 동일 클래스에 대해 더 응집된 클러스터를 생성하여 특징 표현이 향상되었음을 시각적으로 보여준다.

## 🧠 Insights & Discussion

MCSC는 레이블링된 데이터와 비레이블링된 데이터를 효과적으로 활용하여 의료 영상 분할 성능을 크게 향상시킨다. 이는 준지도 학습과 완전 지도 학습 간의 성능 격차를 크게 줄여, 의료 분야에서 준지도 학습의 실질적인 적용 가능성을 높인다. 제안된 균형 잡힌 대조 손실은 의료 영상의 흔한 클래스 불균형 문제를 성공적으로 해결하여, 지배적인 배경 클래스에 대한 편향을 방지하고 소수 장기의 분할 정확도를 개선한다. 다중 스케일 특징 대조는 전역적인 기하학적 구조와 미세한 지역적 세부 정보를 모두 포착하여, 정확한 장기 경계 묘사에 필수적이다. 교차 티칭(cross-teaching)과 교차 지도 샘플링(cross-supervised sampling)은 전체 데이터셋에 걸쳐 특징의 일관성과 구별 능력을 향상시킨다. 결과적으로 MCSC는 레이블링된 데이터의 심각한 감소에도 불구하고 뛰어난 회복력을 보여, 주석이 부족한 의료 분야에서 매우 유용하다.

## 📌 TL;DR

- **문제:** 의료 영상 분할은 주석이 달린 데이터의 부족으로 인해 성능에 제약이 있으며, 기존 준지도 학습 방법은 고수준 의미론적 관계 포착과 클래스 불균형 처리에 어려움을 겪는다.
- **제안 방법:** Multi-Scale Cross Supervised Contrastive Learning (MCSC) 프레임워크를 제안한다. 이 프레임워크는 CNN과 트랜스포머 모델을 교차 티칭 방식으로 공동 훈련하여 예측 일관성을 확보한다. 특징 정규화를 위해 새로운 다중 스케일 교차 지도 대조 손실을 도입하는데, 이는 다중 스케일 특징 맵에 걸쳐 지역 대조 학습을 수행하고, 교차 예측된 레이블을 샘플링에 사용하며, 클래스 불균형을 해소하기 위한 균형 잡힌 손실을 포함한다.
- **주요 결과:** MCSC는 최신 준지도 학습 방법들(ACDC 10% 데이터에서 Dice 3% 이상, HD 5mm 이상 향상)을 현저히 능가하며, 완전 지도 학습 방법과의 성능 격차를 크게 줄인다. 매우 제한된 레이블링 데이터(예: ACDC에서 레이블링 데이터 10%에서 5%로 감소 시 DSC 10% 향상)에서도 탁월한 회복력을 보이며, 특히 소수 클래스에 대해 더 정확하고 균형 잡힌 분할 결과를 제공한다.
