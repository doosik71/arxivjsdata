# Segment Any Anomaly without Training via Hybrid Prompt Regularization

Yunkang Cao, Xiaohao Xu, Chen Sun, Yuqi Cheng, Zongwei Du, Liang Gao, Weiming Shen

## 🧩 Problem to Solve

기존의 이상(anomaly) 분할 모델들은 특정 도메인에 대한 미세 조정(fine-tuning)이나 정상 샘플 학습에 의존하여, 다양한 이상 패턴에 대한 일반화 능력이 제한적입니다. 이는 방대한 종류의 산업 제품이나 의료 영상과 같은 실제 시나리오에서 많은 훈련 데이터 수집 및 모델 학습 비용을 발생시키며, 특히 훈련 과정에서 타겟 카테고리에 대한 정상 또는 비정상 이미지가 전혀 제공되지 않는 제로샷 이상 분할(Zero-Shot Anomaly Segmentation, ZSAS) 설정에서는 더욱 큰 제약이 됩니다.

파운데이션 모델(예: SAM, CLIP)은 뛰어난 제로샷 일반화 능력을 보이지만, 이러한 모델들을 단순히 결합하여 이상 분할에 직접 적용할 경우("anomaly"와 같은 단순한 언어 프롬프트 사용) "언어 모호성" 문제에 직면합니다. 이는 사전 훈련 데이터셋과 이상 분할 데이터셋 간의 도메인 차이, 그리고 이상 현상이 객체 컨텍스트에 따라 달라지는 특성 때문에 심각한 오탐(false alarms)을 유발하여 실질적인 성능 저하로 이어집니다.

## ✨ Key Contributions

* 훈련 과정 없이 다양한 파운데이션 모델의 협업적 조합을 가능하게 하는 SAA(Segment Any Anomaly) 프레임워크를 제안했습니다.
* 도메인 전문가 지식과 타겟 이미지 컨텍스트를 활용하여 파운데이션 모델을 이상 분할에 효과적으로 적응시키기 위한 하이브리드 프롬프트 정규화 기술을 도입했으며, 이를 통해 SAA의 향상된 버전인 SAA+ 모델을 개발했습니다.
* VisA, MVTec-AD, KSDD2, MTD 등 여러 벤치마크 데이터셋에서 제로샷 이상 분할 분야의 최신 성능(SOTA)을 달성했습니다. 특히, SAA/SAA+는 어떠한 어노테이션도 없이 텍스처 관련 이상(texture-related anomalies)을 탐지하는 탁월한 능력을 입증했습니다.

## 📎 Related Works

* **이상 분할(Anomaly Segmentation):**
  * **비지도 학습 방법:** 산업 환경에서 이상 이미지의 희소성으로 인해 정상 이미지만을 활용한 연구가 주를 이룹니다.
    * 재구성 기반(Reconstruction-based) 접근법 [7,8,9,10,11,12]: 오토인코더 모델을 훈련시켜 이미지를 재구성하고, 입력 이미지와의 차이를 통해 이상 위치를 예측합니다.
    * 특징 임베딩 기반(Feature embedding-based) 방법 [1,2,3,13,14,15,16,17,18]: Teacher-student 아키텍처, 원-클래스 분류(one-class classification), 메모리 기반 정상 분포 등을 사용하여 정상-비정상 이미지 간의 특징 분포 차이를 식별합니다.
  * **제로샷 이상 분할(ZSAS):** 훈련 과정에서 정상 또는 비정상 이미지가 전혀 필요 없는 최근 연구 동향 [37,38,39,40]입니다. WinClip [25]은 텍스트-시각 모델의 잠재력을 탐색하지만, 본 연구는 제안 생성 및 이상도 스코어링을 통해 더 나은 분할 성능을 목표로 합니다.
* **파운데이션 모델(Foundation Models):**
  * SAM [19], CLIP [20], Grounding DINO [23]와 같은 모델들은 대규모 데이터셋 [41] 학습을 통해 강력한 표현 학습 및 뛰어난 제로샷 시각 인식 능력을 보여줍니다.
  * 이러한 기성 모델들을 이상 분할과 같은 다운스트림 작업에 훈련 없이 적용하는 방법을 모색하는 것이 본 연구의 목표입니다.
* **프롬프트 엔지니어링(Prompt Engineering):**
  * 파운데이션 모델을 다운스트림 작업에 적응시키는 데 널리 사용되는 기술입니다 [48,49,50,51,52,53,54].
  * ZSAS는 훈련 데이터가 없으므로 훈련이 필요 없는 발견적 프롬프트(heuristic prompts) [55]가 적합합니다. 본 논문은 도메인 전문가 지식과 타겟 이미지 컨텍스트에서 파생된 하이브리드 프롬프트를 제안합니다.

## 🛠️ Methodology

본 논문에서는 SAA(Segment Any Anomaly)라는 바닐라 프레임워크를 먼저 구성한 후, 언어 모호성 문제를 해결하기 위해 하이브리드 프롬프트 정규화를 추가한 SAA+ 프레임워크를 제안합니다.

1. **SAA (Vanilla Foundation Model Assembly) 프레임워크:**
    * **이상 영역 생성기(Anomaly Region Generator):** 언어 기반 시각 그라운딩 파운데이션 모델인 GroundingDINO [23]를 활용합니다. "anomaly"와 같은 단순한 클래스 불특정 언어 프롬프트($T_n$)를 입력으로 받아, 대략적인 이상 영역 제안(바운딩 박스 $R_B$)과 신뢰도 점수($S$)를 생성합니다.
        $$R_B, S := \text{Generator}(I, T_n)$$
    * **이상 영역 정제기(Anomaly Region Refiner):** 프롬프트 기반 분할 파운데이션 모델인 SAM [19]을 사용합니다. 생성된 바운딩 박스 $R_B$를 프롬프트로 사용하여 픽셀 단위의 고품질 분할 마스크($R$)를 생성합니다.
        $$R := \text{Refiner}(I, R_B)$$
    * **문제점:** 단순 언어 프롬프트는 도메인 차이와 객체 컨텍스트 의존성으로 인해 "언어 모호성" 문제를 야기하여 오탐이 발생합니다 (예: 양초의 '심지' 전체를 '이상'으로 오인).

2. **SAA+ (Foundation Model Adaption via Hybrid Prompt Regularization) 프레임워크:**
    SAA의 언어 모호성 문제를 해결하고 ZSAS 성능을 향상시키기 위해, 도메인 전문가 지식과 타겟 이미지 컨텍스트에서 파생된 하이브리드 프롬프트를 도입하여 파운데이션 모델의 예측을 정규화합니다.

    * **도메인 전문가 지식에서 파생된 프롬프트:**
        * **이상 언어 표현 프롬프트($P_L$):**
            * **클래스 불특정 프롬프트($T_a$):** "anomaly", "defect"와 같은 일반적인 이상 설명을 사용합니다.
            * **클래스 특정 프롬프트($T_s$):** 도메인 전문가 지식을 바탕으로 "black hole", "white bubble"과 같이 특정 이상 패턴을 구체적으로 설명하는 언어 프롬프트를 사용합니다. 이를 통해 이상 탐지 문제를 특정 이상 상태를 가진 객체를 찾는 문제로 재구성하여 파운데이션 모델의 능력을 보다 정확하게 활용합니다.
        * **이상 객체 속성 프롬프트($P_P = \{\theta_{\text{IoU}}, \theta_{\text{area}}\}$):** 파운데이션 모델이 객체의 수, 크기, 위치와 같은 특정 속성에 대한 인식이 부족하다는 점을 보완하기 위해 규칙 기반 필터링을 도입합니다.
            * **이상 위치(Anomaly Location):** 잠재적 이상 영역과 검사 대상 객체 간의 IoU(Intersection over Union)를 계산하고, 전문가가 정의한 임계값 $\theta_{\text{IoU}}$ 미만의 후보를 제거합니다.
            * **이상 영역(Anomaly Area):** 이상 영역이 검사 대상 객체 영역의 특정 비율 $\theta_{\text{area}}$보다 작아야 한다는 규칙을 적용하여 후보를 필터링합니다.
            * 이 필터링 함수($\text{Filter}$)를 통해 정제된 후보 영역 $R_P$와 신뢰도 점수 $S_P$를 얻습니다.
                $$R_P, S_P := \text{Filter}(R, P_P)$$

    * **타겟 이미지 컨텍스트에서 파생된 프롬프트:**
        * **이상 현저성(Saliency) 프롬프트($P_S$):**
            * 이상 영역이 주변 환경과 시각적으로 얼마나 다른지에 대한 인간의 직관을 모방하여 현저성 맵($s$)을 계산합니다.
            * 픽셀 ($i,j$)의 특징 $f_{ij}$와 그 $N$개 최근접 이웃 특징 간의 코사인 유사성을 기반으로 현저성 맵 $s_{ij}$를 계산합니다:
                $$s_{ij} := \frac{1}{N} \sum_{f \in N_p(f_{ij})} (1 - \langle f_{ij}, f \rangle)$$
            * 각 영역 마스크 내의 평균 현저성 값에 지수 함수를 적용하여 현저성 프롬프트 $P_S$를 정의하고, 이를 통해 $S_P$를 재보정하여 새로운 점수 $S_S$를 얻습니다:
                $$P_S := \left\{ \exp\left( \frac{\sum_{ij} r_{ij} s_{ij}}{\sum_{ij} r_{ij}} \right) \mid r \in R_P \right\}$$
                $$S_S := \{ p \cdot s \mid p \in P_S, s \in S_P \}$$
        * **이상 신뢰도(Confidence) 프롬프트($P_C$):**
            * 일반적으로 이상 영역의 수가 제한적이라는 점을 활용하여, 이미지 컨텍스트를 기반으로 가장 높은 신뢰도 점수를 가진 상위 $K$개의 후보를 선택합니다. (기본 $K=5$)
            * $$R_C, S_C := \text{Top}_K(R_P, S_S)$$
            * 선택된 $K$개의 후보 영역과 해당 점수를 사용하여 최종 이상 맵($A_{ij}$)을 추정합니다:
                $$A_{ij} := \frac{\sum_{r_C \in R_C} r_{C,ij} \cdot s_C}{\sum_{r_C \in R_C} r_{C,ij}}$$

## 📊 Results

* **정량적 결과:** SAA+는 VisA, MVTec-AD, KSDD2, MTD 등 4가지 이상 분할 벤치마크 데이터셋에서 제로샷 설정 하에 최신 성능(SOTA)을 달성했습니다.
  * $F_p$ (max-F1-pixel)와 $F_r$ (max-F1-region) 모두에서 WinClip [25], ClipSeg [24], UTAD [40], 그리고 바닐라 SAA 모델을 크게 능가했습니다.
  * 예를 들어, 모든 데이터셋 평균 $F_p$에서 SAA는 18.22%였지만 SAA+는 34.85%를 달성했으며, $F_r$에서는 SAA 19.74% 대비 SAA+ 34.07%를 기록했습니다.
  * 특히, 어떠한 훈련이나 어노테이션 없이도 텍스처 관련 이상을 탐지하는 데 탁월한 능력을 보였습니다.
* **정성적 결과:** SAA+는 경쟁 모델들(ClipSeg, UTAD, SAA)과 비교했을 때, 가죽의 미세한 흠집과 같은 텍스처 이상까지 포함하여 더 정확한 이상 분할 결과를 시각적으로 보여주었습니다.
* **어블레이션 스터디(Ablation Study):** 제안된 각 하이브리드 프롬프트의 효과를 검증했습니다.
  * **언어 프롬프트($P_L$):** $F_p$에서 3.90%, $F_r$에서 4.90% 성능 향상에 기여했습니다. 클래스 불특정 프롬프트($T_a$)와 클래스 특정 프롬프트($T_s$) 모두 효과적이었으며, 이들의 조합이 시너지 효과를 보였습니다.
  * **객체 속성 프롬프트($P_P$):** 텍스처 카테고리에서 $F_p$가 21.83%에서 53.79%로 극적인 향상을 보여, 잘못 탐지된 이상 후보를 효과적으로 필터링했습니다.
  * **현저성 프롬프트($P_S$):** 이상 영역이 주변 환경과 얼마나 다른지를 정확하게 모델링하여 신뢰도 점수를 보정하고, 헤이즐넛의 균열이나 양초의 너무 긴 심지 같은 미세한 이상을 정밀하게 분할하는 데 기여했습니다.
  * **신뢰도 프롬프트($P_C$):** 이상 영역의 수를 제한하여 오탐을 효과적으로 줄였고, 모든 카테고리에서 평균 $F_p$ 0.72% 향상을 가져왔습니다. 하이퍼파라미터 $K$ (상위 $K$개 선택)는 $K=5$ 부근에서 최적의 성능을 보였습니다.

## 🧠 Insights & Discussion

* **파운데이션 모델의 잠재력 극대화:** 본 연구는 기존 파운데이션 모델(GroundingDINO, SAM)이 가진 제로샷 일반화 능력을 이상 분할이라는 특정 시각 작업에 성공적으로 적용하는 방법을 제시합니다. 특히, 파운데이션 모델의 '언어 모호성'과 도메인 차이 문제를 하이브리드 프롬프트라는 효과적인 방법으로 극복했습니다.
* **하이브리드 프롬프트의 중요성:** 도메인 전문가 지식(구체적인 언어 설명, 객체 속성 필터)과 타겟 이미지 컨텍스트(시각적 현저성, 신뢰도 순위)를 결합한 하이브리드 프롬프트는 파운데이션 모델이 특정 작업의 미묘한 차이를 이해하고 정확한 예측을 수행하도록 유도하는 핵심 요소임이 입증되었습니다. 이는 효과적인 프롬프트 엔지니어링이 파운데이션 모델 적응의 핵심임을 시사합니다.
* **실용적 의의:** 훈련 데이터나 어노테이션 없이 높은 정확도로 이상을 분할할 수 있는 SAA+는 산업 품질 관리, 의료 진단 등 신속하고 비용 효율적인 배포가 필요한 분야에서 혁신적인 잠재력을 가집니다. 특히, 텍스처와 관련된 미세한 이상까지 탐지할 수 있는 능력은 실제 현장에서 매우 유용할 것입니다.
* **한계점:** 현재 컴퓨팅 자원의 제약으로 인해 더 대규모의 파운데이션 모델에 대한 테스트는 이루어지지 않았습니다. 향후 연구에서는 모델 스케일링 효과에 대한 탐구가 필요합니다.
* **향후 연구 방향:** 본 연구는 이상 분할을 위한 '라벨 프리(label-free) 모델 적응' 설계에 대한 새로운 통찰을 제공하며, 향후 다양한 파운데이션 모델과 더욱 정교한 프롬프트 설계 방법에 대한 연구를 촉진할 것으로 기대됩니다.

## 📌 TL;DR

본 논문은 훈련 없이 어떤 이상이라도 분할(Segment Any Anomaly)하기 위한 제로샷 이상 분할 프레임워크인 SAA+를 제안한다. 기존 파운데이션 모델의 단순 조합(SAA)이 겪는 언어 프롬프트의 모호성 문제를 해결하기 위해, SAA+는 도메인 전문가 지식(정교한 언어 프롬프트, 객체 속성 필터)과 타겟 이미지 컨텍스트(현저성 점수 보정, 신뢰도 기반 상위 $K$개 선택)에서 파생된 하이브리드 프롬프트를 활용하여 파운데이션 모델을 정규화한다. 결과적으로 SAA+는 VisA, MVTec-AD 등 여러 벤치마크 데이터셋에서 최신 제로샷 이상 분할 성능을 달성하며, 특히 어떠한 훈련 데이터나 어노테이션 없이도 텍스처 이상을 효과적으로 탐지하는 능력을 입증했다.
