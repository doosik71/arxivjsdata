# CLUSTSEG: Clustering for Universal Segmentation

James Liang, Tianfei Zhou, Dongfang Liu, Wenguan Wang

## 🧩 해결하고자 하는 문제

기존의 이미지 분할(Image Segmentation) 작업(예: 슈퍼픽셀, 시맨틱, 인스턴스, 파놉틱 분할)은 태스크별로 특화된(task-specialized) 네트워크 아키텍처와 기술 프로토콜을 사용하여 해결되었습니다. 이로 인해 연구 노력이 분산되고 다양한 작업에 유연하게 적용하기 어렵다는 문제가 있었습니다. 본 논문은 이러한 분할 작업들을 픽셀 클러스터링(pixel clustering)이라는 단일화된 관점에서 해결할 수 있는 범용적인 프레임워크를 제안하여, 태스크별 특화된 모델들을 뛰어넘는 성능을 달성하고자 합니다.

## ✨ 주요 기여

* **통합 프레임워크 제안**: 슈퍼픽셀, 시맨틱, 인스턴스, 파놉틱 분할 등 네 가지 핵심 분할 작업을 클러스터링 관점에서 통합적으로 다루는 Transformer 기반의 범용 프레임워크인 CLUSTSEG를 제안합니다.
* **혁신적인 클러스터 중심 초기화 (Dreamy-Start)**: 쿼리(query)를 클러스터 중심으로 간주하고, 태스크별 요구 사항(예: 인스턴스 또는 카테고리 수준의 고유성)에 따라 이 쿼리들을 이질적인 방식으로 초기화합니다. 이는 아키텍처 변경 없이 다양한 태스크의 이질적인 특성을 수용합니다.
  * 시맨틱/스터프(stuff) 분할: 전역 데이터 분포에서 학습된 클래스 중심을 쿼리로 사용합니다.
  * 인스턴스/씽(thing) 분할: 입력 이미지의 컨텍스트에 적응적으로 생성된 인스턴스별 중심을 사용합니다.
  * 슈퍼픽셀 분할: 이미지 그리드에서 샘플링된 위치 기반 중심을 사용합니다.
* **비모수적 반복 클러스터링 (Recurrent Cross-Attention)**: 픽셀-클러스터 할당(E-단계)과 클러스터 중심 업데이트(M-단계)를 교대로 수행하는 반복적인 크로스-어텐션 메커니즘을 도입합니다. 이는 EM 클러스터링의 원리를 따르며, 추가 학습 가능한 매개변수 없이 효율적인 클러스터링을 가능하게 합니다.
* **최첨단 성능 달성**: 네 가지 분할 작업 모두에서 기존의 태스크별 특화 모델 및 범용 모델들을 뛰어넘는 최첨단 성능을 달성했습니다.

## 📎 관련 연구

* **시맨틱 분할**: FCN(Fully Convolutional Networks) 이후 컨텍스트 통합(U-Net, DeepLabV3+), 신경 어텐션(PSANet), 콘트라스트 학습, 프로토타입 이론(CMT-DeepLab), 생성 모델(GMMSeg) 및 최신 Transformer 아키텍처(SETR, Segmenter, Segformer, Mask2Former)의 적용에 대한 연구가 이루어졌습니다.
* **인스턴스 분할**: 크게 상향식(top-down, Mask R-CNN 기반의 detect-then-segment), 하향식(bottom-up, 픽셀 임베딩 후 클러스터링), 그리고 단일 샷(single-shot, 학습 가능한 쿼리 사용) 방식으로 나뉩니다.
* **파놉틱 분할**: Kirillov et al.(2019b)의 선구적인 연구 이후, 문제 분해(proxy task, Panoptic-FPN, UPSNet) 또는 end-to-end 방식(DETR, Panoptic FCN, MaX-DeepLab, kMaX-DeepLab, Mask2Former)으로 발전해왔습니다.
* **슈퍼픽셀 분할**: 딥러닝 이전 시대에 활발히 연구되었으며(SLIC), 최근에는 신경망을 활용한 방법(Superpixel Sampling Networks, SSFCN, LNS)이 개발되었습니다.
* **범용 이미지 분할**: Mask2Former와 K-Net이 다양한 태스크를 마스크-분류(mask-classification) 방식으로 통합하려는 시도를 했으나, CLUSTSEG는 클러스터링 원리를 명시적으로 활용하여 더 투명하고 유연하며 강력한 성능을 제공합니다.
* **클러스터링 기반 분할**: 픽셀 클러스터링을 통한 분할은 오래된 아이디어이나 최근 재조명되고 있습니다. 특히, kMaX-DeepLab(Yu et al., 2022a;b)은 크로스-어텐션을 클러스터링 해결사로 재해석하여 파놉틱 분할 시스템을 구축했습니다. CLUSTSEG는 이를 더욱 발전시켜 범용 분할에 적용했습니다.

## 🛠️ 제안 방법론

CLUSTSEG는 이미지 분할을 픽셀 클러스터링 과정으로 재해석하며, EM 클러스터링의 원리를 Transformer의 크로스-어텐션 메커니즘에 접목합니다.

1. **전체 아키텍처**:
    * **픽셀 인코더 (Pixel Encoder)**: 입력 이미지 $I$에서 다중 스케일의 픽셀 임베딩 $\{I_l\}_l$을 추출합니다. (ResNet, ConvNeXt, Swin 등의 백본 사용)
    * **Dreamy-Start (쿼리 초기화)**: 각 분할 태스크의 특성을 고려하여 초기 클러스터 중심 $C^{(0)}$를 생성합니다.
        * **시맨틱/스터프 분할**: 학습 중 메모리 뱅크 $B$에 저장된 각 클래스의 픽셀 임베딩 평균을 통해 클래스 중심 $\bar{x}_k$를 계산하고, 이를 FFN에 통과시켜 초기 쿼리 $C^{(0)} = \text{FFN}([\bar{x}_1; \cdots; \bar{x}_K])$를 얻습니다. (Eq. 7)
        * **인스턴스/씽 분할**: 입력 이미지의 위치 임베딩(PE)을 FFN에 통과시켜 이미지 컨텍스트에 적응적인 초기 쿼리 $C^{(0)} = \text{FFN}(\text{PE}(I))$를 생성합니다. (Eq. 8)
        * **파놉틱 분할**: 스터프 클래스에는 시맨틱 분할 방식을, 씽 클래스에는 인스턴스 분할 방식을 각각 적용하여 두 개의 개별 쿼리 세트를 사용합니다.
        * **슈퍼픽셀 분할**: 이미지 그리드에서 $K$개의 위치 임베딩된 픽셀 특징을 샘플링하고 FFN에 통과시켜 초기 쿼리 $C^{(0)} = \text{FFN}(\text{GridSample}_K(\text{PE}(I)))$를 얻습니다. (Eq. 9)
    * **Recurrent Cross-Attention 기반 디코더 (Recursive Clustering)**: Dreamy-Start로 초기화된 클러스터 중심 $C^{(0)}$와 픽셀 임베딩 $I$를 사용하여 반복적인 픽셀 클러스터링을 수행합니다.
        * 각 `Recurrent Cross-Attention` 레이어는 $T$번의 반복을 통해 클러스터 할당(E-단계)과 중심 업데이트(M-단계)를 수행합니다.
        * **E-단계 (클러스터링)**: 쿼리 $Q_C^{(t)}$와 이미지 키 $K_I$ 간의 어피니티를 계산하고 소프트맥스 함수를 적용하여 픽셀-클러스터 할당 확률 행렬 $\hat{M}^{(t)} = \text{softmax}_K(Q_C^{(t)}(K_I)^>)$를 얻습니다. (Eq. 10)
        * **M-단계 (중심 업데이트)**: 할당 확률 $\hat{M}^{(t)}$를 사용하여 이미지 값 $V_I$로부터 새로운 클러스터 중심 $C^{(t+1)} = \hat{M}^{(t)} V_I$를 재계산합니다. (Eq. 10)
        * 쿼리, 키, 값에 대한 선형 투영 가중치는 반복 전반에 걸쳐 공유되어 추가 매개변수 없이 재귀성을 달성합니다.
        * 여러 개의 `Recurrent Cross-Attention` 레이어($L$개)가 계층적으로 구성되며, 각 레이어는 하위 해상도 이미지 특징 $I_{l+1}$와 클러스터 중심 $C_{l+1}$를 입력받아 새로운 중심 $C_l = C_{l+1} + \text{RCrossAttention}_{l+1}(I_{l+1}, C_{l+1})$을 생성합니다. (Eq. 11)
    * **픽셀 디코더 (Pixel Decoder)**: 인코더에서 얻은 멀티스케일 특징을 바탕으로 최종적인 고해상도 분할 마스크를 복구합니다.
2. **손실 함수**: 각 태스크 설정에 맞는 표준 손실 함수를 사용하며, `Recurrent Cross-Attention`의 모든 E-단계에서 생성되는 중간 예측에도 중간/심층 감독(intermediate/deep supervision)을 적용하여 학습을 강화합니다.

## 📊 실험 결과

CLUSTSEG는 네 가지 핵심 분할 작업에서 모두 최첨단 성능을 달성했습니다:

* **파놉틱 분할 (COCO Panoptic val)**: Swin-B 백본 사용 시 59.0 PQ를 달성하여 Mask2Former 및 K-Net과 같은 범용 모델과 기존 특화된 파놉틱 모델들을 크게 능가했습니다. 특히 ConvNeXt-B 백본에서는 kMax-Deeplab 대비 PQ, PQ$_{Th}$, PQ$_{St}$에서 각각 2.6%, 2.1%, 2.0%의 향상을 보였습니다.
* **인스턴스 분할 (COCO test-dev)**: Swin-B 백본 사용 시 49.1 AP를 달성하며 Mask2Former(47.9 AP) 및 K-Net(46.1 AP)을 포함한 모든 이전 모델들을 뛰어넘었습니다.
* **시맨틱 분할 (ADE20K val)**: Swin-B 백본 사용 시 57.4 mIoU를 달성하여 Mask2Former(54.5 mIoU)보다 우수한 성능을 보였고, Segformer, Segmenter, SETR과 같은 다른 전문 시맨틱 분할 모델보다도 큰 차이로 앞섰습니다.
* **슈퍼픽셀 분할 (BSDS500 test, NYUv2 test)**: ASA(Achievable Segmentation Accuracy) 및 CO(Compactness) 지표 모두에서 SLIC과 같은 고전적인 방법은 물론, SSFCN, LNS와 같은 딥러닝 기반 경쟁 모델들보다 우수한 성능을 기록했습니다. 특히 BSDS500에서 0.957 ASA를 달성했습니다.
* **어블레이션 연구**: Dreamy-Start와 Recurrent Cross-Attention이 각각 독립적으로 그리고 함께 사용되었을 때 성능 향상에 크게 기여함을 확인했습니다. Dreamy-Start는 쿼리 초기화 방식을 커스터마이징함으로써 PQ를 49.7%에서 51.0%로 향상시켰고, Recurrent Cross-Attention은 Baseline 대비 PQ를 3.5% 상승시켰습니다.

## 🧠 고찰 및 논의

* **장점**:
  * **투명성 및 통찰력**: "클러스터링을 통한 분할"이라는 근본적인 원리를 명시적으로 인식하고 이를 모델 설계에 반영하여, 기존의 블랙박스 같은 모델에 비해 더 투명하고 이해하기 쉬운 프레임워크를 제공합니다.
  * **다목적성 및 유연성**: 단일 아키텍처로 네 가지 주요 분할 작업을 모두 처리하며, Dreamy-Start를 통해 네트워크 구조 변경 없이 태스크별 이질적 특성을 수용합니다.
  * **강력한 성능**: 모든 벤치마크에서 기존의 최첨단 전문 모델과 범용 모델을 능가하는 뛰어난 성능을 입증했습니다.
  * **효율성**: `Recurrent Cross-Attention`은 일반적인 크로스-어텐션보다 계산 복잡도가 낮고, 재귀적 특성을 통해 추가 학습 가능한 매개변수 없이 반복적인 클러스터링을 수행합니다.
* **한계**:
  * 각 학습 반복에서 추가 클러스터링 루프를 사용하는 것이 계산 효율성 측면에서 약간의 오버헤드(학습 속도 5.19% 감소)를 발생시킬 수 있습니다.
  * 고도로 유사하거나 가려진 인스턴스, 복잡한 토폴로지를 가진 객체, 작은 객체, 심하게 변형된 객체, 왜곡된 배경 등 극도로 복잡한 시나리오에서는 객체와 배경을 분리하는 데 어려움을 겪는 실패 사례가 관찰되었습니다.
* **시사점**: CLUSTSEG는 이미지 분할 커뮤니티를 통합하고 각 하위 태스크의 고유한 특성을 존중하는 범용적이고 투명한 프레임워크를 제시합니다. 이는 자율 주행, 로봇 내비게이션, 의료 영상 등 광범위한 밀집 시각 예측(dense visual prediction) 분야에 기여할 잠재력을 가지고 있습니다. 다만, 실제 응용 분야에서의 오차 발생 시 안전 프로토콜 마련의 중요성을 강조합니다.

## 📌 요약 (TL;DR)

본 논문은 다양한 이미지 분할 작업을 통합하는 Transformer 기반 프레임워크인 **CLUSTSEG**를 제안합니다. 전통적으로 태스크별로 분리되어 수행되던 슈퍼픽셀, 시맨틱, 인스턴스, 파놉틱 분할을 **픽셀 클러스터링**이라는 단일 원리로 접근합니다. 이를 위해, 태스크의 특성을 반영하여 쿼리를 초기화하는 혁신적인 **Dreamy-Start** 기법과 EM 클러스터링 원리에 따라 픽셀-클러스터 할당과 클러스터 중심 업데이트를 반복적으로 수행하는 **Recurrent Cross-Attention** 메커니즘을 도입합니다. CLUSTSEG는 이러한 설계를 통해 추가 매개변수 없이 효율적인 클러스터링을 수행하며, 모든 핵심 분할 벤치마크에서 기존 최첨단 모델들을 능가하는 우수한 성능을 달성하여 범용적이고 투명한 분할 솔루션의 가능성을 제시합니다.
