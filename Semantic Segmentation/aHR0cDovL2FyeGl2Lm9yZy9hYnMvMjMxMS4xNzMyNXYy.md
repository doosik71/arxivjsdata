# Alternate Diverse Teaching for Semi-supervised Medical Image Segmentation

Zhen Zhao, Zicheng Wang, Longyue Wang, Dian Yu, Yixuan Yuan, and Luping Zhou

## 🧩 Problem to Solve

반지도 학습 기반의 의료 영상 분할(SS-MIS)은 제한된 레이블 데이터로 모델을 훈련하는 데 유망하지만, 기존의 주류 교사-학생(teacher-student) 접근법은 **확증 편향(confirmation bias)** 문제로 인해 노이즈가 많거나 잘못된 의사 레이블(pseudo-labels)을 생성하는 경향이 있습니다. 이는 훈련 안정성에 부정적인 영향을 미치고 모델의 인식 능력을 저해할 수 있습니다.

## ✨ Key Contributions

* **AD-MT(Alternate Diverse Teaching)** 제안: 확증 편향 완화를 위해 교사-학생 프레임워크에서 교사 모델의 다양성을 극대화하는 새로운 접근 방식을 제시합니다.
* **RPA(Random Periodic Alternate) 업데이트 모듈** 설계: 두 교사 모델의 다양성을 높이고 서로 보완적인 학습을 유도하기 위해 교사 모델을 주기적으로 무작위로 교대하며 업데이트하는 방식을 제안합니다.
* **CCM(Conflict-Combating Module) 제안**: 두 교사 모델 간의 예측 불일치(conflicting predictions)를 직접적으로 처리하고, 이를 통해 모델이 일관된 예측뿐만 아니라 불일치하는 예측에서도 학습하도록 유도합니다.
* **새로운 SOTA 성능 달성**: 추가적인 제약 조건이나 훈련 비용 없이 2D 및 3D SSMIS 벤치마크에서 기존의 최신(SOTA) 방법보다 뛰어난 성능을 달성했습니다.

## 📎 Related Works

* **일관성 정규화(Consistency Regularization, CR) 기반 접근법**: SS-MIS 분야의 주류를 이루는 방법으로, 동일한 비레이블 입력에 대해 모델이 일관된 예측을 생성하도록 장려합니다. (e.g., Mean-teacher, UA-MT)
* **확증 편향 해결 노력**:
  * **간접적인 해결**: 추가적인 훈련 제약 도입 (e.g., DTC, SASS-Net, SS-Net).
  * **다양한 감독 신호 증가**:
    * **다중 학생 공통 훈련(Multi-student co-training)**: 두 개 이상의 학생 모델이 서로를 상호 감독하여 다양한 추론을 유도 (e.g., CPS, MC-Net+). 추가 훈련 비용이 발생하고 동일한 네트워크 구조에서는 충분한 불일치 생성이 어려울 수 있습니다.
    * **다중 교사 앙상블(Multi-teacher ensembling)**: 학생 모델이 여러 교사 모델을 반복적으로 업데이트하며 다양한 관점을 활용 (e.g., PS-MT). 추가 훈련 매개변수 없이 감독 다양성을 확보하지만, 교사 모델 업데이트 전략이 충분히 다양하게 설계되지 않았거나 불일치 예측을 주로 버리는 경향이 있습니다.

## 🛠️ Methodology

AD-MT는 단일 학습 가능한 학생 모델($\theta_s$)과 두 개의 학습 불가능한 교사 모델($\theta_{t1}$, $\theta_{t2}$)을 활용합니다. 교사 모델은 학생 모델 가중치의 지수 이동 평균(EMA)으로 교대로 업데이트됩니다.

1. **감독 손실 ($L_x$)**: 레이블이 있는 데이터($B_x$)에 대해 표준 감독 손실을 계산합니다.
    $$ L_x = \frac{1}{|B_x|} \sum_{i=1}^{B_x} \frac{1}{H \times W} \sum_{j=1}^{H \times W} \ell(\hat{y}_i(j), y_i(j)) $$
    여기서 $\ell$은 Dice 손실과 Cross-entropy 손실의 평균입니다.

2. **비레이블 데이터 활용**: 두 교사 모델 ($T_1, T_2$)과 학생 모델은 모두 약한 증강($a(\cdot)$)이 적용된 비레이블 데이터 $u_i$에 대해 의사 레이블($q_{t1,i}, q_{t2,i}, q_{s,i}$)을 생성합니다.

3. **총 훈련 손실 ($L$)**:
    $$ L = L_x + \lambda_t L_u $$
    여기서 $L_u$는 비레이블 데이터에 대한 일관성 손실입니다. $L_u$는 CCM에서 생성된 최종 의사 레이블 $q_i$를 사용하여 계산됩니다.
    $$ L_u = \frac{1}{|B_u|} \sum_{i=1}^{\mu B} \frac{1}{H \times W} \sum_{j=1}^{H \times W} \ell(p_i(j), q_i(j)) $$
    여기서 $p_i = f(A_m(u_i); \theta_s)$는 강하게 증강된 비레이블 데이터에 대한 학생 모델의 예측입니다. $A_m \in \{A_1, A_2\}$는 교사 교대 턴에 해당하는 두 가지 다른 강한 데이터 증강 전략입니다.

4. **RPA(Random Periodic Alternate) 업데이트 모듈**: 두 교사 모델의 다양성을 극대화하기 위해 다음과 같은 전략을 사용합니다.
    * **교대 업데이트**: 각 반복에서 두 교사 모델 중 하나만 업데이트됩니다. 이를 통해 고유하고 보완적인 비레이블 데이터 배치가 각 교사 모델을 개선하는 데 사용됩니다.
    * **고유한 증강 전략**: T1 턴에는 Color-jitting을, T2 턴에는 Copy-paste 증강을 적용하여 교사 모델 간의 다양성을 더욱 높입니다.
    * **무작위 전환 주기**: 고정된 주기가 아닌, 사전 정의된 최대 주기($T_{max}$) 내에서 각 교사의 교대 주기를 무작위로 생성합니다.
        $$ T_m \leftarrow \text{random.randint}(0, T_{max}), \quad m \in \{1,2\} $$

5. **CCM(Conflict-Combating Module)**: 두 교사 모델 간의 예측 불일치 문제를 해결합니다.
    * **일관성/불일치 예측 분리**:
        * **앙상블 예측($\psi_i$)**: 두 교사 모델의 예측 엔트로피 $H_{t1}, H_{t2}$를 기반으로 엔트로피 가중치를 부여한 앙상블 예측을 얻습니다.
            $$ H_{t1} = H(q_{t1,i}) = - \sum_{k=1}^C q_{t1,i}^{(k)} \log_2 q_{t1,i}^{(k)} $$
            $$ \psi_i = \psi(q_{t1,i}, q_{t2,i}) = \frac{w_1 q_{t1,i} + w_2 q_{t2,i}}{w_1 + w_2}, \quad \text{where } w_1=e^{-H_{t1}}, w_2=e^{-H_{t2}} $$
        * **최종 의사 레이블($q_i$)**: 교사 모델이 불일치하는 경우($q_{t1,i} \neq q_{t2,i}$), 학생 모델의 예측 엔트로피와 앙상블 예측의 엔트로피를 비교하여 엔트로피가 낮은 쪽(더 신뢰할 수 있는 쪽)을 최종 감독으로 선택합니다. 일관된 경우에는 앙상블 예측을 사용합니다.
            $$ q_i(j) = \begin{cases} 1(\max(q_{s,i}(j)) \ge \tau) q_{s,i}(j), & q_{t1,i} \ne q_{t2,i} \land H_{\psi_i(j)} > H_{q_{s,i}(j)} \\ 1(\max(\psi_i(j)) \ge \tau) \psi_i(j), & \text{otherwise} \end{cases} $$
            여기서 $1(\cdot)$은 높은 신뢰도($\ge \tau$) 예측만 선택합니다.

## 📊 Results

* **3D LA, 2D ACDC, 3D Pancreas 데이터셋**: 다양한 레이블 데이터 비율(5%, 10%, 20%)에서 실험을 진행했습니다.
* **SOTA 성능 달성**:
  * **LA 데이터셋**: 5% 레이블 데이터 설정에서 Dice Score 89.63%를 달성하여 SOTA BCP보다 1.61%p 높은 성능을 보였습니다. 95HD 및 ASD 지표에서도 가장 낮은 값을 기록하여 더 정확한 분할 결과를 입증했습니다.
  * **ACDC 데이터셋**: 5% 레이블 데이터 설정에서 Dice Score 88.75%를 달성하여 BCP보다 1.16%p 높았으며, BCP와 달리 추가적인 사전 훈련 단계가 필요하지 않아 효율적입니다.
  * **Pancreas 데이터셋**: 10% 레이블 데이터 설정에서 Dice Score 80.21%를 달성하여 BCP보다 6.38%p 높은 성능을 보였습니다. 20% 설정에서도 95HD와 ASD가 가장 낮아 가장 정밀한 분할 결과를 보였습니다.
* **구성 요소별 효과 (Ablation Study)**:
  * T1-only보다 T2-only가 약간 더 좋은 성능을 보였고, RPA 모듈을 사용하여 T1과 T2를 함께 사용했을 때 평균 Dice Score가 1% 이상 향상되었습니다.
  * CCM을 포함한 완전한 AD-MT가 가장 낮은 95HD와 가장 높은 Dice Score를 달성하여 각 모듈의 중요성을 입증했습니다.
* **임계값($\tau$) 영향**: ACDC (2D)는 $\tau=0.95$에서, LA (3D)는 $\tau=0.75$에서 최상의 성능을 보였습니다. 3D 데이터셋에서는 너무 높은 임계값이 예측을 과도하게 필터링하여 정보 손실을 초래할 수 있음을 시사합니다.
* **전환 주기($T_{max}$) 영향**: 고정 주기보다 무작위 주기가 일관되게 더 나은 성능을 보였습니다. 무작위성이 두 교사 모델 간의 다양성을 더욱 확대하기 때문입니다.
* **앙상블 전략 영향**: 불일치 예측을 완전히 버리는 것보다 평균 기반 또는 엔트로피 기반 앙상블이 성능을 향상시켰고, CCM이 학생 모델의 강점까지 활용하여 가장 높은 Dice Score를 달성했습니다.
* **시각화**: LA 및 ACDC 데이터셋의 정성적 결과는 AD-MT가 다른 SOTA 방법보다 실제 마스크에 더 가까운 분할 결과를 생성함을 보여주었습니다.

## 🧠 Insights & Discussion

* AD-MT는 제한된 레이블 데이터 상황에서 의료 영상 분할의 확증 편향 문제를 효과적으로 해결합니다.
* RPA 모듈은 교사 모델의 EMA 업데이트에 무작위성과 다양성을 도입하여, 단순히 다른 초기화나 학습률을 사용하는 것을 넘어 교사 모델 간의 불일치를 효과적으로 증가시킵니다. 특히 보완적인 데이터 배치, 고유한 데이터 증강, 무작위 전환 주기를 통해 이 다양성을 확보하는 점이 중요합니다.
* CCM은 기존 방법들이 불일치 예측을 무시했던 한계를 넘어, 엔트로피 기반 전략과 학생 모델의 신뢰도를 활용하여 불일치로부터도 학습할 수 있게 하여 모델의 견고성과 성능을 향상시켰습니다.
* AD-MT는 추가적인 훈련 비용 없이 SOTA 성능을 달성하여 실제 적용 가능성이 높습니다.
* 2D와 3D 데이터셋에서 최적의 임계값 $\tau$가 다르다는 점은 데이터의 차원적 특성이나 복잡성에 따라 신뢰도 기준을 조절하는 것이 중요함을 시사합니다.

## 📌 TL;DR

본 논문은 제한된 레이블 데이터로 인한 의료 영상 분할의 확증 편향 문제를 해결하기 위해 **AD-MT(Alternate Diverse Teaching)** 프레임워크를 제안합니다. AD-MT는 **RPA(Random Periodic Alternate) 업데이트 모듈**을 통해 두 교사 모델이 보완적인 데이터 배치, 고유한 데이터 증강, 무작위 전환 주기를 사용하여 주기적/무작위로 교대 업데이트되며 다양한 감독 신호를 생성합니다. 또한, **CCM(Conflict-Combating Module)**은 교사 모델 간의 예측 불일치를 버리지 않고, 엔트로피 기반 앙상블과 학생 모델의 신뢰도를 활용하여 모델이 일관된 예측과 불일치하는 예측 모두로부터 학습하도록 합니다. 결과적으로 AD-MT는 추가 훈련 비용 없이 2D 및 3D 의료 영상 분할 벤치마크에서 새로운 SOTA 성능을 달성했습니다.
