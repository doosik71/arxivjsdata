# Per-Pixel Classification is Not All You Need for Semantic Segmentation

Bowen Cheng, Alexander G. Schwing, Alexander Kirillov

## 🧩 Problem to Solve

최신 이미지 분할(segmentation) 기법은 보통 시맨틱 분할(semantic segmentation)을 픽셀별 분류(per-pixel classification) 문제로 공식화합니다. 반면, 인스턴스 분할(instance segmentation)은 마스크 분류(mask classification)를 사용합니다. 이러한 패러다임의 불일치는 두 작업 간의 모델 개발을 방해하며, 픽셀별 분류는 출력 개수가 고정되어 있어 가변적인 수의 영역을 예측해야 하는 인스턴스 수준 작업에는 적합하지 않습니다. 특히 클래스 수가 많은 데이터셋에서 픽셀별 분류의 성능 한계가 드러납니다. 본 논문은 단일 마스크 분류 모델이 시맨틱 및 인스턴스 수준 분할을 통합하고 기존 픽셀별 분류 방법보다 뛰어난 성능을 보일 수 있는지 탐구합니다.

## ✨ Key Contributions

* **통합된 분할 패러다임 제시**: 시맨틱 분할과 인스턴스 분할(파노펩틱 분할 포함)을 동일한 모델, 손실 함수, 학습 절차를 사용하여 통합적으로 해결하는 마스크 분류 모델인 **MaskFormer**를 제안합니다.
* **간단하면서도 강력한 아키텍처**: 기존의 픽셀별 분류 모델을 마스크 분류 모델로 변환하는 간단한 구조를 제시하며, 이는 트랜스포머 디코더를 사용하여 이진 마스크 집합과 각 마스크에 대한 단일 전역 클래스 예측을 수행합니다.
* **최첨단 성능 달성**:
  * ADE20K 시맨틱 분할 벤치마크에서 55.6 mIoU를 달성하여 새로운 최첨단 기록을 세웠습니다.
  * COCO 파노펩틱 분할에서 52.7 PQ를 달성하여 새로운 최첨단 기록을 세웠습니다.
* **대규모 클래스 데이터셋에서의 우수성**: 클래스 수가 많은 데이터셋(예: ADE20K-Full)에서 기존 픽셀별 분류 모델 대비 월등한 성능 향상을 보였습니다.
* **효율성**: 기존 픽셀별 분류 모델보다 적은 파라미터와 FLOPs로 더 나은 성능을 달성하여 효율성 측면에서도 강점을 보였습니다.
* **보조 손실 제거**: 바운딩 박스 손실이나 인스턴스 차별화 손실과 같은 복잡한 보조 손실 없이도 강력한 성능을 달성합니다.

## 📎 Related Works

* **픽셀별 분류(Per-pixel classification)**:
  * 초기 연구: Konishi and Yuille [25].
  * 딥러닝 기반: Fully Convolutional Networks (FCNs) [30]가 지배적인 패러다임을 형성했습니다. 이후 ASPP [7,8], PPM [52]을 활용한 DeepLab 시리즈, DANet [19], OCNet [51], CCNet [23] 등이 발전했습니다.
  * 최근 트랜스포머 기반: SETR [53], Segmenter [37]와 같은 모델도 여전히 픽셀별 분류 방식을 사용합니다.
* **마스크 분류(Mask classification)**:
  * FCN 이전: O2P [5], CFM [16], SDS [20]와 같은 방법들이 마스크 분류 방식을 사용하여 우수한 성능을 보였습니다.
  * 인스턴스 수준 분할: Mask R-CNN [21]은 마스크 제안(mask proposals)을 분류하며, DETR [4]은 트랜스포머를 도입하여 물체(thing)와 배경(stuff)을 동시에 처리합니다.
  * 바운딩 박스 없는 파노펩틱 분할: Max-DeepLab [42]은 박스 예측 의존성을 제거했지만, 여러 보조 손실을 필요로 했습니다.

## 🛠️ Methodology

MaskFormer는 이미지를 $N$개의 이진 마스크와 각 마스크에 연결된 단일 클래스 레이블 예측으로 분할하는 마스크 분류 패러다임을 따릅니다. 모델은 크게 세 가지 모듈로 구성됩니다.

1. **픽셀 수준 모듈 (Pixel-level module)**:
    * 백본(예: ResNet, Swin-Transformer)은 입력 이미지에서 저해상도 이미지 특징 $\mathcal{F} \in \mathbb{R}^{C_F \times \frac{H}{S} \times \frac{W}{S}}$를 추출합니다.
    * 픽셀 디코더(FPN 기반의 경량 디코더 사용)는 이 특징을 점진적으로 업샘플링하여 픽셀별 임베딩 $E_{\text{pixel}} \in \mathbb{R}^{C_E \times H \times W}$를 생성합니다. 이 모듈은 기존의 픽셀별 분류 모델의 특징 추출 부분을 활용할 수 있습니다.

2. **트랜스포머 모듈 (Transformer module)**:
    * 표준 트랜스포머 디코더 [41]를 사용합니다.
    * 이미지 특징 $\mathcal{F}$와 $N$개의 학습 가능한 위치 임베딩(쿼리)을 입력으로 받아 $N$개의 세그먼트별 임베딩 $Q \in \mathbb{R}^{C_Q \times N}$를 병렬로 계산합니다. 각 임베딩은 해당 세그먼트에 대한 전역 정보를 인코딩합니다.

3. **분할 모듈 (Segmentation module)**:
    * 세그먼트별 임베딩 $Q$를 바탕으로 $N$개의 클래스 확률 예측 $\{p_i \in \Delta^{K+1}\}_{i=1}^N$ (보조 레이블 $\emptyset$ 포함)을 위한 선형 분류기와 소프트맥스 활성화 함수를 적용합니다.
    * 마스크 예측을 위해 MLP가 $Q$를 $N$개의 마스크 임베딩 $E_{\text{mask}} \in \mathbb{R}^{C_E \times N}$로 변환합니다.
    * 각 이진 마스크 $m_i \in [0,1]^{H \times W}$는 $i$-번째 마스크 임베딩 $E_{\text{mask}}[:,i]^{\mathsf{T}}$와 픽셀별 임베딩 $E_{\text{pixel}}[:,h,w]$ 간의 내적 후 시그모이드 활성화 함수를 통해 얻어집니다. 마스크는 상호 배타적일 필요가 없습니다.

**손실 함수**:

* MaskFormer는 이분 매칭(bipartite matching)을 기반으로 예측된 마스크 집합과 실제 마스크 집합 간의 최적의 매칭 $\sigma$를 찾습니다. 매칭 비용은 클래스 예측과 이진 마스크 손실 $L_{\text{mask}}$(Focal loss와 Dice loss의 선형 결합)을 사용합니다.
* 전체 손실 $L_{\text{mask-cls}}$는 매칭된 각 예측 세그먼트에 대한 교차 엔트로피 분류 손실과 이진 마스크 손실로 구성됩니다:
    $$L_{\text{mask-cls}}(z,z_{\text{gt}}) = \sum_{j=1}^N \left[ -\log p_{\sigma(j)}(c^{\text{gt}}_j) + \mathbf{1}_{c^{\text{gt}}_j \neq \emptyset} L_{\text{mask}}(m_{\sigma(j)},m^{\text{gt}}_j) \right]$$
* 별도의 보조 손실 없이 이 단일 손실로 학습합니다.

**추론 전략**:

* **일반 추론 (General inference)**: 각 픽셀 $[h,w]$을 $\arg \max_{i:c_i \neq \emptyset} p_i(c_i) \cdot m_i[h,w]$를 통해 $N$개의 예측 확률-마스크 쌍 중 하나에 할당합니다. 파노펩틱 분할에 사용되며, 저확신도 예측을 필터링합니다.
* **시맨틱 추론 (Semantic inference)**: 시맨틱 분할에 특화된 전략으로, $\arg \max_{c \in \{1,...,K\}} \sum_{i=1}^N p_i(c) \cdot m_i[h,w]$를 통해 각 픽셀의 클래스를 결정합니다. 이는 여러 쿼리로부터의 마스크 예측을 집계하여 픽셀 수준의 정확도를 높입니다.

## 📊 Results

MaskFormer는 시맨틱 및 파노펩틱 분할 데이터셋 모두에서 최첨단 성능을 달성하며, 두 분할 작업을 성공적으로 통합했음을 입증했습니다.

* **시맨틱 분할**:
  * **ADE20K (150개 클래스)**: Swin-L 백본으로 55.6 mIoU를 달성하여 기존 최첨단 모델(Swin-UperNet)보다 2.1 mIoU 높은 성능을 기록했습니다. 파라미터 수와 FLOPs가 더 적으면서도 뛰어난 성능을 보였습니다.
  * **클래스 수에 따른 성능**: 클래스 수가 많은 데이터셋(예: ADE20K-Full, 847개 클래스)에서 MaskFormer는 기존 픽셀별 분류 베이스라인 대비 3.5 mIoU 크게 향상되었습니다. 반면 Cityscapes(19개 클래스)에서는 mIoU는 비슷했으나, PQ$_{\text{St}}$(stuff panoptic quality) metric은 2.9 포인트 향상되었습니다.
  * **고해상도 이미지 (Mapillary Vistas)**: 단일 스케일 추론만으로도 멀티 스케일 픽셀별 분류 모델보다 우수한 성능을 보여, 트랜스포머 디코더가 포착하는 전역적 컨텍스트의 중요성을 시사합니다.
* **파노펩틱 분할**:
  * **COCO (133개 카테고리)**: Swin-L 백본으로 52.7 PQ를 달성하여 새로운 최첨단 성능을 기록했습니다. 기존 DETR [4] 및 Max-DeepLab [42]보다 뛰어난 성능을 보였으며, 특히 PQ$_{\text{St}}$("stuff" 클래스)에서 큰 향상을 보였습니다. 이는 마스크 기반 접근 방식이 모호한 "stuff" 영역을 바운딩 박스보다 잘 처리함을 나타냅니다.
  * 복잡한 보조 손실 없이도 SOTA를 달성했습니다.

* **어블레이션 스터디 (Ablation Studies)**:
  * **픽셀별 분류 vs. 마스크 분류**: MaskFormer의 성능 향상은 픽셀별 분류에서 마스크 분류로의 패러다임 전환(1.8 mIoU 향상)에서 비롯됨을 확인했습니다.
  * **매칭 전략**: 이분 매칭이 고정 매칭보다 성능이 우수하며(0.5 mIoU, 3.1 PQ$_{\text{St}}$ 향상), 더 유연합니다.
  * **쿼리 개수**: 100개의 쿼리가 대부분의 데이터셋에서 일관적으로 가장 좋은 성능을 보였으며, 쿼리 개수가 카테고리 수에 크게 의존하지 않음을 시사합니다.
  * **트랜스포머 디코더 레이어 개수**: 시맨틱 분할에서는 단일 디코더 레이어로도 뛰어난 성능을 보였지만, 파노펩틱 분할에서는 중복 예측 제거를 위해 여러 레이어가 중요했습니다.

## 🧠 Insights & Discussion

* **분할 작업의 통합**: MaskFormer는 시맨틱 및 인스턴스 수준 분할을 동일한 모델, 손실, 학습 파이프라인으로 처리할 수 있음을 입증하며, 이는 분할 분야의 발전을 가속화할 잠재력을 가집니다.
* **DETR의 "박스 없는(box-free)" 버전**: MaskFormer는 DETR [4]에서 바운딩 박스 예측 헤드를 제거하고 마스크 기반 매칭을 도입하여 순수한 마스크 분류 설정으로 전환한 것으로 볼 수 있습니다.
* **마스크 매칭의 우수성**: 특히 "stuff" 카테고리와 같이 바운딩 박스로 표현하기 모호한 영역에서 마스크 기반 매칭이 박스 기반 매칭보다 우수함을 보여주었습니다.
* **효율적인 마스크 헤드**: MaskFormer의 FPN 기반 마스크 헤드는 DETR의 쿼리별 마스크 헤드보다 계산 비용이 훨씬 낮아, 박스 감독 없이도 엔드-투-엔드 학습을 가능하게 합니다.
* **쿼리의 유연한 적응성**: MaskFormer의 쿼리는 주어진 어노테이션에 따라 동작을 유연하게 조절합니다. 시맨틱 분할에서는 단일 쿼리가 여러 인스턴스를 하나의 마스크로 통합할 수 있지만, 인스턴스 분할에서는 각 쿼리가 개별 인스턴스를 예측하여 구분합니다.
* **한계점**: 클래스 인식이 비교적 쉬운 데이터셋(예: Cityscapes)에서는 마스크 분류 기반 접근 방식의 주된 과제가 픽셀 수준의 정확도(마스크 품질)일 수 있습니다.

## 📌 TL;DR

* **문제**: 시맨틱 분할과 인스턴스 분할은 각기 다른(픽셀별 vs. 마스크) 분류 패러다임을 사용하며, 픽셀별 분류는 많은 클래스를 처리하는 데 한계가 있습니다.
* **제안**: MaskFormer는 마스크 분류 패러다임을 채택하여 시맨틱 및 인스턴스 분할을 동일한 모델, 손실, 학습 절차로 통합합니다. 트랜스포머 디코더를 사용하여 이진 마스크 집합과 각 마스크에 대한 단일 클래스 레이블을 예측합니다.
* **결과**: MaskFormer는 ADE20K 시맨틱 분할(55.6 mIoU) 및 COCO 파노펩틱 분할(52.7 PQ)에서 최첨단 성능을 달성하며, 특히 클래스 수가 많을 때 기존 방법을 능가합니다. 이는 마스크 분류가 분할 작업 전반에 걸쳐 유망하고 효율적인 일반화된 접근 방식임을 입증합니다.
