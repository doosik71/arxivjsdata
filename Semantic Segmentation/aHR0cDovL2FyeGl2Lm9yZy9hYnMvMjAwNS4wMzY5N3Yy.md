# Source-Relaxed Domain Adaptation for Image Segmentation

Mathilde Bateson, Hoel Kervadec, Jose Dolz, Hervé Lombaert, and Ismail Ben Ayed

## 🧩 Problem to Solve

대부분의 도메인 적응(DA) 기술은 훈련 단계에서 원본(source) 도메인과 대상(target) 도메인의 이미지에 동시에 접근해야 합니다. 그러나 실제 시나리오, 특히 의료 영상 분야에서는 프라이버시 문제나 데이터 손실 등으로 인해 원본 이미지를 적응 단계에서 사용할 수 없는 경우가 빈번합니다. 이 연구는 원본 이미지에 접근할 수 없는 상황에서 영상 분할(image segmentation)을 위한 도메인 적응 문제를 해결하는 것을 목표로 합니다.

## ✨ Key Contributions

* 원본 데이터(이미지 및 레이블)에 접근할 필요 없이 대상 도메인에서 레이블 없는 엔트로피 손실(entropy loss)을 최소화하는 새로운 도메인 적응 프레임워크를 제안했습니다.
* 엔트로피 최소화의 퇴행적 솔루션(trivial solution)을 방지하기 위해 도메인 불변 사전(domain-invariant prior)인 클래스 비율 사전(class-ratio prior)을 통합했습니다. 이 사전은 보조 네트워크를 통해 학습되며 쿨백-라이블러 발산(Kullback–Leibler divergence) 형태로 전체 손실 함수에 포함됩니다.
* 원본 데이터에 접근할 수 없는 제약된 환경임에도 불구하고, 제안된 방법이 최신 도메인 적응 기법(원본 데이터에 접근 가능한)들과 비교할 만하거나 더 나은 성능을 달성함을 척추 MRI 영상 분할 실험을 통해 입증했습니다.
* 하나의 네트워크만을 사용하여 적응을 수행하므로, 원본 이미지가 필수적인 적대적(adversarial) 기법보다 단순하고 효율적인 전략을 제공합니다.
* 다양한 사전(prior)과 분할 문제에 쉽게 적용 가능한 일반적인 프레임워크를 제시했습니다.

## 📎 Related Works

* **기존 도메인 적응(DA) 연구:** 주석이 달린 원본 도메인에서 모델을 주석이 없거나 최소한의 주석이 있는 대상 도메인으로 전이하는 것이 목표입니다.
* **적대적 DA 전략 [4, 9, 10, 23, 2, 6, 7, 17]:** 현재 지배적인 DA 기법으로, 이미지를 한 도메인에서 다른 도메인으로 변환하거나(생성적 접근법 [25]), 모델이 학습한 특징 또는 출력 공간의 불일치를 최소화합니다. 그러나 대부분의 적대적 기법은 적응 단계에서 원본 및 대상 데이터에 동시에 접근해야 하는 제약이 있습니다.
* **자기 훈련(Self-training) 및 엔트로피 최소화 [26, 19, 20, 15]:** 적대적 기법의 대안으로 연구되었습니다. 모델이 훈련된 모달리티 내에서는 높은 확신을 보이지만, 새로운 모달리티에서는 불확실성이 높다는 관찰에서 출발하여 대상 도메인에서 높은 확신을 강제함으로써 성능 격차를 줄입니다.
* **기존 엔트로피 기반 DA [19, 20]:** 엔트로피 최소화의 퇴행적 솔루션을 방지하기 위해 적응 단계에서 원본 데이터(이미지 및 레이블)에 대한 교차 엔트로피 손실을 사용했습니다. 이는 여전히 원본 데이터 접근을 필요로 합니다.
* **도메인 지식 사전(domain-knowledge priors) 활용 [24, 11, 22, 1]:** 클래스 비율 또는 크기에 대한 사전을 통합하여 제한된 레이블 데이터 환경에서 딥 네트워크를 안내하는 연구들이 있었습니다. 그러나 [22, 1]과 같은 연구들은 도메인 적응에서 사전을 사용했음에도 불구하고, 적응 단계에서 원본 데이터에 접근했습니다.

## 🛠️ Methodology

이 연구는 원본 이미지 없이 대상 도메인에 대한 영상 분할 네트워크를 적응시키는 새로운 손실 함수를 제안합니다.

1. **원본 도메인 훈련:**
    * 먼저, 분할 네트워크($\theta$)는 레이블링된 원본 도메인 데이터($I_s$)를 사용하여 표준 지도 학습(supervised learning) 방식으로 훈련됩니다.
    * 사용되는 손실 함수는 일반적인 교차 엔트로피 손실($\mathcal{L}_s$)입니다:
        $$ L_s(\theta, \Omega_s) = \frac{1}{|\Omega_s|}\sum_{s=1}^S \mathcal{L}(y_s(i), p_s(i,\theta)) $$
        여기서 $\mathcal{L}(y_s(i), p_s(i,\theta)) = -\sum_k y_k^s(i) \log p_k^s(i,\theta)$ 이고, $p_s(i,\theta)$는 네트워크의 소프트맥스(softmax) 출력입니다.

2. **대상 도메인 적응 (주요 방법론):**
    * **엔트로피 최소화:** 대상 도메인 이미지($I_t$)에 대해 네트워크 출력($p_t(i,\theta)$)의 엔트로피를 최소화하여 높은 확신(confidence)을 유도합니다:
        $$ \mathcal{L}_{ent}(p_t(i,\theta)) = -\sum_k p_k^t(i,\theta) \log p_k^t(i,\theta) $$
    * **클래스 비율 사전 통합:** 엔트로피 최소화만으로는 퇴행적 솔루션(즉, 모든 픽셀을 한 클래스로 예측)으로 수렴할 수 있으므로, 도메인 불변 사전인 클래스 비율 사전($\tau_e(t,k)$)을 도입합니다.
        * **클래스 비율 사전 학습:** 보조 회귀 네트워크($R$)는 원본 도메인의 이미지와 해당 참값 클래스 비율($\tau_{GT}(s,k)$)을 사용하여 훈련됩니다. 이 네트워크를 통해 대상 도메인 이미지의 추정된 클래스 비율($\tau_e(t,k)$)을 얻습니다.
        * **네트워크 출력 클래스 비율 계산:** 분할 네트워크의 출력으로부터 대상 이미지의 클래스 비율($\hat{\tau}(t,k,\theta) = \frac{1}{|\Omega_t|}\sum_{i \in \Omega_t} p_k^t(i,\theta)$)을 계산합니다.
    * **최종 손실 함수:** 적응 단계의 전체 손실 함수는 엔트로피 손실과 추정된 클래스 비율 사전과 네트워크 출력 클래스 비율 간의 KL 발산 항의 합으로 구성됩니다:
        $$ \min_{\theta} \sum_t \sum_{i \in \Omega_t} \mathcal{L}_{ent}(p_t(i,\theta)) + \lambda KL(\tau_e(t,k), \hat{\tau}(t,k,\theta)) $$
        여기서 $\lambda$는 KL 발산 항의 가중치입니다. 이 손실 함수는 적응 단계에서 원본 이미지나 레이블을 사용하지 않습니다.

## 📊 Results

* **데이터셋:** 척추의 추간판(intervertebral discs, IVD) 퇴행을 연구하는 MICCAI 2018 IVDM3Seg Challenge 데이터셋(3D 다중 모달 MRI 스캔)을 사용했습니다.
* **평가 지표:** Dice Similarity Coefficient (DSC)와 Hausdorff Distance (HD)를 사용했습니다.
* **정량적 결과 (Wat → IP 및 IP → Wat 변환):**
  * **비적응(NoAdaptation):** 대상 도메인에서 DSC가 46.7% (IP) 및 63.7% (Wat)로 현저히 낮고 표준 편차가 높아, 도메인 전환 시 성능 저하가 큽니다.
  * **적대적 기법(Adversarial [17]):** DSC가 65.3% (IP) 및 77.3% (Wat)로 향상되었지만, 여전히 본 연구의 `AdaEnt`보다 낮거나 유사합니다.
  * **`AdaSource` [22]:** 원본 데이터에 접근하는 기존 클래스 비율 사전 기반 방법으로 DSC가 67.0% (IP) 및 78.3% (Wat)를 기록했습니다.
  * **`AdaEnt` (제안 방법):** DSC가 67.0% (IP) 및 77.8% (Wat)를 기록하여, 원본 데이터에 접근하지 않았음에도 불구하고 `AdaSource` 및 `Adversarial`과 대등하거나 더 나은 성능을 보였습니다.
  * `AdaEnt`와 `AdaSource`는 `Oracle` (최고 성능 82.3% IP, 89.0% Wat)의 성능에 매우 근접했습니다. HD 값도 유사한 경향을 보였습니다.
* **정성적 결과:**
  * `NoAdaptation` 모델은 대상 데이터에서 IVD 구조를 제대로 복구하지 못하고, 엔트로피 맵에서 높은 불확실성을 보입니다.
  * `AdaSource`와 `AdaEnt`는 지상 진실(ground truth)에 훨씬 가까운, 더 규칙적인 경계를 가진 분할 마스크를 생성합니다.
  * `AdaEnt`는 `AdaSource`와 `Oracle`보다 훨씬 낮은 예측 엔트로피를 보여, IVD 경계를 따라서만 높은 엔트로피 활성화가 나타나 높은 확신을 가지고 정확한 예측을 수행함을 입증했습니다.

## 🧠 Insights & Discussion

* **원본 데이터의 불필요성:** 본 연구의 결과는 도메인 적응 작업에서 원본 데이터에 반드시 접근할 필요가 없음을 강력히 시사합니다. 특히 도메인 이동(domain shift)이 너무 크지 않은 경우, 레이블 없는 대상 데이터와 도메인 불변 사전을 통해 효율적인 적응이 가능함을 보여줍니다.
* **엔트로피 최소화 및 사전의 효과:** 엔트로피 최소화와 클래스 비율 사전의 KL 발산 결합은 퇴행적 솔루션을 방지할 뿐만 아니라, 훈련 과정 초기에 유효성 DSC를 빠르게 높이는 등 학습 과정을 효과적으로 안내합니다. 이는 모델 예측의 확신도를 크게 향상시키고 더 정확한 분할 결과를 이끌어냅니다.
* **단일 네트워크의 장점:** 복잡한 적대적 훈련 방식과 달리 단일 네트워크만을 사용하는 본 프레임워크는 구현이 더 간단하고 효율적입니다.
* **한계 및 향후 연구:** 본 연구는 클래스 비율 사전이 모달리티 간에 크게 변하지 않는다는 가정을 따릅니다. 향후 연구에서는 시야(field of view) 변화와 같이 클래스 레이블 비율 사전이 달라지는 경우에 대한 해결책을 모색할 수 있습니다.

## 📌 TL;DR

원본 이미지를 사용할 수 없는 도메인 적응 시나리오를 위해, 대상 도메인의 레이블 없는 엔트로피 최소화를 클래스 비율 사전과 쿨백-라이블러 발산을 통해 유도하는 새로운 영상 분할 방법을 제안합니다. 이 "Source-Relaxed" 접근 방식은 원본 데이터에 접근하는 최신 기술들과 동등하거나 더 나은 성능을 달성하며, 의료 영상과 같이 원본 데이터 접근이 제한적인 환경에 특히 유용합니다.
