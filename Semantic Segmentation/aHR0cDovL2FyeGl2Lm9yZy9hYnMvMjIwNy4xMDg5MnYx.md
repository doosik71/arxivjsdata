# Bi-directional Contrastive Learning for Domain Adaptive Semantic Segmentation

Geon Lee, Chanho Eom, Wonkyung Lee, Hyekang Park, and Bumsub Ham

## 🧩 Problem to Solve

의미론적 분할(Semantic Segmentation)은 각 픽셀에 의미론적 레이블을 할당하는 작업으로, 고해상도 이미지의 픽셀 수준 레이블 주석은 매우 노동 집약적이고 시간이 많이 소요됩니다. 이를 해결하기 위해 GTA5, SYNTHIA와 같은 합성 데이터셋을 활용할 수 있지만, 합성 이미지와 실제 이미지 사이의 도메인 불일치(Domain Discrepancy)로 인해 모델 성능이 저하되는 문제가 발생합니다.

기존의 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) 방법들은 다음과 같은 한계를 가집니다:

- **적대적 학습(Adversarial Training) 기반 방법:** 전역적인 도메인 불일치를 줄이는 데 중점을 두어 픽셀 수준의 의미론을 유지하지 못하고, 종종 클래스에 구애받지 않는 정렬을 수행하여 소스 도메인의 특정 클래스(예: 자동차)가 타겟 도메인의 다른 클래스(예: 버스)와 정렬될 수 있습니다.
- **자기 학습(Self-training) 기반 방법:** 타겟 이미지에 대한 의사 레이블(Pseudo Label)을 생성하여 클래스 인식 정렬을 시도하지만, 다음과 같은 단점이 있습니다:
  - 의사 레이블이 매우 희소(sparse)합니다 (낮은 신뢰도 예측은 버려짐).
  - 의사 레이블 추정 및 업데이트가 계산적으로 비싸 자주 갱신되지 못하며, 이로 인해 모델이 잘못된 의사 레이블에 과적합되어 편향 및 분산이 커질 수 있습니다.

이 논문은 타겟 도메인의 실제 정답 레이블 없이 도메인 불변적이고 판별적인(discriminative) 특징을 학습하고, 기존 방법의 한계, 특히 희소하고 정적인(static) 의사 레이블 문제를 극복하는 것을 목표로 합니다.

## ✨ Key Contributions

- 비지도 도메인 적응 의미론적 분할(UDASS)을 위해 도메인 불변적이고 판별적인 특징 표현을 학습하는 새로운 **양방향 픽셀-프로토타입 대조 학습(Bi-directional Pixel-Prototype Contrastive Learning)** 프레임워크를 제안합니다.
- 정적인 의사 레이블의 한계를 극복하기 위해 픽셀-프로토타입 대응을 사용하는 **비매개변수적(nonparametric) 접근 방식의 동적 의사 레이블(Dynamic Pseudo Label) 생성** 기법을 제안합니다.
- 타겟 도메인과 소스 도메인 간의 픽셀-프로토타입 대응에 대한 **클래스별 도메인 편향(class-wise domain biases)을 보정하는 방법**을 제안합니다.
- GTA5→Cityscapes 및 SYNTHIA→Cityscapes를 포함한 표준 벤치마크에서 새로운 최첨단(State-of-the-Art) 성능을 달성하여 제안된 프레임워크의 효과를 입증합니다.

## 📎 Related Works

- **UDASS:** 기존 연구들은 이미지-레벨 또는 특징-레벨 정렬을 위해 적대적 학습을 사용했으나, 픽셀-레벨 의미론을 유지하지 못하는 한계가 있습니다. 자기 학습 기반 방법(CBST, CRST, FDA, TPLD, CorDA, ProDA)은 의사 레이블을 사용하지만, 의사 레이블의 희소성 및 고정성(staticness)으로 인한 과적합 문제를 겪습니다. PLCA는 픽셀 단위 정렬을 시도하지만, 문맥 정보가 부족하고 압축적인 표현을 얻지 못합니다.
- **프로토타입 학습(Prototypical learning):** 소수 학습(Few-shot Learning) 등 제한된 데이터 환경에서 유용한 개념으로, 각 객체 카테고리에 대한 프로토타입 표현을 추출합니다. 본 논문은 이를 UDASS에 적용하여 도메인 불변적이고 판별적인 특징을 학습합니다.
- **대조 학습(Contrastive learning):** 동일한 레이블을 가진 '긍정 쌍'은 가깝게, 다른 레이블을 가진 '부정 쌍'은 멀리 떨어뜨려 일반적인 특징 표현을 학습하는 자가 지도(self-supervised) 방식입니다. CANet이 UDA 분류에 적용했으나, 본 논문은 픽셀-프로토타입 대응을 통해 이를 의미론적 분할에 확장합니다.
- **비매개변수적 레이블 전이(Nonparametric label transfer):** 이미지 간의 시각적 유사성을 기반으로 레이블을 전이하는 방식으로, 기존에는 주로 추론 시 사용되었습니다. 본 논문에서는 이를 매개변수적 분할 모델을 훈련하는 데 활용하여 동적인 의사 레이블을 생성합니다.

## 🛠️ Methodology

본 논문은 픽셀-프로토타입 대응을 활용한 교차 도메인(cross-domain) 대조 학습 프레임워크를 제안합니다.

1. **전반적인 구조:**

   - 샴 네트워크(siamese network)를 사용하여 소스 및 타겟 이미지에서 특징 맵 $f_S, f_T$를 추출합니다.
   - 소스 도메인 프로토타입 $\rho_S(c)$는 소스 이미지의 정답 레이블 $y_S$를 사용하여 계산됩니다.
   - 타겟 도메인 프로토타입 $\rho_T(c)$는 타겟 이미지의 동적 의사 레이블 $y_T$를 사용하여 계산됩니다.
   - 이 프로토타입과 픽셀-레벨 특징 간의 대응을 통해 도메인 불변적이고 판별적인 표현을 학습합니다.

2. **양방향 픽셀-프로토타입 대조 학습:**

   - 동일한 클래스에 대한 픽셀-레벨 특징의 클래스 내(intra-class) 분산을 최소화하고, 다른 클래스에 대한 클래스 간(inter-class) 분산을 최대화합니다.
   - **전방 대조 손실(Forward Contrastive Loss, FCL):**
     - 타겟 이미지의 픽셀-레벨 특징 $f_T(p)$와 소스 도메인 프로토타입 $\rho_S(c)$ 간의 유사성을 최대화합니다.
     - $L_{FC} = - \sum_c \sum_p y_T(p,c) \log \left( \frac{\exp \left( s(f_T(p), \rho_S(c)) / \tau \right)}{\sum_{c'} \exp \left( s(f_T(p), \rho_S(c')) / \tau \right)} \right)$
     - 여기서 $s(\cdot,\cdot)$는 코사인 유사도, $\tau$는 온도(temperature) 매개변수입니다.
   - **후방 대조 손실(Backward Contrastive Loss, BCL):**
     - 소스 이미지의 픽셀-레벨 특징 $f_S(p)$와 타겟 도메인 프로토타입 $\rho_T(c)$ 간의 유사성을 최대화합니다.
     - $L_{BC} = - \sum_c \sum_p y_S(p,c) \log \left( \frac{\exp \left( s(f_S(p), \rho_T(c)) / \tau \right)}{\sum_{c'} \exp \left( s(f_S(p), \rho_T(c')) / \tau \right)} \right)$

3. **동적 의사 레이블 생성:**

   - 기존의 정적 의사 레이블의 단점(계산 비용, 희소성, 과적합)을 해결하기 위해 비매개변수적 레이블 전이 기법을 사용합니다.
   - **클래스별 보정(Class-wise Calibration):**
     - 지수 이동 평균(exponential moving average)을 사용하여 소스 $\mu_S(c)$와 타겟 $\mu_T(c)$ 도메인의 프로토타입을 점진적으로 업데이트합니다:
       $\mu_S(c) \leftarrow \lambda \mu_S(c) + (1-\lambda) \rho_S(c)$
       $\mu_T(c) \leftarrow \lambda \mu_T(c) + (1-\lambda) \rho_T(c)$
     - 클래스별 도메인 편향 $\xi(c) = \mu_T(c) - \mu_S(c)$를 추정합니다.
     - 보정된 소스 프로토타입 $\rho_{S \rightarrow T}(c) = \rho_S(c) + \xi(c)$를 얻습니다.
   - 보정된 프로토타입을 사용하여 타겟 이미지의 동적 의사 레이블 $y_D(p,c)$를 생성합니다. $s(f_T(p), \rho_{S \rightarrow T}(c))$가 특정 임계값 $T$보다 크고 $c$가 가장 유사한 클래스일 경우 1로 설정합니다.

4. **하이브리드 의사 레이블(Hybrid Pseudo Labels):**

   - 동적 의사 레이블($y_D$)과 기존 매개변수적 방법으로 얻은 정적 의사 레이블($y_F$)을 결합하여 $y_T$를 생성합니다.
   - $y_T(p,c) = y_D(p,c)$ (만약 $y_D(p,c)=1$)
   - $y_T(p,c) = y_F(p,c)$ (만약 동적 레이블이 없고 $y_F(p,c)=1$)
   - 그 외에는 0으로 설정합니다.

5. **학습 손실(Training Loss):**
   - 기존의 분할 및 엔트로피 손실 $L_{base}$에 양방향 대조 손실을 추가합니다:
     $L = L_{base} + \lambda_{FC} L_{FC} + \lambda_{BC} L_{BC}$
   - DeepLab-V2 (ResNet-101 백본), SGD 최적화, 폴리 학습률 스케줄링, 가중치 샘플링, 자가 증류(self-distillation)를 사용합니다.

## 📊 Results

- **정량적 결과:**
  - GTA5→Cityscapes 및 SYNTHIA→Cityscapes 벤치마크에서 기존 최신(SOTA) 방법들을 능가하며 새로운 SOTA를 달성했습니다.
  - GTA5→Cityscapes에서 mIoU 57.1% (Validation), 58.5% (Test)를 달성하여 ProDA (56.5%, 57.6%) 및 CorDA (56.6%, 57.5%) 대비 상당한 성능 향상(각각 0.6%, 1.6%)을 보였습니다.
  - SYNTHIA→Cityscapes에서도 mIoU 55.6% (16 클래스), 62.9% (13 클래스)를 달성하여 ProDA (55.1%, 61.3%) 대비 개선을 입증했습니다.
- **정성적 결과:**
  - 기준 모델(baseline) 대비 더 정확한 분할 결과를 제공합니다 (예: 버스, 도로, 라이더 클래스).
  - t-SNE 시각화 결과, 본 모델은 소스 및 타겟 도메인에서 동일 객체 카테고리에 대한 특징을 성공적으로 정렬하고, 다른 카테고리에 대해서는 분리하여 클래스 내 변동성을 최소화하고 클래스 간 변동성을 최대화함을 보여줍니다.
- **Ablation Study:**
  - FCL과 BCL은 모두 효과적이며, 이들을 함께 최적화하는 것이 UDASS에 가장 효과적임을 보여주었습니다.
  - 동적 의사 레이블이 정적 레이블만 사용하는 것보다 성능을 향상시키며, 클래스별 보정 기법을 적용했을 때 성능이 크게 향상됨을 확인했습니다 (예: GTA5→Cityscapes에서 55.3%에서 57.1%로).
- **의사 레이블 품질 비교:**
  - 보정된 동적 의사 레이블은 정적 의사 레이블보다 밀도가 높으면서도 레이블 정확도를 유지합니다 (동적: 밀도 34.3%, 정확도 98.6% vs. 정적: 밀도 20.1%, 정확도 98.5%).
  - 동적 및 정적 레이블을 결합한 하이브리드 의사 레이블은 가장 높은 밀도(42.3%)와 정확도(98.8%)를 제공합니다.
  - 클래스별 보정은 더 정확하고 밀도 높은 의사 레이블을 생성하는 데 기여합니다.
- **자원 사용:** 학습 시에는 기준 모델보다 더 많은 메모리와 시간이 소요되지만, 테스트 시에는 추가적인 자원 소모가 없습니다.

## 🧠 Insights & Discussion

- 이 논문의 핵심 통찰은 양방향 픽셀-프로토타입 대조 학습과 동적, 보정된 의사 레이블의 조합이 도메인 불일치 문제를 효과적으로 해결하고 도메인 불변적이면서 판별적인 특징을 학습한다는 점입니다.
- 도메인 간 클래스 내 변동성을 최소화하고 클래스 간 변동성을 최대화함으로써, 정확한 교차 도메인 분할에 필수적인 압축적이고 판별적인 특징 표현을 얻을 수 있습니다.
- 비매개변수적으로 동적으로 생성되는 의사 레이블은 기존 자기 학습 방법의 희소성, 정적성, 그리고 오류 누적 문제를 완화합니다. 특히, 제안된 보정 방법은 클래스별 도메인 편향을 고려하여 의사 레이블의 정확도를 더욱 높입니다.
- 하이브리드 레이블 접근 방식은 신뢰성 있는 정적 레이블과 밀도 높은 동적 레이블의 장점을 모두 활용합니다.
- 이 방법은 기존의 SOTA UDASS 방법들보다 상당한 성능 향상을 가져왔으며, 밀집 예측(dense prediction) 작업에서 비지도 도메인 적응의 강력한 접근 방식을 제시합니다.
- 제한점으로는 학습 시간과 메모리 사용량 증가가 있지만, 이는 추론(inference) 단계에는 영향을 미치지 않습니다.

## 📌 TL;DR

- **문제:** 의미론적 분할 모델은 합성 데이터셋으로 학습 시 실제 이미지에 대한 도메인 불일치 문제에 직면하며, 기존 비지도 도메인 적응 방법은 희소하고 정적인 의사 레이블 및 클래스 불특정 정렬 등의 한계를 가집니다.
- **해결책:** 본 논문은 양방향 픽셀-프로토타입 대조 학습 프레임워크를 제안합니다. 이 프레임워크는 소스-타겟 픽셀-프로토타입 대응(FCL, BCL)을 활용하여 도메인 불변적이고 판별적인 특징을 학습합니다. 또한, 클래스별 보정 기법이 적용된 비매개변수적, 동적 의사 레이블 생성 방법은 타겟 도메인에 대한 더 밀도 높고 정확한 레이블을 제공하며, 이를 정적 레이블과 결합하여 하이브리드 레이블을 형성하여 학습에 사용합니다.
- **결과:** GTA5→Cityscapes 및 SYNTHIA→Cityscapes 벤치마크에서 새로운 SOTA mIoU 성능을 달성했습니다. 제안된 방법은 더 정확하고 밀도 높은 의사 레이블을 생성하여 분할 성능을 향상시키고 도메인 간 특징 정렬을 개선합니다.
