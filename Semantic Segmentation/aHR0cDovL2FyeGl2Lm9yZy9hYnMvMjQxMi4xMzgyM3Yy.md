# Prompt Categories Cluster for Weakly Supervised Semantic Segmentation

Wangyu Wu, Xianglin Qiu, Siqi Song, Zhenhong Chen, Xiaowei Huang, Fei Ma, Jimin Xiao

## 🧩 Problem to Solve

약지도 의미론적 분할(WSSS)은 이미지 수준 레이블을 활용하여 픽셀 단위 분할을 수행하는 비용 효율적인 방법입니다. 기존 WSSS 방법들은 주로 클래스 간의 차이를 강조하여 의미론적 모호성으로 인한 잘못된 활성화를 방지하려 했습니다. 그러나 이들은 유사한 클래스들("고양이"와 "개"처럼 "동물"이라는 공통점) 간에 공유되는 정보의 긍정적인 역할을 간과했습니다.

특히, Vision Transformer (ViT) 기반 WSSS는 전역적 특징 상호작용을 잘 포착하지만, self-attention 메커니즘이 저주파 필터처럼 작동하여 패치 토큰의 과도한 스무딩을 유발합니다. 이는 미세 구조를 구별하는 데 중요한 고주파 세부 정보를 약화시키고, 결과적으로 이미지 내의 의미론적 경계를 흐리게 만들 수 있습니다. 본 논문은 이러한 과도한 스무딩으로 인한 의미론적 모호성을 완화하고, 유사 클래스 간의 잠재적 공유 정보를 효과적으로 식별하고 활용하는 방법을 제시합니다.

## ✨ Key Contributions

* **새로운 ViT 기반 프레임워크 도입**: 기존 범주 레이블과 함께 프롬프트 기반으로 생성된 범주 클러스터를 학습 가능한 토큰으로 통합하는 혁신적인 ViT 기반 프레임워크를 제안합니다. 이 설계는 특징 표현을 풍부하게 하고 WSSS의 전반적인 프로세스를 개선하는 추가적인 의미론적 단서를 제공합니다.
* **GPT 프롬프트 기반 자동 클러스터링 메서드 개발**: GPT 프롬프트를 통해 구동되는 자동 클러스터링 방법을 개발했습니다. 대규모 언어 모델(LLMs)에 내재된 광범위한 지식을 활용하여 범주들을 자동으로 클러스터링함으로써, 다른 클래스에 속하는 이미지들 간의 정보 교환을 개선합니다.
* **최첨단 성능 달성**: 제안된 프레임워크가 PASCAL VOC 2012 데이터셋의 의미론적 분할 작업에서 기존 SOTA 방법들 대비 우수한 성능을 입증하며, 효과성과 견고성을 확인합니다.

## 📎 Related Works

* **이미지 수준 레이블을 활용한 WSSS**: CAM (Class Activation Map) 기반의 의사 레이블 생성 방법이 주로 사용되었으며, CAM이 객체의 가장 판별적인 영역만 강조하는 한계를 극복하기 위해 erasing, 온라인 어텐션 누적, 교차 이미지 의미 마이닝 등의 기법이 제안되었습니다. 추가적인 살리언시 맵이나 픽셀-프로토타입 대비를 활용하는 연구들도 있습니다.
* **WSSS를 위한 Vision Transformer**: ViT의 self-attention 메커니즘을 활용하여 CAM을 생성하는 MCTformer, AFA와 같은 모델들이 등장했습니다. ViT-PCM은 CAM 독립적인 접근 방식으로 패치 임베딩과 max pooling을 사용합니다. 본 연구는 기존 ViT 기반 방법들의 과도한 스무딩 문제와 클래스 간 차이에만 집중하는 한계를 보완하기 위해 추가 클러스터 정보를 도입합니다.
* **프롬프트 기반 언어 모델**: 수동으로 설계되거나 자동으로 생성되는 프롬프트를 통해 사전 훈련된 언어 모델(PLM)의 성능을 향상시키는 방법들이 연구되었습니다. 일부 접근 방식은 컴퓨터 비전 작업에 PLM을 적용하여 few-shot 학습을 강화했습니다. 본 연구는 PLM을 사용하여 클러스터 정보를 생성하여 WSSS 작업을 개선한 최초의 시도입니다.

## 🛠️ Methodology

Prompt Categories Cluster (PCC) 프레임워크는 유사한 범주 간의 공유 정보를 활용하여 WSSS 성능을 향상시키는 것을 목표로 합니다. 전체적인 방법론은 다음과 같습니다.

1. **ViT 패치 토큰 추출**:
    * 입력 이미지 $X \in \mathbb{R}^{h \times w \times 3}$는 Vision Transformer (ViT) 인코더에 공급되어 패치 토큰 $F_v \in \mathbb{R}^{s \times e}$를 추출합니다. 여기서 $s$는 토큰의 개수, $e$는 각 토큰의 차원을 나타냅니다.

2. **GPT 기반 범주 클러스터링 (Self-Refine Prompt)**:
    * 데이터셋의 전체 범주 목록 $l$을 기반으로 GPT-4o (M)와 초기 클러스터링 프롬프트 $p_{gen}$를 사용하여 초기 범주 클러스터 $z_0$를 생성합니다.
    * 이후 개선 프롬프트 $p_{refine}$를 활용한 반복적인 최적화 과정을 통해 클러스터 구성을 정제합니다. 클러스터의 안정성이 3회 연속 유지될 때 (즉, $z_{t+1} = z_t = z_{t-1}$) 이 과정은 중지됩니다.
    * 이 클러스터링을 통해 입력 이미지가 속한 클러스터 범주를 식별하고, 이를 나타내는 클러스터 벡터 $u \in \mathbb{R}^L$를 생성합니다. $u_i \in \{0, 1\}$는 이미지의 $i$-번째 클러스터 소속 여부를 나타냅니다.

3. **클러스터 토큰 생성 및 통합**:
    * 클러스터 벡터 $u$는 학습 가능한 행렬 $G \in \mathbb{R}^{L \times H}$를 통해 클러스터 토큰 $F_c \in \mathbb{R}^H$로 매핑됩니다: $$F_c = u^T \cdot G$$
    * 생성된 클러스터 토큰 $F_c$는 각 ViT 패치 토큰 $F_v$와 결합되어 최종 입력 토큰 $F_{in} \in \mathbb{R}^{s \times (e+H)}$를 형성합니다.

4. **토큰 정제 및 패치 예측**:
    * 결합된 토큰 $F_{in}$는 HV-BiLSTM 모듈을 통해 정제되어 $F_{out} \in \mathbb{R}^{s \times (e+H)}$를 생성합니다.
    * 정제된 토큰 $F_{out}$는 1층 MLP 패치 분류기(가중치 $W \in \mathbb{R}^{(e+H) \times C}$)와 SoftMax 함수를 거쳐 패치 수준 예측 $Z \in \mathbb{R}^{s \times C}$를 생성합니다. $$Z = \text{softmax}(F_{out}W)$$

5. **이미지 수준 예측 및 손실 계산**:
    * 패치 예측 $Z$로부터 이미지 수준 클래스 예측 $p_c$를 얻기 위해 Top-K pooling 메커니즘을 사용합니다: $$p_c = \frac{1}{k} \sum_{i=1}^k \text{Top-k}(Z_{c,j}) \quad \text{and } j \in \{1, \dots, s\}$$ 여기서 $\text{Top-k}(\cdot)$는 클래스 $c$에 대해 가장 높은 예측값을 가진 상위 $k$개 패치를 선택하는 연산입니다.
    * 예측된 이미지 수준 레이블 $p_c$와 실제 이미지 레이블 $y_c$ 간의 다중 레이블 분류 예측 오류 (MCE)를 최소화하는 이진 교차 엔트로피 손실 $L_{MCE}$를 사용합니다: $$L_{MCE} = -\frac{1}{C} \sum_{c \in C} [y_c \log(p_c) + (1-y_c) \log(1-p_c)]$$

6. **추론 및 최종 분할**:
    * 훈련된 패치 분류기를 사용하여 패치 수준 SoftMax 클래스 예측 $Z$를 생성합니다.
    * $Z$에 보간 알고리즘을 적용하여 원본 이미지 해상도에 해당하는 픽셀 수준 SoftMax 예측으로 업샘플링합니다.
    * 최종적으로 $Z$에 argmax 연산을 수행하여 각 픽셀에 클래스 의사 레이블을 할당, 최종 의미론적 분할 출력을 얻습니다. 이 의사 레이블은 DeepLabv2 모델 훈련에 사용되며, Conditional Random Fields (CRF)를 통해 공간적 일관성과 의미 정확도를 더욱 향상시킵니다.

## 📊 Results

* **데이터셋 및 평가 지표**: PASCAL VOC 2012 데이터셋 (20개 객체 범주 + 배경 클래스)을 사용했으며, SBD 데이터셋으로 증강하여 총 10,582개 훈련 이미지와 1,449개 검증 이미지를 활용했습니다. 성능 평가는 mIoU (mean Intersection-Over-Union)를 주 지표로 사용했습니다.
* **의사 레이블 성능 비교**: PCC는 PASCAL VOC 2012 데이터셋에서 74.8%의 mIoU를 달성하여 기존 최첨단(SOTA) 방법들 (예: SFC 73.7%, ToCo 72.2%, ViT-PCM 71.4%)을 능가하는 뛰어난 의사 레이블 품질을 보여주었습니다. 이는 유사 범주 간의 공유 정보를 효과적으로 활용하여 의미론적 모호성을 완화하고 더 신뢰할 수 있는 의사 레이블을 생성하는 PCC의 능력을 입증합니다.
* **의미론적 분할 결과 개선**: 생성된 의사 레이블을 사용하여 DeepLab V2 모델을 훈련한 결과, PCC는 PASCAL VOC 검증 세트에서 72.2%의 mIoU를 기록하며 기존 SOTA 방법들 (예: SFC 71.2%, IACD 71.4%, USAGE 71.9%)을 능가했습니다. 시각화 결과 또한 PCC가 더 정확한 분할 결과와 객체 경계의 오류 감소를 보여주어, 의사 레이블 품질 개선이 최종 분할 성능으로 성공적으로 이어진다는 것을 확인했습니다.
* **히트맵 시각화**: 객체의 핵심 영역에서 높은 예측 확률을, 경계에서는 점진적으로 감소하는 확률을 보여주는 히트맵을 통해, 모델이 객체의 핵심 특징을 효과적으로 포착하고 경계에서 확률 전환을 부드럽게 처리함을 확인했습니다. PCC는 기존 접근 방식보다 더 선명하고 집중된 활성화 히트맵을 생성하여 객체 위치 파악 및 분할 정확도를 향상시킵니다.
* **Ablation Study**:
  * 클래스 토큰을 패치 토큰에 연결하는 것만으로 기본 ViT 프레임워크 대비 mIoU가 1.2% ($68.6\% \to 69.8\%$) 향상되어 클래스 관련 정보의 중요성을 입증했습니다.
  * 여기에 GPT 프롬프트로 생성된 클러스터 정보를 추가 토큰으로 통합했을 때 mIoU가 3.6% ($69.8\% \to 72.2\%$) 추가적으로 크게 향상되었습니다. 이는 유사 클래스 내의 공유 특징을 학습하는 것이 WSSS 성능 개선에 매우 중요함을 강력하게 뒷받침합니다.

## 🧠 Insights & Discussion

본 연구는 기존 WSSS 방법들이 간과했던 유사 클래스 간의 공유 정보 활용에 대한 중요성을 부각했습니다. 특히, "고양이"와 "개" 같은 범주가 "동물"이라는 공통점을 가짐에도 불구하고, 대부분의 모델이 클래스 간 차이에만 집중하여 이러한 내재적 유사성을 놓쳤다는 점을 지적합니다. PCC는 이러한 공유 정보를 학습 가능한 토큰으로 ViT에 통합함으로써 의미론적 모호성을 효과적으로 완화하고, ViT 패치 특징의 과도한 스무딩 문제를 해소할 수 있음을 보여주었습니다.

대규모 언어 모델(LLMs)을 사용하여 범주 간의 미묘한 의미론적 관계를 파악하고 클러스터링하는 혁신적인 접근 방식은 LLM이 시각적 인식 작업에 기여할 수 있는 새로운 가능성을 제시합니다. 이는 언어 모델의 광범위한 지식이 시각 데이터의 맥락적 이해를 풍부하게 하는 데 활용될 수 있음을 시사합니다.

제안된 프레임워크는 학습 가능한 클러스터 토큰을 기존 ViT 아키텍처에 유연하게 통합할 수 있어 확장성이 높습니다. 이는 다양한 WSSS 프레임워크에 쉽게 적용될 수 있는 범용적인 솔루션을 제공합니다. LLM의 불안정성 문제를 자기 정제 프롬프트 전략으로 완화하는 창의적인 방법도 돋보입니다. 본 연구는 언어 기반 클러스터링과 시각적 의미론적 분할의 교차점에서 미래 연구를 위한 견고한 기반을 마련했습니다.

## 📌 TL;DR

WSSS에서 ViT의 과도한 스무딩 문제와 유사 클래스 간 공유 정보 활용 미흡 문제를 해결하기 위해, 본 논문은 **Prompt Categories Clustering (PCC)** 프레임워크를 제안합니다. PCC는 **GPT 프롬프트를 활용하여 유사 범주를 자동으로 클러스터링**하고, 이 **클러스터 정보를 학습 가능한 토큰으로 ViT에 통합**하여 패치 토큰을 강화합니다. 이를 통해 모델은 클래스 간의 의미론적 모호성을 더 잘 구분하고 공유 특징을 학습합니다. PASCAL VOC 2012 데이터셋에서 SOTA 의사 레이블 (74.8% mIoU) 및 최종 의미론적 분할 성능 (72.2% mIoU)을 달성하여, 유사 범주 정보 활용의 중요성과 LLM 기반 클러스터링의 효과를 입증했습니다.
