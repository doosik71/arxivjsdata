# Semantic Image Segmentation via Deep Parsing Network

Ziwei Liu, Xiaoxiao Li, Ping Luo, Chen Change Loy, Xiaoou Tang

## 🧩 Problem to Solve

본 논문은 의미론적 이미지 분할(semantic image segmentation) 문제를 다룹니다. 기존 마르코프 랜덤 필드(MRF) 기반 방법론은 고차 관계(high-order relations)나 레이블 컨텍스트 혼합(mixture of label contexts)과 같은 풍부한 정보를 통합하는 데 어려움이 있었고, 특히 평균장(Mean Field, MF) 알고리즘과 같은 반복적인 추론(iterative inference) 방식을 사용하기 때문에 계산 비용이 높았습니다. 최근 심층 합성곱 신경망(CNN)과 MRF를 결합한 연구들도 백프로파게이션(BP) 시 학습 이미지마다 MF의 여러 반복을 요구하여 비효율적이었고, 복잡한 쌍별 항(pairwise terms)을 통합하기 어렵다는 한계가 있었습니다. 본 연구는 이러한 비효율성과 복잡한 항의 통합 문제를 해결하며, MRF 추론을 단일 순방향 패스로 수행하는 결정론적 종단간(end-to-end) CNN을 제안합니다.

## ✨ Key Contributions

- **Deep Parsing Network (DPN) 제안:** VGG-16 기반의 강력한 유니터리 항(unary terms)과 풍부한 쌍별 정보(고차 관계 및 레이블 컨텍스트 혼합)를 통합하여 공동으로 학습하는 새로운 신경망 DPN을 제안합니다. DPN은 MF 추론을 단 한 번의 반복으로 근사하여 계산 비용을 줄이면서도 높은 성능을 유지합니다.
- **다양한 MRF 유형 표현 능력:** DPN이 여러 유형의 MRF를 표현할 수 있음을 입증하여, 기존 RNN [39] 및 DeepLab [3]과 같은 여러 이전 연구들이 DPN의 특수한 경우임을 보여줍니다.
- **상태 최신(State-of-the-Art) 성능 달성:** PASCAL VOC 2012 데이터셋에서 단일 DPN 모델로 77.5%의 새로운 최신 분할 정확도를 달성했습니다.
- **철저한 구성 요소 분석:** DPN의 각 구성 요소가 고성능 달성에 얼마나 중요한지 광범위한 실험을 통해 분석하고, GPU에서의 시간 복잡도를 분석합니다.

## 📎 Related Works

- **MRF/CRF 기반 분할:** [31, 29, 9, 34, 11, 2, 8, 25, 22] 등은 유니터리 항과 쌍별 항 정의를 기반으로 두 그룹으로 분류됩니다.
  - **쌍별 함수 개선:** [16, 17]의 장거리 의존성, [37, 36]의 고차 포텐셜, [21, 26, 38]의 의미론적 레이블 컨텍스트 등을 탐구했습니다. 특히 Krähenbühl et al. [16]은 완전 연결 그래프를 통해 정확한 경계를 달성했으며, Vineet et al. [37]은 고차 및 장거리 항을 정의했습니다. 하지만 유니터리 항의 학습 능력이 병목이며 복잡한 쌍별 항의 학습 및 추론은 비용이 많이 듭니다.
  - **CNN 기반 유니터리 분류기 학습:** [23, 24, 25, 22, 3, 28, 39, 30, 19] 등은 CNN의 발전을 활용하여 강력한 유니터리 분류기를 학습했습니다. Long et al. [22]은 CNN의 완전 연결 계층을 합성곱 계층으로 변환하여 픽셀별 분류를 가능하게 했고, Chen et al. [3]은 CNN 출력을 단순한 쌍별 포텐셜을 가진 MRF에 입력했으나 CNN과 MRF를 분리된 구성 요소로 다루었습니다. Schwing & Urtasun [30]은 CNN과 MRF를 공동으로 학습했지만, 백프로파게이션 동안 MF의 반복적 추론이 필요했고, Zheng et al. [39]은 MF 추론 과정을 순환 신경망(RNN)으로 표현했지만 계산 비용은 유사했습니다.

## 🛠️ Methodology

DPN은 VGG-16을 확장하여 유니터리 항을 모델링하고, 추가 계층을 설계하여 쌍별 항에 대한 MF 추론의 한 번의 반복을 근사합니다.

1. **MRF 개요:**
   - **에너지 함수:** $E(y) = \sum_{\forall i \in V} \Phi(y_{i}^{u}) + \sum_{\forall i,j \in E} \Psi(y_{i}^{u}, y_{j}^{v})$
     - 유니터리 항 $\Phi(y_{i}^{u}) = -\ln p(y_{i}^{u}=1|I)$ (VGG-16으로 모델링).
     - 기존 쌍별 항 $\Psi(y_{i}^{u}, y_{j}^{v}) = \mu(u,v)d(i,j)$는 공간적 컨텍스트 부족 및 고차 상호작용 누락의 단점이 있습니다.
   - **DPN의 쌍별 항:** DPN은 풍부한 정보를 활용하여 쌍별 항을 정의합니다.
     $$\Psi(y_{i}^{u},y_{j}^{v}) = \sum_{k=1}^{K} \lambda_{k} \mu_{k}(i,u,j,v) \sum_{\forall z \in N_{j}} d(j,z)p_{z}^{v}$$
     - 첫 번째 항은 "지역 레이블 컨텍스트 혼합(mixture of local label contexts)"을 학습합니다.
     - 두 번째 항은 "트리플 페널티(triple penalty)"를 모델링합니다. ($i, j$ 및 $j$의 이웃 $z$ 간의 관계)
2. **추론 개요 (평균장 알고리즘 근사):**
   - DPN은 MF의 한 번의 반복을 두 단계로 근사합니다.
   - **단계 1 (트리플 페널티 계산):** 예측된 레이블 맵 $Q^{v}$에 $m \times m$ 필터를 적용하여 $Q^{v'}$를 계산합니다. 이 필터의 각 요소는 $d(j,z)q_{j}^{v}$와 같아 픽셀 $j$와 그 이웃 간의 거리를 기준으로 예측을 평활화합니다. (Fig. 1c)
   - **단계 2 (레이블 컨텍스트 계산):** $Q^{v'}$에 $n \times n$ 필터($\mu_{k}(i,u,j,v)$)를 합성곱하여 레이블 컨텍스트를 얻습니다. (Fig. 1d)
3. **DPN 아키텍처:**
   - **유니터리 항 모델링 (b1-b11):**
     - VGG-16의 해상도를 높이기 위해 최대 풀링 계층(a8, a10)을 제거하여 최소 피처 맵 크기를 64x64로 유지합니다.
     - VGG-16의 완전 연결 계층(a11, a12)을 합성곱 계층(b9, b10)으로 변환합니다. b11은 최종 512x512x21의 유니터리 레이블 확률 맵을 생성합니다.
   - **평활화 항 모델링 (b12-b15):**
     - **b12 (지역 합성곱 계층):** Eqn. (7)의 트리플 페널티를 구현합니다. 각 위치에서 다른 필터를 가지며, 필터는 $d(j,z)p_{j}^{v}$로 초기화됩니다.
     - **b13 (합성곱 계층):** Eqn. (7)의 지역 레이블 컨텍스트를 학습합니다. 9x9x21 필터를 사용하여 105개의 피처 맵을 생성합니다.
     - **b14 (블록 최소 풀링 계층):** 5개의 입력 채널마다 최소값을 풀링하여 21개의 출력 채널로 줄이고, 가장 작은 페널티를 가진 컨텍스트 패턴을 활성화합니다.
     - **b15 (합산 및 Softmax 계층):** 유니터리(b11)와 평활화(b14) 항을 결합하여, 각 픽셀에 레이블 $u$를 할당할 확률을 정규화합니다. 이는 MF 업데이트 식과 동일합니다.
       $$o_{15}(i,u) = \frac{\exp\{ \ln(o_{11}(i,u)) - o_{14}(i,u) \}}{\sum_{v=1}^{21} \exp\{ \ln(o_{11}(i,v)) - o_{14}(i,v) \}}$$
4. **학습 알고리즘:**
   - VGG-16으로 초기화하고, 마지막 4개 그룹은 무작위 초기화 후 점진적으로 미세 조정합니다.
   - **4단계 미세 조정:**
     1. b1-b11 미세 조정 (유니터리 항 학습).
     2. b12를 추가하고 파라미터 업데이트 (트리플 관계 학습).
     3. b13, b14를 추가하고 파라미터 업데이트 (지역 레이블 컨텍스트 학습).
     4. 모든 파라미터를 공동으로 미세 조정.
   - Eqn. (7)을 합성곱 및 풀링으로 변환하여 GPU에서 병렬화 및 가속화합니다.

## 📊 Results

- **데이터셋:** PASCAL VOC 2012 (20개 객체 + 배경) 검증 및 테스트 세트.
- **평가 지표:** mIoU (평균 픽셀별 IoU), TA (태깅 정확도), LA (지역화 정확도), BA (경계 정확도).
- **DPN 구성 요소 효과:**
  - **트리플 페널티:** b12의 수용 필드 50x50이 가장 좋은 mIoU(64.7%)를 달성했으며, 베이스라인(VGG-16 + denseCRF [16])을 능가합니다.
  - **레이블 컨텍스트:** b13의 '9x9 mixture' 설정이 mIoU를 66.5%로 향상시키며, 공간적 컨텍스트 학습의 중요성을 보여줍니다. DPN의 쌍별 항은 DSN 및 DeepLab보다 효과적입니다.
  - **점진적 학습:** 점진적 학습이 동시 학습보다 더 높고 안정적인 정확도(최종 mIoU 67.8%)를 보였습니다.
  - **단일 반복 MF:** DPN은 MF를 단 한 번의 반복으로 수렴하며 좋은 정확도를 달성했습니다. 이는 기존 denseCRF [16]나 다른 딥 모델(5-10회 반복 필요)에 비해 훨씬 효율적입니다.
  - **구성 요소별 효과:**
    - TA는 레이블 컨텍스트에서 향상되나, 전체 공동 튜닝 시 작은 객체들의 성능 저하가 관찰되었습니다.
    - LA는 트리플 페널티와 공동 튜닝을 통해 크게 향상됩니다.
    - BA는 트리플 페널티 단계에서 객체 경계 캡처에 도움을 받습니다.
- **전반적 성능 (PASCAL VOC 2012 테스트 세트):**
  - VOC12 데이터로만 훈련된 DPN (여러 스케일 평균)은 74.1% mIoU를 달성하여 기존 방법들을 능가합니다.
  - MS-COCO 데이터로 사전 훈련된 DPN$^{\dagger}$은 단일 모델로 77.5% mIoU를 달성하여 최신 기술(state-of-the-art) 성능을 기록했습니다.

## 🧠 Insights & Discussion

- DPN은 유니터리 항과 쌍별 항의 추론 및 학습을 단일 합성곱 신경망으로 통합하는 데 성공했으며, 백프로파게이션 시 반복적인 추론이 필요 없습니다.
- 고차 관계 및 레이블 컨텍스트 혼합을 쌍별 항 모델링에 통합함으로써 기존 연구들을 특수한 경우로 포함하는 더욱 일반적인 프레임워크를 제공합니다.
- DPN은 기존 CNN 연산을 기반으로 구축되어 병렬화 및 가속화가 용이하며, 이는 계산 효율성 측면에서 큰 이점입니다.
- 광범위한 실험을 통해 의미론적 이미지 분할에 대한 여러 중요한 통찰을 얻었습니다. 예를 들어, 점진적 학습 전략의 이점, 단일 MF 반복만으로 충분한 성능 달성, 트리플 페널티와 레이블 컨텍스트가 각각 경계와 공간적 관계를 포착하는 데 기여하는 방식 등이 밝혀졌습니다.
- **제한 사항 및 향후 연구:** DPN의 일반화 가능성을 더 많은 객체 클래스, 다양한 외관/스케일 변화 등 더욱 도전적인 시나리오에서 탐색하는 것이 향후 과제입니다. 특히 작은 객체에 대한 성능 향상이 필요합니다.

## 📌 TL;DR

Deep Parsing Network (DPN)는 의미론적 이미지 분할을 위해 CNN 내에 강력한 유니터리 항과 고차 관계 및 레이블 컨텍스트 혼합을 포함하는 복잡한 쌍별 항을 통합합니다. 이 모델은 비용이 많이 드는 평균장(MF) 반복 추론 대신 단 한 번의 순방향 패스로 MF를 근사하여 효율성을 극대화합니다. DPN은 PASCAL VOC 2012에서 77.5%의 최신 mIoU를 달성하며, 기존 CNN-MRF 결합 모델보다 효율적이고 효과적인 접근 방식을 제공합니다.
