# Adaptive Contrastive Learning with Dynamic Correlation for Multi-Phase Organ Segmentation

Ho Hin Lee, Yucheng Tang, Han Liu, Yubo Fan, Leon Y. Cai, Qi Yang, Xin Yu, Shunxing Bao, Yuankai Huo, Bennett A. Landman

## 🧩 Problem to Solve

최근 연구들은 다중 위상 컴퓨터 단층촬영(CT)의 다중 장기 분할을 위해 "스캔 단위(scan-wise)" 대비 라벨을 대조 학습에 도입하여 우수한 성능을 보여주었습니다. 그러나 이러한 스캔 단위 라벨은 다음과 같은 한계가 있습니다:

* **거친 분류**: 모든 장기에 걸쳐 미세한 "장기 단위(organ-wise)" 대비 변화를 포착하지 못합니다. 예를 들어, 신장과 담낭은 대비 강화에 대해 매우 다른 반응을 보입니다.
* **수동 라벨링**: 대비 위상 라벨은 일반적으로 수동으로 제공되어 오류가 발생하기 쉽고, 위상 정의에 대한 수동 편향을 초래할 수 있습니다.
따라서 본 논문은 이러한 "장기 단위" 대비 변화를 활용하여 대조 학습을 통해 장기별 표현을 정의하고 제어하는 방법을 모색합니다.

## ✨ Key Contributions

* 다중 위상 대비 CT로부터 다중 장기 분할 성능을 개선하고 일반화하기 위한 **적응형 대조 학습 프레임워크**를 제안합니다.
* 장기별 대비 상관관계를 적응형 가중치 제약으로 활용하여 다중 위상 표현 간의 거리를 장기 수준에서 조절하는 **데이터 기반 대조 손실 함수**를 제안합니다.
* 제안된 대조 손실이 위상 중 하나의 성능 저하 없이 광범위한 다중 위상 대비 차이를 포착하며, 다운스트림 분할 작업에서 **상당한 성능 향상**을 달성함을 입증합니다.

## 📎 Related Works

* **의료 영상 분할**: 딥러닝 모델을 사용하여 의료 영상을 분할하는 기존 방식은 주로 지도 학습에 의존하며, 데이터 품질 및 해상도에 민감합니다. 패치 기반, 계층적 접근 방식, 그리고 무라벨 데이터를 활용하는 준지도/자기지도 학습 연구들이 진행되었습니다.
* **이미지 단위 대조 학습**: 무라벨 데이터로부터 의미 있는 표현을 학습하는 자기 지도 학습의 한 형태로, 증강된 이미지 쌍을 "긍정 쌍"으로 묶고 다른 샘플들을 "부정 쌍"으로 밀어내는 방식으로 잠재 공간에서 유사성을 평가합니다. 지도 대조 학습은 이미지 수준 라벨을 활용하여 클래스 인지 임베딩을 강화합니다. 그러나 기존 이미지 단위 접근 방식은 "스캔 단위" 라벨의 한계로 인해 장기별 동적 대비 변화를 유연하게 반영하지 못합니다.
* **픽셀 단위 대조 학습**: 대조 학습을 픽셀 수준으로 확장하여 조밀한 매핑 및 유사성을 평가합니다. 분할 작업과 공동 훈련하여 동일한 의미 클래스 내 표현을 더 유사하게 만듭니다. 그러나 여전히 픽셀 단위 라벨 가이드가 필요합니다.

## 🛠️ Methodology

제안하는 방법은 장기 자체에서 대비 관련 지식을 동적으로 추출하여 장기 분할 작업을 위한 견고한 다중 위상 잠재 공간을 정의하는 것을 목표로 합니다. 전체 계층적 파이프라인은 세 단계로 구성됩니다:

1. **거친 분할로부터 장기별 주의(Attention) 추출**:
    * 저해상도 (전체 볼륨) 분할 네트워크 `Coarse(·)`를 사용하여 여러 장기에 대한 거친 분할 마스크 $A_i$를 생성합니다.
    * 각 장기 클래스 $C$의 복셀 인덱스를 중심점으로 무작위 샘플링하여 관심 영역(ROI)인 장기별 패치 $p_i = \{x_{C,i}, y_{C,i}, s_{C,i}\}$를 추출합니다. 여기서 $s_{C,i} \in A_i$는 거친 분할 마스크입니다.
    * 데이터 증강 모듈 `Aug(·)`를 사용하여 $2n$개의 쌍 형태의 복사본 $\tilde{x}_{C,i}, \tilde{s}_{C,i}$를 생성합니다.
    * $\tilde{s}_{C,i}$를 $\tilde{x}_{C,i}$와 다중 채널 입력 $m_i$로 연결하여 인코더 네트워크 $E(·)$를 훈련합니다.

2. **대비 상관관계 기반 대조 학습 (DCC-CL)**:
    * **위상 기반 대비 상관관계**:
        * 해당하는 $\tilde{s}_{C,i}$ 내에서 평균 강도 값 $d_i$를 추출합니다.
        * 각 미니 배치 내의 모든 이미지 패치에 걸쳐 쌍별 평균 강도 절대 차이 $v_{i,j} = |d_i - d_j|$를 계산하여 대비 상관관계 컨텍스트로 사용합니다. $v_{i,j}$ 값이 작을수록 장기별 평균 강도가 유사함을 의미합니다.
    * **동적 대비 상관관계 대조 손실 ($L_{dcc}$)**:
        * $v_{i,j}$를 특징 수준에서 계산된 코사인 유사도에 곱하는 **적응형 가중치**로 활용하여 대조 손실을 제어합니다.
        * 손실 함수는 다음과 같이 정의됩니다:
            $$L_{dcc} = -\sum_{k=1}^{2n} \log \frac{\exp(\tilde{z}_k \cdot \tilde{z}_{p(k)} \cdot (1-v_{k,p(k)})/T)}{\sum_{j \in J(k)} \exp(\tilde{z}_k \cdot \tilde{z}_j \cdot (1-v_{k,j})/T)}$$
            여기서 $\tilde{z}_k$와 $\tilde{z}_{p(k)}$는 쌍별 특징 표현 벡터, $T$는 온도 하이퍼파라미터, $P(·)$는 선형 투영 네트워크(MLP)입니다.
        * 이 손실 함수는 이미지 수준의 가변성을 소프트 감독으로 설명하여 표준 대조 손실의 유연성을 향상시키고, 각 미니 배치에서 쌍별 표현 간의 코사인 거리를 제어합니다.

3. **장기 분할 정제 미세 조정**:
    * 대조 학습으로 사전 훈련된 인코더 네트워크(ResNet-50)를 사용하고, 투영 네트워크는 제거합니다.
    * DeepLabV3+ 네트워크를 모델 백본으로 사용하여 디코더에 ASPP(Atrous Spatial Pyramid Pooling) 모듈을 적용하여 다중 스케일 정제를 수행합니다.
    * Dice 손실을 사용하여 예측된 분할과 실제 라벨 간의 지역적 유사성을 이진 설정에서 평가합니다.
    * 마지막으로 다수결 투표(majority voting)를 사용하여 동일한 슬라이스 내의 모든 이진 출력을 융합하고, 모든 융합된 슬라이스를 연결하여 볼륨 기반 다중 장기 마스크를 생성합니다.

## 📊 Results

* **MICCAI 2015 BTCV Challenge (CECT)**: 제안된 DCC-CL은 평균 Dice 점수 0.936을 달성하여, 기존 최첨단 방법(Hin Lee et al. (2021), 0.923) 대비 1.41%p의 상당하고 유의미한 개선(p-value < 0.01)을 보였습니다.
* **Research Non-Contrast CT (NCCT)**: 제안된 DCC-CL은 평균 Dice 점수 0.910을 달성하여, 기존 최첨단 방법(Hin Lee et al. (2021), 0.891) 대비 2.02%p의 상당하고 유의미한 개선(p-value < 0.01)을 보였습니다.
* **MICCAI 2021 FLARE Challenge (CECT, 외부 검증)**: 평균 Dice 점수가 0.927에서 0.934로 상당한 개선(p-value < 0.01)을 이루었습니다.
* **어블레이션 연구**: 다양한 사전 훈련 시나리오(스크래치, SSCL, CE, AGCL)와 비교하여 DCC-CL이 일관되게 가장 우수한 성능을 보였습니다. 특히, 다중 레이블 대조 손실(AGCL)보다 1.41%p 향상되었습니다.
* **온도(Temperature) 변동성**: 최적의 온도 $T$ 값은 약 0.07이었습니다.
* **단일/다중 위상 대조 학습**: 다중 위상 훈련이 NCCT 데이터셋의 분할 성능을 크게 향상시키면서 CECT 성능 저하 없이 양쪽 모두의 성능을 잘 유지했습니다.

## 🧠 Insights & Discussion

* **의미**: 장기별 대비 특성을 활용하여 적응적으로 정의된 잠재 공간은 경성 라벨(hard label)로 정의된 잠재 공간보다 다운스트림 분할 작업에 더 유리합니다. 이는 데이터 자체에서 유의미한 가변성을 포착하기 때문입니다.
* **장점**: 제안된 방법은 스캔 단위 대비 수준을 정의하기 위해 원-핫(one-hot) 경성 라벨을 사용하는 대신, 평균 강도 간의 유사성을 동적 소프트 제약으로 활용하여 표현을 적응적으로 정의합니다. 이를 통해 대비 특성이 다른 위상에 속하더라도 유사한 장기별 표현을 가능하게 합니다. 이는 모델이 특정 대비 모달리티에 편향되지 않고, 광범위한 대비 변화에 대해 일관된 성능을 유지할 수 있도록 합니다.
* **시각화 (그림 3 PCA)**: PCA 플롯은 서로 다른 대비 위상에서 샘플링되었음에도 불구하고, 유사한 대비를 가진 장기 표현이 잘 분리되어 있음을 보여주며, 이는 사전 훈련에 대비 정보를 활용하는 것의 효과를 입증합니다.
* **한계**:
  * **거친 의사 라벨(pseudo label)에 대한 의존성**: 2D 패치가 의사 라벨 지침에 따라 추출되기 때문에, 부정확한 장기 패치가 추출되어 정확한 장기 단위 강도 정보를 제공하지 못할 수 있습니다.
  * **장기 중심 학습**: 인접 장기 간의 대비 상관관계를 적응시키지 않습니다. 향후 연구에서는 이를 엔드-투-엔드 프레임워크로 확장하는 것을 목표로 합니다.

## 📌 TL;DR

* **문제**: 다중 위상 CT의 장기 분할은 다양한 대비 변화로 인해 어려움이 있으며, 기존 스캔 단위 대조 학습은 장기 단위의 미세한 대비 차이를 간과하고 수동 라벨링의 한계를 가집니다.
* **방법**: 동적 대비 상관관계 대조 학습(DCC-CL)을 제안합니다. 이 방법은 장기별 평균 강도 차이를 계산하여 동적 상관관계 행렬을 생성하고, 이를 대조 손실의 소프트 가중치로 활용하여 잠재 공간의 표현 유사도를 장기별 실제 대비 변화에 따라 적응적으로 조절합니다.
* **결과**: DCC-CL은 대비 강화 및 비대비 CT 데이터셋(BTCV, NCCT, FLARE) 모두에서 다중 장기 분할 성능을 기존 최첨단 방법 대비 크게 향상시키며, 다양한 대비 수준에 대한 우수한 일반화 및 적응성을 입증했습니다.
