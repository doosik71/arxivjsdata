# Federated Client-tailored Adapter for Medical Image Segmentation

Guyue Hu, Siyuan Song, Yukun Kang, Zhu Yin, Gangming Zhao, Chenglong Li, and Jin Tang

## 🧩 Problem to Solve

의료 영상 분할은 컴퓨터 보조 진단 및 병변 위치 파악에 필수적이지만, 기존 중앙 집중식 학습 패러다임은 데이터 프라이버시 규정 및 네트워크 대역폭 제한으로 인해 분산된 "데이터 섬(data islands)"만 접근 가능한 실제 의료 시나리오에는 적용하기 어렵습니다. 연합 학습(Federated Learning, FL)은 분산 솔루션을 제공하지만, 클라이언트별 도메인 이질성(분포 다양성 및 클래스 불균형 포함)으로 인해 심각한 학습 불안정성을 겪습니다. 또한, 기존 FL은 모든 클라이언트에 대한 타협된 전역 모델(global-compromised model)을 생성하여 각 클라이언트의 개별 최적성을 달성하지 못하며, 기존 개인화된 FL 방법들은 너무 거친 수준에서 디커플링되거나 정적으로 파라미터를 할당하여 적응성이 부족합니다.

## ✨ Key Contributions

* 의료 영상 분할에서 클라이언트별 이질성(클래스 불균형 및 분포 다양성)으로 인한 기존 연합 학습의 학습 불안정성 문제를 식별하고, 차선적인 전역 타협 모델 대신 최적의 클라이언트 맞춤형 모델을 추구하여 이를 완화합니다.
* 민감한 로컬 데이터를 공유하지 않고도 안정적이고 맞춤형 연합 분할을 달성하는 새로운 연합 클라이언트 맞춤형 어댑터(Federated Client-tailored Adapter, FCA) 프레임워크를 제안합니다. 이는 파라미터 효율적인 어댑터를 FL에 긴밀하게 결합하여 기성 의료 파운데이션 모델(Medical Foundation Models, MFMs)의 보편적 지식을 효과적으로 증류하여 이질적인 연합 학습을 안정화합니다.
* 어댑터 유닛을 공통 및 개별 구성 요소로 적응적으로 분해하는 혁신적인 클라이언트 맞춤형 연합 업데이트 전략(이진 및 스무스 업데이트)을 개발하여, 새로운 클라이언트 맞춤형 파라미터 효율적 업데이트를 가능하게 하고 이질적인 연합 학습 과정을 더욱 안정화합니다.
* 세 가지 대규모 데이터셋에 대한 광범위한 실험을 통해 이질적인 분산 의료 영상 분할 문제를 해결하는 제안된 FCA 프레임워크의 효과성과 우수성을 입증합니다.

## 📎 Related Works

* **의료 영상 분할**: U-Net 및 변형(U-Net++, nnUNet)과 같은 CNN 기반 방법, TransUnet, VM-UNet과 같은 트랜스포머 기반 방법 등이 있습니다.
* **파운데이션 모델 및 PEFT**: SAM(Segment Anything Model), MedSAM, nnSAM과 같은 모델이 이미지 분할 분야에서 큰 발전을 이루었지만, 주로 중앙 집중식 학습 패러다임에 속합니다.
* **연합 학습**: FedAvg는 기본적인 FL 프레임워크를 제공합니다. FedProx, FedDC, FedSM, FedSeg 등은 클라이언트 드리프트 및 비독립동일분포(non-IID) 데이터 문제를 완화하기 위해 집계 전략이나 손실 함수를 개선했습니다. FedNH, Fed-CBS는 클래스 불균형을, Scaffold, FedNP는 분포 다양성을 다룹니다. FedST, FedA3I는 고품질 로컬 모델의 기여를 강화하며, FSAR는 적응형 토폴로지 연결을 구현합니다. 본 논문은 이러한 기존 연구들과 달리 세분화되고 적응적인 파라미터 분해를 통해 클라이언트 맞춤형 모델을 구현합니다.

## 🛠️ Methodology

FCA 프레임워크는 기성 MFMs(예: SAM-Med2D)를 기본 분할 모델로 사용하며, MFMs 인코더의 각 트랜스포머 레이어에 어댑터 레이어를 삽입합니다. 대부분의 MFMs 인코더 레이어는 고정하고, 경량 어댑터 레이어, 프롬프트 인코더, 마스크 디코더만 파라미터 효율적으로 미세 조정합니다.

1. **적응형 어댑터 분해 (Global-local Decomposer, GLD)**:
    * 어댑터의 Conv 및 FC 레이어에 보조 GLD 브랜치를 추가하여 어댑터 유닛을 전역(클라이언트 불변) 및 로컬(클라이언트 특정) 구성 요소로 적응적으로 분해합니다.
    * GLD는 경량 클라이언트 판별기(client discriminator)를 사용하여 입력 표현이 어떤 클라이언트(도메인)에서 왔는지 분류하는 사전 훈련 작업(pretext task)을 수행합니다.
    * 손실 함수 $L_p = \frac{1}{N_I} \sum_{i=1}^{N_I} \sum_{j=1}^{K} \mathbf{1}_{[j=k]} \log(\mathbf{W_d}(\text{GAP}(\mathbf{F^{k}_{in}}(i))))$를 통해 훈련됩니다.
    * Gradient Reversal Layer (GRL)를 삽입하여 이 보조 브랜치가 메인 브랜치의 원래 훈련 프로세스에 영향을 미치지 않도록 합니다.
    * 각 유닛의 기여도 점수 $\mathbf{S}$를 계산하여 유닛이 클라이언트 특정 정보를 더 많이 포함하는지(로컬) 또는 클라이언트 불변 정보를 더 많이 포함하는지(전역)를 정량화합니다. $\mathbf{S}(i) = \hat{\mathbf{S}}(i) \otimes P(\hat{y}_i | \mathbf{F_{in}}(i))$

2. **클라이언트 맞춤형 연합 업데이트 전략**:
    * **이진 연합 업데이트(Binary Federated Updating, BFU)**:
        * 각 라운드에서 어댑터 유닛을 이진적으로 로컬(클라이언트 특정) 또는 전역(클라이언트 불변) 부분으로 분류합니다.
        * 정규화된 엔트로피를 통해 점수 분포의 클라이언트별 균일성($D_{u,k}$)을 계산하고, 임계값 $\delta$를 기준으로 유닛을 마스킹($M_{u,k}$)합니다.
        * $D_{u,k} = \frac{\text{Entropy}(S_{u,k})}{\text{Entropy}(U(1,K))} = \frac{\sum_{j=1}^{K} S_{u,k,j} \times \log_2 S_{u,k,j}}{\log_2 K}$
        * $M_{u,k} = 1$ (전역 유닛) if $D_{u,k} > \delta$, $0$ (로컬 유닛) if $D_{u,k} < \delta$.
        * 전역 유닛은 기존 FedAvg 방식으로 서버에서 평균화되어 업데이트($W^{t+1}_u = \frac{\sum_{k=1}^K M_{u,k} \times W^t_{u,k}}{\sum_{k=1}^K M_{u,k}}$)되며, 로컬 유닛은 클라이언트 내에서만 독립적으로 업데이트됩니다.
    * **스무스 연합 업데이트(Smooth Federated Updating, SFU)**:
        * BFU의 일반화된 버전으로, 각 유닛이 여러 클라이언트에 확률적으로 속한다고 간주합니다.
        * 각 유닛의 가중 기여도 점수를 사용하여 모든 클라이언트의 파라미터 그룹을 가중 평균하여 업데이트합니다.
        * $W^{t+1}_{u,j} = \frac{\sum_{k=1}^K S_{u,k,j} \times W^t_{u,k}}{\sum_{k=1}^K S_{u,k,j}}$.
        * 이는 모델 파라미터의 보다 적응적이고 동적인 업데이트를 가능하게 하여 각 클라이언트에 대한 스무스한 클라이언트 맞춤형 분할을 실현합니다.

## 📊 Results

* **정량적 성능**:
  * FCA-SFU는 CXRS-HG, HLS, AMD-SD-HG 세 가지 대규모 이질적 의료 영상 분할 데이터셋에서 기존 SOTA FL 방법들(MFMs 강화 변형 포함)을 일관되게 능가합니다.
  * 예를 들어, CXRS-HG에서 3.51%, HLS에서 1.65% 더 높은 mDice를 달성하여 강력한 성능 우위를 보였습니다.
  * FCA-SFU는 FCA-BFU보다 더 나은 성능을 보여, 스무스한 파라미터 가중치가 더 미세하고 적응적인 연합 업데이트를 가능하게 함을 입증했습니다.
* **정성적 분석**:
  * FCA-SFU는 기존 FedAvg* (MFMs 강화 변형) 및 FedAvg (비MFMs)에 비해 각 로컬 클라이언트에서 더 정밀한 분할 결과를 생성합니다.
  * 특히 클라이언트별 이질성(예: CXRS-HG의 복잡한 영역, HLS의 주석 이질성)에 강건하며, 타협된 전역 모델이 아닌 각 클라이언트에 최적화된 맞춤형 분할을 제공합니다.
* **이질성 완화 검증**:
  * 클래스 불균형과 분포 다양성이라는 두 가지 이질성 유형에 대해 FedAvg* 대비 mDice 성능이 크게 향상되었음을 보였습니다(예: 클래스 불균형에서 61.78에서 64.27로, 분포 다양성에서 62.91에서 64.05로).
  * 복합적인 이질성(불균형+다양성)에서도 FedAvg*의 성능 저하가 뚜렷한 반면, FCA-SFU의 성능 저하는 미미하여 이질성 완화 능력을 입증했습니다.
* **MFMs 일반화 능력**:
  * SAM-Med2D, Med-SA, H-SAM 등 다양한 MFMs에 대해 일관된 성능 향상을 보여 FCA 프레임워크의 일반화 능력을 확인했습니다.
* **연산 효율성**:
  * FCA-SFU는 약간의 모델 파라미터 증가와 통신 오버헤드만으로도 상당한 성능 향상을 달성하며, 다른 SOTA 방법들보다 수렴 속도가 훨씬 빠릅니다.

## 🧠 Insights & Discussion

FCA 프레임워크는 기존 연합 학습이 겪는 클라이언트별 데이터 이질성으로 인한 학습 불안정성 문제를 효과적으로 해결합니다. 이는 크게 두 가지 혁신적인 접근 방식을 통해 이루어집니다: 첫째, 기성 의료 파운데이션 모델에서 보편적인 지식을 어댑터를 통해 증류하여 연합 학습의 안정성을 높입니다. 둘째, 어댑터 유닛을 클라이언트 특정 및 클라이언트 불변 부분으로 분해하고, 이를 위한 이진(BFU) 및 스무스(SFU) 연합 업데이트 전략을 개발하여 각 클라이언트에 최적화된 맞춤형 모델을 생성합니다. 특히 SFU는 보다 유연하고 동적인 파라미터 관리를 가능하게 하여 복잡한 이질성 환경에서도 뛰어난 성능을 보입니다. 이러한 접근 방식은 민감한 의료 데이터를 공유하지 않고도 분산 환경에서 고정밀 의료 영상 분할을 가능하게 하여 실제 임상 적용 가능성을 크게 높입니다.

## 📌 TL;DR

**문제**: 연합 학습은 의료 데이터 프라이버시 문제를 해결하지만, 클라이언트별 데이터 이질성(클래스 불균형, 분포 다양성)으로 인해 학습이 불안정하며, 전역 모델이 각 클라이언트에 최적화되지 못함.
**해결책**:

1. **어댑터 활용**: 기성 의료 파운데이션 모델(MFMs)에 경량 어댑터를 삽입하여 보편적 지식을 증류하고 연합 학습 안정화.
2. **GLD 기반 파라미터 분해**: Global-local Decomposer (GLD)를 통해 어댑터 유닛을 클라이언트 불변(전역) 및 클라이언트 특정(로컬) 구성 요소로 동적으로 분해.
3. **맞춤형 연합 업데이트**: 이진(BFU) 또는 스무스(SFU) 연합 업데이트 전략을 사용하여 전역 유닛은 FedAvg 방식으로, 로컬 유닛은 독립적으로 업데이트하거나, 각 유닛의 가중 기여도를 기반으로 모든 클라이언트의 파라미터를 스무스하게 가중 평균하여 업데이트.
**결과**: FCA는 세 가지 대규모 이질적 의료 영상 데이터셋에서 SOTA 성능을 달성하며, 기존 FL 방법 대비 학습 안정성 및 클라이언트 맞춤형 분할 정확도를 크게 향상시킴. 특히 SFU 전략이 가장 우수하며, 다양한 MFMs에 대해 일반화 가능하고 효율적임.
