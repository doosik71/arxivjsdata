# Affinity-Graph-Guided Contractive Learning for Pretext-Free Medical Image Segmentation with Minimal Annotation

Zehua Cheng, Di Yuan and Thomas Lukasiewicz

## 🧩 Problem to Solve

의료 영상 분할에서 반지도 학습(SemiSL)과 대조 학습(CL)의 결합은 제한된 어노테이션 환경에서 성공적이었으나, 다음과 같은 두 가지 주요 문제점을 가지고 있습니다:

1. **프리텍스트(Pretext) 작업에 대한 의존성:** 기존 방법들은 픽셀 수준 분할에 특화되지 않은 프리텍스트 작업에 의존하여 샘플링 편향, 클래스 충돌, 도메인 차이 등으로 인해 모델의 일반화 능력이 저하됩니다. 특히 의료 영상 분야에서는 이러한 도메인 이동 문제가 두드러집니다.
2. **감독 신호 부족으로 인한 과적합 문제:** 적은 수의 어노테이션으로 인해 감독 신호가 불충분하여 모델이 과적합되기 쉽습니다. 기존 손실 함수는 클래스 내 압축성(intra-class compactness)과 클래스 간 분리성(inter-class separability)을 강제하지 못하며, 단일 데이터셋에 최적화된 경우가 많아 다른 도메인으로의 일반화에 어려움을 겪습니다.

이러한 문제들은 제한된 라벨 데이터 환경에서 클러스터 경계를 모호하게 만들어 비라벨 데이터에 대한 정확한 라벨 할당을 방해하고, 학습된 특징 표현의 품질을 저해합니다.

## ✨ Key Contributions

* **새로운 프레임워크 제안:** 프리텍스트 작업에 대한 의존성 및 감독 신호 부족으로 인한 과적합 문제를 완화하기 위해, 극히 적은 어노테이션(minimal annotations)으로 고정밀 의료 영상 분할을 달성하는 **어피니티 그래프 기반 반지도 대조 학습(Semi-AGCL)** 프레임워크를 제안합니다.
* **프리텍스트 없는 클래스 판별 특징 학습:** 생성된 의사 라벨에 어피니티 그래프를 외부 제약으로 사용하여 명시적인 프리텍스트 학습 없이 클래스 판별 특징을 강화하고, 이는 여러 도메인에 걸친 뛰어난 일반화 가능성을 입증합니다.
* **엔트로피 기반 패치 샘플링:** SemiSL 설정에서 얻은 의사 라벨을 기반으로 엔트로피 기반 측정법을 통해 긍정 및 부정 패치 선택을 유도하는 패치 기반 CL 프레임워크를 활용합니다. 이는 의미론적으로 유사한 인스턴스의 강제적 대조(클래스 충돌)를 방지합니다.
* **일반화 및 견고성 입증:** 세 가지 의료 영상 데이터셋(LA, ACDC, CRAG)에 대한 평가를 통해, 제한된 어노테이션 샘플 수에도 불구하고 제안된 방법론의 효과성, 일반화 가능성, 그리고 견고성을 성공적으로 입증했습니다.

## 📎 Related Works

* **반지도 학습 (Semi-supervised Learning, SemiSL):** 대규모 비라벨 샘플로부터 가치 있는 표현을 학습하는 동시에 소수의 라벨 샘플에 대한 지도 학습을 수행하는 방식입니다. 주로 의사 라벨링(pseudo-labeling) [12], 일관성 정규화(consistency regularization) [13, 14], 엔트로피 최소화(entropy minimization) [15, 16] 등의 기법을 포함합니다. 대표적으로 Mean Teacher 프레임워크 기반의 UA-MT [17], Double-UA [18], SASSNet [19], DTC [20], URPC [21], MC-Net [22], SS-Net [8] 등이 있습니다.
* **대조 학습 (Contrastive Learning, CL):** 유사한 샘플의 상호 정보량을 최대화하고, 상이한 샘플의 유사성을 최소화하여 표현을 학습합니다 [23, 24]. 그러나 의료 영상 분할에 적용 시 (i) 비정보성 또는 비유도성 음성 샘플 선택으로 인한 샘플링 편향 및 클래스 충돌 [6], (ii) 대규모 자연 영상 데이터셋에서 사전 학습된 모델을 의료 영상 분야에 전이할 때 발생하는 상당한 도메인 이동 문제 [27], (iii) 적절한 프리텍스트 작업 설계의 어려움 및 데이터셋 간 일반화 문제 [28]에 직면합니다.

본 연구는 이러한 기존 CL의 한계를 극복하고, SemiSL과의 시너지 효과를 통해 의료 영상 분할을 위한 효과적인 표현 학습 능력을 제공하는 것을 목표로 합니다. 기존 기술과 달리 사전 학습 없이 엔드투엔드로 훈련 가능합니다.

## 🛠️ Methodology

제안하는 Semi-AGCL 프레임워크는 교사-학생 모델을 기반으로 하며, 패치 단위 대조 학습을 통해 라벨링된 데이터 $D_L$와 비라벨링된 데이터 $D_U$ 모두의 정보를 활용합니다.

1. **패치 단위 클래스 중심 샘플링 (Patch-wise Class-centric Sampling):**
    * **클래스별 신뢰도 맵 생성:** 각 클래스 $k$에 대해 픽셀이 해당 클래스에 속할 가능성을 나타내는 클래스별 신뢰도 맵 $C^k_i$를 생성합니다.
    * **평균 패치 엔트로피 계산:** 신뢰도 맵을 통해 강조된 이미지 $X'^k_i = X_i \odot C^k_i$를 기반으로 각 패치 $P^k_{i,j}$에 대한 평균 패치 엔트로피 $Ent^k_{i,j}$를 계산합니다. 이는 패치의 클래스 $k$에 대한 확신도, 다른 클래스와의 불확실성, 원본 이미지의 강도 정보를 통합한 풍부한 측정치입니다.
        $$Ent^k_{i,j} = -\frac{1}{|P^k_{i,j}|} \sum_{m \in P^k_{i,j}} (X'^k_i(m) \log(X'^k_i(m)) + (1-X'^k_i(m)) \log(1-X'^k_i(m)))$$
    * **정보성 패치 샘플링:** 앵커 패치에 대해 Top-n 엔트로피 값을 가진 패치를 긍정 패치로, 나머지를 부정 패치로 선정하여 클래스 충돌을 방지하고 정보성 높은 감독 신호를 제공합니다.

2. **의사 라벨 간 어피니티 그래프 유도 대조 손실 (Affinity-Graph-Guided Contrastive Loss between Pseudo Labels, $L_{PL\_AGG}$):**
    * 학생 네트워크($\hat{Y}_S$)와 교사 네트워크($\hat{Y}_T$)의 의사 라벨 간에 패치 단위 어피니티 그래프 $A \in \mathbb{R}^{N \times N}$를 구축합니다. 엣지 가중치 $A_{ij}$는 의사 라벨 벡터 $\hat{y}^t_i$와 $\hat{y}^s_j$ 간의 $L_2$ 거리를 기반으로 가우시안 커널을 사용하여 정의됩니다:
        $$A_{ij} = \exp \left( -\frac{||\hat{y}^t_i - \hat{y}^s_j||^2_2}{2\sigma^2} \right)$$
    * 이 손실은 어피니티 그래프의 대각선 요소 $A_{ii}$를 최대화하여 학생 및 교사 예측의 수렴을 촉진하고, 동시에 핵 규범(nuclear norm) $||A||_*$을 최소화하여 저랭크 구조를 추출함으로써 과적합을 방지합니다.
    * 최종 $L_{PL\_AGG}$ 손실 함수:
        $$L_{PL\_AGG} = \sum_{i=1}^{N} \exp \left( -\frac{||\hat{y}^t_i - \hat{y}^s_i||^2_2}{2\sigma^2} \right) + \gamma||A||_*$$

3. **어피니티 그래프 유도 하드 네거티브 재가중 (Affinity-Graph-Guided Hard-Negative Reweighting, $L_{RW\_AGG}$):**
    * 어피니티 그래프의 대각선 요소 $A_{ii}$ (낮은 $A_{ii}$는 하드 네거티브 샘플을 나타냄)를 기반으로 하드 네거티브 샘플 $h_k$를 식별합니다. $h_k$는 앵커와 유사하지만 라벨이 다른 샘플입니다.
    * $h_k$는 기존 네거티브 샘플 $n_i, n_j$의 혼합으로 구성됩니다:
        $$h_k = \frac{A_{ii} n_i + (1-A_{ii}) n_j}{||A_{ii} n_i + (1-A_{ii}) n_j||_2}$$
    * 일반적인 대조 학습 손실에 하드 네거티브 샘플을 재가중하여 학습 표현의 판별 능력을 향상시킵니다:
        $$L_{RW\_AGG} = -\log \frac{\exp(q^T \cdot k^+ / \tau)}{\exp(q^T \cdot k^+ / \tau) + \sum_{h_k \in H} \exp(q^T \cdot h_k / \tau)}$$

4. **전체 손실 함수 (Overall Loss Function):**
    제안된 프레임워크의 전체 손실 함수는 다음과 같습니다:
    $$L_{all} = L_{sup} + L_{reg} + L_{PL\_AGG} + L_{RW\_AGG}$$
    여기서 $L_{sup}$는 라벨된 데이터에 대한 지도 학습 손실, $L_{reg}$는 학생 및 교사 네트워크 출력 간의 교차 엔트로피 손실입니다.

## 📊 Results

제안된 Semi-AGCL 프레임워크는 LA, ACDC, CRAG 세 가지 의료 영상 데이터셋에서 다양한 라벨링 비율(5%, 10%)로 평가되었습니다. 평가지표로는 Dice Similarity Score (DSC), Jaccard Index, Hausdorff Distance 95 (HD95), Average Symmetric Distance (ASD)가 사용되었습니다.

* **LA 데이터셋:** 5% 라벨 비율에서 기존 SOTA 방법론 대비 DSC 3.11%, Jaccard 2.90% 등 모든 지표에서 유의미한 성능 향상을 달성했습니다.
* **ACDC 데이터셋:** 5% 라벨 비율에서 DSC가 최대 23.09%까지 크게 향상되었습니다. 10% 라벨 비율에서도 전반적으로 최적의 성능을 보였습니다.
* **CRAG 데이터셋:** 10% 라벨 비율에서도 100% 라벨링된 U-Net보다 우수한 분할 성능을 달성하여 극히 적은 어노테이션 환경에서의 강력한 효과를 입증했습니다. 이는 2D 슬라이스의 조합 가능성이 높고, 조직 병리 이미지의 풍부한 텍스처 특징이 어피니티 그래프의 엣지 정보를 풍부하게 하기 때문으로 분석됩니다.
* **일반화 및 견고성:** 세 가지 상이한 도메인의 데이터셋에서 일관되게 탁월한 성능을 보여, 제안된 방법론의 뛰어난 일반화 능력과 견고성을 증명했습니다.
* **계산 효율성:** Semi-AGCL은 기존 SOTA 반지도 학습 방법론 중 두 번째로 빠른 훈련 시간을 기록하며, 복잡한 매트릭스 연산에도 불구하고 병렬화가 용이하여 효율적인 계산이 가능함을 보여주었습니다.

**어블레이션 연구 결과:**

* $L_{PL\_AGG}$와 $L_{RW\_AGG}$ 각 모듈의 효과성과 상호 보완성을 입증했습니다. 특히, 어피니티 그래프의 대각선 요소에 기반한 $\lambda||A||_*$ 항의 추가가 성능 향상에 크게 기여함을 확인했습니다.
* 패치 단위 클래스 중심 샘플링의 효과를 검증한 결과, 제안된 엔트로피 기반 샘플링 방법이 코사인 유사성이나 클래스 신뢰도 기반 샘플링보다 훨씬 뛰어난 성능을 보였습니다. 이는 부정확한 샘플 분류를 줄이고, 패치 간 불균형 매핑에 대한 더 효율적인 측정을 제공하기 때문입니다.

## 🧠 Insights & Discussion

* **데이터 내재 구조 활용:** Semi-AGCL은 어피니티 그래프를 통해 데이터의 내재된 기하학적 및 위상적 관계를 명시적으로 포착하고 활용합니다. 이는 클래스 내 압축성 및 클래스 간 분리성을 효과적으로 강화하여, 제한된 라벨 데이터 환경에서도 모델이 더욱 판별력 있는 특징을 학습할 수 있도록 돕습니다.
* **과적합 완화 및 일반화 향상:** 핵 규범 최소화를 통한 저랭크 정규화는 학생 및 교사 네트워크 출력에서 노이즈를 필터링하고 가장 중요한 정렬 패턴을 추출하여 과적합을 방지하고 모델의 일반화 능력을 크게 향상시킵니다.
* **프리텍스트 문제 해결:** 평균 패치 엔트로피 기반 샘플링은 프리텍스트 작업에 의존하지 않고도 견고한 초기 특징 공간을 제공하며, 클래스 충돌을 효과적으로 회피하여 의료 영상 특유의 도메인 차이 문제를 완화합니다.
* **하드 네거티브 샘플링의 중요성:** 어피니티 그래프를 통해 효과적인 하드 네거티브 샘플을 식별하고 이를 대조 학습에 재가중함으로써, 학습된 표현의 판별 능력을 더욱 정교하게 다듬을 수 있습니다.

**한계 및 논의:** ACDC 데이터셋에서 10% 라벨링 비율 시 HD95와 ASD 지표가 5% 때보다 오히려 감소하는 경향을 보인 것에 대해, 저자들은 어피니티 그래프 기반 손실 함수가 엣지의 복잡한 세부 사항에 대해 적절한 훈련 반복 횟수 증가를 요구할 수 있다고 언급했습니다. 이는 향후 연구에서 복잡한 구조를 가진 데이터에 대한 최적의 학습 스케줄 또는 손실 가중치 튜닝에 대한 추가적인 탐색이 필요함을 시사합니다.

## 📌 TL;DR

* **문제:** 적은 어노테이션으로 인한 과적합 및 프리텍스트 작업 의존성으로 의료 영상 분할 성능 한계.
* **해결:** Semi-AGCL(어피니티 그래프 기반 반지도 대조 학습) 제안. 평균 패치 엔트로피 기반 샘플링으로 프리텍스트 없이 견고한 특징 공간 구축. 학생-교사 네트워크 의사 라벨 간 어피니티 그래프 손실($L_{PL\_AGG}$) 및 하드 네거티브 재가중 손실($L_{RW\_AGG}$) 설계로 데이터 내재 구조 활용, 과적합 완화, 일반화 능력 극대화.
* **결과:** 5%, 10%의 극히 적은 어노테이션만으로도 SOTA 방법론을 크게 능가하는 분할 성능 달성. 다양한 의료 영상 데이터셋에서 뛰어난 일반화 및 견고성 입증.
