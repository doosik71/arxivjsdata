# Bootstrapping Semantic Segmentation with Regional Contrast

Shikun Liu, Shuaifeng Zhi, Edward Johns, and Andrew J. Davison

## 🧩 Problem to Solve

시맨틱 분할(semantic segmentation)은 이미지 내 모든 픽셀에 의미론적 레이블을 할당하는 중요한 작업이지만, 픽셀 단위의 정확한 어노테이션은 시간과 비용이 많이 소모됩니다 (예: CityScapes 이미지 하나에 90분 이상 소요). 이로 인해 실제 애플리케이션에서 제한된 레이블링 데이터만 사용 가능할 경우 병목 현상이 발생합니다. 기존 시맨틱 분할 모델은 인접 픽셀이 같은 클래스에 속하는 경향이 있다는 학습 편향 때문에 일반적으로 부드러운 레이블 맵을 예측하여 객체 경계가 흐려지고 희귀한 객체가 잘못 분류되는 경향이 있습니다. 특히 잘못 분류된 픽셀은 소수의 다른 클래스와 혼동되는 경우가 많습니다.

## ✨ Key Contributions

* 시맨틱 분할 학습을 지원하기 위한 지역 기반 대조 학습 프레임워크인 ReCo(Regional Contrast)를 제안합니다.
* 최소한의 추가 메모리만으로 희소한 하드 네거티브 픽셀에 대해 준지도 학습(semi-supervised) 또는 지도 학습(supervised) 방식의 픽셀 단위 대조 학습을 수행합니다.
* 기존 분할 네트워크 위에 쉽게 구현할 수 있으며, 준지도 및 지도 시맨틱 분할 방법 모두에서 일관되게 성능을 향상시켜 더 부드러운 분할 경계와 더 빠른 수렴을 달성합니다.
* 특히 레이블이 매우 적은 준지도 학습에서 가장 강력한 효과를 보여, 각 시맨틱 클래스에 대해 단 5개의 예시만으로도 고품질 시맨틱 분할 모델을 훈련할 수 있습니다.
* 새로운 준지도 분할 벤치마크 설계 방식(부분 데이터셋 완전 레이블, 부분 레이블 전체 데이터셋)을 제안합니다.

## 📎 Related Works

* **시맨틱 분할:** FCNs [19], dilated/atrous convolutions [3,4], 인코더-디코더 아키텍처 [26,15], 클래스 불균형을 위한 손실 함수 [18], 픽셀 단위 렌더링 전략 [16] 등 강력한 CNN 설계에 의존합니다. ReCo는 이 연구 라인에 기반한 모델-불가지론적(model-agnostic) 프레임워크입니다.
* **준지도 분류 및 분할:** 대량의 비레이블링 데이터를 활용하여 모델 성능을 향상시키는 것을 목표로 하며, 일관성 정규화(consistency regularization) 및 엔트로피 최소화(entropy minimization)가 일반적인 전략입니다 [27,29,2,17]. 분할의 경우, 적대적 학습 [12,21], 클래스 활성화 맵 [38], 다양한 증강 이미지 [9,24] 및 네트워크 [13]로부터의 일관성 적용 등이 있습니다.
* **대조 학습(Contrastive Learning):** 동일 데이터 뷰를 표현 공간에서 가깝게, 다른 데이터 뷰를 멀게 만듦으로써 유사성 함수를 학습합니다. 대부분의 최근 프레임워크는 전역 표현(global representations) [10,5,14]에 기반하며, ReCo와 같은 밀집 표현(dense representations)은 미세한 픽셀 대응 관계를 포착하여 추가적인 지도 학습을 제공합니다 [32,23].
* **시맨틱 분할을 위한 대조 학습:** [33] 및 [34]는 사전 학습을 통해 대조 학습을 수행하지만, 막대한 메모리 소비를 수반합니다. ReCo는 능동 샘플링을 통해 훨씬 적은 메모리로 대조 학습을 수행합니다. 동시 연구 [31,1]도 능동 샘플링을 사용하지만, ReCo는 온디맨드(on-the-fly)로 특징을 샘플링하며, 관계 그래프와 예측 신뢰도에 기반하여 추가적인 계산 오버헤드 없이 구현됩니다.

## 🛠️ Methodology

ReCo는 기존 시맨틱 분할 모델에 쉽게 추가할 수 있는 보조 손실 함수입니다.

1. **픽셀 단위 대조 학습:**
    * 분할 네트워크 $f$는 인코더 $\phi: X \to Z$ 와 디코더 분류 헤드 $\psi_c: Z \to Y$ 로 구성됩니다.
    * 추가적으로 디코더 표현 헤드 $\psi_r: Z \to R$ (여기서 $R \in \mathbb{R}^m$)를 분류 헤드와 병렬로 인코더 위에 부착합니다. 이 헤드는 훈련 중에만 사용됩니다.
    * ReCo 손실 $L_{\text{reco}}$는 쿼리 $r_q$가 동일 클래스의 평균 표현(positive key) $r_{c,+k}$에 가까워지고, 다른 클래스에서 샘플링된 표현(negative key) $r_{-k}$에서 멀어지도록 유도합니다.
    * ReCo 손실의 일반적인 형식은 다음과 같습니다:
        $$L_{\text{reco}} = \sum_{c \in C} \sum_{r_q \sim R_c^q} -\log \frac{\exp(r_q \cdot r_{c,+k}/\tau)}{\exp(r_q \cdot r_{c,+k}/\tau) + \sum_{r_{-k} \sim R_c^k} \exp(r_q \cdot r_{-k}/\tau)}$$
        여기서 $C$는 현재 미니배치 내의 모든 클래스 집합, $\tau$는 온도 파라미터입니다. $R_c^q$는 클래스 $c$에 속하는 쿼리 표현 집합, $R_c^k$는 클래스 $c$에 속하지 않는 네거티브 키 표현 집합입니다. $r_{c,+k}$는 클래스 $c$의 평균 표현입니다.
2. **능동적 하드 샘플링:**
    * **능동적 키 샘플링:** 각 쿼리 클래스에 대해, 해당 쿼리 클래스와의 상대적 거리에 기반하여 네거티브 키를 비균일적으로 샘플링합니다. 이는 각 미니배치마다 동적으로 업데이트되는 쌍별 클래스 관계 그래프 $G \in \mathbb{R}^{|C| \times |C|}$를 사용하여 이루어집니다. 이 관계는 두 클래스의 평균 표현 간의 정규화된 내적 $G[p,q] = (r_{p,+k} \cdot r_{q,+k})$으로 측정됩니다.
    * **능동적 쿼리 샘플링:** 예측 신뢰도 $\hat{y}_q$가 정의된 임계값 $\delta_s$보다 낮은 픽셀에 해당하는 '하드 쿼리'를 샘플링합니다. 이는 시맨틱 분할의 클래스 불균형 문제를 해결하고 불확실한 픽셀에 대한 학습을 강화합니다.
3. **ReCo를 통한 시맨틱 분할 학습:**
    * ReCo는 추론 시 추가 비용 없이 기존 지도 및 준지도 분할 방법에 쉽게 통합될 수 있습니다.
    * **지도 분할 설정:** 전체 훈련 데이터에 ground-truth 어노테이션이 있는 경우, 총 손실은 지도 교차 엔트로피 손실과 ReCo 손실의 선형 조합입니다: $L_{\text{total}} = L_{\text{supervised}} + L_{\text{reco}}$.
    * **준지도 분할 설정:** Mean Teacher 프레임워크 [29]를 사용하여 비레이블링 이미지로부터 생성된 의사 레이블(pseudo-labels)을 활용합니다. 의사 레이블 신뢰도 $\delta_w$ 이상의 픽셀만 샘플링하여 부정확한 의사 레이블을 피합니다.
    * 총 손실은 지도 교차 엔트로피 손실, 비지도 교차 엔트로피 손실, ReCo 손실의 선형 조합입니다: $L_{\text{total}} = L_{\text{supervised}} + \eta \cdot L_{\text{unsupervised}} + L_{\text{reco}}$. ($\eta$는 비지도 손실의 기여도를 재조정하는 스칼라입니다.)

## 📊 Results

* **Pascal VOC, CityScapes, SUN RGB-D (Full Labels):**
  * ReCo는 모든 경우에 준지도 및 지도 설정에서 일관되게 성능을 향상시킵니다.
  * 특히 레이블이 가장 적은 설정에서 ClassMix 대비 5-10%의 현저한 상대적 성능 향상을 보입니다.
  * 정성적 분석 결과, ReCo는 CityScapes의 '사람' 및 '자전거' 클래스, SUN RGB-D의 '램프' 및 '베개' 클래스처럼 작은 객체의 경계가 더 뚜렷하고 정확하게 예측됩니다. 모호한 클래스 쌍(예: 테이블과 책상, 창문과 커튼)에서도 더 정확한 객체 경계를 생성합니다.
* **Pascal VOC, CityScapes (Partial Labels):**
  * 부분 레이블 설정에서도 ClassMix 대비 약 1-5%의 상대적 성능 향상을 보이지만, 완전 레이블 설정만큼 두드러지지는 않습니다. 이는 매우 낮은 수준의 ground-truth 어노테이션이 ReCo에 부정확한 지도를 제공할 수 있기 때문으로 분석됩니다.
* **어블레이션 연구:**
  * **쿼리 및 키 수:** 더 많은 쿼리 및 키를 샘플링할수록 성능이 향상되지만, 특정 지점 이후에는 개선이 미미합니다. 전체 픽셀 공간의 0.5% 미만인 32개의 쿼리/클래스만으로도 상당한 성능 향상을 보여 메모리 효율성(동시 연구 대비 50배 효율적)을 입증합니다.
  * **비레이블링 데이터 비율:** 비레이블링 데이터의 10%만으로도 ClassMix 기준선을 능가하며, 데이터 효율성 측면에서도 강한 일반화 능력을 보입니다.
  * **준지도 방법 선택:** ReCo는 다양한 준지도 기준선(CutOut, CutMix, ClassMix)에 걸쳐 견고한 성능 개선을 보여줍니다.
  * **능동 샘플링 효과:** 능동 샘플링, 특히 하드 쿼리 샘플링은 중요한 성능 향상 요인임을 확인했습니다. 무작위 샘플링은 효과가 훨씬 적습니다.
  * **특징 뱅크 방법과의 비교:** ReCo의 배치 단위 샘플링 방식은 특징 뱅크 방식과 유사한 성능을 보였으며, 이는 전체 데이터셋에 대한 클래스 분포의 정확한 근사치임을 입증합니다.

## 🧠 Insights & Discussion

* ReCo는 비레이블링 데이터를 활용하는 지역 대조 학습을 통해 제한된 레이블링 데이터 문제를 효과적으로 해결합니다.
* 하드 쿼리(불확실한 픽셀) 및 하드 네거티브 키(혼란스러운 클래스)에 대한 능동 샘플링 전략은 학습을 어려운 픽셀과 클래스 관계에 효율적으로 집중시켜, 특히 희귀 객체에 대해 더 선명한 경계와 정확한 예측을 가능하게 합니다.
* ReCo의 임베딩 ($R$ 및 $Z$)을 사용한 클래스 관계 그래프 및 덴드로그램 시각화는 ReCo가 시맨틱 특징을 더 잘 분리하여 구조적이고 해석 가능한 시맨틱 트리를 형성함을 보여줍니다 (예: 유사한 운송 클래스 그룹화). 이는 개선된 성능의 원인을 설명합니다.
* 제한 사항: 매우 적은 부분 레이블 설정에서는 부정확한 의사 레이블이 ReCo를 혼란스럽게 할 수 있어 성능 향상이 덜 두드러집니다. 향후 연구는 비디오 표현 학습을 위한 효과적인 대조 프레임워크 설계를 목표로 합니다.

## 📌 TL;DR

* **문제:** 시맨틱 분할은 막대한 픽셀 단위 레이블링 비용과 제한된 데이터로 인해 경계가 흐려지고 희귀 객체 분류 성능이 저하되는 문제에 직면합니다.
* **해결책:** ReCo(Regional Contrast)는 새로운 픽셀 단위 대조 학습 프레임워크입니다. 이 프레임워크는 보조 표현 헤드와 새로운 손실 함수를 사용하며, '하드 쿼리'(불확실한 픽셀)와 '하드 네거티브 키'(혼동하기 쉬운 클래스)를 능동적으로 샘플링하여 학습을 효율적으로 집중시킵니다.
* **주요 발견:** ReCo는 지도 및 준지도 시맨틱 분할 모두에서, 특히 레이블이 매우 적은 경우에도 일관되게 성능을 향상시키며, 더 선명한 객체 경계와 정확한 예측을 달성합니다. ReCo는 메모리 효율적이며 시맨틱 특징을 효과적으로 분리하는 것으로 나타났습니다.
