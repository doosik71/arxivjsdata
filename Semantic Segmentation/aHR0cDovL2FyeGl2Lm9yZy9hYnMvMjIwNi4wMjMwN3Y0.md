# Bootstrapping Semi-supervised Medical Image Segmentation with Anatomical-aware Contrastive Distillation

Chenyu You, Weicheng Dai, Yifei Min, Lawrence Staib, and James S. Duncan

## 🧩 Problem to Solve

의료 영상 분할(Medical Image Segmentation)은 픽셀 단위의 정확한 수동 레이블링이 막대한 시간, 비용, 전문 지식을 요구하여 레이블 부족 문제에 직면해 있습니다. 이를 해결하기 위해 준지도 학습(Semi-supervised Learning, SSL)이 유망한 대안으로 제시되지만, 기존 대조 학습(Contrastive Learning) 기반 SSL 방법들은 다음과 같은 한계를 가집니다:

* **클래스 분포 불균형**: 실제 의료 영상 데이터는 대다수 클래스 불균형(multi-class label imbalance) 문제를 가지며, 이는 분할 결과의 경계를 흐릿하게 만들고 희귀 객체를 오분류하는 결과를 초래합니다. 기존 방법들은 대부분 균형 잡힌 클래스 분포를 가정합니다.
* **"부정 샘플"의 균일성 문제**: 모든 부정(negative) 샘플이 동일하게 부정적인지에 대한 의문이 남아있으며, 이는 표현 학습에서 잘못된 부정(false negatives)을 야기하여 분할 성능을 저해할 수 있습니다.

## ✨ Key Contributions

* 의료 영상 분할을 위한 **해부학적 인식 대조 증류(Anatomical-aware ConTrastive dIstillatiON, ACTION)** 프레임워크를 제안했습니다.
* 긍정(positive) 및 부정(negative) 쌍 간의 이진(binary) 감독 대신, 부정 샘플에 **소프트 레이블링(soft labeling)**을 사용하는 **반복적 대조 증류(iterative contrastive distillation) 알고리즘**을 개발했습니다.
* 샘플링된 데이터의 다양성을 강화하기 위해 무작위로 선택된 부정 샘플 세트에서 긍정 샘플보다 더 의미론적으로 유사한 특징을 포착합니다.
* 최소한의 추가 메모리 오버헤드로 전체 데이터셋에 걸쳐 **전역적 의미 관계(global semantic relationship)**와 인접 픽셀 간의 **지역적 해부학적 특징(local anatomical features)**을 학습하는 방법을 제시합니다.
* 훈련 과정에서 희소한 **하드 부정 픽셀(hard negative pixels)**을 능동적으로 샘플링하여 더 부드러운 분할 경계와 더 정확한 예측을 생성하는 **해부학적 대조(anatomical contrast)** 개념(AnCo 손실)을 도입했습니다.
* 두 가지 벤치마크 데이터셋(ACDC, LiTS)과 다양한 비레이블링 설정에서 기존 최첨단 준지도 학습 방법들보다 **상당히 우수한 성능**을 달성했습니다.

## 📎 Related Works

이 연구는 다양한 준지도 학습(SSL) 방법론과 대조 학습 기법들을 참고합니다.

* **기존 SSL 방법**: 적대적 훈련 [37, 12, 32, 28, 33], 딥 공동 훈련 [21, 38], 평균 교사(mean teacher) [23, 36], 다중 작업 학습 [16, 11, 4, 31] 등의 접근 방식을 언급합니다.
* **대조 학습**: BYOL [7] 및 MoCo [8]와 같이 레이블 없는 데이터로부터 풍부한 시각적 표현을 학습하는 대조 학습의 성공에 기반을 둡니다. 특히 의료 영상 분야에 대조 학습을 적용한 [3, 9, 34, 35, 29, 30]과 비교됩니다.
* **백본 네트워크**: 의료 영상 분할에서 널리 사용되는 U-Net [22]을 백본 아키텍처로 채택합니다.
* **클래스 불균형**: 의료 영상 데이터의 클래스 불균형이 분할 품질에 미치는 부정적인 영향 [14, 39]에 대한 기존 연구를 인지합니다.
* **잘못된 부정(False Negatives)**: 표현 학습에서 발생할 수 있는 잘못된 부정 샘플 문제 [24, 10]를 해결하고자 합니다.
* **지역적 대조**: 지역적 대조 개념을 도입한 [15]에서 영감을 받았습니다.

## 🛠️ Methodology

ACTION 프레임워크는 BYOL [7] 파이프라인과 2D U-Net [22] 백본을 기반으로 하며, 세 가지 주요 훈련 단계로 구성됩니다:

1. **전역 대조 증류 사전 학습 (Global Contrastive Distillation Pre-Training)**:
    * **목표**: 비레이블된 데이터를 사용하여 전역(global) 수준의 특징을 학습합니다.
    * **과정**: 입력 쿼리 이미지 $q$에 두 가지 증강($q_t$, $q_s$)을 적용하고, 비레이블된 이미지에서 무작위로 $n$개의 이미지를 앵커 포인트 $\{x_j\}^n_{j=1}$로 샘플링합니다. 교사 네트워크($E_t, H^g_t$)와 학생 네트워크($E_s, H^g_s, H^g_p$)는 이들로부터 특징 임베딩($z_t, z_s$)을 생성합니다.
    * 소프트맥스(SoftMax) 함수를 통해 임베딩을 확률 분포($p_t(j), p_s(j)$)로 변환하고, 교사의 분포와 학생의 예측 분포 간의 KL 발산($L_{contrast} = \text{KL}(p_t || p_s)$)을 최소화하여 학습합니다. 이는 무작위 샘플링된 이미지를 통해 학습 데이터의 다양성을 확보합니다.
    $$ p_t(j) = -\log \frac{\exp(\text{sim}(z_t, a_j)/\tau_t)}{\sum_{i=1}^n \exp(\text{sim}(z_t, a_i)/\tau_t)} $$
    $$ p_s(j) = -\log \frac{\exp(\text{sim}(z^*_s, a_j)/\tau_s)}{\sum_{i=1}^n \exp(\text{sim}(z^*_s, a_i)/\tau_s)} $$

2. **지역 대조 증류 사전 학습 (Local Contrastive Distillation Pre-Training)**:
    * **목표**: 인코더와 디코더를 포함한 전체 모델($F_t, F_s$)이 픽셀 수준의 대조 학습을 수행하도록 훈련합니다.
    * **과정**: 레이블된 데이터에는 교차 엔트로피 손실과 Dice 손실의 조합인 지도 학습 손실을 적용합니다. 비레이블된 데이터에는 Stage-i와 유사하게 지역 수준의 $L_{contrast}$를 적용하며, 이 과정에서 무작위 샘플링된 이미지들도 유사성 강화를 위해 포함됩니다. Stage-iii의 초기화를 위해 훈련된 모델 가중치를 재사용합니다.

3. **해부학적 대조 미세 조정 (Anatomical Contrast Fine-Tuning)**:
    * **목표**: 의료 영상의 클래스 불균형과 불확실성 문제를 해결하여 표현의 균형과 식별력을 높입니다.
    * **과정**: 학생 네트워크에 세그멘테이션 헤드와 병렬로 **표현 디코더 헤드($H_r$)**를 추가하여 픽셀 수준의 고차원 임베딩($r_q, r^+_k, r^-_k$)을 생성합니다.
    * **AnCo 손실($L_{anco}$)**을 사용하여 쿼리 임베딩을 해당 클래스의 평균 특징(긍정 키 $r^{c,+}_k$)에 가깝게 당기고, 다른 클래스의 특징(부정 키 $r^-_k$)과는 멀어지게 만듭니다.
    $$ L_{anco} = \sum_{c \in C} \sum_{r_q \sim R^q_c} -\log \frac{\exp(r_q \cdot r^{c,+}_k/\tau_{an})}{\exp(r_q \cdot r^{c,+}_k/\tau_{an}) + \sum_{r^-_k \sim R^k_c} \exp(r_q \cdot r^-_k/\tau_{an})} $$
    * GPU 메모리 제약을 극복하고 효율적인 학습을 위해 **능동적 하드 샘플링(active hard sampling)** 기법을 도입합니다. 이는 쿼리 클래스와 다른 클래스 간의 유사도를 기반으로 부정 키를 비균일적으로 샘플링하고, 예측 신뢰도 임계값($\theta_s$)에 따라 하드 쿼리를 샘플링하여 희귀 클래스 식별력을 높입니다.

## 📊 Results

ACTION은 두 가지 벤치마크 데이터셋(ACDC 및 LiTS)에서 기존 최첨단 준지도 학습 방법들과 비교하여 뛰어난 성능을 보였습니다.

* **ACDC 데이터셋 (레이블된 케이스 3개 또는 7개)**:
  * 레이블된 케이스가 3개인 설정에서 ACTION은 이전 최고 평균 Dice 점수 73.6%를 **87.5%로 대폭 향상**시켰으며, 이는 레이블된 케이스가 7개인 기존 SSL 방법들의 성능과 맞먹거나 이를 능가합니다.
  * 7개의 레이블된 케이스를 사용했을 때는 Dice 점수를 **89.7%**까지 끌어올려 최첨단 성능을 더욱 향상시켰습니다.
  * 특히 RV(우심실) 및 Myo(심근)와 같은 특정 클래스에서 89.8%와 86.7%의 Dice 점수를 기록하며 지도 학습 기준선에 필적하거나 더 우수한 성능을 보였습니다.
  * 시각화 결과, ACTION은 **더욱 선명하고 정확한 객체 경계**를 생성함을 입증했습니다.

* **LiTS 데이터셋 (레이블된 비율 5% 또는 10%)**:
  * 두 가지 레이블링 설정 모두에서 모든 최첨단 방법들을 **상당한 차이로 능가**했습니다.
  * 시각화 결과에서도 ACTION은 다른 SSL 방법들보다 **일관되게 선명하고 정확한 객체 경계**를 달성했습니다.

* **구성 요소별 기여도 (Ablation Study)**:
  * 무작위 샘플링된 이미지(RSI), Stage-ii(지역 대조 증류), Stage-iii(해부학적 대조 미세 조정) 등 ACTION의 각 구성 요소가 전체 성능 향상에 필수적으로 기여함을 확인했습니다.
  * 특히, Stage-iii의 $L_{anco}$ 손실과 비지도 학습 손실($L_{unsup}$)을 제거하면 성능이 저하되는 것을 통해 각각의 중요성을 입증했습니다.

* **데이터 증강 전략 (Ablation Study)**:
  * 교사 네트워크에 약한 증강을, 학생 네트워크에 강한 증강을 적용하는 전략("Strong-Weak" Augmentation)이 최적의 성능을 도출함을 확인했습니다.

## 🧠 Insights & Discussion

* **불균형 데이터 및 부정 샘플 처리**: ACTION은 의료 영상 데이터의 내재적인 클래스 불균형과 '모든 부정 샘플이 동일하지 않다'는 문제를 효과적으로 해결합니다. 소프트 레이블링, 다양한 샘플링 기법, 그리고 해부학적 대조 개념은 이러한 복잡한 도전 과제를 극복하는 데 핵심적인 역할을 합니다.
* **해부학적 특징 학습의 중요성**: AnCo 손실과 능동적 하드 샘플링은 특히 희귀 클래스와 어려운 경계 영역에서 모델의 식별력을 높여 흐릿한 경계를 개선하고 오분류를 줄입니다. 이는 실제 임상 데이터의 불확실성과 불균형을 다루는 데 필수적입니다.
* **효율성**: 최소한의 추가 메모리 요구 사항으로 최첨단 성능을 달성하여, 자원 제약이 있는 실제 의료 환경에서의 실용적인 적용 가능성을 높입니다.
* **한계 및 미래 연구**: 논문에서 명시적인 한계는 언급되지 않지만, 향후 연구로 비레이블되고 불균형한 의료 데이터에서 성능을 더욱 개선하기 위한 더 발전된 대조 학습 접근 방식을 탐색할 계획임을 밝혀, 현재 방법의 잠재적 개선 영역을 암시합니다.
* **의의**: ACTION은 제한된 레이블 하에서 고품질 의료 영상 분할을 위한 강력한 기준선(baseline)을 제시하며, 향후 의료 영상 분석 분야의 발전에 중요한 기여를 할 것으로 기대됩니다.

## 📌 TL;DR

의료 영상 분할의 레이블 부족 및 클래스 불균형 문제를 해결하기 위해, 본 논문은 **ACTION (Anatomical-aware ConTrastive dIstillatiON)** 프레임워크를 제안합니다. ACTION은 소프트 레이블링 기반의 반복적 대조 증류, 전역 및 지역 특징 학습, 그리고 능동적 하드 샘플링을 통한 해부학적 대조(AnCo 손실)를 핵심 구성 요소로 사용합니다. ACDC 및 LiTS 데이터셋에 대한 광범위한 실험을 통해, ACTION은 최소한의 추가 메모리만으로 기존 최첨단 준지도 학습 방법들을 크게 능가하는 **더욱 선명하고 정확한 분할 결과**를 달성하여, 불균형하고 레이블이 제한적인 의료 영상 환경에서 그 효용성을 강력하게 입증했습니다.
