# Curriculum Domain Adaptation for Semantic Segmentation of Urban Scenes

Yang Zhang, Philip David, and Boqing Gong

## 🧩 Problem to Solve

CNN 기반의 시맨틱 분할은 대량의 주석 데이터가 필요하지만, 데이터 수집 및 주석 작업이 어렵습니다. 포토리얼리스틱 합성 데이터를 사용하여 이 문제를 해결할 수 있으나, 합성(소스) 데이터와 실제(타겟) 데이터 간의 도메인 불일치(domain mismatch)로 인해 모델 성능이 크게 저하됩니다. 기존 도메인 적응(DA) 방법은 분류 및 회귀 문제에 주로 초점을 맞추며, 변환된 특징 공간에서 소스와 타겟 도메인이 동일한 예측 함수를 공유한다는 가정을 합니다. 그러나 시맨틱 분할과 같은 구조화된 예측 문제에서는 이러한 가정이 유효하지 않거나 검증하기 어렵고, 도메인 불일치를 해결하기 위한 "인스턴스"의 정의도 모호합니다. 본 논문은 도시 장면의 시맨틱 분할에서 이러한 도메인 불일치를 최소화하여, 합성 데이터로 훈련된 모델이 실제 데이터에서 잘 작동하도록 하는 것을 목표로 합니다.

## ✨ Key Contributions

- 도시 장면의 시맨틱 분할을 위한 **커리큘럼 방식의 도메인 적응** 접근법을 제안합니다.
- 도메인 불일치에 덜 민감한 **"쉬운 작업"**을 도입합니다: 타겟 이미지의 전역 레이블 분포와 랜드마크 슈퍼픽셀의 지역 레이블 분포를 추론하는 것입니다.
- 이러한 추론된 타겟 도메인 속성(레이블 분포)을 사용하여 **시맨틱 분할 네트워크("어려운 작업") 훈련을 정규화**하여, 네트워크 예측이 추론된 속성을 따르도록 유도합니다.
- 변환된 특징 공간에서 소스와 타겟 도메인이 동일한 예측 함수를 공유한다는 기존의 강력한 가정을 효과적으로 **회피**합니다.
- 네트워크 아키텍처나 중간 계층을 변경하지 않아 다양한 분할 네트워크에 쉽게 **적용 가능**합니다.
- 기존 접근 방식 및 베이스라인 대비 **상당한 성능 향상**을 달성했습니다.

## 📎 Related Works

- **일반 도메인 적응:** 훈련 및 테스트 데이터 간 불일치를 해결하는 데 중점을 둡니다. 분류 및 회귀 문제에 주로 사용되며, 선형 변환, 커널 방법, 그리고 도메인 불변 특징 추출을 위한 딥러닝 기법(예: [41, 43, 36, 18, 17])이 있습니다.
- **시맨틱 분할:** 이미지의 각 픽셀에 객체 레이블을 할당하는 작업입니다. 기존 방법 [52, 58] 외에, 최근에는 CNN 기반 방법 [10, 35, 64, 49, 3, 39]이 주를 이룹니다. 수동 주석의 높은 비용 때문에 약한 감독 학습 [44, 28, 42]을 활용하기도 합니다.
- **시맨틱 분할을 위한 도메인 적응:** 이 분야는 상대적으로 연구가 적습니다. 본 논문에서는 [27](Hoffman et al.의 "FCNs in the Wild")을 동일한 문제(합성-실제 도메인 적응)를 다룬 유일한 기존 시도로 언급하며, 이 방법은 픽셀 수준의 적대적 손실과 네트워크 출력 제약을 사용한다고 설명합니다.
- **합성 데이터 활용:** 합성 이미지를 활용하여 객체 탐지 [56, 63] 또는 시뮬레이션 이미지 품질 향상 [53, 45]에 대한 연구가 언급됩니다.

## 🛠️ Methodology

본 논문의 핵심 아이디어는 커리큘럼 방식의 학습 접근법으로, "쉬운 작업"을 통해 타겟 도메인의 속성을 먼저 추론한 다음, 이 속성을 사용하여 픽셀 단위 분할이라는 "어려운 작업"을 지도하는 것입니다.

- **목표 함수:**
  소스 도메인($S$)의 레이블링된 이미지와 타겟 도메인($T$)의 레이블링되지 않은 이미지를 포함하는 미니배치에 대해 전체 목적 함수는 다음과 같습니다.
  $$ \min*{\gamma} \frac{1}{|S|} \sum*{s \in S} \mathcal{L}(Y*s, \hat{Y}\_s) + \frac{1-\gamma}{|T|} \sum*{t \in T} \sum_k C(p_t^k, \hat{p}\_t^k) $$

  - 첫 번째 항: 레이블링된 소스 도메인 데이터에 대한 픽셀 단위 교차 엔트로피 손실($\mathcal{L}$)로, 네트워크의 판별 능력을 강화합니다.
  - 두 번째 항: 레이블링되지 않은 타겟 도메인 데이터에 대한 교차 엔트로피 손실($C$)로, 네트워크의 예측이 추론된 타겟 속성($p_t^k$)과 일치하도록 강제합니다. 여기서 $k$는 다양한 레이블 분포 유형을 나타냅니다.
  - $\gamma \in [0,1]$는 두 항의 중요도를 조절합니다.

- **"쉬운 작업": 타겟 속성($p_t^k$) 추론**
  타겟 레이블에 접근하지 않고 추정하며, 주로 레이블링된 소스 데이터로 모델을 훈련하거나 비모수적 방법을 사용합니다.

  - **이미지의 전역 레이블 분포:**
    - 전체 이미지에 대한 각 카테고리의 픽셀 비율을 추정합니다: $p_t(c) = \frac{1}{WH} \sum_{i=1}^W \sum_{j=1}^H Y_t(i,j,c)$.
    - 추정 방법으로 로지스틱 회귀(LR) 및 최근접 이웃(NNs)의 평균을 실험했으며, LR이 가장 우수한 성능을 보였습니다.
  - **랜드마크 슈퍼픽셀의 지역 레이블 분포:**
    - 전역 분포에서 부족한 공간적 제약을 제공합니다.
    - 이미지를 슈퍼픽셀로 분할(예: Linear Spectral Clustering [33]을 사용하여 100개).
    - 소스 슈퍼픽셀(FCN-8s 특징 및 문맥 정보 사용)로 다중 클래스 SVM을 훈련합니다.
    - 타겟 이미지의 경우, **가장 신뢰도가 높은 상위 60% 슈퍼픽셀**(랜드마크 슈퍼픽셀)만 사용합니다. 이들의 예측된 클래스 레이블(원-핫 벡터로 인코딩)이 해당 슈퍼픽셀의 레이블 분포로 사용됩니다. 이는 덜 정확한 예측으로 인한 과도한 정규화를 방지합니다.

- **"어려운 작업": 시맨틱 분할 네트워크 (FCN-8s)**
  - FCN-8s [35]를 기본 시맨틱 분할 네트워크로 사용하며, VGG-19 [54] 가중치로 초기화됩니다.
  - AdaDelta 최적화기 [67]를 사용하여 훈련됩니다.
  - 미니 배치는 소스(레이블링됨) 및 타겟(레이블링되지 않음) 이미지를 모두 포함합니다.
  - 손실 함수의 타겟 속성 항은 도메인 적응을 유도하기 위해 "타겟 도메인에서 발생하는 유용한 기울기"를 제공합니다.

## 📊 Results

- **데이터셋:** SYNTHIA [48] 및 GTA [47] (소스 도메인)에서 Cityscapes [12] (타겟 도메인)로의 적응을 실험했습니다. 평가는 두 데이터셋 간의 16개 또는 19개 공통 클래스에 대해 수행했습니다.
- **평가 지표:** PASCAL VOC IoU (Intersection-over-Union)를 사용했습니다.
- **전역 레이블 분포 추론 결과:**
  - 로지스틱 회귀(LR) 및 최근접 이웃(NN) 방법은 $\chi^2$ 거리(표 1)에서 베이스라인(NoAdapt, Uniform, Source Mean)보다 훨씬 우수한 성능을 보여 타겟 레이블 분포를 더 정확하게 추정했습니다. 이 중 LR이 가장 효과적이었습니다.
- **시맨틱 분할 성능 (SYNTHIA $\rightarrow$ Cityscapes):**
  - 제안된 모든 도메인 적응 결과(`Ours (I)`, `Ours (SP)`, `Ours (I+SP)`)는 적응 없는 베이스라인(`NoAdapt`)보다 현저히 뛰어난 성능을 보였습니다.
  - `Ours (I)`(이미지 수준 전역 분포만 사용)는 `NoAdapt` 대비 상당한 성능 향상을 보였으며, 도로와 보도에 대한 불균형한 예측과 같은 명백한 오류를 수정하는 데 기여했습니다.
  - `Ours (SP)`(랜드마크 슈퍼픽셀 분포만 사용)는 평균 IoU 28.1%를 달성하여 `NoAdapt` 및 개별 슈퍼픽셀 분류보다 우수했습니다.
  - **`Ours (I+SP)`(전역 및 지역 분포 결합)는 평균 IoU 29.0%로 최고의 시맨틱 분할 결과를 달성했으며, 전역 및 지역 단서의 상호보완적 특성을 입증했습니다.**
  - `FCN Wld` [27]과의 비교에서는, 본 연구의 방법이 상대적으로 더 큰 절대적 성능 향상을 보여 더 큰 효과를 입증했습니다.
  - 도메인 불변 특징 학습 방법(MMD [24] 또는 기울기 역전 [17] 사용)을 시도했으나, 시맨틱 분할에서는 눈에 띄는 성능 향상을 가져오지 못했습니다.
- **시맨틱 분할 성능 (GTA $\rightarrow$ Cityscapes):**
  - SYNTHIA $\rightarrow$ Cityscapes와 유사한 성능 향상 경향이 관찰되었습니다.
  - GTA 이미지가 SYNTHIA보다 더 포토리얼리스틱하기 때문에 전반적으로 더 나은 성능을 보였습니다. `Ours (I+SP)`가 다시 최고의 결과를 달성하여 접근 방식의 견고함을 입증했습니다.
- **정성적 관찰:** 베이스라인 네트워크는 종종 불균형한 예측을 생성했지만, 제안된 방법은 이를 수정했습니다. 슈퍼픽셀 기반 방법은 큰 객체(하늘, 도로, 건물)에는 강했지만 작은 객체(울타리, 신호등)에는 취약했으며, 이미지 수준 분포(`Ours (I)`)는 작은 객체에서 더 나은 성능을 보였습니다. 이들의 결합(`Ours (I+SP)`)은 이러한 상호보완적인 강점을 효과적으로 활용했습니다.

## 🧠 Insights & Discussion

- **커리큘럼 도메인 적응의 효과:** "쉬운 작업"(레이블 분포 추정)을 먼저 해결하여 타겟 도메인의 속성을 추론하는 커리큘럼 방식의 접근법은 픽셀 단위 분할이라는 "어려운 작업"을 효과적으로 지도합니다. 이는 네트워크가 타겟 도메인의 전체적인 특성을 먼저 학습하게 하여, 세부적인 픽셀 수준 예측의 정확도를 높이는 데 도움을 줍니다.
- **강력한 가정 회피:** 본 방법은 구조화된 예측에 종종 부적합한, 도메인 불변 특징 공간에서 예측 함수를 공유한다는 문제가 있는 기존의 강력한 가정을 성공적으로 회피합니다. 대신, 추론된 속성을 기반으로 한 사후 정규화(posterior regularization)를 사용하여 더 유연하고 효과적인 적응을 가능하게 합니다.
- **단서의 상호 보완성:** 전역 이미지 수준 레이블 분포와 지역 랜드마크 슈퍼픽셀 분포는 서로 다른 유형의 정보를 제공하며 상호 보완적입니다. 전역 단서는 전반적인 레이블 비례성과 특정 작은 객체에 대한 오류를 수정하는 데 도움이 되며, 지역 단서는 공간 제약과 크고 잘 정의된 영역에 대한 정확도를 높입니다. 두 정보의 조합이 최적의 성능을 이끌어냈습니다.
- **한계 및 향후 연구:** 특히 슈퍼픽셀 기반 방법에서 작은 객체에 대한 성능은 여전히 개선의 여지가 있습니다. 향후 연구에서는 추론하기 쉽고 성능을 더욱 향상시킬 수 있는 더 많은 "타겟 속성"(아마도 여전히 레이블 분포 형태)을 탐색하여, 특히 작은 객체에 대한 성능을 개선하고 커리큘럼 도메인 적응 프레임워크를 더욱 풍부하게 만들 계획입니다.

## 📌 TL;DR

- **문제:** 합성 데이터로 훈련된 시맨틱 분할 모델은 도메인 불일치로 인해 실제 도시 장면에서 성능이 저하되며, 기존 도메인 적응 방법은 구조화된 예측 작업에서 어려움을 겪습니다.
- **방법:** 커리큘럼 도메인 적응 접근법을 제안합니다. 이 방법은 먼저 "쉬운 작업"—레이블링되지 않은 타겟 도메인 이미지의 전역 레이블 분포와 랜드마크 슈퍼픽셀의 지역 레이블 분포를 추정하는 작업—을 수행합니다. 이렇게 추론된 속성들은 레이블링된 소스 데이터로 픽셀 단위 시맨틱 분할 네트워크를 훈련하는 데 후속 정규화(posterior regularization)로 작용합니다.
- **결과:** 제안된 방법은 합성 데이터에서 실제 도시 장면으로의 시맨틱 분할 성능을 크게 향상시키며, 종종 유효하지 않은 예측 함수 공유에 대한 강력한 가정을 하지 않고도 높은 수준의 타겟 도메인 지식을 효과적으로 활용하여 베이스라인 및 기존 방법을 능가합니다.
