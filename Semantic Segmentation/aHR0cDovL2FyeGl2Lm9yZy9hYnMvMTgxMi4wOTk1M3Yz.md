# 도시 경관의 의미론적 분할을 위한 커리큘럼 도메인 적응 접근 방식
Yang Zhang, Philip David, Hassan Foroosh, and Boqing Gong

## 🧩 해결할 문제

의미론적 분할(semantic segmentation)은 자율 주행 및 증강 현실과 같은 여러 응용 분야에서 핵심적인 컴퓨터 비전 과제입니다. 최근 몇 년간 합성 이미지와 컴퓨터 생성 주석을 활용하여 CNN(Convolutional Neural Networks)을 훈련하는 것이 가능해졌지만, 실제 이미지와 합성 데이터 간의 **도메인 불일치(domain mismatch)**는 모델 성능을 저해하는 주요 문제입니다. 이 논문은 이 도메인 격차를 최소화하여 도시 경관의 의미론적 분할 성능을 향상시키는 것을 목표로 합니다.

## ✨ 주요 기여

*   **커리큘럼 스타일 도메인 적응(Curriculum-style Domain Adaptation) 제안:** 쉬운 작업(타겟 도메인 이미지의 전역 레이블 분포 및 랜드마크 슈퍼픽셀의 지역 레이블 분포 추론)부터 시작하여 필요한 속성을 파악한 후, 이를 활용해 어려운 작업(픽셀 단위 분할 네트워크 학습)을 수행하는 접근 방식을 제안합니다.
*   **타겟 도메인 속성 기반 정규화:** 타겟 도메인에 대한 픽셀 단위 주석 없이도 이미지 및 슈퍼픽셀 수준의 추정된 레이블 분포를 활용하여 분할 네트워크의 예측을 정규화합니다. 이는 변환된 특징 공간에서 두 도메인이 동일한 예측 함수를 공유한다는 기존의 강한 가정을 회피합니다.
*   **색상 일관성(Color Constancy) 스킴 도입:** 독립적인 이미지 전처리 단계로 색상 보정 기법을 도입하여 도메인 적응 성능을 크게 향상시킵니다.
*   **광범위한 적용 가능성:** 네트워크 아키텍처나 중간 레이어를 변경하지 않고도 다양한 분할 네트워크에 쉽게 적용할 수 있음을 보여줍니다.
*   **합성 데이터의 "시장 가치" 정량적 분석:** 합성 데이터가 실제 이미지 라벨링 비용을 얼마나 절감할 수 있는지 정량적으로 분석하여 그 가치를 입증합니다.
*   **관련 연구와의 보완성 입증:** 제안된 방법이 이후 발표된 여러 도메인 적응 방법(특히 적대적 학습 기반 방법)들과 상호 보완적임을 실험적으로 보여줍니다.

## 📎 관련 연구

*   **도메인 적응(Domain Adaptation):** 훈련 및 테스트 데이터가 다른 분포에서 추출될 때 모델 성능을 향상시키는 기술. 초기 "얕은" 방법들은 데이터의 내재적 구조를 활용했으며, 최근 "깊은" 방법들은 새로운 손실 함수 또는 네트워크 아키텍처를 사용하여 도메인 불변 특징 학습에 집중했습니다. 특히 합성 데이터 활용 연구가 활발히 진행됩니다.
*   **의미론적 분할(Semantic Segmentation):** 이미지의 각 픽셀에 객체 레이블을 할당하는 작업. CNN 기반 방법(예: FCN)이 높은 성능을 달성했으며, Cityscapes, SYNTHIA, GTA와 같은 대규모 도시 경관 데이터셋이 활용됩니다.
*   **의미론적 분할을 위한 도메인 적응:** 본 연구 이전에는 Hoffman et al.의 FCNs in the wild [10]가 유사한 문제에 접근한 초기 시도 중 하나였습니다. 이후 많은 적대적 학습(adversarial training) 기반 방법들이 제안되어 도메인 불일치를 줄이는 데 활용되었습니다.

## 🛠️ 방법론

본 논문은 도메인 적응을 위해 **커리큘럼 학습(Curriculum Learning)** 방식을 도입합니다. 이는 의미론적 분할보다 도메인 불일치에 덜 민감한 '쉬운' 작업부터 시작하여 타겟 도메인의 속성을 파악한 후, 이를 활용하여 '어려운' 픽셀 단위 분할 작업을 수행하는 방식입니다.

1.  **'쉬운' 작업: 타겟 도메인 속성 추론**
    *   **전역 이미지 레이블 분포 추론:**
        *   각 이미지에서 특정 카테고리(예: 도로, 건물, 하늘)가 차지하는 픽셀의 비율을 나타내는 레이블 분포 $p_t(c)$를 추정합니다.
        *   이를 위해 레이블이 있는 소스 도메인 데이터를 사용하여 **로지스틱 회귀(Logistic Regression, LR)** 또는 **최근접 이웃(Nearest Neighbor, NN)의 평균**과 같은 모델을 훈련합니다. LR이 실험에서 가장 좋은 성능을 보였습니다.
        *   추정된 분포는 네트워크 예측 $\hat{Y}_t$를 기반으로 다음과 같이 계산됩니다:
            $$ \hat{p}_t(c) = \frac{1}{WH} \sum_{i=1}^{W} \sum_{j=1}^{H} \left( \frac{\hat{Y}_t(i,j,c)}{\max_{c'} (\hat{Y}_t(i,j,c'))} \right)^K, \forall c $$
            여기서 $K > 1$ (실험에서 $K=6$)은 소프트맥스 활성화를 "날카롭게" 만듭니다.
    *   **지역 랜드마크 슈퍼픽셀 레이블 분포 추론:**
        *   이미지를 슈퍼픽셀(예: 100개)로 분할하고, 소스 도메인의 슈퍼픽셀에 대해 지배적인 레이블을 사용하여 다중 클래스 SVM을 훈련합니다.
        *   타겟 도메인의 슈퍼픽셀에 대해 SVM의 분류 결과와 신뢰도 점수를 얻어, 가장 신뢰도 높은 상위 30%의 슈퍼픽셀을 '랜드마크'로 선정합니다.
        *   선정된 랜드마크 슈퍼픽셀의 분류 레이블을 원-핫 벡터로 인코딩하여 유효한 지역 레이블 분포로 사용합니다.
        *   슈퍼픽셀 특징은 PASCAL CONTEXT로 사전 훈련된 FCN-8s의 특징을 활용하며, 수제 특징(BOW, FV) 및 VGG 특징도 비교 평가합니다.

2.  **'어려운' 작업: 의미론적 분할 네트워크 학습**
    *   최종 분할 네트워크는 레이블이 있는 소스 도메인에 대한 픽셀 단위 교차 엔트로피 손실 $L(Y_s, \hat{Y}_s)$과, 레이블이 없는 타겟 도메인에 대한 추정된 속성 분포 $p_t^k$와 네트워크 예측 $\hat{p}_t^k$ 간의 교차 엔트로피 손실 $C(p_t^k, \hat{p}_t^k)$을 동시에 최소화하도록 훈련됩니다.
    *   전체 목적 함수는 다음과 같습니다:
        $$ \min_{\gamma} \frac{\gamma}{|S|} \sum_{s \in S} L(Y_s, \hat{Y}_s) + \frac{1-\gamma}{|T|} \sum_{t \in T} \sum_k C(p^k_t, \hat{p}^k_t) $$
        여기서 $\gamma \in [0,1]$는 두 손실 항의 균형을 조절합니다.

3.  **색상 일관성(Color Constancy) 전처리:**
    *   도메인 간의 조명 조건 차이로 인한 색상 불일치를 줄이기 위해, 타겟 도메인 이미지의 색상을 소스 도메인의 색상 분포에 맞게 보정하는 Gamut-based 색상 일관성 방법 [82]을 전처리 단계로 적용합니다.

## 📊 결과

*   **도메인 적응의 유효성:** 제안된 커리큘럼 도메인 적응 방법(특히 Ours (CC+I+SP))은 SYNTHIA to Cityscapes 및 GTA to Cityscapes 적응 시나리오 모두에서 기준선("적응 없음", NoAdapt)보다 7% 이상 높은 mIoU (mean Intersection-over-Union) 성능 향상을 달성했습니다.
    *   FCN-8s 모델, SYNTHIA2Cityscapes: NoAdapt 22.0% $\rightarrow$ Ours (CC+I+SP) 29.7%
    *   FCN-8s 모델, GTA2Cityscapes: NoAdapt 22.3% $\rightarrow$ Ours (CC+I+SP) 31.4%
*   **구성 요소의 효과:** 전역 이미지 레이블 분포(Ours (I))와 지역 랜드마크 슈퍼픽셀 분포(Ours (SP))는 개별적으로도 성능 향상에 기여하며, 이들을 결합(Ours (I+SP))했을 때 최상의 결과를 보였습니다. 전역 분포는 작은 객체에, 지역 분포는 큰 객체에 강점을 보여 서로 보완적임을 시사합니다.
*   **색상 일관성의 중요성:** 색상 일관성(CC) 전처리를 적용했을 때, 모든 적응 방법의 성능이 일관되게 향상되어, 도메인 불일치에 대한 색상 요인의 중요성을 확인했습니다.
*   **슈퍼픽셀의 과립도 및 특징:** 이미지당 300개의 슈퍼픽셀이 최적의 과립도를 보였으며, PASCAL CONTEXT 특징보다 ImageNet으로 사전 훈련된 VGG 특징이 슈퍼픽셀 분류 정확도를 높여 최종 적응 성능을 소폭 향상시켰습니다.
*   **최신 네트워크 적용:** FCN-8s뿐만 아니라 더 강력한 ADEMXAPP 백본 네트워크에서도 제안된 방법이 유의미한 성능 향상(GTA2Cityscapes에서 ADEMXAPP (CC) 30.0% $\rightarrow$ ADEMXAPP (CC+I+SP) 35.7%)을 보였습니다.
*   **합성 데이터의 가치:** Cityscapes 훈련 세트에 단 5개의 레이블된 이미지만 추가해도 SYNTHIA만으로 훈련한 결과(22.0%)를 33.8%로 크게 향상시켰습니다. SYNTHIA 훈련 세트는 최소 450개의 잘 라벨링된 실제 이미지와 동일한 "시장 가치"를 가집니다.
*   **클래스 간 혼동:** "전봇대", "교통 표지판" 등 작은 객체는 "건물"로 자주 오분류되었고, "기차"와 "버스"는 데이터셋 자체의 시각적 유사성으로 인해 혼동이 빈번했습니다.
*   **다른 방법과의 보완성:** 본 논문의 "Curriculum" 방법은 기존의 적대적 학습 기반 방법들과 상호 보완적 관계를 가집니다. 늦은 융합(late fusion)을 통해 단일 방법보다 더 높은 mIoU를 달성할 수 있음을 입증했습니다(예: CYCADA와 Ours의 융합으로 GTA2Cityscapes에서 34.3% mIoU 달성).

## 🧠 통찰 및 논의

*   **사후 정규화의 중요성:** 이 연구는 도메인 불변 특징을 학습하는 대신, 타겟 도메인의 "쉬운" 속성(레이블 분포)을 추론하고 이를 분할 네트워크의 예측에 대한 "사후 정규화(posterior regularization)"로 활용함으로써 효과적인 도메인 적응을 달성했습니다. 이는 모델이 타겟 도메인에서 가져야 할 바람직한 구조적 특성을 직접적으로 인코딩할 수 있게 합니다.
*   **실용적인 이점:** 제안된 접근 방식은 기존의 딥러닝 프레임워크와 네트워크 아키텍처에 최소한의 변경으로 통합될 수 있어, 다른 분할 네트워크에도 쉽게 적용 가능합니다.
*   **한계 및 향후 연구:** 작은 객체와 배경 클래스 간의 지속적인 혼동(예: 전봇대-건물, 기차-버스)은 데이터셋 자체의 특성이나 복잡한 클래스 간 관계 때문일 수 있습니다. 이를 해결하기 위해서는 더 많은 레이블된 실제 데이터 또는 시뮬레이션 환경에서의 정교한 데이터 생성이 필요합니다. 또한, 전역 및 지역 레이블 분포 외에 픽셀 단위 레이블 예측의 함수로 표현될 수 있는 다른 유용한 타겟 속성을 탐색하고, DeepGTAV, AirSim과 같은 가상 자율 주행 환경에 직접 프레임워크를 적용하는 연구가 가능할 것입니다.

## 📌 TL;DR

도시 경관의 의미론적 분할에서 실제 데이터 라벨링의 높은 비용과 합성-실제 데이터 간의 도메인 불일치를 해결하기 위해, 본 논문은 **커리큘럼 도메인 적응** 방법을 제안합니다. 이 방법은 타겟 도메인의 이미지 전역 및 랜드마크 슈퍼픽셀 지역 **레이블 분포**와 같은 "쉬운" 속성을 먼저 추론한 후, 이를 픽셀 단위 분할 네트워크 학습의 정규화 항으로 활용합니다. 또한, **색상 일관성 전처리**를 도입하여 성능을 더욱 향상시킵니다. 실험 결과는 제안된 방법이 기준선을 크게 능가하며, 기존 도메인 적응 방법들과 상호 보완적임을 보여줍니다. 이는 합성 데이터가 실제 데이터 라벨링 비용을 크게 절감할 수 있는 가치를 가짐을 시사합니다.