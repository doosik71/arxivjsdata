# S-SAM: SVD-based Fine-Tuning of Segment Anything Model for Medical Image Segmentation

Jay N. Paranjape, Shameema Sikder, S. Swaroop Vedula, and Vishal M. Patel

## 🧩 Problem to Solve

기존의 의료 영상 분할 모델은 새로운 모달리티나 데이터셋에 맞추기 위해 전체 모델을 훈련하거나 미세 조정해야 하며, 이 과정에서 많은 수의 매개변수를 조정해야 합니다. 자연 영상 분할을 위해 출시된 Segment Anything Model (SAM)은 의료 영상에 잘 일반화되지 않습니다. 현재 SAM을 의료 영상에 효율적으로 적용하려는 시도들은 많지만, 이 방법들은 여전히 훈련 및 추론 시 각 이미지에 대해 전문가가 점 또는 경계 상자 프롬프트를 제공해야 하므로 실제 적용이 번거롭습니다. 일부 방법은 전문가 프롬프트의 필요성을 제거하지만, SAM의 프롬프트 가능성을 잃습니다.

## ✨ Key Contributions

* **새로운 SAM 적응 기법 제안 (S-SAM):** 의료 영상을 위한 텍스트 프롬프트 기반 분할을 수행하며, 클래스 이름을 단순 프롬프트로 사용하여 전문가 수준의 프롬프트 요구 사항을 제거합니다.
* **높은 효율성:** S-SAM은 SAM 매개변수의 0.4%에 해당하는 매우 적은 수의 매개변수만 학습하여 기존 적응 방법보다 훨씬 효율적입니다.
* **최첨단 성능 달성:** 내시경 영상, X-ray, 초음파, CT, 조직 영상 등 5가지 다양한 모달리티의 공개 데이터셋에서 최첨단(SOTA) 성능을 달성했습니다.

## 📎 Related Works

의료 영상 분야에서 SAM의 성능을 활용하기 위한 여러 연구가 진행되었습니다.

* **MedSAM [19]:** 대규모 의료 영상 코퍼스에 대해 SAM의 모든 매개변수를 미세 조정했습니다.
* **Medical SAM Adapter [33]:** SAM의 인코더 및 디코더 블록에 학습 가능한 어댑터 레이어를 도입하여 계산 요구 사항을 줄였습니다.
* **SonoSAM [24] 및 SAMUS [18]:** 각각 초음파 영상에 특화된 SAM 적응 방법으로, 특정 모듈을 조정하거나 추가 CNN 인코더를 융합합니다.
이들 초기 적응 방법은 여전히 훈련 및 테스트 시 전문가가 수동으로 프롬프트를 제공해야 합니다.
전문가 개입을 최소화하려는 노력도 있었습니다.
* **SAMed [35] 및 AutoSAM [26]:** 사용자 정의 프롬프트를 기본 프롬프트 또는 이미지 자체로 대체하여 전문가 개입을 줄였으나, SAM의 프롬프트 가능성을 잃었습니다.
* **AdaptiveSAM [21]:** 텍스트 프롬프트 기반 분할을 도입하여 레이블 이름을 프롬프트로 사용할 수 있게 했습니다. 인코더 네트워크의 바이어스를 조정하고 디코더를 완전히 학습 가능하게 했습니다.
본 연구는 AdaptiveSAM과 유사하게 텍스트 프롬프트를 사용하면서도, 마스크 디코더 튜닝을 요구하지 않아 더 효율적입니다.

## 🛠️ Methodology

S-SAM은 SAM의 이미지 인코더에서 가중치 행렬의 특이값(singular value)을 미세 조정하는 방식을 사용합니다.

1. **SVD 기반 튜닝:**
    * SAM 이미지 인코더 내의 각 가중치 행렬 $W$에 대해 특이값 분해(SVD)를 수행합니다: $W = U\Sigma V^T$.
    * 학습 중에는 $W$를 다음과 같이 변환합니다:
        $$W \leftarrow U \text{ReLU}(A \odot \Sigma + B) V^T$$
        여기서 $A$와 $B$는 $\Sigma$와 동일한 형태를 가지며 비대각 성분이 0인 행렬입니다. $A$는 특이값의 스케일링을, $B$는 특이값의 시프팅을 나타냅니다. ReLU 함수는 $\Sigma$ 행렬의 양의 준정부호(positive semidefinite) 특성을 유지합니다.
    * 이 접근 방식은 LoRA(Low-Rank Adaptation)와 달리 모든 특이값을 조정하여 풀 랭크(full-rank) 연산을 수행하므로, 학습된 부분 공간이 필요한 크기보다 작아 언더피팅이 발생하는 문제를 피합니다. S-SAM의 학습 가능한 매개변수 수는 $2 \times \min(D, K)$ (LoRA의 $r(D+K)$보다 적음)로 LoRA보다 효율적입니다.

2. **S-SAM 아키텍처:**
    * **이미지 인코더:** SAM의 기존 이미지 인코더를 사용하되, 위에서 설명한 SVD 기반 튜닝을 통해 가중치를 수정합니다. 이미지 임베딩을 출력합니다.
    * **텍스트 어파인 레이어(Text Affine Layer, TAL):** CLIP 임베딩을 통해 얻은 텍스트 프롬프트 임베딩을 TAL(학습 가능한 1-레이어 MLP)에 통과시켜 프롬프트 인코더에 전달하기 전에 의료 레이블에 맞게 조정합니다.
    * **프롬프트 인코더 및 마스크 디코더:** SAM의 사전 학습된 체크포인트로 초기화하며, 훈련 중에는 **완전히 고정**됩니다.
    * **학습 가능한 매개변수:** 이미지 인코더의 특이값 변환 파라미터 $A$와 $B$, 인코더의 positional embedding, layernorm 레이어, 그리고 TAL만 학습됩니다. 특히 positional embedding은 SAM의 고정된 $1024 \times 1024$ 크기 요구사항을 극복하기 위해 더 낮은 해상도에서도 학습 가능하도록 변경되고, SAM의 체크포인트로부터 평균 풀링하여 초기화됩니다.

## 📊 Results

S-SAM은 5가지 의료 영상 데이터셋(CholecSeg8k, 복부 초음파, ChestXDet, LiTS, GLAS)에서 평가되었습니다. Blank mask(관심 레이블이 이미지에 없을 때의 예측)도 유효한 예측으로 간주하여 Rahman et al. [23]의 Dice Score (DSC) 정의를 사용했습니다.

* **정량적 결과:**
  * CholecSeg8k, 초음파, GLAS 데이터셋에서 기존 최첨단 방법 대비 평균 6-7%의 성능 향상을 달성했습니다.
  * LiTS 및 ChestXDet 데이터셋에서는 1%의 개선을 보였습니다.
  * S-SAM은 SAM 대비 99.6%, AdaptiveSAM 대비 90%, LoRA 대비 50% 적은 학습 가능한 매개변수를 사용하면서도 이와 같거나 더 뛰어난 성능을 달성했습니다.
  * S-SAM의 모든 결과는 통계적으로 유의미합니다 ($p \le 10^{-8}$).
  * Zero-shot SAM(텍스트 프롬프트 또는 포인트 프롬프트)은 의료 영상에서 저조한 성능을 보였고, SAM의 전체 미세 조정은 데이터에 과적합되는 경향을 보였습니다.
* **정성적 결과:**
  * S-SAM은 Adaptive SAM이나 기존 SAM이 놓쳤던 GI Tract와 같은 작은 객체도 정확하게 분할할 수 있었습니다.
  * 쿼리된 관심 객체가 없을 때 빈 마스크를 정확하게 생성하는 능력도 보여주었습니다.
* **요소별 분석(Ablation Study):**
  * layernorm 레이어 튜닝이 DSC를 약 46% 향상시켜 도메인 적응에 중요함을 입증했습니다.
  * TAL 추가는 성능을 더 향상시켰습니다.
  * 특이값 시프팅($B$)과 스케일링($A$) 모두 성능을 향상시켰으며, 시프팅이 도메인 시프트를 모델링하는 데 더 중요했습니다(12% 향상). 모든 구성 요소를 함께 사용할 때 최상의 성능을 보였습니다.

## 🧠 Insights & Discussion

S-SAM은 SAM의 강력한 기능과 의료 영상 도메인 특유의 요구사항을 효율적으로 결합한 효과적인 적응 방법입니다. 가중치 행렬의 특이값을 미세 조정하는 독창적인 접근 방식은 극히 적은 매개변수만으로도 우수한 성능을 달성하게 합니다. 이는 기존의 프롬프트 기반 적응 방식이 가지고 있던 전문가 개입의 부담을 크게 줄이면서도, SAM의 핵심적인 프롬프트 가능 특성을 유지한다는 점에서 실용적인 가치가 높습니다. 또한, 모델의 특정 구성 요소(layernorm, TAL, 특이값 시프트/스케일링)가 도메인 적응과 성능 향상에 미치는 영향을 명확히 보여주었습니다.

제한점으로는, 클래스 크기 불균형에 따라 성능이 영향을 받을 수 있다는 점이 언급되었습니다. 이는 향후 연구에서 추가 손실 함수나 가중 손실 함수를 사용하여 개선될 수 있는 부분입니다.

## 📌 TL;DR

의료 영상 분할을 위한 SAM의 비효율적인 미세 조정 및 전문가 프롬프트 의존성 문제를 해결하기 위해, 본 논문은 SAM 매개변수의 0.4%만 학습하는 효율적인 S-SAM을 제안합니다. S-SAM은 SAM의 이미지 인코더에서 가중치 행렬의 특이값을 텍스트 프롬프트에 맞춰 조정하여, 레이블 이름을 단순 프롬프트로 사용하면서도 다양한 의료 영상 모달리티에서 최첨단 성능을 달성합니다. 이는 계산 효율성과 실용성 면에서 기존 방법을 크게 능가합니다.
