# Semi-supervised Medical Image Segmentation through Dual-task Consistency

Xiangde Luo, Jieneng Chen, Tao Song, Yinan Chen, Guotai Wang, Shaoting Zhang

## 🧩 Problem to Solve

의료 영상 분할(Medical Image Segmentation)은 진단 및 치료 계획에 필수적이지만, 픽셀 단위의 정확한 어노테이션(주석)을 생성하는 데에는 전문가의 시간과 비용이 많이 소요됩니다. 특히 3D 영상의 경우 더욱 그렇습니다. 기존의 준지도 학습(Semi-supervised Learning, SSL) 알고리즘은 주로 네트워크나 데이터에 미세한 교란(perturbation)을 가하여 모델 훈련을 정규화하는 방식에 의존했습니다. 이 연구는 이러한 암묵적인 교란 기반 방식 대신, 명시적으로 `태스크 수준(task-level)의 정규화`를 구축하여 SSL의 성능을 향상시킬 수 있는지에 대한 질문을 던집니다.

## ✨ Key Contributions

* **새로운 듀얼 태스크 일관성 준지도 프레임워크 제안**: 픽셀 단위 분할 맵 예측과 기하학적 레벨 셋 표현 회귀라는 두 가지 태스크를 결합한 모델을 최초로 제안했습니다.
* **미분 가능한 태스크 변환 레이어 도입**: 레벨 셋 표현을 근사화된 분할 맵으로 변환하여 두 태스크 간의 일관성을 계산할 수 있게 합니다.
* **듀얼 태스크 일관성 정규화 설계**: 레이블링된 데이터와 레이블링되지 않은 데이터 모두에 대해 레벨 셋에서 파생된 분할 맵과 직접 예측된 분할 맵 간의 일관성 손실($L_{DTC}$)을 적용합니다.
* **최첨단 성능 달성**: 두 가지 공개 의료 영상 데이터셋(좌심방 MRI, 췌장 CT)에서 기존의 최첨단 준지도 학습 방법들을 능가하는 분할 정확도를 보였습니다.
* **효율성 증명**: 기존 방법론에 비해 더 적은 훈련 시간과 계산 비용으로 뛰어난 성능을 달성했으며, 단일 추론(inference) 패스만으로 일관성 손실을 계산합니다.
* **높은 확장성**: 제안된 프레임워크는 모든 준지도 의료 영상 분할 시나리오에 직접 적용 가능하며, 미분 가능한 변환이 존재하는 한 에지 추출 또는 키포인트 추정 등 추가적인 태스크로 쉽게 확장될 수 있습니다.

## 📎 Related Works

* **준지도 의료 영상 분할(Semi-Supervised Medical Image Segmentation)**
  * **전통적 방법**: 수작업 특징 기반 모델(예: 사전(prior)-기반, 클러스터링-기반)은 일반화 능력과 견고성에 한계가 있었습니다.
  * **딥러닝 기반**:
    * 반복적 의사 레이블(pseudo-label) 생성 (Bai et al. 2017).
    * 적대적 학습(adversarial learning)을 통한 비레이블 데이터 활용 (Zhang et al. 2017, Nie et al. 2018, Li, Zhang, and He 2020 - SASSNet).
    * 평균 교사(Mean Teacher) 모델 (Tarvainen and Valpola 2017, Yu et al. 2019 - UA-MT).
* **일관성 정규화(Consistency Regularization)**
  * **데이터/네트워크 교란 기반**: 동일 데이터에 다른 변환/교란을 가하여 예측 일관성을 강제 (Sajjadi et al. 2016, Li et al. 2020, Ouali et al. 2020 - CCT). 이러한 방법들은 종종 여러 번의 포워드 패스를 필요로 하여 계산 비용이 증가합니다.
  * **태스크 일관성**: Zamir et al. (2020)이 추론 경로 불변성(inference-path invariance)을 기반으로 태스크 간 일관성을 활용했으나, 주로 완전 지도 학습이나 저수준 비전 태스크에 국한되었습니다.
  * 본 연구는 기존 방법들과 달리, 네트워크의 두 가지 태스크(픽셀 분류와 레벨 셋 회귀) 사이의 명시적인 일관성을 최소화하여 비레이블 데이터를 활용하며, 이를 위해 단 한 번의 추론만 필요로 합니다.

## 🛠️ Methodology

제안하는 듀얼 태스크 일관성(Dual-task Consistency, DTC) 프레임워크는 크게 세 부분으로 구성됩니다. 전체 구조는 VNet과 같은 인코더-디코더 네트워크를 백본으로 사용합니다.

1. **듀얼 태스크 분할 네트워크**:
    * 입력 3D 의료 영상에 대해 두 가지 다른 표현을 동시에 예측합니다.
        * **태스크 1 (픽셀 단위 분류 헤드)**: 픽셀 단위의 분할 확률 맵을 예측합니다.
        * **태스크 2 (레벨 셋 함수 회귀 헤드)**: 대상의 기하학적 형태를 포착하는 레벨 셋 함수(Level Set Function, LSF)를 예측합니다. 여기서 레벨 셋의 영점(zero level set)이 분할 경계선이 됩니다.
        * LSF는 다음과 같이 정의됩니다:
            $$ T(x) = \begin{cases} -\inf_{y \in \partial S} \|x-y\|_2, & x \in S_{in} \\ 0, & x \in \partial S \\ +\inf_{y \in \partial S} \|x-y\|_2, & x \in S_{out} \end{cases} $$
            여기서 $S_{in}$과 $S_{out}$은 객체의 내부 및 외부 영역을, $\partial S$는 경계선을 나타냅니다.

2. **미분 가능한 태스크 변환 레이어**:
    * 태스크 2의 출력인 레벨 셋 함수를 태스크 1의 출력 공간과 동일한 픽셀 단위의 분할 확률 맵으로 변환하기 위해, 미분 가능한 스무스 헤비사이드(smooth Heaviside) 함수를 사용합니다. 이는 Sigmoid 함수에 상수 $k$를 곱한 형태로 구현됩니다.
        $$ T^{-1}(z) = \frac{1}{1 + e^{-k \cdot z}} = \sigma(k \cdot z) $$
        이 변환을 통해 두 태스크의 예측 맵 간 일관성 측정이 가능해집니다.

3. **결합 손실 함수(Combination Loss Function)**:
    * **지도 학습 손실 (레이블링된 데이터 $D_l$에만 적용)**:
        * **분할 손실 ($L_{Seg}$)**: 픽셀 단위 예측을 위한 Dice Loss를 사용합니다.
        $$ L_{Seg}(x,y) = \sum_{x_i,y_i \in D_l} \left(1 - \frac{2 \sum f_1(x_i)y_i}{\sum f_1(x_i) + \sum y_i}\right) $$
        * **LSF 손실 ($L_{LSF}$)**: 예측된 LSF 맵 $f_2(x)$와 그라운드 트루스 LSF 맵 $T(y)$ (자동 생성됨) 간의 $L_2$ 손실을 사용합니다.
        $$ L_{LSF}(x,y) = \sum_{x_i,y_i \in D_l} \|f_2(x_i) - T(y_i)\|^2 $$
    * **듀얼 태스크 일관성 손실 ($L_{DTC}$, 레이블링된 $D_l$ 및 비레이블링된 $D_u$ 데이터 모두에 적용)**:
        * 태스크 1의 예측 $f_1(x_i)$과 태스크 2의 변환된 예측 $T^{-1}(f_2(x_i))$ 간의 $L_2$ 손실을 최소화합니다.
        $$ L_{DTC}(x) = \sum_{x_i \in D} \|f_1(x_i) - T^{-1}(f_2(x_i))\|^2 = \sum_{x_i \in D} \|f_1(x_i) - \sigma(k \cdot f_2(x_i))\|^2 $$
    * **총 손실**:
        $$ L_{total} = L_{Seg} + L_{LSF} + \lambda_d L_{DTC} $$
        여기서 $\lambda_d$는 훈련 스텝에 따라 가중치를 조절하는 가우시안 웜업(Gaussian warming-up) 함수입니다.

## 📊 Results

* **데이터셋**: 좌심방 MRI (100개 3D 이미지), 췌장 CT (82개 CT 이미지)를 사용했습니다. 일반적으로 20%의 레이블링된 데이터와 80%의 비레이블링된 데이터를 사용한 준지도 학습 설정에서 실험을 진행했습니다.
* **평가 지표**: Dice, Jaccard, 평균 표면 거리(Average Surface Distance, ASD), 95% Hausdorff 거리(95HD)를 사용했습니다.
* **듀얼 태스크 일관성의 효과 (표 1, 그림 2)**:
  * 단일 태스크(Seg, LSF)보다 듀얼 태스크(Seg + LSF)가 성능이 향상되었습니다.
  * 제안된 듀얼 태스크 일관성(Seg + LSF + DTC)은 완전 지도 학습 설정에서도 단일 또는 결합된 듀얼 태스크 학습보다 일관되게 우수한 성능을 보였습니다. 이는 일관성 정규화가 모델의 일반화 능력을 향상시킴을 입증합니다.
* **준지도 학습 효율성 (그림 4)**:
  * 제안된 준지도 학습 방법은 레이블링된 데이터만 사용한 완전 지도 학습 VNet 및 듀얼 태스크 VNet보다 지속적으로 우수한 성능을 나타냈습니다. 이는 비레이블 데이터를 효과적으로 활용했음을 보여줍니다.
  * 레이블링된 데이터 수가 적을수록 성능 향상 폭이 더 컸으며, 이는 적은 레이블 데이터 상황에서 제안 방법의 높은 잠재력을 시사합니다.
* **다른 최첨단 준지도 방법과의 비교 (표 2, 3, 그림 3)**:
  * Pancreas CT 및 Left Atrium MRI 두 데이터셋 모두에서 DAN, Entropy Mini, CCT, MT, UA-MT, SASSNet 등 기존의 최첨단 준지도 분할 방법들보다 모든 평가 지표에서 우수한 성능을 달성했습니다.
  * 특히 ASD 및 95HD에서 더 나은 결과를 보여, 더 정확한 경계와 형태를 예측함을 입증했습니다.
  * 복잡한 다중 네트워크 구조나 반복적인 업데이트 방식 없이도 최고 성능을 달성했으며, 기존 방법들보다 더 적은 훈련 시간과 계산 비용을 요구하는 등 효율성 측면에서도 뛰어남을 보였습니다.

## 🧠 Insights & Discussion

* 이 연구는 `태스크 수준의 일관성 정규화`가 준지도 의료 영상 분할에 매우 효과적임을 입증했습니다. 픽셀 단위 분류와 레벨 셋 표현을 통한 전역적(global-level) 형태 및 기하학적 정보 통합이 강력한 시너지를 발휘합니다.
* 제안된 프레임워크는 비레이블 데이터를 효율적으로 활용하여 분할 정확도와 견고성을 향상시킵니다. 또한, 단일 추론 패스만으로 일관성 손실을 계산하므로 계산 비용과 훈련 시간이 크게 절감됩니다.
* 단일 클래스 분할에 초점을 맞추었지만, 다중 클래스 분할로의 확장이 용이하며, 미분 가능한 변환이 있는 한 에지 추출, 키포인트 추정 등 다른 컴퓨터 비전 태스크에도 적용 가능성이 높습니다.
* 이 연구는 컴퓨터 비전 커뮤니티 전반에 걸쳐 태스크 일관성 기반의 준지도 학습 방법을 다양한 응용 분야(예: 투 스트림 비디오 인식, 멀티태스크 이미지 재구성)에 확장하여 비레이블 데이터 활용의 새로운 가능성을 제시할 수 있습니다.

## 📌 TL;DR

의료 영상 분할의 비싼 어노테이션 비용 문제를 해결하기 위해, 이 연구는 `듀얼 태스크 일관성(DTC)`이라는 새로운 준지도 학습 프레임워크를 제안합니다. 이 프레임워크는 픽셀 단위 분할과 기하학적 레벨 셋 회귀라는 두 가지 태스크를 동시에 수행하며, 미분 가능한 변환 레이어를 통해 두 태스크의 예측 결과 간 일관성을 비레이블 데이터에 대해서도 강제합니다. 그 결과, 기존 최첨단 준지도 방법보다 적은 레이블 데이터로도 더 높은 분할 정확도를 달성하며, 계산 효율성까지 뛰어남을 입증했습니다.
