# SAM-Med2D
Junlong Cheng, Jin Ye, Zhongying Deng, Jianpin Chen, Tianbin Li, Haoyu Wang, Yanzhou Su, Ziyan Huang, Jilong Chen, Lei Jiang, Hui Sun, Junjun He, Shaoting Zhang, Min Zhu, Yu Qiao

## 🧩 Problem to Solve
Segment Anything Model (SAM)은 자연 영상 분할에서 뛰어난 성능을 보이지만, 자연 영상과 의료 영상 간의 상당한 도메인 격차로 인해 의료 영상에 직접 적용했을 때 만족스러운 결과를 얻지 못합니다. 의료 영상은 다양한 모달리티, 복잡한 해부학적 구조, 그리고 제한적인 주석 데이터와 같은 고유한 특성을 가지므로, 기존의 SAM 기반 미세 조정 방법들은 특정 시나리오나 프롬프트 유형에만 국한되어 일반화 및 적응성이 부족했습니다. 따라서 의료 2D 영상에 SAM을 효과적으로 적용하고 그 성능을 종합적으로 평가하기 위한 포괄적인 연구가 필요합니다.

## ✨ Key Contributions
*   **대규모 의료 영상 분할 데이터셋 구축:** 공개 및 비공개 데이터셋에서 약 460만 장의 영상과 1,970만 개의 마스크를 수집 및 큐레이션하여 다양한 모달리티와 객체를 포괄하는 최대 규모의 의료 영상 분할 데이터셋을 구축했습니다.
*   **포괄적인 SAM 미세 조정 전략:** SAM의 인코더(어댑터 계층 사용)와 디코더를 모두 미세 조정하여 SAM-Med2D를 개발했습니다. 기존 방법들이 바운딩 박스 또는 점 프롬프트에만 초점을 맞춘 것과 달리, 바운딩 박스, 점, 마스크를 포함한 더 포괄적인 프롬프트 모드를 지원하도록 적응시켰습니다.
*   **종합적인 성능 평가:** 다양한 모달리티, 해부학적 구조, 장기에 걸쳐 SAM-Med2D의 성능을 평가하고 분석했습니다. 또한, MICCAI 2023 챌린지의 9개 데이터셋을 통해 일반화 능력을 검증했습니다.
*   **우수한 성능 및 일반화 능력 입증:** SAM-Med2D는 SAM에 비해 의료 영상 분할에서 현저히 우수한 성능과 일반화 능력을 입증했습니다.

## 📎 Related Works
*   **대규모 시각 모델(Large-scale Vision Models, LVM):** ChatGPT, ERNIE Bot, DINO, SegGPT, SAM, CLIP, DALL·E, SEEM과 같은 대규모 모델들이 제로샷 및 Few-샷 일반화 능력을 보여주며 다양한 태스크에 적용되고 있습니다. 특히 SAM은 대규모 마스크 데이터(1B개)로 사전 학습되어 범용적인 영상 분할 LVM으로 주목받습니다.
*   **의료 영상 분석에서의 SAM 미세 조정:** SAM-U [16], SAMed [17], AutoSAM [18], MedSAM [20], MSA [21] 등 여러 연구가 SAM을 의료 영상 분할에 적용하기 위해 미세 조정했지만, 대부분 특정 데이터셋이나 제한적인 프롬프트 모드에만 초점을 맞췄습니다. 본 연구는 이들과 달리 더 포괄적인 프롬프트 모드를 지원합니다.
*   **의료 영상에서의 SAM 제로샷 평가:** Deng et al. [27], Hu et al. [28], Zhou et al. [12], Cheng et al. [29], Huang et al. [15] 등은 SAM의 제로샷 성능을 의료 영상에 대해 평가했으며, 대부분의 연구에서 도메인 격차로 인해 만족스럽지 못한 결과를 보였습니다.

## 🛠️ Methodology
1.  **의료 지식 통합을 위한 데이터셋 구축:**
    *   총 460만 장의 영상과 1,970만 개의 마스크를 포함하는 대규모 의료 영상 분할 데이터셋을 수집했습니다. 이는 10가지 모달리티 (CT, MR, X-ray 등)와 31개 주요 장기 및 해부학적 구조, 병변을 포함합니다.
    *   **데이터 전처리:** 3D 데이터는 모든 슬라이스 이미지를 $x, y, z$ 축을 따라 추출하고 픽셀 값을 $[0, 255]$ 범위로 정규화했습니다. 2D 데이터는 픽셀 값이 동일한 범위에 있는지 확인했습니다.
    *   **마스크 처리:** 하나의 마스크가 여러 클래스를 포함하거나 여러 연결된 구성 요소(예: 좌우 폐)를 가질 경우, 각 클래스/구성 요소별로 분리된 마스크를 생성했습니다.
    *   총 이미지 면적의 0.153% ($100 / (256 \times 256)$) 미만인 작은 타겟 영역 마스크는 제외했습니다.
    *   데이터는 훈련용 80%, 테스트용 20%로 분할되었으며, 9개 MICCAI 2023 데이터셋은 모델의 일반화 능력 검증에만 사용되었습니다.

2.  **SAM-Med2D로의 전환 (SAM 아키텍처 미세 조정):**
    *   **이미지 인코더 적응:** SAM의 이미지 인코더는 파라미터 수가 많으므로, 원본 파라미터를 고정하고 각 트랜스포머 블록에 학습 가능한 어댑터 계층을 삽입하여 의료 도메인 지식을 저비용으로 통합했습니다. 어댑터는 채널 및 공간 차원을 따라 적응합니다.
    *   **프롬프트 인코더 및 마스크 디코더:**
        *   텍스트 프롬프트는 의료 영상-텍스트 정렬 모델 부족으로 제외하고, 점, 바운딩 박스, 마스크 프롬프트만 미세 조정했습니다.
        *   **점 및 바운딩 박스 (Sparse Prompts):** 위치 인코딩과 학습된 임베딩을 사용하여 벡터 임베딩으로 표현합니다.
        *   **마스크 (Dense Prompts):** 이전 반복에서 생성된 저해상도 피처 맵을 마스크 프롬프트로 사용합니다.
        *   마스크 디코더 구조는 변경하지 않고 훈련 중 파라미터를 계속 업데이트합니다. 각 프롬프트는 여러 마스크(기본 3개)를 예측하며, 가장 높은 IoU를 가진 마스크를 사용하여 손실을 계산합니다.
    *   **미세 조정 전략:** 대화형 분할을 시뮬레이션하여 배치당 9회 반복으로 훈련합니다.
        *   **첫 번째 반복:** 전경 점 또는 바운딩 박스를 무작위로 선택하여 스파스 프롬프트로 사용합니다. 어댑터, 프롬프트 인코더, 마스크 디코더 파라미터를 모두 업데이트합니다.
        *   **이후 반복:** 마스크 디코더 파라미터만 업데이트합니다. 이전 예측과 실제 값 간의 오류 영역에서 1, 3, 5, 또는 9개의 점을 무작위로 선택하여 새로운 스파스 프롬프트로 사용하고, 이전 저해상도 마스크를 밀집 프롬프트로 사용합니다.
        *   마지막 반복과 하나의 무작위 중간 반복에서는 모델이 제공된 마스크로부터 이점을 얻도록 밀집 프롬프트만 제공합니다.

3.  **SAM-Med2D 평가:**
    *   **모델 비교:** SAM (원본), FT-SAM (마스크 디코더만 미세 조정), SAM-Med2D를 비교합니다.
    *   **프롬프트 모드:** 바운딩 박스 및 점 프롬프트를 중심으로 평가합니다.
    *   **데이터 다양성:** 10가지 모달리티, 4가지 해부학적 구조, 31개 주요 장기에 걸쳐 성능을 평가합니다.
    *   **일반화 능력:** 9개 MICCAI 2023 데이터셋에서 모델의 견고성을 평가합니다.
    *   **평가 지표:** Dice score를 사용하여 분할 결과를 평가합니다.

## 📊 Results
*   **전반적인 성능:**
    *   바운딩 박스 프롬프트 모드에서 SAM-Med2D (79.30% Dice)는 SAM (61.63%) 대비 17.67%p 향상, FT-SAM (73.56%) 대비 5.74%p 향상된 성능을 보였습니다.
    *   점 프롬프트 모드(1점)에서 SAM-Med2D (70.01%)는 SAM (18.94%) 대비 압도적인 성능 우위를 보였으며, 점 개수가 증가함에 따라 성능이 크게 향상되었습니다. 미세 조정된 모델은 1024x1024 해상도의 SAM보다 우수했습니다.
*   **해부학적 구조별 성능:**
    *   SAM-Med2D는 모든 해부학적 구조(두경부, 흉부, 복부, 골반 등)에서 다른 방법들보다 높은 Dice 점수를 달성했습니다.
    *   두경부 영역은 모든 모델에서 상대적으로 낮은 성능을 보였으며, 이는 작거나 경계가 불분명한 병변/장기의 분할 난이도를 시사합니다.
*   **모달리티별 성능:**
    *   피부경, 내시경, 안저, 조직병리, 현미경 영상(RGB 2D)에서는 모든 방법이 70% 이상의 높은 Dice 점수를 보였습니다.
    *   SAM (1024x1024)은 내시경, 조직병리, 현미경 모드에서 미세 조정된 모델보다 우수한 경우도 있었는데, 이는 이들 모달리티가 자연 영상과 유사한 특성을 가지기 때문으로 분석됩니다.
    *   SAM-Med2D는 1점 상호작용만으로도 다른 방법들의 5점 상호작용보다 우수한 성능을 보이는 경우가 많아 효율성을 입증했습니다.
*   **주요 장기별 성능:**
    *   SAM-Med2D는 30개 이상의 장기 중 24개 장기에서 FT-SAM보다 더 높은 Dice 점수를 달성했으며, 최대 6.95%p의 차이를 보였습니다.
    *   5점 프롬프트와 바운딩 박스 프롬프트 간의 성능 격차가 상대적으로 작았으며, 갈비뼈, 견갑골, 쇄골과 같은 특정 골격 부위에서는 점 프롬프트가 더 효과적일 수 있음을 시사했습니다.
*   **일반화 평가:**
    *   9개 MICCAI 2023 데이터셋(미학습 데이터)에서 SAM-Med2D는 바운딩 박스 프롬프트(어댑터 유지 시 81.93%, 제거 시 90.12%)와 1점 프롬프트(어댑터 유지 시 60.31%, 제거 시 83.41%) 모두에서 강력한 일반화 능력을 보여주었습니다.
    *   특히 어댑터 계층을 제거했을 때, SAM-Med2D의 1점 프롬프트 성능(83.41%)은 SAM의 바운딩 박스 프롬프트 성능(85.35%)에 매우 근접하여 데이터 주석 및 분석 시간과 비용을 크게 절감할 수 있음을 입증했습니다.
*   **정성적 비교:**
    *   SAM-Med2D는 SAM보다 시각적으로 더 선명한 경계와 실제와 더 유사한 분할 결과를 제공했습니다. 특히 1점 프롬프트에서 SAM이 타겟 영역을 찾지 못하는 경우가 많았던 반면, SAM-Med2D는 정확한 분할을 수행했습니다.
    *   동일한 수의 점 프롬프트에서 SAM-Med2D는 SAM보다 타겟 영역을 더 잘 묘사하여 더 적은 상호작용으로 원하는 결과를 얻을 수 있음을 보여주었습니다.

## 🧠 Insights & Discussion
본 연구는 대규모 의료 영상 데이터셋에 SAM을 미세 조정하여 의료 영상 분할 작업에서 상당한 성능 향상과 일반화 능력을 달성한 SAM-Med2D를 제시했습니다. 이는 의료 도메인 지식을 SAM에 효과적으로 통합함으로써 도메인 격차를 성공적으로 메웠음을 보여줍니다. 특히, 단일 점 프롬프트에서도 압도적인 성능을 보이며 의료 분야에서 점 기반 상호작용 분할의 효율성과 효과를 입증했습니다. 어댑터 계층을 제거한 상태에서의 1점 프롬프트 성능이 SAM의 바운딩 박스 프롬프트 성능과 유사한 수준에 도달하여, 효율적인 주석 및 분석을 위한 실용적 가치를 강조했습니다.

**한계점 및 향후 연구 방향:**
*   복잡한 형태/경계, 작은 크기 또는 낮은 대비를 가진 객체에 대한 분할 결과는 여전히 개선의 여지가 있습니다. 향후 특정 장기에 대한 윈도우 폭 설정, 경계 손실 설계 등의 최적화 전략이 필요합니다.
*   현재는 관련 데이터셋이 부족하여 자연어 프롬프트 기능이 제한적입니다. SAM-Med2D에 의료 도메인에서의 자연어 이해 능력을 부여하는 것이 향후 목표입니다.
*   SAM-Med2D의 학습 데이터 규모(1,970만 개 마스크)는 SAM의 원본 학습 데이터(10억 개 마스크)에 비해 여전히 작아, 의료 도메인에서 "모든 것"을 분할하는 능력에는 한계가 있습니다. 향후 데이터 엔진을 통해 더 많고 다양한 고품질 마스크를 생성하여 이 격차를 줄일 계획입니다.

## 📌 TL;DR
*   **문제:** SAM은 자연 영상에 특화되어 의료 영상 분할에 직접 적용 시 도메인 격차로 인해 성능이 저조합니다.
*   **제안 방법:** `SAM-Med2D`를 제안합니다. 이는 약 460만 장의 영상과 1,970만 개의 마스크로 구성된 최대 규모의 의료 영상 데이터셋을 구축하고, SAM의 이미지 인코더(어댑터 계층 사용)와 마스크 디코더를 포함한 모든 컴포넌트를 포괄적으로 미세 조정하여 다양한 프롬프트(점, 바운딩 박스, 마스크)를 지원합니다.
*   **주요 결과:** `SAM-Med2D`는 의료 영상 분할에서 원본 SAM보다 훨씬 우수한 성능과 강력한 일반화 능력을 입증했습니다. 특히, 단일 점 상호작용만으로도 높은 정확도를 달성하며, 어댑터 계층 제거 시 바운딩 박스 프롬프트에 필적하는 효율적인 성능을 보여 의료 분야에서 실용적인 가치를 제공합니다.