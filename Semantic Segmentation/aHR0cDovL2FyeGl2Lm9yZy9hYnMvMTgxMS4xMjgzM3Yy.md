# ADVENT: Adversarial Entropy Minimization for Domain Adaptation in Semantic Segmentation
Tuan-Hung Vu, Himalaya Jain, Maxime Bucher, Matthieu Cord, Patrick Pérez

---

## 🧩 Problem to Solve

의미론적 분할(Semantic Segmentation) 모델은 훈련 데이터셋 내에서는 높은 정확도를 보이지만, 실제 환경의 다양한 테스트 데이터셋(예: 날씨 변화, 합성 데이터와 실제 데이터 간의 차이)에서는 심각한 성능 저하를 겪습니다. 특히, 게임 엔진으로 생성된 합성 데이터로 훈련하고 실제 장면에서 테스트하는 "합성-실제(synthetic-2-real)" 환경에서 이러한 도메인 간의 간극(domain gap)이 두드러집니다. 기존 모델은 소스 도메인에서는 '과도한 확신(over-confident, 낮은 엔트로피)' 예측을, 타겟 도메인에서는 '불확실한(under-confident, 높은 엔트로피)' 예측을 생성하는 경향이 있습니다. 이 연구는 레이블 없는 타겟 도메인 이미지에 대해서도 높은 예측 신뢰도(낮은 엔트로피)를 강제함으로써 도메인 간극을 줄이는 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA) 문제를 해결하고자 합니다.

## ✨ Key Contributions

*   의미론적 분할 UDA를 위해 타겟 도메인의 낮은 신뢰도 예측에 직접적으로 패널티를 부여하는 엔트로피 손실(entropy loss)을 제안합니다. 이 엔트로피 손실은 기존 의미론적 분할 프레임워크에 큰 오버헤드를 추가하지 않습니다.
*   엔트로피 최소화 목표뿐만 아니라 소스 도메인에서 타겟 도메인으로의 구조 적응(structure adaptation)을 목표로 하는 새로운 엔트로피 기반 적대적 학습(adversarial training) 접근 방식을 도입합니다.
*   특정 설정에서 성능을 더욱 향상시키기 위해 다음 두 가지 추가 방식을 제안합니다: (i) 특정 엔트로피 범위에서의 훈련 (ii) 클래스 비율 사전 지식(class-ratio priors) 통합.
*   두 가지 도전적인 "합성-실제" 벤치마크(GTA5→Cityscapes 및 SYNTHIA→Cityscapes)에서 의미론적 분할의 최신(state-of-the-art) 성능을 달성했으며, 이 접근 방식이 객체 감지(detection)에도 활용될 수 있음을 보여주었습니다.

## 📎 Related Works

이 논문은 비지도 도메인 적응(UDA) 분야의 다양한 선행 연구를 참조합니다:

*   **특징 분포 불일치 최소화 (Discrepancy Minimization):** 소스와 타겟 간의 특징 분포 차이를 줄이는 방식으로, 최대 평균 불일치(MMD) 또는 적대적 훈련 [10, 24, 15, 25, 42]을 사용합니다.
*   **자기 훈련 (Self-Training):** 모델 예측을 의사 레이블(pseudo-labels)로 사용하여 레이블 없는 데이터로 모델을 훈련하는 방식 [51]입니다. 이 연구의 엔트로피 최소화와 흥미로운 연결 고리가 있습니다.
*   **생성 모델 (Generative Models):** Cycle-GAN [14]과 같이 소스 이미지에 기반한 타겟 이미지를 생성하거나, 특징 공간에서 이미지를 재구성하는 [34, 43] 방식입니다.
*   **의미론적 분할을 위한 적대적 훈련:** Hoffman et al. [15]이 처음 적용했으며, 이후 글로벌 및 클래스별 정렬 [5], 공간 인식 적응 [4], 잔차 네트워크를 통한 특징 유사성 확보 [16], 출력 공간에서의 적응 [41] 등 다양한 변형이 제안되었습니다.
*   **엔트로피 최소화 (Entropy Minimization):** 준지도 학습 [12, 38] 및 클러스터링 [17, 18]에서 유용성이 입증되었으며, 최근에는 분류 태스크의 도메인 적응 [25]에도 적용되었습니다. 이 논문은 엔트로피 기반 UDA 훈련을 의미론적 분할 태스크에 성공적으로 적용한 첫 번째 사례임을 주장합니다.

## 🛠️ Methodology

이 연구는 기존 의미론적 분할 프레임워크(DeepLab-V2 기반, VGG-16 또는 ResNet-101 백본 사용)에 도메인 적응을 위한 추가 네트워크 브랜치를 추가하여 두 가지 엔트로피 기반 UDA 접근 방식을 제안합니다.

1.  **직접 엔트로피 최소화 (Direct Entropy Minimization, MinEnt):**
    *   목표: 타겟 도메인에서 모델의 예측이 높은 신뢰도를 갖도록 강제합니다.
    *   방법: 섀넌 엔트로피(Shannon Entropy)를 사용하여 픽셀별 예측의 엔트로피를 최소화합니다.
    *   픽셀 $(h,w)$에서의 엔트로피 $E_{\{(h,w)\}\}_{x_t}}$는 다음과 같습니다:
        $$E_{\{(h,w)\}\}_{x_t}} = -\frac{1}{\log(C)} \sum_{c=1}^{C} P_{\{(h,w,c)\}\}_{x_t}} \log P_{\{(h,w,c)\}\}_{x_t}}$$
        여기서 $P_{\{(h,w,c)\}\}_{x_t}}$는 픽셀 $(h,w)$에서 클래스 $c$에 대한 예측 확률입니다.
    *   총 엔트로피 손실은 모든 픽셀별 정규화된 엔트로피의 합으로 정의됩니다: $L_{ent}(x_t) = \sum_{h,w} E_{\{(h,w)\}\}_{x_t}}$.
    *   최종 최적화 문제는 소스 도메인에서의 지도 분할 손실 $L_{seg}$와 타겟 도메인에서의 비지도 엔트로피 손실 $L_{ent}$를 공동으로 최적화하는 것입니다:
        $$\min_{\theta_F} \frac{1}{|X_s|} \sum_{x_s \in X_s} L_{seg}(x_s,y_s) + \frac{\lambda_{ent}}{|X_t|} \sum_{x_t \in X_t} L_{ent}(x_t)$$
        여기서 $\lambda_{ent}$는 엔트로피 항의 가중치 요소입니다. 이 방법은 의사 레이블을 사용하는 자기 훈련의 '소프트 할당(soft-assignment)' 버전으로 볼 수 있습니다.

2.  **적대적 학습을 통한 엔트로피 최소화 (Minimizing Entropy with Adversarial Learning, AdvEnt):**
    *   목표: 타겟 도메인의 엔트로피 분포를 소스 도메인과 유사하게 만들어 간접적으로 엔트로피를 최소화하고, 도메인 간의 구조적 일관성을 활용합니다.
    *   방법: 픽셀 수준의 가중 자체 정보(weighted self-information) 맵 $I_x = -P_x \cdot \log P_x$ 공간에서 소스와 타겟 간의 분포 거리를 최소화합니다.
    *   완전 합성곱(fully-convolutional) 판별자 네트워크 $D$는 $I_x$를 입력으로 받아 도메인 분류 출력을 생성합니다 (소스 도메인 1, 타겟 도메인 0).
    *   판별자는 소스 및 타겟 이미지에서 오는 출력을 구별하도록 훈련됩니다:
        $$\min_{\theta_D} \frac{1}{|X_s|} \sum_{x_s} L_D(I_{x_s},1) + \frac{1}{|X_t|} \sum_{x_t} L_D(I_{x_t},0)$$
    *   분할 네트워크는 판별자를 속이도록 훈련됩니다 (즉, 타겟 이미지를 소스 이미지처럼 보이게 함):
        $$\min_{\theta_F} \frac{1}{|X_s|} \sum_{x_s} L_{seg}(x_s,y_s) + \frac{\lambda_{adv}}{|X_t|} \sum_{x_t} L_D(I_{x_t},1)$$
        여기서 $\lambda_{adv}$는 적대적 항의 가중치 요소입니다. 훈련 중에는 네트워크 $D$와 $F$를 번갈아 최적화합니다.

3.  **클래스 비율 사전 지식 통합 (Incorporating Class-Ratio Priors, CP):**
    *   엔트로피 최소화가 특정 쉬운 클래스에 편향될 수 있는 문제를 해결하기 위해, 소스 레이블의 클래스 분포에 기반한 클래스 비율 사전 지식 $p_s$를 사용합니다.
    *   타겟 예측 $P_{x_t}$와 클래스 비율 사전 지식 $p_s$ 간의 큰 불일치에 패널티를 부과합니다:
        $$L_{cp}(x_t) = \sum_{c=1}^{C} \max(0,\mu p^{(c)}_s - E_c(P^{(c)}_{x_t}))$$
        여기서 $\mu \in [0,1]$는 클래스 사전 제약의 강도를 조절합니다.

## 📊 Results

이 연구는 GTA5→Cityscapes 및 SYNTHIA→Cityscapes 두 가지 UDA 벤치마크에서 최첨단 성능을 달성했습니다.

*   **GTA5→Cityscapes:**
    *   **MinEnt (직접 엔트로피 최소화):** VGG-16 및 ResNet-101 기반 CNN 모두에서 최신 기준선과 비슷한 성능을 달성했으며, 자기 훈련(Self-Training, ST) 접근 방식보다 뛰어났습니다. 판별자 네트워크 훈련이 필요 없어 훈련 시간이 적고 안정적입니다.
    *   **MinEnt + ER (Entropy Range):** ResNet-101 모델의 경우, 각 타겟 샘플에서 가장 높은 엔트로피 픽셀 상위 30%에 대해 훈련했을 때 (MinEnt+ER), 43.1% mIoU를 달성하여 기본 MinEnt 모델보다 성능이 향상되었습니다.
    *   **AdvEnt (적대적 엔트로피 최소화):** 두 가지 기본 네트워크 모두에서 기준선 대비 일관된 성능 향상을 보였으며, MinEnt보다 일반적으로 우수했습니다. GTA5→Cityscapes UDA 설정에서 43.8% mIoU로 최신 성능을 달성했습니다. VGG-16에서는 +3.3% mIoU, ResNet-101에서는 +1.5% mIoU 향상을 보여 구조적 적응의 중요성을 입증했습니다.
    *   **앙상블 (AdvEnt+MinEnt):** 두 모델을 결합했을 때 Cityscapes 검증 세트에서 45.5% mIoU를 달성하여 가장 우수한 성능을 보였습니다. 이는 두 모델이 상호 보완적인 정보를 학습한다는 것을 시사합니다. 오라클(oracle, 완전 지도 학습 모델)과의 mIoU 격차도 가장 작았습니다.

*   **SYNTHIA→Cityscapes:**
    *   **MinEnt:** VGG-16 기반 네트워크에서 최신 메서드와 비슷한 결과를 보였습니다. 자기 훈련보다 우수했지만, '도로' 클래스에서 성능 저하가 관찰되었습니다.
    *   **MinEnt + CP (Class Priors):** SYNTHIA와 Cityscapes 간의 큰 레이아웃 차이를 해결하기 위해 클래스 비율 사전 지식을 통합했습니다. 이로 인해 16- 및 13-클래스 서브셋 모두에서 MinEnt 성능이 +2.9% mIoU 향상되었습니다.
    *   **AdvEnt + CP:** ResNet-101 기반 네트워크에서 최신 성능을 달성했으며, [41]의 재훈련된 모델보다 16-클래스 및 13-클래스 서브셋에서 각각 +1.2%, +1.8% mIoU 향상을 보였습니다.
    *   **앙상블 (AdvEnt+MinEnt):** SYNTHIA에서 훈련된 MinEnt 및 AdvEnt 모델의 앙상블은 각각 16-클래스에서 41.2%, 13-클래스에서 48.0% mIoU로 가장 좋은 성능을 달성했습니다. 오라클과의 mIoU 격차도 가장 작았습니다.

*   **객체 감지 UDA (Cityscapes→Cityscapes-Foggy):**
    *   SSD-300 아키텍처에 엔트로피 기반 UDA를 적용한 예비 실험 결과, 기준 모델(14.7% mAP) 대비 MinEnt는 16.9% mAP, AdvEnt는 26.2% mAP를 달성하여 상당한 성능 향상을 보였습니다. 이는 엔트로피 기반 UDA가 객체 감지에도 적용될 가능성을 시사합니다.

## 🧠 Insights & Discussion

*   **특정 엔트로피 범위에서의 훈련:** GTA5→Cityscapes 설정의 ResNet-101 기반 MinEnt 모델에서, "가장 혼란스러운(most confusing)" 픽셀(엔트로피 값이 높은 픽셀) 상위 30%에 대해 훈련하면 성능이 향상되었습니다. 이는 모델이 이미 잘 일반화되어 이러한 "혼란스러운" 예측 중 상당수가 정확하지만 "낮은 신뢰도"를 가짐을 시사합니다.
*   **클래스 비율 사전 지식의 활용:** SYNTHIA와 Cityscapes 사이의 현저한 레이아웃 차이가 있는 경우, 클래스 비율 사전 지식은 특정 클래스가 타겟 도메인에서 완전히 누락되거나 강하게 편향되는 "퇴화된 해결책(degenerate solutions)"을 피하는 데 도움이 됩니다. $\mu=0.5$를 사용하여 타겟 클래스 비율이 소스와 어느 정도 다를 수 있도록 허용하는 것이 이상적이었습니다.
*   **MinEnt와 AdvEnt의 상호 보완성:** MinEnt는 독립적인 픽셀 수준 예측의 불확실성에 패널티를 부과하는 반면, AdvEnt는 이미지 수준, 즉 장면 토폴로지에 더 많이 작용합니다. 두 모델의 앙상블이 더 나은 성능을 달성하는 것은 이들이 상호 보완적인 정보를 학습함을 나타냅니다.
*   **객체 감지로의 확장 가능성:** 엔트로피 기반 UDA 접근 방식은 의미론적 분할에 국한되지 않고 객체 감지와 같은 다른 인식 태스크에도 적용될 수 있음을 보여주었습니다. 간단한 탐지 아키텍처(SSD-300)에서도 상당한 mAP 개선을 달성했습니다.

## 📌 TL;DR

이 논문은 의미론적 분할에서 합성-실제(synthetic-to-real) 데이터 간의 도메인 이동 문제를 해결하기 위해 두 가지 엔트로피 기반 비지도 도메인 적응(UDA) 방법을 제안합니다. 첫째, **MinEnt(직접 엔트로피 최소화)**는 타겟 도메인에서 픽셀별 예측의 엔트로피를 직접 최소화하여 예측 신뢰도를 높입니다. 둘째, **AdvEnt(적대적 엔트로피 최소화)**는 가중 자체 정보(weighted self-information) 분포를 도메인 간에 정렬하기 위해 적대적 학습을 사용하여 구조적 일관성을 활용하며 간접적으로 엔트로피를 최소화합니다. 이 연구는 특정 엔트로피 범위에서의 훈련과 클래스 비율 사전 지식 통합을 통해 성능을 추가로 향상시킬 수 있음을 보여줍니다. 제안된 방법들은 GTA5→Cityscapes 및 SYNTHIA→Cityscapes 벤치마크에서 최신 성능을 달성했으며, 두 방법의 앙상블이 더욱 우수한 결과를 보였습니다. 또한, 객체 감지 UDA에서도 유망한 결과를 시연하여 해당 접근 방식의 광범위한 적용 가능성을 입증합니다.