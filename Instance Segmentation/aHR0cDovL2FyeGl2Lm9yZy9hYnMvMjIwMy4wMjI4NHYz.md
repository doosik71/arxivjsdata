# NUCLEI INSTANCE SEGMENTATION AND CLASSIFICATION IN HISTOPATHOLOGY IMAGES WITH STARDIST

Martin Weigert, Uwe Schmidt

## 🧩 Problem to Solve

조직병리 이미지에서 세포 핵의 인스턴스 분할(instance segmentation) 및 분류는 전산 병리학에서 중요한 과제입니다. 특히 핵이 밀집되어 있을 때 기존의 바운딩 박스 기반 또는 픽셀 그룹화 방법은 정확한 분할에 어려움을 겪을 수 있습니다. StarDist는 원래 형광 현미경 이미지의 둥근 객체(예: 세포 핵)를 별 볼록 다각형(star-convex polygon)으로 표현하여 분할하는 딥러닝 방법이었으나, 저자들은 이를 조직병리 이미지 도메인에 적용하고, 추가적으로 탐지된 객체의 분류까지 수행하도록 확장하는 문제를 해결하고자 합니다. 또한 이 확장된 방법이 다른 조직병리 방법들과 비교하여 얼마나 효과적인지 CoNIC 챌린지를 통해 검증하고자 합니다.

## ✨ Key Contributions

* **StarDist 확장:** 형광 현미경 이미지를 위해 개발된 StarDist를 조직병리 이미지의 핵 인스턴스 분할 및 분류에 성공적으로 적용하고 확장하는 방법을 제시했습니다. 이를 위해 CNN 백본에 의미론적 분할(semantic segmentation) 헤드를 추가하여 객체 클래스 확률을 예측하도록 했습니다.
* **CoNIC 챌린지 1위 달성:** Colon Nuclei Identification and Counting (CoNIC) 챌린지 2022에서 분할 및 분류 태스크의 예비 및 최종 테스트 단계 모두에서 1위를 차지하여 방법론의 우수성을 입증했습니다.
* **염색 변동성 대응:** 전형적인 기하학적 데이터 증강 외에, 헤마톡실린(H) 및 에오신(E) 염색 변동성을 다루기 위한 특별한 색상 증강 기법이 새로운 데이터에 대한 모델 일반화에 중요함을 발견했습니다.
* **불균형 클래스 문제 해결:** 불균형한 (세포) 클래스 분포 문제를 해결하는 것이 CoNIC 챌린지에서 사용된 평가 지표(각 세포 유형에 동일한 중요도 부여)에서 높은 점수를 달성하는 데 결정적임을 보였습니다. 특히, 간단한 학습 데이터 오버샘플링이 가장 효과적이었습니다.
* **성능 향상 기법:** 테스트 시간 증강(Test-Time Augmentations, TTA) 및 모델 앙상블이 성능을 크게 향상시키며, 비교적 간단한 형태 정제(shape refinement) 절차도 분할 품질을 추가적으로 개선할 수 있음을 입증했습니다.

## 📎 Related Works

* **STARDIST [1, 2]:** 별 볼록 다각형을 사용하여 세포를 탐지하고 분할하는 딥러닝 기반 접근 방식의 원천 기술입니다.
* **HoverNet [3]:** 다중 조직 조직학 이미지에서 핵을 동시에 분할하고 분류하는 기존의 조직병리 관련 방법론입니다.
* **CoNIC Challenge [4]:** Colon Nuclei Identification and Counting 챌린지로, 본 논문에서 성능 평가의 주요 무대가 됩니다.
* **Lizard Dataset [5]:** CoNIC 챌린지에서 사용된 대규모 결장 핵 인스턴스 분할 및 분류를 위한 데이터셋입니다.
* **Focal Loss [6]:** 불균형한 클래스 문제를 다루기 위한 손실 함수로, 본 연구에서 클래스 불균형 해결을 위한 대안으로 탐색되었습니다.
* **U-Net [7]:** StarDist 모델의 CNN 백본으로 사용된 컨볼루션 네트워크 아키텍처입니다.
* **Tversky Loss [8]:** 클래스 확률 손실 계산에 사용된 손실 함수 중 하나입니다.
* **Adam [9]:** 모델 훈련에 사용된 최적화 알고리즘입니다.
* **Panoptic Segmentation [10]:** 인스턴스 분할과 의미론적 분할을 결합한 태스크로, 본 연구의 평가 지표인 $mPQ$와 관련이 있습니다.

## 🛠️ Methodology

본 연구는 기존 StarDist를 확장하고 여러 최적화 기법을 적용하여 조직병리 이미지의 핵 인스턴스 분할 및 분류를 수행합니다.

* **StarDist 확장:**
  * 기존 StarDist는 객체 확률 및 방사형 거리(radial distances)를 예측하여 별 볼록 다각형 형태로 객체를 분할합니다.
  * 여기에 **의미론적 분할 헤드(semantic segmentation head)**를 CNN 백본에 추가하여 픽셀별 클래스 확률을 예측하도록 확장했습니다.
  * 객체 인스턴스가 분할된 후, 해당 인스턴스에 속하는 모든 픽셀의 클래스 확률을 집계하여 최종 객체 인스턴스의 클래스를 결정합니다.

* **데이터:**
  * CoNIC 챌린지 주최 측에서 제공하는 **Lizard 데이터셋 [5]**의 패치만 사용하여 모델을 학습했습니다.
  * 데이터셋은 6가지 세포 유형(호중구, 상피세포, 림프구, 형질세포, 호산구, 결합 조직 세포)의 핵 인스턴스를 포함합니다.
  * 세포 클래스 분포가 매우 불균형합니다 (예: 상피 핵이 60% 이상, 호중구 및 호산구 핵은 1% 미만).
  * 데이터의 90%는 학습에, 10%는 내부 검증에 사용했습니다.

* **클래스 불균형 및 증강:**
  * **클래스 불균형 해결:**
    * 의미론적 분할 헤드의 손실에 클래스 가중치(class weights) 적용.
    * 의미론적 분할 헤드에 포컬 손실(focal loss) [6] 사용.
    * **학습 데이터 오버샘플링(oversampling):** 클래스 빈도에 반비례하는 확률로 소수 클래스 핵을 많이 포함하는 이미지 패치를 중복시켜 샘플링하는 방법이 가장 효과적이었습니다.
  * **데이터 증강:**
    * **기하학적 증강:** 뒤집기, 90도 회전, 탄성 변형(elastic deformations)을 훈련 중 실시간으로 적용했습니다.
    * **색상 증강:**
      * 밝기(brightness)만 변경.
      * 밝기 및 색조(hue) 변경.
      * 밝기 및 H&E 염색 변경. (외부 테스트 데이터에서 특히 효과적)

* **모델 및 학습 세부 사항:**
  * StarDist 모델은 64개의 레이(rays)와 깊이 4의 U-Net [7] 백본을 사용했습니다.
  * **손실 함수:**
    * 객체 확률: 이진 교차 엔트로피(binary cross-entropy)
    * 방사형 거리: 평균 절대 오차(mean absolute error)
    * 클래스 확률: 범주형 교차 엔트로피(categorical cross-entropy)와 Tversky 손실 [8]의 합
  * **학습:** 무작위 초기화된 가중치로 1000 에포크 동안 Adam [9] 옵티마이저를 사용하여 학습했습니다 (초기 학습률 0.0003). 80 에포크 동안 진전이 없으면 학습률을 절반으로 줄였습니다. 과적합(overfitting) 방지를 위해 검증 손실이 가장 작았을 때의 모델 가중치를 선택했습니다.

* **테스트 시간 증강 (TTA):**
  * 훈련 시 데이터 증강을 많이 사용했음에도 TTA가 성능 개선에 기여함을 확인했습니다.
  * 8가지 기하학적 TTA (90도 회전 및 수평 뒤집기 조합)를 적용하고, 각 예측(객체 확률, 방사형 거리, 클래스 확률)을 요소별 평균(element-wise averaging)으로 병합하여 더 견고한 결과를 얻었습니다.
  * 방사형 거리가 극좌표계 방향을 참조하므로, 입력 이미지의 기하학적 변환에 따라 예측된 텐서의 방사형 거리 순서가 순환적으로 변경될 수 있음을 고려하여 이를 보정했습니다.

* **후처리 및 형태 정제 (Shape Refinement):**
  * CNN 예측 후 NMS(non-maximum suppression)를 적용합니다.
  * 일반적인 StarDist에서는 각 NMS 라운드에서 "승자" 폴리곤만 유지하지만, 본 연구에서는 각 승자 폴리곤과 그것이 억제한 모든 폴리곤을 함께 그룹화했습니다.
  * 각 그룹에 대해 모든 폴리곤을 이진 마스크로 래스터화하고 다수결 투표(majority vote)를 통해 주어진 객체 인스턴스의 최종 마스크를 얻습니다. 이를 형태 정제라고 합니다.

* **모델 앙상블:**
  * 별도로 훈련된 여러 StarDist 모델의 예측을 결합하여 성능을 더욱 향상시켰습니다.
  * 각 모델의 CNN 예측을 수집하고 TTA와 동일한 방식으로 병합했습니다.
  * 앙상블과 TTA를 결합할 수도 있으며, 계산 요구 사항을 줄이기 위해 각 모델별로 일부 증강만 무작위로 샘플링할 수 있습니다. 후처리 및 형태 정제는 앙상블 전체에 대해 한 번만 수행됩니다.

## 📊 Results

모델의 인스턴스 분할 및 분류 성능은 CoNIC에서 사용된 지표인 다중 클래스 파놉틱 품질(multi-class panoptic quality, $mPQ$)을 사용하여 평가했습니다. $PQ$는 탐지 품질($DQ$, $F_{1}$ 점수)과 분할 품질($SQ$, 평균 IoU)의 곱으로 정의되며, $mPQ = \frac{1}{T} \sum_{t=1}^{T} PQ_{t}$는 모든 $T$개 세포 클래스에 대한 $PQ_{t}$의 평균입니다.

* **절단 실험(Ablation Experiments) (내부 검증 데이터셋):**
  * **클래스 불균형 해결:** 단순 오버샘플링(oversampling)이 클래스 가중치나 포컬 손실보다 모든 지표에서 훨씬 우수한 결과를 보였습니다 ($mPQ$: 오버샘플링 0.5885 vs. 클래스 가중치 0.5099, 포컬 손실 0.4541, none 0.3900).
  * **색상 증강:** 내부 검증 데이터셋에서는 밝기 증강(brightness)이 밝기+색조 또는 밝기+H&E 염색 증강보다 더 효과적인 것으로 나타났습니다 ($mPQ$: 밝기 0.6034 vs. 밝기+색조 0.5495, 밝기+H&E 0.5884). 이는 내부 훈련 및 검증 데이터의 높은 유사성 때문일 수 있습니다.
  * **테스트 시간 전략:** 형태 정제(shape refinement) 및 TTA(Test-Time Augmentations)는 클래스 불균형 해결 및 색상 증강에 비해 상대적으로 작은 성능 향상을 가져왔습니다 ($mPQ$: none 0.5884 -> TTA 0.5913 -> TTA + 형태 정제 0.5984).

* **CoNIC 예비 및 최종 테스트 단계 제출 결과:**
  * **예비 테스트 단계:**
    * 초기 기본 모델(A)은 낮은 $mPQ^+$ 점수를 보였습니다 (0.3647).
    * **H&E 염색 증강 추가(B):** 테스트 데이터의 도메인 시프트(domain shift)를 예상하여 H&E 염색 증강을 추가하자 성능이 크게 향상되었습니다 ($mPQ^+$ 0.3647 -> 0.4343).
    * **TTA (B$_{2}$) 및 형태 정제 (B$_{3}$) 추가:** 각각 성능이 추가적으로 개선되었습니다 ($mPQ^+$ 0.4343 -> 0.4515 -> 0.4583).
    * **오버샘플링으로 클래스 불균형 해결 (C):** 클래스 불균형을 오버샘플링으로 적극적으로 해결하자 성능이 크게 향상되어 2위를 기록했습니다 ($mPQ^+$ 0.4583 -> 0.4970).
    * **모델 앙상블 (B,C,D):** 세 가지 모델의 앙상블을 통해 최종적으로 예비 테스트 리더보드에서 1위를 달성했습니다 ($mPQ^+$ 0.4971).
  * **최종 테스트 단계:**
    * 네 가지 모델(C,D,E,F)의 앙상블을 제출하여 최종 테스트 리더보드에서도 1위를 차지했습니다 ($mPQ^+$ 0.5013). 외부 테스트 데이터에 대해 염색 증강이 효과적이었던 반면, 내부 검증 데이터에서는 다른 양상을 보였습니다.

## 🧠 Insights & Discussion

* **StarDist의 유연성:** StarDist가 형광 현미경 이미지에서 조직병리 이미지 도메인으로 성공적으로 확장되었으며, 인스턴스 분할뿐만 아니라 객체 분류까지 가능하도록 유연하게 개선될 수 있음을 입증했습니다. 이는 StarDist가 둥근 객체 분할에 적합한 강력한 프레임워크임을 시사합니다.
* **데이터 증강의 중요성:** 특히 조직병리 이미지의 염색 변동성으로 인한 도메인 시프트 문제에 대응하기 위해 H&E 염색 증강이 필수적임을 확인했습니다. 내부 검증 데이터와 외부 CoNIC 테스트 데이터 간의 성능 차이는 실제 적용 시 데이터의 다양성과 도메인 불일치를 고려한 증강 전략의 중요성을 강조합니다.
* **클래스 불균형의 영향:** 세포 클래스 불균형 문제를 해결하기 위한 오버샘플링 전략이 CoNIC 챌린지의 평가 지표에서 높은 점수를 달성하는 데 가장 중요한 요소 중 하나였습니다. 이는 평가 지표가 소수 클래스에도 동일한 중요도를 부여할 때, 불균형한 데이터셋에서 소수 클래스에 대한 학습을 강화하는 것이 매우 중요함을 시사합니다.
* **앙상블 및 TTA의 시너지 효과:** 테스트 시간 증강(TTA)과 모델 앙상블은 각각 성능을 소폭 향상시키지만, 결합될 경우 상당한 성능 부스트를 제공하여 최종 결과에서 챌린지 1위를 달성하는 데 결정적인 역할을 했습니다.
* **한계:** 본 연구에서는 CoNIC 챌린지의 핵 분할 및 분류 태스크 1에 중점을 두었으며, 태스크 2(세포 구성 예측)는 태스크 1의 결과를 단순히 보고하는 방식으로 수행되었습니다. 핵 인스턴스 수 예측에 특화된 추가 최적화가 이루어지지 않아, 태스크 2에서는 초기에는 성능이 그리 좋지 않았으나 최종적으로는 3위를 기록했습니다.

## 📌 TL;DR

본 논문은 형광 현미경 이미지를 위해 개발된 딥러닝 기반 핵 분할 방법인 **StarDist**를 조직병리 이미지의 핵 **인스턴스 분할 및 분류**에 성공적으로 확장하고 적용했습니다. CNN에 의미론적 분할 헤드를 추가하여 핵 유형 분류 기능을 구현하고, **학습 데이터 오버샘플링**을 통해 심각한 클래스 불균형 문제를 해결했습니다. 또한, **H&E 염색 증강**을 통해 염색 변동성으로 인한 도메인 시프트를 극복하고, **테스트 시간 증강(TTA)** 및 **모델 앙상블**을 활용하여 성능을 최적화했습니다. 그 결과, CoNIC 챌린지 2022의 핵 분할 및 분류 태스크에서 **예비 및 최종 테스트 단계 모두 1위**를 차지하며 제안된 방법론의 우수성과 경쟁력을 입증했습니다.
