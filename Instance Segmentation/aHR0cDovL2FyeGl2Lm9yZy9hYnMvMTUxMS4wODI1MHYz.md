# Recurrent Instance Segmentation

Bernardino Romera-Paredes, Philip Hilaire Sean Torr

## 🧩 Problem to Solve

인스턴스 분할(Instance Segmentation)은 이미지 내에서 관심 있는 각각의 고유한 객체를 탐지하고 그 윤곽을 정확히 그리는 문제입니다. 이는 모든 픽셀을 미리 정의된 클래스로 분류하는 의미론적 분할(Semantic Segmentation)보다 더 도전적인데, 객체의 개수가 사전에 알려져 있지 않고, 평가 시 픽셀 그룹 할당의 순열 불변성을 고려해야 하기 때문입니다. 기존 인스턴스 분할 접근 방식들은 객체 제안(object proposal), 인식(recognition), 분할(segmentation) 등 여러 모듈을 개별적으로 학습시키므로, 모듈 간의 공동 학습 기회를 놓치고 복잡한 중간 손실 함수 정의가 필요하다는 한계가 있었습니다.

## ✨ Key Contributions

* **엔드-투-엔드 순차적 인스턴스 분할 패러다임 제안:** 기존의 독립적인 모듈 학습 방식에서 벗어나, 순환 신경망(RNN) 기반의 단일 엔드-투-엔드 모델을 통해 인스턴스를 순차적으로 찾아 분할하는 새로운 방법을 제시합니다.
* **공간 기억(Spatial Memory) 활용:** RNN에 공간 기억을 통합하여 이미 처리된 픽셀을 추적하고, 가려짐(occlusion) 문제를 효과적으로 처리할 수 있도록 합니다.
* **원칙적인 손실 함수 설계:** 인스턴스 분할 문제의 고유한 특성(예: 순열 불변성)을 정확하게 반영하는 손실 함수를 설계하여 모델 학습의 안정성과 효율성을 높입니다.
* **우수한 성능 달성:** 다중 인물 분할(multiple person segmentation)에서 최신 접근 방식을 능가하며, 식물 표현형 분석(Plant Phenotyping) 데이터셋의 잎 개수 세기 작업에서 모든 최신 기법을 뛰어넘는 성능을 보입니다.

## 📎 Related Works

* **인스턴스 분할 모델:** 객체 탐지(예: R-CNN [10])와 의미론적 분할(예: FCN [12], CRFs [13, 14])의 발전에 영향을 받았습니다. [4, 5]는 R-CNN 기반으로 영역 제안 후 CNN 특징과 후처리를 통해 분할을 수행했지만, 모듈들이 독립적으로 학습됩니다. [15]는 픽셀 단위 인스턴스 위치를 예측하고 클러스터링을 적용했으나, 직접적인 인스턴스 분할 측정값을 최적화하지 못했습니다. 깊이 정보를 활용하여 가려진 객체 순서를 모델링하는 접근 방식 [16, 17, 18]도 있었지만, 이 논문은 모델이 스스로 인스턴스 순서를 결정하게 합니다.
* **순환 신경망 (RNNs):** 시퀀스 데이터를 다루고 내부 상태(메모리)를 유지하는 능력 때문에 기계 번역 [19], 이미지 생성(DRAW [22]), 이미지 캡셔닝 [23, 24, 25] 등 다양한 분야에서 성공적으로 사용되었습니다. [27]은 RNN으로 얼굴 바운딩 박스를 순차적으로 예측했는데, 본 연구와 유사한 동기를 가지지만 픽셀 단위 분류가 아닌 회귀 문제입니다.
* **어텐션 기반 모델:** 입력의 특정 부분에 집중하여 작업을 수행하는 모델 [22, 30, 31]로, 본 연구의 순차적 인스턴스 처리는 어텐션과 유사하지만, 이 모델에서는 "하나의 인스턴스에 집중하는 것" 자체가 최종 목표입니다.

## 🛠️ Methodology

본 연구에서 제안하는 RIS (Recurrent Instance Segmentation) 모델은 이미지를 순차적으로 처리하여 한 번에 하나의 인스턴스를 분할합니다.

1. **초기 특징 추출 (FCN):** 입력 이미지 $I \in \mathbb{R}^{h \times w \times c}$는 완전 합성곱 네트워크(FCN, [12] 기반)를 통과하여 공간 정보를 보존하는 저해상도 특징 맵 $B \in \mathbb{R}^{h' \times w' \times d}$를 생성합니다. 이 특징 맵은 RNN의 모든 반복에서 입력으로 사용됩니다.
2. **순환 처리 (Convolutional LSTM):**
    * FCN의 출력 $B$와 이전 단계의 은닉 상태 $h_{t-1}$를 입력으로 받아, 합성곱 LSTM(ConvLSTM) 유닛을 통해 현재 상태 $h_t$를 업데이트합니다.
    * ConvLSTM [36]은 표준 LSTM의 완전 연결 계층을 합성곱 계층으로 대체하여, 이미지와 같은 격자형 입력에 적합하며 공간 정보를 효율적으로 처리할 수 있게 합니다. 이는 이전 반복에서 이미 분할된 픽셀 영역을 기억하는 "공간 기억" 역할을 수행합니다.
    * 수학적으로는 다음과 같이 게이트가 합성곱으로 표현됩니다:
        $$
        \begin{aligned}
        i_t &= \text{Sigmoid}(\text{Conv}(x_t;w_{xi}) + \text{Conv}(h_{t-1};w_{hi}) + b_i) \\
        f_t &= \text{Sigmoid}(\text{Conv}(x_t;w_{xf}) + \text{Conv}(h_{t-1};w_{hf}) + b_f) \\
        o_t &= \text{Sigmoid}(\text{Conv}(x_t;w_{xo}) + \text{Conv}(h_{t-1};w_{ho}) + b_o) \\
        g_t &= \text{Tanh}(\text{Conv}(x_t;w_{xg}) + \text{Conv}(h_{t-1};w_{hg}) + b_g) \\
        c_t &= f_t \odot c_{t-1} + i_t \odot g_t \\
        h_t &= o_t \odot \text{Tanh}(c_t)
        \end{aligned}
        $$
        여기서 $\odot$는 요소별 곱셈을 나타냅니다.
3. **공간 억제 모듈 (Spatial Inhibition Module):**
    * ConvLSTM의 은닉 상태 $h_t$를 입력으로 받아 현재 반복에서 분할할 객체의 마스크 $\hat{Y}_t \in [0,1]^{h \times w}$와 예측의 신뢰도 $s_t \in [0,1]$를 출력합니다.
    * 마스크 생성 과정: $1 \times 1$ 합성곱 $\to$ 로그 소프트맥스 $\to$ 학습된 바이어스 추가 $\to$ 시그모이드 변환 (픽셀별) $\to$ 업샘플링. 로그 소프트맥스는 경쟁 메커니즘을 통해 하나의 인스턴스만 분할하도록 돕습니다.
    * 신뢰도 생성 과정: Max-pooling $\to$ 선형 계층 $\to$ 시그모이드.
4. **손실 함수 (Loss Function):**
    * 예측 마스크 시퀀스 $\hat{Y} = \{\hat{Y}_1, ..., \hat{Y}_{\hat{n}}\}$와 실제 마스크 시퀀스 $Y = \{Y_1, ..., Y_n\}$ 간의 최적의 일치(optimal matching)를 찾기 위해 헝가리안 알고리즘(Hungarian algorithm)을 사용합니다. 이는 순열 불변성을 해결하기 위함이며, Intersection over Union (IoU) 유사도 $f_{IoU}(\hat{y},y)$를 기반으로 합니다.
    * 전체 손실 함수는 다음과 같이 정의됩니다:
        $$
        \mathcal{L}(\hat{Y}, s, Y) = \min_{\delta \in \mathcal{S}} \left( - \sum_{\hat{t}=1}^{\tilde{n}} \sum_{t=1}^{n} f_{IoU}(\hat{Y}_{\hat{t}}, Y_t) \delta_{\hat{t},t} + \lambda \sum_{t=1}^{\hat{n}} f_{BCE}([t \le n], s_t) \right)
        $$
        * 첫 번째 항은 매칭된 인스턴스들의 IoU 유사도 합계를 최소화합니다 (음수이므로 IoU를 최대화).
        * 두 번째 항은 이진 교차 엔트로피(BCE)를 사용하여 신뢰도 $s_t$를 학습합니다. 실제 인스턴스 개수 $n$ 이하의 예측에는 $s_t=1$, 그 이상에는 $s_t=0$을 유도합니다. $\lambda$는 두 항의 가중치입니다.
5. **학습 전략:** 커리큘럼 학습(curriculum learning)을 통해 초기에 적은 수의 객체 분할부터 시작하여 점진적으로 더 많은 객체를 처리하도록 학습시킵니다.

## 📊 Results

* **다중 인물 분할 (Multiple Person Segmentation):**
  * Pascal VOC 2012 데이터셋에서 실험했습니다.
  * RIS 모델은 경쟁 모델들과 유사한 성능을 보였습니다.
  * 후처리로 조건부 랜덤 필드(CRF)를 적용한 **RIS+CRF**는 $AP_r(0.5)$에서 50.1%를 달성하여, 기존 최신 방법들을 능가하는 우수한 성능을 보여주었습니다. (예: [5] 48.3%, [4] 47.9%, [15] 48.8%).
* **식물 잎 분할 및 개수 세기 (Plants Leaf Segmentation and Counting):**
  * CVPPP A1 데이터셋에서 실험했습니다.
  * **잎 개수 세기:** RIS는 DiC (Difference in Count) 및 $|DiC|$ (절대값 DiC) 지표에서 현저히 뛰어난 성능을 보였으며, $|DiC|$는 1.1로 기존 모든 ad-hoc 경쟁 방법보다 우수했습니다.
  * **잎 분할:** SBD (Symmetric Best Dice) 지표에서 RIS+CRF는 66.6%를 달성하여 경쟁 모델들과 비슷한 수준이었으나, 가장 좋은 성능은 아니었습니다. 이는 학습 데이터 부족으로 다양한 잎 모양을 처음부터 학습하기 어려웠기 때문으로 분석됩니다.
* **정성적 결과:** 모델의 내부 상태는 시간이 지남에 따라 이미 방문한 이미지 영역에 대한 정보를 성공적으로 추적하고 있음을 시각적으로 보여줍니다.

## 🧠 Insights & Discussion

본 연구는 순환 신경망을 활용하여 인스턴스 분할을 엔드-투-엔드로 학습하는 새로운 가능성을 제시합니다. 특히, ConvLSTM 기반의 순환 구조와 공간 기억을 통해 사람이 객체를 세는 방식과 유사하게 순차적으로 인스턴스를 처리하고, 가려짐과 같은 복잡한 상황을 모델링할 수 있음을 보여줍니다. 설계된 원칙적인 손실 함수는 순열 불변성 문제를 효과적으로 해결하며, 인물 분할 및 잎 개수 세기에서 기존 최신 기법들을 능가하는 인상적인 결과를 달성했습니다.

**한계 및 향후 연구:**

* 세분화된 경계(boundary) 예측의 정확도를 높이기 위해 CRF를 후처리로 사용하는 것이 필요했지만, 이를 엔드-투-엔드 모델에 통합하는 연구가 가능합니다.
* 학습 데이터가 부족한 경우 (예: 잎 분할) 모델이 다양한 모양을 학습하는 데 어려움을 겪을 수 있습니다.
* 다른 ConvLSTM 구조, 손실 함수의 변형, 분류 기능 통합, 객체 공존(co-occurrence) 정보 활용 등 다양한 확장 가능성이 있습니다.

## 📌 TL;DR

이 논문은 이미지 내의 개별 객체(인스턴스)를 순차적으로 분할하는 **Recurrent Instance Segmentation (RIS)**이라는 새로운 엔드-투-엔드 패러다임을 제안합니다. **합성곱 LSTM (ConvLSTM)** 기반의 순환 신경망은 **공간 기억**을 활용하여 이미 분할된 영역을 추적하고 가려진 객체를 처리합니다. **헝가리안 알고리즘** 기반의 **원칙적인 손실 함수**는 인스턴스 분할의 순열 불변성 문제를 해결하며 모델 학습을 가능하게 합니다. RIS는 다중 인물 분할과 식물 잎 개수 세기 작업에서 최신 기법들을 뛰어넘는 성능을 입증하며, 인스턴스 분할을 위한 효과적인 엔드-투-엔드 학습 방법을 제시합니다.
