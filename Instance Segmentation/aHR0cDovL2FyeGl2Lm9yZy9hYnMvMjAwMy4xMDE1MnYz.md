# SOLOv2: Dynamic and Fast Instance Segmentation

Xinlong Wang, Rufeng Zhang, Tao Kong, Lei Li, Chunhua Shen

## 🧩 Problem to Solve

기존의 인스턴스 분할(instance segmentation) 방법들은 바운딩 박스(bounding box)에 의존하는 경향이 있어, 픽셀 수준의 정밀한 객체 경계를 표현하는 데 한계가 있었습니다. 최근 제안된 SOLO(Segmenting Objects by LOcations) [1]는 바운딩 박스나 그룹핑 없이 객체 위치 기반으로 마스크를 직접 예측하는 새로운 패러다임을 제시했지만, 다음과 같은 주요 병목 현상이 있었습니다:

1. **비효율적인 마스크 표현 및 학습**: $S^2$ 채널의 큰 출력 텐서 $M$을 직접 예측하는 것은 메모리 및 계산 효율성이 떨어집니다.
2. **낮은 마스크 예측 해상도**: 미세한 객체 경계 처리를 위한 고해상도 마스크 예측이 어려웠습니다.
3. **느린 마스크 NMS (Non-Maximum Suppression)**: 바운딩 박스 NMS에 비해 마스크 NMS는 IoU 계산이 복잡하여 상당한 지연을 초래했습니다.

이 연구는 위 SOLO의 한계점들을 해결하고, 더 강력하고 효율적인 인스턴스 분할 프레임워크를 개발하는 것을 목표로 합니다.

## ✨ Key Contributions

* **동적 인스턴스 마스크 표현 (Dynamic Instance Mask Representation)**: 인스턴스 마스크 생성을 **마스크 커널 예측**과 **마스크 특징 학습**으로 분리하는 새로운 동적 체계를 제안합니다. 이는 네트워크가 입력에 따라 동적으로 컨볼루션 커널을 생성하고, 이를 특징 맵에 적용하여 바운딩 박스 없이 각 인스턴스를 효과적으로 분할합니다. 이는 보다 간결하고 강력한 헤드 설계로 이어지며 더 나은 결과를 달성합니다.
* **고해상도 마스크를 위한 통합 마스크 특징 표현 (Unified High-Resolution Mask Feature Representation)**: 모든 FPN 레벨에 걸쳐 통합된 고해상도 마스크 특징 표현을 학습하여, 객체 경계의 정확도를 크게 향상시켰습니다.
* **매트릭스 NMS (Matrix NMS)**: 기존 NMS의 순차적 처리로 인한 오버헤드를 줄이기 위해, 병렬 행렬 연산으로 NMS를 한 번에 수행하는 새로운 매트릭스 NMS 기술을 개발했습니다. 이는 마스크 AP 손실 없이 속도를 크게 향상시킵니다.
* **최첨단 성능 달성**: 제안된 SOLOv2는 MS COCO 및 LVIS 데이터셋에서 속도와 정확도 면에서 대부분의 최첨단 인스턴스 분할 방법을 능가합니다. 부산물로 생성된 바운딩 박스만으로도 객체 탐지에서 높은 성능을 보이며, Panoptic Segmentation에도 쉽게 확장 가능함을 보여 인스턴스 수준 인식 작업의 강력한 새 기준선이 될 잠재력을 입증했습니다.

## 📎 Related Works

* **인스턴스 분할 (Instance Segmentation)**:
  * **하향식 (Top-down) 방법**: Mask R-CNN [4], TensorMask [7], BlendMask [8]와 같이 객체 탐지 후 분할하는 방식.
  * **상향식 (Bottom-up) 방법**: Associative Embedding [12], SSAP [15] 등 픽셀별 임베딩 학습 후 클러스터링하는 방식.
  * **직접 (Direct) 방법**: SOLO [1]는 박스 탐지나 임베딩 학습 없이 직접 마스크를 예측합니다. 본 논문은 SOLO의 기본 개념을 계승 및 발전시킵니다. YOLACT [2]는 앵커 박스를 기반으로 계수 그룹을 학습합니다.
* **동적 컨볼루션 (Dynamic Convolutions)**: Spatial Transform Networks [16], Dynamic Filter [17], Deformable Convolutional Networks [18]와 같이 입력에 따라 컨볼루션 커널이나 샘플링 위치를 동적으로 예측하는 아이디어. CondInst [21]는 동시 연구로 유사한 동적 방식을 사용하지만, SOLOv2는 전역 좌표를 사용하여 인스턴스 위치 정보를 처리합니다.
* **비최대 억제 (Non-Maximum Suppression, NMS)**: Hard-NMS, Soft-NMS [22], Adaptive NMS [23], Fast NMS [2] 등 객체 탐지 및 인스턴스 분할 시스템의 필수 구성 요소로, 주로 정확도 향상 또는 속도 가속에 초점을 맞춥니다.

## 🛠️ Methodology

SOLOv2는 SOLO의 '위치로 객체 분할하기' 개념을 계승하여 이미지를 $S \times S$ 그리드로 나누고, 각 그리드는 중심이 해당 셀에 속하는 객체의 이진 마스크를 담당합니다. 기존 SOLO의 병목을 해결하기 위해 다음과 같은 개선 사항을 제안합니다.

1. **동적 인스턴스 분할 (Dynamic Instance Segmentation)**:
    * **마스크 커널 $G$ 예측**:
        * 백본 및 FPN에서 얻은 입력 특징 $F_I$를 $S \times S \times C$ 형태로 리사이즈합니다.
        * 4개의 컨볼루션 레이어와 최종 $3 \times 3 \times D$ 컨볼루션 레이어를 사용하여 마스크 커널 $G$를 예측합니다.
        * 첫 번째 컨볼루션에 CoordConv [26]를 따라 정규화된 좌표 채널을 추가하여 공간 기능을 부여합니다.
        * 이 커널들은 위치에 따라 동적으로 생성되며, 다른 FPN 레벨 간에 가중치를 공유합니다.
    * **마스크 특징 $F$ 학습**:
        * **통합 고해상도 마스크 특징 표현** 방식을 채택합니다.
        * P2에서 P5까지의 FPN 특징들을 $3 \times 3$ 컨볼루션, 그룹 정규화(Group Norm), ReLU, $2 \times$ bilinear 업샘플링을 반복하여 1/4 스케일의 단일 출력으로 통합합니다.
        * 가장 깊은 FPN 레벨(1/32 스케일)에 정규화된 픽셀 좌표를 추가하여 정확한 위치 정보를 제공, 인스턴스 인식 특징 예측에 기여합니다.
    * **인스턴스 마스크 생성**: 각 그리드 셀 $(i,j)$에서 얻은 마스크 커널 $G_{i,j,:}$를 통합 마스크 특징 $F$와 컨볼루션하여 최종 인스턴스 마스크를 얻습니다.
2. **매트릭스 NMS (Matrix NMS)**:
    * Soft-NMS [22]에서 영감을 받아, 순차적 처리 없이 병렬 행렬 연산으로 NMS를 수행합니다.
    * **감쇠 계수 계산**: 점수 $s_j$를 가진 마스크 $m_j$가 억제되는 정도를 계산하기 위해, (a) $s_i > s_j$인 다른 마스크 $m_i$가 $m_j$에 가하는 페널티 $f(\text{iou}_{i,j})$와 (b) $m_i$가 억제될 확률 $f(\text{iou}_{\cdot,i})$를 고려합니다.
    * 최종 감쇠 계수는 $\text{decay}_j = \min_{\forall s_i > s_j} \frac{f(\text{iou}_{i,j})}{f(\text{iou}_{\cdot,i})}$로 정의되며, $f$는 선형 또는 가우시안 함수가 될 수 있습니다.
    * **구현**: 상위 $N$개 예측에 대한 $N \times N$ 쌍별 IoU 행렬을 한 번에 계산하고, 모든 연산은 행렬 연산으로 병렬 처리됩니다.

3. **학습 및 추론 (Learning and Inference)**:
    * **손실 함수**: $L = L_{\text{cate}} + \lambda L_{\text{mask}}$ ($L_{\text{cate}}$는 Focal Loss, $L_{\text{mask}}$는 Dice Loss).
    * **추론**: 낮은 신뢰도의 예측을 필터링한 후, 예측된 마스크 커널로 마스크 특징에 컨볼루션 연산을 수행합니다. Sigmoid 활성화 후, 임계값 0.5로 이진 마스크를 얻고 매트릭스 NMS를 적용합니다.

## 📊 Results

* **MS COCO 인스턴스 분할**:
  * **정확도 및 속도**: Res-DCN-101-FPN 백본을 사용하는 SOLOv2는 COCO test-dev에서 41.7% 마스크 AP를 달성하여 SOTA 성능을 기록했습니다. 경량화 버전은 31.3 FPS의 속도로 37.1% 마스크 AP를 달성, 실시간 애플리케이션에 적합함을 보여줍니다.
  * **경계 예측**: Mask R-CNN에 비해 훨씬 더 미세한 마스크, 특히 객체 경계 부분에서 더 높은 품질의 예측을 보여줍니다 (그림 1b).
* **LVISv0.5 인스턴스 분할**: Mask R-CNN 대비 약 1% AP 개선을 보였으며, 특히 대형 객체($\text{AP}_{\text{L}}$)에서 6.7% AP 향상을 달성했습니다.
* **어블레이션 연구 (Ablation Studies)**:
  * **커널 형태**: $1 \times 1 \times 256$ 채널의 커널이 효율적임을 확인했습니다.
  * **명시적 좌표**: 마스크 커널 또는 특징 학습 시 좌표 정보를 명시적으로 입력하면 AP가 1.5% 향상되었습니다.
  * **통합 마스크 특징 표현**: 분리된 표현 방식보다 더 나은 결과를 보였으며, 특히 중간 및 대형 객체에서 강점을 가집니다.
  * **매트릭스 NMS**: 기존 NMS보다 9배 빠르며 (500개 마스크 처리 1ms 미만), Fast NMS보다 0.4% AP 더 높은 정확도를 달성했습니다.
* **확장성 (Object Detection 및 Panoptic Segmentation)**:
  * **객체 탐지 (Object Detection)**: 예측된 마스크를 바운딩 박스로 직접 변환하여 COCO test-dev에서 44.9% AP를 달성, 많은 최첨단 객체 탐지 방법을 능가했습니다.
  * **Panoptic Segmentation**: 시맨틱 분할 브랜치를 추가하여 COCO val2017에서 42.1% PQ를 달성, 다른 box-free 방법들을 크게 앞질렀습니다.

## 🧠 Insights & Discussion

SOLOv2는 인스턴스 분할에 대한 간단하고 빠르며 강력한 해결책을 제시합니다. 바운딩 박스 탐지에 대한 의존성을 제거하고, 동적 커널 학습과 통합 마스크 특징 표현을 통해 효율적인 고해상도 마스크 예측이 가능해졌습니다. 특히, 병렬 행렬 연산을 활용한 Matrix NMS는 추론 속도 저하 없이 NMS 과정을 가속화하여 전체 시스템의 실시간성을 확보했습니다.

본 연구의 결과는 인스턴스 분할이 객체 바운딩 박스 탐지의 강력한 대안이 될 수 있음을 시사하며, 자율 주행, 의료 영상 분석, 증강 현실 등 다양한 응용 분야에서 넓은 활용 가능성을 보여줍니다. 또한, SOLOv2의 단순성(proposal-free, anchor-free, FCN-like)과 높은 성능은 향후 인스턴스 인식 연구를 위한 강력한 기준선이 될 것으로 기대됩니다. 아직 개선의 여지가 많으며, 그 잠재력을 최대한 활용하기 위한 후속 연구가 장려됩니다.

## 📌 TL;DR

**문제**: 기존 인스턴스 분할 방법은 바운딩 박스에 의존적이거나, 직접 분할 방식(SOLO)은 마스크 표현 및 NMS에서 비효율성을 가짐.
**방법**: SOLOv2는 마스크 커널 예측과 마스크 특징 학습을 분리하는 **동적 인스턴스 마스크 표현**과 빠르고 병렬적인 **매트릭스 NMS**를 제안. 명시적 좌표 정보를 활용한 통합 고해상도 마스크 특징 표현을 도입.
**발견**: MS COCO에서 SOTA 정확도(41.7% AP)와 실시간 속도(31.3 FPS)를 달성. 기존 방법(Mask R-CNN 등) 대비 더 미세한 마스크 예측 및 뛰어난 성능을 보이며, 객체 탐지와 Panoptic Segmentation에서도 강력한 확장성을 입증.
