# BoxInst: High-Performance Instance Segmentation with Box Annotations

Zhi Tian, Chunhua Shen, Xinlong Wang, Hao Chen

## 🧩 Problem to Solve

인스턴스 분할(Instance Segmentation)은 이미지 내의 각 객체 인스턴스에 대해 픽셀 단위의 마스크와 클래스 레이블을 예측하는 중요한 컴퓨터 비전 태스크입니다. 하지만 이 태스크는 픽셀 단위의 정밀한 마스크 주석(annotation)이 필요하며, 이는 바운딩 박스(bounding box) 주석에 비해 훨씬 많은 시간과 비용을 요구합니다. 기존의 박스 기반 약지도(weakly-supervised) 인스턴스 분할 방법들은 느린 훈련 과정, 복잡한 파이프라인, 그리고 COCO와 같은 대규모 데이터셋에서의 저조한 성능으로 인해 실용성이 낮았습니다. 본 논문은 마스크 주석 없이도 높은 품질의 인스턴스 마스크를 효율적으로 생성하는 방법을 목표로 합니다.

## ✨ Key Contributions

* **새로운 마스크 손실 함수 설계**: 마스크 주석 없이 마스크를 학습할 수 있는 두 가지 핵심 손실 항, 즉 `Projection Loss`와 `Pairwise Affinity Loss`를 제안합니다.
* **간결하고 효율적인 디자인**: 기존의 완전 컨볼루션 인스턴스 분할 프레임워크인 CondInst의 네트워크 모델을 수정하지 않고, 단순히 마스크 손실 함수만 대체합니다. 이는 CondInst의 모든 이점(빠른 추론 속도 등)을 계승합니다.
* **획기적인 성능 향상**: 마스크 주석 없이 COCO 데이터셋에서 33.2% mask AP를 달성하여, 이전의 약지도 방식(21.1%)을 10% 이상 대폭 개선했으며, 일부 완전 지도 방식보다도 우수한 성능을 보입니다.
* **성능 격차 해소**: 완전 지도 인스턴스 분할과 박스 기반 약지도 인스턴스 분할 간의 성능 격차를 크게 줄여, 약지도 인스턴스 분할의 잠재력을 강력하게 보여줍니다.
* **다양한 활용 가능성**: 반지도 학습(semi-supervised learning) 설정 및 문자 분할(character segmentation)과 같은 다양한 응용 분야에서 마스크 주석 없이 고품질 마스크를 생성할 수 있음을 입증합니다.

## 📎 Related Works

* **박스 기반 의미론적 분할(Box-supervised Semantic Segmentation)**:
  * **BoxSup [6]**, **Box2Seg [18]** 등은 MCG [22]나 GrabCut [24] 같은 비지도 방법을 통해 생성된 의사 레이블(pseudo labels)에 의존합니다. 이는 훈련이 느리고 복잡하다는 단점이 있습니다.
* **박스 기반 인스턴스 분할(Box-supervised Instance Segmentation)**:
  * **SDI [16]**는 MCG의 지역 제안에 의존하며, 반복 훈련을 통해 결과를 개선합니다.
  * **BBTP [12]**는 다중 인스턴스 학습(MIL) 문제로 접근하며 Mask R-CNN을 기반으로 합니다. Pairwise Loss를 사용하지만, 픽셀 간 색상 유사성을 활용하지 않아 노이즈에 취약합니다.
* **완전 지도 인스턴스 분할(Fully-supervised Instance Segmentation)**:
  * **Mask R-CNN [10]**, **YOLACT [3]**, **PolarMask [31]** 등이 있으며, 이 중 **CondInst [27]**는 RoI-free의 동적 필터를 활용하는 완전 컨볼루션 방식으로, BoxInst의 기반 모델입니다.

## 🛠️ Methodology

BoxInst는 CondInst [27] 프레임워크를 기반으로 하며, 기존의 픽셀 단위 마스크 손실을 마스크 주석 없이 작동하는 두 가지 새로운 손실 항으로 대체합니다.

1. **CondInst (Conditional Convolutions for Instance Segmentation)**
    * 각 인스턴스에 따라 마스크 헤드의 가중치를 동적으로 조정하는 동적 필터 [15]를 사용하여 RoI(Region of Interest) 연산 없이 전체 이미지 마스크를 생성합니다.
    * 마스크 헤드는 클래스 불가지론적 마스크를 예측하며, 클래스는 별도의 검출 브랜치에서 결정됩니다. BoxInst는 CondInst의 이 구조를 그대로 활용합니다.

2. **Projection Loss ($L_{proj}$)**
    * 예측된 마스크($\tilde{m} \in (0,1)^{H \times W}$)의 수평 및 수직 투영을 Ground-Truth 바운딩 박스의 투영과 일치시키는 것을 목표로 합니다.
    * Ground-Truth 박스 $b_{b} \in \{0,1\}^{H \times W}$ (박스 내부 1, 외부 0)의 투영 $l_x$, $l_y$는 다음과 같이 정의됩니다:
        $$Proj_x(b_{b}) = \max_y(b_{b}) = l_x$$
        $$Proj_y(b_{b}) = \max_x(b_{b}) = l_y$$
    * 예측 마스크 $\tilde{m}$에 대해서도 동일하게 $\tilde{l}_x$, $\tilde{l}_y$를 계산하고, 이들 간의 불일치를 Dice Loss $L(\cdot, \cdot)$로 최소화합니다:
        $$L_{proj} = L(\tilde{l}_x, l_x) + L(\tilde{l}_y, l_y)$$
    * 이 손실은 예측 마스크를 감싸는 가장 작은 바운딩 박스가 Ground-Truth 박스와 일치하도록 유도합니다.

3. **Pairwise Affinity Loss ($L_{pairwise}$)**
    * 마스크 주석이 없을 때, 인접 픽셀 간의 색상 유사성이 높으면 동일한 레이블을 가질 가능성이 높다는 핵심 아이디어를 활용합니다.
    * 이미지의 픽셀들을 노드로 하는 그래프에서 각 픽셀은 $K \times K - 1$ 이웃 픽셀(팽창된(dilated) 이웃 포함)과 연결됩니다.
    * 두 픽셀 $(i,j)$와 $(l,k)$가 에지 $e$로 연결되어 있을 때, $y_e=1$ (같은 레이블)일 확률 $P(y_e=1)$을 예측 마스크 $\tilde{m}_{i,j}$, $\tilde{m}_{k,l}$로 다음과 같이 계산합니다:
        $$P(y_e=1) = \tilde{m}_{i,j} \cdot \tilde{m}_{k,l} + (1-\tilde{m}_{i,j}) \cdot (1-\tilde{m}_{k,l})$$
    * 마스크 주석이 없으므로, Ground-Truth $y_e$는 픽셀 쌍의 색상 유사도 $S_e$를 통해 추정됩니다. $S_e$는 LAB 색 공간에서 두 픽셀의 색상 벡터 $c_{i,j}, c_{l,k}$의 차이를 기반으로 계산됩니다:
        $$S_e = S(c_{i,j}, c_{l,k}) = \exp \left( -\frac{||c_{i,j} - c_{l,k}||}{\theta} \right)$$
    * 색상 유사도 $S_e$가 임계값 $\tau$ 이상일 때만 에지 $e$의 레이블을 1로 간주하여 이진 교차 엔트로피 손실에 적용합니다. 이렇게 하면 노이즈가 적은 신뢰할 수 있는 픽셀 쌍만 학습에 사용됩니다:
        $$L_{pairwise} = -\frac{1}{N} \sum_{e \in E_{in}} \mathbb{1}_{\{S_e \geq \tau\}} \log P(y_e=1)$$
        여기서 $E_{in}$은 Ground-Truth 박스 내 픽셀을 포함하는 에지들의 집합이며, $\mathbb{1}_{\{S_e \geq \tau\}}$는 $S_e \geq \tau$일 때 1, 아니면 0인 지시 함수입니다.
    * 최종 마스크 손실 $L_{mask} = L_{proj} + L_{pairwise}$를 사용하여 모델을 훈련합니다.

## 📊 Results

* **COCO 데이터셋 성능**:
  * ResNet-101 백본으로 3배 훈련 스케줄 시, 마스크 주석 없이 COCO `test-dev`에서 **33.2% mask AP**를 달성했습니다.
  * 이는 이전 최고 약지도 방식인 BBTP [12]의 21.1% mask AP를 10% 이상 뛰어넘는 수치입니다.
  * 또한 YOLACT [3] (31.2% AP) 및 PolarMask [31] (32.1% AP)와 같은 일부 완전 지도 방식보다도 우수합니다.
  * 완전 지도 CondInst (39.1% AP)와의 성능 격차를 약 6% 차이로 크게 줄였습니다.
  * BiFPN [26] 및 DCN [34]을 활용 시 35.0% mask AP까지 성능을 향상시켰습니다.
* **Pascal VOC 데이터셋 성능**:
  * Pascal VOC `val2012`에서 ResNet-101 백본으로 **36.5% mask AP**를 달성하여 이전 최고 방식들을 크게 능가했습니다. 특히 $AP_{75}$는 17.1%에서 37.0%로 200% 이상 향상되어 마스크 품질의 대폭 개선을 입증했습니다.
  * 전통적인 비지도 분할 방법인 GrabCut [24] (19.0% mask AP)보다 훨씬 우수하며, 추론 속도도 크게 빠릅니다.
* **손실 항별 기여도**:
  * Projection Loss($L_{proj}$)만 사용해도 COCO `val2017`에서 21.2% mask AP를 달성하여, 바운딩 박스 마스크(10.6% mask AP)보다 훨씬 높은 정밀도를 보였습니다.
  * Pairwise Affinity Loss($L_{pairwise}$)를 추가하면 성능이 30.7% mask AP로 크게 향상되었습니다.
* **하이퍼파라미터 영향**:
  * Pairwise Loss의 색상 유사도 임계값 $\tau$: $\tau=0.1$에서 가장 좋은 성능(30.7% mask AP)을 보였으며, 너무 낮으면 노이즈가 많고 너무 높으면 감독되는 픽셀 쌍이 줄어들어 성능이 저하되었습니다.
  * 이웃 픽셀의 범위와 팽창률(dilation rate): $3 \times 3$ 패치에 팽창률 2를 적용하는 것이 계산 오버헤드 없이 장거리 픽셀 관계를 포착하여 30.7% mask AP로 좋은 성능을 보였습니다.
* **확장 실험**:
  * **반지도 인스턴스 분할**: 20개 클래스 마스크 주석과 60개 클래스 박스 주석이 혼합된 환경에서 미등록 클래스에 대해 30.9% mask AP를 달성하여, 부분적인 마스크 주석이 박스 지도 학습에 긍정적인 영향을 줌을 확인했습니다.
  * **문자 분할**: ICDAR 2019 ReCTS 데이터셋의 문자 박스 주석만으로 고품질 문자 마스크를 성공적으로 생성함을 시각적으로 입증하여, BoxInst의 일반성을 보여주었습니다.

## 🧠 Insights & Discussion

BoxInst는 마스크 주석 없이도 완전 지도 방식에 필적하는 고품질 인스턴스 마스크를 생성할 수 있음을 입증하며, "인스턴스 분할은 박스 검출보다 훨씬 어렵다"는 기존의 인식을 뒤집는 중요한 통찰을 제공합니다. 이는 약지도 인스턴스 분할의 막대한 잠재력을 처음으로 강력하게 보여준 결과입니다.

본 논문의 핵심 강점은 **간결한 디자인**에 있습니다. 복잡한 의사 레이블 생성이나 반복 훈련 없이, 기존 CondInst 네트워크를 전혀 변경하지 않고 손실 함수만 재설계함으로써 높은 효율성과 성능을 동시에 달성했습니다. 이는 CondInst의 빠른 추론 속도를 그대로 계승한다는 이점도 있습니다.

제안된 **두 가지 손실 함수**는 상호 보완적으로 작동합니다. `Projection Loss`는 예측 마스크의 전체적인 윤곽과 크기가 Ground-Truth 박스와 일치하도록 유도하며, `Pairwise Affinity Loss`는 인접 픽셀의 색상 유사도를 활용하여 마스크 경계를 픽셀 수준에서 정교하게 다듬는 데 결정적인 역할을 합니다. 특히, 신뢰할 수 있는 픽셀 쌍만을 선별하여 노이즈를 효과적으로 줄인 전략이 성공의 열쇠임을 보여줍니다.

BoxInst는 **다양한 다운스트림 태스크에 활용될 잠재력**이 큽니다. 추가적인 마스크 주석 비용 없이 픽셀 단위의 정확한 객체 위치 정보를 제공할 수 있으므로, 로봇의 객체 파지, 텍스트 인식에서의 문자 마스크 생성 등 여러 분야의 성능을 향상시킬 수 있습니다. 또한, 완전 지도 학습을 위한 마스크 주석 데이터를 자동으로 생성하는 데도 활용될 수 있습니다.

## 📌 TL;DR

BoxInst는 마스크 주석 없이 고성능 인스턴스 분할을 달성하는 새로운 방법입니다. Ground-Truth 박스와 예측 마스크의 투영을 일치시키는 **Projection Loss**와 색상 유사성을 기반으로 인접 픽셀 간 레이블 일관성을 강제하는 **Pairwise Affinity Loss**를 핵심으로 하여, CondInst 프레임워크에 적용합니다. 이 간단한 설계로 BoxInst는 COCO에서 33.2% mask AP를 기록, 약지도 인스턴스 분할의 기존 최고 성능을 크게 뛰어넘고 완전 지도 방식에 준하는 결과를 보여주며, 마스크 주석 없이 고품질 마스크를 얻을 수 있는 강력한 잠재력을 입증했습니다.
