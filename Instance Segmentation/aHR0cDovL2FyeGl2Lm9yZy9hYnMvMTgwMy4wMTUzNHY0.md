# Path Aggregation Network for Instance Segmentation

Shu Liu, Lu Qi, Haifang Qin, Jianping Shi, Jiaya Jia

## 🧩 Problem to Solve

신경망에서 정보가 전파되는 방식은 인스턴스 분할(Instance Segmentation) 성능에 중요한 영향을 미칩니다. Mask R-CNN과 FPN(Feature Pyramid Network) 기반의 기존 인스턴스 분할 프레임워크는 다음과 같은 문제점을 가지고 있습니다:

1. **정보 전달 경로의 길이:** 정확한 위치 정보가 풍부한 하위 계층 특징이 최상위 특징에 도달하는 경로가 길어, 하위 계층 정보에 접근하기 어렵습니다. 이는 특히 큰 인스턴스를 정확하게 식별하고 현지화하는 데 어려움을 초래합니다.
2. **휴리스틱한 특징 풀링:** 각 제안(proposal)은 휴리스틱하게 할당된 단일 특징 레벨에서만 특징 그리드를 풀링합니다. 이로 인해 다른 특징 레벨에 존재하는 유용한 정보가 버려질 수 있습니다.
3. **단일 관점의 마스크 예측:** 마스크 예측은 주로 FCN(Fully Convolutional Network)을 통해 단일 관점에서 이루어져, 더 다양하고 전역적인 정보(fully-connected layer가 제공할 수 있는)를 활용할 기회를 놓칩니다.

## ✨ Key Contributions

이 논문은 인스턴스 분할 프레임워크에서 정보 흐름을 개선하기 위한 Path Aggregation Network (PANet)을 제안하며, 다음과 같은 주요 기여를 합니다:

* **하향식 경로 증강(Bottom-up Path Augmentation) 도입:** 하위 계층의 정확한 현지화 신호를 전체 특징 계층으로 전달하는 새로운 하향식 경로를 생성하여 정보 경로를 단축하고 특징 피라미드를 강화합니다.
* **적응형 특징 풀링(Adaptive Feature Pooling) 제안:** 각 제안이 모든 특징 레벨에서 정보를 직접 풀링하고 융합할 수 있도록 하여, 제안과 모든 특징 레벨 간의 정보 경로를 복구하고 유용한 정보를 효과적으로 활용합니다.
* **완전 연결 융합(Fully-connected Fusion) 추가:** 마스크 예측에 FCN과 상호보완적인 역할을 하는 작은 완전 연결(FC) 레이어를 추가하여, 제안에 대한 다양한 관점을 포착하고 마스크 예측의 품질을 향상시킵니다.
* **최고 성능 달성:** COCO 2017 Challenge 인스턴스 분할 태스크에서 1위, 객체 탐지 태스크에서 2위를 달성했습니다. MVD 및 Cityscapes에서도 최신(state-of-the-art) 성능을 보여주었습니다.
* **간단한 구현 및 효율성:** 제안된 개선 사항들은 구현이 간단하며, 계산 오버헤드가 미미합니다.

## 📎 Related Works

* **인스턴스 분할(Instance Segmentation):**
  * **제안 기반(Proposal-based) 방법:** R-CNN, Fast/Faster R-CNN, SPPNet, MNC, Mask R-CNN 등 객체 탐지에서 파생된 접근법. 본 논문은 Mask R-CNN을 기반으로 개선합니다.
  * **분할 기반(Segmentation-based) 방법:** 특별히 설계된 변환(e.g., SGN, Deep Watershed Transform)을 학습하거나 인스턴스 경계(e.g., InstanceCut)를 예측하는 방법.
* **다단계 특징(Multi-level Features):**
  * FCN, U-Net, SharpMask, LRR과 같이 세밀한 분할을 위해 하위 계층 특징을 융합하는 방법.
  * TDM, FPN, SSD, DSSD, MS-CNN과 같이 객체 탐지를 위해 하향식 경로와 측면 연결을 사용하는 방법. 본 논문은 FPN을 baseline으로 삼아 강화합니다.
  * ION, Hypernet, Hypercolumn과 같이 여러 계층에서 특징 그리드를 연결하는 방법.
* **더 넓은 문맥 영역(Larger Context Region):** PSPNet, ParseNet과 같이 전역 풀링 또는 다해상도 특징 풀링을 사용하여 문맥 정보를 활용하는 방법.

## 🛠️ Methodology

PANet은 Mask R-CNN 및 FPN 기반 아키텍처를 개선하기 위해 세 가지 핵심 구성 요소를 통합합니다:

1. **하향식 경로 증강 (Bottom-up Path Augmentation):**
    * FPN에서 생성된 특징 레벨 {$P_2, P_3, P_4, P_5$}를 사용하여 새로운 하향식 경로 {$N_2, N_3, N_4, N_5$}를 구축합니다.
    * $N_2$는 단순히 $P_2$입니다.
    * 각 빌딩 블록에서, 높은 해상도의 특징 맵 $N_i$를 $3 \times 3$ 컨볼루션 레이어 (stride 2)를 통과시켜 공간 크기를 줄입니다.
    * 이 다운샘플링된 맵과 $P_{i+1}$ (측면 연결)의 요소를 element-wise sum으로 더합니다.
    * 융합된 특징 맵은 다른 $3 \times 3$ 컨볼루션 레이어를 통해 $N_{i+1}$로 처리되어 다음 하위 네트워크로 전달됩니다.
    * 이 과정은 $P_5$에 도달할 때까지 반복됩니다. 이 경로는 하위 계층에서 최상위 계층까지의 정보 경로를 10개 미만의 레이어로 단축시킵니다.

2. **적응형 특징 풀링 (Adaptive Feature Pooling):**
    * 각 제안에 대해 FPN과 유사하게 바운딩 박스를 모든 특징 레벨 {$N_2, N_3, N_4, N_5$}에 매핑합니다.
    * Mask R-CNN의 ROIAlign을 사용하여 각 레벨에서 특징 그리드를 풀링합니다.
    * 풀링된 특징 그리드는 독립적인 파라미터 레이어를 통과한 다음, 융합 연산(element-wise max 또는 sum)을 통해 다른 레벨의 특징 그리드와 융합됩니다.
    * 이 융합된 특징 그리드가 분류, 박스 회귀 및 마스크 예측을 위한 최종 제안 특징으로 사용됩니다. 이는 네트워크가 모든 레벨의 유용한 정보를 유연하게 선택하도록 합니다.

3. **완전 연결 융합 (Fully-connected Fusion):**
    * 마스크 예측 브랜치는 작은 FCN(4개의 컨볼루션 레이어와 1개의 디컨볼루션 레이어)을 기본 경로로 사용합니다.
    * 여기에 FCN의 `conv3` 레이어에서 시작하는 보완적인 짧은 경로를 추가합니다. 이 경로는 두 개의 $3 \times 3$ 컨볼루션 레이어와 한 개의 FC 레이어로 구성됩니다.
    * FC 레이어는 클래스 불가지론적(class-agnostic) 전경/배경 마스크를 예측합니다.
    * FCN에서 예측된 각 클래스의 마스크와 FC 레이어에서 예측된 전경/배경 마스크는 element-wise sum을 통해 최종 마스크 예측을 생성합니다.
    * FC 레이어는 전역 정보와 위치 민감성을 제공하여 FCN의 지역적이고 파라미터 공유적인 특성을 보완합니다.

## 📊 Results

* **COCO 2017 Challenge 성과:**
  * 인스턴스 분할 태스크 1위, 객체 탐지 태스크 2위를 달성했습니다 (대규모 배치 훈련 없이).
  * ResNet-50 backbone으로 훈련된 PANet은 multi-scale 훈련 및 단일 스케일 테스트 조건에서 Mask R-CNN 및 COCO 2016 챔피언보다 뛰어난 성능을 보였습니다.
  * COCO 2016 챔피언 대비 인스턴스 분할에서 절대 `$9.1\%$`p, 객체 탐지에서 절대 `$9.4\%$`p 향상을 달성했습니다.
* **다른 데이터셋에서의 SOTA:** Cityscapes 및 MVD 데이터셋에서도 상위권의 결과를 기록하며, PANet의 실용성과 성능을 입증했습니다.
* **구성 요소별 효과 분석 (Ablation Study):**
  * **하향식 경로 증강 (BPA):** 마스크 `$AP$`와 박스 `$AP_{bb}$`를 각각 `$0.6$`점, `$0.9$`점 이상 향상시켰으며, 특히 대형 인스턴스에서 가장显著한 개선을 보였습니다.
  * **적응형 특징 풀링 (AFP):** 모든 스케일의 인스턴스에서 전반적인 성능 향상을 가져왔으며, 여러 계층의 특징이 최종 예측에 유용하다는 것을 확인했습니다.
  * **완전 연결 융합 (FF):** 마스크 `$AP$`를 `$0.7$`점 향상시키며, 마스크 품질 개선에 기여했습니다.
  * **추가 요인:** Multi-scale training 및 Multi-GPU synchronized batch normalization도 모델의 수렴과 일반화 능력 향상에 크게 기여했습니다 (전체 개선의 절반).
  * 모든 구성 요소를 포함한 PANet은 baseline 대비 마스크 `$AP$`에서 `$4.4$`점, 독립적으로 훈련된 객체 탐지기의 박스 `$AP_{bb}$`에서 `$4.2$`점 향상을 보였습니다.

## 🧠 Insights & Discussion

* **향상된 정보 흐름의 중요성:** PANet은 저수준 특징의 정확한 현지화 신호를 효과적으로 활용하고, 모든 제안이 다양한 특징 레벨에서 풍부한 정보를 얻도록 함으로써 신경망 내 정보 흐름의 중요성을 강조합니다.
* **다중 관점의 보완성:** 마스크 예측에서 FCN과 FC 레이어를 융합하는 전략은 각 방법론이 제공하는 상이한 정보(FCN의 지역적이고 공유된 패턴 인식 대 FC의 전역적이고 위치 민감한 정보)가 서로를 보완하여 예측 품질을 높일 수 있음을 보여줍니다.
* **실용적인 효율성:** 제안된 구성 요소들은 최소한의 추가 계산 비용으로 상당한 성능 향상을 제공하여, PANet이 다양한 실제 적용 시나리오에서 매우 실용적인 프레임워크임을 증명합니다.
* **일반화 능력:** COCO, Cityscapes, MVD와 같은 다양한 데이터셋에서 일관되게 최고 수준의 성능을 달성함으로써, PANet의 설계 원칙이 광범위한 인스턴스 분할 및 객체 탐지 시나리오에 걸쳐 일반화될 수 있음을 시사합니다.
* **향후 연구 방향:** 논문은 PANet을 비디오 및 RGBD 데이터로 확장하는 것을 향후 연구로 언급하며, 현재의 이미지 기반 연구에서 더욱 동적인 환경으로의 확장을 모색합니다.

## 📌 TL;DR

**문제점:** 기존 인스턴스 분할 모델은 하위 계층 특징에 대한 정보 경로가 길고, 제안별 특징 풀링이 단일 레벨에 국한되며, 마스크 예측이 단일 관점에서 이루어져 정확한 현지화 및 다양항 정보 활용에 한계가 있었습니다.
**제안 방법:** PANet은 이 문제들을 해결하기 위해 1) 하위 계층의 정확한 위치 신호를 상위 계층으로 직접 전달하는 **하향식 경로 증강**, 2) 각 제안이 모든 특징 레벨에서 정보를 취합할 수 있는 **적응형 특징 풀링**, 그리고 3) FCN과 상호보완적인 FC 레이어를 사용하여 마스크 예측의 다양성을 높이는 **완전 연결 융합**을 도입했습니다.
**주요 결과:** PANet은 COCO 2017 인스턴스 분할 챌린지에서 1위, 객체 탐지 챌린지에서 2위를 차지하며 최첨단 성능을 달성했습니다. 이 모델은 적은 계산 오버헤드로 정보 흐름과 예측 품질을 크게 개선하여 다양한 데이터셋에서 뛰어난 일반화 능력을 보여주었습니다.
