# 판별 손실 함수를 이용한 의미론적 인스턴스 분할

Bert De Brabandere, Davy Neven, Luc Van Gool

## 🧩 Problem to Solve

의미론적 인스턴스 분할(Semantic instance segmentation)은 이미지 내 개별 객체에 대해 이진 분할 마스크와 의미론적 레이블을 생성하는 어려운 작업입니다. 특히, 이미지에 포함될 수 있는 인스턴스 개수가 가변적이고 라벨링이 순열 불변(permutation-invariant)이기 때문에, 픽셀 단위 소프트맥스(softmax) 손실 함수를 사용하는 기존의 의미론적 분할(semantic segmentation) 아키텍처를 인스턴스 분할에 직접 적용하기 어렵습니다. 현재 대부분의 딥러닝 기반 인스턴스 분할 방법은 객체 제안(object proposal)이나 순환 메커니즘(recurrent mechanisms)을 사용하는 다단계 파이프라인에 의존하며, 이는 복잡성을 증가시킵니다.

## ✨ Key Contributions

* 픽셀 수준에서 작동하는 판별 손실 함수(discriminative loss function)를 제안하여, 컨볼루션 네트워크가 간단한 후처리 단계만으로 쉽게 인스턴스로 군집화될 수 있는 특징 공간(feature space) 표현을 생성하도록 유도합니다.
* 객체 제안(object proposals)이나 순환 메커니즘 없이 개념적으로 간단하면서도 효과적인 인스턴스 분할 접근 방식을 제시합니다.
* 인기 있는 "탐지 후 분할(detect-and-segment)" 접근 방식이 겪는 한계(예: 복잡한 폐색(occlusions) 상황 처리의 어려움)를 본 방법이 극복할 수 있음을 입증합니다.
* Cityscapes 및 CVPPP 잎 분할 벤치마크에서 기존의 복잡한 방법들과 대등하거나 경쟁력 있는 성능을 달성합니다.

## 📎 Related Works

* **제안 기반(Proposal-based) 방법:** MCG, MNC(Multi-task Network Cascades), Mask R-CNN과 같이 객체 제안 및 분류 단계를 포함하는 다단계 파이프라인을 사용합니다. 경계 상자(bounding box) 정보에 의존하여 복잡한 폐색 상황에서 분할 마스크를 명확하게 추출하기 어렵다는 한계가 있습니다.
* **순환(Recurrent) 방법:** RNN(Recurrent Neural Networks), LSTM(Long Short-Term Memory) 등을 사용하여 개별 인스턴스를 순차적으로 생성합니다. 종종 순열 불변성을 위해 헝가리안 알고리즘(Hungarian algorithm)을 포함하여 복잡한 구성을 가집니다.
* **군집화(Clustering) 기반 방법:** 이미지를 후속 군집화될 수 있는 표현으로 변환합니다 (예: 분할 트리, 깊이 정렬, 인스턴스 중심 방향 예측, 경계 상자 특징 예측). 본 연구의 방법은 이러한 기존 군집화 기반 방법들보다 덜 임시적(ad-hoc)이며, 네트워크 출력 표현에 특정 제약을 가하지 않습니다.
* **손실 함수:** 거리 메트릭 학습(distance metric learning), 판별 손실 함수, 샴 네트워크(Siamese networks) (예: Triplet loss, Large Margin Nearest Neighbor)에서 영감을 받았습니다. 기존 연구들이 데이터셋 내 이미지 간의 거리를 최적화하는 반면, 본 연구는 이미지 내 **개별 픽셀** 간의 거리를 최적화하는 데 초점을 맞춥니다.

## 🛠️ Methodology

본 연구는 각 픽셀을 $n$-차원 특징 공간의 한 지점(픽셀 임베딩)으로 매핑하는 미분 가능한 함수를 학습합니다. 핵심 아이디어는 동일한 인스턴스에 속하는 픽셀 임베딩은 서로 가깝게, 다른 인스턴스에 속하는 픽셀 임베딩은 서로 멀리 떨어지도록 만드는 것입니다.

1. **판별 손실 함수 ($L$):** 세 가지 항으로 구성됩니다.
    * **분산 항 ($L_{var}$):** 클러스터 내 당김 힘(intra-cluster pull-force)을 생성하여, 각 임베딩 $x_i$가 해당 클러스터의 평균 임베딩 $\mu_c$ (클러스터 중심)에 가깝게 위치하도록 합니다. 마진 $\delta_v$를 사용하여, 특정 거리 내의 임베딩은 더 이상 당김 힘을 받지 않도록 합니다.
        $$L_{var} = \frac{1}{C}\sum_{c=1}^{C} \frac{1}{N_c}\sum_{i=1}^{N_c} \left[ \left\| \mu_c - x_i \right\| - \delta_v \right]_{+}^{2}$$
    * **거리 항 ($L_{dist}$):** 클러스터 간 밀어내기 힘(inter-cluster push-force)을 생성하여, 서로 다른 클러스터 중심 $\mu_{c_A}$와 $\mu_{c_B}$ 간의 거리를 증가시킵니다. 마진 $2\delta_d$를 사용하여, 특정 거리 이상 떨어져 있는 클러스터 중심은 더 이상 밀어내기 힘을 받지 않도록 합니다.
        $$L_{dist} = \frac{1}{C(C-1)}\sum_{c_A=1}^{C}\sum_{c_B=1, c_A \neq c_B}^{C} \left[ 2\delta_d - \left\| \mu_{c_A} - \mu_{c_B} \right\| \right]_{+}^{2}$$
    * **정규화 항 ($L_{reg}$):** 모든 클러스터 중심을 원점(origin)으로 당겨 특징 공간의 활성화 값을 제한합니다.
        $$L_{reg} = \frac{1}{C}\sum_{c=1}^{C} \left\| \mu_c \right\|$$
    * **총 손실:** $L = \alpha \cdot L_{var} + \beta \cdot L_{dist} + \gamma \cdot L_{reg}$로 정의됩니다. (실험에서는 $\alpha=\beta=1, \gamma=0.001$로 설정)
2. **네트워크 아키텍처:** 의미론적 분할을 위해 설계된 ResNet-38과 같은 기존의 컨볼루션 신경망을 재사용합니다.
3. **후처리:**
    * 학습된 네트워크 출력은 픽셀 임베딩의 집합입니다. 만약 $\delta_d > \delta_v$ 조건이 만족되면, 각 임베딩은 다른 클러스터 중심보다 자체 클러스터 중심에 더 가깝게 위치하게 됩니다.
    * 추론 시, 레이블이 지정되지 않은 픽셀을 하나 선택하고, 해당 임베딩을 중심으로 임계값(thresholding)을 적용하여 동일 인스턴스에 속하는 모든 픽셀을 찾은 후 동일한 레이블을 할당합니다. 모든 픽셀에 레이블이 지정될 때까지 이 과정을 반복합니다.
    * 군집화의 견고성을 높이기 위해 평균-이동(mean-shift) 알고리즘의 빠른 변형을 적용하여 이상치(outlier)의 영향을 줄입니다.

## 📊 Results

* **CVPPP 잎 분할 데이터셋:** SBD(Symmetric Best Dice) 84.2, |DiC|(Absolute Difference in Count) 1.0을 기록하며, 최신 기술(SBD 84.9, |DiC| 0.8)과 대등한 성능을 달성했습니다. 기존의 비-딥러닝 및 순환 방식보다 우수함을 보였습니다.
* **Cityscapes 인스턴스 수준 의미론적 라벨링 데이터셋:** AP(Average Precision) 17.5, AP0.5 35.9를 달성하여 경쟁력 있는 성능을 보였습니다. Mask R-CNN과 같은 최신 제안 기반 방식을 제외한 대부분의 이전 연구보다 우수한 결과를 보였습니다.
* **개별 구성 요소 분석:**
  * 의미론적 분할(semantic segmentation) 마스크의 품질이 전체 인스턴스 분할 성능에 큰 영향을 미치는 것으로 나타났습니다. (ResNet-38 예측 마스크 사용 시 $AP_{mean-shift}$ 21.4 → Ground Truth 마스크 사용 시 $AP_{mean-shift}$ 37.5)
  * 군집화 방법론 또한 성능에 영향을 미치며, 평균-이동(mean-shift) 클러스터링을 Ground Truth 클러스터 중심 임계값(center threshold) 클러스터링으로 대체할 경우 성능 향상의 여지가 있음을 확인했습니다.
* **속도-정확도 트레이드오프:** 다양한 네트워크 아키텍처(ENet, SegNet, Dilation, ResNet-38)를 테스트한 결과, ResNet-38이 가장 높은 정확도를 제공했으며, ENet은 SegNet과 유사한 정확도로 훨씬 빠른 속도를 보였습니다. 후처리 단계는 무시할 수 있는 수준의 오버헤드만 발생합니다.

## 🧠 Insights & Discussion

* **강점:** 본 방법은 기존 "탐지 후 분할(detect-and-segment)" 접근 방식이 경계 상자(bounding box)의 복잡한 중첩으로 인해 명확한 분할 마스크를 추출하기 어려운 "복잡한 폐색(complex occlusions)" 상황(예: 겹쳐진 막대기)에서 탁월한 성능을 보입니다. 이는 이미지를 전체적으로(holistically) 처리하고 폐색에 대해 추론하도록 학습하기 때문입니다. 이러한 강점은 산업 및 의료 분야의 실제 응용(컨베이어 벨트 정렬 시스템, 겹쳐진 세포 및 염색체 분할 등)에서 특히 유용합니다.
* **한계:** 객체가 임의의 배열과 다양한 설정으로 나타나는 데이터셋(예: Pascal VOC, MSCOCO)에서는 슬라이딩-윈도우(sliding-window) 방식보다 성능이 떨어질 수 있습니다. 본 방법은 Cityscapes의 교통 장면이나 CVPPP의 잎 배열처럼 이미지 간 유사성이 높은 데이터셋에 더 적합합니다.
* **향후 연구:** 현재는 사전에 학습된 네트워크를 사용하여 의미론적 분할 마스크를 생성했지만, 앞으로는 인스턴스 및 의미론적 분할을 제안된 판별 손실 함수로 함께 학습하는 방법을 연구할 계획입니다.

## 📌 TL;DR

본 논문은 인스턴스 분할 문제를 해결하기 위해 픽셀 임베딩을 학습하는 새로운 판별 손실 함수를 제안합니다. 이 손실 함수는 동일 인스턴스에 속하는 픽셀 임베딩을 가깝게, 다른 인스턴스에 속하는 픽셀 임베딩을 멀리 떨어뜨려 특징 공간을 구성합니다. 학습된 네트워크 출력은 간단한 평균-이동(mean-shift) 기반 군집화 후처리로 개별 인스턴스로 쉽게 분할될 수 있습니다. 본 방법은 객체 제안이나 순환 메커니즘에 의존하지 않고도 복잡한 폐색을 효과적으로 처리할 수 있으며, Cityscapes 및 CVPPP 벤치마크에서 경쟁력 있는 성능을 달성합니다.
