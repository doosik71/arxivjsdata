# Weakly Supervised Instance Segmentation using Class Peak Response

Yanzhao Zhou, Yi Zhu, Qixiang Ye, Qiang Qiu and Jianbin Jiao

## 🧩 Problem to Solve

대부분의 의미론적 분할(Semantic Segmentation) 방법은 픽셀 단위 마스크 형태의 값비싼 조밀한 주석(dense annotation)에 의존합니다. 이에 비해 이미지 레벨 레이블과 같은 약한 감독(weak supervision)은 비용이 적게 들지만, 동일 카테고리 내의 여러 객체 인스턴스를 구분하는 데 어려움이 있습니다. 본 논문은 이미지 레벨 레이블만으로 개별 객체 인스턴스를 감지하고 정밀한 마스크를 예측하는 약지도 학습 인스턴스 분할(Weakly Supervised Instance Segmentation)이라는 미개척의 도전적인 문제를 해결하고자 합니다.

## ✨ Key Contributions

* **핵심 관찰:** 클래스 반응 맵(Class Response Maps)의 지역 최대값(즉, 피크)이 각 인스턴스 내의 강력한 시각적 특징과 일치한다는 점을 발견했으며, 이 간단한 관찰을 통해 효과적인 약지도 학습 인스턴스 분할 기술을 개발했습니다.
* **PRMs (Peak Response Maps) 제안:** 분류 네트워크가 인스턴스 마스크를 추출할 수 있도록 클래스 피크 반응을 활용하는 방법을 제안합니다.
  * **피크 자극(Peak Stimulation):** 훈련 단계에서 클래스 반응 맵에서 피크가 두드러지게 나타나도록 유도하는 과정을 설계했습니다.
  * **피크 역전파(Peak Back-propagation):** 나타난 피크들을 역전파하여 각 객체 인스턴스의 경계와 같은 매우 유익한 영역에 효과적으로 매핑하여 PRMs를 생성합니다.
* **SOTA 성능 달성:** 제안된 방법을 VGG16, ResNet50과 같은 인기 있는 CNN에 구현하여 PASCAL VOC 2012 및 MS COCO 벤치마크에서 약지도 점 단위 위치화(pointwise localization) 및 의미 분할(semantic segmentation) 성능을 향상시키고 SOTA 결과를 보고합니다. 또한, 이미지 레벨 감독 인스턴스 분할 작업에 대한 결과를 처음으로 보고합니다.

## 📎 Related Works

* **약지도 학습 의미 분할:** 픽셀 단위 주석의 비효율성을 해결하기 위해 포인트, 바운딩 박스, 스크리블, 이미지 레벨 주석 등 다양한 약한 주석을 활용하는 방법이 연구되었습니다. 이미지 레벨 주석은 가장 저렴하지만 가장 도전적이며, 기존 방법들은 인스턴스 구분에 한계가 있습니다.
* **인스턴스 분할:** 의미 분할과 달리 인스턴스 인식 영역 레이블과 미세한 분할 마스크를 동시에 생성해야 하므로 훨씬 어렵습니다. 대부분의 방법(예: FCIS [16], Mask R-CNN [12])은 픽셀 단위 GT 마스크 또는 정확한 객체 바운딩 박스와 같은 강력한 감독에 의존합니다. 약지도 인스턴스 분할은 미개척된 문제입니다.
* **객체 사전 정보(Object Prior Information):** 객체 제안(Object Proposal) 방법(예: Selective Search [38], Edge Boxes [49], MCG [27])은 약지도 객체 감지 및 분할에서 저수준 특징을 사용하여 객체 위치와 범위를 추정합니다. 본 논문은 MCG 제안을 활용합니다.
* **이미지 레벨 감독 딥 활성화:** CNN의 딥 반응(feature maps)을 글로벌 클래스 신뢰도로 집계하는 방법으로 Global Max Pooling (GMP) [21], Global Average Pooling (GAP) [47], Log-Sum-Exponential (LSE) [35], Global Rank Max-Min Pooling (GRP) [9] 등이 있습니다. 기존 방법들은 종종 지역 공간적 관련성을 고려하지 않아 이미지 내 객체 인스턴스를 구별하기 어렵습니다.

## 🛠️ Methodology

1. **완전 합성곱 아키텍처 (Fully Convolutional Architecture):**
    * 표준 CNN 분류기(예: VGGNet, ResNet)를 FCN으로 변환하여 전방 전달(forward pass) 중에 공간 정보를 보존하고 클래스 반응 맵을 생성합니다.
2. **피크 자극 (Peak Stimulation):**
    * 네트워크의 맨 위 계층 뒤에 "피크 자극 계층"을 삽입합니다.
    * 각 클래스 반응 맵 $M_c \in \mathbb{R}^{H \times W}$에서 창 크기 $r^2$ 내의 지역 최대값(피크) $P_c = \{(i_k, j_k)\}$를 감지합니다.
    * 분류 신뢰도 점수 $s_c$는 $M_c$와 피크 위치에서만 특징을 집계하는 샘플링 커널 $G_c$의 컨볼루션으로 계산됩니다:
        $$ s_c = M_c * G_c = \frac{1}{N_c} \sum_{k=1}^{N_c} M_c(i_k, j_k) $$
    * 역전파 시 그래디언트는 피크 위치에만 할당되어, 네트워크가 정보가 풍부한 수용 필드(receptive fields)에 집중하여 학습하게 하여, 수많은 쉬운 음성 샘플(easy negatives)이 학습 표현을 압도하는 것을 방지합니다.
3. **피크 역전파 (Peak Back-propagation):**
    * 피크에서부터 미세하고 인스턴스 인식적인 표현인 Peak Response Maps (PRMs)를 생성하기 위해 확률 역전파 과정을 제안합니다.
    * 이는 피크(최상위 계층)에서 최하위 계층으로 무작위로 이동하는 워커(walker)의 절차로 해석될 수 있습니다. 최하위 계층의 각 위치에 대한 탑다운 관련성(top-down relevance)은 워커에 의해 방문될 확률로 공식화됩니다.
    * 컨볼루션 계층의 전이 확률(transition probability) $P(U_{ij}|V_{pq}) = Z_{pq} \times \hat{U}_{ij} W^+_{(i-p)(j-q)}$를 사용하며, $\hat{U}_{ij}$는 상향식 활성화(bottom-up activation), $W^+ = \text{ReLU}(W)$는 음수 연결을 제거합니다.
4. **약지도 학습 인스턴스 분할 (Weakly Supervised Instance Segmentation):**
    * PRMs(인스턴스 인식 단서), 클래스 반응 맵(클래스 인식 단서), 그리고 외부 객체 제안(예: MCG [27])의 공간 연속성 사전 정보를 결합합니다.
    * 객체 인스턴스 마스크는 다음 메트릭을 사용하여 제안 갤러리에서 검색됩니다:
        $$ \text{Score} = \alpha \cdot \underbrace{R * S}_{\text{instance-aware}} + \underbrace{R * \hat{S}}_{\text{boundary-aware}} - \beta \cdot \underbrace{Q * S}_{\text{class-aware}} $$
        여기서 $R$은 PRM, $S$는 제안, $\hat{S}$는 제안의 윤곽 마스크, $Q$는 클래스 반응 맵에서 얻은 배경 마스크입니다.
    * 전체 알고리즘은 다음과 같습니다: (1) 클래스 반응 맵 생성, (2) 각 클래스에 대한 피크 감지, (3) 각 피크에 대해 PRM 생성, (4) PRM과 클래스 반응 맵을 사용하여 각 제안에 대한 점수 계산, (5) 최고 순위 제안을 인스턴스 예측으로 선택, (6) NMS 적용.

## 📊 Results

* **점 단위 위치화 (Pointwise Localization):** PASCAL VOC 2012 및 MS COCO 2014 데이터셋에서 ResNet50 기반으로 85.5% / 57.5%의 mAP를 달성하여 SOTA를 기록했으며, 피크 자극이 없을 때(81.5% / 53.1%)보다 크게 향상되었습니다.
* **Peak Response Maps 품질:** VOC 2012에서 mAP 64.0%를 달성하여 다른 응답 집계 전략보다 높은 PRM 품질을 보였습니다. 단일 객체 이미지의 경우 PRM 에너지의 78%, 2-5개 객체 이미지의 경우 67%가 인스턴스 내에 위치하여 고품질의 인스턴스 인식 단서를 제공함을 입증했습니다.
* **약지도 학습 의미 분할:** VOC 2012에서 ResNet50으로 mIoU 53.4%를 달성하며 CRF 후처리 없이도 경쟁력 있는 결과를 보였습니다.
* **약지도 학습 인스턴스 분할:** PASCAL VOC 2012에서 mAP$_{r}$0.25 44.3%, mAP$_{r}$0.5 26.8%, mAP$_{r}$0.75 9.0%, ABO 37.6%를 달성하여 이미지 레벨 감독 인스턴스 분할의 첫 결과를 보고했습니다. 다른 약지도 방법들보다 월등히 높은 성능을 보였습니다.
* **Ablation Study:** 피크 자극, 인스턴스 인식 항, 경계 인식 항, 클래스 인식 항 모두 인스턴스 분할 성능에 필수적이며, 특히 인스턴스 인식 항이 mAP$_{r}$0.5를 26.8%에서 13.3%로 크게 향상시키는 등 각 구성 요소의 중요성을 입증했습니다.
* **정성적 결과:** 서로 가깝거나 가려진 객체, 다양한 스케일의 객체, 다양한 클래스의 객체 등 도전적인 시나리오에서 고품질의 인스턴스 분할 결과를 생성했습니다.
* **성능 상한 분석:** GT 마스크를 완벽한 제안 갤러리로 사용했을 때 mAP$_{r}$0.75가 73.3%까지 향상되어, 제안 품질이 개선될 경우 본 방법의 성능 잠재력이 매우 높음을 보여주었습니다.

## 🧠 Insights & Discussion

* **새로운 관점:** 이 연구는 인스턴스 인식 단서가 CNN의 계층적 반응 맵에 자연스럽게 인코딩되어 있으며, 이를 효과적으로 추출하여 약지도 인스턴스 분할 문제를 해결할 수 있다는 새로운 통찰력을 제공합니다.
* **효율성 및 확장성:** 제안된 방법은 기존 CNN 아키텍처와 호환되며 표준 분류 설정과 이미지 레벨 레이블만으로 훈련할 수 있어 계산 오버헤드가 적고 대규모 데이터에 적용하기에 적합합니다.
* **피크 기반 학습의 중요성:** 피크 자극을 통해 네트워크가 유익한 수용 필드에서 명시적인 표현을 학습하도록 유도함으로써 객체 위치화 능력이 강화되고 고품질의 PRM이 생성됩니다. 피크 역전파는 인스턴스의 미세한 경계 정보까지 추출하여 분할 마스크의 정확도를 높입니다.
* **한계점:** 제안된 방법은 외부 객체 제안의 품질에 의해 성능이 제한될 수 있습니다. 특히 복잡한 장면(예: 혼란스러운 장면, 병합 실패, 과도한 확장)에서는 제안의 한계가 명확하게 드러납니다.
* **향후 연구:** 성능 상한 분석을 통해 PRM 자체의 강력한 인스턴스 위치화 능력을 확인했습니다. 이는 비디오/RGB-D 애플리케이션과 같이 고품질 제안을 생성할 수 있는 풍부한 정보를 활용하면 본 방법의 성능이 크게 향상될 수 있음을 시사합니다.

## 📌 TL;DR

* **문제:** 값비싼 픽셀 레벨 주석 없이, 이미지 레벨 레이블만으로 개별 객체 인스턴스를 분할하는 **약지도 학습 인스턴스 분할** 문제 해결.
* **제안 방법:** CNN의 "클래스 반응 맵"에서 지역 최대값인 "피크"를 활용하는 **Peak Response Maps (PRMs)** 기법 제안.
    1. **피크 자극:** 학습 시 클래스 반응 맵에서 피크가 두드러지게 나타나도록 네트워크를 훈련하여 객체 위치화 능력 강화.
    2. **피크 역전파:** 추론 시 이 피크들을 역전파하여 인스턴스의 미세한 경계 정보를 포함하는 고품질의 인스턴스 인식 시각 특징(PRMs) 생성.
    3. **마스크 추출:** PRMs, 클래스 반응 맵, 그리고 외부 객체 제안(object proposals)을 결합하여 인스턴스 마스크를 추출.
* **주요 결과:** 이미지 레벨 약지도 인스턴스 분할에서 처음으로 결과를 보고하며, 약지도 점 단위 위치화 및 의미 분할에서 SOTA 성능 달성. 피크 기반 접근 방식이 객체 위치화 및 미세 경계 추출에 매우 효과적임을 입증하고, 외부 제안의 품질이 향상될 경우 성능 잠재력이 매우 높음을 보여줌.
