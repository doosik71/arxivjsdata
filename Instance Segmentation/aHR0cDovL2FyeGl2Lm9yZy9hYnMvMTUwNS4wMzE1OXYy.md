# Monocular Object Instance Segmentation and Depth Ordering with CNNs

Ziyu Zhang, Alexander G. Schwing, Sanja Fidler, Raquel Urtasun

## 🧩 Problem to Solve

본 논문은 단일 단안 이미지(monocular image)에서 객체 인스턴스 분할(instance-level segmentation) 및 깊이 순서(depth ordering)를 예측하는 문제를 다룹니다. 이는 각 픽셀에 대한 클래스 레이블링과 객체로의 조합적 그룹핑, 그리고 단일 이미지에서 깊이를 추론하는 난해한 문제를 동시에 해결해야 하므로 매우 어려운 과제입니다. 특히, 자율 주행 시나리오에서 복잡한 폐색 패턴, 그림자, 반사 및 채도 등의 문제에 직면하는 차량 객체에 초점을 맞춥니다.

## ✨ Key Contributions

* **CNN 기반 인스턴스 분할 및 깊이 순서 예측:** 인스턴스 ID가 이미지 패치 내의 깊이 순서를 인코딩하도록 CNN을 직접 훈련하여 인스턴스 수준 분할 및 깊이 순서를 동시에 예측하는 방법을 제안합니다.
* **다중 해상도 패치 및 MRF 통합:** 다양한 해상도의 겹치는 이미지 패치에 적용된 CNN 예측과 연결된 구성 요소(connected component) 알고리즘의 출력을 입력으로 받아 이미지의 일관된 설명을 제공하는 마르코프 랜덤 필드(MRF)를 개발했습니다.
* **약한 3D 감독 학습:** 훈련 시에는 3D 바운딩 박스, LIDAR 포인트 및 스테레오 이미지와 같은 약한 3D 정보를 활용하여 대규모 데이터셋(KITTI)에서 네트워크를 훈련시키지만, 테스트 시에는 단일 RGB 이미지만을 요구합니다.
* **MRF 에너지 항 설계:** MRF 에너지 함수에 CNN 예측, 연결된 구성 요소의 순서, 장거리(long-range) 및 단거리(short-range) 픽셀 간 연결성을 인코딩하여 최종 분할 및 깊이 순서의 일관성을 강화합니다.
* **KITTI 벤치마크에서의 성능 입증:** 도전적인 KITTI 벤치마크에서 제안된 접근 방식의 효과를 입증하며, 인스턴스 분할 및 깊이 순서 지정 두 가지 작업 모두에서 우수한 성능을 보여줍니다.

## 📎 Related Works

* **깊이 순서 예측:** 약한 객체 정보 및 중간 수준 단서(예: 접합부, 경계)를 사용하여 깊이 순서를 예측하는 기존 연구([14, 16, 19])와 관련이 있습니다.
* **객체 감지 및 분할의 조합:** 바운딩 박스로 객체를 지역화한 후, 형상 또는 외형 정보를 사용하여 객체를 분할하는 일반적인 접근 방식([20, 21, 30, 40])과 다릅니다. 본 논문은 감지와 분할을 공동으로 추론합니다.
* **RGB 이미지에서 3D 객체 추론:** 2D 감지에서 3D 객체를 추론하는 방법([12, 37, 38]) 및 CAD 모델을 사용하는 방법([1, 23])과 관련되지만, 일반적으로 분할까지 다루지는 않습니다.
* **최근 인스턴스 분할 접근 방식:** R-CNN 프레임워크를 활용한 객체 감지 및 분할([9]) 또는 계층적 분할 트리에서 최적의 분할을 찾는 방법([34]) 등이 있습니다.
* **가장 관련 있는 연구:** 클래스 및 인스턴스 분할, 그리고 깊이 순서 지정을 명시적으로 다루는 [36, 15, 39]와 유사하지만, 본 논문은 강력한 CNN과 에너지 최소화 작업을 통해 인스턴스 레이블링과 깊이 순서를 직접 예측합니다.

## 🛠️ Methodology

본 논문의 접근 방식은 CNN 기반의 로컬 예측과 MRF 기반의 전역적 일관성 확보로 구성됩니다.

1. **CNN 기반 인스턴스 분할 및 깊이 순서 네트워크:**
    * **입력:** 단일 이미지를 다양한 크기와 겹침으로 추출한 패치.
    * **네트워크 아키텍처:** VGG-16 네트워크를 기반으로 하며, 원래의 세 개의 완전 연결(fully-connected) 계층을 컨볼루션 유닛으로 변환하여 픽셀 단위 예측이 가능하게 합니다(Fully Convolutional Networks 방식).
    * **해상도 손실 보상:** 5개의 풀링 계층으로 인한 해상도 손실을 보상하기 위해 상위 두 풀링 계층에서 다운샘플링을 건너뛰고 'à trous (with hole) algorithm'을 사용하여 출력이 입력 패치 크기보다 8배만 작도록 합니다.
    * **출력:** 각 패치에 대해 최대 6개의 인스턴스 레벨(배경 포함)을 예측하는 40x40x6 크기의 출력 맵을 생성합니다. 인스턴스 ID는 깊이 순서를 나타냅니다.
    * **훈련:** KITTI 데이터셋의 3D 바운딩 박스 정보를 활용하여 [2]에서 제안한 약한 레이블링 기법으로 생성된 고품질 인스턴스 분할 및 깊이 순서 정보를 그라운드 트루스로 사용합니다. 교차 엔트로피 손실 함수와 확률적 경사 하강법(SGD)으로 네트워크 파라미터 $w$를 최적화합니다.

2. **MRF 패치 병합:**
    * **목표:** 여러 겹치는 패치에서 얻은 CNN 출력을 단일하고 일관된 이미지 레이블링으로 통합합니다.
    * **초기 단계:** 병합된 CNN 예측 맵에 연결된 구성 요소 알고리즘을 실행하여 고수준 구조를 추정합니다.
    * **에너지 함수 정의:** $E(y) = \sum_{p} (E_{CNN,p}(y_p) + E_{CCO,p}(y_p)) + \sum_{p,p':C(p) \neq C(p')} E_{long,p,p'}(y_p, y_{p'}) + \sum_{p,p' \in N(p)} E_{short,p,p'}(y_p, y_{p'})$
        * **CNN 에너지 ($E_{CNN,p}(y_p)$):** CNN의 지역 예측이 실제 전역 예측보다 낮을 수 있다는 사실을 인코딩하며, 예측된 깊이 레벨과 같거나 높은 상태를 선호합니다.
        * **연결된 구성 요소 순서 에너지 ($E_{CCO,p}(y_p)$):** 연결된 구성 요소를 수직축에 따라 정렬하고, 픽셀에 할당된 구성 요소의 순서와 같거나 큰 상태를 선호합니다.
        * **장거리 연결 ($E_{long,p,p'}(y_p, y_{p'})$):** 다른 구성 요소에 속하는 픽셀에는 다른 상태가 할당되도록 선호합니다. 각 구성 요소 쌍에 대해 무작위로 20,000개의 연결을 샘플링합니다.
        * **단거리 연결 ($E_{short,p,p'}(y_p, y_{p'})$):** 인접 픽셀이 CNN 예측에 따라 동일하거나 다른 레이블을 갖도록 권장합니다 (가중치 있는 Potts-type potential).
    * **추론:** NP-hard 문제이므로, $\alpha$-$\beta$-swap 알고리즘에서 영감을 받아 이진 추론 문제를 해결하기 위해 QPBO(Quadratic Pseudo-Boolean Optimization)를 사용합니다. 에너지가 감소하는 경우에만 이동을 수락합니다.

3. **후처리 (Post-processing):**
    * 200픽셀 미만의 작은 가짜 객체 인스턴스 그룹을 제거합니다.
    * 객체 인스턴스 내의 구멍을 주변 객체의 레이블로 채웁니다.
    * 연결이 끊긴 인스턴스 레이블을 다시 지정하고, 각 연결된 구성 요소의 2D 바운딩 박스 중심의 수직축 좌표에 따라 순서를 다시 정렬합니다.

## 📊 Results

* **평가 데이터셋:** KITTI 벤치마크의 301개 이미지(1,229개 차량)를 테스트에 사용하고, 나머지 6,744개 이미지는 CNN 훈련에 사용합니다.
* **클래스 수준 분할:**
  * 제안된 MRF 전체(Full) 모델이 평균 IoU(AvgIoU)에서 가장 좋은 성능을 보이며, 다른 IoU 지표, 정확도 및 재현율에서도 우수합니다.
  * 중간 크기 패치가 작은 패치와 큰 패치보다 약간 더 나은 성능을 보였습니다.
  * 후처리가 전반적으로 이진 예측 성능을 약간 저해하는 경향이 있습니다.
* **인스턴스 분할:**
  * MRF 전체(Full) 모델이 [28] 기반의 다른 기준선보다 모든 지표에서 우수한 성능을 보입니다. 특히, 인스턴스 수준 평가인 평균 가중 커버리지(MWCov)와 평균 비가중 커버리지(MUCov)에서 기준선을 크게 능가합니다.
  * 후처리(Post-processing) 단계는 인스턴스 수준 성능을 약 2% 향상시킵니다.
  * 후처리 적용 후에는 페어와이즈(pairwise) MRF 공식이 유니터리(unary) 포텐셜만 사용하는 경우보다 명확히 더 나은 성능을 보입니다.
* **깊이 순서:**
  * 제안된 접근 방식은 무작위로 샘플링된 전경 픽셀 쌍 중 83.1%를 올바르게 순서화했습니다.
  * MRF의 페어와이즈 연결은 후처리 후에 CNN 원본 출력 및 유니터리 방식보다 성능을 향상시킵니다. 후처리가 없으면 페어와이즈 연결이 오히려 성능을 저해합니다.
* **정성적 결과:**
  * 차량이 쉽게 분리되는 장면(예: Fig. 5 상단 행)에서는 잘 작동합니다. 이는 연결된 구성 요소 알고리즘이 인스턴스를 성공적으로 구별하기 때문입니다.
  * 작은 차량(CNN 예측에서 놓침)이나 연결된 구성 요소 알고리즘에 의해 병합된 인스턴스(예: Fig. 6 하단 행)에서는 어려움을 겪습니다.

## 🧠 Insights & Discussion

* **단일 이미지의 한계 극복:** 단일 단안 이미지에서 인스턴스 수준 분할과 깊이 순서 지정을 동시에 해결하는 것은 어려운 문제이며, CNN의 강력한 특징 추출 능력과 MRF의 전역적 일관성 모델링을 결합하여 효과적으로 접근했습니다.
* **약한 감독 학습의 중요성:** 3D 바운딩 박스와 같은 약한 감독 정보를 활용하여 대규모 데이터셋을 구축하고 CNN을 훈련할 수 있었던 점은 레이블링 비용이 많이 드는 인스턴스 분할 및 깊이 추론 문제에 대한 실용적인 해결책을 제시합니다.
* **MRF 설계의 효과:** MRF의 에너지 항들이 CNN 예측, 연결된 구성 요소의 구조, 인접 픽셀 간의 관계를 효과적으로 통합하여 복잡한 장면에서 객체의 일관된 분할 및 깊이 순서를 유도하는 데 기여했습니다. 특히 후처리와 결합될 때 페어와이즈 MRF 연결이 깊이 순서 결정에 긍정적인 영향을 미친다는 것을 보여주었습니다.
* **제한 사항:** 작은 객체나 심하게 가려진 객체에 대한 CNN의 예측 실패, 그리고 연결된 구성 요소 알고리즘에 의한 인스턴스 병합은 여전히 해결해야 할 과제입니다. 이러한 경우 MRF도 한계에 직면할 수 있습니다.
* **향후 연구:** 복잡한 실내 장면으로 접근 방식을 확장하여 더 높은 수준의 혼란(clutter)이 있는 환경에서의 적용 가능성을 탐색할 수 있을 것입니다.

## 📌 TL;DR

본 논문은 단일 단안 이미지에서 객체 인스턴스 분할과 깊이 순서 지정을 동시에 수행하는 방법을 제안합니다. 인스턴스 ID에 깊이 정보를 인코딩하는 CNN이 여러 해상도의 겹치는 패치에서 로컬 예측을 수행하고, 이 예측들은 연결된 구성 요소 정보와 함께 마르코프 랜덤 필드(MRF)에 통합되어 전역적으로 일관된 최종 결과를 생성합니다. 훈련에는 3D 바운딩 박스 등의 약한 3D 감독 정보가 활용되며, KITTI 벤치마크에서 이 접근 방식이 인스턴스 분할 및 깊이 순서 지정 모두에서 효과적임을 입증했습니다. 특히 후처리를 통해 성능이 향상되며, MRF의 페어와이즈 연결이 깊이 순서 정확도를 높이는 데 기여함을 보여주었습니다.
