# SSAP: Single-Shot Instance Segmentation With Affinity Pyramid

Naiyu Gao, Yanhu Shan, Yupei Wang, Xin Zhao, Yinan Yu, Ming Yang, Kaiqi Huang

## 🧩 Problem to Solve

기존의 제안(proposal-free) 기반 인스턴스 분할(instance segmentation) 방법들은 일반적으로 픽셀 단위의 의미론적 분할(semantic segmentation)과 인스턴스 인지 특징(instance-aware features) 학습을 위해 별개의 모듈을 사용하며 여러 단계의 추론 과정을 요구합니다. 이는 최적의 방식이 아니며, 여러 모듈 사용으로 인해 실제 적용 가능성이 줄어들고, 상호 보완적인 두 서브태스크 간의 잠재적 상호 이점(mutual benefits)이 충분히 활용되지 못하는 문제가 있습니다.

## ✨ Key Contributions

* 인스턴스를 구별하기 위한 새로운 인스턴스 인지 픽셀-쌍 유사도 피라미드(pixel-pair affinity pyramid)를 제안합니다. 이는 픽셀 수준의 의미론적 클래스 라벨링과 공동으로 학습될 수 있으며, 두 서브태스크 간의 양방향 상호작용을 통해 인스턴스 분할 성능을 향상시킵니다.
* 제안된 유사도 피라미드를 기반으로 단일 패스(single-shot)로 인스턴스를 생성하는 제안 기반(proposal-free) 인스턴스 분할 방법을 제안합니다. Cityscapes 데이터셋에서 37.3% AP (val) / 32.7% (test) 및 61.1% PQ (val)의 최첨단 성능을 달성합니다.
* 유사도 피라미드의 계층적 특성과 결합하여, 이미지를 점진적으로 분할하는 새로운 캐스케이드 그래프 분할(cascaded graph partition) 모듈을 제안합니다. 이 모듈은 비-캐스케이드 방식 대비 5배의 속도 향상과 9%의 상대적인 AP 개선을 이룹니다.

## 📎 Related Works

* **인스턴스 분할**:
  * **제안 기반(Proposal-based)**: Mask R-CNN, MNC 등 객체 탐지(object detection)에서 확장되어 바운딩 박스를 먼저 생성하고 그 안에 마스크를 예측합니다.
  * **제안 기반이 아닌(Proposal-free)**: 의미론적 분할의 성공에 기반하여 인스턴스 인지 특징을 학습하고 클러스터링을 통해 인스턴스를 구분합니다. DWT(Deep Watershed Transform), 임베딩(embeddings) 기반 방법, SGN(Sequential Grouping Networks), RNN(Recurrent Neural Networks)을 활용한 방법 등이 있습니다.
  * **그래프 기반 알고리즘**: 후처리(post-processing)에 활용되기도 하나, 일반적으로 시간이 많이 소요됩니다.
* **픽셀-쌍 유사도(Pixel-Pair Affinity)**: 의미론적 분할 학습 또는 후처리 과정에서 픽셀-쌍 유사도를 학습하는 개념이 여러 연구에서 개발되었습니다. 본 논문은 Liu et al. [40]과 유사하게 인스턴스 인지 유사도를 활용하지만, 유사도를 도출하고 픽셀을 그룹화하는 방식이 다르고, 본 접근 방식은 단일 패스(single-shot)로 작동합니다.

## 🛠️ Methodology

본 방법론은 의미론적 분할과 픽셀-쌍 유사도 피라미드를 공동으로 학습하는 통합 네트워크와 캐스케이드 그래프 분할 모듈로 구성됩니다.

1. **유사도 피라미드 (Affinity Pyramid)**:
    * **픽셀-쌍 유사도**: 두 픽셀이 동일한 인스턴스에 속할 확률을 예측합니다. 각 픽셀에 대해 작은 $r \times r$ 윈도우 내 이웃 픽셀과의 단거리 유사도($a_j$)를 학습합니다.
    * **장거리 유사도**: 더 큰 객체나 인접하지 않은 부분을 처리하기 위해 필요하며, 작은 윈도우 크기를 유지하면서 낮은 해상도의 인스턴스 맵에서 드물게(sparsely) 도출됩니다.
    * **계층적 학습**: U-shape 네트워크의 디코더 계층을 따라 여러 해상도($1/4, 1/8, \dots, 1/64$)에서 유사도 브랜치를 추가하여 단거리 유사도와 장거리 유사도를 각각 높은 해상도와 낮은 해상도의 특징 레벨에서 효과적으로 학습합니다. 이는 의미론적 분할과 공동으로 학습되어 상호 이점을 제공합니다.
    * **손실 함수**: 각 픽셀에 대한 $r^2$개의 예측된 유사도에 대해 평균 $L_2$ 손실을 사용하며, 불균형 데이터 문제 해결을 위해 특정 조건을 만족하는 픽셀의 80%를 무작위로 제거하고 객체 인스턴스에 속하는 픽셀에 3배의 손실 가중치를 부여합니다.

2. **캐스케이드 그래프 분할 (Cascaded Graph Partition)**:
    * **그래프 구성**: 학습된 픽셀-쌍 유사도 피라미드를 이용하여 각 픽셀을 노드($V$)로, 유사도를 엣지($E$) 점수 $w_{u,v}$로 변환하여 무방향 그래프 $G=(V, E)$를 구성합니다. $w_{u,v} = \log(\frac{\alpha_{u,v}}{1-\alpha_{u,v}})$이며, 여기서 $\alpha_{u,v}$는 픽셀 $u,v$의 평균 유사도입니다.
    * **최적화 문제**: 인스턴스 분할을 그래프 분할 문제로 변환하여 최적화 문제를 해결합니다:
        $$ \min_{y \in \{0,1\}} \sum_{e \in E} w_e y_e $$
        $$ \text{s.t. } \forall C \forall e' \in C: \sum_{e \in C \setminus \{e'\}} y_e \geq y_{e'} $$
        여기서 $y_e = 1$은 엣지 $e$의 두 노드가 다른 파티션에 속함을 의미합니다.
    * **캐스케이드 방식**: 낮은 해상도(예: $1/16$ 해상도)에서 먼저 그래프 분할을 수행하여 대형 인스턴스에 대한 조악한 세그먼트를 생성합니다. 이 세그먼트의 내부 영역을 업샘플링하여 높은 해상도의 다음 단계에 대한 제안(proposals)으로 활용합니다. 이 방식으로 노드 수를 크게 줄여 그래프 분할 속도를 가속화하고 성능을 개선합니다.
    * **분할 정제 (Segmentation Refinement)**: 의미론적 분할 점수와 유사도 정보를 통합하여 최종 분할을 정제합니다. 픽셀 $u, v$의 평균 유사도 $\alpha_{u,v}$를 다음과 같이 정제합니다:
        $$ \alpha'_{u,v} = \alpha_{u,v} \ast \exp[-D_{JS}(s_u \Vert s_v)] $$
        여기서 $D_{JS}$는 젠슨-섀넌(Jensen-Shannon) 발산으로 두 픽셀의 의미론적 분류 분포 $s_u, s_v$ 간의 거리를 측정합니다.

## 📊 Results

* **데이터셋**: Cityscapes 및 COCO.
* **Cityscapes**:
  * **AP (Average-Precision)**: 검증(val) 세트에서 37.3% (ResNet-101 기반), 테스트(test) 세트에서 32.7%를 달성하여 최첨단 성능을 기록했습니다.
  * **PQ (Panoptic Quality)**: 검증(val) 세트에서 61.1% (ResNet-101 기반)를 달성했습니다.
  * **캐스케이드 그래프 분할 효과**: $1/16$ 해상도에서 초기화할 경우 비-캐스케이드 방식($1/4$ 해상도 초기화) 대비 5배의 속도 향상과 9%의 상대적 AP 개선을 보였습니다.
  * **공동 학습 효과**: 유사도 피라미드와 의미론적 분할의 공동 학습은 두 태스크 모두의 성능을 향상시키는 상호 이점을 제공합니다.
  * **장거리 유사도의 효과**: 장거리 유사도를 점진적으로 추가할수록 AP 및 PQ 성능이 지속적으로 향상됩니다.
* **COCO**:
  * 파노라마 분할(panoptic segmentation) 태스크에서 평가되었으며, DeeperLab (Xception-71 기반)보다 모든 서브 지표에서 우수한 성능을 보였습니다. (예: PQ 36.9% vs 34.3%).

## 🧠 Insights & Discussion

* **상호 이점의 확인**: 본 연구는 인스턴스 인지 픽셀-쌍 유사도 학습과 픽셀 수준 의미론적 클래스 라벨링 간의 상호 이점을 성공적으로 활용했음을 실험적으로 보여줍니다. 이는 두 서브태스크를 별도로 처리하는 기존 방식의 한계를 극복합니다.
* **효율성과 정확성의 동시 달성**: 제안된 캐스케이드 그래프 분할 모듈은 낮은 해상도에서 생성된 인스턴스 제안을 활용하여 높은 해상도에서의 그래프 분할 과정을 가속화할 뿐만 아니라, 부정확한 정보를 걸러내어 정확도까지 향상시킵니다. 이는 기존 그래프 기반 방법론의 고질적인 문제인 느린 속도를 해결하면서 성능까지 개선한 중요한 기여입니다.
* **단일 패스 파이프라인**: 전체 과정이 단일 패스로 이루어져 효율적인 인스턴스 분할 시스템을 구축할 수 있음을 입증했습니다. 이는 실시간 애플리케이션에 매우 유리합니다.
* **제한 사항 및 향후 연구**: 논문에서 명시적인 한계는 언급되지 않았지만, affinity window size 튜닝의 필요성 등은 효율성과 성능 사이의 균형점을 찾는 중요한 고려사항이 될 수 있습니다.

## 📌 TL;DR

SSAP는 단일 패스로 인스턴스 분할을 수행하는 제안(proposal-free) 기반 방법입니다. 의미론적 분할과 인스턴스 인지 픽셀-쌍 유사도 피라미드를 U-shape 네트워크에서 공동으로 학습하여 상호 이점을 얻습니다. 또한, 계층적 유사도 피라미드를 활용하는 새로운 캐스케이드 그래프 분할 모듈을 통해 기존 그래프 분할의 느린 속도 문제를 해결하고, 5배의 속도 향상과 9%의 AP 개선을 달성합니다. Cityscapes 및 COCO 데이터셋에서 최첨단 성능을 기록하며 효율적이고 정확한 인스턴스 분할을 위한 효과적인 접근 방식을 제시합니다.
