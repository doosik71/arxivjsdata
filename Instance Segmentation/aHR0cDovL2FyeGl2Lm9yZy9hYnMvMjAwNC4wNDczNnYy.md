# Capsules for Biomedical Image Segmentation

Rodney LaLonde, Ziyue Xu, Ismail Irmakci, Sanjay Jain, Ulas Bagci

## 🧩 Problem to Solve

* 의료 영상 분석에서 객체 분할은 질병 진단 및 치료 계획에 필수적이지만, 병변의 다양성, 노이즈, 인공물 등으로 인해 매우 어려운 문제이다.
* 기존 컨볼루셔널 신경망(CNN)은 높은 성능을 보이지만, 특징의 공간적 관계를 파악하는 데 한계가 있으며, 특징의 정확한 위치, 자세, 변형 등을 벡터로 인코딩하는 능력이 부족하다. 이로 인해 보지 못한 객체 포즈(unseen object poses)에 대한 일반화 능력이 떨어진다.
* 초기 캡슐 네트워크(CapsNet)는 벡터 기반 특징 표현으로 CNN의 한계를 극복하려 했으나, 메모리 및 파라미터 요구량이 매우 커서 32x32 픽셀 이상의 대규모 이미지에 적용하기 어렵다. 의료 영상은 고해상도 이미지가 많아 이 문제를 해결해야 한다.

## ✨ Key Contributions

* **SegCaps 아키텍처 최초 제안:** 문헌상 최초로 캡슐 네트워크 아키텍처를 객체 분할에 적용한 **SegCaps**를 제안한다.
* **효율적인 라우팅 메커니즘 개발:** 기존 다이내믹 라우팅 알고리즘에 두 가지 핵심 수정을 도입하여 대규모 이미지 처리 가능하게 함:
  * **지역적 제약 라우팅(locally-constrained routing):** 자식 캡슐이 정의된 공간적 로컬 윈도우 내의 부모 캡슐에게만 라우팅되도록 하여 연산 비용을 절감한다.
  * **변환 행렬 공유(transformation matrix sharing):** 캡슐 유형 내 그리드의 각 멤버에 대해 변환 행렬을 공유하여 파라미터 수를 획기적으로 줄인다.
* **디컨볼루셔널 캡슐 도입:** "디컨볼루셔널(deconvolutional)" 캡슐 개념을 도입하여 심층 인코더-디코더 스타일의 캡슐 아키텍처를 구축, 글로벌 컨텍스트 정보를 유지하면서도 효율적인 픽셀 수준 예측을 가능하게 한다.
* **마스킹된 재구성 정규화 확장:** 대상 클래스의 마스킹된 재구성(masked reconstruction)을 분할 문제에 대한 정규화 방법으로 확장하여 네트워크의 일반화 성능을 향상시킨다.
* **광범위한 실험적 검증:**
  * 병리학적 폐 분할(임상 및 전임상 대상의 CT 스캔 5개 데이터셋, 약 2000개) 및 허벅지 근육 및 지방 조직 분할(MRI 스캔 150개)에서 SegCaps의 우수한 성능을 입증했다.
  * SegCaps는 U-Net 등 최신 CNN 기반 모델보다 더 높은 Dice 계수 및 Hausdorff 거리를 달성하면서, U-Net의 4.6%에 불과한 파라미터 수를 사용한다.
  * 객체의 미확인 회전/반사(unseen rotations/reflections)에 대한 캡슐 네트워크의 뛰어난 일반화 능력을 시연한다.

## 📎 Related Works

* **전통적 이미지 분할:** 저수준 픽셀 처리, 수학적 모델(예: 레벨 세트, 퍼지 연결성, 그래프 기반, 아틀라스 기반 알고리즘).
* **CNN 기반 분할:**
  * **FCN (Fully Convolutional Networks):** 시맨틱 분할의 기반.
  * **U-Net:** 의료 영상 분할 분야의 대표적인 인코더-디코더 구조.
  * **Tiramisu (FC-DenseNet):** U-Net과 DenseNet을 결합한 조밀 연결 구조.
  * **SegNet, RefineNet, PSPNet, DeepLab:** 글로벌 컨텍스트 정보 활용 및 효율성 개선을 위한 다양한 CNN 기반 모델.
* **의료 영상 특화 분할:** 3D U-Net, V-Net 등 3D 네트워크, 다중 뷰 네트워크.
* **병리학적 폐 분할:** Mansoor et al. (2014)의 퍼지 연결성 및 텍스처 특징 기반 접근법, Harrison et al. (2017)의 P-HNN.
* **근육 및 지방 조직 분할:** Irmakci et al. (2018)의 퍼지 연결성 기반 방법.
* **캡슐 네트워크 (CapsNet):** Sabour et al. (2017)이 제안한 것으로, 벡터 기반 특징 표현을 통해 객체의 공간적 방향, 위치, 크기 등을 인코딩하여 CNN의 한계(공간 관계 무시)를 극복한다.

## 🛠️ Methodology

본 연구는 객체 분할을 위한 심층 인코더-디코더 스타일의 캡슐 네트워크인 **SegCaps**를 제안하며, 주요 방법론은 다음과 같다.

1. **캡슐 표현:** CNN의 스칼라 특징 맵과 달리, SegCaps는 벡터 형태의 캡슐을 사용하여 특징의 존재 여부뿐만 아니라 자세, 변형, 정밀한 위치 정보 등을 인코딩한다.
2. **컨볼루셔널 캡슐 (Convolutional Capsules):**
    * 입력 이미지는 2D 컨볼루셔널 계층을 통과하여 초기 캡슐 세트를 형성한다. 각 캡슐은 $z$-차원 벡터이다.
    * **예측 벡터 생성:** 계층 $l$의 자식 캡슐 $U_{x,y|t^l_i}$는 학습된 변환 행렬 $M_{t^{l+1}_j}$와 행렬 곱을 통해 다음 계층의 부모 캡슐을 위한 예측 벡터 $\hat{u}_{x,y|t^l_i}$를 생성한다:
        $$\hat{u}_{x,y|t^l_i} = M_{t^{l+1}_j} \cdot U_{x,y|t^l_i}$$
    * **변환 행렬 공유:** 기존 CapsNet과 달리, 변환 행렬 $M_{t^{l+1}_j}$는 특정 캡슐 유형 내의 모든 공간 위치 $(x,y)$에서 공유되어 파라미터 수를 대폭 감소시킨다.
3. **지역적 제약 다이내믹 라우팅 (Locally-Constrained Dynamic Routing):**
    * 기존 CapsNet의 전역적 라우팅과 달리, 자식 캡슐은 정의된 공간적 로컬 커널 내의 부모 캡슐에게만 라우팅된다.
    * **라우팅 계수 계산:** 라우팅 계수 $r_{t^l_i|x,y}$는 예측 벡터가 특정 부모 캡슐로 라우팅될 사전 확률인 로짓 $b_{t^l_i|x,y}$를 사용하여 소프트맥스 함수를 통해 계산된다:
        $$r_{t^l_i|x,y} = \frac{\exp(b_{t^l_i|x,y})}{\sum_{t^{l+1}_j} \exp(b_{t^l_i|t^{l+1}_j})}$$
    * **부모 캡슐 입력:** 각 부모 캡슐 $p_{x,y}$의 최종 입력은 예측 벡터들의 가중치 합으로 계산된다:
        $$p_{x,y} = \sum_{n} r_{t^l_i|x,y} \hat{u}_{x,y|t^l_i}$$
    * **Squashing 함수:** 부모 캡슐의 최종 벡터 출력 $v_{x,y}$는 비선형 squashing 함수를 통해 크기는 [0, 1] 범위로 제한되고 방향은 유지된다:
        $$v_{x,y} = \frac{\Vert p_{x,y} \Vert^2}{1+\Vert p_{x,y} \Vert^2} \frac{p_{x,y}}{\Vert p_{x,y} \Vert}$$
4. **디컨볼루셔널 캡슐 (Deconvolutional Capsules):**
    * 인코더-디코더 네트워크를 구성하기 위해 도입되며, 전치 컨볼루션(transposed convolutions)과 유사한 방식으로 예측 벡터를 형성하여 캡슐 그리드의 해상도를 업샘플링한다. 라우팅 메커니즘은 컨볼루셔널 캡슐과 동일하다.
5. **재구성 정규화 (Reconstruction Regularization):**
    * 네트워크가 단순히 판별적인 특징에만 집중하는 것을 방지하고, 입력 데이터 분포의 더 많은 관련 특징을 학습하도록 유도한다.
    * 양성 클래스에 해당하는 픽셀만으로 구성된 마스킹된 입력 이미지의 재구성을 시도하며, 3계층 $1 \times 1$ 컨볼루셔널 네트워크를 통해 재구성된 이미지와 원본 이미지(마스크 적용) 간의 평균 제곱 오차(MSE)를 손실로 사용한다.
    * 최종 손실 함수는 분할 출력에 대한 가중 이진 교차 엔트로피(BCE) 손실과 재구성 손실의 합이다.

## 📊 Results

* **병리학적 폐 분할 (CT):** LIDC-IDRI, LTRC, UHG (임상), JHU-TBS, JHU-TB (전임상) 5개 데이터셋에서 SegCaps는 Dice Similarity Coefficient 및 Hausdorff Distance 모두에서 U-Net, Tiramisu, P-HNN과 같은 최신 방법들을 일관되게 능가하는 성능을 보였다. 특히, UHG와 같은 작은 규모의 고난도 데이터셋에서도 우수한 결과를 달성했다.
* **근육 및 지방 조직 분할 (MRI):** BLSA 데이터셋의 3가지 T1 강조 MRI(water-only, water-fat, fat-only)에서 SegCaps는 U-Net과 동등한 성능을 보이면서도 이전 최신 방법을 뛰어넘었다. U-Net이 유사한 강도 값을 가진 영역에서 문제를 겪는 경향이 있었다.
* **파라미터 효율성:** SegCaps는 U-Net, P-HNN, Tiramisu보다 훨씬 적은 파라미터를 사용하면서도 더 나은 성능을 달성했다. 구체적으로, U-Net의 4.6%, P-HNN의 9.5%, Tiramisu의 14.9% 파라미터만으로 우수한 결과를 냈으며, 파라미터 수가 비슷한 다른 네트워크들과 비교했을 때도 SegCaps가 우수함을 입증했다.
* **객체 자세 일반화:** PASCAL VOC 데이터셋에서 단일 이미지에 과적합(overfitting)시킨 후 90도 회전 및 미러링된 이미지에 대해 테스트한 결과, SegCaps는 거의 모든 변형된 이미지에서 잘 작동한 반면, U-Net은 실패했다. 이는 캡슐 네트워크의 아핀 등변성(affine equivariance) 특성과 보지 못한 객체 포즈에 대한 탁월한 일반화 능력을 보여준다.

## 🧠 Insights & Discussion

* **캡슐 네트워크의 효율성과 강건성:** SegCaps는 파라미터를 매우 효율적으로 사용하여 기존 CNN보다 적은 자원으로 더 높은 예측 성능을 달성한다. 이는 특히 데이터가 제한적이거나 고해상도 이미지를 다루는 의료 영상 분야에서 중요한 이점이다. 또한, 객체의 아핀 변환(회전, 반사)에 대한 강건한 일반화 능력을 보여주며, 이는 CNN의 주요 한계 중 하나를 해결한다.
* **아키텍처 혁신의 중요성:** 지역적 제약 라우팅, 변환 행렬 공유, 디컨볼루셔널 캡슐의 도입은 캡슐 네트워크를 대규모 이미지 분할 작업에 적용할 수 있게 하는 핵심적인 기술 혁신이다. 이를 통해 캡슐 네트워크의 실용적인 적용 범위를 크게 확장했다.
* **재구성 정규화의 역할:** 마스킹된 재구성 정규화는 네트워크가 더 풍부하고 의미 있는 특징 표현을 학습하도록 유도하여 분할 성능 향상에 기여한다. 이는 단순히 판별적인 정보뿐만 아니라 입력 데이터의 전반적인 분포를 이해하는 데 도움이 된다.
* **다이내믹 라우팅 반복 횟수:** 3회 반복이 최적의 성능을 제공했지만, 향후 라우팅 메커니즘 자체를 개선하는 연구의 필요성도 시사한다.
* **의료 영상 분야의 의의:** 본 연구는 병리학적 폐 분할에 대한 가장 큰 규모의 연구이며, 특히 전임상(pre-clinical) 동물 대상에 대한 딥러닝 기반 자동 분할 결과를 처음으로 제시한다. 이는 향후 전임상 연구 및 컴퓨터 보조 진단(CAD) 시스템 개발에 중요한 통찰력을 제공한다.

## 📌 TL;DR

본 논문은 캡슐 네트워크를 의료 영상 분할에 최초로 적용한 **SegCaps**를 제안한다. SegCaps는 **지역적 제약 라우팅**과 **변환 행렬 공유**를 통해 기존 캡슐 네트워크의 높은 메모리/파라미터 부담을 해결하여 대규모 이미지($512 \times 512$ 픽셀) 처리를 가능하게 한다. 또한, **디컨볼루셔널 캡슐**로 인코더-디코더 구조를 구현하여 글로벌 정보를 유지하고, **마스킹된 재구성 정규화**로 네트워크의 성능을 향상시킨다. 병리학적 폐 및 허벅지 근육/지방 분할 작업에서 SegCaps는 U-Net 등 최신 CNN 모델보다 우수한 성능을 달성하면서도 U-Net 파라미터의 4.6%만을 사용하며 탁월한 효율성을 보인다. 더 나아가, 객체의 미확인 회전/반사에 대한 뛰어난 일반화 능력을 입증하여 캡슐 네트워크의 강력한 잠재력을 시사한다.
