# Test-time adaptable neural networks for robust medical image segmentation

Neerav Karani, Ertunc Erdil, Krishna Chaitanya, Ender Konukoglu

## 🧩 Problem to Solve

의료 영상 분할에서 합성곱 신경망(CNN)은 훈련 데이터셋이 테스트 시점에 예상되는 변화를 대표할 때 매우 우수한 성능을 보입니다. 그러나 실제 임상 환경에서는 스캐너 모델이나 프로토콜과 같은 획득 세부 정보의 차이로 인해 훈련 및 테스트 이미지 간에 불일치(즉, 도메인 이동)가 발생할 수 있습니다. 이러한 도메인 이동은 CNN의 성능 저하를 야기하며, 기존의 해결책인 각 도메인별 CNN 훈련, 전이 학습(Transfer Learning), 또는 비지도 도메인 적응(Unsupervised Domain Adaptation, UDA)은 새로운 레이블 데이터나 훈련 데이터셋 전체가 테스트 시점에 필요하다는 실용적인 한계를 가집니다. 본 연구의 목표는 이러한 알려지지 않은 도메인 변화에 대한 CNN의 강건성을 높여 도메인 일반화(Domain Generalization)를 달성하는 것입니다.

## ✨ Key Contributions

- **테스트 시점 적응 (Test-Time Adaptation, TTA) 도입:** 학습된 CNN을 각 테스트 이미지에 대해 개별적으로 적응시키는 새로운 패러다임을 제안하여, 훈련 시점에는 알 수 없었던 도메인 변화에 대한 강건성을 확보합니다.
- **분할 CNN의 이중 서브 네트워크 구조:** CNN을 이미지 정규화(Image-to-Normalized-Image, I2NI) 서브 네트워크 $N_{\phi}$와 정규화된 이미지 분할(Normalized-Image-to-Segmentation, NI2S) 서브 네트워크 $S_{\theta}$의 결합으로 설계합니다.
- **암시적 사전 정보를 활용한 적응:** 예측된 분할 결과의 '타당성(plausibility)'에 대한 암시적 사전 정보를 사용하여 테스트 시점 I2NI 네트워크의 파라미터 $\phi$를 조정합니다.
- **DAE (Denoising Autoencoder)를 통한 타당성 모델링:** 훈련 데이터셋의 분할 레이블에 대한 타당성 모델로 DAE를 활용하여, 비정상적인 분할을 "노이즈 제거"하여 타당한 분할로 유도하고 이를 통해 I2NI를 최적화합니다.
- **다중 해부학 데이터셋에서의 검증:** 뇌, 심장, 전립선 세 가지 해부학적 구조의 다중 센터 MRI 데이터셋에서 제안 방법의 일관된 성능 향상과 일반성을 입증합니다.
- **아키텍처 불가지론적 (Architecture-Agnostic) 설계:** NI2S CNN의 아키텍처에 구애받지 않아 기존의 다양한 분할 네트워크에 적용 가능합니다.

## 📎 Related Works

- **도메인 불변 특징 (Domain Invariant Features):** 입력에서 도메인 특정 신호에 대한 의존성을 줄이는 접근 방식으로, 다중 작업 오토인코더 [16], 최대 평균 불일치 (Maximum Mean Discrepancy, MMD) [17], 적대적 프레임워크 [18] 등을 통해 특징 유사성을 강제하거나, 메타 학습 프레임워크 [20, 14, 21]를 활용합니다.
- **데이터 증강 (Data Augmentation):** 훈련 데이터셋을 확장하여 테스트 시점에 발생할 수 있는 잠재적 변화를 포함하도록 유도하는 방법 [22, 23, 24, 25]입니다.
- **훈련 중 형상 제약 (Imposing Shape Constraints during Training):** 예측된 분할에 형상 또는 위상학적 제약을 부과하여 출력 공간에서 불변성을 유도하는 접근 방식 [26, 27, 28, 29, 30, 31, 32, 33]입니다.
- **비지도 분할 (Unsupervised Segmentation):** 특정 소스 도메인(SD) 이미지에 대한 의존성 없이 확률적 생성 모델(Probabilistic Generative Models, PGMs) [36, 37, 38] 기반으로 학습하는 방법입니다.
- **테스트 시점 적응 (Test Time Adaptation):** 본 연구와 가장 밀접하게 관련된 분야로, 사전 학습된 CNN을 각 테스트 이미지에 대해 적응시키는 접근 방식 [47, 48, 49]입니다.
- **후처리 (Post-Processing):** 조건부 랜덤 필드 [50, 51], DAE [52] 또는 생성적 적대 신경망 [53] 등을 사용하여 CNN 예측을 후처리하여 타당성을 개선하는 방법입니다.

## 🛠️ Methodology

본 연구는 분할 CNN을 두 개의 서브 네트워크 $N_{\phi}$ (I2NI: Image-to-Normalized-Image)와 $S_{\theta}$ (NI2S: Normalized-Image-to-Segmentation)의 연속으로 설계하며, 테스트 시점에 $N_{\phi}$만 적응시킵니다.

1. **소스 도메인에서 분할 CNN 훈련:**

   - $N_{\phi}$와 $S_{\theta}$는 소스 도메인 훈련 데이터셋 $D_{SD} = \{(x_i, z_i) | i=1, \dots, N\}$에서 지도 학습 방식으로 함께 훈련됩니다.
   - 최적의 파라미터 $\{\theta^{\ast}, \phi^{\ast}\}$는 다음과 같은 손실 함수 $L$을 최소화하여 추정됩니다:
     $$ \theta^{\ast}, \phi^{\ast} = \argmin*{\theta, \phi} \sum_i L(S*{\theta}(N\_{\phi}(x_i)), z_i) $$
   - 이 훈련 후 $S_{\theta}$의 파라미터 $\theta^{\ast}$는 고정되고, $N_{\phi}$의 파라미터 $\phi$만 테스트 시점에 각 이미지에 대해 조정됩니다.

2. **테스트 시점 적응 (Test-Time Adaptation):**

   - **적응 파라미터 선택:** 도메인 이동이 저수준 강도 통계 및 조직 유형 간의 대비 변화로 나타난다고 가정하고, 상대적으로 얕은 이미지 정규화 CNN $N_{\phi}$의 파라미터 $\phi$만 조정합니다. $N_{\phi}$는 잔차 CNN(Residual CNN)으로 모델링되며, 입력 이미지의 내용을 크게 변경하지 않으면서 대비 변화를 보정할 수 있는 유연성을 제공합니다.
   - **적응 유도 방법:** 레이블 정보나 추가 이미지 없이, 예측된 분할이 소스 도메인 훈련 데이터셋에서 관찰된 것과 유사하게 '타당'해야 한다는 암시적 사전 정보를 활용합니다.
     - **DAE (Denoising Autoencoder) 훈련:** 소스 도메인의 실제 분할 레이블 $z_i$를 사용하여 DAE $D_{\psi}$를 훈련합니다. $D_{\psi}$는 손상된 분할 $Z_c$를 "노이즈 제거"하여 $Z$와 유사한 타당한 분할을 출력하도록 학습됩니다. DAE 훈련은 다음과 같습니다:
       $$ \psi^{\ast} = \argmin*{\psi} \sum_j \sum_i L(D*{\psi}(z*{cij}), z_i) $$
       여기서 $z*{cij}$는 실제 레이블 $z_i$를 인위적으로 손상시킨 것입니다 (노이즈 전략: 무작위 패치 복사).
     - **DAE 기반 적응:** 주어진 테스트 이미지 $x$에 대해, $S_{\theta^{\ast}}(N_{\phi}(x))$에 의해 예측된 분할 $z_c$를 "노이즈가 있는" 분할로 간주하고, 이를 훈련된 DAE $D_{\psi^{\ast}}$에 통과시켜 "노이즈 제거된" 버전 $D_{\psi^{\ast}}(z_c)$를 얻습니다. 그런 다음, $N_{\phi}$의 파라미터 $\phi$를 업데이트하여 예측된 분할 $z_c$가 노이즈 제거된 버전 $D_{\psi^{\ast}}(z_c)$에 가까워지도록 합니다:
       $$ \hat{\phi} = \argmin*{\phi} L(z_c, D*{\psi^{\ast}}(z*c)); z_c = S*{\theta^{\ast}}(N\_{\phi}(x)) $$
     - 이 최적화는 경사 하강법 변형을 사용하여 반복적으로 수행되며, $L(z_c, D_{\psi^{\ast}}(z_c))$가 최소가 되는 $\hat{\phi}$를 최적 파라미터로 선택합니다. 최종 분할은 $S_{\theta^{\ast}}(N_{\hat{\phi}}(x))$입니다.

3. **큰 도메인 변화를 위한 아틀라스 초기화:** SD와 TD 이미지가 T1w와 T2w MRI처럼 크게 다른 경우, DAE 기반 적응 전에 아핀(affinely) 등록된 아틀라스 $A$를 사용하여 예측 분할을 합리적인 시작점으로 유도하는 스위칭 전략을 사용합니다. $L(z_c, D_{\psi^{\ast}}(z_c))$와 $L(z_c, A)$ 중 하나를 최소화합니다.

4. **2D 분할 CNN과 3D DAE 통합:** GPU 메모리 제한으로 2D 분할 CNN을 사용하지만, 3D 정보를 활용하기 위해 DAE는 3D CNN으로 모델링됩니다. 3D 테스트 이미지를 연속적인 슬라이스 배치로 나누어 2D CNN을 통과시킨 후, 전체 3D 예측 분할을 3D DAE에 통과시켜 노이즈 제거된 버전을 얻습니다. 이후 2D 배치별로 기울기를 계산하고 평균하여 $\phi$를 업데이트합니다.

## 📊 Results

- **데이터셋:** 뇌 (HCP-T1w, ABIDE-Caltech-T1w, HCP-T2w), 전립선 (NCI, USZ, PROMISE12), 심장 (ACDC, RVSC)의 다중 MRI 데이터셋에서 제안 방법의 유효성을 검증했습니다.
- **정량적 성능 향상:**
  - 제안된 테스트 시점 적응(TTA) 방법은 모든 해부학적 구조(뇌, 전립선, 심장)와 데이터셋에 걸쳐 데이터 증강, 메타 학습, 비지도 도메인 적응(UDA)과 같은 경쟁 방법에 비해 **일관되고 상당한 성능 향상**을 보였습니다. 특히 Dice score와 Hausdorff distance 지표에서 개선을 나타냈습니다.
  - 'SD + DA + Post-Proc.'와 비교했을 때, 제안 방법은 5개 데이터셋 중 3개에서 통계적으로 유의미한 Dice score 향상을 달성했습니다.
  - 'Fast' 버전의 TTA는 첫 이미지의 최적 파라미터로 초기화하여 이후 이미지의 적응 시간을 단축하면서도 유사한 성능을 유지하여 실용성을 입증했습니다.
- **정성적 결과:** TTA는 예측 분할에서 맥락적으로 잘못된 부분을 수정하고, 장기 형태를 완성하며, 이상치를 제거하는 등 'SD + DA' baseline 대비 시각적으로도 명확한 개선을 보여주었습니다.
- **UDA와의 비교:** TTA는 레이블된 소스 도메인 데이터셋이 필요 없음에도 불구하고, 비지도 도메인 적응(UDA) 방법 중 가장 성능이 좋은 방법과 **비교 가능한 결과**를 달성했습니다. 이는 TTA가 더 유연하고 실용적인 대안임을 시사합니다.
- **어블레이션 연구:**
  - I2NI ($\phi$)뿐만 아니라 NI2S ($\theta$) 파라미터까지 모두 적응시켰을 때는 Dice score는 감소했으나 Hausdorff distance는 개선되는 경향을 보였습니다. 이는 분할 가장자리의 정확도가 떨어질 수 있음을 나타내어, 대부분의 파라미터를 고정하는 것이 중요함을 시사합니다.
  - DAE 대신 실제(Ground Truth) 레이블을 사용하여 I2NI를 적응시켰을 때, 정확도는 향상되었지만 여전히 타겟 도메인에 대해 개별 CNN을 훈련한 벤치마크보다는 낮은 성능을 보여, NI2S CNN에 소스 도메인 편향이 남아있을 수 있음을 시사했습니다.
  - DAE를 단순히 여러 번 통과시켜 후처리하는 것은 TTA만큼의 분할 정확도 개선을 가져오지 못했으며, 특정 데이터셋에서는 오히려 성능이 저하되기도 했습니다. 이는 DAE 출력이 입력 이미지와 반드시 직접적으로 연결되지 않을 수 있기 때문으로 분석됩니다.
- **수렴성:** 테스트 시점 적응은 다양한 해부학적 구조 및 타겟 도메인의 100개 이상의 테스트 볼륨 이미지에 대해 안정적으로 수렴하는 것으로 확인되었습니다. 예측 분할과 실제 분할 간의 Dice score와 DAE 입력 및 출력 간의 Dice score는 강한 상관관계를 보였습니다.

## 🧠 Insights & Discussion

- **시사점:** 제안된 테스트 시점 적응 방법은 의료 영상 분할에서 스캐너 및 프로토콜 변화와 같은 도메인 이동에 대한 강건성을 크게 향상시킬 수 있는 유망한 접근 방식임을 보여줍니다. 특히, 각 이미지별 적응성과 DAE를 통한 타당성 확보가 핵심입니다. 이 방법은 알려지지 않은 도메인에도 적용 가능하여, 의료 영상 분석 도구의 실제 배포 가능성을 높입니다.
- **한계점 및 향후 연구 방향:**
  - **DAE 훈련을 위한 노이즈 전략:** 현재의 휴리스틱 노이즈 생성 전략이 DAE 성능을 제한할 수 있습니다. 실제 TD 이미지에서 예측되는 부정확한 분할을 더 잘 모방하는 노이즈 전략 개발이 필요합니다.
  - **DAE 출력의 확률적 가정:** DAE가 '유일한' 깨끗한 분할 대신 '여러 가능한' 노이즈 제거된 분할을 출력하도록 훈련하는 것이 성능에 도움이 될 수 있습니다.
  - **정규화된 이미지에 대한 사전 정보:** 테스트 시점 적응이 단순히 TD에서 SD로의 '변환기' 역할보다는, 중간 정규화 표현에 대한 추가 제약을 통해 더 잘 유도될 수 있습니다.
  - **큰 도메인 이동을 위한 아핀 등록:** 현재 뇌 영상에 대해서만 아틀라스 기반 초기화가 평가되었으며, 다른 해부학적 구조나 더 큰 도메인 이동에 대한 일반적인 아핀 등록 적용에 대한 추가 검증이 필요합니다.
  - **PGM 프레임워크에서의 TTA:** 지도 학습 CNN의 테스트 시점 적응을 확률적 그래픽 모델(PGM) 프레임워크에 통합하여 명시적인 사전 및 가능성 모델을 활용하는 것을 고려할 수 있습니다.
  - **테스트 시점 적응 소요 시간:** 각 3D 이미지당 약 12분(고속 버전)의 추가 시간이 소요됩니다. 이는 임상 환경에서 합리적일 수 있지만, CNN의 빠른 추론이라는 장점을 일부 희생하므로 시간 효율성 최적화가 중요합니다.

## 📌 TL;DR

본 연구는 의료 영상 분할에서 훈련 데이터와 테스트 데이터 간의 스캐너/프로토콜 불일치(도메인 이동)로 인한 CNN의 성능 저하 문제를 해결하기 위해 **테스트 시점 적응(Test-Time Adaptation, TTA)** 방법을 제안합니다. 핵심 아이디어는 분할 CNN을 이미지 정규화(I2NI) 네트워크 $N_{\phi}$와 분할(NI2S) 네트워크 $S_{\theta}$로 분리한 후, 테스트 시점에 $N_{\phi}$만을 각 이미지에 맞게 적응시키는 것입니다. 이 적응 과정은 미리 훈련된 **노이즈 제거 오토인코더(DAE)**가 예측 분할의 '타당성'에 대한 암시적 사전 정보를 제공함으로써 유도됩니다. 뇌, 심장, 전립선 MRI 데이터셋에 대한 실험 결과, 제안된 TTA 방법은 데이터 증강, 메타 학습, 비지도 도메인 적응 등 기존 방법들보다 **일관되게 우수한 성능**을 보여주었으며, 보이지 않는 도메인에 대한 강건하고 일반화 가능한 의료 영상 분할의 잠재력을 입증합니다.
