# Mutual Consistency Learning for Semi-supervised Medical Image Segmentation

Yicheng Wu, Zongyuan Ge, Donghao Zhang, Minfeng Xu, Lei Zhang, Yong Xia, Jianfei Cai

## 🧩 Problem to Solve

의료 영상 분할을 위한 딥러닝 모델은 고밀도 주석(annotation)이 달린 의료 데이터의 부족으로 인해 성능이 제한되는 경우가 많습니다. 이러한 데이터는 획득하고 주석을 다는 데 비용이 많이 들고 시간이 오래 걸려, 모델이 과적합되기 쉽습니다. 특히, 기존의 준지도 학습(semi-supervised learning) 방법들은 모호한 영역(예: 유착된 가장자리, 얇은 가지)에서 모델이 매우 불확실하고 쉽게 오분류하는 예측을 내놓는 "학습의 어려움(learning difficulties)"을 효과적으로 활용하지 못하고 있습니다. 본 논문은 이러한 불확실한 영역을 효과적으로 활용하여 준지도 의료 영상 분할 모델의 성능을 향상시키는 것을 목표로 합니다.

## ✨ Key Contributions

- 준지도 분할을 위한 MC-Net+ 모델을 제안했습니다. 이 모델은 어려운 영역에서 일관되고 낮은 엔트로피(low-entropy) 예측을 강제함으로써, 레이블이 없는 데이터를 효과적으로 활용하고 준지도 영상 분할 성능을 향상시킵니다.
- 일관성(consistency)과 엔트로피 최소화(entropy-minimization) 제약 조건을 모두 활용하는 새로운 상호 일관성(mutual consistency) 학습 방식을 설계하여, 모델이 일반화된 특징 표현(feature representation)을 학습할 수 있도록 했습니다.
- 세 가지 공개 의료 데이터셋에 대한 광범위한 실험을 통해 제안된 MC-Net+ 모델이 최신(state-of-the-art, SOTA) 방법 5가지를 능가하며 준지도 의료 영상 분할에서 새로운 SOTA를 달성했음을 입증했습니다.
- 이전 버전(MC-Net)에 또 다른 디코더를 포함하여 모델 내 다양성을 더욱 높였으며, 추가 추론 비용(inference costs) 없이 테스트 단계에서 원래의 인코더-디코더 아키텍처를 사용할 수 있도록 했습니다.

## 📎 Related Works

- **준지도 학습 (Semi-supervised Learning, SSL):**
  - **일관성 기반 모델:** 데이터 증강(_Zhang et al., 2017_), 특징 공간 교란(_Ouali et al., 2020_), Mean-Teacher 모델(_Tarvainen and Valpola, 2017_) 및 적대적 학습(_Miyato et1 al., 2018_)을 통해 입력의 작은 교란이 출력에 큰 변화를 주지 않도록 합니다.
  - **엔트로피 최소화 기반 모델:** 각 클래스의 클러스터가 낮은 엔트로피를 가져야 한다는 가정에 기반합니다(_Kalluri et al., 2019_). 의사 레이블(pseudo-label) 학습(_Lee et al., 2013; Chen et al., 2021_)은 샤프닝 함수(sharpening function)를 사용하여 확률 맵을 의사 레이블로 변환합니다. 본 논문은 이 두 가지 접근 방식을 모두 활용합니다.
- **준지도 의료 영상 분할:** 불확실성 인식 Mean-Teacher 모델(_Yu et al., 2019_), 형태 제약(_Li et al., 2020b_), 다중 스케일 일관성(_Luo et al., 2021a,b_), 다중 뷰 공동 학습(_Xia et al., 2020b_) 등의 방법들이 제안되었습니다. 본 연구는 *Chen et al., 2021*의 CPS 모델과 유사하게 순환 일관성(cycled-consistency)을 사용하지만, MC-Net+는 동일한 아키텍처와 다른 초기화 대신 공유된 인코더와 _다르게 업샘플링하는_ 디코더들을 사용합니다.
- **다중 작업 학습 (Multi-task Learning):** 교차 작업 특징 학습, 비지도 사전 학습(_You et al., 2021_), 대조 학습(_Chaitanya et al., 2020_) 등이 모델 일반화에 기여합니다. 본 논문의 방법은 보조 작업을 설계할 필요 없이 원래 분할 작업에만 초점을 맞추지만, 다른 다중 작업 학습 모델과 쉽게 결합될 수 있습니다.
- **불확실성 추정 (Uncertainty Estimation):** 모델의 예측 신뢰도를 정량화하는 데 중점을 둡니다. 베이지안 딥러닝에서 모델 앙상블(_Lakshminarayanan et al., 2016_)이나 MC-Dropout(_Gal and Ghahramani, 2016_)을 통해 불확실성을 추정합니다. MC-Net+는 미리 정의된 여러 서브 모델을 사용하여 단일 전방 전달(forward pass)에서 불확실성을 추정합니다.

## 🛠️ Methodology

1. **모델 아키텍처 (MC-Net+):**
   - **불확실성 추정:** 기존 MC-Dropout이 여러 번의 전방 전달을 요구하는 문제를 해결하기 위해, MC-Net+는 하나의 공유 인코더 $f_{\theta_e}$와 $n$개의 약간 다른 디코더 $f_{\theta_d^i}$로 구성됩니다.
   - 각 서브 모델 $f_{\theta_{\text{sub}}^i}$는 공유 인코더와 하나의 디코더로 구성되며, 이는 표준 인코더-디코더 아키텍처(예: V-Net, U-Net)입니다.
   - 본 논문에서는 $n=3$으로 설정하여 전치 컨볼루션(transposed convolution) 레이어, 선형 보간(linear interpolation) 레이어, 최근접 이웃 보간(nearest interpolation) 레이어를 사용하여 세 가지 다른 업샘플링 전략을 통해 디코더를 구성함으로써 모델 내 다양성을 높입니다.
   - 여러 디코더 출력의 통계적 불일치 $D$는 픽셀/복셀 수준의 불확실성 $\mu_x$을 나타냅니다.
2. **상호 일관성 학습 (Mutual Consistency Training):**
   - **샤프닝 함수:** 모델의 출력 확률 맵 $p(y_{\text{pred}}|x;\theta)$을 소프트 의사 레이블 $p^*(y^*_{\text{pred}}|x;\theta)$로 변환합니다. 이는 다음 공식으로 정의됩니다:
     $$p^*(y^*_{\text{pred}}|x;\theta) = \frac{p(y_{\text{pred}}|x;\theta)^{1/T}}{p(y_{\text{pred}}|x;\theta)^{1/T} + (1-p(y_{\text{pred}}|x;\theta))^{1/T}}$$
     여기서 $T$는 샤프닝의 강도를 조절하는 하이퍼파라미터입니다.
   - **상호 일관성 제약:** 한 디코더의 확률 출력과 다른 디코더들의 소프트 의사 레이블 간에 일관성 제약(consistency constraint)을 적용합니다. 이를 통해 여러 출력 간의 불일치를 최소화하고 모델 불확실성을 줄여 모델 학습을 안내합니다.
   - **손실 함수:** 감독(supervised) 손실과 상호 일관성 손실의 가중치 합으로 모델을 학습시킵니다:
     $$L_{\text{mc}} = \sum_{i,j=1 \& i \neq j}^{n} D[p^*(y^*_{\text{pred}}|x;\theta^i_{\text{sub}}), p(y_{\text{pred}}|x;\theta^j_{\text{sub}})]$$
     $$\text{Loss} = \lambda \times \sum_{i=1}^{n} L_{\text{seg}}(p(y_{\text{pred}}|x^l;\theta^i_{\text{sub}}), y^l) + \beta \times L_{\text{mc}}$$
     여기서 $L_{\text{seg}}$는 분할 작업을 위한 Dice 손실이며, $D$는 쌍을 이루는 입력에 대한 MSE(Mean Squared Error) 손실입니다. $\lambda$와 $\beta$는 두 손실의 균형을 맞추는 하이퍼파라미터입니다. $L_{\text{mc}}$는 레이블이 지정된 데이터와 레이블이 지정되지 않은 데이터 모두에 적용됩니다.

## 📊 Results

- **데이터셋:** LA (좌심방 MR), Pancreas-CT (췌장 CT), ACDC (심장 MR) 세 가지 공개 의료 데이터셋에서 MC-Net+ 모델을 평가했습니다.
- **우수한 성능:** MC-Net+는 세 가지 데이터셋 모두에서 최신 준지도 학습 방법 5가지보다 우수한 성능을 보이며 새로운 SOTA를 달성했습니다.
  - LA 데이터셋에서 10%의 레이블 데이터만으로도 55%에서 70%의 Dice 점수 향상을 달성했으며, 20%의 레이블 데이터로는 전체 레이블 데이터로 학습한 V-Net 모델(91.62%)에 필적하는 91.07%의 Dice 점수를 기록했습니다.
  - 질적(qualitative) 결과에서도 MC-Net+는 다른 SOTA 방법들보다 더 완전한 좌심방 분할 결과를 생성했으며, 분리된 영역을 제거하고 얇은 가지와 같은 미세한 세부 사항을 잘 보존했습니다.
  - Pancreas-CT 데이터셋에서는 Multi-scale MC-Net+ 모델이 각 설정에서 최고의 성능을 달성하여, 본 모델이 다른 다중 스케일 방법들과 쉽게 결합될 수 있음을 보여주었습니다.
  - ACDC 데이터셋의 2D 다중 클래스 분할 작업에서도 MC-Net+는 각 클래스에서 뛰어난 Dice 성능 향상을 보였습니다.
- **효율성:** 추론 단계에서는 추가적인 계산 비용이 발생하지 않습니다.
- **어블레이션 연구:** 모델 불확실성 감소(상호 일관성)가 성능 향상에 가장 중요한 요소였으며, 디코더에 다른 업샘플링 전략을 사용하는 것(모델 내 다양성)도 긍정적인 영향을 미쳤음을 확인했습니다.

## 🧠 Insights & Discussion

- **의미 및 시사점:** 레이블 없는 데이터의 불확실하고 어려운 영역을 효과적으로 활용하는 것이 준지도 의료 영상 분할에 매우 중요함을 입증했습니다. 제안된 상호 일관성 기법은 이러한 영역에서 일관되고 낮은 엔트로피 예측을 효과적으로 강제합니다.
- **견고성:** 샤프닝 함수에 사용되는 온도 하이퍼파라미터 $T$에 대해 비교적 견고한 성능을 보입니다.
- **일반화 가능성:** MC-Net+는 특정 백본(backbone)에 의존하지 않으며(V-Net, U-Net 모두 사용 가능) 2D 또는 3D 분할과 같은 다양한 의료 작업에 적용할 수 있습니다.
- **실용적 이점:** 후처리 모듈이나 형태 관련 제약 없이도 만족스러운 분할 결과를 생성하고, 어려운 영역을 정확하게 분할하며, 추론 비용을 추가하지 않아 CAD(Computer-Aided Diagnosis) 시스템 구축에 유용합니다.
- **한계점:**
  - 모델 설계가 미리 정의된 여러 디코더에 의존하며, 기존 업샘플링 전략의 선택이 제한적입니다. 향후 더 다양한 모델 아키텍처를 탐색하여 모델 내 다양성을 높일 필요가 있습니다.
  - 모델 수준의 교란만 탐구되었고, 데이터 수준의 교란, 특히 의료 데이터에 적합한 데이터 특정 교란(data-specific perturbation) 작업 개발이 향후 연구 방향입니다.

## 📌 TL;DR

본 논문은 레이블이 없는 데이터의 불확실한 영역을 효과적으로 활용하는 준지도 의료 영상 분할 모델인 MC-Net+를 제안합니다. 이 모델은 공유 인코더와 여러 개의 약간 다른 디코더(서로 다른 업샘플링 전략 사용)를 사용하여 모델 불확실성을 추정합니다. 그리고 한 디코더의 확률 출력과 다른 디코더의 소프트 의사 레이블 사이에 새로운 상호 일관성 제약(mutual consistency constraint)을 적용하여, 어려운 영역에서 불변하고 낮은 엔트로피 예측을 강제합니다. MC-Net+는 세 가지 의료 데이터셋에서 최신 성능을 달성하며 추가 추론 비용 없이 새로운 SOTA를 수립했습니다.
