# Deep Learning-Based Regression and Classification for Automatic Landmark Localization in Medical Images

Julia M. H. Noothout, Bob D. de Vos, Jelmer M. Wolterink, Elbrich M. Postma, Paul A. M. Smeets, Richard A. P. Takx, Tim Leiner, Max A. Viergever and Ivana Išgum

## 🧩 Problem to Solve

의료 영상에서 해부학적 랜드마크를 자동으로 빠르고 정확하게 찾는 것은 영상 정합, 분할 초기화, 임상 측정 등 다양한 의료 영상 분석 작업의 필수적인 선행 조건입니다. 수동 랜드마크 식별은 시간이 많이 걸리고 번거로우며, 특히 다수의 랜드마크를 정밀하게 찾아야 할 때 효율적이지 못합니다. 이 연구는 이 문제를 해결하기 위해 의료 영상에서 해부학적 랜드마크를 자동으로 정확하고 신속하게 찾아내는 방법을 제안합니다.

## ✨ Key Contributions

- **전역-지역(Global-to-Local) 랜드마크 탐색 접근 방식**: 완전 합성곱 신경망(FCNN)을 활용하여 먼저 여러 랜드마크의 전역적 위치를 추정하고, 이후 전문화된 FCNN이 각 랜드마크의 최종 위치를 정교화합니다.
- **회귀 및 분류 동시 수행**: 이미지 패치 기반의 FCNN이 회귀(변위 벡터 예측)와 분류(패치 내 랜드마크 존재 여부 예측)를 동시에 수행하여 랜드마크를 찾습니다.
- **가중 평균을 통한 최종 랜드마크 위치 결정**: 회귀를 통해 예측된 변위 벡터들을 분류에서 얻은 사후 확률(posterior probability)로 가중 평균하여 최종 랜드마크 위치를 결정함으로써 정확도를 높입니다.
- **로그 변환된 변위 벡터 회귀의 이점 입증**: 로그 변환된 변위 벡터에 대한 회귀가 랜드마크 탐색 성능을 개선함을 보여줍니다.
- **다양한 의료 영상 적용 가능성**: 3D 심장 CT 혈관조영술(CCTA), 3D 후각 자기공명영상(MR), 2D 두부계측 X-선 등 다양한 영상 양식, 차원, 해부학적 영역의 랜드마크 탐색에서 높은 정확도를 입증했습니다.
- **최첨단 방법 대비 우월한 성능 및 속도**: 다른 최첨단 랜드마크 탐색 방법들과 비교하여 단일 랜드마크 탐색에서 우수하거나 유사한 성능을 보였으며, 처리 속도는 훨씬 빠릅니다.

## 📎 Related Works

- **전통적인 머신러닝 기반 방법**:
  - 분류 기반: 이미지 슬라이스, 패치, 복셀에서 랜드마크 존재 여부 감지 (Oktay et al. [7], Zheng et al. [12], Ibragimov et al. [18], Dabbah et al. [19], Mahapatra et al. [20], Lu et al. [21], Urschler et al. [22], Donner et al. [23]).
  - 회귀 기반: 랜드마크까지의 변위 또는 거리 예측 (Han et al. [5], Oktay et al. [7], Al et al. [9], Urschler et al. [22], Štern et al. [24], Gao et al. [25], Lindner et al. [26]).
- **딥러닝 기반 방법**:
  - 분류 기반: CNN을 이용한 슬라이스/복셀/픽셀 분류 (Yang et al. [31], Zheng et al. [29], Arik et al. [32], Xu et al. [33]).
  - 회귀 기반 (히트맵 예측): 랜드마크 위치를 나타내는 히트맵 예측 (Torosdagli et al. [10], Wolterink et al. [34], Payer et al. [35], Zhang et al. [36], Meyer et al. [37], O’Neil et al. [30]).
  - 회귀 기반 (변위 벡터 예측): 분석된 복셀에서 랜드마크까지의 변위 벡터 예측 (Zhang et al. [38]).
  - 반복적 랜드마크 결정: 초기 패치에서 랜드마크로의 변위를 반복적으로 예측 (Aubert et al. [39], Li et al. [40]).
  - 강화 학습 이용: 최적의 탐색 경로 획득 (Ghesu et al. [41], Alansary et al. [42], Al et al. [43]).
- **멀티-아틀라스 영상 정합**: 아틀라스 이미지를 관심 이미지에 정합하여 랜드마크 위치 결정 (Išgum et al. [17], Alam et al. [6]).

## 🛠️ Methodology

제안된 방법은 ResNet 기반의 완전 합성곱 신경망(FCNN)을 사용하는 전역-지역(Global-to-Local) 랜드마크 탐색 접근 방식을 따릅니다.

1. **전역 랜드마크 탐색 (Global Landmark Localization)**:

   - **입력**: 전체 의료 영상 (2D 또는 3D).
   - **네트워크**: ResNet34 [44] 기반의 FCNN. 1개의 컨볼루션 레이어(16개 $7 \times 7 \times 7$ 커널, stride 2)와 4개의 ResNet-블록으로 구성됩니다. 각 ResNet-블록 앞에는 평균 풀링 레이어가 추가되어 수용장(receptive field)을 넓힙니다.
   - **동시 회귀 및 분류**: 네트워크는 각 이미지 패치에 대해 다음을 동시에 예측합니다.
     - **회귀 (R)**: 패치 중심에서 관심 랜드마크까지의 변위 벡터. 손실 함수 계산 시 `log-transformed` 변위 벡터를 사용합니다.
     - **분류 (C)**: 패치 내에 랜드마크가 존재하는지 여부에 대한 사후 확률.
   - **최종 전역 위치**: 예측된 변위 벡터들을 분류에서 얻은 사후 확률을 가중치로 사용하여 가중 평균하여 각 랜드마크의 전역적 위치를 얻습니다.

2. **지역 랜드마크 정교화 (Local Landmark Refinement)**:

   - **입력**: 전역 탐색으로 얻은 랜드마크 위치 주변의 지역 부분 영상 (sub-image).
   - **네트워크**: 전역 FCNN과 유사하지만 더 작은 디자인의 전문화된 FCNN (2개의 ResNet-블록, 평균 풀링, 병렬 회귀 및 분류 헤드).
   - **동시 회귀 및 분류**: 전역 단계와 동일하게 지역 부분 영상 내에서 회귀 및 분류를 수행하여 랜드마크 위치를 더 정교하게 예측합니다.
   - **최종 지역 위치**: 전역 단계와 동일한 방식으로 가중 평균을 통해 최종 랜드마크 위치를 결정합니다.

3. **네트워크 세부 사항**:
   - 모든 컨볼루션 레이어는 제로 패딩을 적용하고, 각 컨볼루션 레이어 뒤에는 배치 정규화(batch normalization) [46]가 적용됩니다.
   - 임의의 크기 이미지에 적용 가능하도록 3D 특징 맵은 평탄화되지 않으며, 조밀한(dense) 레이어는 $1 \times 1 \times 1$ 컨볼루션으로 구현됩니다 [45].
   - 활성화 함수: ReLU (중간 레이어), 선형 (회귀 출력), 시그모이드 (분류 출력, $0$과 $1$ 사이의 사후 확률).
   - 손실 함수: 회귀 출력과 참조 변위 간의 평균 절대 오차(Mean Absolute Error, `log-transformed` 변위 벡터에 적용)와 분류 출력과 참조 레이블 간의 이진 교차 엔트로피(Binary Cross-Entropy)의 조합.
   - 최적화 알고리즘: Adam (학습률 $0.001$) [47].
   - 완전 합성곱 특성 덕분에 네트워크는 다양한 크기의 입력 이미지를 분석할 수 있으며, 출력은 풀링 레이어와 stride가 있는 컨볼루션 레이어의 합에 의해 결정되는 $2^n$ 복셀의 그리드 간격으로 분포됩니다.

## 📊 Results

이 방법은 3가지 다양한 데이터셋(CCTA, Olfactory MR, Cephalometric X-ray)에서 평가되었으며, 높은 정확도와 빠른 처리 속도를 보였습니다.

- **심장 CT 혈관조영술 (CCTA)**:

  - 8개의 심장 랜드마크 탐색.
  - 중앙 유클리드 거리 오차: 1.45mm에서 2.48mm (1.03에서 1.65 복셀).
  - 이는 내부 관찰자(intra-observer) 변동성 (1.43-2.68mm)과 유사하거나 더 좋았고, 두 번째 관찰자(second observer) 변동성 (1.73-3.46mm)보다 우수했습니다.
  - 처리 시간: 스캔당 평균 $0.06 \pm 0.05$ 초.
  - 해부학적 이상(예: 관상동맥 입구가 비정상적으로 위치)이 있는 스캔에서 더 큰 오차가 발생했습니다.

- **후각 자기공명영상 (Olfactory MR)**:

  - 오른쪽 및 왼쪽 후각구 탐색.
  - 중앙 유클리드 거리 오차: 오른쪽 후각구 0.87mm, 왼쪽 후각구 0.90mm.
  - 4mm 거리 임계값에서 95.0%의 성공 탐지율(SDR)을 달성했습니다.
  - 처리 시간: 스캔당 평균 $0.07 \pm 0.01$ 초.

- **두부계측 X-선 (Cephalometric X-rays)**:

  - 19개의 랜드마크 탐색.
  - 중앙 유클리드 거리 오차: Test1에서 0.46-2.12mm, Test2에서 0.42-4.32mm.
  - 모든 랜드마크의 평균 거리 오차는 $1.35 \pm 1.19$mm로, 첫 번째 관찰자의 내부 관찰자 변동성 및 관찰자 간 변동성보다 낮았습니다.
  - 기존 연구들 (Ibragimov et al. [18], Lindner et al. [26], Arik et al. [32], Payer et al. [35], Urschler et al. [22])보다 모든 거리 임계값에서 더 나은 성공 탐지율(SDR)을 보였습니다.
  - 처리 시간: 스캔당 평균 $0.05 \pm 0.009$ 초.

- **Ablation Study**:

  - 회귀에 로그 변환을 적용하고 분류를 결합한 (`R_{\text{log}} + C`) 전역 탐색이 가장 좋은 성능을 보였습니다.
  - 전역-지역 접근 방식이 전역 탐색만 사용하는 것보다 더 작은 거리 오차를 달성했습니다.

- **최첨단 방법과의 비교**:
  - CCTA 및 Olfactory MR 데이터셋에서 Alansary et al. [42] 및 Payer et al. [35]의 방법과 비교했을 때, 제안된 방법은 단일 랜드마크 탐색에서 통계적으로 유의미하게 우수했습니다.
  - 멀티-랜드마크 탐색의 경우 Payer et al. [35]와 성능 차이는 유의미하지 않았습니다.
  - 제안된 방법은 비교된 모든 최첨단 방법보다 현저히 빠른 처리 속도를 보였습니다 (CCTA에서 최대 10배 이상 빠름).

## 🧠 Insights & Discussion

이 연구는 의료 영상에서 해부학적 랜드마크를 자동으로 탐색하는 빠르고 정확한 방법을 성공적으로 제시했습니다. 핵심 통찰은 다음과 같습니다.

- **회귀와 분류의 시너지**: 패치 기반 분류의 내재적 정밀도 한계를 회귀를 통해 예측된 변위 벡터로 보완하고, 회귀 결과의 불확실성을 분류의 사후 확률로 가중치를 부여하여 완화함으로써 정확도를 크게 향상시켰습니다. 이는 단일 태스크 접근 방식보다 우수한 성능을 가져왔습니다.
- **로그 변환 변위 벡터의 중요성**: 변위 벡터에 로그 변환을 적용하는 것이 랜드마크 탐색 성능을 더욱 향상시켰습니다. 이는 랜드마크에 가까운 패치에서의 예측 오차에 더 큰 페널티를 부여하여 학습을 효율적으로 유도했기 때문으로 분석됩니다.
- **전역-지역 접근의 효율성**: 넓은 영역에서 여러 랜드마크를 동시에 빠르게 찾은 다음, 개별 랜드마크 위치를 국소적으로 정교화하는 방식은 복잡한 전체 영상 분석의 부담을 줄이면서도 높은 정밀도를 유지할 수 있게 합니다.
- **일반성 및 실용성**: 이 방법은 2D 및 3D, 다양한 모달리티(CT, MR, X-ray), 다양한 해부학적 영역(심장, 뇌, 두부)에 걸쳐 높은 정확도를 유지하며 적용 가능함을 입증했습니다. 이는 임상 환경에서의 넓은 적용 가능성을 시사합니다.
- **성능과 속도**: 제안된 방법은 수동 관찰자 수준의 정확도를 달성하며, 기존 최첨단 딥러닝 기반 방법들보다 훨씬 빠른 처리 속도를 제공합니다. 이는 대규모 데이터셋 분석이나 실시간 애플리케이션(예: 수술 중 가이드)에 매우 유리합니다.
- **한계 및 향후 개선**:
  - **하드웨어 제약**: 현재 하드웨어 메모리 한계로 인해 원본 해상도에서 전체 이미지를 분석하기 어렵고, 다운샘플링이 필요했습니다. 이는 밀리미터 단위의 거리 오차에 부정적인 영향을 미칠 수 있습니다. 향후 하드웨어 개선 또는 이미지 분할 추론 방식을 통해 더 높은 해상도에서의 분석이 필요합니다.
  - **해부학적 변이**: 드물지만 심각한 해부학적 이상(예: 관상동맥 입구의 이소성 위치)이 있는 경우 오차가 증가했습니다. 이러한 변이를 포착하기 위해 더 많은 훈련 데이터 또는 탄성 변환과 같은 데이터 증강(data augmentation) 기법을 활용하여 데이터셋의 다양성을 늘릴 필요가 있습니다.
  - **사전 분할 불필요**: 이전 연구들이 대동맥 분할과 같은 사전 분할 단계를 요구했던 것과 달리, 제안된 방법은 데이터에서 직접 학습하여 사전 처리 단계 없이도 정확한 탐색을 달성했습니다.

## 📌 TL;DR

이 논문은 의료 영상에서 해부학적 랜드마크를 자동으로 탐색하기 위한 빠르고 정확한 **전역-지역(Global-to-Local) 접근 방식**을 제안합니다. 이 방법은 완전 합성곱 신경망(FCNN)을 사용하여 **패치 기반 회귀(변위 벡터 예측)와 분류(랜드마크 존재 여부 예측)를 동시에** 수행하고, 분류에서 얻은 확률로 회귀 예측을 **가중 평균**하여 최종 랜드마크 위치를 결정합니다. CCTA, Olfactory MR, Cephalometric X-ray 등 **다양한 영상 양식 및 해부학적 영역에서 높은 정확도**를 입증했으며, 특히 **로그 변환된 변위 벡터 회귀**를 통해 성능을 개선했습니다. 기존 최첨단 방법들과 비교하여 **우수하거나 동등한 정확도를 보이면서 훨씬 빠른 처리 속도**를 달성하여, 대규모 데이터 분석 및 실시간 의료 애플리케이션에 적합함을 보여줍니다.
