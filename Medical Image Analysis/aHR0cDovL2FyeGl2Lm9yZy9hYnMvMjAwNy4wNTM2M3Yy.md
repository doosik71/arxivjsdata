# Semi-supervised Task-driven Data Augmentation for Medical Image Segmentation

Krishna Chaitanya, Neerav Karani, Christian F. Baumgartner, Ertunc Erdil, Anton Becker, Olivio Donati, Ender Konukoglu

## 🧩 Problem to Solve

의료 영상 분할(Medical Image Segmentation)은 정확한 진단에 필수적이지만, 픽셀 단위의 정교한 주석(annotation)이 필요한 학습 데이터를 대량으로 확보하기 어렵고 비용과 시간이 많이 소요됩니다. 기존의 제한된 라벨 데이터 학습 방법(예: 무작위 데이터 증강, GAN 기반 이미지 생성)들은 영상 분할 작업 자체에 최적화되지 않아 만족할 만한 성능 향상을 가져오지 못했습니다. 이 논문은 이러한 라벨 데이터 부족 문제를 해결하고, 적은 수의 주석 데이터로도 뛰어난 일반화 성능을 보이는 딥러닝 모델을 개발하는 것을 목표로 합니다.

## ✨ Key Contributions

- **작업 주도형(Task-driven) 데이터 증강 방법론 제안:** 합성 데이터 생성기가 분할 작업 자체에 최적화되도록 설계된 새로운 데이터 증강 방법론을 제안합니다.
- **두 가지 변형 모델 도입:** 형태(shape) 및 강도(intensity) 변화를 모델링하기 위해 변형 필드(deformation field) 생성기와 가산 강도 필드(additive intensity field) 생성기를 사용합니다.
- **준지도 학습(Semi-supervised Learning) 프레임워크:** 라벨링된 데이터뿐만 아니라 라벨링되지 않은 데이터도 활용하여 두 변형 모델을 최적화합니다.
- **규제 손실(Regularization Loss) 도입:** 적대적 손실(adversarial loss)과 큰 편차(large deviation) 손실을 결합하여, 생성된 데이터가 라벨링되지 않은 데이터 분포와 일치하면서도 분할 네트워크에 도전적인(non-trivial) 큰 변화를 갖도록 유도합니다.
- **현실성 가정에 대한 도전:** 생성된 증강 이미지가 반드시 해부학적으로 '현실적'일 필요는 없으며, 작업에 최적화된(task-optimal) 이미지가 더 나은 분할 성능을 가져올 수 있음을 실험적으로 입증합니다.
- **뛰어난 성능 입증:** 심장, 전립선, 췌장 등 세 가지 의료 데이터셋에 대한 실험을 통해 기존의 표준 증강 및 준지도 학습 방법론 대비 제안 방법의 상당한 성능 향상을 보고합니다.

## 📎 Related Works

- **데이터 증강 (Data Augmentation):**
  - 무작위 아핀 변환(random affine transformations) [4], 무작위 탄성 변환(random elastic deformations) [1, 2], 무작위 대비 변환(random contrast transformations) [5, 6].
  - GAN(Generative Adversarial Networks)을 활용한 현실적인 이미지-라벨 쌍 생성 [8-17].
  - MixUp [18]: 이미지와 해당 라벨을 선형 보간하여 데이터를 생성.
  - 메타 학습 기반 작업 최적화 증강 [20]: 분류 성능을 생성기 학습에 포함했으나, 완전 지도 방식이며 많은 클래스 샘플을 요구하고 도메인 지식을 활용하지 않음.
  - 기하학적 변환을 위한 매니폴드 탐색 [21]: 분류 작업에 주로 적용되며 기하학적 변형에만 초점을 맞춤.
- **준지도 학습 (Semi-supervised Learning, SSL):**
  - 자기 학습(Self-training) [22-26]: 이미 학습된 네트워크를 비라벨 데이터의 예측 라벨(pseudo-labels)로 재학습. 초기 예측이 부정확할 경우 문제가 발생할 수 있음.
  - 적대적 학습(Adversarial training) 및 GAN 기반 SSL [27, 28]: 생성기를 분할 네트워크로 사용하거나, 판별기(discriminator)를 규제 항으로 사용.
  - 학습된 변환을 이용한 원샷(one-shot) 데이터 증강 [29]: 이미지 등록(registration)에 의존하며, 생성기가 작업 성능에 최적화되지 않고 배경 구조의 영향을 받을 수 있음.

## 🛠️ Methodology

제안하는 방법은 분할 네트워크($S$)의 파라미터($w_S$)와 데이터 생성기($G$)의 파라미터($w_G$)를 동시에 최적화하여 증강 데이터가 분할 작업에 가장 효과적이도록 합니다.

**전반적인 최적화 목표:**
$$ \min*{w_G} \left( \min*{w*S} L_S(X_L \cup X_G, Y_L \cup Y_G) + L*{reg,G}(X*{UL}) \right) $$
여기서 $X_L, Y_L$은 라벨링된 데이터, $X_G, Y_G$는 생성된 증강 데이터, $X*{UL}$은 라벨링되지 않은 데이터입니다.

**두 가지 조건부 생성기 (Conditional Generators):**

1. **변형 필드 생성기 ($G_V$):**
   - 입력: 라벨링된 이미지 $x_L$과 무작위 벡터 $z$.
   - 출력: 픽셀 단위의 조밀한 변형 필드 $v = G_V(x_L, z; w_{G_V})$.
   - 증강된 쌍: $(x_{G_V}, y_{G_V}) = (v \circ x_L, v \circ y_L)$ (여기서 $\circ$는 워핑(warping) 연산).
2. **가산 강도 필드 생성기 ($G_I$):**
   - 입력: 라벨링된 이미지 $x_L$과 무작위 벡터 $z$.
   - 출력: 이미지에 더해지는 강도 마스크 $\Delta I = G_I(x_L, z; w_{G_I})$.
   - 증강된 쌍: $(x_{G_I}, y_{G_I}) = (x_L + \Delta I, y_L)$.

**규제 손실 ($L_{reg,G_C}$):**
$$ L*{reg,G_C} = \lambda*{adv} L*{adv,G_C} + \lambda*{LD} L\_{LD,G_C} \quad \text{for } C=V,I $$

1. **적대적 손실 ($L_{adv,G_C}$):**
   - 표준 GAN 목표를 따르며, 라벨링되지 않은 이미지 $X_{UL}$와 생성된 이미지를 사용하여 판별기 $D_C$를 훈련시킵니다.
   - $D_C$는 실제(비라벨) 이미지와 생성된 이미지(가짜)를 구별하고, $G_C$는 $D_C$를 속이려 합니다. 이 항은 비라벨 데이터를 활용하여 생성된 이미지가 현실적인 분포를 따르도록 합니다.
2. **큰 편차(Large Deviation, LD) 손실 ($L_{LD,G_C}$):**
   - 생성기가 _더 큰_ 변형을 생성하도록 강제하여, 생성기가 분할하기 쉬운 작은 변화를 만드는 것을 방지합니다.
   - $G_V$의 경우: $L_{LD,G_V} = -\|v\|_1$
   - $G_I$의 경우: $L_{LD,G_I} = -\|\Delta I\|_1$
   - 음의 부호는 전체 손실을 최소화할 때 $L_1$ 노름(norm)을 최대화하도록 합니다.
   - $\lambda_{adv}$ 및 $\lambda_{LD}$는 각 손실 항의 가중치를 조절하는 하이퍼파라미터입니다.

**최적화 과정 (Algorithm 1):**

1. **분할 네트워크 사전 훈련:** 분할 네트워크 $S$를 라벨링된 데이터 $X_L, Y_L$로 짧게 사전 훈련합니다.
2. **생성기 및 판별기 공동 훈련:**
   - $(S, G_V, D_V)$ 및 $(S, G_I, D_I)$ 모델을 독립적으로 훈련합니다.
   - 이때 $S$의 분할 손실(증강 데이터 포함)과 $G$의 규제 손실(비라벨 데이터 포함)을 동시에 사용하여 $G_V$와 $G_I$를 최적화합니다.
   - 검증 데이터셋(validation set)을 사용하여 최적의 생성기 파라미터를 선택합니다.
3. **증강 데이터 생성:** 최적화된 $G_V$와 $G_I$를 사용하여 변형된 이미지 ($X_{G_V}, Y_{G_V}$), 강도 변형된 이미지 ($X_{G_I}, Y_{G_I}$), 그리고 두 가지 변형이 모두 적용된 이미지 ($X_{G_{VI}}, Y_{G_{VI}}$)를 생성합니다.
4. **최종 분할 네트워크 훈련:** 분할 네트워크 $S$를 무작위로 재초기화한 후, 원본 라벨링된 데이터, 아핀 변환된 데이터, 그리고 모든 종류의 생성된 증강 데이터를 포함한 전체 데이터셋으로 최종 훈련을 수행합니다.

## 📊 Results

- **데이터셋:** MICCAI'17 ACDC 심장 데이터셋, MICCAI'18 전립선 및 췌장 데이터셋.
- **평가 지표:** Dice Similarity Coefficient (DSC).
- **주요 결과:** 제안하는 방법 (GD+GI)은 라벨링된 데이터가 제한적인 상황($N_L=1$ 또는 $3$)에서 심장, 전립선, 췌장 데이터셋 모두에서 기존의 아핀 변환, 무작위 탄성 변형, 무작위 강도 변동, MixUp, 자기 학습, 적대적 학습 등의 방법보다 일관되게 높은 DSC 성능을 보였습니다.
- **GD 및 GI의 효과:** 학습된 변형 필드(GD)와 가산 강도 마스크(GI)는 무작위 변형(RD, RI)보다 높은 성능을 달성하여, 작업 주도형 최적화의 이점을 보여주었습니다.
- **GD+GI의 시너지 효과:** 두 생성기를 함께 사용했을 때, 단독으로 사용했을 때보다 훨씬 더 큰 성능 향상을 보였습니다.
- **MixUp과의 결합:** MixUp이 단독으로도 상당한 성능 향상을 보였으며, GD+GI와 결합했을 때 추가적인 약간의 개선을 가져왔습니다. 이는 상호 보완적인 이점을 시사합니다.
- **준지도 학습과의 비교:** 자기 학습은 아핀 변형 대비 개선을 보였으나, 제안하는 GD+GI 방법에는 미치지 못했습니다. 적대적 학습은 매우 제한된 라벨 데이터 설정에서 미미한 성능 향상을 보이거나 수렴에 실패하기도 했습니다.
- **어블레이션 연구 (Ablation Studies):**
  - **규제 손실의 효과 ($\lambda_{adv}, \lambda_{LD}$):** 적대적 손실과 큰 편차 손실 모두 중요하며 상호 보완적입니다. 두 손실이 모두 0일 때는 무작위 증강과 유사한 낮은 성능을 보였습니다. 큰 편차 손실($L_{LD}$)만 사용하면 비현실적이고 쓸모없는 변형을 생성하여 성능이 크게 저하되었습니다. 세 가지 손실(분할, 적대적, 큰 편차)이 동시에 경쟁할 때 가장 좋은 결과를 얻었습니다.
  - **생성기와 분할 네트워크의 공동 최적화:** 생성기를 분할 손실과 함께 공동으로 최적화하는 것이 독립적으로 최적화하는 것보다 훨씬 높은 DSC 값을 달성하여, 작업 주도형 최적화의 중요성을 입증했습니다.
  - **비라벨 데이터 수 ($N_{UL}$):** 비라벨 데이터 수가 매우 적을 때($1, 3$개 볼륨)는 성능이 하락했지만, $5$개에서 $25$개 볼륨 사이에서는 성능 향상이 크게 변하지 않았으며, $50$개 볼륨 이상에서는 추가적인 이점이 미미했습니다.
  - **라벨 데이터 수 ($N_L$):** 라벨 데이터 수가 증가할수록 제안 방법과 다른 방법들 간의 성능 격차는 줄어들었습니다. $N_L=10$까지 통계적으로 유의미한 개선이 있었으며, 제안 방법은 $N_L=10$으로 무작위 증강의 $N_L=40$과 유사한 정확도를 달성했습니다.
  - **검증 이미지 없이 훈련:** 놀랍게도 검증 이미지를 사용하지 않고 미리 정의된 반복 횟수 후 훈련을 중단했을 때의 성능이 검증 이미지를 사용하여 최적 모델을 선택했을 때와 크게 다르지 않았습니다.

## 🧠 Insights & Discussion

- **작업 주도형 증강의 중요성:** 생성기를 다운스트림 분할 작업에 직접적으로 최적화하는 것이 "현실적"인 이미지를 생성하는 것보다 우수하다는 것을 보여줍니다.
- **'비현실적' 증강 이미지의 효과:** 제안된 방법으로 생성된 증강 이미지는 때때로 해부학적으로 비현실적일 수 있음에도 불구하고 분할 성능을 향상시켰습니다. 이는 데이터 증강이 반드시 사실적인 샘플을 생성해야 한다는 기존의 통념에 의문을 제기하며, 작업에 최적화된 샘플이 더 중요하다는 통찰을 제공합니다.
- **규제 손실의 역할:** 적대적 손실은 생성된 이미지가 비라벨 데이터의 분포를 따르도록 하고, 큰 편차 손실은 생성기가 단순하거나 분할하기 쉬운 작은 변화 대신 더 도전적인 변형을 만들도록 강제합니다. 이 두 가지 손실의 균형 잡힌 적용이 광범위하고 유용한 증강 데이터 생성을 가능하게 합니다.
- **계산 비용:** 제안된 방법은 새로운 데이터셋에 적용할 때 하이퍼파라미터($\lambda_{adv}, \lambda_{LD}$) 튜닝이 필요하므로 계산 비용이 높다는 한계가 있습니다.
- **스캐너 차이 문제:** 본 연구는 스캐너 간의 강도 차이 문제에 초점을 맞추지 않았으며, 제한된 데이터셋 내의 스캐너 내 변동을 모델링하는 데 주력했습니다.

## 📌 TL;DR

**문제:** 의료 영상 분할은 라벨링된 데이터 부족에 시달리며, 기존의 데이터 증강 및 준지도 학습 방법은 작업 최적화에 미흡했습니다.
**방법:** 제안된 방법은 준지도 작업 주도형 데이터 증강으로, 두 가지 생성기(형태 변형 및 강도 변형)를 분할 네트워크와 함께 공동으로 최적화합니다. 이 과정에서 분할 손실(작업 주도형)과 비라벨 데이터를 활용하는 적대적 손실, 그리고 다양하고 도전적인 변형을 유도하는 큰 편차 손실을 포함하는 규제 손실을 사용합니다.
**결과:** 심장, 전립선, 췌장 데이터셋에서 제한된 라벨 데이터로도 기존 방법들보다 현저히 뛰어난 분할 성능을 달성했습니다. 특히, 생성된 증강 이미지가 해부학적으로 현실적이지 않아도 작업에 최적화되었다면 더 나은 성능을 낼 수 있음을 입증했습니다.
