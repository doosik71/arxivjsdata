# Building medical image classifiers with very limited data using segmentation networks

Ken C. L. Wong, Tanveer Syeda-Mahmood, Mehdi Moradi

## 🧩 Problem to Solve

심층 학습은 의료 영상 분석에서 유망한 결과를 보여주었으나, 방대한 양의 주석이 달린 데이터셋의 부족으로 인해 잠재력을 최대한 발휘하기 어렵습니다. ImageNet 사전 학습 분류 모델을 통한 전이 학습은 이 문제를 일부 완화할 수 있지만, 이미지 크기 및 모델 복잡성 제한은 불필요한 계산 비용 증가와 성능 저하로 이어질 수 있습니다. 특히 3D 의료 영상 분석에서는 ImageNet에 필적하는 사전 학습 모델이 공개적으로 사용 가능하지 않습니다. 따라서 제한된 의료 영상 데이터로도 높은 성능의 분류기를 구축하는 것이 주요 연구 과제입니다.

## ✨ Key Contributions

- **새로운 전이 학습 전략 제안**: 분류 작업과 유사한 데이터로 사전 학습된 분할(segmentation) 네트워크의 특징을 활용하여 의료 영상 분류기를 구축하는 전략을 제안했습니다. 이는 복잡한 개념(질병 분류)에 앞서 간단한 개념(형태, 구조)을 먼저 학습하는 커리큘럼 학습(curriculum learning) 아이디어에서 영감을 받았습니다.
- **제한된 데이터로 높은 성능 달성**: 매우 제한된 훈련 데이터만으로도 높은 분류 성능을 달성할 수 있음을 입증했습니다.
- **다양한 적용 가능성 입증**: 3D 뇌 자기공명(MR) 영상의 3가지 뇌종양 유형 분류(91개 훈련 샘플로 82% 정확도) 및 2D 심장 CTA 영상의 9가지 심장 의미론적 레벨 분류(108개 훈련 샘플로 86% 정확도) 문제에 적용하여 효과를 검증했습니다.
- **기존 방법론 대비 우수성**: ImageNet 사전 학습 분류기(2D의 경우) 및 스크래치(scratch) 학습 분류기보다 우수한 성능을 보였습니다. 특히, 사전 학습된 분할 네트워크의 특징이 적은 데이터 환경에서 과적합(overfitting)을 줄이는 데 도움이 됨을 보여주었습니다.
- **비의미론적 레이블 활용 가능성**: 전문가의 수동 주석 없이 강도 임계값(intensity thresholding)을 통해 생성된 비의미론적 분할 레이블로 사전 학습한 분할 네트워크도 특정 분류 문제에서 유용한 특징을 제공할 수 있음을 확인했습니다.

## 📎 Related Works

- **ImageNet 사전 학습 CNN 기반 전이 학습**: Litjens et al. (2017), van Ginneken et al. (2015), Moradi et al. (2016), Tajbakhsh et al. (2016), Shin et al. (2016) 등 많은 연구에서 ImageNet으로 사전 학습된 CNN을 의료 영상 분석에 활용했습니다. 하지만 이는 2D 이미지에 국한되며, 모델 크기 및 특정 작업에 대한 관련성 부족 등의 한계가 있습니다.
- **제한된 데이터 학습을 위한 대안적 접근법**: Roy et al. (2017)은 자동화된 소프트웨어 도구가 생성한 보조 레이블로 분할 네트워크를 사전 학습한 후 미세 조정하는 방법을, Uzunova et al. (2017)은 소수의 샘플에서 통계적 외형 모델을 학습하여 합성 데이터를 생성하는 방법을, Madani et al. (2018b)는 GAN(Generative Adversarial Nets) 기반의 준지도 학습을 제안했습니다.
- **세분화(Segmentation) 네트워크**: Ronneberger et al. (2015)의 U-Net, Milletari et al. (2016)의 V-Net, Mehta and Sivaswamy (2017)의 M-Net 등은 의료 영상 세분화에서 뛰어난 성능을 보였습니다. 본 연구에서는 Mehta and Sivaswamy (2017)의 M-Net을 수정하여 특징 추출 소스로 사용했습니다.
- **커리큘럼 학습**: Bengio et al. (2009)은 기계 학습이 인간과 동물의 학습처럼 간단한 개념에서 복잡한 개념으로 의미 있게 조직된 개념을 제시함으로써 이점을 얻을 수 있음을 제안했습니다.

## 🛠️ Methodology

1. **프레임워크 개요**: 사전 학습된 분할 네트워크를 특징 추출 소스로 활용하고, 추출된 특징을 사용하여 분류 네트워크를 학습합니다.
2. **분할 네트워크 아키텍처**:
   - Mehta and Sivaswamy (2017)의 M-Net을 수정하여 사용했습니다. M-Net은 U-Net 기반으로 인코딩(encoding) 및 디코딩(decoding) 경로 외에 두 개의 측면 경로(left and right legs)를 포함하여 깊은 감독(deep supervision) 기능을 제공합니다.
   - 각 합성곱(convolutional) 레이어의 특징 채널 수는 맥스 풀링(max pooling) 후 두 배로 늘어나고 업샘플링(upsampling) 후 절반으로 줄어듭니다.
   - $3_{dim}$ 합성곱 레이어는 배치 정규화(BN) 및 ReLU(Rectified Linear Units)와 결합됩니다. 과적합 방지를 위해 마지막 풀링 레이어 뒤에 0.5 확률의 드롭아웃(dropout) 레이어를 도입했습니다.
   - 최종 $1_{dim}$ 합성곱 레이어와 소프트맥스(softmax) 함수를 통해 분할 확률을 제공하며, 분류를 위한 특징은 이 수정된 M-Net의 특정 레이어에서 추출됩니다 (2D의 경우 $31n_s$, 3D의 경우 $7n_s$).
3. **제안된 분류 네트워크 아키텍처**:
   - 사전 학습된 분할 네트워크에서 추출된 특징을 입력으로 받습니다.
   - $2_{dim}$ 맥스 풀링으로 다운샘플링한 후, $r$개의 합성곱-풀링 쌍(conv-pooling pair)을 반복합니다 ($3_{dim}$ 합성곱 + BN + ReLU + $2_{dim}$ 맥스 풀링).
   - 최종 맥스 풀링 출력은 평탄화(flattened)되어 3개의 완전 연결(FC) 레이어로 전달됩니다. 처음 두 FC 레이어는 BN, ReLU, 0.5 드롭아웃을 포함하며, 마지막 FC 레이어는 소프트맥스 함수와 함께 분류 확률을 제공합니다.
4. **비교를 위한 분류 네트워크**:
   - **수정된 VGGNet**: VGGNet (16 layers) 아키텍처를 수정하여 배치 정규화와 더 적은 특징 채널을 사용하여 스크래치 학습 및 ImageNet 사전 학습 VGGNet과의 비교에 사용합니다.
   - **ImageNet 사전 학습 VGGNet**: 2D 이미지 분류에서만 사용되며, 사전 학습된 VGGNet 모델의 FC 레이어를 수정된 VGGNet의 FC 레이어로 교체하고, 학습 시 FC 레이어의 가중치만 수정합니다.
5. **훈련 전략**:
   - **손실 함수**: 가중 교차 엔트로피(weighted cross entropy)를 사용하여 클래스 불균형 문제를 해결합니다. 레이블 가중치는 $w_l = (\frac{\sum_k f_k}{f_l})^{0.5}$로 계산됩니다.
   - **최적화**: Adam 옵티마이저를 사용하고 Glorot 균일 초기화를 적용합니다.
   - **이미지 증강(Image Augmentation)**: 회전, 이동, 확대/축소, 뒤집기(대칭 구조의 경우)와 같은 강체 변환(rigid transformations)을 무작위로 적용하여 불변 특징을 학습하고 과적합을 줄입니다.
   - **ImageNet VGG 전처리**: 224x224x3으로 이미지 크기를 조정하고, CLAHE(Contrast Limited Adaptive Histogram Equalization)를 사용하여 이미지 강도를 정규화하고 -128만큼 이동시킵니다.
6. **실험 프레임워크**:
   - **MANUAL**: 수동으로 주석된 의미론적 분할 데이터로 사전 학습된 분할 네트워크를 사용하는 제안된 프레임워크.
   - **THRESHOLD**: 강도 임계값(k-means)으로 얻은 비의미론적 분할 데이터로 사전 학습된 분할 네트워크를 사용하는 제안된 프레임워크.
   - **VGG**: ImageNet 사전 학습 VGGNet의 합성곱 특징을 사용하는 프레임워크 (2D에만 적용).
   - **SCRATCH**: 어떠한 사전 학습된 특징 없이 처음부터 학습된 분류 네트워크.

## 📊 Results

1. **3D 뇌종양 분류 (비종양, 저등급 신경교종, 교모세포종)**

   - **데이터셋**: 91개 훈련 샘플(비종양 11개, 저등급 신경교종 40개, 교모세포종 40개), 191개 테스트 샘플.
   - **분할 네트워크 성능**: 19개 신경해부학적 레이블에 대해 평균 다이스 계수(Dice coefficient) 69%를 달성. 종양 주변 구조의 시각적 분별력을 제공하여 분류에 유용한 정보를 학습했음을 보여줌.
   - **분류 성능**:
     - MANUAL 및 THRESHOLD 프레임워크는 종양 훈련 샘플 수가 적을 때(70개 미만) SCRATCH 프레임워크보다 현저히 우수한 성능을 보였습니다.
     - MANUAL 프레임워크는 80개의 종양 훈련 샘플(총 91개)에서 **82%의 정확도**와 67%의 코헨 카파(Cohen's kappa)를 달성하며 수렴했습니다.
     - SCRATCH 프레임워크는 샘플 수가 적을 때 더 큰 변동성과 표준 편차를 보였습니다.
     - MANUAL 프레임워크는 THRESHOLD 프레임워크보다 약간 더 좋은 성능을 보였습니다 (정확도 평균 3%, 코헨 카파 평균 5% 차이).

2. **2D 심장 의미론적 축 레벨 분류 (9개 레벨)**
   - **데이터셋**: 108개 훈련 샘플(각 클래스 18개), 263개 테스트 샘플.
   - **분할 네트워크 성능**: 16개 해부학적 레이블에 대해 평균 다이스 계수 78%를 달성. 복잡한 심장 구조에 대한 유용한 특징을 학습했음을 시사.
   - **분류 성능**:
     - MANUAL 프레임워크가 전반적으로 가장 우수한 성능을 보였습니다.
     - ImageNet 사전 학습 VGG 프레임워크는 적은 훈련 샘플에서는 THRESHOLD 및 SCRATCH보다 우수했지만, 샘플 수가 증가하면서 SCRATCH 프레임워크에 추월당했습니다.
     - MANUAL 프레임워크는 약 108개의 샘플에서 **86%의 정확도**와 84%의 코헨 카파를 달성하며 수렴했습니다.
     - VGG 프레임워크는 약 108개의 샘플에서 67%의 정확도와 62%의 코헨 카파를 달성하여 MANUAL보다 현저히 낮았습니다.
     - MANUAL 프레임워크는 다른 프레임워크에 비해 전반적으로 F1 점수가 높았으며, 특히 "상행/하행 대동맥" 및 "4-챔버 뷰" 레벨에서 큰 차이를 보였습니다. 또한, MANUAL은 수렴 후 모든 레벨에서 작은 표준 편차를 보여 더 일관적인 성능을 나타냈습니다.

## 🧠 Insights & Discussion

- **분할 네트워크 사전 학습의 효과**: 분할 정확도 자체가 주된 목표는 아니지만, 뇌(69%) 및 심장(78%) 분할에서 얻은 상당한 다이스 계수는 제한된 데이터로도 분류 성능을 향상시키는 데 유용한 특징을 학습했음을 시사합니다.
- **모델 크기 및 데이터 효율성**: 의료 영상 분석에서는 ImageNet과 같은 1000개 클래스를 분류하는 대규모 네트워크가 불필요할 수 있습니다. 제안된 프레임워크는 기존 VGGNet(약 1억 3천 8백만 개)보다 훨씬 적은 수의 파라미터(MANUAL의 경우 약 3백만 개)를 사용하여 효율적입니다.
- **3D 의료 영상 분석의 장점**: ImageNet에 필적하는 3D 사전 학습 CNN 모델이 부재한 상황에서, 제안된 MANUAL 및 THRESHOLD 프레임워크는 3D 의료 영상 분류를 위한 실용적이고 유용한 대안을 제공합니다.
- **정상 이미지로 학습된 분할 네트워크의 유용성**: 정상 뇌 영상으로만 훈련된 분할 네트워크가 종양 유형 분류 성능을 향상시키는 데 기여했습니다. 이는 방대한 이미지 기반 주석 대신 더 적은 이미지로 복잡한 픽셀 기반 주석을 사용하여 사전 학습 특징을 얻을 수 있음을 의미합니다.
- **과적합 감소**: 사전 학습된 분할 특징을 사용하는 프레임워크는 스크래치 학습 프레임워크에 비해 과적합을 줄이고, 특히 제한된 데이터에서 학습 곡선의 변동성이 적고 부드럽게 수렴하는 경향을 보였습니다.
- **비의미론적 레이블의 한계**: THRESHOLD 프레임워크의 성능은 문제의 특성에 따라 달랐습니다. 뇌종양 분류처럼 전반적인 구조적 차이가 중요한 경우에는 유용했지만, 심장 의미론적 레벨 분류처럼 더 미세한 구조적 세부 사항이 필요한 경우에는 효과가 떨어졌습니다. 향후 연구에서는 수동 분할을 대체하기 위해 기존 소프트웨어에서 생성된 "자동 레이블"의 활용이 고려될 수 있습니다.
- **VGG 프레임워크의 비최적성**: ImageNet 사전 학습 VGGNet은 특정 문제에 너무 특화된 특징을 가질 수 있으며, 본 연구에서는 최적의 VGGNet 활용법을 탐색하는 것이 주 목표가 아니었으므로 일반적인 설정으로 비교를 진행했습니다.

## 📌 TL;DR

**의료 영상 분류를 위한 제한된 데이터 문제**를 해결하고자, 본 논문은 **사전 학습된 분할(segmentation) 네트워크의 특징을 활용하는 새로운 분류 전략**을 제안합니다. 이 방법은 분할 네트워크를 통해 단순한 형태 및 구조 정보를 먼저 학습함으로써 복잡한 분류 문제를 더 효과적으로 해결하는 **커리큘럼 학습**의 이점을 활용합니다. 제안된 프레임워크는 3D 뇌종양 분류(91개 훈련 샘플로 82% 정확도)와 2D 심장 의미론적 레벨 분류(108개 훈련 샘플로 86% 정확도)에서 높은 성능을 달성했으며, ImageNet 사전 학습 VGGNet 모델 및 스크래치 학습 모델보다 우수함을 입증했습니다. 특히, 3D 의료 영상 분석과 같이 ImageNet에 필적하는 사전 학습 CNN이 없는 분야에서 유용하고 실용적인 대안을 제공합니다.
