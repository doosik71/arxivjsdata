# BayeSeg: Interpretable Generalizability를 위한 의료 영상 분할 베이지안 모델링

Shangqi Gao, Hangqi Zhou, Yibo Gao, Xiahai Zhuang

## 🧩 해결하고자 하는 문제

다양한 의료 영상 시스템으로 인한 도메인 간 분포 변화(cross-domain distribution shift) 때문에, 기존 딥러닝 분할 방법론들은 학습되지 않은 데이터에 대해 성능이 저하되어 실제 적용 가능성이 제한됩니다. 최근 연구들은 도메인 불변 표현(domain-invariant representations) 추출의 이점을 보여주었지만, 이러한 도메인 불변 특징의 **해석 가능성(interpretability)**을 확보하는 것이 여전히 큰 과제입니다. 이 논문은 의료 영상 분할에서 모델의 일반화 능력(generalizability)을 향상시키기 위해 해석 가능하면서도 일반화 가능한 모델을 개발하는 것을 목표로 합니다.

## ✨ 주요 기여

- **해석 가능한 베이지안 프레임워크 제안:** 의료 영상 및 레이블 통계의 베이지안 모델링을 통해 해석 가능하고 일반화 가능한 베이지안 분할(BayeSeg) 프레임워크를 제안합니다.
- **이미지 분해 및 계층적 베이지안 사전(Prior) 할당:** 이미지를 공간 상관 변수(spatial-correlated variable)인 `형태(shape)` $x$와 공간 가변 변수(spatial-variant variable)인 `외관(appearance)` $a$로 분해하고, 각각 도메인 불변 형태 정보와 도메인 특이 외관 정보를 명시적으로 모델링하도록 계층적 베이지안 사전을 할당합니다.
- **형태 기반 분할 모델링:** 분할 $z$을 형태 $x$에만 관련된 국부적으로 부드러운(locally smooth) 변수로 모델링합니다.
- **변분 베이지안 추론:** 설명 가능한 변수들의 사후 분포(posterior distributions)를 추론하기 위한 변분 베이지안 프레임워크를 개발했으며, 이를 신경망으로 구현하여 딥 베이지안 분할(Deep Bayesian Segmentation)이라고 명명합니다.
- **광범위한 실험 및 해석 가능성 분석:** 전립선 및 심장 분할 태스크에서 교차 도메인(cross-site, cross-sequence, cross-modality) 시나리오에 걸쳐 제안 방법의 효과를 정량적 및 정성적으로 입증하고, 사후 분포 시각화를 통해 BayeSeg의 해석 가능성을 분석했습니다.
- **일반화 능력 요인 분석:** 추가적인 제거 연구(ablation studies)를 통해 통계적 사전 설정 및 이미지와 레이블 통계의 공동 모델링이 일반화 능력에 미치는 영향을 분석했습니다.

## 📎 관련 연구

- **이미지 통계 모델링:**
  - 초기 연구는 계산적 어려움으로 가우시안 사전(Gaussian prior) 모델링에 집중했습니다 (e.g., Hunt, Archer & Titterington).
  - 픽셀 간 관계를 더 잘 설명하기 위해 마르코프 랜덤 필드(MRF), 깁스 분포(Gibbs distribution)와 같은 `이미지 필드 모델링(image field modeling)`이 탐구되었습니다 (e.g., Cross & Jain, Geman & Geman).
  - 계산 효율성을 위해 `공간 상관 모델링(spatial correlation modeling)` (e.g., SAR, CAR) 및 `희소성 모델링(sparsity modeling)` (e.g., 가우시안 스케일 혼합 모델)이 제안되었습니다.
  - 고정된 연산자의 한계를 극복하기 위해 학습 가능한 필터를 사용하는 `유연한 사전 모델링(flexible prior modeling)`이 발전했습니다 (e.g., 고차 MRF).
- **의료 영상 분할을 위한 도메인 일반화(Domain Generalization, DG):**
  - DG는 학습 과정에서 대상 도메인 데이터에 접근하지 않고도 미지의 대상 도메인에 잘 일반화되는 모델을 만드는 것을 목표로 합니다.
  - **데이터 기반 접근법:** 데이터 증강 또는 생성을 통해 학습 데이터의 다양성을 높입니다 (e.g., Zhang et al. 2020, Chen et al. 2020).
  - **학습 기반 접근법:** 앙상블 학습, 메타 학습과 같은 특정 학습 전략을 통해 학습 도메인들의 지식을 결합합니다 (e.g., Dou et al. 2019, Liu et al. 2020).
  - **표현 기반 접근법:** 도메인 불변 또는 도메인 무관 특징을 추출합니다.
    - `특징 정렬(Feature alignment)`: 적대적 학습, 최대 평균 불일치(MMD) 등을 통해 교차 도메인 특징 분포 격차를 줄입니다 (e.g., Li et al. 2018a).
    - `특징 분리(Feature disentanglement)`: 특징 표현을 도메인 특이 부분과 도메인 공유/무관 부분으로 분해합니다 (e.g., DIVA).
    - `인과성 기반 모델(Causality-inspired models)`: 잠재 특징과 출력 간의 인과 관계에 집중하여 결과를 유발하는 가장 중요한 특징을 찾습니다 (e.g., Sun et al. 2021).
- **BayeSeg의 차별점:** 기존 표현 기반 방법들이 주로 컴퓨터 비전 작업에 초점을 맞추고 의료 영상 분할에서는 연구가 적었으며, 도메인 불변 특징 자체의 해석 가능성 증진이 과제였습니다. BayeSeg는 통계 모델링과 이미지 분해를 결합하여 해석 가능한 특징을 추출하고, 계층적 베이지안 사전을 통해 특징의 사후 분포를 제어하여 일반화 능력을 향상시킵니다.

## 🛠️ 방법론

BayeSeg는 이미지와 레이블의 통계적 모델링과 사후 분포의 딥 추론이라는 두 가지 주요 부분으로 구성됩니다.

1. **이미지 및 레이블의 통계 모델링:**

   - **이미지 분해:** 입력 이미지 $y \in \mathbb{R}^{d_y}$를 `형태(shape)` $x \in \mathbb{R}^{d_y}$와 `외관(appearance)` $a \in \mathbb{R}^{d_y}$의 합으로 분해합니다: $y = x + a$.
   - **외관 모델링:** 외관 $a$는 공간 가변 가우시안 분포를 따릅니다: $p(a|m, \rho) = N(a|m, \text{diag}(\rho)^{-1})$. 여기서 $m \in \mathbb{R}^{d_y}$는 평균, $\rho \in \mathbb{R}^{d_y}$는 역분산입니다.
   - **형태 모델링:** 형태 $x$는 동시 자기회귀(SAR) 모델을 통해 공간 상관성을 가지며, 예상 분할 $z \in \mathbb{R}^{d_y \times K}$와 경계 $\upsilon \in \mathbb{R}^{d_y}$에 따라 달라집니다: $p(x|z, \upsilon) = \prod_{k=1}^{K} N(x|0, [D_x^{\text{T}} \text{diag}(z_k \upsilon)D_x]^{-1})$. 여기서 $D_x$는 라플라시안 연산자입니다.
   - **분할 모델링:** 분할 $z$도 SAR 모델을 따르며, 분할 경계 $\omega \in \mathbb{R}^{d_y \times K}$와 클래스별 확률 $\pi \in \mathbb{R}^{K}$에 따라 달라집니다: $p(z|\pi, \omega) = \prod_{k=1}^{K} N(z|0, [-\ln(1-\pi_k)D_z^{\text{T}} \text{diag}(\omega_k)D_z]^{-1})$.
   - **정답 레이블 모델링:** 정답 레이블 $u \in \mathbb{R}^{d_y \times K}$는 일반화된 베르누이 분포를 따르며, 분할 $z$에 의존합니다: $p(u|z) = \prod_{i=1}^{d_y} \prod_{k=1}^{K} z_{ik}^{u_{ik}}$.
   - **사전 분포:** $m$에는 가우시안 사전, $\rho, \upsilon, \omega$에는 감마 사전, $\pi$에는 베타 사전이 할당됩니다.

2. **딥 추론 및 학습 전략:**
   - **변분 추론:** 직접적인 사후 분포 추론의 어려움으로 인해 변분 베이지안(VB) 접근 방식(Blei et al., 2022)을 사용합니다. 모든 변수 $\psi = \{m, \rho, x, \upsilon, z, \omega, \pi\}$가 독립적이라는 가정을 통해 $q(\psi) = q(m)q(\rho)q(x)q(\upsilon)q(z)q(\omega)q(\pi)$로 근사합니다.
   - KL 다이버전스(KL divergence) 최소화를 통해 변수들의 사후 분포 파라미터($\hat{\mu}_{\cdot}$, $\hat{\sigma}_{\cdot}$, $\hat{\alpha}_{\cdot}$, $\hat{\beta}_{\cdot}$, $\hat{\phi}_{\cdot}$, $\hat{\gamma}_{\cdot}$)를 추론합니다.
   - **변분 손실(Variational Loss) $L_{var}$ 전개:** $L_{var}$는 이미지 $y$의 피팅, $z$의 공간적 부드러움, $x$의 공간적 상관성 및 엣지 보존, $m$의 에너지 제약 등을 위한 여러 항으로 구성되어 해석 가능성을 높입니다 (표 3 참고).
     $$L_{var} = L_y + L_{\hat{\mu}_z} + L_{\hat{\sigma}_z} + L_{\hat{\mu}_x} + L_{\hat{\sigma}_x} + L_{\hat{\mu}_m} + L_{\hat{\sigma}_m}$$
   - **신경망 아키텍처:**
     - **분해 단계:** 두 개의 ResNet (f_s($\cdot$)는 형태 $x$의 사후 분포를 추론, f_a($\cdot$)는 외관 $m$의 사후 분포를 추론)을 사용하여 평균과 분산을 출력하고, 이를 통해 $x$와 $a$를 샘플링합니다.
     - **분할 단계:** U-Net (g($\cdot$)는 분할 $z$의 사후 분포를 추론)을 사용하여 $z$의 평균과 분산을 출력하고 샘플링합니다.
   - **학습:** 교차 엔트로피 손실(cross-entropy loss) $L_{ce}$와 변분 손실 $L_{var}$을 균형 있게 사용하여 최적화합니다: $\min_{q(\psi)} L_{ce} + \lambda L_{var}$. ($\lambda=100$)
   - **추론:** 테스트 단계에서는 $z$의 평균을 최종 분할 결과로 사용합니다.

## 📊 결과

- **전립선 분할 (교차 사이트 시나리오):**
  - RUNMC 데이터를 소스 도메인으로 사용하고 BMC, BIDMC, HK, UCL, I2CVB를 타겟 도메인으로 테스트했습니다.
  - BayeSeg는 타겟 도메인에서 평균 Dice 점수 77.5를 달성하여 기존 최신 도메인 일반화 방법들(ERM, Cutout, IBN-Net, RandConv, DSU)을 7.7점 차이로 능가했습니다.
  - 특히, BIDMC 및 HK와 같은 어려운 도메인에서 가장 적은 성능 저하를 보였습니다 (BIDMC에서 24.4% vs. 다른 방법의 >40% 이상, HK에서 4.1%).
  - 정성적 결과(그림 3a)는 BayeSeg가 모든 경우에 연결된(connected) 분할 결과를 유지함을 보여주었습니다.
- **심장 분할 (교차 시퀀스, 교차 사이트, 교차 모달리티 시나리오):**
  - MSCMR의 LGE를 소스 도메인으로 사용하고 MSCMR의 T2, EMIDEC의 LGE, ACDC의 bSSFP, MMWHS의 bSSFP, CASDC의 CT를 타겟 도메인으로 테스트했습니다.
  - BayeSeg는 타겟 도메인에서 가장 작은 평균 Dice 점수 하락(5.5)을 보였습니다.
  - 가장 큰 도메인 변화를 보이는 T2 of MSCMR(교차 시퀀스)에서 BayeSeg는 34.6점 차이로 두 번째로 좋은 방법보다 우수했으며, 성능 저하가 9.9%에 불과했습니다 (다른 방법은 >44.5%).
  - EMIDEC LGE (교차 사이트)에서 10.2점, CASDC CT (교차 모달리티)에서 3.6점 차이로 우수한 성능을 보였습니다.
- **기본 구성 요소에 대한 제거 연구:**
  - 변분 손실($L_{var}$)이 BayeSeg의 일반화 능력에 핵심적인 요소임을 확인했습니다. 이는 형태 $x$가 도메인 불변 구조 정보를 모델링하게 하여 일반화 능력을 향상시킵니다.
  - 확률적 매핑(stochastic mapping) 단독으로는 큰 성능 향상을 가져오지 않지만, 변분 손실과 결합될 때 주어진 이미지에 대해 무한한 형태 샘플을 보게 하여 성능 향상에 기여합니다.

## 🧠 통찰 및 논의

- **통계적 표현의 해석:**
  - BayeSeg는 사전 정의된 통계 모델을 통해 변수들이 특정 사후 분포를 따르도록 강제함으로써 `능동적 해석 가능성(active interpretability)`을 제공합니다.
  - 확률적 변수 모델링을 통해 입력 이미지 분포에 대한 `전역적 해석 가능성(global interpretability)`을 제공합니다.
  - 그림 4에 제시된 바와 같이 외관($a, m, \rho$), 형태($x, \upsilon$), 분할($z, \omega$)의 사후 분포를 시각화하여 `의미론적 해석(semantic interpretation)`을 제공합니다. 특히 형태 경계($\upsilon$)는 좌심실 영역을, 분할 경계($\omega$)는 심근의 내부 및 외부 경계를 효과적으로 감지합니다.
- **통계적 사전 모델링의 일반화 능력:**
  - $\rho$ (외관의 역분산) 사전: 적절한 사전은 외관의 미세 구조를 포착하는 데 도움이 됩니다. 너무 크거나 작은 $\rho$ 값은 외관의 적응성을 제한하거나 학습 수렴을 어렵게 만듭니다 (표 8, 그림 5).
  - $\upsilon$ (형태 경계) 사전: 적절한 사전은 형태의 엣지를 보존하는 데 중요합니다. 너무 뚜렷한(sharper) 사전은 엣지를 무시하여 과도하게 부드러운 형태로 이어지고, 너무 평탄한(flatter) 사전은 노이즈에 민감하게 반응하게 합니다 (표 9, 그림 6).
  - $\omega$ (분할 경계) 사전: 분할의 공간적 관련성을 조절합니다. 적절한 사전 설정이 전반적인 성능에 기여합니다 (표 10, 그림 7).
  - 결론적으로 통계적 사전 모델링은 형태와 같은 특징이 도메인에 걸쳐 일관되게 유지되도록 강제하여 모델의 일반화 능력을 향상시키는 데 필수적인 역할을 합니다.
- **공동 모델링의 일반화 능력:**
  - 이미지($y$)와 레이블($u$) 통계의 공동 모델링이 중요함을 입증하기 위해, `외관 $a$가 결정론적`이거나 `분할 $z$가 결정론적`인 단순화된 PGM(Probabilistic Graphical Model) 구성을 평가했습니다.
  - 어느 경우든 성능 저하가 발생했으며(표 11), 특히 외관 $a$가 결정론적일 때 T2 of MSCMR와 같은 어려운 도메인에서 큰 성능 하락을 보였습니다. 이는 $a$가 외관 관련 이미지 세부 정보를 모델링하기 때문입니다.
  - t-SNE 시각화(그림 8)는 이미지와 레이블 통계를 공동 모델링하는 완전한 PGM이 모든 대상 도메인의 형태 $x$ 분포를 중앙 집중화하고, 소스 도메인 $x$ 분포가 더 넓은 커버리지를 가져 일반화에 도움이 됨을 보여줍니다.
- **한계점 및 향후 연구:**
  - 추출된 형태가 완전히 도메인 불변하지는 않습니다. T2 of MSCMR의 t-SNE shift(해부학적-무관)는 가장 작지만, 정량적 결과(해부학적-관련)는 최악의 일반화 능력을 보여줍니다. 이는 **해부학적으로 관련된 특징만** 도메인 불변으로 추출하는 것이 여전히 미해결 과제임을 의미합니다.
  - 향후 연구에서는 의료 영상 분할에서 인과 관계(causality)를 재고하여 인과적 베이지안 프레임워크(causal Bayesian framework)를 개발하고, 반사실적 추론(counterfactual inference)을 고려하여 미지의 시나리오를 상상하는 것이 도메인 일반화에 큰 도움이 될 것으로 예상됩니다.

## 📌 TL;DR

의료 영상 분할은 도메인 변화로 인해 미지의 데이터에서 성능이 저하되며, 기존 도메인 일반화 방법은 해석 가능성이 부족합니다. BayeSeg는 이미지를 `도메인 불변 형태` $x$와 `도메인 특이 외관` $a$로 분해하고, 계층적 베이지안 사전을 사용하여 이들을 명시적으로 모델링하는 해석 가능한 베이지안 프레임워크입니다. 분할 $z$는 형태 $x$로부터 모델링되며, 변분 베이지안 추론을 통해 이 모든 변수들의 사후 분포를 신경망으로 추론합니다. 전립선 및 심장 분할 태스크에서 교차 사이트, 시퀀스, 모달리티에 걸쳐 기존 방법보다 뛰어난 일반화 능력을 달성하며, 추출된 변수들의 시각화를 통해 높은 해석 가능성을 제공합니다. 제거 연구는 통계적 사전 모델링과 이미지/레이블 통계의 공동 모델링이 모델의 일반화 능력에 필수적임을 입증했습니다.
