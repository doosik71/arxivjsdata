# Multivariate Time-series Anomaly Detection via Graph Attention Network

Hang Zhao, Yujing Wang, Juanyong Duan, Congrui Huang, Defu Cao, Yunhai Tong, Bixiong Xu, Jing Bai, Jie Tong, Qi Zhang

## 🧩 Problem to Solve

다변량 시계열 데이터에서 이상 징후를 탐지하는 것은 데이터 마이닝 연구 및 산업 응용 분야에서 매우 중요합니다. 기존의 많은 접근 방식들은 발전된 성과를 보여주었지만, 서로 다른 시계열(즉, 특징들) 간의 관계를 명시적으로 포착하지 못한다는 한계가 있습니다. 이러한 관계 부족은 예를 들어, 여러 지표가 함께 증가하는 것이 정상임에도 불구하고 개별적으로 보면 이상으로 오인될 수 있는 오탐(false alarm)을 유발합니다. 따라서, 시스템의 전반적인 건강 상태를 정확하게 판단하기 위해서는 다변량 시계열 간의 상관관계를 고려하는 것이 필수적입니다.

## ✨ Key Contributions

- **새로운 자기 지도(Self-supervised) 프레임워크 제안:** 다변량 시계열 이상 탐지를 위한 MTAD-GAT (Multivariate Time-series Anomaly Detection via Graph Attention Network)라는 새로운 프레임워크를 제안했습니다.
- **두 가지 병렬 그래프 어텐션(GAT) 레이어 활용:** 기존 연구들이 다변량 상관관계를 명시적으로 다루지 못했던 한계를 해결하기 위해, 특징(feature-oriented) 및 시간(time-oriented) 차원에서 다변량 시계열의 복잡한 동적 관계를 학습하는 두 가지 병렬 GAT 레이어를 최초로 사용했습니다. 특히, 사전 지식 없이도 서로 다른 시계열 간의 상관관계를 성공적으로 포착합니다.
- **공동 최적화 전략:** 단일 타임스탬프 예측에 중점을 둔 예측 기반(forecasting-based) 모델과 전체 시계열의 잠재 표현을 학습하는 재구성 기반(reconstruction-based) 모델의 장점을 통합하기 위해 공동 최적화 목표를 도입했습니다.
- **최고 수준 성능 달성:** 세 가지 실제 데이터셋(SMAP, MSL, TSA)에서 다른 최신 모델들보다 우수한 성능을 보여주며 최고 수준(state-of-the-art)의 점수를 기록했습니다.
- **우수한 해석 가능성 및 진단 능력:** 그래프 어텐션 레이어가 학습한 어텐션 스코어를 분석하여 모델의 우수한 해석 가능성을 입증했으며, 이상 징후 진단(anomaly diagnosis)에 유용함을 보여주어 이상 발생 시 근본 원인을 찾는 데 도움을 줍니다.

## 📎 Related Works

이 연구는 시계열 이상 탐지 연구들을 두 가지 주요 범주로 분류하여 관련 연구들을 제시합니다.

- **시계열 유형별 분류:**
  - **단변량(Univariate) 이상 탐지:** 각 개별 시계열을 분석하는 접근 방식 (예: ARIMA, S-H-ESD, DONUT (VAE), SR-CNN).
  - **다변량(Multivariate) 이상 탐지:** 여러 시계열을 통합된 엔티티로 모델링하는 접근 방식 (예: LSTM-NDT, OmniAnomaly, DAGMM, MAD-GAN).
- **모델 패러다임별 분류:**
  - **예측 기반(Forecasting-based) 모델:** 미래 타임스탬프 값을 예측하고, 예측 오류를 기반으로 이상을 탐지합니다 (예: LSTM-NDT, HTM+BN). DAGMM과 같은 모델도 다변량 데이터를 다루지만 시간 의존성을 고려하지 않는다는 차이가 있습니다.
  - **재구성 기반(Reconstruction-based) 모델:** 잠재 변수를 통해 원본 입력을 재구성하여 정상 패턴의 표현을 학습하고, 재구성 오류가 큰 경우를 이상으로 간주합니다 (예: LSTM 기반 인코더-디코더, Kitsune, MAD-GAN, GAN-Li, LSTM-VAE, OmniAnomaly).

**기존 연구의 한계:** 대부분의 기존 다변량 모델들은 시계열 간의 **명시적인 상관관계**를 포착하는 데 한계가 있으며, 예측 기반 및 재구성 기반 모델은 각각 고유한 장단점을 가지고 있어 상호 보완적인 접근이 필요합니다.

## 🛠️ Methodology

MTAD-GAT는 다변량 시계열의 특징 간 상관관계와 시간적 의존성을 두 개의 그래프 어텐션 네트워크로 모델링하고, GRU 네트워크를 통해 장기적인 의존성을 포착합니다. 또한 예측 기반 및 재구성 기반 모델의 이점을 모두 활용하는 공동 손실 함수를 최적화합니다.

1. **데이터 전처리 및 1D Convolution:**
   - 훈련 데이터의 최댓값/최솟값을 이용한 Min-Max 정규화를 수행합니다.
   - 훈련 데이터에 대해서만 SR(Spectral Residual) 방법을 사용하여 이상 타임스탬프를 감지하고 주변의 정상 값으로 대체하는 데이터 클리닝을 적용합니다.
   - 각 시계열 입력의 고수준 특징을 추출하기 위해 커널 크기 7의 1D 컨볼루션 레이어를 적용합니다.
2. **두 가지 병렬 그래프 어텐션 (GAT) 레이어:**
   - **특징 중심(Feature-oriented) GAT:** 각 단변량 시계열을 개별 노드로 간주하여 다변량 시계열을 완전 그래프로 취급합니다. 이를 통해 서로 다른 특징(feature) 간의 관계를 포착합니다.
   - **시간 중심(Time-oriented) GAT:** 슬라이딩 윈도우 내의 모든 타임스탬프를 개별 노드로 간주하여 완전 그래프를 형성합니다. 이를 통해 시계열 내의 시간적 의존성(temporal dependency)을 모델링합니다 (Transformer의 self-attention과 유사).
   - GAT는 인접 노드 $j$가 노드 $i$에 기여하는 정도를 측정하는 어텐션 점수 $\alpha_{ij}$를 계산하여 노드 표현을 업데이트합니다: $h_i = \sigma(\sum_{j=1}^{L} \alpha_{ij} v_j)$, 여기서 $\alpha_{ij} = \frac{\exp(e_{ij})}{\sum_{L}^{l=1} \exp(e_{il})}$ 이고 $e_{ij} = \text{LeakyReLU}(w^T \cdot (v_i \oplus v_j))$ 입니다.
3. **GRU 레이어:**
   - 1D 컨볼루션 레이어 및 두 GAT 레이어의 출력 표현을 연결(concatenate)한 후, GRU(Gated Recurrent Unit) 레이어에 입력하여 시계열의 장기적인 순차 패턴을 포착합니다.
4. **공동 최적화:**
   - GRU 레이어의 출력은 예측 기반 모델과 재구성 기반 모델로 병렬로 입력됩니다.
   - **예측 기반 모델:** 다음 타임스탬프의 값을 예측하기 위한 세 개의 완전 연결(fully-connected) 레이어로 구성됩니다. 손실 함수로는 RMSE(Root Mean Square Error)를 사용합니다: $\text{Loss}_{for} = \sqrt{\sum_{i=1}^{k} (x_{n,i} - \hat{x}_{n,i})^2}$.
   - **재구성 기반 모델:** VAE(Variational Auto-Encoder)를 사용하여 시계열 데이터의 잠재 분포를 학습합니다. 손실 함수는 VAE의 ELBO(Evidence Lower Bound)입니다: $\text{Loss}_{rec} = -E_{q_\phi(z|x)}[\log p_\theta(x|z)] + D_{KL}(q_\phi(z|x)||p_\theta(z))$.
   - 전체 손실은 두 모델의 손실 합계로 정의되며, 이들을 동시에 최적화합니다: $\text{Loss} = \text{Loss}_{for} + \text{Loss}_{rec}$.
5. **모델 추론(Inference):**
   - 각 특징에 대한 최종 이상 점수 $s_i$는 예측 오차와 재구성 확률을 결합하여 계산됩니다: $score = \sum_{i=1}^{k} \frac{(\hat{x}_i - x_i)^2 + \gamma \times (1-p_i)}{1 + \gamma}$. 여기서 $\gamma$는 하이퍼파라미터입니다.
   - POT(Peak Over Threshold) 방법을 사용하여 임계값을 자동으로 선택하고, 임계값을 초과하는 타임스탬프를 이상으로 식별합니다.

## 📊 Results

- **데이터셋:** SMAP (Soil Moisture Active Passive satellite), MSL (Mars Science Laboratory rover) (NASA), TSA (Microsoft Flink 시스템 데이터) 세 가지 실제 데이터셋을 사용하여 모델의 성능을 검증했습니다.
- **평가 지표:** Precision, Recall, F1-score를 사용했으며, 이상 관측치는 연속적인 세그먼트로 발생하는 경향이 있으므로 세그먼트 기반 평가 전략을 따랐습니다.
- **최신 기술(SOTA) 모델과의 비교:** MTAD-GAT는 세 가지 데이터셋 모두에서 일관되게 가장 높은 F1-score를 달성했습니다. SMAP, MSL, TSA 데이터셋에서 각각 1%, 1%, 9%의 F1-score 향상을 보였습니다. 특히, 기존 모델들이 명시적인 특징 상관관계를 다루지 못하는 한계를 MTAD-GAT의 특징 중심 GAT 레이어가 효과적으로 해결했음을 입증했습니다.
- **다른 지연 시간(Delay)에 따른 평가:** MTAD-GAT는 허용 가능한 지연 시간($\delta$)이 작을 때 특히 우수한 성능을 보이며, OmniAnomaly와 비교하여 F1-score에서 일관된 향상을 달성했습니다 (예: $\delta=10$일 때 SMAP에서 53.98% 상대적 향상). 이는 실제 시나리오에서 잠재적 사고에 대해 더 신속하게 경고할 수 있음을 의미합니다.

## 🧠 Insights & Discussion

- **그래프 어텐션의 효과:**
  - 특징 중심 GAT(w/o feature)를 제거했을 때 평균 F1-score가 3.2% 감소했으며, 특히 TSA 데이터셋에서 4.8% 감소했습니다. 이는 CPU 및 MEMORY와 같이 강하게 상관된 특징들 간의 관계를 포착하는 데 특징 중심 GAT가 중요함을 시사합니다.
  - 시간 중심 GAT(w/o time)를 제거했을 때도 평균 F1-score가 2.5% 감소했습니다. 이는 GRU가 이미 시간적 의존성을 모델링함에도 불구하고, 시간 중심 GAT가 인접하지 않은 타임스탬프 간의 직접적인 관계를 모델링하여 장기적인 의존성을 더욱 명시적으로 포착하는 데 기여함을 나타냅니다.
  - 어텐션 스코어 시각화를 통해 특징 중심 GAT가 정상 상황에서 가장 관련성 높은 특징들을 학습하고, 이상 발생 시 상관관계 변화를 성공적으로 감지함을 보여주었습니다.
- **공동 최적화의 효과:**
  - 예측 기반 모델만 사용하거나(w/o reconstruction) 재구성 기반 모델만 사용했을 때(w/o prediction) 모두 전체 모델보다 성능이 현저히 저하되었습니다.
  - 예측 기반 모델은 시계열의 무작위성에 민감한 반면, 재구성 기반 모델은 확률적 변수의 분포를 학습하여 섭동(perturbation) 및 노이즈에 더 강합니다. 하지만 재구성 기반 모델은 값이 정상 분포를 따르지만 주기성이 깨지는 돌발적인 변화를 놓칠 수 있습니다 (그림 6).
  - 따라서 두 모델의 상호 보완적인 장점을 활용하는 공동 최적화 전략이 더 나은 이상 탐지 결과를 얻는 데 효과적임을 입증했습니다.
- **$\gamma$ 매개변수 분석:** 예측 기반 오차와 재구성 기반 확률의 균형을 맞추는 하이퍼파라미터 $\gamma$에 대한 민감도 분석 결과, $\gamma$ 값이 0.4에서 1.0 사이에서 모델이 견고한 성능을 보임을 확인했습니다.
- **이상 진단(Anomaly Diagnosis) 능력:**
  - MTAD-GAT는 각 특징의 추론 점수를 기반으로 이상 발생의 근본 원인이 될 가능성이 있는 특징들을 정렬합니다.
  - TSA 데이터셋에서 NDCG@5는 0.8556, HitRate@100%는 0.7428을 기록하며, 실제 근본 원인이 되는 특징들을 상위 후보에 포함시키는 우수한 진단 능력을 보여주었습니다. 이는 실제 AI-ops 시나리오에서 문제 해결 시간을 단축하는 데 기여할 수 있습니다.
- **사례 연구:**
  - **참 음성(True Negative) 사례:** 여러 시계열이 함께 급증하더라도 상관관계가 유지되면 오탐을 피할 수 있음을 보여주었습니다.
  - **오탐(False Positive) 사례:** Flink 클러스터의 트래픽 급증으로 인한 일시적인 CPU 사용량 증가를 이상으로 오인하는 경우가 발생했습니다. 이는 드물게 발생하는 정상적인 패턴도 비지도 학습 알고리즘이 이상으로 처리할 수 있음을 시사하며, 향후 도메인 지식이나 사용자 피드백 통합의 필요성을 강조합니다.
- **미래 연구 방향:** 특징 간 상관관계에 대한 사용자 피드백이나 도메인 사전 지식 활용, 더 복잡한 이상 진단 시나리오 탐구 등이 있습니다.

## 📌 TL;DR

다변량 시계열 이상 탐지 문제에서 기존 모델들이 특징 간 관계를 명시적으로 포착하지 못해 오탐을 유발하는 한계를 해결하기 위해, MTAD-GAT는 **그래프 어텐션 네트워크**를 기반으로 한 새로운 자기 지도 프레임워크를 제안합니다. 이 모델은 **특징 중심(feature-oriented) GAT**와 **시간 중심(time-oriented) GAT**를 병렬로 사용하여 시계열과 타임스탬프 간의 동적 관계를 학습하고, **예측 기반 및 재구성 기반 모델을 공동으로 최적화**합니다. 결과적으로 MTAD-GAT는 세 가지 실제 데이터셋에서 기존 SOTA 모델들보다 우수한 성능을 달성하며, 특히 낮은 지연 시간에서 탁월함을 보입니다. 또한, 학습된 어텐션 스코어를 통해 **이상 진단**에 유용한 해석 가능성을 제공하며 실제 이상 발생의 근본 원인을 파악하는 데 기여합니다.
