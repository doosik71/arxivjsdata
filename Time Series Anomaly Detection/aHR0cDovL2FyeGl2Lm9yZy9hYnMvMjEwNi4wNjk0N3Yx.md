# Graph Neural Network-Based Anomaly Detection in Multivariate Time Series

Ailin Deng, Bryan Hooi

---

## 🧩 Problem to Solve

고차원 다변량 시계열 데이터(예: 센서 데이터)에서 시스템 오류나 사이버 공격과 같은 비정상 이벤트를 탐지하고 설명하는 것이 주요 목표입니다. 특히 다음과 같은 도전 과제들이 있습니다:

- 센서 간의 복잡하고 비선형적인 상호 관계를 효과적으로 포착하는 것.
- 이러한 관계에서 벗어나는 비정상적인 동작을 정확하게 탐지하고 그 원인을 설명하는 것.
- 기존 딥러닝 기반 이상 탐지 기법들은 센서 간의 명시적인 관계를 학습하거나 예측에 활용하지 않아 설명 가능성이 부족합니다.
- 그래프 신경망(GNN)은 그래프 구조 데이터를 모델링하는 데 효과적이지만, 센서 데이터의 경우 그래프 구조가 미리 알려져 있지 않고, 다양한 센서의 이질적인 특성을 모델링하기 위해 노드마다 다른 모델 파라미터를 적용하기 어렵다는 문제가 있습니다.

## ✨ Key Contributions

- **GDN(Graph Deviation Network) 제안:** 센서 간의 의존성 관계 그래프를 학습하고, 이 관계에서 벗어나는 이상을 탐지하며, 해당 이상을 설명할 수 있는 새로운 어텐션 기반 GNN 접근 방식을 제안합니다.
- **우수한 성능 입증:** 실제 수처리 플랜트 센서 데이터셋(SWaT 및 WADI)에 대한 실험을 통해 GDN이 기존 베이스라인 방법들보다 이상 탐지 정확도 측면에서 뛰어남을 입증했습니다.
- **높은 설명 가능성 제공:** 센서 임베딩과 학습된 그래프를 통해 GDN이 높은 설명 가능성(explainable model)을 제공함을 사례 연구로 보여줍니다. 이를 통해 탐지된 편차가 발생하는 서브그래프, 어텐션 가중치, 예측값과 실제값 비교를 통해 이상 현상의 근본 원인을 파악하는 데 도움을 줍니다.

## 📎 Related Works

- **이상 탐지 (Anomaly Detection):**
  - **고전적 방법:** 밀도 기반(LOF), 선형 모델 기반(PCA), 거리 기반(KNN), 단일 클래스 SVM 등이 있으며, 주로 선형적 관계 모델링에 한계가 있습니다.
  - **최근 딥러닝 방법:** 오토인코더(AE, VAE), GAN(Generative Adversarial Network), LSTM 기반 접근 방식 등이 고차원 데이터에서 성능 향상을 보였지만, 센서 간 명시적 관계 학습에 어려움이 있습니다.
- **다변량 시계열 모델링 (Multivariate Time Series Modelling):**
  - **고전적 방법:** 자기회귀 모델(ARIMA)은 선형성에 국한됩니다.
  - **딥러닝 방법:** CNN, LSTM, GAN 모델이 비선형 고차원 시계열 데이터 예측에 성공적이지만, 시계열 간의 관계를 명시적으로 학습하지 않는 경우가 많습니다.
  - **그래프 기반 방법:** 확률적 그래프 모델 등이 센서 간 상호 의존성을 모델링하지만, 대부분 정지(stationary) 시계열에 맞춰져 복잡한 비정지 시계열에는 어려움이 있습니다.
- **그래프 신경망 (Graph Neural Networks):**
  - GCN(Graph Convolutional Networks), GAT(Graph Attention Networks) 등은 그래프 구조 데이터의 복잡한 패턴을 모델링하는 데 성공적입니다.
  - 그러나 일반적인 GNN은 노드 행동을 모델링하는 데 동일한 모델 파라미터를 사용하며, 그래프 구조가 입력으로 주어져야 한다는 제약이 있습니다. 이는 센서마다 다른 행동을 보이는 이질적인 센서 데이터와 그래프 구조가 알려져 있지 않은 문제에는 부적합합니다.

## 🛠️ Methodology

GDN은 4가지 주요 구성 요소로 이루어져 있습니다:

1. **Sensor Embedding (센서 임베딩):**

   - 각 센서 $i$의 고유한 특성을 포착하기 위해 임베딩 벡터 $v_i \in \mathbb{R}^d$를 도입합니다.
   - 임베딩은 무작위로 초기화되며 모델의 나머지 부분과 함께 학습됩니다.
   - 유사한 임베딩 값을 가진 센서는 유사한 동작 특성을 가집니다. 이는 그래프 구조 학습 및 어텐션 메커니즘에 활용됩니다.

2. **Graph Structure Learning (그래프 구조 학습):**

   - 센서 간의 의존성 관계를 나타내는 **방향성 그래프**를 학습합니다. $A_{ji}$는 센서 $j$가 센서 $i$의 동작 모델링에 사용됨을 나타냅니다.
   - 센서 $i$의 임베딩 $v_i$와 후보 센서 $j \in C_i$의 임베딩 $v_j$ 간의 정규화된 내적 유사도 $e_{ji} = \frac{v_i^\top v_j}{\|v_i\| \cdot \|v_j\|}$를 계산합니다.
   - 각 센서 $i$에 대해 상위 $K$개의 유사도를 가진 후보 $j$를 선택하여 에지 $A_{ji}=1$을 생성합니다. $K$는 사용자가 지정할 수 있는 희소성(sparsity) 수준을 결정합니다.

3. **Graph Attention-Based Forecasting (그래프 어텐션 기반 예측):**

   - 과거 시계열 데이터의 슬라이딩 윈도우 $x^{(t)} \in \mathbb{R}^{N \times w}$를 입력으로 받아 현재 시점 $t$의 센서 값 $s^{(t)}$를 예측합니다.
   - **특징 추출기 (Feature Extractor):** 학습된 그래프 구조를 기반으로 노드의 정보를 이웃 노드의 정보와 융합하기 위해 그래프 어텐션 메커니즘을 사용합니다.
     - 노드 $i$의 집계된 표현 $z^{(t)}_i = \text{ReLU}\left(\alpha_{i,i}Wx^{(t)}_i + \sum_{j \in N(i)} \alpha_{i,j}Wx^{(t)}_j\right)$를 계산합니다.
     - 어텐션 계수 $\alpha_{i,j}$는 센서 임베딩 $v_i$와 변환된 특징 $Wx^{(t)}_i$를 연결한 $g^{(t)}_i = v_i \oplus Wx^{(t)}_i$를 사용하여 계산됩니다.
     - $\pi(i,j) = \text{LeakyReLU}(a^\top (g^{(t)}_i \oplus g^{(t)}_j))$
     - $\alpha_{i,j} = \frac{\exp (\pi(i,j))}{\sum_{k \in N(i) \cup \{i\}} \exp (\pi(i,k))}$ (softmax 정규화).
   - **출력 계층 (Output Layer):** 모든 노드의 표현 $\{z^{(t)}_1, \dots, z^{(t)}_N\}$에 해당 센서 임베딩 $v_i$를 원소별 곱셈($\circ$)한 후, 이를 스택된 완전 연결 계층에 입력하여 센서 값 벡터 $\hat{s}^{(t)}$를 예측합니다.
   - 손실 함수로 예측값 $\hat{s}^{(t)}$와 실제 관측값 $s^{(t)}$ 간의 평균 제곱 오차(MSE)를 사용합니다.

4. **Graph Deviation Scoring (그래프 편차 점수화):**
   - 예측값과 관측값 간의 차이를 기반으로 이상 스코어를 계산하여 이상을 탐지하고 설명합니다.
   - 각 센서 $i$에 대해 시점 $t$에서의 오류 값 $Err_i(t) = |s^{(t)}_i - \hat{s}^{(t)}_i|$를 계산합니다.
   - 서로 다른 센서들의 편차 스케일이 다를 수 있으므로, 각 센서의 오류 값에 대해 중앙값($\tilde{\mu}_i$)과 사분위 범위(IQR, $\tilde{\sigma}_i$)를 사용하여 강건하게 정규화합니다: $a_i(t) = \frac{Err_i(t) - \tilde{\mu}_i}{\tilde{\sigma}_i}$.
   - 전체 시점 $t$에서의 비정상성 스코어 $A(t)$는 모든 센서의 정규화된 오류 값 중 최댓값으로 집계합니다: $A(t) = \max_i a_i(t)$.
   - 갑작스러운 값 변화로 인한 오류 스파이크를 완화하기 위해 단순 이동 평균(SMA)을 사용하여 평활화된 스코어 $A_s(t)$를 생성합니다.
   - $A_s(t)$가 검증 데이터셋의 최댓값으로 설정된 임계값을 초과하면 해당 시점을 이상으로 분류합니다.

## 📊 Results

- **RQ1 (정확도):**
  - GDN은 SWaT 및 WADI 데이터셋 모두에서 PCA, KNN, FB, AE, DAGMM, LSTM-VAE, MAD-GAN 등 모든 베이스라인 방법보다 우수한 이상 탐지 정확도를 보였습니다.
  - SWaT 데이터셋에서는 F1-score 0.81, WADI 데이터셋에서는 F1-score 0.57을 달성했으며, 특히 WADI에서 다음으로 좋은 베이스라인보다 54% 높은 F1-score를 기록했습니다.
  - 이는 GDN이 불균형하고 고차원적인 공격 시나리오에서도 효과적임을 보여줍니다.
- **RQ2 (어블레이션 연구):**
  - 학습된 그래프 구조를 완전 그래프로 대체하거나, 어텐션 메커니즘에서 센서 임베딩을 제거하거나, 어텐션 메커니즘 자체를 제거했을 때 GDN의 성능이 모두 저하되었습니다.
  - 특히 어텐션 메커니즘을 제거했을 때 가장 큰 성능 저하가 나타났습니다.
  - 이는 학습된 그래프 구조, 센서 임베딩, 어텐션 메커니즘이 모두 GDN의 높은 정확도에 필수적인 요소임을 입증합니다.
- **RQ3 (모델 해석 가능성):**
  - **센서 임베딩을 통한 해석:** t-SNE를 이용한 센서 임베딩 시각화 결과, WADI 데이터셋에서 유사한 기능을 수행하는 센서들(예: 2FICx01CO 센서 그룹)이 군집을 형성하는 것을 확인하여 임베딩이 센서 행동 유사성을 잘 반영함을 보였습니다.
  - **그래프 에지 및 어텐션 가중치를 통한 해석:** 학습된 그래프의 에지는 센서 간 관계를, 어텐션 가중치는 노드 모델링에서 이웃 노드의 중요도를 나타내어 해석에 기여합니다.
- **RQ4 (이상 현상 국지화):**
  - WADI 데이터셋의 유량 센서(1_FIT_001_PV) 공격 사례 연구에서 GDN은 가장 높은 이상 스코어를 가진 1_MV_001_STATUS 센서를 주요 이탈 센서로 식별했습니다.
  - GDN의 어텐션 가중치는 이탈 센서와 가장 밀접하게 관련된 센서들(예: 1_FIT_001_PV)을 가리켰습니다.
  - GDN은 1_MV_001_STATUS가 증가할 것으로 예측했지만, 공격으로 인해 변화가 관측되지 않아 큰 오류가 발생했음을 보여줌으로써, 예측값과 관측값 비교를 통해 이상 현상의 원인을 설명했습니다.
  - 결론적으로, GDN은 개별 이상 스코어로 이상을 국지화하고, 어텐션 가중치로 관련 센서를 찾으며, 예측을 통해 이상이 어떻게 기대치에서 벗어나는지 이해하는 데 도움을 줍니다.

## 🧠 Insights & Discussion

GDN은 다변량 시계열 데이터에서 센서 간의 복잡하고 비선형적인 관계를 학습하고, 이러한 관계에서 벗어나는 이상을 탐지하는 데 매우 효과적입니다. 특히, 미리 알려지지 않은 그래프 구조를 학습하고, 센서별 이질적인 특성을 반영하는 임베딩을 GNN에 통합한 점이 주요 성공 요인입니다. 어텐션 메커니즘은 이웃 노드의 영향력을 동적으로 가중하여 모델 성능을 크게 향상시켰습니다. 또한, GDN의 센서 임베딩, 학습된 그래프, 어텐션 가중치, 그리고 예측과 실제 관측값 비교를 통한 이상 설명 기능은 실제 시스템 운영자가 이상 현상의 근본 원인을 이해하고 신속하게 대응하는 데 큰 도움을 줄 수 있습니다. 이는 특히 중요 기반 시설과 같은 사이버 물리 시스템에서 신뢰성 있는 이상 탐지 및 진단이 필수적인 시나리오에서 GDN의 실용적 가치를 높입니다. 향후 연구에서는 다양한 GNN 아키텍처와 온라인 학습 방법을 고려하여 접근 방식의 실용성을 더욱 높일 수 있을 것입니다.

## 📌 TL;DR

- **문제:** 고차원 다변량 센서 시계열 데이터에서 센서 간의 복잡하고 알려지지 않은 상호 관계를 파악하여 이상을 탐지하고 그 원인을 설명해야 합니다.
- **방법:** GDN(Graph Deviation Network)은 어텐션 기반 그래프 신경망입니다. 센서 임베딩을 통해 센서 의존성 그래프를 학습하고, 이 학습된 그래프에서 그래프 어텐션을 사용하여 센서 동작을 예측합니다. 예측된 동작과 실제 관측값 간의 편차를 계산하여 이상 점수를 매김으로써 이상을 탐지하고 설명합니다.
- **주요 발견:** GDN은 실제 수처리 플랜트 데이터셋(SWaT, WADI)에서 기존 이상 탐지 모델들보다 훨씬 높은 정확도를 달성했습니다. 또한, 학습된 센서 임베딩(유사 센서 그룹화), 그래프 에지, 어텐션 가중치, 그리고 예측값과 관측값 비교를 통해 높은 수준의 해석 가능성을 제공하여 사용자가 이상을 국지화하고 근본 원인을 이해하는 데 도움을 줍니다.
