# An Attention-based ConvLSTM Autoencoder with Dynamic Thresholding for Unsupervised Anomaly Detection in Multivariate Time Series

Tareq Tayeh, Sulaiman Aburakhia, Ryan Myers, and Abdallah Shami

## 🧩 Problem to Solve

스마트 제조(Smart Manufacturing, SM) 시스템은 방대한 양의 다변량 시계열 데이터를 생성하며, 이는 운영 위험을 줄이고 모니터링 부담을 경감하기 위한 향상된 이상 감지(anomaly detection) 프레임워크를 필요로 합니다. 그러나 이러한 프레임워크를 구축하는 것은 다음과 같은 난제들을 수반합니다:

- **데이터 희소성:** 충분히 많은 양의 결함 데이터(anomalous data)를 확보하기 어려워 지도 학습(supervised learning) 방식 적용이 비현실적입니다.
- **복잡한 종속성:** 프레임워크는 서로 다른 시간 단계(time steps)에 걸쳐 시계열 데이터의 **시간적(temporal)** 및 **문맥적(contextual)** 종속성을 모두 포착해야 합니다.
- **노이즈 강건성:** 노이즈에 강건(robust)해야 합니다.
- **근본 원인 진단:** 이상 징후 발생 시 그 근본 원인을 식별(diagnosis)할 수 있어야 합니다.

## ✨ Key Contributions

- **새로운 비지도 학습 프레임워크 제안:** 다변량 시계열 데이터 전처리 및 풍부화, 특징 이미지(feature images) 생성, 어텐션(attention) 기반 ConvLSTM 오토인코더(autoencoder)를 통한 재구성, 동적 임계값(dynamic thresholding) 메커니즘을 포함하여 이상 감지 및 근본 원인 식별을 수행합니다.
- **다목적 심층 학습(Deep Learning, DL) 기반 솔루션:** 다양한 SM 다변량 시계열 활용 사례에 적용 가능한 범용적인 비지도 학습 프레임워크를 제공합니다.
- **안정적인 모델 성능:** 어텐션 기반, 시간 분산형 ConvLSTM 인코더-디코더(encoder-decoder) 모델을 통해 입력 시계열 시퀀스의 길이가 증가해도 일정한 성능을 유지합니다.
- **적응형 임계값 메커니즘:** 데이터의 비정상성(non-stationarity), 노이즈(noise), 다양성(diversity) 문제를 해결하기 위해 재구성 오류를 평가하는 비모수적(nonparametric)이고 동적인 임계값 메커니즘을 사용합니다.
- **실제 데이터 기반 성능 검증:** 실제 제조 데이터셋으로 평가하여 최첨단(state-of-the-art) 방법론들 대비 우수한 성능을 입증했습니다.

## 📎 Related Works

- **고전적 방법론:** 확률 기반([18]), 거리 기반([19]), 클러스터링 기반([20]), 예측 기반([21]) 접근법들은 복잡한 데이터 구조를 포착하지 못하고 데이터 볼륨 증가 시 확장성에 한계가 있습니다.
- **기계 학습(ML) 방법론:** K-NNs([22]), SVMs([23]), 신경망([24]) 등은 지도 학습 기반으로, 레이블링된 이상 데이터 부족과 특징 추출에 인간의 전문 지식이 필요하다는 한계가 있습니다.
- **심층 학습(DL) 방법론:**
  - **CNNs([27]):** 시각 이미지 분석에 탁월하지만, 시계열의 고차원 특징 학습에 어려움을 겪습니다.
  - **LSTMs([28]):** 순환 신경망(RNN)의 특수 형태로, 피드백 루프를 사용하여 시계열과 같은 시간적 행동 모델링에 강점을 보입니다.
  - **ConvLSTM([15]):** CNN과 LSTM의 장점을 결합하여 입력-상태 및 상태-상태 전환 모두에 컨볼루션 구조를 사용하여 시공간 정보(spatio-temporal information)를 정확하게 모델링합니다.
  - **오토인코더([29]):** 비지도 학습 모델로, 입력 데이터를 효율적으로 압축하고 재구성하여 재구성 오류를 최소화합니다.
- **어텐션 메커니즘([16]):** 입력 시퀀스 길이가 길어질 때 모델 성능 저하를 방지하기 위해 관련 있는 은닉 상태(hidden states)를 선택적으로 가중치 부여하여 모델 오류를 줄입니다.
- **하이퍼파라미터 최적화([17]):** 모델 성능 향상을 위해 그리드 탐색(grid search), 랜덤 탐색(random search) 등이 사용되며, 본 논문에서는 랜덤 탐색이 채택되었습니다.

## 🛠️ Methodology

제안하는 ACLAE-DT(Attention-based ConvLSTM Autoencoder with Dynamic Thresholding) 프레임워크는 다음 단계로 구성됩니다.

1. **시계열 전처리 (Pre-process Time Series):**

   - 각 다변량 시계열 $x_i$를 **Min-Max 스케일링**을 사용하여 0에서 1 사이의 값으로 정규화합니다:
     $$x'_{i} = \frac{x_{i} - \min(x_{i})}{\max(x_{i}) - \min(x_{i})}$$
   - 이는 큰 스케일의 특징이 지배하는 것을 방지하고, 경사 하강법(gradient descent)의 수렴 속도를 높입니다.

2. **시계열 풍부화 (Enrich Time Series):**

   - **슬라이딩 윈도우(Sliding Windows) 활용:** 전처리된 시계열을 슬라이딩 윈도우를 사용하여 다변량 서브시퀀스(multivariate subsequences)로 변환합니다. 이는 시간 지연 값(lagged values)을 포함하여 시간적 행동을 더 풍부하게 포착할 수 있게 합니다.
   - **문맥 정보 임베딩(Embedding Contextual Information):** 제조 공정의 문맥 정보(예: 클램프 압력)를 통합하여 이상 감지 성능을 향상시킵니다.
     - 원-핫 인코딩(one-hot encoding)의 한계를 극복하기 위해 **엔티티 임베딩(Entity Embeddings)**을 사용하여 각 카테고리를 저차원 공간 $W_{embedding} \in \mathbb{R}^{q \times p}$ (여기서 $p < q$)에 매핑합니다. 임베딩된 표현은 $embedded(v) = onehot(v) \times W_{embedding}$ 로 정의됩니다.

3. **특징 이미지 구성 (Construct Feature Images):**

   - 각 슬라이딩 윈도우 세그먼트에 대해 $(n+p) \times (n+p)$ 크기의 **특징 이미지 $M_t$**를 구성합니다.
   - 이 특징 이미지는 슬라이딩 윈도우 내 두 시계열 간의 쌍별 **내적(pairwise inner-product)**을 기반으로 **상호 상관관계(inter-correlations)**를 나타냅니다:
     $$m^{t}_{ij} = \sum_{ \delta=0}^{w} x^{t-\delta}_{i} x^{t-\delta}_{j} \in M_{t}$$
   - 특징 이미지는 시계열 쌍 간의 모양 유사성 및 상호 상관관계를 포착하며 노이즈에 강건합니다.

4. **어텐션 기반 ConvLSTM 오토인코더 모델 (Attention-based ConvLSTM Autoencoder Model):**

   - **인코더:** 세 개의 ConvLSTM 인코딩 레이어와 MaxPool 레이어를 번갈아 사용하여 특징 이미지를 인코딩하고 시간적 행동을 포착합니다.
   - **디코더:** 세 개의 ConvLSTM 디코딩 레이어와 UpSample 레이어를 번갈아 사용하여 압축된 지식 표현으로부터 원본 특징 이미지를 재구성합니다.
   - ConvLSTM 레이어는 커널 크기 $(3 \times 3)$ 및 'same' 패딩을 사용하며, 대부분 64개의 필터를 가집니다 (병목 계층은 32개 필터).
   - **Bahdanau 어텐션 메커니즘([16])**을 추가하여 시퀀스 길이가 증가하더라도 모델 성능을 일정하게 유지하고 오류를 줄입니다. 어텐션은 이전 시간 단계의 은닉 상태 $s_{t-1}$와 입력 시퀀스의 $t'$-번째 주석 $h_{t'}$ 간의 정렬(alignment)을 포착하는 $u_{t,t'}$를 통해 문맥 벡터 $c_t = \sum_{t'=1}^{T_x} \alpha_{t,t'} h_{t'}$를 계산합니다.

5. **모델 하이퍼파라미터 최적화 (Model's Hyperparameter Optimization):**

   - 모델 성능 향상을 위해 **랜덤 탐색(random search)** 방법을 사용하여 하이퍼파라미터를 튜닝합니다.
   - 최적화 대상: 활성화 함수(ReLU, Leaky ReLU, ELU, SELU), 학습률, 배치 크기, 최적화기(Adam, RMSProp, AdaDelta, SGD), 손실 함수(MAE, MSE, RMSE).

6. **재구성 오류 계산 (Compute Reconstruction Errors):**

   - 훈련 과정에서 정상 특징 이미지의 재구성 오류를 최소화하도록 모델을 학습시킵니다.
   - 목표는 정상 데이터는 정확하게 재구성하고, 이상 데이터는 부정확하게 재구성하여 재구성 오류를 크게 만드는 것입니다.

7. **동적 임계값 메커니즘 (Dynamic Thresholding Mechanism):**
   - 비모수적이고 동적인 이상 임계값 설정 메커니즘을 사용합니다.
   - 각 특징 이미지 내 **개별 시계열 쌍**에 대해 고유한 임계값을 계산합니다:
     $$\tau_{ij} = (\mu(e_{ij}) + z\sigma(e_{ij}))$$
     여기서 $\tau_{ij}$는 $i$와 $j$ 시계열 쌍의 임계값, $e_{ij}$는 정상 데이터의 재구성 오류 집합, $\mu$는 평균, $\sigma$는 표준 편차, $z$는 표준 편차의 배수를 나타내는 양의 값입니다 (2~5 범위에서 가장 정확한 결과).
   - 재구성 오류가 이 임계값을 초과하면 해당 시계열 쌍이 이상으로 플래그되고, 이는 전체 프로세스가 이상하다고 판단하는 데 기여합니다.
   - 이 메커니즘은 이상 징후를 감지할 뿐만 아니라 그 **근본 원인(root cause)**이 되는 센서를 식별하는 데 도움을 줍니다.

## 📊 Results

- **데이터셋:** 미시간 대학교에서 제공하는 CNC Mill Tool Wear 데이터셋(44개 시계열, 18개 실험 중 4개는 육안 검사 실패).
- **실험 설정:** 윈도우 크기 및 스텝 사이즈를 변경하며 3가지 실험 진행 (실험 1: 윈도우 10/스텝 2, 실험 2: 윈도우 30/스텝 5, 실험 3: 윈도우 60/스텝 10). 모든 DL 모델은 250 에포크(epochs) 훈련.
- **비교 모델:** SVM, ARIMA, LSTM Autoencoder, ConvLSTM-LSTM Autoencoder, CNN-LSTM Autoencoder, ACLAE-DT Shallow(ACLAE-DT의 얕은 버전), ACLAE-DT No-Attention(어텐션 제외 버전).
- **평가 지표:** Precision, Recall, F1-Score, 훈련 시간(Train Time).

**주요 결과 요약:**

- **ACLAE-DT의 우수성:** 모든 실험 설정에서 ACLAE-DT Full 모델이 가장 우수한 이상 감지 성능을 보였습니다.
  - **클래식/ML 모델 압도:** ARIMA와 SVM은 복잡한 관계를 포착하지 못하여 DL 기반 모델들에 비해 현저히 낮은 성능을 보였습니다.
  - **경쟁 DL 모델 능가:** ACLAE-DT는 LSTM, ConvLSTM-LSTM, CNN-LSTM 오토인코더 등 기존 DL 기반 모델보다 모든 평가 지표에서 뛰어난 성능을 보였고, 훈련 시간도 더 짧았습니다. 특히 윈도우 크기가 커질수록 성능 격차가 더욱 벌어졌습니다.
  - **실험 3 (윈도우 60/스텝 10):** ACLAE-DT Full은 Precision 0.99, Recall 1.00, F1-Score 1.00이라는 거의 완벽한 성능을 달성했으며, 평균 훈련 시간은 1,736초였습니다.
- **ACLAE-DT 구성 요소의 효과:**
  - ACLAE-DT Full은 ACLAE-DT Shallow 및 ACLAE-DT No-Attention보다 전반적으로 더 좋은 성능을 보이거나 유사한 최고 성능을 유지하여, 깊은 모델 구조와 어텐션 메커니즘의 효과를 입증했습니다. 특히 윈도우 크기가 30 이상일 때 어텐션의 중요성이 부각되었습니다.
- **이상 근본 원인 식별:**
  - 실험 3에서 ACLAE-DT는 이상 징후를 유발하는 주요 센서로 X축 모터의 X1-OutputCurrent (95.7% 기여), X1-DCBusVoltage (88.2%), X1-ActualAcceleration (78.7%)를 정확하게 지목했습니다.
  - 시각적 분석 결과, ACLAE-DT는 정상 데이터는 잘 재구성했지만, 이전에 관찰되지 않은 시스템 상태를 포함하는 이상 데이터(특히 피크 값)는 재구성에 실패하여 재구성 오류가 동적 임계값을 초과하는 것을 확인했습니다.
- **실행 시간 및 메모리 요구사항 (윈도우당, 실험 3):**
  - LSTM 오토인코더가 가장 빠른 실행 시간(약 10ms)을 보였고, ACLAE-DT Shallow가 두 번째(약 11.25ms)였습니다.
  - ACLAE-DT Shallow가 가장 적은 메모리(약 0.14MB)를 사용했습니다.
  - ACLAE-DT Full은 뛰어난 이상 감지 성능과 짧은 훈련 시간을 제공하지만, 윈도우당 실행 시간(약 14ms) 및 메모리 사용량(약 0.26MB)은 다른 DL 모델이나 Shallow 버전에 비해 높았습니다. 그러나 이는 성능 향상에 따른 합리적인 트레이드오프(trade-off)로 간주될 수 있습니다.

## 🧠 Insights & Discussion

- **DL 기반 이상 감지의 효과성:** 본 연구는 SM 환경의 다변량 시계열 이상 감지에서 ConvLSTM 오토인코더와 같은 딥러닝 기술이 고전적/ML 기반 방법론을 압도함을 명확히 보여줍니다. 이는 딥러닝이 복잡한 시공간적 패턴과 센서 간 상호 관계를 효과적으로 포착하기 때문입니다.
- **어텐션 및 심층 구조의 중요성:** 어텐션 메커니즘과 더 깊은 모델 구조는 특히 긴 시계열 시퀀스에서 모델의 성능을 일관되게 유지하고 향상시키는 데 중요한 역할을 합니다. 이는 실제 산업 데이터의 복잡성에 대응하는 핵심 요소입니다.
- **동적 임계값의 실용성:** 비모수적이고 동적인 임계값 메커니즘은 비정상적이고 노이즈가 많으며 다양성이 큰 제조 데이터에 적응적으로 대응하여 효과적인 이상 감지 및 근본 원인 진단을 가능하게 합니다.
- **실제 적용 가능성:** ACLAE-DT는 높은 정밀도(Precision), 재현율(Recall), F1-점수와 비교적 빠른 훈련 시간을 보여줌으로써 실제 스마트 제조 공정에 적용할 수 있는 실용적인 솔루션임을 입증했습니다.
- **성능과 자원 간의 트레이드오프:** ACLAE-DT Full 모델은 가장 뛰어난 이상 감지 및 원인 식별 성능을 제공하지만, 윈도우당 실행 시간과 메모리 소비 측면에서는 약간의 트레이드오프가 존재합니다. 그러나 ACLAE-DT Shallow 버전은 자원 효율성을 중시하는 시나리오에서 여전히 강력한 대안이 될 수 있습니다.
- **향후 연구 방향:** ACLAE-DT 모델을 다른 공개 데이터셋에 적용하여 성능을 벤치마킹하고, ACLAE-DT Full 모델의 실행 시간과 메모리 소비를 줄이면서도 우수한 이상 감지 및 원인 식별 성능을 유지하는 방법을 모색하는 것이 제안됩니다.

## 📌 TL;DR

이 논문은 스마트 제조(SM) 환경의 다변량 시계열 데이터에서 **비지도 학습 기반 이상 감지 및 근본 원인 진단**을 위한 **ACLAE-DT(Attention-based ConvLSTM Autoencoder with Dynamic Thresholding)** 프레임워크를 제안합니다. 주요 문제는 레이블링된 이상 데이터 부족과 데이터의 복잡한 **시공간적/문맥적 종속성**을 포착하는 것입니다.

ACLAE-DT는 다음을 수행합니다:

1. **전처리 및 풍부화:** Min-Max 스케일링, 슬라이딩 윈도우, 엔티티 임베딩을 통한 문맥 정보 통합.
2. **특징 이미지 생성:** 시계열 쌍 간의 **내적**을 통해 시스템 상태를 나타내는 특징 이미지 생성.
3. **어텐션 기반 ConvLSTM 오토인코더:** 특징 이미지를 학습하여 정상 패턴을 재구성하고, **어텐션 메커니즘**으로 긴 시퀀스에서도 안정적인 성능을 유지.
4. **동적 임계값 메커니즘:** 재구성 오류의 통계적 특성(평균, 표준편차)을 이용해 **개별 시계열 쌍마다 동적인 임계값**을 설정하여 이상 징후를 감지하고, **근본 원인이 되는 센서를 식별**합니다.

실제 제조 데이터셋에 대한 평가에서 ACLAE-DT는 기존 ML 및 DL 방법론들보다 **우수한 이상 감지 성능(특히 F1-Score)**을 보였으며, 효율적으로 이상 원인을 진단했습니다. 높은 성능은 다소 높은 실행 시간 및 메모리 소비와 트레이드오프 관계를 보였으나, SM 공정에서 그 실용성과 적합성을 입증했습니다.
