# Correlation-aware Spatial-Temporal Graph Learning for Multivariate Time-series Anomaly Detection

Yu Zheng, Huan Yee Koh, Ming Jin, Lianhua Chi, Khoa T. Phan, Shirui Pan, Yi-Ping Phoebe Chen, Wei Xiang

## 🧩 Problem to Solve

다변량 시계열 이상 탐지(Multivariate Time-series Anomaly Detection)는 소매, 운송, 전력망, 수처리 공장 등 다양한 응용 분야에서 매우 중요합니다. 기존 접근 방식들은 다음과 같은 한계점을 가집니다:

- 통계 모델은 비선형 관계를 잘 포착하지 못합니다.
- CNN, LSTM과 같은 기존 딥러닝 모델은 변수 간의 쌍별 상관관계를 명시적으로 학습하지 않습니다.
- 일반적인 공간-시간 그래프 신경망(STGNN)은 사전 정의된 그래프 구조를 필요로 하지만, 많은 시계열 데이터셋에서 이러한 그래프가 없는 경우가 많습니다.
- GDN(Graph Deviation Network)과 같은 초기 STGNN 기반 모델은 직접 이웃의 공간 의존성만 포착하고, 멀티-홉(multi-hop) 이웃 정보나 명시적인 시계열 내 시간 관계를 충분히 모델링하지 못합니다.

이러한 문제들을 해결하기 위해 다음 세 가지 도전 과제를 해결해야 합니다:

1. **다변량 시계열 상관관계 학습**: 변수 간의 쌍별 관계를 어떻게 명시적으로 포착할 것인가?
2. **공간-시간 의존성 모델링**: 공간적 의존성과 시간적 의존성을 어떻게 동시에 포착할 것인가?
3. **이상 점수 계산**: 지도 학습 없이 이상 점수를 어떻게 효과적으로 추정할 것인가?

## ✨ Key Contributions

- **통합 알고리즘 제안**: 다변량 시계열 데이터 분석을 위한 `CST-GL` (Correlation-aware Spatial-Temporal Graph Learning)을 제안합니다. 이 방법은 상관관계 학습을 공간-시간 네트워크에 완벽하게 통합합니다.
- **새로운 이상 탐지 방법**: 복잡한 시계열에서 자동 임계값 설정을 통해 이상 현상을 자동으로 탐지하고, 조기 탐지를 효과적으로 가능하게 합니다.
- **뛰어난 성능 입증**: 11개의 기존 모델(베이스라인)들과 비교하여 일반 이상 탐지 및 조기 탐지 설정 모두에서 우수한 성능을 보였습니다.
- **설명 가능성 및 근본 원인 진단**: 실제 응용 사례 연구를 통해 `CST-GL`이 이상 탐지뿐만 아니라 근본 원인을 설명 가능한 방식으로 진단할 수 있음을 입증합니다.

## 📎 Related Works

- **다변량 시계열 이상 탐지**:
  - **전통적 방법**: ARIMA/VAR, PCA, SVM 등 통계 모델 및 웨이블릿 분석, 패턴 기반, 거리 기반 접근 방식들이 있었으나, 비선형 공간 및 시간 관계를 잘 포착하지 못합니다.
  - **딥러닝 기반**: RNN(특히 LSTM), CNN, VAE, GAN 등이 시간적 의존성을 포착하는 데 사용되었으나, 다변량 변수 간의 쌍별 상호 의존성을 명시적으로 학습하기보다는 전역 은닉 상태(global hidden state)에 캡슐화하는 경향이 있어 잠재적 의존성을 충분히 활용하지 못했습니다 (예: LSTM-VAE, OmniAnomaly, USAD, InterFusion).
- **그래프 학습 및 GNNs**:
  - **일반 GNNs (GCN, GAT)**: 메시지 전달 방식을 통해 노드 임베딩을 업데이트하여 그래프 데이터의 상호 관계를 활용하지만, 사전 정의된 그래프 구조가 필요합니다.
  - **그래프 구조 학습 (예: SUBLIME)**: 데이터 자체에서 그래프 구조를 자동으로 학습하는 방법을 다루지만, 주로 정적 데이터에 적용됩니다.
  - **공간-시간 그래프 신경망 (STGNNs)**: GNN을 동적 그래프 데이터(노드 특징은 변하지만 그래프 구조는 정적) 처리를 위해 확장한 것으로, 교통 예측 등에 효과적입니다. 하지만 기존 STGNN은 그래프 학습 모듈과 강력한 이상 점수 계산 모듈이 부족했습니다 (예: MTAD-GAT, GDN). 특히 GDN은 공간 의존성을 직접 이웃에 대해서만 포착하고 시간적 관계 모델링이 부족합니다.

## 🛠️ Methodology

`CST-GL`은 다변량 시계열 이상 탐지를 위해 세 가지 주요 구성 요소로 이루어져 있습니다:

1. **다변량 시계열 상관관계 학습(Multivariate Time-Series Correlation Learning, MTCL)**:

   - 각 시계열 변수(노드) 간의 잠재적 연관성(엣지)을 명시적으로 학습하여 알 수 없는 그래프 인접 행렬 $A$를 적응적으로 추론합니다.
   - $N_1, N_2 \in R^{N \times d}$ 두 개의 노드 임베딩 행렬과 학습 가능한 파라미터 $W_1, W_2 \in R^{d \times d}$를 사용하여 $A = ReLU(tanh(\alpha (e_{N1} e_{N2}^T - e_{N2} e_{N1}^T)))$ 형태로 정의하여 단방향(uni-directional) 관계를 포착합니다.
   - 계산 비용 절감을 위해 각 노드의 상위 $k$개 이웃을 제외한 요소를 0으로 설정하여 $A$를 희소하게 만듭니다.

2. **공간-시간 그래프 신경망(Spatial-Temporal Graph Neural Network, STGNN)**:

   - **그래프 컨볼루션 네트워크(GCN)**:
     - 바닐라 GCN의 과평활(over-smoothing) 문제를 피하기 위해 게이팅 메커니즘을 도입합니다: $H_{k+1} = \beta H_{in} + (1-\beta) \tilde{A} H_k$. $\beta$는 원본 노드 정보 유지 비율을 제어합니다.
     - 여러 홉(multi-hop)으로부터의 정보를 혼합하는 어텐티브 변환 $H_{out} = \sum_{k=0}^{K} H_k W_k$을 사용하여 오류를 완화합니다.
     - $A$와 $A^T$를 모두 사용하여 노드의 유입(inflow) 및 유출(outflow) 정보를 통합합니다.
   - **시간 컨볼루션 네트워크(TCN)**:
     - RNN의 단점을 피하기 위해 여러 개의 잔여(residual) 확장 시간 컨볼루션(dilated temporal convolution) 레이어를 사용하여 비재귀적으로 고수준의 시간 특징을 추출합니다.
     - 게이팅 메커니즘 $TCN(Z_l, \Phi_l) = f_C(Z_l, \Phi_l^c) \odot f_G(Z_l, \Phi_l^g)$을 통해 정보 흐름을 제어합니다.
     - 다양한 커널 폭(예: 2, 3, 6, 7)을 사용하여 다중 세분화된 시간적 단서(multi-granular temporal clues)를 포착합니다.
   - STGNN 레이어는 GCN과 TCN을 엮어서 구성됩니다: $Z_{l+1} = T(Z_l, Q_{l+1}) + GCN(TCN(Z_l, \Phi_l), W)$. 최종적으로 MLP를 통해 단일 스텝 예측 $\hat{x}_T$를 수행합니다.

3. **이상 탐지 및 진단(Anomaly Detection and Diagnosis, ADD)**:
   - **실시간 이상 지표**:
     - 각 단변량 변수에 대해 현재 시점 $T$에서의 정규화된 예측 편차 $\tilde{e}_{T_i} = \frac{e_{T_i} - \mu_{T_i}}{\sigma_{T_i}}$를 계산합니다. $\mu_{T_i}$와 $\sigma_{T_i}$는 슬라이딩 윈도우 내 과거 오류 값들의 중앙값(median)과 사분위 범위(IQR)입니다. 이는 실시간 탐지를 가능하게 합니다.
     - 주성분 분석(PCA)을 사용하여 다변량 정규화 오류 벡터 $\tilde{E}_T$를 재구성합니다 $\tilde{E}_T^{PCA}$. PCA는 이상 노드가 네트워크 임베딩에 편향을 유발하여 다른 변수의 예측 오류를 불필요하게 증가시키는 문제를 완화합니다.
     - 최종 이상 점수는 재구성된 오류와 원본 정규화 오류 간의 L1 거리로 계산합니다: $A(T) = ||\tilde{E}_T^{PCA} - \tilde{E}_T||_1$.
     - 자동 임계값 설정: 유효성 검증(validation) 세트에서 최대 이상 점수를 임계값으로 사용하여 이상 여부를 판단합니다.
   - **근본 원인 이상 진단**:
     - 각 단변량 변수가 이상 점수에 기여하는 정도를 기준으로 순위를 매겨 근본 원인을 식별합니다.
     - 상위 랭크된 변수가 단순히 증상일 경우, MTCL 모듈에서 학습된 관계를 기반으로 1-홉(one-hop) 이웃들의 이상 기여 점수를 합산하여 실제 근본 원인 변수를 찾습니다: $R_i(T) = \sum_{j \in N(i)} A_i(T)$.

## 📊 Results

`CST-GL`은 SWaT, WADI, SMD 세 가지 벤치마크 데이터셋에 대해 Raw Signal, PCA, AutoEncoder, Kmeans, DAGMM 등 5가지 표준 다차원 이상 탐지 방법과 LSTM-VAE, OmniAnomaly, USAD, MTAD-GAT, GDN, InterFusion 등 6가지 최신 다변량 시계열 이상 탐지 프레임워크와 비교 평가되었습니다.

- **전반적인 탐지 성능**: `CST-GL`은 ROC AUC와 PRC AUC 점수 모두에서 모든 베이스라인을 뛰어넘는 우수한 성능을 보였습니다 (ROC AUC 7.16%P, PRC AUC 8.30%P 평균 향상). 특히 WADI 데이터셋의 PRC 값에서는 차선책에 비해 45% 이상의 성능 향상을 달성했습니다.
- **모듈별 기여(Ablation Study)**:
  - `MTCL`을 제거하거나(`w/o MTCL`), `GCN` 모듈을 제거하거나(`w/o GCN`), `TCN`을 수정(`mod. TCN`)하면 성능이 저하되어 각 구성 요소의 중요성을 입증했습니다. 특히 `w/o MTCL`은 변수가 많은 WADI 데이터셋에서 성능 저하가 뚜렷했습니다.
  - `PCA` 기반 이상 점수 계산 모듈을 제거했을 때(`w/o PCA`)도 성능 저하가 발생하여 `PCA`의 노이즈 제거 능력이 중요함을 시사합니다.
  - `STGNN`을 제거(`w/o STGNN`, 즉 PCA 모델만 남았을 때)했을 때는 성능이 크게 감소하여 `STGNN`이 이상 탐지를 위한 포괄적인 솔루션의 핵심임을 보여주었습니다.
- **자동 임계값 설정 메커니즘**: `CST-GL`의 비모수적 임계값 선택은 SWaT 데이터셋에서 최적의 F1 점수에 근접하는 유망한 결과를 보였습니다. WADI 및 SMD에서는 약간의 성능 저하가 있었으나, 여전히 유효한 수준이었습니다.
- **조기 탐지 성능**:
  - `CST-GL`은 지연 없는 즉각적인 탐지( $\delta=0$ )에서 다른 베이스라인에 비해 86.27%(SWaT), 43.44%(WADI), 2.75%(SMD)의 상당한 성능 향상을 보였습니다.
  - 모든 지연 시간 $\delta$에 걸쳐 대부분의 데이터셋에서 가장 우수한 성능을 유지하며, 다양한 실세계 운영 요구사항에 적용될 수 있는 높은 실용성을 입증했습니다.
- **근본 원인 이상 진단(RC-Top3)**:
  - `MTCL-Graph`를 활용한 `CST-GL`은 SWaT 및 WADI 데이터셋에서 이상 현상의 근본 원인을 식별하는 데 탁월했습니다. 이는 오류 기여도가 높은 변수가 실제 원인이 아닌 증상일 때 특히 유용합니다.
  - SMD에서는 이상 행동을 보이는 변수가 직접적인 근본 원인인 경우가 많아 `MTCL-Graph` 없이 PCA 기반 순위만으로도 높은 성능을 보였습니다.
  - WADI 수처리 시스템의 은밀한 공격(stealth attack) 사례 연구에서 `CST-GL`은 4분 이내에 이상을 감지하고, 127개의 센서 중 단 6개만 검사하여 근본 원인을 성공적으로 식별했습니다.

## 🧠 Insights & Discussion

`CST-GL`은 다변량 시계열 이상 탐지 분야에서 기존 모델의 한계를 효과적으로 극복했습니다. 특히, 변수 간의 쌍별 상관관계를 명시적으로 학습하고, 공간적 및 시간적 의존성을 통합적으로 모델링하는 능력은 정확하고 조기 이상 탐지에 결정적인 역할을 합니다. `PCA` 기반의 이상 점수 계산 모듈은 노이즈를 효과적으로 제거하고 실제 이상 이벤트에 크게 기여하는 변수를 식별하는 데 도움을 줍니다.

`MTCL-Graph`를 통한 근본 원인 진단 기능은 실제 산업 환경에서 운영자가 이상 현상의 실제 원인을 신속하게 파악하고 대응하는 데 필수적인 통찰력을 제공합니다. 단순히 이상이 발생했음을 알리는 것을 넘어, 그 원인을 특정하는 것은 시스템의 안정성과 효율성을 크게 향상시킬 수 있습니다.

**제한 사항 및 향후 연구**:

- **강건성(Robustness) 향상**: GNN에서 이상 현상이 모델링 프로세스에 편향을 도입하는 문제를 해결하고, 대규모 센싱 네트워크에서 발생하는 장기적인 연쇄 이상 효과에 대한 강건성을 강화할 계획입니다. 이를 위해 과평활(over-smoothing) 및 과압축(over-squashing) 문제를 완화할 수 있는 GNN 기술과 온라인 적응형 재배선(online adaptive rewiring) 방법을 탐색할 예정입니다.
- **적용 범위 확장**: 개념 드리프트(concept drift) 및 결측값(missing values) 처리 기능을 통합하여 `CST-GL`의 적용 범위를 넓힐 계획입니다. 데이터 드리프트를 감지하고 정량화하는 메커니즘을 구현하고, 결측값 처리를 위해 표준 보간법/대치(imputation) 알고리즘 및 공간-시간 그래프 제어 미분 방정식(Graph ODEs)을 고려할 것입니다.
- **신뢰성(Trustworthiness) 연구**: GNN 모델의 강건성 및 설명 가능성 측면에서 신뢰성에 대한 연구를 계속하고, 대규모 언어 모델(LLM)이 시계열 데이터의 그래프 학습을 어떻게 향상시킬 수 있는지 탐구할 예정입니다.

## 📌 TL;DR

**문제**: 기존 다변량 시계열 이상 탐지 모델들은 변수 간의 비선형 쌍별 상관관계와 명시적인 공간-시간 의존성을 효과적으로 포착하지 못하며, 사전 정의된 그래프가 없는 환경에서 특히 취약합니다.

**방법**: `CST-GL`은 세 가지 핵심 모듈로 구성됩니다. 첫째, **다변량 시계열 상관관계 학습(MTCL)** 모듈은 변수들 간의 적응형 단방향 그래프 구조를 학습합니다. 둘째, **공간-시간 그래프 신경망(STGNN)** 모듈은 학습된 그래프를 바탕으로 게이팅된 그래프 컨볼루션(과평활 방지, 멀티-홉 정보 활용)과 확장 시간 컨볼루션(다중 세분화된 시간적 단서 포착)을 엮어 정확한 미래 값을 예측합니다. 셋째, **이상 탐지 및 진단(ADD)** 모듈은 실시간 PCA 기반 이상 점수 계산기를 사용하여 예측 오류를 정규화하고 노이즈를 제거한 뒤 L1 거리를 통해 이상 점수를 산출하며, 자동 임계값 설정을 통해 이상을 탐지합니다. 또한, 학습된 그래프 관계를 활용하여 근본 원인 진단 기능을 제공합니다.

**결과**: `CST-GL`은 일반 이상 탐지 및 조기 이상 탐지 설정 모두에서 11가지 베이스라인 모델을 뛰어넘는 우수한 성능을 보였습니다. 특히 즉각적인 이상 탐지에서 상당한 성능 향상을 달성했으며, 실제 사례 연구를 통해 적은 수의 센서만으로도 근본 원인을 효과적으로 진단할 수 있음을 입증하여 실세계 응용 가능성을 제시했습니다.
