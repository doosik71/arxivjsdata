# Time-Series Anomaly Detection Service at Microsoft

Hansheng Ren, Bixiong Xu, Yujing Wang, Chao Yi, Congrui Huang, Xiaoyu Kou, Tony Xing, Mao Yang, Jie Tong, Qi Zhang

## 🧩 Problem to Solve

이 논문은 대규모 산업 환경에서 시계열 이상 감지 서비스가 직면하는 주요 과제를 해결하고자 합니다. 이러한 과제는 다음과 같습니다:

1. **레이블 부족 (Lack of Labels)**: 수백만 개의 시계열을 수동으로 레이블링하기 어려우며, 데이터 분포가 지속적으로 변하여 유사한 패턴이 이전에 나타나지 않았더라도 이상을 인식해야 하므로 지도 학습 모델이 부적합합니다.
2. **일반화 (Generalization)**: 다양한 비즈니스 시나리오에서 계절성(seasonal), 안정성(stable), 불안정성(unstable) 등 여러 종류의 시계열 패턴을 효과적으로 모니터링해야 하지만, 기존 방법들은 모든 패턴에 충분히 일반화되지 못합니다.
3. **효율성 (Efficiency)**: 수백만, 심지어 수십억 개의 시계열을 실시간에 가깝게 처리해야 하므로, 분 단위 시계열의 경우 제한된 시간 내에 이상 감지를 완료해야 합니다. 높은 정확도를 가진 모델이라도 시간 복잡도가 크면 온라인 시나리오에서 활용하기 어렵습니다.

따라서, 이 연구의 목표는 정확하고 효율적이며 일반화된 비지도 학습 기반의 시계열 이상 감지 접근 방식을 개발하는 것입니다.

## ✨ Key Contributions

- **시각적 특이점 감지(Visual Saliency Detection) 기법 도입**: 시계열 이상 감지 분야에서 처음으로 시각적 특이점 감지(특히 Spectral Residual, SR) 기술을 도입하여 컴퓨터 비전 기술이 이상 감지 문제 해결에 활용될 수 있음을 입증했습니다.
- **SR-CNN 모델 제안**: Spectral Residual(SR) 모델과 Convolutional Neural Network(CNN)를 혁신적으로 결합하여 시계열 이상 감지 정확도를 크게 향상시켰습니다. 특히 Microsoft 프로덕션 데이터에서 F1-score를 20% 이상 개선했습니다.
- **높은 일반화 및 효율성**: 제안된 솔루션은 다양한 시계열 패턴에 대해 뛰어난 일반화 능력을 보이며, 효율적이어서 온라인 모니터링 시스템에 쉽게 통합되어 신속한 알림을 제공할 수 있습니다.
- **실제 적용 및 성능**: Microsoft 내 200개 이상의 제품 팀에서 사용되어 연간 수백만 개의 시계열을 모니터링하며, 공개 및 사내 데이터셋에서 최신 비지도 및 지도 학습 모델 대비 우수한 성능을 달성했습니다.

## 📎 Related Works

- **기존 이상 탐지기**:
  - **통계적 접근 방식**: 가설 검정, 웨이블릿 분석, SVD, ARIMA, FFT, Twitter-AD, Luminol, Extreme Value Theory 기반의 SPOT 및 DSPOT 등이 있습니다. 효율적이지만 실제 적용에서 정확도가 불충분한 경우가 많습니다.
  - **지도 학습 접근 방식**: Opprentice(통계적 특징 추출 + Random Forest), Yahoo EGADS(여러 모델 + 필터링 레이어), Google의 딥러닝 모델 등이 있습니다. 정확도가 높지만, 산업 환경에서 지속적인 레이블 획득이 어려워 온라인 적용에 한계가 있습니다.
  - **비지도 학습 접근 방식**: DONUT(Variational Auto-Encoder 기반), LinkedIn Luminol(시계열 청크 분할 및 유사성 기반) 등이 있습니다.
- **특이점 감지(Saliency Detection) 접근 방식**:
  - **Spectral Residual (SR)**: Hou et al. [10]이 제안한 것으로, 이미지를 중복 부분과 혁신 부분으로 나누고 혁신 부분이 시각적으로 더 중요하다고 가정합니다. 로그 진폭 스펙트럼에서 평균 로그 진폭 스펙트럼을 빼는 방식으로 이미지의 특이점을 포착합니다.
  - **Phase Spectrum 기반**: Guo et al. [8]은 위상 스펙트럼만으로 특이점 감지가 충분하다고 주장했습니다.
  - **CNN 기반**: Zhao et al. [25]은 CNN 아키텍처 기반의 다중 컨텍스트 딥러닝 프레임워크로 특이점 감지 문제를 해결했습니다.

## 🛠️ Methodology

본 논문은 Microsoft의 시계열 이상 감지 서비스의 파이프라인과 SR(Spectral Residual) 및 CNN을 결합한 SR-CNN 알고리즘을 소개합니다.

### 시스템 파이프라인

전체 시스템은 세 가지 주요 모듈로 구성됩니다:

- **데이터 수집(Data Ingestion)**: 사용자는 Azure 저장소, 데이터베이스, 온라인 스트리밍 데이터 등 다양한 소스에서 시계열을 등록할 수 있습니다. 수집 워커는 지정된 세분성(분, 시간, 일)에 따라 시계열 데이터를 InfluxDB 및 Kafka로 업데이트합니다.
- **온라인 계산(Online Compute)**: 데이터 포인트가 파이프라인에 들어오면 즉시 처리됩니다. Flink를 사용하여 메모리 내 데이터 포인트를 관리하여 계산 효율성을 최적화합니다. 이상 감지 프로세서는 각 시계열에 대해 이상 상태를 감지하며, 스마트 알림 프로세서는 관련 시계열의 이상을 상관시켜 인시던트 보고서를 생성합니다.
- **실험 플랫폼(Experimentation Platform)**: 이상 감지 모델의 성능을 평가하기 위한 플랫폼입니다. 새 모델 배포 전에 오프라인 실험 및 온라인 A/B 테스트를 수행합니다. 사람이 수동으로 이상점을 레이블링하거나 모델 결과에서 오탐을 레이블링하여 모델의 정확도, 효율성, 일반성을 평가합니다. 유효성이 검증된 모델은 Azure Machine Learning 서비스에서 웹 서비스로 배포됩니다.

### 이상 감지 알고리즘 (SR-CNN)

시계열 $x = x_1, x_2, \dots, x_n$가 주어졌을 때, 각 $x_i$가 이상점인지 ($y_i=1$) 아닌지 ($y_i=0$)를 나타내는 출력 시퀀스 $y = y_1, y_2, \dots, y_n$를 생성하는 것이 목표입니다.

#### 1. SR (Spectral Residual)

SR 알고리즘은 시각적 특이점 감지에서 차용한 비지도 학습 방식으로, 세 가지 주요 단계를 거칩니다.

1. **푸리에 변환(Fourier Transform)을 통한 로그 진폭 스펙트럼 획득**: 입력 시퀀스 $x$에 푸리에 변환($F$)을 적용하여 진폭 스펙트럼 $A(f)$와 위상 스펙트럼 $P(f)$를 얻습니다. $A(f)$에 로그를 취하여 $L(f)$를 계산합니다.
   $$A(f) = \text{Amplitude}(F(x)) \quad (1)$$
   $$P(f) = \text{Phrase}(F(x)) \quad (2)$$
   $$L(f) = \log(A(f)) \quad (3)$$
2. **스펙트럼 잔차(Spectral Residual) 계산**: $L(f)$의 평균 스펙트럼 $AL(f)$를 계산합니다. $AL(f)$는 $h_q(f)$ 매트릭스로 컨볼루션하여 근사화됩니다. 스펙트럼 잔차 $R(f)$는 $L(f)$에서 $AL(f)$를 빼서 얻습니다.
   $$AL(f) = h_q(f) \cdot L(f) \quad (4)$$
   $$R(f) = L(f) - AL(f) \quad (5)$$
3. **역 푸리에 변환(Inverse Fourier Transform)을 통한 공간 도메인 복원**: 스펙트럼 잔차 $R(f)$와 원래의 위상 스펙트럼 $P(f)$를 사용하여 역 푸리에 변환($F^{-1}$)을 수행하여 시계열을 공간 도메인으로 되돌립니다. 이 결과 시퀀스를 **특이점 지도(saliency map)** $S(x)$라고 합니다.
   $$S(x) = \left| F^{-1}(\exp(R(f) + iP(f))) \right| \quad (6)$$
   $S(x)$를 기반으로 간단한 임계값 $\tau$를 사용하여 이상점을 탐지합니다.
   $$O(x_i) = \begin{cases} 1, & \text{if } \frac{S(x_i) - \overline{S(x_i)}}{\overline{S(x_i)}} > \tau, \\ 0, & \text{otherwise}, \end{cases} \quad (7)$$
   여기서 $\overline{S(x_i)}$는 $S(x_i)$의 이전 $z$개 지점의 지역 평균입니다.
   실제 구현에서는 슬라이딩 윈도우 내에서 FFT를 수행하며, 최신 포인트 $x_n$이 윈도우 중앙에 오도록 여러 개의 '예측 지점'을 추가하여 $S(x)$를 계산합니다. 예측 지점 $x_{n+1}$은 이전 $m$개 지점의 평균 기울기($\text{avg\_gradient}$)를 기반으로 계산됩니다.

#### 2. SR-CNN

원래 SR 방법은 단일 임계값을 사용하지만, SR-CNN은 이 규칙을 대체하기 위해 CNN 기반의 판별 모델을 훈련합니다.

- **합성 이상치 데이터 생성**: 이상치가 포함되지 않은 특이점 지도($S(x)$) 데이터셋에 인위적으로 이상점을 주입하여 합성 학습 데이터를 생성합니다. 이 주입된 지점들은 이상치로 레이블링되고 나머지는 정상으로 레이블링됩니다.
  - 주입될 이상치 값 $x_{inj}$는 이전 지점들의 지역 평균 $x_{prev\_avg}$, 현재 슬라이딩 윈도우 내 모든 지점의 평균 $\text{mean}$ 및 분산 $\text{var}$, 그리고 정규 분포에서 샘플링된 무작위 값 $r \sim N(0,1)$을 활용하여 결정됩니다.
    $$x_{inj} = (x_{prev\_avg} + \text{mean})(1 + \text{var}) \cdot r + x_{prev\_avg} \quad (10)$$
- **CNN 아키텍처**: 1차원 컨볼루션 레이어 2개(필터 크기는 슬라이딩 윈도우 크기 $\omega$와 동일), 완전 연결 레이어 2개, 그리고 시그모이드 출력으로 구성됩니다. 교차 엔트로피를 손실 함수로, SGD를 최적화 도구로 사용합니다. 이 방법을 통해 수동 레이블링 없이도 시계열 분포 변화에 적응하는 강력한 이상 감지기를 구축합니다.

## 📊 Results

- **데이터셋**: KPI, Yahoo (공개 데이터셋), Microsoft (사내 프로덕션 데이터셋) 세 가지를 사용했으며, 다양한 시계열 간격과 패턴을 포함합니다.
- **평가 지표**: 정확도(Precision, Recall, F1-score), 효율성(CPU 실행 시간), 일반성(Yahoo 데이터셋의 계절성, 안정성, 불안정성 클래스별 F1-score 분산)을 평가했습니다. 정확도 평가 시 연속 이상 구간 내 한 지점이라도 일정 지연 시간 $k$ 내에 감지되면 해당 구간 전체를 올바른 감지로 처리하는 조정된 전략을 사용했습니다.
- **SR/SR-CNN 성능**:
  - **Cold-start 시나리오(표 2)**: SR 및 SR-CNN은 FFT, Twitter-AD, Luminol 대비 F1-score에서 KPI 36.1%, Yahoo 68.8%, Microsoft 21.2%의 상당한 개선을 보였습니다.
  - **학습 데이터 사용 시나리오(표 3)**: SPOT, DSPOT, DONUT과 비교했을 때, SR 및 SR-CNN은 KPI 48.0%, Yahoo 92.9%, Microsoft 57.0%의 F1-score 개선을 달성했습니다.
  - **효율성**: SR은 가장 효율적인 방법이었으며, SR-CNN은 합리적인 지연 시간 증가와 함께 더 나은 정확도를 달성했습니다.
  - **일반성(표 4)**: SR은 Yahoo 데이터셋의 세 가지 시계열 클래스(계절성, 안정성, 불안정성) 전반에 걸쳐 가장 안정적인 성능을 보였고, SR-CNN도 우수한 일반화 능력을 입증했습니다.
- **SR+DNN 성능**: SR 모델의 중간 결과를 지도 학습 DNN 모델의 추가 특징으로 활용했을 때, KPI 데이터셋에서 바닐라 DNN 모델 대비 F1-score가 1.6% 향상되어 0.811을 기록했으며, 이는 해당 데이터셋에서 최고 성능입니다. 이는 SR 특징이 기존 이상 감지기에 보완 정보를 제공함을 보여줍니다.

## 🧠 Insights & Discussion

- **영역 간 기술 전이의 성공**: 시각적 특이점 감지(visual saliency detection)에서 영감을 받은 Spectral Residual 모델을 시계열 이상 감지에 성공적으로 적용한 것은 이종 분야 간 기술 전이의 잠재력을 보여줍니다. 시계열 이상점과 시각적 특이점이 본질적으로 유사하다는 직관이 유효함을 입증했습니다.
- **레이블링 문제 해결 및 성능 향상**: SR-CNN은 수동 레이블링이 부족한 산업 환경의 문제를 합성 데이터 생성을 통해 우회하고, SR의 강점과 CNN의 판별 능력을 결합하여 비지도 설정에서 최첨단 성능을 달성했습니다. 이는 실제 서비스에 적용 가능한 실용적인 해결책을 제시합니다.
- **실용적인 가치 및 영향**: 본 서비스는 Microsoft 내 200개 이상의 팀에 배포되어 4백만 개 이상의 시계열을 모니터링하며, 라이브 사이트 문제 해결 시간을 단축하고 수동 작업을 줄이는 데 기여하고 있습니다. 이는 제안된 방법이 단순한 학술적 성과를 넘어 실제 비즈니스 가치를 창출하고 있음을 의미합니다.
- **향후 계획**: 더 강력한 이상 감지 서비스를 제공하기 위해 최신 방법들을 앙상블하고, Microsoft Azure Cognitive Service의 일부로 외부 고객에게 제공할 계획입니다. 이는 이 기술이 계속해서 발전하고 더 넓은 범위에 영향을 미칠 잠재력을 가지고 있음을 시사합니다.

## 📌 TL;DR

Microsoft는 대규모 산업 시계열 이상 감지의 난제(레이블 부족, 일반화, 효율성)를 해결하기 위해 **SR-CNN**이라는 새로운 비지도 학습 알고리즘과 서비스 파이프라인을 제안합니다. 이 알고리즘은 시각적 특이점 감지 기법인 **Spectral Residual(SR)**을 시계열 이상 감지에 최초로 적용하고, SR의 출력에 **CNN**을 결합하여 합성 이상치 데이터로 훈련함으로써 수동 레이블 없이도 뛰어난 성능을 달성합니다. 공개 및 Microsoft 내부 데이터셋에서 SR-CNN은 기존 최신 모델들을 크게 능가하는 F1-score를 기록하며, 효율성과 다양한 시계열 패턴에 대한 일반화 능력을 입증했습니다. 현재 Microsoft 서비스에 통합되어 200개 이상의 팀에서 활용되며, 향후 Azure Cognitive Service로도 출시될 예정입니다.
