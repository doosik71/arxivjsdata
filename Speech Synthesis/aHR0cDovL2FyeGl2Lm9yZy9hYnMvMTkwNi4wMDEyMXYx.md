# Graph WaveNet for Deep Spatial-Temporal Graph Modeling

Zonghan Wu, Shirui Pan, Guodong Long, Jing Jiang, Chengqi Zhang

## 🧩 Problem to Solve

기존 시공간 그래프 모델링 접근 방식은 대부분 사전에 결정된 고정된 그래프 구조에 의존하여 공간적 의존성을 포착합니다. 그러나 이러한 명시적인 그래프 구조가 실제 의존성을 정확히 반영하지 못하거나, 데이터 내 불완전한 연결로 인해 중요한 관계가 누락될 수 있습니다. 또한, 기존 RNN 또는 CNN 기반 방법론은 장거리 시간 시퀀스(long-range temporal sequences)를 효과적으로 포착하는 데 비효율적이라는 한계가 있습니다. RNN은 긴 시퀀스에서 시간이 오래 걸리고 기울기 폭발/소실 문제가 있으며, CNN은 넓은 수용장(receptive field)을 확보하기 위해 많은 레이어를 필요로 합니다.

## ✨ Key Contributions

- **자기 적응형 인접 행렬(Self-adaptive Adjacency Matrix) 개발:** 데이터에서 숨겨진 공간적 의존성(hidden spatial dependency)을 자동으로 학습하여, 사전 지식 없이도 보이지 않는 그래프 구조를 발견할 수 있습니다.
- **효율적인 시공간 의존성 포착 프레임워크 제시:** 제안된 그래프 컨볼루션과 확장형 인과적 컨볼루션(dilated causal convolution)을 통합하여, 각 그래프 컨볼루션 레이어가 서로 다른 시간적 granular level에서 추출된 노드 정보의 공간적 의존성을 처리하도록 합니다.
- **장거리 시간 시퀀스 처리 능력 강화:** WaveNet에서 영감을 받은 스택형 확장형 1D 컨볼루션(stacked dilated 1D convolution)을 사용하여, 레이어 수가 증가함에 따라 수용장이 지수적으로 확장되어 매우 긴 시퀀스를 효과적으로 처리합니다.
- **통합된 엔드투엔드(End-to-End) 학습 프레임워크:** 두 핵심 구성 요소를 하나의 프레임워크에 원활하게 통합하고 엔드투엔드 방식으로 학습하며, 두 가지 공개 교통 데이터셋에서 SOTA(state-of-the-art) 성능을 달성합니다.

## 📎 Related Works

- **그래프 컨볼루션 네트워크(GCN):** 그래프 구조 데이터 학습의 핵심 요소로, 스펙트럼 기반(예: Bruna et al., Defferrard et al., Kipf and Welling) 및 공간 기반(예: Atwood and Towsley, Gilmer et al., Hamilton et al.) 접근 방식으로 나뉩니다. 대부분의 방법은 고정된 인접 행렬을 사전 지식으로 간주합니다.
- **시공간 그래프 네트워크(Spatial-temporal Graph Networks):**
  - **RNN 기반:** GCN을 순환 신경망(RNN)에 통합하여 시공간 의존성을 포착합니다(예: Seo et al., Li et al., Zhang et al.). 그러나 긴 시퀀스 처리 비효율성과 기울기 폭발/소실 문제에 직면합니다.
  - **CNN 기반:** GCN을 표준 1D 컨볼루션 신경망(CNN)에 통합합니다(예: Yu et al., Yan et al.). 계산 효율적이지만, 넓은 수용장을 위해 많은 레이어를 쌓아야 합니다.

## 🛠️ Methodology

Graph WaveNet은 스택형 시공간 레이어와 출력 레이어로 구성됩니다.

1. **문제 정의:**
   그래프 $G = (V, E)$와 각 시간 $t$에서의 동적 특징 행렬 $X^{(t)} \in \mathbb{R}^{N \times D}$가 주어졌을 때, 과거 $S$단계 그래프 신호 $[X^{(t-S):t}, G]$를 입력으로 받아 다음 $T$단계 그래프 신호 $X^{(t+1):(t+T)}$를 예측하는 함수 $f$를 학습하는 것이 목표입니다.

2. **그래프 컨볼루션 레이어 (GCN):**

   - 기존의 확산 컨볼루션 레이어(Li et al., 2018b)를 일반화하여 $K$단계 확산 과정을 모델링합니다. 방향성 그래프의 경우 정방향 전이 행렬 $P_f$와 역방향 전이 행렬 $P_b$를 사용합니다.
   - **자기 적응형 인접 행렬($\tilde{A}_{\text{adp}}$):** 두 개의 학습 가능한 노드 임베딩 행렬 $E_1, E_2 \in \mathbb{R}^{N \times c}$를 무작위로 초기화하여 다음 식을 통해 학습합니다:
     $$ \tilde{A}_{\text{adp}} = \text{SoftMax}(\text{ReLU}(E_1 E_{2}^{T})) $$
        $E_1$은 소스 노드 임베딩, $E_2$는 타겟 노드 임베딩입니다. $\text{ReLU}$는 약한 연결을 제거하고 $\text{SoftMax}$는 정규화를 수행합니다. 이 행렬은 숨겨진 확산 과정의 전이 행렬로 간주될 수 있습니다.
   - 최종 그래프 컨볼루션 레이어는 사전 정의된 공간 의존성과 자체 학습된 숨겨진 그래프 의존성을 결합합니다:
     $$ Z = \sum*{k=0}^{K} P*{f}^{k} X W*{k1} + P*{b}^{k} X W*{k2} + \tilde{A}*{\text{adp}}^{k} X W*{k3} $$
     그래프 구조를 알 수 없을 때는 $\tilde{A}*{\text{adp}}$만 사용하여 숨겨진 공간 의존성을 포착할 수 있습니다.

3. **시간 컨볼루션 레이어 (TCN):**

   - **확장형 인과적 컨볼루션(dilated causal convolution)**을 사용하여 노드의 시간적 경향을 포착합니다. 이 컨볼루션은 레이어 깊이 증가에 따라 수용장이 지수적으로 증가하며, 비재귀적인 방식으로 긴 시퀀스를 처리하여 병렬 계산과 기울기 문제 완화에 기여합니다.
   - **게이트 TCN (Gated TCN):** 정보 흐름을 제어하기 위해 게이팅 메커니즘을 사용합니다. 입력 $X \in \mathbb{R}^{N \times D \times S}$에 대해 다음과 같은 형태를 가집니다:
     $$ h = g(\Theta*1 * X + b) \odot \sigma(\Theta*2 * X + c) $$
        여기서 $\odot$는 요소별 곱셈, $g(\cdot)$는 활성화 함수, $\sigma(\cdot)$는 시그모이드 함수입니다.

4. **Graph WaveNet 프레임워크:**
   - 입력은 선형 레이어를 거쳐 게이트 시간 컨볼루션 모듈(Gated TCN)로 전달된 후 그래프 컨볼루션 레이어(GCN)를 거칩니다.
   - 각 시공간 레이어는 잔차 연결(residual connections)을 가지며, 출력 레이어에 스킵 연결(skip connections)됩니다.
   - Graph WaveNet은 $T$단계 예측을 한 번에 생성하여 훈련과 테스트 간의 불일치 문제를 해결하고, MAE(Mean Absolute Error)를 훈련 목표로 사용합니다.

## 📊 Results

- **데이터셋:** METR-LA 및 PEMS-BAY 두 가지 공개 교통 네트워크 데이터셋에서 평가되었습니다.
- **성능 비교:** Graph WaveNet은 ARIMA, FC-LSTM, WaveNet, DCRNN, GGRU, STGCN 등 모든 기준 모델을 뛰어넘어 두 데이터셋 모두에서 15분, 30분, 60분 예측에서 가장 우수한 성능을 달성했습니다 (MAE, RMSE, MAPE 기준).
- **자기 적응형 인접 행렬의 효과:**
  - 사전 정의된 그래프 구조 없이 $\tilde{A}_{\text{adp}}$만 사용한 'Adaptive-only' 모델이 'Forward-only' 모델보다 평균 MAE에서 더 나은 성능을 보여, 숨겨진 공간 의존성을 학습하는 능력의 중요성을 입증했습니다.
  - 사전 정의된 구조와 $\tilde{A}_{\text{adp}}$를 결합한 'Forward-backward-adaptive' 모델이 세 가지 평가 지표 모두에서 가장 낮은 점수를 기록하며, 기존 정보에 유용한 추가 정보를 제공함을 시사했습니다.
  - 학습된 $\tilde{A}_{\text{adp}}$의 히트맵 분석 결과, 특정 노드(예: 교차로 근처 노드 9)가 다른 노드들에 더 큰 영향력을 가짐을 시각적으로 확인했습니다.
- **계산 시간:** METR-LA 데이터셋에서 Graph WaveNet은 DCRNN보다 훈련 시 약 5배 빠르고, 추론 시에는 가장 효율적이었습니다. 이는 Graph WaveNet이 여러 예측 단계를 한 번의 실행으로 생성하는 반면, 다른 모델들은 이전 예측에 의존하여 결과를 생성하기 때문입니다.

## 🧠 Insights & Discussion

- **숨겨진 의존성 발견의 중요성:** Graph WaveNet의 자기 적응형 인접 행렬은 명시적 그래프 구조가 불완전하거나 부정확할 때도 데이터에서 실제 의존성을 성공적으로 학습할 수 있음을 입증했습니다. 이는 시스템의 의존성 구조를 알 수 없는 경우에 특히 유용한 새로운 모델링 방향을 제시합니다.
- **장거리 시간 의존성 처리 능력:** 스택형 확장형 인과적 컨볼루션은 기존 RNN 기반 모델의 한계를 극복하고 긴 시간 시퀀스를 효율적으로 모델링할 수 있는 강력한 대안을 제공합니다.
- **통합 프레임워크의 시너지:** 그래프 컨볼루션과 확장형 인과적 컨볼루션을 하나의 엔드투엔드 프레임워크에 통합함으로써, 각 구성 요소의 장점을 극대화하고 시공간 의존성을 효과적으로 동시에 포착할 수 있었습니다.
- **추론 효율성:** 여러 예측 단계를 한 번에 생성하는 방식은 기존 재귀적 예측 방식에 비해 추론 시간을 크게 단축시키는 실용적인 이점을 제공합니다.
- **한계 및 향후 연구:** 현재 모델은 고정된 공간 의존성을 학습하지만, 미래 연구에서는 대규모 데이터셋에 대한 확장 가능한 방법과 동적 공간 의존성을 학습하는 접근 방식을 탐색할 계획입니다.

## 📌 TL;DR

기존 시공간 그래프 모델이 고정된 그래프 구조에 의존하고 긴 시간 시퀀스 처리에 비효율적인 문제를 해결하기 위해, Graph WaveNet이 제안되었습니다. 이 모델은 **자기 적응형 인접 행렬**을 통해 데이터에서 숨겨진 공간 의존성을 자동으로 학습하고, **스택형 확장형 인과적 컨볼루션**을 사용하여 장거리 시간 의존성을 효율적으로 포착합니다. 결과적으로 Graph WaveNet은 두 가지 교통 데이터셋에서 SOTA 성능을 달성했으며, 숨겨진 의존성 학습 및 효율적인 장거리 시간 시퀀스 모델링의 중요성을 입증했습니다.
