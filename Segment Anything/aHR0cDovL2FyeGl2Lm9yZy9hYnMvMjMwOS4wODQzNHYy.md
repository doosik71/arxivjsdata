# Segment Anything Model for Brain Tumor Segmentation

Peng Zhang, Yaping Wang

## 🧩 Problem to Solve

뇌종양의 정확한 분할은 임상 진단 및 치료에 매우 중요하지만, 현재 Convolutional Neural Network (CNN) 및 Transformer 기반 알고리즘들은 특정 데이터셋에 특화되어 있어 다른 유형의 데이터셋을 처리하려면 새로운 알고리즘을 설계해야 합니다. 이러한 모델들은 충분한 학습 데이터와 픽셀 수준의 수동 주석이 필요하며, 이는 특히 전문 지식을 요하는 의료 영상에서 시간과 노력이 많이 듭니다. 또한, 의료 영상은 영상 장비 및 양상에 따라 다양하여 모델의 일반화 능력을 제한합니다. 따라서 다양한 유형의 데이터셋에 적응할 수 있는 범용적인 파운데이션 모델의 필요성이 절실합니다. Meta AI가 출시한 Segment Anything Model (SAM)은 자연 영상 분할에서 뛰어난 성능을 보였지만, 경계가 모호한 의료 영상, 특히 뇌종양 분할에서의 효과는 아직 충분히 탐구되지 않았습니다.

## ✨ Key Contributions

* SAM의 제로샷(zero-shot) 일반화 능력을 뇌종양 분할 작업에서 포괄적으로 평가했습니다. 이는 다양한 프롬프트 전략, 여러 영상 양상 데이터, 그리고 상이한 종양 영역을 포함합니다.
* SAM의 프롬프트 전략에 무작위성 수준(예: 점 프롬프트 무작위 이동, 박스 프롬프트 무작위 스케일링)을 추가하여 실제 인터랙티브 분할 시나리오에서의 성능을 더 잘 반영하고자 했습니다.
* 상당량의 뇌종양 데이터셋으로 SAM을 파인튜닝(fine-tuning)하여, SAM의 분할 성능이 크게 향상될 수 있음을 확인했으며, 이는 다운스트림 작업에서의 SAM의 중요한 잠재력을 보여줍니다.

## 📎 Related Works

* **CNN 기반 모델**: ResNet, GoogleNet, DenseNet, U-Net 등 다양한 의료 영상 분할 및 컴퓨터 비전 분야에서 성공을 거두었습니다.
* **Transformer 기반 모델**: NLP 분야에서 주목할 만한 성과를 거둔 후 컴퓨터 비전 분야에서도 활용되고 있습니다.
* **대규모 언어 모델 (LLM)**: ChatGPT, GPT-4, LLaMA 등 컴퓨팅 파워와 방대한 네트워크 데이터를 통해 강력한 성능을 보여주었습니다.
* **Segment Anything Model (SAM)**: Meta AI Research에서 출시한 최초의 이미지 분할 파운데이션 모델로, 11M개 이미지와 1B개 이상의 마스크를 포함하는 SA-1B 데이터셋으로 학습되어 뛰어난 일반화 능력을 보여줍니다.

## 🛠️ Methodology

1. **뇌종양 분할 데이터셋**:
    * BraTS2019 데이터셋 사용: 고등급 신경교종(HGG) 259 케이스, 저등급 신경교종(LGG) 76 케이스.
    * 각 케이스는 4가지 영상 양상(T1, T1ce, T2, FLAIR)과 경험 많은 신경방사선 전문의의 수동 주석(Ground Truth, GT)을 포함합니다.
    * 주석은 4가지 클래스(배경, 괴사 및 비강화 종양, 종양 주변 부종, GD 강화 종양)로 구성되며, 3가지 종양 분할 영역(전체 종양, 종양 중심부, 강화 종양)으로 평가됩니다.
    * **데이터 전처리**: SAM은 2D 이미지만 지원하므로, 3D BraTS2019 MRI 이미지를 축 평면을 따라 2D 슬라이스로 변환했습니다. 종양이 없는 슬라이스는 GT를 기준으로 제거하여 유효한 데이터셋만 남겼습니다.

2. **SAM을 이용한 뇌종양 분할**:
    * Meta AI가 제공하는 SAM 소스 코드를 사용했습니다.
    * 다음 6가지 프롬프트 전략을 사용하여 실험을 수행했습니다:
        * 2개의 점 (양성 1개, 음성 1개)
        * 10개의 점 (양성 5개, 음성 5개)
        * 20개의 점 (양성 10개, 음성 10개)
        * 30개의 점 (양성 15개, 음성 15개)
        * 1개의 박스
        * 1개의 박스 + 1개의 양성 점
    * **점 프롬프트 생성**: GT의 무게 중심(중심점)을 기준으로 첫 양성 점을 선택하고, 나머지는 GT를 1D 벡터로 평탄화하여 균일하게 선택했습니다. 음성 점은 GT의 최소 경계 박스를 10픽셀 확장한 영역과 최소 경계 박스 사이의 중간 영역에서 균일하게 선택했습니다.
    * **박스 프롬프트 선택**: GT의 최소 경계 박스를 직접 사용했습니다.

3. **평가 지표**:
    * **Dice 계수 (Dice)**: 예측과 GT 마스크 간의 겹침 정도를 측정합니다. $Dice = \frac{2|P \cap G|}{|P| + |G|}$
    * **Hausdorff 거리 (HD)**: 예측 및 GT의 윤곽점 세트 간의 최대 불일치를 측정합니다. $HD = \max(h(A, B), h(B, A))$, 여기서 $h(A, B) = \max_{a \in A} \min_{b \in B} ||a-b||$
    * **평균 대칭 표면 거리 (ASSD)**: 분할 결과의 표면 정렬 정도를 측정합니다. $ASSD = \frac{1}{2} \left( \frac{\sum_{x \in X} \min_{y \in Y} d(x,y)}{len(X)} + \frac{\sum_{y \in Y} \min_{x \in X} d(y,x)}{len(Y)} \right)$

4. **추가 실험**:
    * **무작위성 도입**: 실제 인터랙티브 분할 시나리오를 시뮬레이션하기 위해, 이상적인 점/박스 프롬프트에 0-5, 5-10, 10-15 픽셀 범위의 무작위 스케일링(박스) 및 이동(점)을 적용하여 SAM의 성능 변화를 관찰했습니다.
    * **SAM 파인튜닝**: 제한된 연산 자원을 고려하여, 이미지 인코더와 프롬프트 인코더의 파라미터를 고정하고 마스크 디코더만 BraTS2019 2D 슬라이스 데이터셋의 일부를 사용하여 파인튜닝했습니다.

## 📊 Results

* **프롬프트 종류별 성능**:
  * 10개의 점 프롬프트는 2개의 점 프롬프트보다 우수하고 안정적인 성능을 보였습니다. 2개의 점은 분할에 충분한 정보를 제공하지 못했습니다.
  * 하지만 점 프롬프트 수가 20개, 30개로 계속 증가하면 성능이 감소하기 시작했습니다. 너무 많은 점은 서로 너무 가깝거나 경계에 위치하여 오탐(false positive) 영역을 증가시켰습니다.
  * 1개의 박스 프롬프트는 점 프롬프트 기반 SAM보다 우수한 성능을 보였습니다 (예: T2 양상 종양 중심부 분할에서 10점 Dice 0.7234 vs. 1박스 Dice 0.7605). 박스 프롬프트는 분할 결과를 효과적으로 제한하여 오탐 영역을 줄였습니다.
  * 1개의 박스와 1개의 양성 점 프롬프트를 결합했을 때, 1개의 박스 프롬프트만 사용한 경우보다 성능이 더욱 향상되었습니다 (예: T1ce 양상 종양 중심부 분할에서 1박스 Dice 0.7823 vs. 1박스+1점 Dice 0.8029). 추가적인 양성 점이 분할 위치 정교화에 도움을 주었습니다.

* **의료 영상 양상별 성능**:
  * T1ce, T2, FLAIR 양상 데이터의 Dice 값은 일반적으로 T1 양상 데이터보다 높았습니다. 이는 T1 양상 데이터의 경계가 가장 흐릿하기 때문입니다.
  * T1ce는 강화 종양과 종양 중심부의 경계는 명확하지만, 가장 바깥쪽 부분인 종양 주변 부종의 경계가 흐릿하여 전체 종양 분할 성능은 좋지 않았습니다.

* **분할 영역별 성능**:
  * 종양 중심부(tumor core) 분할 성능이 가장 좋았고, 그 다음으로 전체 종양(whole tumor), 강화 종양(enhancing tumor) 순이었습니다.
  * 이는 GD 강화 종양(GD-enhancing tumor)의 경계가 비교적 명확한 반면, 종양 주변 부종(peritumoral edema)의 경계는 매우 흐릿하기 때문입니다.

* **무작위성 도입의 영향**:
  * 프롬프트에 추가되는 무작위성이 점차 증가함에 따라 SAM의 분할 성능은 점진적으로 감소했습니다 (Dice 값 감소, HD 및 ASSD 값 증가). 이는 실제 인터랙티브 분할 시나리오의 어려움을 반영합니다.

* **파인튜닝의 영향**:
  * 뇌종양 데이터셋으로 SAM의 마스크 디코더를 파인튜닝한 결과, 분할 성능이 크게 향상되었습니다 (예: T1 양상 전체 종양 분할에서 파인튜닝 전 Dice 0.6989 -> 파인튜닝 후 Dice 0.8005). 이는 다운스트림 작업에서 SAM의 큰 잠재력을 시사합니다.

## 🧠 Insights & Discussion

* SAM은 뇌종양 분할에서 유망한 제로샷 일반화 능력을 보이지만, 최적의 성능을 위해서는 프롬프트 전략이 매우 중요합니다.
* 의료 영상의 흐릿한 경계 특성상 박스 프롬프트가 점 프롬프트보다 효과적이며, 박스 프롬프트는 관심 영역을 효율적으로 제한하여 오탐을 줄입니다. 박스 프롬프트와 점 프롬프트의 조합은 추가적인 정교화를 제공합니다.
* 점 프롬프트의 수는 적절해야 하며, 너무 많으면 오히려 성능 저하를 초래할 수 있습니다.
* SAM의 성능은 영상 양상의 특성과 종양 영역의 경계 선명도에 따라 크게 달라집니다.
* 실제 대화형 분할 환경에서 발생하는 프롬프트의 무작위성은 SAM의 성능에 부정적인 영향을 미치므로, 실제 적용을 위해서는 이러한 불확실성에 대한 강건성 확보가 필요합니다.
* SAM의 마스크 디코더를 특정 도메인 데이터로 파인튜닝하면 성능이 크게 향상될 수 있으며, 이는 SAM이 특정 의료 영상 분할 작업에 효과적으로 적응할 수 있는 강력한 파운데이션 모델임을 시사합니다.
* **향후 연구 방향**:
  * **3D 데이터 지원**: 의료 영상은 주로 3D이므로, 2D 입력만 지원하는 SAM을 3D 데이터로 확장하여 공간적 맥락 정보를 활용하는 것이 중요합니다.
  * **다중 양상 통합**: T1, T1ce, T2, FLAIR과 같은 다중 양상 의료 데이터의 상호 보완적인 정보를 통합하여 SAM의 성능을 더욱 향상시키는 방법을 탐색해야 합니다.

## 📌 TL;DR

* **문제**: 기존 뇌종양 분할 모델들은 특정 데이터에 국한되며, 방대한 주석 데이터와 재설계가 필요합니다. SAM(Segment Anything Model)이 자연 영상에서 뛰어난 일반화 능력을 보였으나, 경계가 모호한 의료 영상, 특히 뇌종양 분할에서의 효과는 미지수였습니다.
* **방법**: 본 연구는 BraTS2019 데이터셋(2D 슬라이스)을 사용하여 다양한 점 및 박스 프롬프트 전략 하에 SAM의 제로샷 분할 성능을 평가했습니다. 또한 프롬프트에 무작위성을 도입했을 때의 성능 변화와 SAM의 마스크 디코더를 파인튜닝했을 때의 효과를 분석했습니다.
* **주요 결과**:
    1. 박스 프롬프트가 점 프롬프트보다 우수했으며, 박스와 점을 결합하면 성능이 더욱 향상되었습니다.
    2. 점 프롬프트 수는 적절해야 하며, 너무 많으면 오히려 성능이 저하되었습니다.
    3. SAM은 경계가 명확한 영상 양상(T2, T1ce, FLAIR)과 종양 영역(종양 중심부)에서 더 좋은 성능을 보였습니다.
    4. 프롬프트에 무작위성을 도입하면 SAM의 성능이 유의미하게 감소하여 실제 적용 시 고려해야 할 과제임을 시사했습니다.
    5. 뇌종양 데이터로 SAM의 마스크 디코더를 파인튜닝하자 분할 성능이 크게 향상되었으며, 이는 SAM의 다운스트림 작업 적응 가능성이 높음을 보여줍니다.
    6. 향후 SAM을 3D 의료 영상과 다중 양상 데이터에 확장하는 연구가 필요합니다.
