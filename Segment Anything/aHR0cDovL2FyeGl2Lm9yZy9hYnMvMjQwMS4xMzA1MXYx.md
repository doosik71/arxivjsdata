# PA-SAM: Prompt Adapter SAM for High-Quality Image Segmentation

Zhaozhi Xie, Bochen Guan, Weihao Jiang, Muyang Yi, Yue Ding, Hongtao Lu, Lei Zhang

## 🧩 Problem to Solve

Segment Anything Model (SAM)은 다양한 이미지 분할(segmentation) 작업에서 뛰어난 성능을 보였지만, 특히 실제 환경에서 마스크 예측 품질, 즉 고품질 세부 정보를 포착하는 데 한계가 있습니다. SAM은 객체의 거친 경계나 미세한 세부 사항(예: 연줄, 곤충 더듬이)을 정확하게 분할하지 못하는 경우가 많습니다. 기존 HQ-SAM과 같은 방법들은 세부 정보를 포착하려 했으나, SAM의 마스크 디코더 피처를 주로 활용하여 SAM의 전체 프레임워크와는 단절된 암묵적 학습 방식을 사용했습니다. 또한, 기존 프롬프트 기반 방법들은 고정된 희소(sparse) 프롬프트를 사용하여 객체 위치는 잘 찾지만, 세부 정보를 포착하기 어렵습니다. 따라서 SAM에 직접 상세 정보를 제공하고 마스크 디코더 피처를 개선하여 고품질 마스크를 생성할 수 있는 네트워크가 필요합니다.

## ✨ Key Contributions

* **프롬프트 기반 어댑터(Prompt-driven Adapter) 도입**: 이미지의 불확실한 영역을 탐색하고 저수준 세부 정보를 조밀(dense) 및 희소(sparse) 프롬프트에 통합하여 SAM의 세부 정보 학습 능력을 향상시키는 PA-SAM을 제안합니다.
* **어댑터의 프롬프트 피처 최적화**: 기존 어댑터와 달리 이미지 피처가 아닌 프롬프트 피처를 최적화하여 네트워크의 초점 영역에서 세부 정보를 추출합니다.
* **적응형 세부 정보 강화(Adaptive Detail Enhancement)**: 마스크 개선 프로세스를 `refined token`과 `uncertain token` 학습으로 전환하여 모델이 어려운 영역의 이미지 세부 정보에 더 민감하게 반응하도록 합니다.
  * **조밀 프롬프트 보상(Dense Prompt Compensation)**: 원본 이미지 $I$와 그 그레디언트 $\nabla I$를 활용하여 SAM의 다운샘플링으로 손실된 세부 정보를 보상합니다.
  * **희소 프롬프트 최적화(Sparse Prompt Optimization)**: `token-to-image cross-attention`을 통해 희소 프롬프트 피처를 최적화하고, `uncertain token`과 `refined token`을 정의하여 어려운 영역을 식별하고 분할합니다.
* **하드 포인트 마이닝(Hard Point Mining)**: `Gumbel top-k operation`을 기반으로 한 하드 포인트 마이닝 방법을 제안하여 모델에 직접적인 세부 정보 안내를 제공합니다.
* **경량 학습**: SAM 구성 요소는 고정하고 프롬프트 어댑터만 훈련하여 SAM의 강력한 객체 위치 파악 능력을 유지하면서 고품질 분할 맵을 생성합니다.
* **최첨단 성능**: HQSeg-44K 고품질 분할 데이터셋에서 기존 최첨단 모델 대비 mIoU 1.7%, mBIoU 2.7% 개선을 달성했으며, zero-shot 및 open-set 분할에서도 유망한 결과를 보였습니다.

## 📎 Related Works

* **SAM [7]**: 기본 분할 모델로, 프롬프트를 기반으로 임의의 이미지에 대해 여러 정확하고 합리적인 마스크를 생성합니다.
* **HQ-SAM [10]**: SAM의 한계를 해결하기 위해 고품질 토큰을 도입하여 세부 정보를 포착하고 분할 품질을 크게 개선했습니다. 그러나 암묵적 학습 방식으로 SAM의 전체 프레임워크와 분리되어 있다는 한계가 있습니다.
* **RSPrompter [11]**: 이미지 피처를 활용하여 고정된 희소 프롬프트를 생성하는 프롬프트-쿼리 기반 방법 중 하나로, 객체 위치 파악에는 효과적이나 세부 정보 포착에는 한계가 있습니다.
* **BOFT-SAM [18]**: SAM의 마스크 디코더를 미세 조정하는 방식과 같이 일반적인 표현 학습에 중점을 둔 다른 미세 조정 방법들입니다.
* **GroundingDINO [25]**: SAM 기반 open-set 분할에서 사용되는 객체 탐지기로, 바운딩 박스를 생성하여 희소 프롬프트로 활용됩니다.

## 🛠️ Methodology

PA-SAM은 이미지 세부 정보를 다중 세분성(multi-granularity) 프롬프트 피처로 변환하여 마스크 디코더에 전달함으로써 SAM의 세부 정보 학습 능력을 향상시킵니다. 전체적인 아키텍처는 SAM의 이미지 인코더, 프롬프트 인코더, 마스크 인코더는 고정하고, 마스크 디코더 내부에 프롬프트 어댑터(Prompt Adapter)를 도입하여 이미지 피처와 희소 프롬프트를 조밀 및 희소 어댑터 프롬프트로 변환합니다.

주요 단계는 다음과 같습니다:

1. **전체 프레임워크**:
    * PA-SAM은 이미지 피처를 조밀 프롬프트와 결합하고, 이를 희소 프롬프트와 함께 마스크 디코더로 보냅니다.
    * 제안된 프롬프트 어댑터는 각 블록의 `self-attention` 이후에 이미지 피처와 희소 프롬프트를 각각 조밀 및 희소 어댑터 프롬프트로 변환합니다.
    * 출력된 프롬프트 피처는 잔차(residual) 방식으로 PA-SAM에 재통합되어 마스크 디코더의 피처 표현을 최적화합니다.

2. **프롬프트 어댑터 (PA)**:
    * **적응형 세부 정보 강화 (Adaptive Detail Enhancement)**:
        * **조밀 프롬프트 보상 (Dense Prompt Compensation)**: SAM의 16x16 다운샘플링으로 인한 세부 정보 손실을 보상하기 위해 원본 이미지 $I$와 그 그레디언트 $\nabla I$를 가이드 정보로 인코딩합니다. 일관된 표현 모듈(CRM, Consistent Representation Module)을 사용하여 출력 피처와 이미지 피처 간의 일관성을 유지합니다.
            $$x_{\text{pa}} = \text{CRM}(W_g[I, \nabla I], x)$$
            여기서 $x_{\text{pa}}$는 PA 조밀 프롬프트, $W_g$는 컨볼루션 연산입니다.
        * **희소 프롬프트 최적화 (Sparse Prompt Optimization)**: 기존 희소 프롬프트 $t_{\text{in}}$을 `token-to-image cross-attention`을 통해 상세 희소 프롬프트 $t_{\text{pa}}$로 변환합니다.
            $$t_{\text{pa}} = \text{Attention}(q=t_{\text{in}}, k=x_{\text{pa}}, v=x_{\text{pa}})$$
            또한, 어려운 영역을 식별하는 `uncertain token` $u_{\text{pa}}$와 이 영역을 분할하는 `refined token` $r_{\text{pa}}$를 정의합니다. 이들을 통해 `coarse mask` $M_C$, `refined mask` $M_R$, `uncertain mask` $M_U$를 얻고, 최종적으로 중간 마스크 $M_{PA}$를 계산합니다.
            $$M_{PA} = M_U \circ M_R + (1 - M_U) \circ M_C$$
    * **하드 포인트 마이닝 (Hard Point Mining)**: $M_C$, $M_R$, $M_U$를 활용하여 어려운 지점 샘플링을 위한 가이드맵을 구성합니다. 훈련 단계에서는 다양성 확보를 위해 `Gumbel-Softmax operation`을 `Gumbel top-k operation`으로 확장합니다.
        * 긍정(positive) 포인트 샘플링의 경우, 초기 샘플링 가이드 $\phi_0$는 $\text{flatten}(M_U \circ (M_R - M_C))$로 구성됩니다. Gumbel top-k 연산을 통해 최종 `top-k Softmax probability` $\hat{g}$를 얻습니다.
        * $\hat{g}$를 사용하여 PA 조밀 프롬프트 $x_{\text{pa}}$에서 $N_{\text{sample}}$개의 긍정 포인트를 샘플링합니다. 부정(negative) 포인트 샘플링도 유사하게 $\phi_0$를 $\text{flatten}(M_U \circ (M_C - M_R))$로 대체하여 수행합니다.
        * 새로운 포인트 프롬프트 $p_{\text{sample}}$을 생성하고, PA 희소 프롬프트 $t_{\text{pa}}$를 `[iou_pa, r_pa, p_pa, p_sample, b_pa]`로 업데이트합니다.

3. **훈련**: SAM 파라미터는 고정하고 프롬프트 어댑터와 마스크 예측 모듈의 이미지 업샘플링 모듈만 훈련합니다. BCE 손실과 Dice 손실을 사용하여 $M_{\text{SAM}}$과 $M_{PA}$를 감독하고, $M_U$에는 BCE 손실을 사용합니다.

## 📊 Results

* **고품질 분할 (HQSeg-44K)**:
  * HQ-SAM 대비 모든 4개 데이터셋에서 평균 mIoU 2.1%, mBIoU 2.7% 향상.
  * PA-SAM은 SAM 미세조정 방식(BOFT-SAM 등)보다 mIoU 1.7%, mBIoU 2.9% 더 높은 성능을 보였습니다.
  * 시각적 비교에서 PA-SAM은 배경 객체와 목표 객체를 더 잘 구분하고(예: 선반 옆 막대기, 의자 밑 부분), HQ-SAM의 마스크 깨짐 현상(예: 새)을 효과적으로 방지했습니다.

* **Zero-shot 분할 (COCO)**:
  * HQ-SAM 대비 AP 0.4% 추가 향상.
  * 탐지기(FocalNet-DINO)의 탐지 품질 병목현상으로 인해 감독 학습 방식에는 미치지 못하지만, PA-SAM은 하드 포인트 마이닝을 통한 희소 프롬프트 강화로 탐지 오류에 더 강한 저항력을 보였습니다.

* **Open-set 분할 (SegInW)**:
  * Grounding-DINO를 사용하여 HQ-SAM 대비 mAP 0.6% 향상된 50.2%를 달성했습니다.
  * 일부 카테고리(전기 면도기, 나비 다람쥐, 기둥)에서는 성능이 상대적으로 낮았는데, 이는 해당 카테고리에 주요 몸체와 크게 다른 부분이 포함되어 사전 지식 없이 다른 카테고리로 오분류될 수 있기 때문입니다.

## 🧠 Insights & Discussion

* PA-SAM은 프롬프트 기반 어댑터를 통해 마스크 디코더의 중간 피처 표현을 최적화함으로써 고품질 분할 맵 생성에 더 큰 이점을 제공합니다. 이는 최종 피처만으로 훈련하는 것보다 효과적임을 입증합니다.
* 하드 포인트 마이닝과 적응형 세부 정보 강화는 불확실한 영역에서 세부 정보를 학습하고 탐색하는 데 탁월하며, 이는 일반적인 표현 학습에만 집중하는 다른 미세 조정 방법들보다 고품질 분할에 훨씬 유리합니다.
* 프롬프트-쿼리 기반 방법들이 이미지 정보뿐만 아니라 원본 입력 프롬프트와의 상호작용에도 의존한다는 점을 고려할 때, PA-SAM은 상세한 이미지 정보를 활용하여 프롬프트 어댑터에서 원본 프롬프트의 표현을 최적화함으로써 탁월한 성능을 달성합니다.
* 제로샷 분할에서 PA-SAM은 하드 포인트 마이닝을 통해 희소 프롬프트를 강화하여 탐지 오류에 대한 저항력을 높입니다. 이는 탐지기의 한계로 인한 성능 저하를 완화하는 데 기여합니다.
* 어블레이션 연구 결과, 조밀 프롬프트 보상과 희소 프롬프트 최적화를 함께 사용하는 것이 효과적이며, 일관된 표현 모듈로는 `guided gate`가 `cross-attention`보다 추론 속도 저하를 줄이면서 좋은 균형을 제공했습니다.
* `Gumbel top-k point sampler`는 잎의 구멍(음성 포인트)이나 가장자리(양성 포인트)와 같은 어려운 지점을 효과적으로 포착하여 모델의 고품질 분할을 촉진합니다.
* 프롬프트 어댑터를 네트워크에 병렬 방식으로 연결하는 것이 원본 마스크 디코더에 미치는 간섭을 최소화하여 가장 좋은 결과를 보였습니다. 또한, 마스크 디코더의 첫 번째 블록은 의미론적 정보가 부족하여 어댑터를 추가할 경우 오히려 부정적인 영향을 미칠 수 있음을 발견했습니다.

## 📌 TL;DR

PA-SAM은 SAM의 고품질 이미지 분할 한계를 해결하기 위해 새로운 프롬프트 기반 어댑터를 제안합니다. 이 어댑터는 이미지에서 세부 정보를 추출하여 조밀 및 희소 프롬프트를 최적화하며, 적응형 세부 정보 강화와 하드 포인트 마이닝을 통해 어려운 영역의 세부 사항을 효과적으로 학습합니다. SAM의 인코더는 고정하고 어댑터만 훈련하여 고품질, zero-shot, open-set 분할에서 기존 방법들을 뛰어넘는 최첨단 성능을 달성했습니다.
