# Segment Anything in Medical Images and Videos: Benchmark and Deployment

Jun Ma, Sumin Kim, Feifei Li, Mohammed Baharoon, Reza Asakereh, Hongwei Lyu, and Bo Wang

## 🧩 Problem to Solve

자연 영상 분야에서 뛰어난 성능을 보이는 Segment Anything Model (SAM1)과 같은 분할 기반 모델들은 의료 영상의 고유한 특성(낮은 해상도, 제한된 이미지 품질 등)과 자연 영상과의 큰 도메인 차이로 인해 의료 영상 분할에서 저조한 성능을 보입니다. MedSAM은 2D 의료 영상 분할에서 SAM1의 한계를 극복했지만, 3D 영상 및 비디오 분할에서는 효율적인 프롬프트 생성 및 분할이 어려웠습니다. 최근에 출시된 SAM2는 영상 및 비디오 분할을 위한 통합 프레임워크를 제공하지만, 다양한 의료 영상 모달리티(특히 3D 영상 및 비디오)에서의 성능과 활용 가능성은 불확실했습니다. 또한, 의료 전문가들이 코딩 없이 이러한 모델을 쉽게 사용할 수 있는 사용자 친화적인 인터페이스가 부족했습니다.

## ✨ Key Contributions

* 11가지 의료 영상 모달리티(2D 및 3D 영상, 비디오 포함)에 걸쳐 SAM2의 포괄적인 벤치마킹을 수행하고, SAM1 및 MedSAM과 비교하여 강점과 약점을 파악했습니다.
* 전이 학습 파이프라인을 개발하여 SAM2가 미세 조정을 통해 의료 도메인에 빠르게 적응할 수 있음을 입증했습니다.
* SAM2를 3D Slicer 플러그인과 Gradio API로 구현하여 의료 전문가들이 효율적으로 3D 의료 영상 및 비디오를 분할하고 주석을 달 수 있도록 지원했습니다.
* 연구에 사용된 모든 코드를 공개적으로 사용할 수 있도록 제공했습니다.

## 📎 Related Works

* **특수 목적 분할 모델**: 특정 해부학적 구조나 질병, 영상 모달리티에 특화된 모델(예: U-Net [13, 43]).
* **일반 목적 분할 모델 (기반 모델)**: SAM [25]은 대규모 자연 영상 데이터로 학습되었으나 의료 영상에서는 한계가 있었습니다.
* **의료 영상 특화 SAM 모델**: MedSAM [29]은 대규모 의료 영상 데이터에 SAM을 미세 조정한 모델로, 2D 의료 영상 분할에서 뛰어난 성능을 보였습니다.
* **3D 의료 영상 분할을 위한 SAM 확장 연구**: 이미지 인코더에 3D 어댑터 추가 [17, 8], 이미지 인코더를 3D로 확장 [48, 12], Mixture of Experts [47], 텍스트 기반 3D 분할 [54] 등이 있습니다.
* **SAM2 [10, 39]**: SAM의 후속 모델로, 프롬프트 기반 비디오 분할 기능을 추가하고 대규모 비디오 데이터셋으로 학습되었습니다.

## 🛠️ Methodology

* **데이터셋**: CT, MRI, PET, 초음파(US), 내시경, 안저, 피부경, 유방조영술, 광학 현미경, OCT를 포함한 11가지 모달리티의 공공 의료 영상 및 비디오 데이터셋을 사용했습니다.
* **평가 모델**: SAM1 (Base, Large, Huge), SAM2 (Tiny, Small, Base, Large), MedSAM의 다양한 모델을 평가했습니다.
* **평가 프로토콜**:
  * **프롬프트**: 효율성과 모호성 감소를 위해 바운딩 박스 프롬프트를 주로 사용했습니다.
  * **2D 영상**: 이미지와 바운딩 박스 프롬프트를 모델에 직접 전달했습니다.
  * **3D 영상**: 중간 슬라이스에 바운딩 박스를 초기화했습니다.
    * SAM1/MedSAM: 슬라이스별 분할을 수행하며, 이전 슬라이스의 마스크를 다음 슬라이스의 프롬프트로 활용했습니다.
    * SAM2: 중간 슬라이스의 마스크를 SAM2의 비디오 분할 기능을 사용하여 나머지 슬라이스로 전파했습니다.
  * **비디오 분할**: 첫 프레임에 바운딩 박스 프롬프트를 초기화하고, SAM2의 비디오 분할 기능으로 전체 프레임에 걸쳐 마스크를 전파했습니다.
  * **마스크 초기화 영향 분석**: 3D 분할 시 중간 슬라이스의 초기 마스크를 MedSAM 생성 마스크 또는 Ground Truth 마스크로 대체하여 성능 변화를 분석했습니다.
* **전이 학습 파이프라인**:
  * SAM2-Tiny 모델을 MICCAI FLARE22 복부 CT 데이터셋으로 미세 조정했습니다.
  * 프롬프트 인코더는 도메인 불가지론적이므로 고정하고, 이미지 인코더와 마스크 디코더만 업데이트했습니다.
  * 입력 이미지는 $[1024, 1024]$로 크기를 조정하고, Z-score 정규화를 적용했으며, 3채널 이미지로 복제했습니다.
  * 바운딩 박스 프롬프트는 Ground Truth 마스크에서 얻었으며, 강건성을 위해 5픽셀의 무작위 섭동을 적용했습니다.
  * AdamW 옵티마이저, 학습률 $6 \times 10^{-5}$, 배치 크기 16으로 1000 에폭 동안 학습했으며, Dice 손실과 교차 엔트로피 손실의 비가중 합을 손실 함수로 사용했습니다.
* **배포**: 의료 전문직의 접근성을 높이기 위해 3D Slicer 플러그인과 Gradio API를 개발했습니다.
* **평가 지표**: 영역 중첩도를 위한 Dice Similarity Coefficient (DSC)와 경계 중첩도를 위한 Normalized Surface Distance (NSD)를 사용했습니다.
* **SAM1과 SAM2의 주요 방법론적 차이**: SAM2는 Vision Transformer (ViT) 대신 **Hiera** [42]를 사용하여 멀티스케일 특징을 추출하고, **메모리 어텐션 모듈**을 도입하여 이전 프레임의 정보로 현재 프레임 예측을 조정함으로써 비디오 분할 능력을 강화했습니다.

## 📊 Results

* **2D 영상 분할**:
  * MedSAM은 11개 모달리티 중 9개에서 SAM1 및 SAM2보다 일관되게 우수한 성능을 보였습니다 (PET, 광학 현미경 제외).
  * SAM2는 MR, 피부경, 광학 현미경 영상에서 SAM1보다 높은 DSC 점수를 얻었으나, PET 및 OCT 영상에서는 낮은 점수를 기록했습니다.
* **3D 영상 분할**:
  * SAM2-Base 모델은 3D CT 및 MR 영상에서 SAM1과 MedSAM보다 현저히 개선된 성능을 달성했습니다 (3D 영상을 비디오처럼 처리하여 마스크를 전파하는 방식).
  * PET 영상에서는 SAM1 모델들이 SAM2를 능가했는데, 이는 SAM2에서 중간 슬라이스의 과분할 오류가 나머지 슬라이스로 전파되는 경향 때문으로 분석됩니다.
* **3D 분할 성능에 대한 마스크 초기화의 영향**:
  * SAM2에서 중간 슬라이스 초기화를 MedSAM으로 생성된 마스크를 사용했을 때, 모든 3D 모달리티에서 최종 3D 분할 성능이 향상되었습니다 (DSC 최대 17.5%, NSD 최대 33.3% 향상).
  * Ground Truth 마스크를 초기화에 사용했을 때는 더 큰 정확도 향상을 가져왔습니다.
* **비디오 분할**:
  * 초음파 비디오에서는 SAM2-T 모델이 DSC 0.8537로 최고의 성능을 보였습니다.
  * 내시경 비디오에서는 SAM2-B 모델이 DSC 0.8397로 가장 높은 성능을 보였습니다.
  * 실패 사례는 객체 경계가 불분명하거나 이미지 대비가 낮을 때 첫 프레임 분할에 실패하거나 마스크 전파 중 과분할 오류가 발생하는 경우였습니다.
* **전이 학습**:
  * SAM2-Tiny 모델을 3D 복부 장기 CT 데이터셋으로 미세 조정한 결과, 미세 조정 전 SAM2-Tiny에 비해 DSC 점수에서 3.5~45.62%, NSD 점수에서 10.1~61.4%의 현저한 개선을 달성했습니다.

## 🧠 Insights & Discussion

* **SAM1 대 SAM2**: SAM2는 고급 네트워크 아키텍처와 비디오 데이터셋 학습 덕분에 일부 2D(MRI, 피부경, 광학 현미경) 및 3D(CT, MRI) 의료 영상에서 SAM1보다 우수했으나, 2D OCT 및 PET 영상에서는 SAM1이 더 나은 성능을 보였습니다. 이는 모델 크기가 작거나 특정 훈련 데이터셋의 특성 때문일 수 있으며, 완전한 이해를 위해서는 훈련 코드에 대한 접근이 필요합니다.
* **스케일링 법칙: 모델 크기 대 성능**: 가장 큰 SAM2-L 모델이 항상 최고의 성능을 보이지 않았습니다. 3D PET, 광학 현미경, 초음파 비디오에서는 가장 작은 SAM2-T 모델이 최고의 성능을 달성하기도 했습니다. 이는 의료 영상 분할에서는 모델 크기뿐만 아니라 훈련 데이터셋의 특성과 훈련 프로토콜이 최적의 성능에 중요한 역할을 함을 시사합니다.
* **일반 목적 SAM2 대 의료 영상 적응 MedSAM**: SAM2의 비디오 분할 능력은 3D 의료 영상 분할에 큰 이점을 제공하지만, 대부분의 2D 의료 영상 모달리티에서는 MedSAM이 여전히 우수합니다. 전이 학습은 SAM2의 의료 영상 분할 능력을 향상시키는 효과적인 방법이지만, 직접적인 미세 조정은 SAM2의 원래 다목적 분할 능력을 저해할 수 있으므로 균형 잡힌 접근이 중요합니다.
* **제한 사항 및 향후 연구**:
  * 더 많은 3D 모달리티(예: 3D 초음파, OCT 영상)를 벤치마킹에 포함하여 연구를 확장할 수 있습니다.
  * SAM2의 비디오 분할 기능은 경계가 불분명한 대상을 분할하는 데 어려움이 있습니다. 의료 비디오 데이터셋에 대한 전이 학습을 통해 이 문제를 해결할 수 있습니다.
  * 텍스트 프롬프트를 지원하도록 SAM2를 확장하여 복잡한 의료 구조 분할에 유연성을 더할 수 있습니다.
  * SAM2를 더 경량화하고 추론 효율성을 개선하여 더 넓은 임상 환경에 배포할 수 있도록 해야 합니다.
* **배포의 중요성**: 3D Slicer 플러그인 및 Gradio API와 같은 엔지니어링 구현은 임상 실습에서의 채택에 매우 중요하며, 이는 딥러닝 기반 의료 영상 분할 논문에서 간과되는 경향이 있습니다.

## 📌 TL;DR

본 논문은 SAM2 (Segment Anything Model 2)의 11가지 의료 영상 및 비디오 모달리티에 대한 성능을 SAM1 및 MedSAM과 비교하여 종합적으로 벤치마킹했습니다. SAM2는 3D CT 및 MR 영상에서 마스크 전파를 통해 SAM1과 MedSAM 대비 개선을 보였으나, 2D 의료 영상에서는 MedSAM이 대부분의 모달리티에서 우수했습니다. 또한, 전이 학습 파이프라인을 통해 SAM2를 의료 도메인에 효과적으로 적응시킬 수 있음을 입증했으며, SAM2를 3D Slicer 플러그인과 Gradio API로 배포하여 의료 전문가들이 쉽게 사용할 수 있도록 했습니다. 결과는 모델 크기보다 훈련 데이터셋의 특성이 의료 영상 분할 성능에 더 중요할 수 있음을 시사하며, 전이 학습과 사용자 친화적인 배포가 임상 채택에 필수적임을 강조합니다.
