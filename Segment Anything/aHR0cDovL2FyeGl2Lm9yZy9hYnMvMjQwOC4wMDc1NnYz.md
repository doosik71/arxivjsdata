# Segment anything model 2: an application to 2D and 3D medical images

Haoyu Dong, Hanxue Gu, Yaqian Chen, Jichen Yang, Yuwen Chen, Maciej A. Mazurowski

## 🧩 Problem to Solve

의료 영상 분할은 질병 진단 및 임상 분석에 매우 중요하지만, 데이터 주석의 노동 집약성과 의료 영상의 복잡성으로 인해 어려운 과제로 남아 있습니다. 기존의 Segment Anything Model (SAM)은 2D 이미지에 대한 제로샷 분할에서 뛰어난 성능을 보였지만, 2D 이미지에만 국한되어 3차원적 이해가 필요한 의료 영상 분야에 적용하기에는 한계가 있었습니다. 최근 출시된 SAM 2는 비디오 입력으로 기능을 확장하여 3D 의료 영상 분할에 적용할 수 있는 기회를 제공했습니다. 본 논문은 SAM 2의 2D 및 3D 의료 영상 분할 능력을 광범위하게 평가하고, 이 분야에서 SAM 2의 행동을 이해하며 향후 연구 방향을 제시하는 것을 목표로 합니다.

## ✨ Key Contributions

* **광범위한 평가 데이터셋 구축:** 2D 및 3D 의료 영상(수술 비디오, CT, MRI, PET, X-ray, 초음파 등)을 포함한 21개 의료 영상 데이터셋을 수집하여 SAM 2의 성능을 평가했습니다.
* **두 가지 평가 설정 도입:** 단일 프레임 2D 분할(각 슬라이스에 프롬프트 제공) 및 다중 프레임 3D 분할(볼륨에서 선택된 한두 슬라이스에 프롬프트 제공) 설정을 고려했습니다.
* **다중 프레임 3D 분할의 핵심 요소 분석:** 주석 처리할 슬라이스 선택, 전파 방향, 예측 마스크 선택 등 3D 분할의 고유한 과제에 대한 다양한 모드를 제안하고 평가했습니다.
* **SAM 2의 2D 성능 확인:** 단일 프레임 2D 분할에서 SAM 2가 SAM과 유사한 성능을 보임을 확인했습니다.
* **SAM 2의 3D 성능 및 최적 전략 제시:** 다중 프레임 3D 분할에서 SAM 2의 성능이 슬라이스 선택, 전파 방향, 예측 활용 방식 등에 따라 크게 달라짐을 보여주었고, 최적의 전략들을 도출했습니다.
* **SAM 2와 SAM-Med3D 비교:** 3D 의료 영상에 특화된 SAM-Med3D보다 SAM 2가 대부분의 데이터셋에서 우수한 성능을 보임을 입증했습니다.
* **대화형 분할 알고리즘 평가:** 두 가지 대화형 프롬프팅 전략(수정 기반 및 재초기화 기반)을 제안하고 그 효과를 분석했습니다.
* **코드 공개:** 관련 코드를 공개하여 후속 연구에 기여했습니다.

## 📎 Related Works

* **Segment Anything Model (SAM) [17]:** 프롬프트 기반의 제로샷 2D 분할 능력을 보여준 선행 모델입니다. 본 연구는 SAM의 2D 한계를 극복하려는 SAM 2를 평가합니다.
* **nn-UNet [15]:** 널리 사용되는 의료 영상 분할 기법으로, 때때로 미세 조정된 SAM에 의해 능가되는 것으로 언급됩니다.
* **SAM3D [5], 3DSAM-A [10], SAM-Med3D [37]:** 2D SAM을 3D 의료 영상 분할로 확장하기 위해 추가 구성 요소를 결합하거나 아키텍처를 수정한 이전 연구들입니다. 특히 SAM-Med3D와 SAM 2의 성능을 비교했습니다.
* **SAM 2 [31]:** SAM의 백본을 비디오 입력 및 3D로 확장하여 메모리 뱅크를 도입한 모델로, 본 논문의 주된 평가 대상입니다.
* **SAM에 대한 이전 의료 영상 평가 연구 [24]:** 본 연구는 이 선행 연구의 연장선상에서 SAM 2를 평가합니다.

## 🛠️ Methodology

본 연구는 SAM 2의 의료 영상 분할 성능을 평가하기 위해 21개 데이터셋(2D 6개, 3D 15개)을 사용했으며, IoU (Intersection over Union)를 평가 지표로 활용했습니다.

### 단일 프레임 2D 분할 평가 ($P_{mode}$ 1-4)

* SAM 2는 각 슬라이스에 개별적으로 프롬프트를 제공받아 SAM과 유사하게 동작합니다.
* **프롬프트 모드 ($P_{Mode}$):**
  * **P-Mode 1:** 관심 객체의 가장 큰 연결 영역 중앙에 한 개의 점 프롬프트.
  * **P-Mode 2:** 관심 객체의 각 개별 연결 영역에 한 개의 점 프롬프트 (최대 세 개).
  * **P-Mode 3:** 관심 객체의 가장 큰 연결 영역 중앙에 한 개의 박스 프롬프트.
  * **P-Mode 4:** 관심 객체의 각 개별 연결 영역에 한 개의 박스 프롬프트 (최대 세 개).

### 다중 프레임 3D 분할 평가 ($F_{mode}$, $P_{mode}$, $D_{mode}$, $S_{mode}$)

* SAM 2의 비디오 분할 능력을 3D 이미지 분할에 적용하며, 한두 개의 슬라이스에만 프롬프트를 제공하고 나머지는 모델이 예측하는 반지도 학습 설정을 따릅니다.
* **초기 프레임 선택 모드 ($F_{Mode}$):**
  * **F-Mode 1:** 관심 객체가 처음 나타나는 경계 슬라이스.
  * F**-Mode 2:** 관심 객체의 중심 슬라이스.
  * **F-Mode 3:** 관심 객체가 가장 큰 슬라이스.
  * **F-Mode 4:** 전체 관심 객체에서 3개의 슬라이스를 균일하게 선택.
* **프롬프트 시뮬레이션 모드 ($P_{Mode}$):** (3D 설정에서는 다중 박스 프롬프트($P_{Mode}$ 4)는 지원되지 않음)
  * $P_{Mode}$ 1-3 (위 2D 설정과 동일).
  * **P-Mode 5:** Ground Truth (GT) 마스크를 프롬프트로 제공.
* **전파 방향 모드 ($D_{Mode}$):**
  * **D-Mode 1 (전방 전파):** 볼륨의 첫 번째 슬라이스부터 순방향으로 전파.
  * **D-Mode 2 (양방향 전파):** 주석이 있는 슬라이스에서 시작하여 첫 번째 슬라이스까지 역방향으로 전파한 다음, 주석이 있는 슬라이스에서 다시 시작하여 볼륨 끝까지 순방향으로 전파 (역방향 예측은 순방향에 사용되지 않음).
* **예측 마스크 선택 모드 ($S_{Mode}$):**
  * **S-Mode 1:** 가장 높은 신뢰도($IoU$)를 가진 예측 마스크 선택.
  * **S-Mode 2:** 첫 번째 채널의 예측 마스크 선택 (가장 작은 영역에 해당하며, SAM 2의 내부 구조 수정 필요).
* 총 64가지의 실험 구성 ($4 F_{mode} \times 4 P_{mode} \times 2 S_{mode} \times 2 D_{mode}$).

### 대화형 다중 프레임 3D 분할 평가

* 사용자가 SAM 2의 예측을 개선할 수 있는 오프라인 설정에 초점을 맞춥니다.
* **수정 기반 대화형 프롬프팅 (알고리즘 1):**
  * 주석 슬라이스를 기준으로 볼륨을 두 개의 하위 볼륨으로 나누고, 각 하위 볼륨에서 가장 큰 오류를 가진 슬라이스를 식별하여 새로운 프롬프트를 추가합니다. 이 과정에서 전체 예측기의 메모리를 유지합니다.
* **재초기화 기반 대화형 프롬프팅 (알고리즘 2):**
  * 전체 볼륨에서 가장 낮은 $IoU$를 가진 슬라이스를 식별하고, 해당 슬라이스에 새로운 프롬프트를 추가하며, 각 반복마다 모델을 재초기화합니다 (메모리 지움).

## 📊 Results

### 단일 프레임 2D 분할 결과

* SAM 2의 2D 분할 성능은 SAM과 유사하며, 데이터셋에 따라 크게 달라집니다 (예: Xray-Hip ilium에서 $0.908$ $IoU$ vs. MRI-Spine 회백질에서 $0.278$ $IoU$).
* 박스 프롬프트가 점 프롬프트보다 일관되게 더 나은 결과를 제공합니다.
* 점 프롬프트의 수가 많다고 항상 성능이 향상되는 것은 아니며, 작은 객체의 경우 과분할을 유발할 수 있습니다.

### 다중 프레임 3D 분할 결과

* **전파 모드:** 양방향 전파 ($D_{Mode}$ 2)가 단방향 전파보다 일관되게 우수합니다 (평균 $IoU$가 $0.0874$에서 $0.2383$까지 향상). 이는 인접 슬라이스 예측의 효과와 역방향 전파의 유효성을 시사합니다.
* **예측 마스크 선택:** 점 프롬프트의 경우 ($P_{Mode}$ 1, 2) 첫 번째 채널을 선택하는 것 ($S_{Mode}$ 2)이 가장 신뢰도 높은 예측을 선택하는 것 ($S_{Mode}$ 1)보다 더 나은 성능을 보였습니다. 반면, 박스 프롬프트 ($P_{Mode}$ 3) 또는 GT 마스크 ($P_{Mode}$ 5)의 경우 가장 신뢰도 높은 예측을 선택하는 것이 더 효과적이었습니다.
* **초기 프레임 선택:** 단일 슬라이스를 주석 처리할 경우 중심 슬라이스 ($F_{Mode}$ 2) 또는 가장 큰 객체를 포함하는 슬라이스 ($F_{Mode}$ 3)를 선택하는 것이 경계 슬라이스 ($F_{Mode}$ 1)보다 성능이 좋았습니다. 3개의 슬라이스를 주석 처리할 경우 GT 마스크를 제공할 때만 상당한 개선이 있었습니다.
* **프롬프트 모드:** 복잡한 프롬프트일수록 성능이 향상됩니다 (단일 슬라이스에 대해 1점: $0.3778$, 여러 점: $0.3851$, 1박스: $0.5222$, GT 마스크: $0.6198$ $IoU$). 초기 슬라이스 예측의 품질이 전체 볼륨 분할 성능을 좌우합니다.
* **GT 마스크 사용:** GT 마스크를 사용하더라도 평균 $IoU$는 $0.6198$에 그쳤는데, 이는 SAM 2가 8프레임 폭으로 훈련되었고 의료 볼륨은 슬라이스 간 변화가 크기 때문으로 추정됩니다.

### SAM 2와 타 모델 비교

* **단일 프레임 2D vs. 다중 프레임 3D:** 각 슬라이스에 프롬프트를 제공하는 2D 방식이 SAM 2의 자동 지식 전파에 의존하는 3D 방식보다 여전히 더 효과적입니다. 박스 프롬프트가 두 설정 간 성능 격차를 가장 적게 만듭니다.
* **SAM 2 vs. SAM-Med3D:** SAM 2는 SAM-Med3D보다 거의 모든 데이터셋에서 우수한 성능을 보였습니다. SAM 2가 전파 전략을 통해 $1024 \times 1024$의 고해상도 입력을 유지하는 반면, SAM-Med3D는 전체 볼륨 입력을 위해 $128 \times 128 \times 128$로 입력 크기를 크게 줄여야 했기 때문입니다.

### 대화형 분할 성능

* **수정 기반 알고리즘:** 추가 점 프롬프트를 제공해도 성능 개선이 미미하고 불안정했습니다. GT 마스크를 제공할 때 점진적으로 개선되었습니다.
* **재초기화 기반 알고리즘:** 수정 기반보다 성능이 우수했으며, 점 프롬프트를 제공했을 때도 약간의 개선이 있었습니다 ($P_{Mode}$ 1에서 $0.3782$에서 $0.3977$로 향상). 대화형 모드에서는 메모리를 유지하는 것보다 지우는 것이 더 효과적임을 시사합니다.
* 대화형 주석에서 점 프롬프트는 (오류가 많은 영역에 적용하더라도) 크게 효과적이지 않으며, GT 마스크 제공이 중요함을 확인했습니다. 불만족스러운 수정은 전체 볼륨에 해로울 수 있습니다.

## 🧠 Insights & Discussion

* SAM 2는 2D 의료 영상 분할에서 SAM과 동등한 성능을 보이며 강력한 2D 기능은 여전히 유효합니다.
* 3D 의료 영상 분할에서 SAM 2의 성능은 유망하지만, 초기 슬라이스 선택, 프롬프트 유형, 전파 전략 및 예측 마스크 선택에 따라 크게 달라지므로 **전략적인 활용**이 중요합니다.
* **최적의 3D 전략**은 다음과 같습니다: 양방향 전파를 사용하고, 중심 또는 가장 큰 객체를 포함하는 슬라이스를 초기 프롬프트로 선택하며, 점 프롬프트의 경우 "첫 번째 채널" 예측을, 박스/GT 프롬프트의 경우 "가장 높은 신뢰도" 예측을 선택하는 것입니다. 박스 프롬프트는 점 프롬프트보다 효과적이지만 인간의 노력이 더 필요합니다.
* 모든 슬라이스에 프롬프트를 제공하는 2D 분할과 몇몇 슬라이스에만 프롬프트를 제공하는 3D 분할 사이에는 여전히 성능 격차가 존재하며, 이는 인간의 수동 주석이 제공하는 정보의 가치를 강조합니다.
* SAM 2의 전파 전략을 통한 고해상도 입력 유지 능력은 3D SAM-Med3D와 같은 모델이 입력 해상도를 줄여야 하는 한계에 비해 큰 이점을 제공합니다.
* 대화형 분할은 점 프롬프트만으로는 불안정하고 효과적이지 않았습니다. 수동으로 GT 마스크를 제공하는 경우에만 유의미한 개선이 있었습니다. 대화형 모드에서는 메모리를 지우고 다시 시작하는 것이 이전 예측을 수정하며 메모리를 유지하는 것보다 더 나은 접근 방식입니다.
* 향후 연구에서는 의료 볼륨의 특성(슬라이스 간 큰 변화, 많은 슬라이스 수)을 고려하여 SAM 2의 메모리 뱅크를 보다 효과적으로 활용하여 2D-3D 성능 격차를 줄이는 방향이 필요합니다.

## 📌 TL;DR

SAM 2는 2D 의료 영상 분할에서 SAM과 유사한 성능을 보였고, 3D 의료 영상 분할에서도 그 잠재력을 확인했습니다. 21개 의료 데이터셋에 대한 광범위한 평가를 통해, SAM 2의 3D 성능은 초기 슬라이스 선택 ($F_{Mode}$), 프롬프트 유형 ($P_{Mode}$), 전파 방향 ($D_{Mode}$), 예측 마스크 선택 ($S_{Mode}$)에 따라 크게 달라짐을 발견했습니다. 특히, **양방향 전파**와 **중심/가장 큰 객체 슬라이스**에 **박스 프롬프트**를 제공하는 것이 가장 효과적이었으며, 점 프롬프트의 경우 **첫 번째 채널 예측**을 선택하는 것이 유리했습니다. SAM 2는 저해상도로 전체 볼륨을 처리하는 SAM-Med3D보다 우수한 성능을 보였습니다. 대화형 분할에서는 점 프롬프트만으로는 제한적인 개선을 보였으나, **메모리를 재초기화**하는 방식이 더 효과적이었습니다. 2D와 3D 분할 간의 성능 격차는 여전히 존재하며, 의료 영상 특성을 고려한 메모리 뱅크 활용 개선이 향후 연구 과제입니다.
